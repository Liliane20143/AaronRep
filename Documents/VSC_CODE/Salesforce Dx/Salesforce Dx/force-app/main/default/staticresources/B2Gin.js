/*! b2wgin - v1.1.0 - 2018-09-12
* Copyright (c) 2018 b2wgin team; */
/* eslint-disable */

!function t(e,r,n){function o(a,s){if(!r[a]){if(!e[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(i)return i(a,!0);throw new Error("Cannot find module '"+a+"'")}var c=r[a]={exports:{}};e[a][0].call(c.exports,function(t){var r=e[a][1][t];return o(r||t)},c,c.exports,t,e,r,n)}return r[a].exports}for(var i="function"==typeof require&&require,a=0;a<n.length;a++)o(n[a]);return o}({1:[function(t,e,r){(function(){"use strict";var e=t("../");"function"!=typeof Object.getPrototypeOf&&(Object.getPrototypeOf="".__proto__===String.prototype?function(t){return t.__proto__}:function(t){return t.constructor.prototype}),"function"==typeof this.define&&this.define.amd?define([],function(){return e}):this.b2wgin=e}).call("undefined"!=typeof window?window:this)},{"../":2}],2:[function(t,e,r){e.exports=t("./lib")},{"./lib":15}],3:[function(t,e,r){"use strict";var n=t("./extended"),o=n.declare,i=n.AVLTree,a=n.LinkedList,s=n.isPromiseLike,u=t("events").EventEmitter,c=o({instance:{constructor:function(){this.memory={},this.memoryValues=new a},clear:function(){this.memoryValues.clear(),this.memory={}},remove:function(t){var e=t.hashCode,r=this.memory,n=r[e];return n&&(this.memoryValues.remove(n),delete r[e]),n},insert:function(t){var e=t.hashCode;if(e in this.memory)throw new Error("Activation already in agenda "+t.rule.name+" agenda");this.memoryValues.push(this.memory[e]=t)}}});e.exports=o(u,{instance:{constructor:function(t,e){this.agendaGroups={},this.agendaGroupStack=["main"],this.rules={},this.flow=t,this.comparator=e,this.setFocus("main").addAgendaGroup("main")},addAgendaGroup:function(t){n.has(this.agendaGroups,t)||(this.agendaGroups[t]=new i({compare:this.comparator}))},getAgendaGroup:function(t){return this.agendaGroups[t||"main"]},setFocus:function(t){return t!==this.getFocused()&&this.agendaGroups[t]&&(this.agendaGroupStack.push(t),this.emit("focused",t)),this},getFocused:function(){var t=this.agendaGroupStack;return t[t.length-1]},getFocusedAgenda:function(){return this.agendaGroups[this.getFocused()]},register:function(t){var e=t.rule.agendaGroup;this.rules[t.name]={tree:new i({compare:this.comparator}),factTable:new c},e&&this.addAgendaGroup(e)},isEmpty:function(){for(var t=this.agendaGroupStack,e=!1;this.getFocusedAgenda().isEmpty()&&"main"!==this.getFocused();)t.pop(),e=!0;return e&&this.emit("focused",this.getFocused()),this.getFocusedAgenda().isEmpty()},fireNext:function(){for(var t=this.agendaGroupStack,e=!1;this.getFocusedAgenda().isEmpty()&&"main"!==this.getFocused();)t.pop();if(!this.getFocusedAgenda().isEmpty()){var r=this.pop();this.emit("fire",r.rule.name,r.match.factHash);var n=r.rule.fire(this.flow,r.match);e=!s(n)||n.then(function(){return!0})}return e},pop:function(){for(var t=this.getFocusedAgenda(),e=t.__root;e.right;)e=e.right;var r=e.data;t.remove(r);var n=this.rules[r.name];return n.tree.remove(r),n.factTable.remove(r),r},peek:function(){for(var t=this.getFocusedAgenda().__root;t.right;)t=t.right;return t.data},modify:function(t,e){this.retract(t,e),this.insert(t,e)},retract:function(t,e){var r=this.rules[t.name];e.rule=t;var n=r.factTable.remove(e);n&&(this.getAgendaGroup(t.rule.agendaGroup).remove(n),r.tree.remove(n))},insert:function(t,e){var r=this.rules[t.name],n=t.rule,o=n.agendaGroup;r.tree.insert(e),this.getAgendaGroup(o).insert(e),n.autoFocus&&this.setFocus(o),r.factTable.insert(e)},dispose:function(){for(var t in this.agendaGroups)this.agendaGroups[t].clear();var e=this.rules;for(t in e)t in e&&(e[t].tree.clear(),e[t].factTable.clear());this.rules={}}}})},{"./extended":12,events:60}],4:[function(require,module,exports){"use strict";var extd=require("../extended"),forEach=extd.forEach,isString=extd.isString;exports.modifiers=["assert","modify","retract","emit","halt","focus","getFacts"];var createFunction=function(body,defined,scope,scopeNames,definedNames){var declares=[];forEach(definedNames,function(t){-1!==body.indexOf(t)&&declares.push("var "+t+"= defined."+t+";")}),forEach(scopeNames,function(t){-1!==body.indexOf(t)&&declares.push("var "+t+"= scope."+t+";")}),body=["((function(){",declares.join(""),"\n\treturn ",body,"\n})())"].join("");try{return eval(body)}catch(t){throw new Error("Invalid action : "+body+"\n"+t.message)}},createDefined=function(t,e,r){return function(t,e,r){if(isString(t)){var n=[];extd(e).keys().forEach(function(e){-1!==t.indexOf(e)&&n.push("var "+e+"= defined."+e+";")}),extd(r).keys().forEach(function(e){-1!==t.indexOf(e)&&n.push("var "+e+"= function(){var prop = scope."+e+"; return __objToStr__.call(prop) === '[object Function]' ? prop.apply(void 0, arguments) : prop;};")}),n.length&&n.unshift("var __objToStr__ = Object.prototype.toString;"),t=[n.join(""),"return ",t,";"].join(""),t=new Function("defined","scope",t)(e,r)}var o=t.hasOwnProperty("constructor")&&"function"==typeof t.constructor?t.constructor:function(e){for(var r in e=e||{})r in t&&(this[r]=e[r])},i=o.prototype;for(var a in t)i[a]=t[a];return o}(t.properties,e,r)};exports.createFunction=createFunction,exports.createDefined=createDefined},{"../extended":12}],5:[function(t,e,r){var n=t("__browserify_Buffer").Buffer,o=t("../extended"),i=t("../parser"),a=t("../constraintMatcher.js"),s=o.indexOf,u=o.forEach,c=o.removeDuplicates,l=o.map,f=o.hash.keys,d=o.merge,h=t("../rule"),p=t("./common"),g=p.modifiers,m=p.createDefined,v=p.createFunction,y=function(){var t=function(t,e,r,n,c){var l=[],f=t[0],d=t[1],h=t[2],p=t[3];if(o.isHash(h)&&(p=h,h=null),!f||!(f=n[f]))throw new Error("Invalid class "+t[0]+" for rule "+c);if(l.push(f),l.push(d,h,p),r.push(l),e.push(d),h&&u(a.getIdentifiers(i.parseConstraint(h)),function(t){e.push(t)}),o.isObject(p))for(var g in p){var m=p[g];-1===s(e,m)&&e.push(m)}};return function(e,r,n){var i=e.name;if(o.isEmpty(e))throw new Error("Rule is empty");var a=e.options||{};a.scope=n;var s=e.constraints||[];s.length||(s=["true"]);var l=e.action;if(o.isUndefined(l))throw new Error("No action was defined for rule "+i);var f=[],d=[];return u(s,function(e){!function e(r,n,o,i,a){if(r.length){var s=r[0];if("not"===s||"exists"===s){var l=[];r.shift(),t(r,o,l,i,a);var f=l[0];f.unshift(s),n.push(f)}else if("or"===s){var d=[s];r.shift(),u(r,function(t){e(t,d,o,i,a)}),n.push(d)}else t(r,o,n,i,a),o=c(o)}}(e,f,d,r,i)}),h.createRule(i,a,f,function(t,e,r,n){var i=[];u(e,function(e){-1!==t.indexOf(e)&&i.push("var "+e+"= facts."+e+";")}),o(r).keys().forEach(function(e){-1!==t.indexOf(e)&&i.push("var "+e+"= defined."+e+";")}),o(n).keys().forEach(function(e){-1!==t.indexOf(e)&&i.push("var "+e+"= scope."+e+";")}),o(g).forEach(function(e){-1!==t.indexOf(e)&&i.push("if(!"+e+"){ var "+e+"= flow."+e+";}")});var a=["facts","flow"];/next\(.*\)/.test(t)&&a.push("next"),t=i.join("")+t;try{return new Function("defined, scope","return "+new Function(a.join(","),t).toString())(r,n)}catch(e){throw new Error("Invalid action : "+t+"\n"+e.message)}}(l,d,r,n))}}();r.parse=function(t,e){return i.parseRuleSet(t,e)},r.compile=function(t,e,r,i){o.isFunction(e)?(r=e,e={}):e=e||{};var a=t.name||e.name;if(!a)throw new Error("Name must be present in JSON or options");var s=new i(a),c=d({Array:Array,String:String,Number:Number,Boolean:Boolean,RegExp:RegExp,Date:Date,Object:Object},e.define||{});void 0!==n&&(c.Buffer=n);var h=d({console:console},e.scope);u(t.scope,function(t){h[t.name]=!0}),u(t.define,function(t){c[t.name]=m(t,c,h)}),o(c).forEach(function(t,e){s.addDefined(e,t)});var p=o(t.scope).pluck("name").union(o(h).keys().value()).value(),g=l(f(c),function(t){return t});u(t.scope,function(t){h[t.name]=v(t.body,c,h,p,g)});var x=t.rules;return x.length&&u(x,function(t){s.__rules=s.__rules.concat(y(t,c,h))}),r&&r.call(s,s),s},r.transpile=t("./transpile").transpile},{"../constraintMatcher.js":9,"../extended":12,"../parser":44,"../rule":49,"./common":4,"./transpile":6,__browserify_Buffer:63}],6:[function(t,e,r){var n=t("__browserify_Buffer").Buffer,o=t("../extended"),i=o.forEach,a=o.indexOf,s=o.merge,u=o.isString,c=t("./common").modifiers,l=t("../constraintMatcher"),f=t("../parser");function d(t,e){var r=[];if("or"===(t=t.slice(0))[0])return r.push('["'+t.shift()+'"'),r.push(o.map(t,function(t){return d(t,e)}).join(",")+"]"),r;if("not"!==t[0]&&"exists"!==t[0]||r.push('"',t.shift(),'", '),e.push(t[1]),r.push(t[0],', "'+t[1].replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'),t.splice(0,2),t.length){var n=t.shift();o.isString(n)&&n?(r.push(',"'+n.replace(/\\/g,"\\\\").replace(/"/g,'\\"'),'"'),i(l.getIdentifiers(f.parseConstraint(n)),function(t){e.push(t)})):(r.push(',"true"'),t.unshift(n))}return function(t,e){if(t.length&&o.isString(t[0])){var r=t[0].match(" *(from)");if(r)switch(r=r[0]){case"from":e.push(', "',t.shift(),'"');break;default:throw new Error("Unrecognized modifier "+r)}}}(t,r),function(t,e,r){if(t.length&&o.isHash(t[0])){var n=t.shift();o(n).values().forEach(function(t){-1===a(r,t)&&r.push(t)}),e.push(","+o.format("%j",[n]))}}(t,r,e),"["+r.join("")+"]"}r.transpile=function(t,e){e=e||{};var r=[];r.push("(function(){"),r.push("return function(options){"),r.push("options = options || {};"),r.push("var bind = function(scope, fn){return function(){return fn.apply(scope, arguments);};}, defined = {Array: Array, String: String, Number: Number, Boolean: Boolean, RegExp: RegExp, Date: Date, Object: Object}, scope = options.scope || {};"),r.push("var optDefined = options.defined || {}; for(var i in optDefined){defined[i] = optDefined[i];}");var a=s({Array:Array,String:String,Number:Number,Boolean:Boolean,RegExp:RegExp,Date:Date,Object:Object},e.define||{});void 0!==n&&(a.Buffer=n);var l=s({console:console},e.scope);return r.push(["return b2wgin.flow('",e.name,"', function(){"].join("")),r.push(o(t.define||[]).map(function(t){var e=t.name;return t[e]={},["var",e,"= defined."+e,"= this.addDefined('"+e+"',",function(t){t=u(t)?new Function("return "+t+";")():t;var e,r=["(function(){"];for(var n in t.hasOwnProperty("constructor")&&"function"==typeof t.constructor?r.push("var Defined = "+t.constructor.toString()+";"):r.push("var Defined = function(opts){ for(var i in opts){if(opts.hasOwnProperty(i)){this[i] = opts[i];}}};"),r.push("var proto = Defined.prototype;"),t)t.hasOwnProperty(n)&&(e=t[n],r.push("proto."+n+" = "+(o.isFunction(e)?e.toString():o.format("%j",e))+";"));return r.push("return Defined;"),r.push("}())"),r.join("")}(t.properties)+");"].join(" ")}).value().join("\n")),r.push(o(t.scope||[]).map(function(t){var e=t.name;return l[e]={},["var",e,"= scope."+e,"= ",t.body,";"].join(" ")}).value().join("\n")),r.push("scope.console = console;\n"),r.push(o(t.rules||[]).map(function(t){var e=[],r=["this.rule('",t.name.replace(/'/g,"\\'"),"'"],n=o.merge(t.options||{},{scope:"scope"});return r.push(",",o.format("%j",[n]).replace(/(:"scope")/,":scope")),t.constraints&&!o.isEmpty(t.constraints)&&(r.push(", ["),r.push(o(t.constraints).map(function(t){return d(t,e)}).value().join(",")),r.push("]")),r.push(",",function(t,e,r,n){var a=[],s={};i(e,function(e){-1!==t.indexOf(e)&&(s[e]=!0,a.push("var "+e+"= facts."+e+";"))}),o(r).keys().forEach(function(e){-1===t.indexOf(e)||s[e]||(s[e]=!0,a.push("var "+e+"= defined."+e+";"))}),o(n).keys().forEach(function(e){-1===t.indexOf(e)||s[e]||(s[e]=!0,a.push("var "+e+"= scope."+e+";"))}),o(c).forEach(function(e){-1===t.indexOf(e)||s[e]||a.push("var "+e+"= flow."+e+";")});var u=["facts","flow"];/next\(.*\)/.test(t)&&u.push("next"),t=a.join("")+t;try{return["function(",u.join(","),"){",t,"}"].join("")}catch(e){throw new Error("Invalid action : "+t+"\n"+e.message)}}(t.action,e,a,l)),r.push(");"),r.join("")}).value().join("")),r.push("});"),r.push("};"),r.push("}());"),r.join("")}},{"../constraintMatcher":9,"../extended":12,"../parser":44,"./common":4,__browserify_Buffer:63}],7:[function(t,e,r){var n=t("./extended").map;var o={salience:function(t,e){return t.rule.priority-e.rule.priority},bucketCounter:function(t,e){return t.counter-e.counter},factRecency:function(t,e){for(var r=0,n=t.match.recency,o=e.match.recency,i=n.length-1,a=o.length-1;n[r]===o[r]&&r<i&&r<a&&r++;);var s=n[r]-o[r];return s||(s=i-a),s},activationRecency:function(t,e){return t.recency-e.recency}};r.strategies=o,r.strategy=function(t){var e=(t=n(t,function(t){return o[t]})).length;return function(r,n){var o=-1,i=0;if(!(r===n||r.name===n.name&&r.hashCode===n.hashCode)){for(;++o<e&&!i;)i=t[o](r,n);i=i>0?1:-1}return i}}},{"./extended":12}],8:[function(t,e,r){"use strict";var n,o=t("./extended"),i=o.deepEqual,a=o.merge,s=o.instanceOf,u=o.filter,c=0,l=(0,o.declare)({type:null,instance:{constructor:function(e){n||(n=t("./constraintMatcher")),this.id=c++,this.constraint=e,o.bindAll(this,["assert"])},assert:function(){throw new Error("not implemented")},getIndexableProperties:function(){return[]},equal:function(t){return s(t,this._static)&&this.get("alias")===t.get("alias")&&o.deepEqual(this.constraint,t.constraint)},getters:{variables:function(){return[this.get("alias")]}}}});l.extend({instance:{type:"object",constructor:function(t){this._super([t])},assert:function(t){return t instanceof this.constraint||t.constructor===this.constraint},equal:function(t){return s(t,this._static)&&this.constraint===t.constraint}}}).as(r,"ObjectConstraint");var f=l.extend({instance:{type:"equality",constructor:function(t,e){this._super([t]),e=e||{},this.pattern=e.pattern,this._matcher=n.getMatcher(t,e,!0)},assert:function(t){return this._matcher(t)}}}).as(r,"EqualityConstraint");f.extend({instance:{type:"inequality"}}).as(r,"InequalityConstraint"),f.extend({instance:{type:"comparison"}}).as(r,"ComparisonConstraint"),l.extend({instance:{type:"equality",constructor:function(){this._super([[!0]])},equal:function(t){return s(t,this._static)&&this.get("alias")===t.get("alias")},assert:function(){return!0}}}).as(r,"TrueConstraint");var d=l.extend({instance:{type:"reference",constructor:function(t,e){this.cache={},this._super([t]),e=e||{},this.values=[],this.pattern=e.pattern,this._options=e,this._matcher=n.getMatcher(t,e,!1)},assert:function(t,e){try{return this._matcher(t,e)}catch(t){throw new Error("Error with evaluating pattern "+this.pattern+" "+t.message)}},merge:function(t){var e=this;return t instanceof d&&((e=new this._static([this.constraint,t.constraint,"and"],a({},this._options,this._options)))._alias=this._alias||t._alias,e.vars=this.vars.concat(t.vars)),e},equal:function(t){return s(t,this._static)&&o.deepEqual(this.constraint,t.constraint)},getters:{variables:function(){return this.vars},alias:function(){return this._alias}},setters:{alias:function(t){this._alias=t,this.vars=u(n.getIdentifiers(this.constraint),function(e){return e!==t})}}}}).as(r,"ReferenceConstraint");d.extend({instance:{type:"reference_equality",op:"eq",getIndexableProperties:function(){return n.getIndexableProperties(this.constraint)}}}).as(r,"ReferenceEqualityConstraint").extend({instance:{type:"reference_inequality",op:"neq"}}).as(r,"ReferenceInequalityConstraint").extend({instance:{type:"reference_gt",op:"gt"}}).as(r,"ReferenceGTConstraint").extend({instance:{type:"reference_gte",op:"gte"}}).as(r,"ReferenceGTEConstraint").extend({instance:{type:"reference_lt",op:"lt"}}).as(r,"ReferenceLTConstraint").extend({instance:{type:"reference_lte",op:"lte"}}).as(r,"ReferenceLTEConstraint"),l.extend({instance:{type:"hash",constructor:function(t){this._super([t])},equal:function(t){return o.instanceOf(t,this._static)&&this.get("alias")===t.get("alias")&&o.deepEqual(this.constraint,t.constraint)},assert:function(){return!0},getters:{variables:function(){return this.constraint}}}}).as(r,"HashConstraint"),l.extend({instance:{constructor:function(t,e){this.type="from",this.constraints=n.getSourceMatcher(t,e||{},!0),o.bindAll(this,["assert"])},equal:function(t){return s(t,this._static)&&this.get("alias")===t.get("alias")&&i(this.constraints,t.constraints)},assert:function(t,e){return this.constraints(t,e)},getters:{variables:function(){return this.constraint}}}}).as(r,"FromConstraint"),l.extend({instance:{constructor:function(t,e){this.type="custom",this.fn=t,this.options=e,o.bindAll(this,["assert"])},equal:function(t){return s(t,this._static)&&this.fn===t.constraint},assert:function(t,e){return this.fn(t,e)}}}).as(r,"CustomConstraint")},{"./constraintMatcher":9,"./extended":12}],9:[function(t,e,r){"use strict";var n=t("./extended"),o=n.isArray,i=n.forEach,a=n.some,s=n.indexOf,u=n.isNumber,c=n.removeDuplicates,l=t("./constraint");var f={indexOf:n.indexOf,now:function(){return new Date},Date:function(t,e,r,n,o,i,a){var s=new Date;return u(t)&&s.setYear(t),u(e)&&s.setMonth(e),u(r)&&s.setDate(r),u(n)&&s.setHours(n),u(o)&&s.setMinutes(o),u(i)&&s.setSeconds(i),u(a)&&s.setMilliseconds(a),s},lengthOf:function(t,e){return t.length===e},isTrue:function(t){return!0===t},isFalse:function(t){return!1===t},isNotNull:function(t){return null!==t},dateCmp:function(t,e){return n.compare(t,e)}};i(["years","days","months","hours","minutes","seconds"],function(t){f[t+"FromNow"]=n[t+"FromNow"],f[t+"Ago"]=n[t+"Ago"]}),i(["isArray","isNumber","isHash","isObject","isDate","isBoolean","isString","isRegExp","isNull","isEmpty","isUndefined","isDefined","isUndefinedOrNull","isPromiseLike","isFunction","deepEqual"],function(t){var e=n[t];f[t]=function(){return e.apply(n,arguments)}});var d={equal:function(t,e){var r=!1;return t===e?r=!0:t[2]===e[2]&&(r=-1!==s(["string","number","boolean","regexp","identifier","null"],t[2])?t[0]===e[0]:"unary"===t[2]||"logicalNot"===t[2]?this.equal(t[0],e[0]):this.equal(t[0],e[0])&&this.equal(t[1],e[1])),r},__getProperties:function(t){var e=[];if(t){var r=t[2];if(!r)return e;"prop"!==r&&"identifier"!==r&&"string"!==r&&"number"!==r&&"boolean"!==r&&"regexp"!==r&&"unary"!==r&&"unary"!==r?(e[0]=this.__getProperties(t[0]),e[1]=this.__getProperties(t[1])):e="identifier"===r?[t[0]]:d.__getProperties(t[1]).concat(d.__getProperties(t[0]))}return e},getIndexableProperties:function(t){return"composite"===t[2]?this.getIndexableProperties(t[0]):/^(\w+(\['[^']*'])*) *([!=]==?|[<>]=?) (\w+(\['[^']*'])*)$/.test(this.parse(t))?function t(e){return n(e).map(function(e){return o(e)?o(e[0])?t(e).value():e.reverse().join("."):e}).flatten().filter(function(t){return!!t})}(this.__getProperties(t)).flatten().value():[]},getIdentifiers:function(t){var e=[],r=t[2];if("identifier"===r)return[t[0]];if("function"===r)e=e.concat(this.getIdentifiers(t[0])).concat(this.getIdentifiers(t[1]));else if("string"!==r&&"number"!==r&&"boolean"!==r&&"regexp"!==r&&"unary"!==r&&"unary"!==r)if("prop"===r){if(e=e.concat(this.getIdentifiers(t[0])),t[1])for(var n=t[1];o(n);){if("function"===n[2]){e=e.concat(this.getIdentifiers(n[1]));break}n=n[1]}}else t[0]&&(e=e.concat(this.getIdentifiers(t[0]))),t[1]&&(e=e.concat(this.getIdentifiers(t[1])));return c(e)},toConstraints:function(t,e){var r=[],n=e.alias,o=e.scope||{},i=t[2];if("and"===i)r=r.concat(this.toConstraints(t[0],e)).concat(this.toConstraints(t[1],e));else if("composite"===i||"or"===i||"lt"===i||"gt"===i||"lte"===i||"gte"===i||"like"===i||"notLike"===i||"eq"===i||"neq"===i||"seq"===i||"sneq"===i||"in"===i||"notIn"===i||"prop"===i||"propLookup"===i||"function"===i||"logicalNot"===i){var s=a(this.getIdentifiers(t),function(t){return!(t===n||t in f||t in o)});switch(i){case"eq":case"seq":r.push(new l[s?"ReferenceEqualityConstraint":"EqualityConstraint"](t,e));break;case"neq":case"sneq":r.push(new l[s?"ReferenceInequalityConstraint":"InequalityConstraint"](t,e));break;case"gt":r.push(new l[s?"ReferenceGTConstraint":"ComparisonConstraint"](t,e));break;case"gte":r.push(new l[s?"ReferenceGTEConstraint":"ComparisonConstraint"](t,e));break;case"lt":r.push(new l[s?"ReferenceLTConstraint":"ComparisonConstraint"](t,e));break;case"lte":r.push(new l[s?"ReferenceLTEConstraint":"ComparisonConstraint"](t,e));break;default:r.push(new l[s?"ReferenceConstraint":"ComparisonConstraint"](t,e))}}return r},parse:function(t){return this[t[2]](t[0],t[1])},composite:function(t){return this.parse(t)},and:function(t,e){return["(",this.parse(t),"&&",this.parse(e),")"].join(" ")},or:function(t,e){return["(",this.parse(t),"||",this.parse(e),")"].join(" ")},prop:function(t,e){return"function"===e[2]?[this.parse(t),this.parse(e)].join("."):[this.parse(t),"['",this.parse(e),"']"].join("")},propLookup:function(t,e){return"function"===e[2]?[this.parse(t),this.parse(e)].join("."):[this.parse(t),"[",this.parse(e),"]"].join("")},unary:function(t){return-1*this.parse(t)},plus:function(t,e){return[this.parse(t),"+",this.parse(e)].join(" ")},minus:function(t,e){return[this.parse(t),"-",this.parse(e)].join(" ")},mult:function(t,e){return[this.parse(t),"*",this.parse(e)].join(" ")},div:function(t,e){return[this.parse(t),"/",this.parse(e)].join(" ")},mod:function(t,e){return[this.parse(t),"%",this.parse(e)].join(" ")},lt:function(t,e){return[this.parse(t),"<",this.parse(e)].join(" ")},gt:function(t,e){return[this.parse(t),">",this.parse(e)].join(" ")},lte:function(t,e){return[this.parse(t),"<=",this.parse(e)].join(" ")},gte:function(t,e){return[this.parse(t),">=",this.parse(e)].join(" ")},like:function(t,e){return[this.parse(e),".test(",this.parse(t),")"].join("")},notLike:function(t,e){return["!",this.parse(e),".test(",this.parse(t),")"].join("")},eq:function(t,e){return[this.parse(t),"==",this.parse(e)].join(" ")},seq:function(t,e){return[this.parse(t),"===",this.parse(e)].join(" ")},neq:function(t,e){return[this.parse(t),"!=",this.parse(e)].join(" ")},sneq:function(t,e){return[this.parse(t),"!==",this.parse(e)].join(" ")},in:function(t,e){return["(indexOf(",this.parse(e),",",this.parse(t),")) != -1"].join("")},notIn:function(t,e){return["(indexOf(",this.parse(e),",",this.parse(t),")) == -1"].join("")},arguments:function(t,e){var r=[];return t&&r.push(this.parse(t)),e&&r.push(this.parse(e)),r.join(",")},array:function(t){var e=[];return t?(e=this.parse(t),o(e)?e:["[",e,"]"].join("")):["[",e.join(","),"]"].join("")},function:function(t,e){var r=this.parse(e);return[this.parse(t),"(",r,")"].join("")},string:function(t){return"'"+t+"'"},number:function(t){return t},boolean:function(t){return t},regexp:function(t){return t},identifier:function(t){return t},null:function(){return"null"},logicalNot:function(t){return["!(",this.parse(t),")"].join("")}},h=0,p=r.toJs=function(t,e,r,o,i){var a=d.parse(t);e=e||{};var s=d.getIdentifiers(t),u=["var indexOf = definedFuncs.indexOf; var hasOwnProperty = Object.prototype.hasOwnProperty;"],c=[];n(s).filter(function(t){var r=["var ",t," = "];if(f.hasOwnProperty(t))r.push("definedFuncs['",t,"']");else{if(!e.hasOwnProperty(t))return!0;r.push("scope['",t,"']")}return r.push(";"),u.push(r.join("")),!1}).forEach(function(t){var e=["var ",t," = "];o||t!==r?e.push("fact."+t):t===r&&e.push("hash.",t,""),e.push(";"),c.push(e.join(""))});var l=u.join("")+"return function matcher"+h+++(o?"(fact){":"(fact, hash){")+c.join("")+" return "+(i?i(a):a)+";}";return new Function("definedFuncs, scope",l)(f,e)};r.getMatcher=function(t,e,r){return p(t,(e=e||{}).scope,e.alias,r,function(t){return"!!("+t+")"})},r.getSourceMatcher=function(t,e,r){return p(t,(e=e||{}).scope,e.alias,r,function(t){return t})},r.toConstraints=function(t,e){return"function"==typeof t?[new l.CustomConstraint(t,e)]:d.toConstraints(t,e)},r.equal=function(t,e){return d.equal(t,e)},r.getIdentifiers=function(t){return d.getIdentifiers(t)},r.getIndexableProperties=function(t){return d.getIndexableProperties(t)}},{"./constraint":8,"./extended":12}],10:[function(t,e,r){"use strict";var n=t("./extended"),o=n.isBoolean,i=n.declare,a=n.indexOf,s=Array.prototype.push;function u(t,e,r){for(var n,o=-1,i=r.length;++o<i;)t[n=r[o]]=e[n]}var c=i({instance:{isMatch:!0,hashCode:"",facts:null,factIds:null,factHash:null,recency:null,aliases:null,constructor:function(){this.facts=[],this.factIds=[],this.factHash={},this.recency=[],this.aliases=[]},addFact:function(t){return s.call(this.facts,t),s.call(this.recency,t.recency),s.call(this.factIds,t.id),this.hashCode=this.factIds.join(":"),this},merge:function(t){var e=new c;return e.isMatch=t.isMatch,s.apply(e.facts,this.facts),s.apply(e.facts,t.facts),s.apply(e.aliases,this.aliases),s.apply(e.aliases,t.aliases),e.hashCode=this.hashCode+":"+t.hashCode,u(e.factHash,this.factHash,this.aliases),u(e.factHash,t.factHash,t.aliases),function(t,e,r){s.apply(t,e);for(var n,o=-1,i=r.length,u=t.length;++o<i;)n=r[o],-1===a(t,n)&&(t[u++]=n)}(e.recency,this.recency,t.recency),e}}}),l=i({instance:{match:null,factHash:null,aliases:null,fact:null,hashCode:null,paths:null,pathsHash:null,constructor:function(t,e,r){this.fact=t,this.match=r||(new c).addFact(t),this.factHash=this.match.factHash,this.aliases=this.match.aliases,this.hashCode=this.match.hashCode,e?(this.paths=e,this.pathsHash=function(t,e){for(var r="",n=-1,o=t.length;++n<o;)r+=t[n].id+":";return r+=e}(e,this.hashCode)):this.pathsHash=this.hashCode},set:function(t,e){return this.factHash[t]=e,this.aliases.push(t),this},isMatch:function(t){return o(t)?(this.match.isMatch=t,this):this.match.isMatch},mergeMatch:function(t){var e=this.match=this.match.merge(t);return this.factHash=e.factHash,this.hashCode=e.hashCode,this.aliases=e.aliases,this},clone:function(t,e,r){return new l(t||this.fact,e||this.path,r||this.match)}}}).as(e)},{"./extended":12}],11:[function(t,e,r){var n=t("./extended"),o=n.Promise,i=t("./nextTick"),a=n.isPromiseLike;o.extend({instance:{looping:!1,constructor:function(t,e){this._super([]),this.flow=t,this.agenda=t.agenda,this.rootNode=t.rootNode,this.matchUntilHalt=!!e,n.bindAll(this,["onAlter","callNext"])},halt:function(){this.__halted=!0,this.looping||this.callback()},onAlter:function(){this.flowAltered=!0,this.looping||!this.matchUntilHalt||this.__halted||this.callNext()},setup:function(){var t=this.flow;this.rootNode.resetCounter(),t.on("assert",this.onAlter),t.on("modify",this.onAlter),t.on("retract",this.onAlter)},tearDown:function(){var t=this.flow;t.removeListener("assert",this.onAlter),t.removeListener("modify",this.onAlter),t.removeListener("retract",this.onAlter)},__handleAsyncNext:function(t){var e=this,r=e.agenda;return t.then(function(){e.looping=!1,r.isEmpty()?e.matchUntilHalt&&!e.__halted||e.callback():(e.flowAltered&&(e.rootNode.incrementCounter(),e.flowAltered=!1),e.__halted?e.callback():e.callNext()),e=null},this.errback)},__handleSyncNext:function(t){return this.looping=!1,this.agenda.isEmpty()||this.flowAltered&&(this.rootNode.incrementCounter(),this.flowAltered=!1),t&&!this.__halted?i(this.callNext):this.matchUntilHalt&&!this.__halted||this.callback(),t},callback:function(){this.tearDown(),this._super(arguments)},callNext:function(){this.looping=!0;var t=this.agenda.fireNext();return a(t)?this.__handleAsyncNext(t):this.__handleSyncNext(t)},execute:function(){return this.setup(),this.callNext(),this}}}).as(e)},{"./extended":12,"./nextTick":17}],12:[function(t,e,r){var n=t("array-extended"),o=n.unique,i=n.indexOf,a=n.map,s=Array.prototype.slice,u=Array.prototype.splice;function c(t){var e=t.match(/(\w+)\(\)$/);return e?(t=e[1],function(e){return e[t]()}):function(e){return e[t]}}e.exports=t("extended")().register(t("date-extended")).register(n).register(t("object-extended")).register(t("string-extended")).register(t("promise-extended")).register(t("function-extended")).register(t("is-extended")).register("intersection",function(t,e){var r,n,o=-1;for(n=(t=s.call(t)).length;++o<n;)r=t[o],-1===i(e,r)&&(u.call(t,o--,1),n--);return t}).register("inPlaceIntersection",function(t,e){var r,n,o=-1;for(n=t.length;++o<n;)r=t[o],-1===i(e,r)&&(u.call(t,o--,1),n--);return t}).register("inPlaceDifference",function(t,e){var r,n,o=-1;for(n=t.length;++o<n;)r=t[o],-1!==i(e,r)&&(u.call(t,o--,1),n--);return t}).register("diffArr",function(t,e){var r,n,o,i=[],a=-1,s=e.length,u=t.length;if(s>u){for(i=t.slice();++a<s;)for(n=e[a],r=-1,u=i.length;++r<u;)if(i[r]===n){i.splice(r,1);break}}else for(;++a<u;){for(n=t[a],r=-1,o=!1;++r<s;)if(e[r]===n){o=!0;break}o||i.push(n)}return i}).register("diffHash",function(t,e){var r={};for(var n in t)hasOwnProperty.call(e,n)||(r[n]=t[n]);return r}).register("unionArr",function(t,e){return o(t.concat(e))}).register("plucker",function(t){if(1===(t=t.split(".")).length)return c(t[0]);var e=a(t,function(t){return c(t)}),r=e.length;return function(t){for(var n=-1,o=t;++n<r;)o=e[n](o);return o}}).register("HashTable",t("ht")).register("declare",t("declare.js")).register(t("leafy")).register("LinkedList",t("./linkedList"))},{"./linkedList":16,"array-extended":52,"date-extended":53,"declare.js":55,extended:56,"function-extended":59,ht:65,"is-extended":66,leafy:67,"object-extended":68,"promise-extended":69,"string-extended":70}],13:[function(t,e,r){"use strict";var n=t("./extended"),o=n.bind,i=n.declare,a=t("./nodes"),s=t("events").EventEmitter,u=t("./workingMemory").WorkingMemory,c=t("./executionStrategy"),l=t("./agenda");e.exports=i(s,{instance:{name:null,executionStrategy:null,constructor:function(t,e){this.env=null,this.name=t,this.__rules={},this.conflictResolutionStrategy=e,this.workingMemory=new u,this.agenda=new l(this,e),this.agenda.on("fire",o(this,"emit","fire")),this.agenda.on("focused",o(this,"emit","focused")),this.rootNode=new a.RootNode(this.workingMemory,this.agenda),n.bindAll(this,"halt","assert","retract","modify","focus","emit","getFacts","getFact")},getFacts:function(t){return t?this.workingMemory.getFactsByType(t):this.workingMemory.getFacts()},getFact:function(t){var e;return(e=t?this.workingMemory.getFactsByType(t):this.workingMemory.getFacts())&&e[0]},focus:function(t){return this.agenda.setFocus(t),this},halt:function(){return this.executionStrategy.halt(),this},dispose:function(){this.workingMemory.dispose(),this.agenda.dispose(),this.rootNode.dispose()},assert:function(t){return this.rootNode.assertFact(this.workingMemory.assertFact(t)),this.emit("assert",t),t},retract:function(t){return this.rootNode.retractFact(this.workingMemory.retractFact(t)),this.emit("retract",t),t},modify:function(t,e){return"function"==typeof e&&e.call(t,t),this.rootNode.modifyFact(this.workingMemory.modifyFact(t)),this.emit("modify",t),t},print:function(){this.rootNode.print()},containsRule:function(t){return this.rootNode.containsRule(t)},rule:function(t){this.rootNode.assertRule(t)},matchUntilHalt:function(t){return(this.executionStrategy=new c(this,!0)).execute().classic(t).promise()},match:function(t){return(this.executionStrategy=new c(this)).execute().classic(t).promise()}}})},{"./agenda":3,"./executionStrategy":11,"./extended":12,"./nodes":27,"./workingMemory":50,events:60}],14:[function(t,e,r){"use strict";var n=t("./extended"),o=n.instanceOf,i=n.forEach,a=n.declare,s=t("./pattern").InitialFact,u=t("./conflict"),c=u.strategy(["salience","activationRecency"]),l=t("./rule"),f=t("./flow"),d={},h=a({instance:{constructor:function(t,e){if(this.name=t,this.cb=e,this.__rules=[],this.__defined={},this.conflictResolutionStrategy=c,e&&e.call(this,this),d.hasOwnProperty(t))throw new Error("Flow with "+t+" already defined");d[t]=this},conflictResolution:function(t){return this.conflictResolutionStrategy=u.strategy(t),this},getDefined:function(t){var e=this.__defined[t.toLowerCase()];if(!e)throw new Error(t+" flow class is not defined");return e},addDefined:function(t,e){return this.__defined[t.toLowerCase()]=e,e},rule:function(){return this.__rules=this.__rules.concat(l.createRule.apply(l,arguments)),this},getSession:function(){var t=new f(this.name,this.conflictResolutionStrategy);i(this.__rules,function(e){t.rule(e)}),t.assert(new s);for(var e=0,r=arguments.length;e<r;e++)t.assert(arguments[e]);return t},containsRule:function(t){return n.some(this.__rules,function(e){return e.name===t})}},static:{getFlow:function(t){return d[t]},hasFlow:function(t){return n.has(d,t)},deleteFlow:function(t){return o(t,h)&&(t=t.name),delete d[t],h},deleteFlows:function(){for(var t in d)t in d&&delete d[t];return h},create:function(t,e){return new h(t,e)}}}).as(e)},{"./conflict":7,"./extended":12,"./flow":13,"./pattern":48,"./rule":49}],15:[function(t,e,r){"use strict";var n=t("./extended"),o=t("fs"),i=t("path"),a=t("./compile"),s=t("./flowContainer");function u(t){return/\.b2wgin$/.test(t)}function c(t){return u(t)?a.parse(o.readFileSync(t,"utf8"),t):a.parse(t)}r.Flow=s,r.getFlow=s.getFlow,r.hasFlow=s.hasFlow,r.deleteFlow=function(t){return s.deleteFlow(t),this},r.deleteFlows=function(){return s.deleteFlows(),this},r.flow=s.create,r.compile=function(t,e,r){if(n.isFunction(e)?(r=e,e={}):e=e||{},n.isString(t)&&(e.name=e.name||(u(t)?i.basename(t,i.extname(t)):null),t=c(t)),!e.name)throw new Error("Name required when compiling b2wgin source");return a.compile(t,e,r,s)},r.transpile=function(t,e){return e=e||{},n.isString(t)&&(e.name=e.name||(u(t)?i.basename(t,i.extname(t)):null),t=c(t)),a.transpile(t,e)},r.parse=c},{"./compile":5,"./extended":12,"./flowContainer":14,fs:61,path:62}],16:[function(t,e,r){t("declare.js")({instance:{constructor:function(){this.head=null,this.tail=null,this.length=null},push:function(t){var e=this.tail,r=this.head,n={data:t,prev:e,next:null};return e&&(this.tail.next=n),this.tail=n,r||(this.head=n),this.length++,n},remove:function(t){t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,this.length--},forEach:function(t){for(var e={next:this.head};e=e.next;)t(e.data)},toArray:function(){for(var t={next:this.head},e=[];t=t.next;)e.push(t);return e},removeByData:function(t){for(var e={next:this.head};e=e.next;)if(e.data===t){this.remove(e);break}},getByData:function(t){for(var e={next:this.head};e=e.next;)if(e.data===t)return e},clear:function(){this.head=this.tail=null,this.length=0}}}).as(e)},{"declare.js":55}],17:[function(t,e,r){var n,o=t("__browserify_process"),i=t("./extended");if("function"==typeof setImmediate)n="undefined"!=typeof window?i.bind(window,setImmediate):setImmediate;else if(void 0!==o)n=o.nextTick;else if("undefined"!=typeof MessageChannel){var a=new MessageChannel,s={},u=s;a.port1.onmessage=function(){var t=(s=s.next).task;delete s.task,t()},n=function(t){u=u.next={task:t},a.port2.postMessage(0)}}else n=function(t){setTimeout(t,0)};e.exports=n},{"./extended":12,__browserify_process:64}],18:[function(t,e,r){var n=t("./node"),o=t("../extended").intersection;n.extend({instance:{__propagatePaths:function(t,e){for(var r,n,i,a,s=this.__entrySet,u=s.length;--u>-1;)n=(r=s[u]).key,i=r.value,(a=o(i,e.paths)).length&&n[t](e.clone(null,a,null))},__propagateNoPaths:function(t,e){for(var r=this.__entrySet,n=r.length;--n>-1;)r[n].key[t](e)},__propagate:function(t,e){e.paths?this.__propagatePaths(t,e):this.__propagateNoPaths(t,e)}}}).as(e)},{"../extended":12,"./node":37}],19:[function(t,e,r){t("./alphaNode").extend({instance:{constructor:function(){this._super(arguments),this.alias=this.constraint.get("alias")},toString:function(){return"AliasNode"+this.__count},assert:function(t){return this.__propagate("assert",t.set(this.alias,t.fact.object))},modify:function(t){return this.__propagate("modify",t.set(this.alias,t.fact.object))},retract:function(t){return this.__propagate("retract",t.set(this.alias,t.fact.object))},equal:function(t){return t instanceof this._static&&this.alias===t.alias}}}).as(e)},{"./alphaNode":20}],20:[function(t,e,r){"use strict";t("./node").extend({instance:{constructor:function(t){this._super([]),this.constraint=t,this.constraintAssert=this.constraint.assert},toString:function(){return"AlphaNode "+this.__count},equal:function(t){return this.constraint.equal(t.constraint)}}}).as(e)},{"./node":37}],21:[function(t,e,r){var n=t("../extended").hash.keys,o=t("./node"),i=t("./misc/leftMemory"),a=t("./misc/rightMemory");o.extend({instance:{nodeType:"BetaNode",constructor:function(){this._super([]),this.leftMemory={},this.rightMemory={},this.leftTuples=new i,this.rightTuples=new a},__propagate:function(t,e){for(var r=this.__entrySet,n=r.length;--n>-1;)r[n].key[t](e)},dispose:function(){this.leftMemory={},this.rightMemory={},this.leftTuples.clear(),this.rightTuples.clear()},disposeLeft:function(t){this.leftMemory={},this.leftTuples.clear(),this.propagateDispose(t)},disposeRight:function(t){this.rightMemory={},this.rightTuples.clear(),this.propagateDispose(t)},hashCode:function(){return this.nodeType+" "+this.__count},toString:function(){return this.nodeType+" "+this.__count},retractLeft:function(t){for(var e=(t=this.removeFromLeftMemory(t).data).rightMatches,r=n(e),o=-1,i=r.length;++o<i;)this.__propagate("retract",e[r[o]].clone())},retractRight:function(t){for(var e=(t=this.removeFromRightMemory(t).data).leftMatches,r=n(e),o=-1,i=r.length;++o<i;)this.__propagate("retract",e[r[o]].clone())},assertLeft:function(t){this.__addToLeftMemory(t);for(var e=this.rightTuples.getRightMemory(t),r=-1,n=e.length;++r<n;)this.propagateFromLeft(t,e[r].data)},assertRight:function(t){this.__addToRightMemory(t);for(var e=this.leftTuples.getLeftMemory(t),r=-1,n=e.length;++r<n;)this.propagateFromRight(t,e[r].data)},modifyLeft:function(t){var e=this.removeFromLeftMemory(t).data;this.__addToLeftMemory(t);var r,n=this.rightTuples.getRightMemory(t),o=n.length,i=-1;if(o)for(r=e.rightMatches;++i<o;)this.propagateAssertModifyFromLeft(t,r,n[i].data);else this.propagateRetractModifyFromLeft(e)},modifyRight:function(t){var e=this.removeFromRightMemory(t).data;this.__addToRightMemory(t);var r=this.leftTuples.getLeftMemory(t);if(r.length)for(var n=e.leftMatches,o=-1,i=r.length;++o<i;)this.propagateAssertModifyFromRight(t,n,r[o].data);else this.propagateRetractModifyFromRight(e)},propagateFromLeft:function(t,e){this.__propagate("assert",this.__addToMemoryMatches(e,t,t.clone(null,null,t.match.merge(e.match))))},propagateFromRight:function(t,e){this.__propagate("assert",this.__addToMemoryMatches(t,e,e.clone(null,null,e.match.merge(t.match))))},propagateRetractModifyFromLeft:function(t){for(var e=t.rightMatches,r=n(e),o=r.length,i=-1;++i<o;)this.__propagate("retract",e[r[i]].clone())},propagateRetractModifyFromRight:function(t){for(var e=t.leftMatches,r=n(e),o=r.length,i=-1;++i<o;)this.__propagate("retract",e[r[i]].clone())},propagateAssertModifyFromLeft:function(t,e,r){r.hashCode in e?this.__propagate("modify",this.__addToMemoryMatches(r,t,t.clone(null,null,t.match.merge(r.match)))):this.propagateFromLeft(t,r)},propagateAssertModifyFromRight:function(t,e,r){r.hashCode in e?this.__propagate("modify",this.__addToMemoryMatches(t,r,t.clone(null,null,r.match.merge(t.match)))):this.propagateFromRight(t,r)},removeFromRightMemory:function(t){var e=t.hashCode;t=this.rightMemory[e]||null;var r=this.rightTuples;if(t){var o=this.leftMemory,i=t.data.leftMatches;r.remove(t);for(var a=n(i),s=-1,u=a.length;++s<u;)delete o[a[s]].data.rightMatches[e];delete this.rightMemory[e]}return t},removeFromLeftMemory:function(t){var e=t.hashCode;if(t=this.leftMemory[e]||null){var r=this.rightMemory,o=t.data.rightMatches;this.leftTuples.remove(t);for(var i=n(o),a=-1,s=i.length;++a<s;)delete r[i[a]].data.leftMatches[e];delete this.leftMemory[e]}return t},getRightMemoryMatches:function(t){var e=this.leftMemory[t.hashCode],r={};return e&&(r=e.rightMatches),r},__addToMemoryMatches:function(t,e,r){var n,o=t.hashCode,i=this.rightMemory[o],a=e.hashCode;if(i){if(a in(i=i.data).leftMatches)throw new Error("Duplicate left fact entry");i.leftMatches[a]=r}if(n=this.leftMemory[a]){if(o in(n=n.data).rightMatches)throw new Error("Duplicate right fact entry");n.rightMatches[o]=r}return r},__addToRightMemory:function(t){var e=t.hashCode,r=this.rightMemory;return!(e in r)&&(r[e]=this.rightTuples.push(t),t.leftMatches={},!0)},__addToLeftMemory:function(t){var e=t.hashCode,r=this.leftMemory;return!(e in r)&&(r[e]=this.leftTuples.push(t),t.rightMatches={},!0)}}}).as(e)},{"../extended":12,"./misc/leftMemory":32,"./misc/rightMemory":34,"./node":37}],22:[function(t,e,r){t("./alphaNode").extend({instance:{constructor:function(){this.memory={},this._super(arguments),this.constraintAssert=this.constraint.assert},assert:function(t){(this.memory[t.pathsHash]=this.constraintAssert(t.factHash))&&this.__propagate("assert",t)},modify:function(t){var e=this.memory,r=t.pathsHash,n=e[r];(e[r]=this.constraintAssert(t.factHash))?this.__propagate(n?"modify":"assert",t):n&&this.__propagate("retract",t)},retract:function(t){var e=t.pathsHash,r=this.memory;r[e]&&this.__propagate("retract",t),delete r[e]},toString:function(){return"EqualityNode"+this.__count}}}).as(e)},{"./alphaNode":20}],23:[function(t,e,r){var n=t("./fromNotNode"),o=t("../extended"),i=t("../context"),a=o.isDefined,s=o.isArray;n.extend({instance:{nodeType:"ExistsFromNode",retractLeft:function(t){var e=this.removeFromLeftMemory(t);e&&(e=e.data).blocked&&this.__propagate("retract",e.clone())},__modify:function(t,e){var r=e.blocked,n=t.factHash,o=this.from(n);if(s(o)){for(var i=0,u=o.length;i<u;i++)if(this.__isMatch(t,o[i],!0)){t.blocked=!0;break}}else a(o)&&(t.blocked=this.__isMatch(t,o,!0));t.blocked?r?this.__propagate("modify",t.clone()):this.__propagate("assert",t.clone()):r&&this.__propagate("retract",t.clone())},__findMatches:function(t){var e=t.factHash,r=this.from(e);if(s(r)){for(var n=0,o=r.length;n<o;n++)if(this.__isMatch(t,r[n],!0))return t.blocked=!0,void this.__propagate("assert",t.clone())}else a(r)&&this.__isMatch(t,r,!0)&&(t.blocked=!0,this.__propagate("assert",t.clone()));return!1},__isMatch:function(t,e,r){var n=!1;if(this.type(e)){var o=this.workingMemory.getFactHandle(e),a=new i(o,null,null).mergeMatch(t.match).set(this.alias,e);if(r){var s=this.fromMemory[o.id];s||(s=this.fromMemory[o.id]={}),s[t.hashCode]=t}for(var u=a.factHash,c=this.__equalityConstraints,l=0,f=c.length;l<f;l++){if(!c[l](u)){n=!1;break}n=!0}}return n},assertLeft:function(t){this.__addToLeftMemory(t),this.__findMatches(t)}}}).as(e)},{"../context":10,"../extended":12,"./fromNotNode":26}],24:[function(t,e,r){var n=t("./notNode"),o=t("../linkedList");n.extend({instance:{nodeType:"ExistsNode",blockedContext:function(t,e){t.blocker=e,this.removeFromLeftMemory(t),this.addToLeftBlockedMemory(e.blocking.push(t)),this.__propagate("assert",this.__cloneContext(t))},notBlockedContext:function(t,e){this.__addToLeftMemory(t),e&&this.__propagate("retract",this.__cloneContext(t))},propagateFromLeft:function(t){this.notBlockedContext(t,!1)},retractLeft:function(t){var e;if(!this.removeFromLeftMemory(t)){if(!(e=this.removeFromLeftBlockedMemory(t)))throw new Error;this.__propagate("retract",this.__cloneContext(e.data))}},modifyLeft:function(t){var e,r,n,o,i=this.removeFromLeftMemory(t),a=this.constraint,s=this.rightTuples,u=s.length,c=!1;if(i||(i=this.removeFromLeftBlockedMemory(t),c=!0),!i)throw new Error;if((e=i.data)&&e.blocker&&(o=this.rightMemory[e.blocker.hashCode]),o?(a.isMatch(t,n=o.data)&&(this.__propagate(c?"modify":"assert",this.__cloneContext(e)),t.blocker=n,this.addToLeftBlockedMemory(n.blocking.push(t)),t=null),t&&(r={next:o.next})):r={next:s.head},t&&u)for(r={next:s.head};r=r.next;)if(a.isMatch(t,n=r.data)){this.__propagate(c?"modify":"assert",this.__cloneContext(e)),this.addToLeftBlockedMemory(n.blocking.push(t)),t.blocker=n,t=null;break}t&&(this.__addToLeftMemory(t),c&&this.__propagate("retract",this.__cloneContext(t)))},modifyRight:function(t){var e=this.removeFromRightMemory(t);if(!e)throw new Error;var r,n,i=e.data,a=this.leftTuples,s=a.length,u=this.constraint,c=i.blocking;if(this.__addToRightMemory(t),t.blocking=new o,s||c.length){if(c.length)for(var l,f={next:c.head};f=f.next;)if((r=f.data).blocker=null,u.isMatch(r,t))r.blocker=t,this.addToLeftBlockedMemory(t.blocking.push(r)),this.__propagate("assert",this.__cloneContext(r)),r=null;else{for(r.blocker=null,n=e;n=n.next;)if(u.isMatch(r,l=n.data)){r.blocker=l,this.addToLeftBlockedMemory(l.blocking.push(r)),this.__propagate("assert",this.__cloneContext(r)),r=null;break}r&&this.__addToLeftMemory(r)}if(s)for(n={next:a.head};n=n.next;)r=n.data,u.isMatch(r,t)&&(this.__propagate("assert",this.__cloneContext(r)),this.removeFromLeftMemory(r),this.addToLeftBlockedMemory(t.blocking.push(r)),r.blocker=t)}}}}).as(e)},{"../linkedList":16,"./notNode":38}],25:[function(t,e,r){var n=t("./joinNode"),o=t("../extended"),i=t("../constraint"),a=i.EqualityConstraint,s=i.HashConstraint,u=i.ReferenceConstraint,c=t("../context"),l=o.isDefined,f=o.isEmpty,d=o.forEach,h=o.isArray,p={isMatch:function(){return!1}};n.extend({instance:{nodeType:"FromNode",constructor:function(t,e){this._super(arguments),this.workingMemory=e,this.fromMemory={},this.pattern=t,this.type=t.get("constraints")[0].assert,this.alias=t.get("alias"),this.from=t.from.assert;var r=this.__equalityConstraints=[],n=[];d(this.constraints=this.pattern.get("constraints").slice(1),function(t){t instanceof a||t instanceof u?r.push(t.assert):t instanceof s&&(n=n.concat(t.get("variables")))}),this.__variables=n},__createMatches:function(t){var e=t.factHash,r=this.from(e);if(h(r))for(var n=0,o=r.length;n<o;n++)this.__checkMatch(t,r[n],!0);else l(r)&&this.__checkMatch(t,r,!0)},__checkMatch:function(t,e,r){var n;return(n=this.__createMatch(t,e)).isMatch()&&r&&this.__propagate("assert",n.clone()),n},__createMatch:function(t,e){if(this.type(e)){var r,n=this.workingMemory.getFactHandle(e,!0),o=new c(n,null,null).set(this.alias,e),i=n.id,a=o.factHash,s=t.factHash;for(var u in s)a[u]=s[u];for(var l=this.__equalityConstraints,f=this.__variables,d=-1,h=l.length;++d<h;)if(!l[d](a,a)){r=p;break}var g=this.fromMemory[i];if(g||(g=this.fromMemory[i]={}),!r){var m;for(d=-1,h=f.length;++d<h;)a[m=f[d]]=e[m];t.fromMatches[n.id]=r=o.clone(n,null,t.match.merge(o.match))}return g[t.hashCode]=[t,r],r}return p},retractRight:function(){throw new Error("Shouldnt have gotten here")},removeFromFromMemory:function(t){var e=t.fact.id,r=this.fromMemory[e];if(r)for(var n in r)if(r[n][1]===t){delete r[n],f(r)&&delete this.fromMemory[e];break}},retractLeft:function(t){var e=this.removeFromLeftMemory(t);if(e){var r=(e=e.data).fromMatches;for(var n in r)this.removeFromFromMemory(r[n]),this.__propagate("retract",r[n].clone())}},modifyLeft:function(t){var e,r,n,o,i,a=this.removeFromLeftMemory(t);if(a){this.__addToLeftMemory(t);var s=a.data,u=t.fromMatches={},c=s.fromMatches,f=this.from(t.factHash);if(h(f))for(r=0,n=f.length;r<n;r++)(e=this.__checkMatch(t,f[r],!1)).isMatch()&&((o=e.fact.id)in c?this.__propagate("modify",e.clone()):this.__propagate("assert",e.clone()));else l(f)&&(e=this.__checkMatch(t,f,!1)).isMatch()&&((o=e.fact.id)in c?this.__propagate("modify",e.clone()):this.__propagate("assert",e.clone()));for(r in c)r in u||(this.removeFromFromMemory(c[r]),this.__propagate("retract",c[r].clone()))}else this.assertLeft(t);o=(i=t.fact).id;var d=this.fromMemory[o];if(this.fromMemory[o]={},d){var p,g,m,v,y=i.object;for(r in d)p=(g=d[r])[0],v=(m=g[1]).isMatch(),p.hashCode!==t.hashCode&&(e=this.__createMatch(p,y,!1),v&&this.__propagate("retract",m.clone()),e.isMatch()&&this.__propagate(v?"modify":"assert",e.clone()))}},assertLeft:function(t){this.__addToLeftMemory(t),t.fromMatches={},this.__createMatches(t)},assertRight:function(){throw new Error("Shouldnt have gotten here")}}}).as(e)},{"../constraint":8,"../context":10,"../extended":12,"./joinNode":28}],26:[function(t,e,r){var n=t("./joinNode"),o=t("../extended"),i=t("../constraint"),a=i.EqualityConstraint,s=i.HashConstraint,u=i.ReferenceConstraint,c=t("../context"),l=o.isDefined,f=o.forEach,d=o.isArray;n.extend({instance:{nodeType:"FromNotNode",constructor:function(t,e){this._super(arguments),this.workingMemory=e,this.pattern=t,this.type=t.get("constraints")[0].assert,this.alias=t.get("alias"),this.from=t.from.assert,this.fromMemory={};var r=this.__equalityConstraints=[],n=[];f(this.constraints=this.pattern.get("constraints").slice(1),function(t){t instanceof a||t instanceof u?r.push(t.assert):t instanceof s&&(n=n.concat(t.get("variables")))}),this.__variables=n},retractLeft:function(t){var e=this.removeFromLeftMemory(t);e&&((e=e.data).blocked||this.__propagate("retract",e.clone()))},__modify:function(t,e){var r=e.blocked,n=t.factHash,o=this.from(n);if(d(o)){for(var i=0,a=o.length;i<a;i++)if(this.__isMatch(t,o[i],!0)){t.blocked=!0;break}}else l(o)&&(t.blocked=this.__isMatch(t,o,!0));t.blocked?r||this.__propagate("retract",e.clone()):r?this.__propagate("assert",t.clone()):this.__propagate("modify",t.clone())},modifyLeft:function(t){var e=this.removeFromLeftMemory(t);if(!e)throw new Error;this.__addToLeftMemory(t),this.__modify(t,e.data);var r=this.fromMemory[t.fact.id];if(this.fromMemory[t.fact.id]={},r)for(var n in r)if(n!==t.hashCode){var o=r[n];(e=this.removeFromLeftMemory(o))&&((o=o.clone()).blocked=!1,this.__addToLeftMemory(o),this.__modify(o,e.data))}},__findMatches:function(t){var e=t.factHash,r=this.from(e);if(d(r)){for(var n=0,o=r.length;n<o;n++)if(this.__isMatch(t,r[n],!0))return void(t.blocked=!0);this.__propagate("assert",t.clone())}else l(r)&&!(t.blocked=this.__isMatch(t,r,!0))&&this.__propagate("assert",t.clone());return!1},__isMatch:function(t,e,r){var n=!1;if(this.type(e)){var o=this.workingMemory.getFactHandle(e),i=new c(o,null).mergeMatch(t.match).set(this.alias,e);if(r){var a=this.fromMemory[o.id];a||(a=this.fromMemory[o.id]={}),a[t.hashCode]=t}for(var s=i.factHash,u=this.__equalityConstraints,l=0,f=u.length;l<f;l++){if(!u[l](s,s)){n=!1;break}n=!0}}return n},assertLeft:function(t){this.__addToLeftMemory(t),this.__findMatches(t)},assertRight:function(){throw new Error("Shouldnt have gotten here")},retractRight:function(){throw new Error("Shouldnt have gotten here")}}}).as(e)},{"../constraint":8,"../context":10,"../extended":12,"./joinNode":28}],27:[function(t,e,r){"use strict";var n=t("../extended"),o=n.forEach,i=n.some,a=n.declare,s=t("../pattern.js"),u=s.ObjectPattern,c=s.FromPattern,l=s.FromNotPattern,f=s.ExistsPattern,d=s.FromExistsPattern,h=s.NotPattern,p=s.CompositePattern,g=s.InitialFactPattern,m=t("../constraint"),v=m.HashConstraint,y=m.ReferenceConstraint,x=t("./aliasNode"),C=t("./equalityNode"),_=t("./joinNode"),w=t("./betaNode"),b=t("./notNode"),E=t("./fromNode"),I=t("./fromNotNode"),O=t("./existsNode"),M=t("./existsFromNode"),S=t("./leftAdapterNode"),A=t("./rightAdapterNode"),k=t("./typeNode"),T=t("./terminalNode"),P=t("./propertyNode");function L(t){return i(t.constraints||[],function(t){return t instanceof y})}a({instance:{constructor:function(t,e){this.terminalNodes=[],this.joinNodes=[],this.nodes=[],this.constraints=[],this.typeNodes=[],this.__ruleCount=0,this.bucket={counter:0,recency:0},this.agendaTree=e,this.workingMemory=t},assertRule:function(t){var e=new T(this.bucket,this.__ruleCount++,t,this.agendaTree);this.__addToNetwork(t,t.pattern,e),this.__mergeJoinNodes(),this.terminalNodes.push(e)},resetCounter:function(){this.bucket.counter=0},incrementCounter:function(){this.bucket.counter++},assertFact:function(t){for(var e=this.typeNodes,r=e.length-1;r>=0;r--)e[r].assert(t)},retractFact:function(t){for(var e=this.typeNodes,r=e.length-1;r>=0;r--)e[r].retract(t)},modifyFact:function(t){for(var e=this.typeNodes,r=e.length-1;r>=0;r--)e[r].modify(t)},containsRule:function(t){return i(this.terminalNodes,function(e){return e.rule.name===t})},dispose:function(){for(var t=this.typeNodes,e=t.length-1;e>=0;e--)t[e].dispose()},__mergeJoinNodes:function(){for(var t=this.joinNodes,e=0;e<t.length;e++){var r=t[e],n=t[e+1];r&&n&&r.constraint&&n.constraint&&r.constraint.equal(n.constraint)&&(r.merge(n),t.splice(e+1,1))}},__checkEqual:function(t){for(var e=this.constraints,r=e.length-1;r>=0;r--){var n=e[r];if(t.equal(n))return n}return e.push(t),t},__createTypeNode:function(t,e){for(var r=new k(e.get("constraints")[0]),n=this.typeNodes,o=n.length-1;o>=0;o--){var i=n[o];if(r.equal(i))return i}return n.push(r),r},__createEqualityNode:function(t,e){return this.__checkEqual(new C(e)).addRule(t)},__createPropertyNode:function(t,e){return this.__checkEqual(new P(e)).addRule(t)},__createAliasNode:function(t,e){return this.__checkEqual(new x(e)).addRule(t)},__createAdapterNode:function(t,e){return("left"===e?new S:new A).addRule(t)},__createJoinNode:function(t,e,r,n){var o;e.rightPattern instanceof h?o=new b:e.rightPattern instanceof d?o=new M(e.rightPattern,this.workingMemory):e.rightPattern instanceof f?o=new O:e.rightPattern instanceof l?o=new I(e.rightPattern,this.workingMemory):e.rightPattern instanceof c?o=new E(e.rightPattern,this.workingMemory):e instanceof p&&!L(e.leftPattern)&&!L(e.rightPattern)?(o=new w,this.joinNodes.push(o)):(o=new _,this.joinNodes.push(o)),o.__rule__=t;var i=o;if(r instanceof w){var a=this.__createAdapterNode(t,n);i.addOutNode(a,e),i=a}return i.addOutNode(r,e),o.addRule(t)},__addToNetwork:function(t,e,r,n){e instanceof u?e instanceof g||n&&"left"!==n?this.__createAlphaNode(t,e,r,n):this.__createBetaNode(t,new p(new g,e),r,n):e instanceof p&&this.__createBetaNode(t,e,r,n)},__createBetaNode:function(t,e,r,n){var o=this.__createJoinNode(t,e,r,n);return this.__addToNetwork(t,e.rightPattern,o,"right"),this.__addToNetwork(t,e.leftPattern,o,"left"),r.addParentNode(o),o},__createAlphaNode:function(t,e,r,n){var o,i;if(!(e instanceof c)){var a=e.get("constraints");o=this.__createTypeNode(t,e);var s=this.__createAliasNode(t,e);o.addOutNode(s,e),s.addParentNode(o),i=s;for(var u=a.length-1;u>0;u--){var l,f=a[u];if(f instanceof v)l=this.__createPropertyNode(t,f);else{if(f instanceof y){r.constraint.addConstraint(f);continue}l=this.__createEqualityNode(t,f)}i.addOutNode(l,e),l.addParentNode(i),i=l}if(r instanceof w){var d=this.__createAdapterNode(t,n);d.addParentNode(i),i.addOutNode(d,e),i=d}return r.addParentNode(i),i.addOutNode(r,e),o}},print:function(){o(this.terminalNodes,function(t){t.print("    ")})}}}).as(r,"RootNode")},{"../constraint":8,"../extended":12,"../pattern.js":48,"./aliasNode":19,"./betaNode":21,"./equalityNode":22,"./existsFromNode":23,"./existsNode":24,"./fromNode":25,"./fromNotNode":26,"./joinNode":28,"./leftAdapterNode":30,"./notNode":38,"./propertyNode":39,"./rightAdapterNode":40,"./terminalNode":41,"./typeNode":42}],28:[function(t,e,r){var n=t("./betaNode"),o=t("./joinReferenceNode");n.extend({instance:{constructor:function(){this._super(arguments),this.constraint=new o(this.leftTuples,this.rightTuples)},nodeType:"JoinNode",propagateFromLeft:function(t,e){var r;return(r=this.constraint.match(t,e)).isMatch&&this.__propagate("assert",this.__addToMemoryMatches(e,t,t.clone(null,null,r))),this},propagateFromRight:function(t,e){var r;return(r=this.constraint.match(e,t)).isMatch&&this.__propagate("assert",this.__addToMemoryMatches(t,e,t.clone(null,null,r))),this},propagateAssertModifyFromLeft:function(t,e,r){var n,o=r.hashCode;o in e?(n=this.constraint.match(t,r)).isMatch?this.__propagate("modify",this.__addToMemoryMatches(r,t,t.clone(null,null,n))):this.__propagate("retract",e[o].clone()):this.propagateFromLeft(t,r)},propagateAssertModifyFromRight:function(t,e,r){var n,o=r.hashCode;o in e?(n=this.constraint.match(r,t)).isMatch?this.__propagate("modify",this.__addToMemoryMatches(t,r,t.clone(null,null,n))):this.__propagate("retract",e[o].clone()):this.propagateFromRight(t,r)}}}).as(e)},{"./betaNode":21,"./joinReferenceNode":29}],29:[function(t,e,r){var n=t("./node"),o=t("../constraint").ReferenceEqualityConstraint,i={isDefault:!0,assert:function(){return!0},equal:function(){return!1}},a={gt:"lte",gte:"lte",lt:"gte",lte:"gte",eq:"eq",neq:"neq"};n.extend({instance:{constraint:i,constructor:function(t,e){this._super(arguments),this.constraint=i,this.constraintAssert=i.assert,this.rightIndexes=[],this.leftIndexes=[],this.constraintLength=0,this.leftMemory=t,this.rightMemory=e},addConstraint:function(t){if(t instanceof o){var e=t.getIndexableProperties(),r=t.get("alias");if(2===e.length&&r){for(var n,i,s=-1,u=[];++s<2;){var c=e[s];null===c.match(new RegExp("^"+r+"(\\.?)"))?(u.push(c),n=c):(u.push(c),i=c)}if(n&&i){var l=function(t,e,r){return t===e[1]&&(r=a[r]),r}(n,u,t.op),f=function(t,e,r){return t===e[1]&&(r=a[r]),r}(i,u,t.op);this.rightMemory.addIndex(i,n,f),this.leftMemory.addIndex(n,i,l)}}}this.constraint.isDefault?(this.constraint=t,this.isDefault=!1):this.constraint=this.constraint.merge(t),this.constraintAssert=this.constraint.assert},equal:function(t){return this.constraint.equal(t.constraint)},isMatch:function(t,e){return this.constraintAssert(t.factHash,e.factHash)},match:function(t,e){var r={isMatch:!1};return this.constraintAssert(t.factHash,e.factHash)&&(r=t.match.merge(e.match)),r}}}).as(e)},{"../constraint":8,"./node":37}],30:[function(t,e,r){t("./adapterNode").extend({instance:{propagateAssert:function(t){this.__propagate("assertLeft",t)},propagateRetract:function(t){this.__propagate("retractLeft",t)},propagateResolve:function(t){this.__propagate("retractResolve",t)},propagateModify:function(t){this.__propagate("modifyLeft",t)},retractResolve:function(t){this.__propagate("retractResolve",t)},dispose:function(t){this.propagateDispose(t)},toString:function(){return"LeftAdapterNode "+this.__count}}}).as(e)},{"./adapterNode":18}],31:[function(t,e,r){r.getMemory=function(){var t=Array.prototype.push,e=0,r=[],n={},o={},i=0;function a(a,s){var c=r;return s&&(e||i?(c=[],e?i?function(t,r,a){if(i===a)u(t,r);else if(e<a)for(var s,c,l=0,f=-1;++f<a;)!n[c=(s=r[f]).hashCode]&&o[c]&&(t[l++]=s);e=0,n={},i=0,o={}}(c,a,s):function(t,r,o){var i,a=0,s=-1;if(e<o)for(;++s<o;)e?n[(i=r[s]).hashCode]?e--:t[a++]=i:t[a++]=r[s];e=0,n={}}(c,a,s):function(e,r,n){var a,s=0,u=-1;if(i<n)for(;i&&++u<n;)o[(a=r[u]).hashCode]&&(e[s++]=a,i--);else t.apply(e,r);i=0,o={}}(c,a,s)):c=a),c}function s(t,e,r){var n;return"gt"===t?n=e.findGT(r):"gte"===t?n=e.findGTE(r):"lt"===t?n=e.findLT(r):"lte"===t&&(n=e.findLTE(r)),n}function u(t,r){if(r)for(var o,i=-1;++i<r;)o=t[i].hashCode,n[o]||(n[o]=!0,e++)}function c(t,e){if(e)for(var r,n=-1;++n<e;)r=t[n].hashCode,o[r]||(o[r]=!0,i++)}return function(t,e,n){for(var o,i,l,f,d,h,p,g=-1,m=n.length,v=t.tuples,y=v.length,x=!1,C=t.tables;++g<m&&y;)i=(o=n[g])[3](e),l=o[4],d=C[o[0]],"eq"===l||"seq"===l?(f=d.get(i))?(y=(v=(t=f).tuples).length,C=f.tables):y=(v=r).length:"neq"===l||"sneq"===l?(f=d.get(i))&&(p=(h=f.tuples).length,u(h,p)):x?(p=(h=s(l,d,i)).length)?c(h,p):(v=h,y=p):(y=(v=s(l,d,i)).length,x=!0);return a(v,y)}}()},{}],32:[function(t,e,r){t("./memory").extend({instance:{getLeftMemory:function(t){return this.getMemory(t)}}}).as(e)},{"./memory":33}],33:[function(t,e,r){var n=t("../../extended"),o=n.plucker,i=n.declare,a=t("./helpers").getMemory,s=t("./table"),u=t("./tupleEntry"),c=0;i({instance:{length:0,constructor:function(){this.head=null,this.tail=null,this.indexes=[],this.tables=new u(null,new s,!1)},push:function(t){var e=this.tail,r=this.head,n={data:t,tuples:[],hashCode:c++,prev:e,next:null};return e&&(this.tail.next=n),this.tail=n,r||(this.head=n),this.length++,this.__index(n),this.tables.addNode(n),n},remove:function(t){t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,this.tables.removeNode(t),this.__removeFromIndex(t),this.length--},forEach:function(t){for(var e={next:this.head};e=e.next;)t(e.data)},toArray:function(){return this.tables.tuples.slice()},clear:function(){this.head=this.tail=null,this.length=0,this.clearIndexes()},clearIndexes:function(){this.tables={},this.indexes.length=0},__index:function(t){for(var e,r,n,o,i,a,c,l=t.data.factHash,f=this.indexes,d=this.tables,h=-1,p=f.length;++h<p;)n=(r=f[h])[2](l),o=r[0],(e=(a=(i=d.tables)[o]||(i[o]=new s)).get(n))||(e=new u(n,a,!0),a.set(n,e)),a!==c&&t.tuples.push(e.addNode(t)),c=a,"eq"===r[4]&&(d=e)},__removeFromIndex:function(t){for(var e=t.tuples,r=e.length;--r>=0;)e[r].removeNode(t);t.tuples.length=0},getMemory:function(t){return this.length?a(this.tables,t.factHash,this.indexes):[]},__createIndexTree:function(){(this.tables.tables={})[this.indexes[0][0]]=new s},addIndex:function(t,e,r){this.indexes.push([t,e,o(t),o(e),r||"eq"]),this.indexes.sort(function(t,e){var r=t[4],n=e[4];return r===n?0:r>n?1:r===n?0:-1}),this.__createIndexTree()}}}).as(e)},{"../../extended":12,"./helpers":31,"./table":35,"./tupleEntry":36}],34:[function(t,e,r){t("./memory").extend({instance:{getRightMemory:function(t){return this.getMemory(t)}}}).as(e)},{"./memory":33}],35:[function(t,e,r){var n=t("../../extended"),o=Array.prototype.push,i=n.HashTable;function a(t,e){return(t=t.key)==(e=e.key)?0:t>e?1:t<e?-1:1}function s(t,e){return 1===a(t,e)}function u(t,e){return-1!==a(t,e)}function c(t,e){return-1===a(t,e)}function l(t,e){return 1!==a(t,e)}var f=[],d={key:null};function h(t,e,r){d.key=e;for(var n,i=[],a=0,s=t.__root;;)if(s)s=(f[a++]=s).left;else{if(!(a>0))break;if(!r(n=(s=f[--a]).data,d))break;o.apply(i,n.value.tuples),s=s.right}return f.length=0,i}function p(t,e,r){d.key=e;for(var n,i=[],a=0,s=t.__root;;)if(s)s=(f[a++]=s).right;else{if(!(a>0))break;if(!r(n=(s=f[--a]).data,d))break;o.apply(i,n.value.tuples),s=s.left}return f.length=0,i}n.AVLTree.extend({instance:{constructor:function(){this._super([{compare:a}]),this.gtCache=new i,this.gteCache=new i,this.ltCache=new i,this.lteCache=new i,this.hasGTCache=!1,this.hasGTECache=!1,this.hasLTCache=!1,this.hasLTECache=!1},clearCache:function(){this.hasGTCache&&this.gtCache.clear()&&(this.hasGTCache=!1),this.hasGTECache&&this.gteCache.clear()&&(this.hasGTECache=!1),this.hasLTCache&&this.ltCache.clear()&&(this.hasLTCache=!1),this.hasLTECache&&this.lteCache.clear()&&(this.hasLTECache=!1)},contains:function(t){return this._super([{key:t}])},set:function(t,e){this.insert({key:t,value:e}),this.clearCache()},get:function(t){var e=this.find({key:t});return e&&e.value},remove:function(t){return this.clearCache(),this._super([{key:t}])},findGT:function(t){var e=this.gtCache.get(t);return e||(this.hasGTCache=!0,this.gtCache.put(t,e=p(this,t,s))),e},findGTE:function(t){var e=this.gteCache.get(t);return e||(this.hasGTECache=!0,this.gteCache.put(t,e=p(this,t,u))),e},findLT:function(t){var e=this.ltCache.get(t);return e||(this.hasLTCache=!0,this.ltCache.put(t,e=h(this,t,c))),e},findLTE:function(t){var e=this.lteCache.get(t);return e||(this.hasLTECache=!0,this.lteCache.put(t,e=h(this,t,l))),e}}}).as(e)},{"../../extended":12}],36:[function(t,e,r){var n=t("../../extended"),o=n.indexOf,i=0;n.declare({instance:{tuples:null,tupleMap:null,hashCode:null,tables:null,entry:null,constructor:function(t,e,r){this.val=t,this.canRemove=r,this.tuples=[],this.tupleMap={},this.hashCode=i++,this.tables={},this.length=0,this.entry=e},addNode:function(t){return this.tuples[this.length++]=t,this.length>1&&this.entry.clearCache(),this},removeNode:function(t){var e=this.tuples,r=o(e,t);-1!==r&&(e.splice(r,1),this.length--,this.entry.clearCache()),this.canRemove&&!this.length&&this.entry.remove(this.val)}}}).as(e)},{"../../extended":12}],37:[function(t,e,r){var n=t("../extended"),o=n.forEach,i=n.indexOf,a=n.intersection,s=n.declare,u=n.HashTable,c=t("../context"),l=0;s({instance:{constructor:function(){this.nodes=new u,this.rules=[],this.parentNodes=[],this.__count=l++,this.__entrySet=[]},addRule:function(t){return-1===i(this.rules,t)&&this.rules.push(t),this},merge:function(t){t.nodes.forEach(function(e){for(var r=e.value,n=e.key,o=0,i=r.length;o<i;o++)this.addOutNode(n,r[o]);t.nodes.remove(n)},this);for(var e=t.parentNodes,r=0,n=t.parentNodes.l;r<n;r++){var o=e[r];this.addParentNode(o),o.nodes.remove(t)}return this},resolve:function(t,e){return t.hashCode===e.hashCode},print:function(t){console.log(t+this.toString()),o(this.parentNodes,function(e){e.print("    "+t)})},addOutNode:function(t,e){this.nodes.contains(t)||this.nodes.put(t,[]),this.nodes.get(t).push(e),this.__entrySet=this.nodes.entrySet()},addParentNode:function(t){-1===i(this.parentNodes,t)&&this.parentNodes.push(t)},shareable:function(){return!1},__propagate:function(t,e){for(var r,n,o,i,s=this.__entrySet,u=s.length;--u>-1;)n=(r=s[u]).key,o=r.value,(i=a(o,e.paths)).length&&n[t](new c(e.fact,i,e.match))},dispose:function(t){this.propagateDispose(t)},retract:function(t){this.propagateRetract(t)},propagateDispose:function(t,e){e=e||this.nodes;for(var r=this.__entrySet,n=r.length-1;n>=0;n--){r[n].key.dispose(t)}},propagateAssert:function(t){this.__propagate("assert",t)},propagateRetract:function(t){this.__propagate("retract",t)},assert:function(t){this.propagateAssert(t)},modify:function(t){this.propagateModify(t)},propagateModify:function(t){this.__propagate("modify",t)}}}).as(e)},{"../context":10,"../extended":12}],38:[function(t,e,r){var n=t("./joinNode"),o=t("../linkedList"),i=t("../context"),a=t("../pattern").InitialFact;n.extend({instance:{nodeType:"NotNode",constructor:function(){this._super(arguments),this.leftTupleMemory={},this.notMatch=new i(new a).match},__cloneContext:function(t){return t.clone(null,null,t.match.merge(this.notMatch))},retractRight:function(t){var e=this.removeFromRightMemory(t).data.blocking;if(e.length){for(var r,n,o=this.constraint,i={next:e.head};i=i.next;){r=i.data,this.removeFromLeftBlockedMemory(r);var a,s=this.rightTuples.getRightMemory(r),u=s.length;for(a=-1;++a<u;)if(o.isMatch(r,n=s[a].data)){this.blockedContext(r,n),r=null;break}r&&this.notBlockedContext(r,!0)}e.clear()}},blockedContext:function(t,e,r){t.blocker=e,this.removeFromLeftMemory(t),this.addToLeftBlockedMemory(e.blocking.push(t)),r&&this.__propagate("retract",this.__cloneContext(t))},notBlockedContext:function(t,e){this.__addToLeftMemory(t),e&&this.__propagate("assert",this.__cloneContext(t))},propagateFromLeft:function(t){this.notBlockedContext(t,!0)},propagateFromRight:function(t){this.notBlockedContext(t,!0)},blockFromAssertRight:function(t,e){this.blockedContext(t,e,!0)},blockFromAssertLeft:function(t,e){this.blockedContext(t,e,!1)},retractLeft:function(t){var e=this.removeFromLeftMemory(t);if(e)e=e.data,this.__propagate("retract",this.__cloneContext(e));else if(!this.removeFromLeftBlockedMemory(t))throw new Error},assertLeft:function(t){for(var e,r=this.rightTuples.getRightMemory(t),n=this.constraint,o=-1,i=r.length;++o<i;)n.isMatch(t,e=r[o].data)&&(this.blockFromAssertLeft(t,e),t=null,o=i);t&&this.propagateFromLeft(t)},assertRight:function(t){this.__addToRightMemory(t),t.blocking=new o;for(var e,r=this.leftTuples.getLeftMemory(t).slice(),n=-1,i=r.length,a=this.constraint;++n<i;)e=r[n].data,a.isMatch(e,t)&&this.blockFromAssertRight(e,t)},addToLeftBlockedMemory:function(t){var e=t.data.hashCode,r=this.leftMemory[e];return this.leftTupleMemory[e]=t,r&&this.leftTuples.remove(r),this},removeFromLeftBlockedMemory:function(t){var e=this.leftTupleMemory[t.hashCode]||null;return e&&(delete this.leftTupleMemory[t.hashCode],e.data.blocker.blocking.remove(e)),e},modifyLeft:function(t){var e,r,n,o,i=this.removeFromLeftMemory(t),a=this.constraint,s=this.rightTuples.getRightMemory(t),u=s.length,c=!1;if(i||(i=this.removeFromLeftBlockedMemory(t),c=!0),!i)throw new Error;if((e=i.data)&&e.blocker&&(o=this.rightMemory[e.blocker.hashCode],e.blocker=null),o&&a.isMatch(t,n=o.data)&&(c||this.__propagate("retract",this.__cloneContext(e)),t.blocker=n,this.addToLeftBlockedMemory(n.blocking.push(t)),t=null),t&&u)for(r=-1;++r<u;)if(a.isMatch(t,n=s[r].data)){c||this.__propagate("retract",this.__cloneContext(e)),this.addToLeftBlockedMemory(n.blocking.push(t)),t.blocker=n,t=null;break}t&&(this.__addToLeftMemory(t),c?this.__propagate("assert",this.__cloneContext(t)):this.__propagate("modify",this.__cloneContext(t)))},modifyRight:function(t){var e=this.removeFromRightMemory(t);if(!e)throw new Error;var r,n,i,a,s=e.data,u=this.leftTuples.getLeftMemory(t).slice(),c=u.length,l=this.constraint,f=s.blocking;this.__addToRightMemory(t),t.blocking=new o;for(var d={next:f.head};d=d.next;)if((r=d.data).blocker=null,l.isMatch(r,t))r.blocker=t,this.addToLeftBlockedMemory(t.blocking.push(r)),r=null;else{for(r.blocker=null,i=e;i=i.next;)if(l.isMatch(r,a=i.data)){r.blocker=a,this.addToLeftBlockedMemory(a.blocking.push(r)),r=null;break}r&&(this.__addToLeftMemory(r),this.__propagate("assert",this.__cloneContext(r)))}if(c)for(n=-1;++n<c;)r=u[n].data,l.isMatch(r,t)&&(this.__propagate("retract",this.__cloneContext(r)),this.removeFromLeftMemory(r),this.addToLeftBlockedMemory(t.blocking.push(r)),r.blocker=t)}}}).as(e)},{"../context":10,"../linkedList":16,"../pattern":48,"./joinNode":28}],39:[function(t,e,r){var n=t("./alphaNode"),o=t("../context"),i=t("../extended");n.extend({instance:{constructor:function(){this._super(arguments),this.alias=this.constraint.get("alias"),this.varLength=(this.variables=i(this.constraint.get("variables")).toArray().value()).length},assert:function(t){var e,r=new o(t.fact,t.paths),n=this.variables,i=t.fact.object;r.set(this.alias,i);for(var a=0,s=this.varLength;a<s;a++)e=n[a],r.set(e[1],i[e[0]]);this.__propagate("assert",r)},retract:function(t){this.__propagate("retract",new o(t.fact,t.paths))},modify:function(t){var e,r=new o(t.fact,t.paths),n=this.variables,i=t.fact.object;r.set(this.alias,i);for(var a=0,s=this.varLength;a<s;a++)e=n[a],r.set(e[1],i[e[0]]);this.__propagate("modify",r)},toString:function(){return"PropertyNode"+this.__count}}}).as(e)},{"../context":10,"../extended":12,"./alphaNode":20}],40:[function(t,e,r){t("./adapterNode").extend({instance:{retractResolve:function(t){this.__propagate("retractResolve",t)},dispose:function(t){this.propagateDispose(t)},propagateAssert:function(t){this.__propagate("assertRight",t)},propagateRetract:function(t){this.__propagate("retractRight",t)},propagateResolve:function(t){this.__propagate("retractResolve",t)},propagateModify:function(t){this.__propagate("modifyRight",t)},toString:function(){return"RightAdapterNode "+this.__count}}}).as(e)},{"./adapterNode":18}],41:[function(t,e,r){var n=t("./node"),o=t("../extended").bind;n.extend({instance:{constructor:function(t,e,r,n){this._super([]),this.resolve=o(this,this.resolve),this.rule=r,this.index=e,this.name=this.rule.name,this.agenda=n,this.bucket=t,n.register(this)},__assertModify:function(t){var e=t.match;if(e.isMatch){var r=this.rule,n=this.bucket;this.agenda.insert(this,{rule:r,hashCode:t.hashCode,index:this.index,name:r.name,recency:n.recency++,match:e,counter:n.counter})}},assert:function(t){this.__assertModify(t)},modify:function(t){this.agenda.retract(this,t),this.__assertModify(t)},retract:function(t){this.agenda.retract(this,t)},retractRight:function(t){this.agenda.retract(this,t)},retractLeft:function(t){this.agenda.retract(this,t)},assertLeft:function(t){this.__assertModify(t)},assertRight:function(t){this.__assertModify(t)},toString:function(){return"TerminalNode "+this.rule.name}}}).as(e)},{"../extended":12,"./node":37}],42:[function(t,e,r){var n=t("./alphaNode"),o=t("../context");n.extend({instance:{assert:function(t){this.constraintAssert(t.object)&&this.__propagate("assert",t)},modify:function(t){this.constraintAssert(t.object)&&this.__propagate("modify",t)},retract:function(t){this.constraintAssert(t.object)&&this.__propagate("retract",t)},toString:function(){return"TypeNode"+this.__count},dispose:function(){for(var t=this.__entrySet,e=t.length-1;e>=0;e--){var r=t[e],n=r.key,o=r.value;n.dispose({paths:o})}},__propagate:function(t,e){for(var r=this.__entrySet,n=-1,i=r.length;++n<i;){var a=r[n],s=a.key,u=a.value;s[t](new o(e,u))}}}}).as(e)},{"../context":10,"./alphaNode":20}],43:[function(t,e,r){var n=t("__browserify_process"),o=function(){var t=function(t,e,r,n){for(r=r||{},n=t.length;n--;r[t[n]]=e);return r},e=[1,29],r=[1,30],n=[1,26],o=[1,24],i=[1,16],a=[1,18],s=[1,19],u=[1,20],c=[1,21],l=[1,22],f=[5,38,49],d=[1,33],h=[5,36,38,49],p=[5,8,11,12,13,15,17,19,20,21,22,24,25,26,27,28,29,36,38,49],g=[2,2],m=[5,24,25,26,27,28,29,36,38,49],v=[1,42],y=[1,43],x=[1,44],C=[1,45],_=[5,8,11,12,13,15,17,19,20,21,22,24,25,26,27,28,29,31,33,36,38,40,46,49],w=[1,46],b=[1,47],E=[1,48],I=[5,19,20,21,22,24,25,26,27,28,29,36,38,49],O=[1,50],M=[5,8,11,12,13,15,17,19,20,21,22,24,25,26,27,28,29,31,33,36,38,40,43,44,46,48,49],S=[5,17,19,20,21,22,24,25,26,27,28,29,36,38,49],A=[1,55],k=[1,54],T=[5,8,15,17,19,20,21,22,24,25,26,27,28,29,36,38,49],P=[1,56],L=[1,57],N=[1,58],R=[1,87],F=[40,46,49],D={trace:function(){},yy:{},symbols_:{error:2,expressions:3,EXPRESSION:4,EOF:5,UNARY_EXPRESSION:6,LITERAL_EXPRESSION:7,"-":8,"!":9,MULTIPLICATIVE_EXPRESSION:10,"*":11,"/":12,"%":13,ADDITIVE_EXPRESSION:14,"+":15,EXPONENT_EXPRESSION:16,"^":17,RELATIONAL_EXPRESSION:18,"<":19,">":20,"<=":21,">=":22,EQUALITY_EXPRESSION:23,"==":24,"===":25,"!=":26,"!==":27,"=~":28,"!=~":29,IN_EXPRESSION:30,in:31,ARRAY_EXPRESSION:32,notIn:33,OBJECT_EXPRESSION:34,AND_EXPRESSION:35,"&&":36,OR_EXPRESSION:37,"||":38,ARGUMENT_LIST:39,",":40,IDENTIFIER_EXPRESSION:41,IDENTIFIER:42,".":43,"[":44,STRING_EXPRESSION:45,"]":46,NUMBER_EXPRESSION:47,"(":48,")":49,STRING:50,NUMBER:51,REGEXP_EXPRESSION:52,REGEXP:53,BOOLEAN_EXPRESSION:54,BOOLEAN:55,NULL_EXPRESSION:56,NULL:57,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",8:"-",9:"!",11:"*",12:"/",13:"%",15:"+",17:"^",19:"<",20:">",21:"<=",22:">=",24:"==",25:"===",26:"!=",27:"!==",28:"=~",29:"!=~",31:"in",33:"notIn",36:"&&",38:"||",40:",",42:"IDENTIFIER",43:".",44:"[",46:"]",48:"(",49:")",50:"STRING",51:"NUMBER",53:"REGEXP",55:"BOOLEAN",57:"NULL"},productions_:[0,[3,2],[6,1],[6,2],[6,2],[10,1],[10,3],[10,3],[10,3],[14,1],[14,3],[14,3],[16,1],[16,3],[18,1],[18,3],[18,3],[18,3],[18,3],[23,1],[23,3],[23,3],[23,3],[23,3],[23,3],[23,3],[30,1],[30,3],[30,3],[30,3],[30,3],[35,1],[35,3],[37,1],[37,3],[39,1],[39,3],[41,1],[34,1],[34,3],[34,4],[34,4],[34,4],[34,3],[34,4],[45,1],[47,1],[52,1],[54,1],[56,1],[32,2],[32,3],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,3],[4,1]],performAction:function(t,e,r,n,o,i,a){var s=i.length-1;switch(o){case 1:return i[s-1];case 3:this.$=[i[s],null,"unary"];break;case 4:this.$=[i[s],null,"logicalNot"];break;case 6:this.$=[i[s-2],i[s],"mult"];break;case 7:this.$=[i[s-2],i[s],"div"];break;case 8:this.$=[i[s-2],i[s],"mod"];break;case 10:this.$=[i[s-2],i[s],"plus"];break;case 11:this.$=[i[s-2],i[s],"minus"];break;case 13:this.$=[i[s-2],i[s],"pow"];break;case 15:this.$=[i[s-2],i[s],"lt"];break;case 16:this.$=[i[s-2],i[s],"gt"];break;case 17:this.$=[i[s-2],i[s],"lte"];break;case 18:this.$=[i[s-2],i[s],"gte"];break;case 20:this.$=[i[s-2],i[s],"eq"];break;case 21:this.$=[i[s-2],i[s],"seq"];break;case 22:this.$=[i[s-2],i[s],"neq"];break;case 23:this.$=[i[s-2],i[s],"sneq"];break;case 24:this.$=[i[s-2],i[s],"like"];break;case 25:this.$=[i[s-2],i[s],"notLike"];break;case 27:case 29:this.$=[i[s-2],i[s],"in"];break;case 28:case 30:this.$=[i[s-2],i[s],"notIn"];break;case 32:this.$=[i[s-2],i[s],"and"];break;case 34:this.$=[i[s-2],i[s],"or"];break;case 36:this.$=[i[s-2],i[s],"arguments"];break;case 37:this.$=[String(t),null,"identifier"];break;case 39:this.$=[i[s-2],i[s],"prop"];break;case 40:case 41:case 42:this.$=[i[s-3],i[s-1],"propLookup"];break;case 43:this.$=[i[s-2],[null,null,"arguments"],"function"];break;case 44:this.$=[i[s-3],i[s-1],"function"];break;case 45:this.$=[String(t.replace(/^['|"]|['|"]$/g,"")),null,"string"];break;case 46:this.$=[Number(t),null,"number"];break;case 47:this.$=[t,null,"regexp"];break;case 48:this.$=["true"==t.replace(/^\s+/,""),null,"boolean"];break;case 49:this.$=[null,null,"null"];break;case 50:this.$=[null,null,"array"];break;case 51:this.$=[i[s-1],null,"array"];break;case 59:this.$=[i[s-1],null,"composite"]}},table:[{3:1,4:2,6:28,7:7,8:e,9:r,10:27,14:25,16:17,18:8,23:6,30:5,32:15,34:14,35:4,37:3,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{1:[3]},{5:[1,31]},t([5,49],[2,60],{38:[1,32]}),t(f,[2,33],{36:d}),t(h,[2,31]),t(h,[2,26],{24:[1,34],25:[1,35],26:[1,36],27:[1,37],28:[1,38],29:[1,39]}),t(p,g,{31:[1,40],33:[1,41]}),t(m,[2,19],{19:v,20:y,21:x,22:C}),t(_,[2,52]),t(_,[2,53]),t(_,[2,54]),t(_,[2,55]),t(_,[2,56]),t(_,[2,57],{43:w,44:b,48:E}),t(_,[2,58]),{4:49,6:28,7:7,8:e,9:r,10:27,14:25,16:17,18:8,23:6,30:5,32:15,34:14,35:4,37:3,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},t(I,[2,14],{17:O}),t(_,[2,45]),t(_,[2,46]),t(_,[2,47]),t(_,[2,48]),t(_,[2,49]),t(M,[2,38]),{7:53,32:15,34:14,39:52,41:23,42:n,44:o,45:9,46:[1,51],47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},t(S,[2,12],{8:A,15:k}),t(M,[2,37]),t(T,[2,9],{11:P,12:L,13:N}),t(p,[2,5]),{6:59,7:60,8:e,9:r,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{6:61,7:60,8:e,9:r,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{1:[2,1]},{6:28,7:7,8:e,9:r,10:27,14:25,16:17,18:8,23:6,30:5,32:15,34:14,35:62,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{6:28,7:7,8:e,9:r,10:27,14:25,16:17,18:8,23:6,30:63,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{6:28,7:60,8:e,9:r,10:27,14:25,16:17,18:64,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{6:28,7:60,8:e,9:r,10:27,14:25,16:17,18:65,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{6:28,7:60,8:e,9:r,10:27,14:25,16:17,18:66,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{6:28,7:60,8:e,9:r,10:27,14:25,16:17,18:67,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{6:28,7:60,8:e,9:r,10:27,14:25,16:17,18:68,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{6:28,7:60,8:e,9:r,10:27,14:25,16:17,18:69,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{32:70,34:71,41:23,42:n,44:o},{32:72,34:73,41:23,42:n,44:o},{6:28,7:60,8:e,9:r,10:27,14:25,16:74,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{6:28,7:60,8:e,9:r,10:27,14:25,16:75,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{6:28,7:60,8:e,9:r,10:27,14:25,16:76,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{6:28,7:60,8:e,9:r,10:27,14:25,16:77,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{41:78,42:n},{34:81,41:23,42:n,45:79,47:80,50:a,51:s},{7:53,32:15,34:14,39:83,41:23,42:n,44:o,45:9,47:10,48:i,49:[1,82],50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{49:[1,84]},{6:28,7:60,8:e,9:r,10:27,14:85,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},t(_,[2,50]),{40:R,46:[1,86]},t(F,[2,35]),{6:28,7:60,8:e,9:r,10:88,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{6:28,7:60,8:e,9:r,10:89,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{6:90,7:60,8:e,9:r,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{6:91,7:60,8:e,9:r,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},{6:92,7:60,8:e,9:r,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},t(p,[2,3]),t(p,g),t(p,[2,4]),t(f,[2,34],{36:d}),t(h,[2,32]),t(m,[2,20],{19:v,20:y,21:x,22:C}),t(m,[2,21],{19:v,20:y,21:x,22:C}),t(m,[2,22],{19:v,20:y,21:x,22:C}),t(m,[2,23],{19:v,20:y,21:x,22:C}),t(m,[2,24],{19:v,20:y,21:x,22:C}),t(m,[2,25],{19:v,20:y,21:x,22:C}),t(h,[2,27]),t(h,[2,29],{43:w,44:b,48:E}),t(h,[2,28]),t(h,[2,30],{43:w,44:b,48:E}),t(I,[2,15],{17:O}),t(I,[2,16],{17:O}),t(I,[2,17],{17:O}),t(I,[2,18],{17:O}),t(M,[2,39]),{46:[1,93]},{46:[1,94]},{43:w,44:b,46:[1,95],48:E},t(M,[2,43]),{40:R,49:[1,96]},t(_,[2,59]),t(S,[2,13],{8:A,15:k}),t(_,[2,51]),{7:97,32:15,34:14,41:23,42:n,44:o,45:9,47:10,48:i,50:a,51:s,52:11,53:u,54:12,55:c,56:13,57:l},t(T,[2,10],{11:P,12:L,13:N}),t(T,[2,11],{11:P,12:L,13:N}),t(p,[2,6]),t(p,[2,7]),t(p,[2,8]),t(M,[2,40]),t(M,[2,41]),t(M,[2,42]),t(M,[2,44]),t(F,[2,36])],defaultActions:{31:[2,1]},parseError:function(t,e){if(!e.recoverable){function r(t,e){this.message=t,this.hash=e}throw r.prototype=Error,new r(t,e)}this.trace(t)},parse:function(t){var e=this,r=[0],n=[null],o=[],i=this.table,a="",s=0,u=0,c=0,l=o.slice.call(arguments,1),f=Object.create(this.lexer),d={yy:{}};for(var h in this.yy)Object.prototype.hasOwnProperty.call(this.yy,h)&&(d.yy[h]=this.yy[h]);f.setInput(t,d.yy),d.yy.lexer=f,d.yy.parser=this,void 0===f.yylloc&&(f.yylloc={});var p=f.yylloc;o.push(p);var g=f.options&&f.options.ranges;"function"==typeof d.yy.parseError?this.parseError=d.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var m,v,y,x,C,_,w,b,E,I=function(){var t;return"number"!=typeof(t=f.lex()||1)&&(t=e.symbols_[t]||t),t},O={};;){if(y=r[r.length-1],this.defaultActions[y]?x=this.defaultActions[y]:(null!==m&&void 0!==m||(m=I()),x=i[y]&&i[y][m]),void 0===x||!x.length||!x[0]){var M="";for(_ in E=[],i[y])this.terminals_[_]&&_>2&&E.push("'"+this.terminals_[_]+"'");M=f.showPosition?"Parse error on line "+(s+1)+":\n"+f.showPosition()+"\nExpecting "+E.join(", ")+", got '"+(this.terminals_[m]||m)+"'":"Parse error on line "+(s+1)+": Unexpected "+(1==m?"end of input":"'"+(this.terminals_[m]||m)+"'"),this.parseError(M,{text:f.match,token:this.terminals_[m]||m,line:f.yylineno,loc:p,expected:E})}if(x[0]instanceof Array&&x.length>1)throw new Error("Parse Error: multiple actions possible at state: "+y+", token: "+m);switch(x[0]){case 1:r.push(m),n.push(f.yytext),o.push(f.yylloc),r.push(x[1]),m=null,v?(m=v,v=null):(u=f.yyleng,a=f.yytext,s=f.yylineno,p=f.yylloc,c>0&&c--);break;case 2:if(w=this.productions_[x[1]][1],O.$=n[n.length-w],O._$={first_line:o[o.length-(w||1)].first_line,last_line:o[o.length-1].last_line,first_column:o[o.length-(w||1)].first_column,last_column:o[o.length-1].last_column},g&&(O._$.range=[o[o.length-(w||1)].range[0],o[o.length-1].range[1]]),void 0!==(C=this.performAction.apply(O,[a,u,s,d.yy,x[1],n,o].concat(l))))return C;w&&(r=r.slice(0,-1*w*2),n=n.slice(0,-1*w),o=o.slice(0,-1*w)),r.push(this.productions_[x[1]][0]),n.push(O.$),o.push(O._$),b=i[r[r.length-2]][r[r.length-1]],r.push(b);break;case 3:return!0}}return!0}},j={EOF:1,parseError:function(t,e){if(!this.yy.parser)throw new Error(t);this.yy.parser.parseError(t,e)},setInput:function(t,e){return this.yy=e||this.yy||{},this._input=t,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var t=this._input[0];return this.yytext+=t,this.yyleng++,this.offset++,this.match+=t,this.matched+=t,t.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),t},unput:function(t){var e=t.length,r=t.split(/(?:\r\n?|\n)/g);this._input=t+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-e),this.offset-=e;var n=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),r.length-1&&(this.yylineno-=r.length-1);var o=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:r?(r.length===n.length?this.yylloc.first_column:0)+n[n.length-r.length].length-r[0].length:this.yylloc.first_column-e},this.options.ranges&&(this.yylloc.range=[o[0],o[0]+this.yyleng-e]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(t){this.unput(this.match.slice(t))},pastInput:function(){var t=this.matched.substr(0,this.matched.length-this.match.length);return(t.length>20?"...":"")+t.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var t=this.match;return t.length<20&&(t+=this._input.substr(0,20-t.length)),(t.substr(0,20)+(t.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var t=this.pastInput(),e=new Array(t.length+1).join("-");return t+this.upcomingInput()+"\n"+e+"^"},test_match:function(t,e){var r,n,o;if(this.options.backtrack_lexer&&(o={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(o.yylloc.range=this.yylloc.range.slice(0))),(n=t[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=n.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:n?n[n.length-1].length-n[n.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+t[0].length},this.yytext+=t[0],this.match+=t[0],this.matches=t,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(t[0].length),this.matched+=t[0],r=this.performAction.call(this,this.yy,this,e,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),r)return r;if(this._backtrack){for(var i in o)this[i]=o[i];return!1}return!1},next:function(){if(this.done)return this.EOF;var t,e,r,n;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var o=this._currentRules(),i=0;i<o.length;i++)if((r=this._input.match(this.rules[o[i]]))&&(!e||r[0].length>e[0].length)){if(e=r,n=i,this.options.backtrack_lexer){if(!1!==(t=this.test_match(r,o[i])))return t;if(this._backtrack){e=!1;continue}return!1}if(!this.options.flex)break}return e?!1!==(t=this.test_match(e,o[n]))&&t:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var t=this.next();return t||this.lex()},begin:function(t){this.conditionStack.push(t)},popState:function(){return this.conditionStack.length-1>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(t){return(t=this.conditionStack.length-1-Math.abs(t||0))>=0?this.conditionStack[t]:"INITIAL"},pushState:function(t){this.begin(t)},stateStackSize:function(){return this.conditionStack.length},options:{},performAction:function(t,e,r,n){switch(r){case 0:return 31;case 1:return 33;case 2:return"from";case 3:return 24;case 4:return 25;case 5:return 26;case 6:return 27;case 7:return 21;case 8:return 19;case 9:return 22;case 10:return 20;case 11:return 28;case 12:return 29;case 13:return 36;case 14:return 38;case 15:return 57;case 16:return 55;case 17:break;case 18:return 51;case 19:case 20:return 50;case 21:return 42;case 22:return 53;case 23:return 43;case 24:return 11;case 25:return 12;case 26:return 13;case 27:return 40;case 28:return 8;case 29:return 28;case 30:return 29;case 31:return 25;case 32:return 24;case 33:return 27;case 34:return 26;case 35:return 21;case 36:return 22;case 37:return 20;case 38:return 19;case 39:return 36;case 40:return 38;case 41:return 15;case 42:return 17;case 43:return 48;case 44:return 46;case 45:return 44;case 46:return 49;case 47:return 9;case 48:return 5}},rules:[/^(?:\s+in\b)/,/^(?:\s+notIn\b)/,/^(?:\s+from\b)/,/^(?:\s+(eq|EQ)\b)/,/^(?:\s+(seq|SEQ)\b)/,/^(?:\s+(neq|NEQ)\b)/,/^(?:\s+(sneq|SNEQ)\b)/,/^(?:\s+(lte|LTE)\b)/,/^(?:\s+(lt|LT)\b)/,/^(?:\s+(gte|GTE)\b)/,/^(?:\s+(gt|GT)\b)/,/^(?:\s+(like|LIKE)\b)/,/^(?:\s+(notLike|NOT_LIKE)\b)/,/^(?:\s+(and|AND)\b)/,/^(?:\s+(or|OR)\b)/,/^(?:\s*(null)\b)/,/^(?:\s*(true|false)\b)/,/^(?:\s+)/,/^(?:-?[0-9]+(?:\.[0-9]+)?\b)/,/^(?:'[^']*')/,/^(?:"[^"]*")/,/^(?:([a-zA-Z_$][0-9a-zA-Z_$]*))/,/^(?:^\/((?![\s=])[^[\/\n\\]*(?:(?:\\[\s\S]|\[[^\]\n\\]*(?:\\[\s\S][^\]\n\\]*)*])[^[\/\n\\]*)*\/[imgy]{0,4})(?!\w))/,/^(?:\.)/,/^(?:\*)/,/^(?:\/)/,/^(?:\%)/,/^(?:,)/,/^(?:-)/,/^(?:=~)/,/^(?:!=~)/,/^(?:===)/,/^(?:==)/,/^(?:!==)/,/^(?:!=)/,/^(?:<=)/,/^(?:>=)/,/^(?:>)/,/^(?:<)/,/^(?:&&)/,/^(?:\|\|)/,/^(?:\+)/,/^(?:\^)/,/^(?:\()/,/^(?:\])/,/^(?:\[)/,/^(?:\))/,/^(?:!)/,/^(?:$)/],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48],inclusive:!0}}};function B(){this.yy={}}return D.lexer=j,B.prototype=D,D.Parser=B,new B}();void 0!==t&&void 0!==r&&(r.parser=o,r.Parser=o.Parser,r.parse=function(){return o.parse.apply(o,arguments)},r.main=function(e){e[1]||(console.log("Usage: "+e[0]+" FILE"),n.exit(1));var o=t("fs").readFileSync(t("path").normalize(e[1]),"utf8");return r.parser.parse(o)},void 0!==e&&t.main===e&&r.main(n.argv.slice(1)))},{__browserify_process:64,fs:61,path:62}],44:[function(t,e,r){!function(){"use strict";var e=t("./constraint/parser"),n=t("./b2wgin/nool.parser");r.parseConstraint=function(t){try{return e.parse(t)}catch(e){throw new Error("Invalid expression '"+t+"'")}},r.parseRuleSet=function(t,e){return n.parse(t,e)}}()},{"./constraint/parser":43,"./b2wgin/nool.parser":45}],45:[function(t,e,r){"use strict";var n=t("./tokens.js"),o=t("../../extended").hash.keys,i=t("./util.js"),a=function(t,e,r){var n=t;t=t.replace(/\/\/(.*)/g,"").replace(/\r\n|\r|\n/g," ");for(var s,u=new RegExp("^("+o(e).join("|")+")");t&&-1!==(s=i.findNextTokenIndex(t));){var c=(t=t.substr(s)).match(u);if(null===c)throw new Error("Error parsing "+t);if(!((c=c[1])in e))throw new Error("Unknown token"+c);try{t=e[c](t,r,a).replace(/^\s*|\s*$/g,"")}catch(t){throw new Error("Invalid "+c+" definition \n"+t.message+"; \nstarting at : "+n)}}};r.parse=function(t,e){var r={define:[],rules:[],scope:[],loaded:[],file:e};return a(t,n,r),r}},{"../../extended":12,"./tokens.js":46,"./util.js":47}],46:[function(require,module,exports){var process=require("__browserify_process"),utils=require("./util.js"),fs=require("fs"),extd=require("../../extended"),filter=extd.filter,indexOf=extd.indexOf,predicates=["not","or","exists"],predicateRegExp=new RegExp("^("+predicates.join("|")+") *\\((.*)\\)$","m"),predicateBeginExp=new RegExp(" *("+predicates.join("|")+") *\\(","g"),isWhiteSpace=function(t){return 0===t.replace(/[\s|\n|\r|\t]/g,"").length},joinFunc=function(t,e){return"; "+e},splitRuleLineByPredicateExpressions=function(t){var e=t.replace(/,\s*(\$?\w+\s*:)/g,joinFunc),r=filter(e.split(predicateBeginExp),function(t){return""!==t}),n=r.length,o=[];if(!n)return e;for(var i=0;i<n;i++)-1!==indexOf(predicates,r[i])?o.push([r[i],"(",r[++i].replace(/, *$/,"")].join("")):o.push(r[i].replace(/, *$/,""));return o.join(";")},ruleTokens={salience:(salienceRegexp=/^(salience|priority)\s*:\s*(-?\d+)\s*[,;]?/,function(t,e){if(salienceRegexp.test(t)){var r=t.match(salienceRegexp),n=parseInt(r[2],10);if(isNaN(n))throw new Error("Invalid salience/priority "+r[2]);return e.options.priority=n,t.replace(r[0],"")}throw new Error("invalid format")}),agendaGroup:(agendaGroupRegexp=/^(agenda-group|agendaGroup)\s*:\s*([a-zA-Z_$][0-9a-zA-Z_$]*|"[^"]*"|'[^']*')\s*[,;]?/,function(t,e){if(agendaGroupRegexp.test(t)){var r=t.match(agendaGroupRegexp),n=r[2];if(!n)throw new Error("Invalid agenda-group "+r[2]);return e.options.agendaGroup=n.replace(/^["']|["']$/g,""),t.replace(r[0],"")}throw new Error("invalid format")}),autoFocus:(autoFocusRegexp=/^(auto-focus|autoFocus)\s*:\s*(true|false)\s*[,;]?/,function(t,e){if(autoFocusRegexp.test(t)){var r=t.match(autoFocusRegexp),n=r[2];if(!n)throw new Error("Invalid auto-focus "+r[2]);return e.options.autoFocus="true"===n,t.replace(r[0],"")}throw new Error("invalid format")}),"agenda-group":function(){return this.agendaGroup.apply(this,arguments)},"auto-focus":function(){return this.autoFocus.apply(this,arguments)},priority:function(){return this.salience.apply(this,arguments)},when:function(){var ruleRegExp=/^(\$?\w+) *: *(\w+)(.*)/,constraintRegExp=/(\{ *(?:["']?\$?\w+["']?\s*:\s*["']?\$?\w+["']? *(?:, *["']?\$?\w+["']?\s*:\s*["']?\$?\w+["']?)*)+ *\})/,fromRegExp=/(\bfrom\s+.*)/,parseRules=function(str){for(var rules=[],ruleLines=str.split(";"),l=ruleLines.length,ruleLine,i=0;i<l&&(ruleLine=ruleLines[i].replace(/^\s*|\s*$/g,"").replace(/\n/g,""));i++)if(!isWhiteSpace(ruleLine)){var rule=[];if(predicateRegExp.test(ruleLine)){var m=ruleLine.match(predicateRegExp),pred=m[1].replace(/^\s*|\s*$/g,"");if(rule.push(pred),ruleLine=m[2].replace(/^\s*|\s*$/g,""),"or"===pred){rule=rule.concat(parseRules(splitRuleLineByPredicateExpressions(ruleLine))),rules.push(rule);continue}}var parts=ruleLine.match(ruleRegExp);if(!parts||!parts.length)throw new Error("Invalid constraint "+ruleLine);rule.push(parts[2],parts[1]);var constraints=parts[3].replace(/^\s*|\s*$/g,""),hashParts=constraints.match(constraintRegExp),from=null,fromMatch;if(hashParts){var hash=hashParts[1],constraint=constraints.replace(hash,"");fromRegExp.test(constraint)&&(fromMatch=constraint.match(fromRegExp),from=fromMatch[0],constraint=constraint.replace(fromMatch[0],"")),constraint&&rule.push(constraint.replace(/^\s*|\s*$/g,"")),hash&&rule.push(eval("("+hash.replace(/(\$?\w+)\s*:\s*(\$?\w+)/g,'"$1" : "$2"')+")"))}else constraints&&!isWhiteSpace(constraints)&&(fromRegExp.test(constraints)&&(fromMatch=constraints.match(fromRegExp),from=fromMatch[0],constraints=constraints.replace(fromMatch[0],"")),rule.push(constraints));from&&rule.push(from),rules.push(rule)}return rules};return function(t,e){var r=t.replace(/^when\s*/,"").replace(/^\s*|\s*$/g,"");if("{"===utils.findNextToken(r)){var n=utils.getTokensBetween(r,"{","}",!0).join("");return r=r.replace(n,""),e.constraints=parseRules(n.replace(/^\{\s*|\}\s*$/g,"")),r}throw new Error("unexpected token : expected : '{' found : '"+utils.findNextToken(r)+"'")}}(),then:function(t,e){if(e.action)throw new Error("action already defined for rule"+e.name);var r=t.replace(/^then\s*/,"").replace(/^\s*|\s*$/g,"");if("{"===utils.findNextToken(r)){var n=utils.getTokensBetween(r,"{","}",!0).join("");if(r=r.replace(n,""),e.action||(e.action=n.replace(/^\{\s*|\}\s*$/g,"")),!isWhiteSpace(r))throw new Error("Error parsing then block "+t);return r}throw new Error("unexpected token : expected : '{' found : '"+utils.findNextToken(r)+"'")}},autoFocusRegexp,agendaGroupRegexp,salienceRegexp,topLevelTokens={"/":function(t){return t.match(/^\/\*/)?t.replace(/\/\*.*?\*\//,""):t},define:function(t,e){var r=t.replace(/^define\s*/,""),n=r.match(/^([a-zA-Z_$][0-9a-zA-Z_$]*)/);if(n){if(r=r.replace(n[0],"").replace(/^\s*|\s*$/g,""),"{"===utils.findNextToken(r)){n=n[1];var o=utils.getTokensBetween(r,"{","}",!0).join("");return r=r.replace(o,""),e.define.push({name:n,properties:"("+o+")"}),r}throw new Error("unexpected token : expected : '{' found : '"+utils.findNextToken(r)+"'")}throw new Error("missing name")},import:function(t,e,r){if("undefined"!=typeof window)throw new Error("import cannot be used in a browser");var n=t.replace(/^import\s*/,"");if("("===utils.findNextToken(n)){var o=utils.getParamList(n);if(n=n.replace(o,"").replace(/^\s*|\s*$/g,""),";"===utils.findNextToken(n)&&(n=n.replace(/\s*;/,"")),1===(o=o.replace(/[\(|\)]/g,"").split(",")).length){if(o=utils.resolve(e.file||process.cwd(),o[0].replace(/["|']/g,"")),-1===indexOf(e.loaded,o)){var i=e.file;e.file=o,r(fs.readFileSync(o,"utf8"),topLevelTokens,e),e.loaded.push(o),e.file=i}return n}throw new Error("import accepts a single file")}throw new Error("unexpected token : expected : '(' found : '"+utils.findNextToken(n)+"'")},global:function(t,e){var r=t.replace(/^global\s*/,""),n=r.match(/^([a-zA-Z_$][0-9a-zA-Z_$]*\s*)/);if(n){if(r=r.replace(n[0],"").replace(/^\s*|\s*$/g,""),"="===utils.findNextToken(r)){n=n[1].replace(/^\s+|\s+$/g,"");var o=utils.getTokensBetween(r,"=",";",!0).join(""),i=o.substring(1,o.length-1);if(i=i.replace(/^\s+|\s+$/g,""),/^require\(/.test(i)){var a=utils.getParamList(i.replace("require")).replace(/[\(|\)]/g,"").split(",");1===a.length&&(a=a[0].replace(/["|']/g,""),i=["require('",utils.resolve(e.file||process.cwd(),a),"')"].join(""))}return e.scope.push({name:n,body:i}),r=r.replace(o,"")}throw new Error("unexpected token : expected : '=' found : '"+utils.findNextToken(r)+"'")}throw new Error("missing name")},function:function(t,e){var r=t.replace(/^function\s*/,""),n=r.match(/^([a-zA-Z_$][0-9a-zA-Z_$]*)\s*/);if(n){if(r=r.replace(n[0],""),"("===utils.findNextToken(r)){n=n[1];var o=utils.getParamList(r);if(r=r.replace(o,"").replace(/^\s*|\s*$/g,""),"{"===utils.findNextToken(r)){var i=utils.getTokensBetween(r,"{","}",!0).join("");return r=r.replace(i,""),e.scope.push({name:n,body:"function"+o+i}),r}throw new Error("unexpected token : expected : '{' found : '"+utils.findNextToken(r)+"'")}throw new Error("unexpected token : expected : '(' found : '"+utils.findNextToken(r)+"'")}throw new Error("missing name")},rule:function(t,e,r){var n=t.replace(/^rule\s*/,""),o=n.match(/^([a-zA-Z_$][0-9a-zA-Z_$]*|"[^"]*"|'[^']*')/);if(o){if(n=n.replace(o[0],"").replace(/^\s*|\s*$/g,""),"{"===utils.findNextToken(n)){var i={name:o=o[1].replace(/^["']|["']$/g,""),options:{},constraints:null,action:null},a=utils.getTokensBetween(n,"{","}",!0).join("");return n=n.replace(a,""),r(a.replace(/^\{\s*|\}\s*$/g,""),ruleTokens,i),e.rules.push(i),n}throw new Error("unexpected token : expected : '{' found : '"+utils.findNextToken(n)+"'")}throw new Error("missing name")}};module.exports=topLevelTokens},{"../../extended":12,"./util.js":47,__browserify_process:64,fs:61}],47:[function(t,e,r){var n=t("__browserify_process"),o=t("path"),i=/[\s|\n|\r|\t]/,a=o.sep||("win32"===n.platform?"\\":"/"),s={"{":"}","}":"{","(":")",")":"(","[":"]"},u=r.getTokensBetween=function(t,e,r,n){var o=0,i=[];e||(e=s[r],o=1),r||(r=s[e]),t=Object(t);for(var a,u=!1,c=0,l=!1;a=t.charAt(c++);)if(a===e)o++,u?i.push(a):(u=!0,n&&i.push(a));else if(a===r&&c){if(0===--o){n&&i.push(a),l=!0;break}i.push(a)}else u&&i.push(a);if(!l)throw new Error("Unable to match "+e+" in "+t);return i};r.getParamList=function(t){return u(t,"(",")",!0).join("")},r.resolve=function(t,e){return"win32"===n.platform&&(e=e.replace(/\//g,"\\")),""!==o.extname(t)&&(t=o.dirname(t)),1===e.split(a).length?e:o.resolve(t,e).replace(/\\/g,"/")};var c=r.findNextTokenIndex=function(t,e,r){e=e||0,r=r||t.length;var n=-1,o=t.length;for((!r||r>o)&&(r=o);e<r;e++){var a=t.charAt(e);if(!i.test(a)){n=e;break}}return n};r.findNextToken=function(t,e,r){return t.charAt(c(t,e,r))}},{__browserify_process:64,path:62}],48:[function(t,e,r){"use strict";var n=t("./extended"),o=n.isEmpty,i=n.merge,a=n.forEach,s=n.declare,u=t("./constraintMatcher"),c=t("./constraint"),l=c.EqualityConstraint,f=c.FromConstraint,d=0,h=s({}),p=h.extend({instance:{constructor:function(t,e,r,n,s){s=s||{},this.id=d++,this.type=t,this.alias=e,this.conditions=r,this.pattern=s.pattern;var l=[new c.ObjectConstraint(t)],f=u.toConstraints(r,i({alias:e},s));if(f.length)l=l.concat(f);else{var h=new c.TrueConstraint;l.push(h)}if(n&&!o(n)){var p=new c.HashConstraint(n);l.push(p)}a(l,function(t){t.set("alias",e)}),this.constraints=l},getSpecificity:function(){for(var t=this.constraints,e=0,r=0,n=t.length;r<n;r++)t[r]instanceof l&&e++;return e},hasConstraint:function(t){return n.some(this.constraints,function(e){return e instanceof t})},hashCode:function(){return[this.type,this.alias,n.format("%j",this.conditions)].join(":")},toString:function(){return n.format("%j",this.constraints)}}}).as(r,"ObjectPattern"),g=p.extend({instance:{constructor:function(t,e,r,n,o,i){this._super([t,e,r,n,i]),this.from=new f(o,i)},hasConstraint:function(t){return n.some(this.constraints,function(e){return e instanceof t})},getSpecificity:function(){return this._super(arguments)+1},hashCode:function(){return[this.type,this.alias,n.format("%j",this.conditions),this.from.from].join(":")},toString:function(){return n.format("%j from %s",this.constraints,this.from.from)}}}).as(r,"FromPattern");g.extend().as(r,"FromNotPattern"),p.extend().as(r,"NotPattern"),p.extend().as(r,"ExistsPattern"),g.extend().as(r,"FromExistsPattern"),h.extend({instance:{constructor:function(t,e){this.id=d++,this.leftPattern=t,this.rightPattern=e},hashCode:function(){return[this.leftPattern.hashCode(),this.rightPattern.hashCode()].join(":")},getSpecificity:function(){return this.rightPattern.getSpecificity()+this.leftPattern.getSpecificity()},getters:{constraints:function(){return this.leftPattern.constraints.concat(this.rightPattern.constraints)}}}}).as(r,"CompositePattern");var m=s({instance:{constructor:function(){this.id=d++,this.recency=0}}}).as(r,"InitialFact");p.extend({instance:{constructor:function(){this._super([m,"__i__",[],{}])},assert:function(){return!0}}}).as(r,"InitialFactPattern")},{"./constraint":8,"./constraintMatcher":9,"./extended":12}],49:[function(t,e,r){"use strict";var n=t("./extended"),o=n.isArray,i=n.Promise,a=n.declare,s=n.isHash,u=n.isString,c=n.format,l=t("./parser"),f=t("./pattern"),d=f.ObjectPattern,h=f.FromPattern,p=f.NotPattern,g=f.ExistsPattern,m=f.FromNotPattern,v=f.FromExistsPattern,y=f.CompositePattern,x=function(t){return"function"==typeof t?t:l.parseConstraint(t)},C=n.switcher().isUndefinedOrNull(function(){return null}).isLike(/^from +/,function(t){return{from:t.replace(/^from +/,"").replace(/^\s*|\s*$/g,"")}}).def(function(t){throw new Error("invalid rule constraint option "+t)}).switcher(),_=n.switcher().isLength(1,function(t){throw new Error("invalid rule constraint "+c("%j",[t]))}).isLength(2,function(t){return t.push("true"),t}).isLength(3,function(t){if(u(t[2])&&/^from +/.test(t[2])){var e=t[2];t.splice(2,0,"true"),t[3]=null,t[4]=C(e)}else s(t[2])&&t.splice(2,0,"true");return t}).isLength(4,function(t){return u(t[3])&&(t.splice(3,0,null),t[4]=C(t[4])),t}).def(function(t){return 5===t.length&&(t[4]=C(t[4])),t}).switcher(),w=function(t,e){e=e||{};var r=n.switcher().isEq("string",function(){return String}).isEq("date",function(){return Date}).isEq("array",function(){return Array}).isEq("boolean",function(){return Boolean}).isEq("regexp",function(){return RegExp}).isEq("number",function(){return Number}).isEq("object",function(){return Object}).isEq("hash",function(){return Object}).def(function(t){throw new TypeError("invalid param type "+t)}).switcher();return n.switcher().isString(function(t){var n=e[t];return n||r(t.toLowerCase())}).isFunction(function(t){return t}).deepEqual([],function(){return Array}).def(function(t){throw new Error("invalid param type "+t)}).switcher()(t)},b=n.switcher().containsAt("or",0,function(t){return t.shift(),n(t).map(function(e){return e.scope=t.scope,b(e)}).flatten().value()}).containsAt("not",0,function(t){return t.shift(),(t=_(t))[4]&&t[4].from?[new m(w(t[0],t.scope),t[1]||"m",x(t[2]||"true"),t[3]||{},x(t[4].from),{scope:t.scope,pattern:t[2]})]:[new p(w(t[0],t.scope),t[1]||"m",x(t[2]||"true"),t[3]||{},{scope:t.scope,pattern:t[2]})]}).containsAt("exists",0,function(t){return t.shift(),(t=_(t))[4]&&t[4].from?[new v(w(t[0],t.scope),t[1]||"m",x(t[2]||"true"),t[3]||{},x(t[4].from),{scope:t.scope,pattern:t[2]})]:[new g(w(t[0],t.scope),t[1]||"m",x(t[2]||"true"),t[3]||{},{scope:t.scope,pattern:t[2]})]}).def(function(t){return"function"==typeof t?[t]:(t=_(t))[4]&&t[4].from?[new h(w(t[0],t.scope),t[1]||"m",x(t[2]||"true"),t[3]||{},x(t[4].from),{scope:t.scope,pattern:t[2]})]:[new d(w(t[0],t.scope),t[1]||"m",x(t[2]||"true"),t[3]||{},{scope:t.scope,pattern:t[2]})]}).switcher(),E=a({instance:{constructor:function(t,e,r,o){this.name=t,this.pattern=r,this.cb=o,e.agendaGroup&&(this.agendaGroup=e.agendaGroup,this.autoFocus=!!n.isBoolean(e.autoFocus)&&e.autoFocus),this.priority=e.priority||e.salience||0},fire:function(t,e){var r=new i,n=this.cb;try{3===n.length?n.call(t,e.factHash,t,r.resolve):r=n.call(t,e.factHash,t)}catch(t){r.errback(t)}return r}}});r.createRule=function(t,e,r,i){o(e)?(i=r,r=e):e=e||{};var a=n.every(r,function(t){return o(t)});a&&1===r.length&&(r=r[0],a=!1);var s=[],u=e.scope||{};if(r.scope=u,a){for(var c,l=function(t,e){d[e]?n(d).forEach(function(e){e.push(t)}):(d[e]=0===e?[]:d[e-1].slice(),0!==e&&d[e].pop(),d[e].push(t))},f=r.length,d=[],h=0;h<f;h++)(c=r[h]).scope=u,n.forEach(b(c),l);s=n.map(d,function(r){for(var n=null,o=0;o<r.length;o++)n=new y(null===n?r[o++]:n,r[o]);return new E(t,e,n,i)})}else s=n.map(b(r),function(r){return new E(t,e,r,i)});return s}},{"./extended":12,"./parser":44,"./pattern":48}],50:[function(t,e,r){"use strict";var n=t("declare.js"),o=t("./linkedList"),i=t("./pattern").InitialFact,a=0,s=n({instance:{constructor:function(t){this.object=t,this.recency=0,this.id=a++},equals:function(t){return t===this.object},hashCode:function(){return this.id}}});n({instance:{constructor:function(){this.recency=0,this.facts=new o},dispose:function(){this.facts.clear()},getFacts:function(){for(var t,e={next:this.facts.head},r=[],n=0;e=e.next;)(t=e.data.object)instanceof i||(r[n++]=t);return r},getFactsByType:function(t){for(var e={next:this.facts.head},r=[],n=0;e=e.next;){var o=e.data.object;o instanceof i||!(o instanceof t||o.constructor===t)||(r[n++]=o)}return r},getFactHandle:function(t){for(var e,r={next:this.facts.head};r=r.next;){var n=r.data;if(n.equals(t))return n}return e||((e=new s(t)).recency=this.recency++),e},modifyFact:function(t){for(var e={next:this.facts.head};e=e.next;){var r=e.data;if(r.equals(t))return r.recency=this.recency++,r}throw new Error("the fact to modify does not exist")},assertFact:function(t){var e=new s(t);return e.recency=this.recency++,this.facts.push(e),e},retractFact:function(t){for(var e=this.facts,r={next:e.head};r=r.next;){var n=r.data;if(n.equals(t))return e.remove(r),n}throw new Error("the fact to remove does not exist")}}}).as(r,"WorkingMemory")},{"./linkedList":16,"./pattern":48,"declare.js":55}],51:[function(t,e,r){(function(){"use strict";function n(t,e){Array.prototype.slice;var r=e.isArguments;function n(t,e){var r=-1,n=0,o=t.length,i=[];for(r+=e=e||0;++r<o;)i[n++]=t[r];return i}return t.define(r,{toArray:n}).expose({argsToArray:n})}void 0!==r?void 0!==e&&e.exports&&(e.exports=n(t("extended"),t("is-extended"))):"function"==typeof define&&define.amd?define(["extended","is-extended"],function(t,e){return n(t,e)}):this.argumentsExtended=n(this.extended,this.isExtended)}).call(this)},{extended:56,"is-extended":66}],52:[function(t,e,r){(function(){"use strict";function n(t,e,r){var n=e.isString,o=Array.isArray||e.isArray,i=e.isDate,a=Math.floor,s=Math.abs,u=(Math.max,Math.min),c=Array.prototype,l=(c.indexOf,c.forEach),f=c.map,d=c.reduce,h=c.reduceRight,p=c.filter,g=c.every,m=c.some,v=r.argsToArray;function y(t,e){var r,n,o=[],i=-1;for(n=t.length;++i<n;)-1!==b(e,r=t[i])&&o.push(r);return o}var x,C,_,w=(x=function(t,e){return O(t,e)},C=function(t,e){return t-e},_=function(t,e){return t.getTime()-e.getTime()},function(t,e){var r=[];return o(t)&&(r=t.slice(),e?"function"==typeof e?r.sort(e):r.sort(function(t,r){var o=t[e],a=r[e];return n(o)&&n(a)?o>a?1:o<a?-1:0:i(o)&&i(a)?o.getTime()-a.getTime():o-a}):x(r,n)?r.sort():x(r,i)?r.sort(_):r.sort(C)),r});function b(t,e,r){for(var n=(r||0)-1,o=t.length;++n<o;)if(t[n]===e)return n;return-1}function E(t,e,r){if(t&&p&&p===t.filter)return t.filter(e,r);if(!o(t)||"function"!=typeof e)throw new TypeError;for(var n=Object(t),i=n.length>>>0,a=[],s=0;s<i;s++)if(s in n){var u=n[s];e.call(r,u,s,n)&&a.push(u)}return a}function I(t,e,r){if(!o(t)||"function"!=typeof e)throw new TypeError;if(t&&l&&l===t.forEach)return t.forEach(e,r),t;for(var n=0,i=t.length;n<i;++n)e.call(r||t,t[n],n,t);return t}function O(t,e,r){if(t&&g&&g===t.every)return t.every(e,r);if(!o(t)||"function"!=typeof e)throw new TypeError;for(var n=Object(t),i=n.length>>>0,a=0;a<i;a++)if(a in n&&!e.call(r,n[a],a,n))return!1;return!0}function M(t,e,r){if(t&&f&&f===t.map)return t.map(e,r);if(!o(t)||"function"!=typeof e)throw new TypeError;for(var n=Object(t),i=n.length>>>0,a=[],s=0;s<i;s++)s in n&&a.push(e.call(r,n[s],s,n));return a}function S(t,e,r){var n=arguments.length>2;if(t&&d&&d===t.reduce)return n?t.reduce(e,r):t.reduce(e);if(!o(t)||"function"!=typeof e)throw new TypeError;var i=0,a=t.length>>0;if(arguments.length<3){if(0===a)throw new TypeError("Array length is 0 and no second argument");r=t[0],i=1}else r=arguments[2];for(;i<a;)i in t&&(r=e.call(void 0,r,t[i],i,t)),++i;return r}function A(t,e,r){var n=arguments.length>2;if(t&&h&&h===t.reduceRight)return n?t.reduceRight(e,r):t.reduceRight(e);if(!o(t)||"function"!=typeof e)throw new TypeError;var i=Object(t),a=i.length>>>0;if(0===a&&2===arguments.length)throw new TypeError;var s=a-1;if(arguments.length>=3)r=arguments[2];else for(;;)if(s in t){r=t[s--];break}for(;s>=0;)s in i&&(r=e.call(void 0,r,i[s],s,i)),s--;return r}function k(t){var r=[];if(null!==t){var n=v(arguments);if(1===n.length)if(o(t))r=t;else if(e.isHash(t))for(var i in t)t.hasOwnProperty(i)&&r.push([i,t[i]]);else r.push(t);else I(n,function(t){r=r.concat(k(t))})}return r}function T(t){return(t=t||[]).length?S(t,function(t,e){return t+e}):0}function P(t){var e,r=[],n=-1,o=0;if(t)for(e=t.length;++n<e;){var i=t[n];-1===b(r,i)&&(r[o++]=i)}return r}function L(t,e){var r=t.slice();return"number"!=typeof e&&(e=1),e&&o(t)?(e>0?(r.push(r.shift()),e--):(r.unshift(r.pop()),e++),L(r,e)):r}function N(t){var e=v(arguments);return S(e.length>1?e:k(t),function(t,e){return t.concat(e)},[])}var R={toArray:k,sum:T,avg:function(t){if((t=t||[]).length){var r=T(t);if(e.isNumber(r))return r/t.length;throw new Error("Cannot average an array of non numbers.")}return 0},sort:function(t,e){return w(t,e)},min:function(t,e){return w(t,e)[0]},max:function(t,e){return w(t,e)[t.length-1]},difference:function(t){var e=t,r=N(v(arguments,1));return o(t)&&(e=E(t,function(t){return-1===b(r,t)})),e},removeDuplicates:P,unique:function(t){return P(t)},rotate:L,permutations:function(t,e){var r=[];if(o(t)){var n=t.slice(0);"number"!=typeof e&&(e=t.length),e?e<=t.length&&(r=S(t,function(t,r,o){var i;return i=e>1?function(t,e,r){for(var n=[],o=0;o<e.length;o++)n.push([t].concat(L(e,o)).slice(0,r));return n}(r,L(n,o).slice(1),e):[[r]],t.concat(i)},[])):r=[[]]}return r},zip:function(){var t=[],r=v(arguments);if(r.length>1){var n=r.shift();o(n)&&(t=S(n,function(t,n,i){for(var a=[n],s=0;s<r.length;s++){var u=r[s];o(u)&&!e.isUndefined(u[i])?a.push(u[i]):a.push(null)}return t.push(a),t},[]))}return t},transpose:function(t){var e,r=[];return o(t)&&t.length&&I(t,function(t){!o(t)||e&&t.length!==e.length||(I(t,function(t,e){r[e]||(r[e]=[]),r[e].push(t)}),e=t)}),r},valuesAt:function(t,e){var r=[];if(t=(e=v(arguments)).shift(),o(t)&&e.length)for(var n=0,i=e.length;n<i;n++)r.push(t[e[n]]||null);return r},union:function(){var t=[],e=v(arguments);if(e.length>1){for(var r=0,n=e.length;r<n;r++)t=t.concat(e[r]);t=P(t)}return t},intersect:function(){var t,e,r=[],n=-1;if(t=arguments.length>1?v(arguments):arguments[0],o(t))for(r=t[0],n=0,e=t.length;++n<e;)r=y(r,t[n]);return P(r)},powerSet:function(t){var e=[];return o(t)&&t.length&&(e=S(t,function(t,e){var r=M(t,function(t){return t.concat(e)});return t.concat(r)},[[]])),e},cartesian:function t(e,r){var n,i,a=[];return o(e)&&o(r)&&e.length&&r.length&&(a=(n=e[0],i=r,A(i,function(t,e){return o(e)||(e=[e]),e.unshift(n),t.unshift(e),t},[])).concat(t(e.slice(1),r))),a},compact:function(t){var r=[];return o(t)&&t.length&&(r=E(t,function(t){return!e.isUndefinedOrNull(t)})),r},multiply:function(t,r){(r=e.isNumber(r)?r:1)||(r=1),t=k(t||[]);for(var n=[],o=0;++o<=r;)n=n.concat(t);return n},flatten:N,pluck:function(t,e){e=e.split(".");var r=t.slice(0);return I(e,function(t){var e=t.match(/(\w+)\(\)$/);r=M(r,function(r){return e?r[e[1]]():r[t]})}),r},invoke:function(t,e,r){return r=v(arguments,2),M(t,function(t){return(n(e)?t[e]:e).apply(t,r)})},forEach:I,map:M,filter:E,reduce:S,reduceRight:A,some:function(t,e,r){if(t&&m&&m===t.some)return t.some(e,r);if(!o(t)||"function"!=typeof e)throw new TypeError;for(var n=Object(t),i=n.length>>>0,a=0;a<i;a++)if(a in n&&e.call(r,n[a],a,n))return!0;return!1},every:O,indexOf:b,lastIndexOf:function(t,e,r){if(!o(t))throw new TypeError;var n=Object(t),i=n.length>>>0;if(0===i)return-1;var c=i;arguments.length>2&&((c=Number(arguments[2]))!=c?c=0:0!==c&&c!==1/0&&c!==-1/0&&(c=(c>0||-1)*a(s(c))));for(var l=c>=0?u(c,i-1):i-s(c);l>=0;l--)if(l in n&&n[l]===e)return l;return-1}};return t.define(o,R).expose(R)}void 0!==r?void 0!==e&&e.exports&&(e.exports=n(t("extended"),t("is-extended"),t("arguments-extended"))):"function"==typeof define&&define.amd?define(["extended","is-extended","arguments-extended"],function(t,e,r){return n(t,e,r)}):this.arrayExtended=n(this.extended,this.isExtended,this.argumentsExtended)}).call(this)},{"arguments-extended":51,extended:56,"is-extended":66}],53:[function(t,e,r){(function(){"use strict";function n(t,e,r){function n(t,e,r,n){t=""+t,r=r||" ";for(var o=t.length;o<e;)n?t+=r:t=r+t,o++;return t}var o=function(){var t=Math.floor,e=Math.round,r={day:function(t,e){return[e,"Date",!1]},weekday:function(t,e){var r,n,o=e%5,i=t.getDay(),a=0;o?(r=o,n=parseInt(e/5,10)):(r=e>0?5:-5,n=e>0?(e-5)/5:(e+5)/5),6===i&&e>0?a=1:0===i&&e<0&&(a=-1);var s=i+r;return 0!==s&&6!==s||(a=e>0?2:-2),[7*n+r+a,"Date",!1]},year:function(t,e){return[e,"FullYear",!0]},week:function(t,e){return[7*e,"Date",!1]},quarter:function(t,e){return[3*e,"Month",!0]},month:function(t,e){return[e,"Month",!0]}};var n={quarter:function(e,r,n){var o=r.getFullYear()-e.getFullYear(),i=e[n?"getUTCMonth":"getMonth"](),a=r[n?"getUTCMonth":"getMonth"](),s=t(i/3)+1,u=t(a/3)+1;return(u+=4*o)-s},weekday:function(t,e,r){var n,i=o("day",t,e,r),a=i%7;if(0===a)i=5*o("week",t,e,r);else{var s=0,u=t[r?"getUTCDay":"getDay"](),c=e[r?"getUTCDay":"getDay"]();n=parseInt(i/7,10);var l=new Date(+t);l.setDate(l[r?"getUTCDate":"getDate"]()+7*n);var f=l[r?"getUTCDay":"getDay"]();i>0?6===u||6===c?s=-1:0===u?s=0:(0===c||f+a>5)&&(s=-2):i<0&&(6===u?s=0:0===u||0===c?s=1:(6===c||f+a<0)&&(s=2)),i+=s,i-=2*n}return i},year:function(t,e){return e.getFullYear()-t.getFullYear()},month:function(t,e,r){var n=t[r?"getUTCMonth":"getMonth"]();return e[r?"getUTCMonth":"getMonth"]()-n+12*(e.getFullYear()-t.getFullYear())},week:function(t,r,n){return e(o("day",t,r,n)/7)},day:function(t,e){return 1.1574074074074074e-8*(e.getTime()-t.getTime())},hour:function(t,e){return 2.7777777777777776e-7*(e.getTime()-t.getTime())},minute:function(t,e){return 16666666666666667e-21*(e.getTime()-t.getTime())},second:function(t,e){return.001*(e.getTime()-t.getTime())},millisecond:function(t,e){return e.getTime()-t.getTime()}};function o(t,r,o,i){return t=t.replace(/s$/,""),e(n[t](r,o,i))}return{addTransform:function(t,e,n){return t=t.replace(/s$/,""),r.hasOwnProperty(t)?r[t](e,n):[n,"UTC"+t.charAt(0).toUpperCase()+t.substring(1)+"s",!1]},differenceTransform:o}}(),i=o.addTransform,a=o.differenceTransform,s=Math.floor,u=Math.round,c=Math.min,l=Math.pow,f=Math.ceil,d=Math.abs,h=["January","February","March","April","May","June","July","August","September","October","November","December"],p=["Jan.","Feb.","Mar.","Apr.","May.","Jun.","Jul.","Aug.","Sep.","Oct.","Nov.","Dec."],g=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],m=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],v=["Before Christ","Anno Domini"],y=["BC","AD"];function x(t,e){return _.difference(new Date(t.getFullYear(),0,1,t.getHours()),t,null,e)+1}function C(t){var e=t.toString(),r="",n=e.indexOf("(");return n>-1&&(r=e.substring(++n,e.indexOf(")"))),r}var _={getDaysInMonth:function(t){var e=t.getMonth();return 1===e&&_.isLeapYear(t)?29:[31,28,31,30,31,30,31,31,30,31,30,31][e]},isLeapYear:function(t,e){var r=t[e?"getUTCFullYear":"getFullYear"]();return r%400==0||r%4==0&&r%100!=0},isWeekend:function(t,e){var r=(t||new Date)[e?"getUTCDay":"getDay"]();return 0===r||6===r},getTimezoneName:C,compare:function(t,e,r){return t=new Date(+t),e=new Date(+(e||new Date)),"date"===r?(t.setHours(0,0,0,0),e.setHours(0,0,0,0)):"time"===r&&(t.setFullYear(0,0,0),e.setFullYear(0,0,0)),t>e?1:t<e?-1:0},add:function(t,e,r){var n=i(e,t,r||0);r=n[0];var o=n[1],a=new Date(+t),s=n[2];return o&&a["set"+o](a["get"+o]()+r),s&&a.getDate()<t.getDate()&&a.setDate(0),a},difference:function(t,e,r,n){return e=e||new Date,a(r=r||"day",t,e,n)},format:function(t,r,o){var i,a,c,_,w,b,E,I;return(o=o||!1)?(i=t.getUTCFullYear(),a=t.getUTCMonth(),c=t.getUTCDay(),_=t.getUTCDate(),w=t.getUTCHours(),b=t.getUTCMinutes(),E=t.getUTCSeconds(),I=t.getUTCMilliseconds()):(i=t.getFullYear(),a=t.getMonth(),_=t.getDate(),c=t.getDay(),w=t.getHours(),b=t.getMinutes(),E=t.getSeconds(),I=t.getMilliseconds()),r.replace(/([A-Za-z])\1*/g,function(r){var O,M,S=r.charAt(0),A=r.length;if("d"===S)O=""+_,M=!0;else if("H"!==S||O)if("m"!==S||O)if("s"===S)O||(O=""+E),M=!0;else if("G"===S)O=(A<4?y:v)[i<0?0:1];else if("y"===S)O=i,A>1&&(2===A?O=function t(r,n,o){var i=r;if(e.isString(i)){if(r.length>n)if(o){var a=r.length;i=r.substring(a-n,a)}else i=r.substring(0,n)}else i=t(""+i,n);return i}(""+O,2,!0):M=!0);else if("Q"===S.toUpperCase())O=f((a+1)/3),M=!0;else if("M"===S)A<3?(O=a+1,M=!0):O=(3===A?p:h)[a];else if("w"===S)O=function(t,e,r){e=e||0;var n=t[r?"getUTCFullYear":"getFullYear"](),o=new Date(n,0,1).getDay(),i=(o-e+7)%7,a=s((x(t)+i-1)/7);return o===e&&a++,a}(t,0,o),M=!0;else if("D"===S)O=x(t,o),M=!0;else if("E"===S)A<3?(O=c+1,M=!0):O=(-3===A?m:g)[c];else if("a"===S)O=w<12?"AM":"PM";else if("h"===S)O=w%12||12,M=!0;else if("K"===S)O=w%12,M=!0;else if("k"===S)O=w||24,M=!0;else if("S"===S)O=u(I*l(10,A-3)),M=!0;else if("z"===S||"v"===S||"Z"===S){if(O=C(t),"z"!==S&&"v"!==S||O||(A=4),!O||"Z"===S){var k=t.getTimezoneOffset(),T=[k>=0?"-":"+",n(s(d(k)/60),2,"0"),n(d(k)%60,2,"0")];4===A&&(T.splice(0,0,"GMT"),T.splice(3,0,":")),O=T.join("")}}else O=r;else O=""+b,M=!0;else O=""+w,M=!0;return M&&(O=n(O,A,"0")),O})}},w={};function b(t){w[t+"sFromNow"]=function(e){return _.add(new Date,t,e)},w[t+"sAgo"]=function(e){return _.add(new Date,t,-e)}}for(var E=["year","month","day","hour","minute","second"],I=0,O=E.length;I<O;I++)b(E[I]);var M={parseDate:function(t,n){if(!n)throw new Error("format required when calling dateExtender.parse");var o=[],i=function(t,e){return t.replace(/([a-z])\1*/gi,function(t){var r,n=t.charAt(0),o=t.length;return"y"===n?r="\\d{2,4}":"M"===n?r=o>2?"\\S+?":"1[0-2]|0?[1-9]":"D"===n?r="[12][0-9][0-9]|3[0-5][0-9]|36[0-6]|0{0,2}[1-9][0-9]|0?[1-9]":"d"===n?r="3[01]|[12]\\d|0?[1-9]":"w"===n?r="[1-4][0-9]|5[0-3]|0?[1-9]":"E"===n?r="\\S+":"h"===n?r="1[0-2]|0?[1-9]":"K"===n?r="1[01]|0?\\d":"H"===n?r="1\\d|2[0-3]|0?\\d":"k"===n?r="1\\d|2[0-4]|0?[1-9]":"m"===n||"s"===n?r="[0-5]\\d":"S"===n?r="\\d{"+o+"}":"a"===n?(r="AM|PM","AM"!=="AM".toLowerCase()&&(r+="|"+"AM".toLowerCase()),"PM"!=="PM".toLowerCase()&&(r+="|"+"PM".toLowerCase()),r=r.replace(/\./g,"\\.")):r="v"===n||"z"===n||"Z"===n||"G"===n||"q"===n||"Q"===n?".*":" "===n?"\\s*":n+"*",e&&e.push(t),"("+r+")"}).replace(/[\xa0 ]/g,"[\\s\\xa0]")}(n,o),a=new RegExp("^"+i+"$","i").exec(t);if(!a)return null;var s=[1970,0,1,0,0,0,0],u="";if(function(t,r,n){if(!e.isArray(t)||"function"!=typeof r)throw new TypeError;for(var o=Object(t),i=o.length>>>0,a=0;a<i;a++)if(a in o&&!r.call(n,o[a],a,o))return!1;return!0}(a,function(t,e){if(e){var n=o[e-1],i=n.length,a=n.charAt(0);if("y"===a)if(t<100){t=parseInt(t,10);var l=""+(new Date).getFullYear(),f=100*l.substring(0,2),d=c(l.substring(2,4)+20,99);s[0]=t<d?f+t:f-100+t}else s[0]=t;else if("M"===a){if(i>2){var v,y,x=h;3===i&&(x=p),t=t.replace(".","").toLowerCase();var C=!1;for(v=0,y=x.length;v<y&&!C;v++){x[v].replace(".","").toLocaleLowerCase()===t&&(t=v,C=!0)}if(!C)return!1}else t--;s[1]=t}else if("E"===a||"e"===a){var _=g;3===i&&(_=m),t=t.toLowerCase(),_=r.map(_,function(t){return t.toLowerCase()});var w=r.indexOf(_,t);if(-1===w){if(t=parseInt(t,10),isNaN(t)||t>_.length)return!1}else t=w}else if("D"===a||"d"===a)"D"===a&&(s[1]=0),s[2]=t;else if("a"===a){t=t.replace(/\./g,"").toLowerCase(),u="pm"===t?"p":"am"===t?"a":""}else"k"===a||"h"===a||"H"===a||"K"===a?("k"===a&&24==+t&&(t=0),s[3]=t):"m"===a?s[4]=t:"s"===a?s[5]=t:"S"===a&&(s[6]=t)}return!0})){var l=+s[3];"p"===u&&l<12?s[3]=l+12:"a"===u&&12===l&&(s[3]=0);var f=new Date(s[0],s[1],s[2],s[3],s[4],s[5],s[6]),d=-1!==r.indexOf(o,"d"),v=-1!==r.indexOf(o,"M"),y=s[1],x=s[2],C=f.getMonth(),_=f.getDate();return v&&C>y||d&&_>x?null:f}return null}},S=t.define(e.isDate,_).define(e.isString,M).define(e.isNumber,w);for(I in _)_.hasOwnProperty(I)&&(S[I]=_[I]);for(I in M)M.hasOwnProperty(I)&&(S[I]=M[I]);for(I in w)w.hasOwnProperty(I)&&(S[I]=w[I]);return S}void 0!==r?void 0!==e&&e.exports&&(e.exports=n(t("extended"),t("is-extended"),t("array-extended"))):"function"==typeof define&&define.amd?define(["extended","is-extended","array-extended"],function(t,e,r){return n(t,e,r)}):this.dateExtended=n(this.extended,this.isExtended,this.arrayExtended)}).call(this)},{"array-extended":52,extended:56,"is-extended":66}],54:[function(t,e,r){!function(){function t(){var t,e=Array.prototype.slice,r=0,n=new Function,o=/(super)/g;function i(t,r){return r=r||0,e.call(t,r)}function a(t){return"[object Array]"===Object.prototype.toString.call(t)}function s(t){return function(t){return null!==t&&void 0!==t&&"object"==typeof t}(t)&&t.constructor===Object}var u=function(t){return"[object Arguments]"===Object.prototype.toString.call(t)};function c(t,e){if(t&&t.length)for(var r=0,n=t.length;r<n;r++)if(t[r]===e)return r;return-1}function l(t,e,r){var n,o;for(n in e)e.hasOwnProperty(n)&&-1===c(r,n)&&(o=e[n],n in t&&t[n]===o||(t[n]=o));return t}function f(t,e){var r=this.__meta,n=r.supers,o=n.length,i=r.superMeta,s=i.pos;if(o>s){t=t?u(t)||a(t)?t:[t]:[];var c,l=i.name,f=i.f;do{if("function"==typeof(c=n[s][l])&&(c=c._f||c)!==f)return i.pos=1+s,c.apply(this,t)}while(o>++s)}return null}function d(){var t=this.__meta,e=t.supers,r=e.length,n=t.superMeta,o=n.pos;if(r>o){var i,a=n.name,s=n.f;do{if("function"==typeof(i=e[o][a])&&(i=i._f||i)!==s)return n.pos=1+o,i.bind(this)}while(r>++o)}return null}function h(t){var e=this.__getters__;return e.hasOwnProperty(t)?e[t].apply(this):this[t]}function p(t,e){var r=this.__setters__;if(!s(t))return r.hasOwnProperty(t)?r[t].apply(this,i(arguments,1)):this[t]=e;for(var n in t){var o=t[n];r.hasOwnProperty(n)?r[t].call(this,o):this[n]=o}}function g(){var t=this.__meta||{},e=t.supers,r=e.length,n=t.superMeta,o=n.pos;if(r>o){var i,a=n.name,s=n.f;do{if("function"==typeof(i=e[o][a])&&(i=i._f||i)!==s)return n.pos=1+o,i.apply(this,arguments)}while(r>++o)}return null}function m(t,e){if(t.toString().match(o)){var r=function(){var r,n=this.__meta||{},o=n.superMeta;switch(n.superMeta={f:t,pos:0,name:e},arguments.length){case 0:r=t.call(this);break;case 1:r=t.call(this,arguments[0]);break;case 2:r=t.call(this,arguments[0],arguments[1]);break;case 3:r=t.call(this,arguments[0],arguments[1],arguments[2]);break;default:r=t.apply(this,arguments)}return n.superMeta=o,r};return r._f=t,r}return t._f=t,t}function v(t,e){var r=e.setters||{},n=t.__setters__,o=t.__getters__;for(var i in r)n.hasOwnProperty(i)||(n[i]=r[i]);for(i in r=e.getters||{})o.hasOwnProperty(i)||(o[i]=r[i]);for(var a in e)if("getters"!==a&&"setters"!==a){var s=e[a];"function"==typeof s?t.hasOwnProperty(a)||(t[a]=m(g,a)):t[a]=s}}function y(){for(var t=i(arguments),e=t.length,r=this.prototype,n=r.__meta,o=this.__meta,a=r.__meta.bases,s=a.slice(),u=o.supers||[],c=n.supers||[],l=0;l<e;l++){var f=t[l],d=f.prototype,h=d.__meta,p=f.__meta;!h&&(h=d.__meta={proto:d||{}}),!p&&(p=f.__meta={proto:f.__proto__||{}}),v(r,h.proto||{}),v(this,p.proto||{}),x(f.prototype,c,a),x(f,u,s)}return this}function x(t,e,n){var o=t.__meta;!o&&(o=t.__meta={});var i=t.__meta.unique;if(!i&&(o.unique="declare"+ ++r),-1===c(n,i)){n.push(i);for(var a=t.__meta.supers||[],s=a.length-1||0;s>=0;)x(a[s--],e,n);e.unshift(t)}}function C(t,e){var r=e.setters,n=t.__setters__,o=t.__getters__;if(r)for(var i in r)n[i]=r[i];if(r=e.getters||{})for(i in r)o[i]=r[i];for(i in e)if("getters"!=i&&"setters"!=i){var a=e[i];if("function"==typeof a)(a.__meta||{}).isConstructor?t[i]=a:t[i]=m(a,i);else t[i]=a}}function _(e,o,i){var u={},c=[],h="declare"+ ++r,p=[],v=[],_=[],w=[],b={supers:_,unique:h,bases:p,superMeta:{f:null,pos:0,name:null}},E={supers:w,unique:h,bases:v,isConstructor:!0,superMeta:{f:null,pos:0,name:null}};if(s(o)&&!i&&(i=o,o=t),"function"==typeof o||a(o)?(o=(c=a(o)?o:[o]).shift(),e.__meta=E,(u=function(t){n.prototype=t.prototype;var e=new n;return n.prototype=null,e}(o)).__meta=b,u.__getters__=l({},u.__getters__||{}),u.__setters__=l({},u.__setters__||{}),e.__getters__=l({},e.__getters__||{}),e.__setters__=l({},e.__setters__||{}),x(o.prototype,_,p),x(o,w,v)):(e.__meta=E,u.__meta=b,u.__getters__=u.__getters__||{},u.__setters__=u.__setters__||{},e.__getters__=e.__getters__||{},e.__setters__=e.__setters__||{}),e.prototype=u,i){var I=b.proto=i.instance||{},O=E.proto=i.static||{};O.init=O.init||g,C(u,I),C(e,O),I.hasOwnProperty("constructor")?u.constructor=m(I.constructor,"constructor"):u.constructor=I.constructor=m(g,"constructor")}else b.proto={},E.proto={},e.init=m(g,"init"),u.constructor=m(g,"constructor");c.length&&y.apply(e,c),o&&l(e,l(l({},o),e)),u._super=e._super=f,u._getSuper=e._getSuper=d,u._static=e}function w(t,e){function r(){switch(arguments.length){case 0:this.constructor.call(this);break;case 1:this.constructor.call(this,arguments[0]);break;case 2:this.constructor.call(this,arguments[0],arguments[1]);break;case 3:this.constructor.call(this,arguments[0],arguments[1],arguments[2]);break;default:this.constructor.apply(this,arguments)}}return _(r,t,e),r.init()||r}return u(arguments)||(u=function(t){return!(!t||!t.hasOwnProperty("callee"))}),t=w({instance:{get:h,set:p},static:{get:h,set:p,mixin:y,extend:function(t){return w(this,t)},as:function(t,e){return t&&e?t[e]=this:t.exports=t=this,this}}}),w.singleton=function(t,e){var r;function n(){return r||(this.constructor.apply(this,arguments),r=this),r}return _(n,t,e),n.init()||n},w}void 0!==r?void 0!==e&&e.exports&&(e.exports=t()):"function"==typeof define&&define.amd?define(t):this.declare=t()}()},{}],55:[function(t,e,r){e.exports=t("./declare.js")},{"./declare.js":54}],56:[function(t,e,r){(function(){"use strict";function n(t){!function(){function t(t,e){var r,n;for(r in e)e.hasOwnProperty(r)&&(n=e[r],r in t&&t[r]===n||(t[r]=n));return t}}();function e(){return(e=t.define()).expose({register:function(t,r){r||(r=t,t=null);var n=typeof r;if(t)e[t]=r;else if(r&&"function"===n)e.extend(r);else{if("object"!==n)throw new TypeError("extended.register must be called with an extender function");e.expose(r)}return e},define:function(){return t.define.apply(t,arguments)}}),e;var e}return e.define=function(){return t.define.apply(t,arguments)},e}void 0!==r?void 0!==e&&e.exports&&(e.exports=n(t("extender"))):"function"==typeof define&&define.amd?define(["extender"],function(t){return n(t)}):this.extended=n(this.extender)}).call(this)},{extender:58}],57:[function(t,e,r){(function(){function n(t){var e,r=Array.prototype.slice;function n(t,e){if(t&&t.length)for(var r=0,n=t.length;r<n;r++)if(t[r]===e)return r;return-1}var o=function(){function t(t,e,r){var o,i;for(o in e)e.hasOwnProperty(o)&&-1===n(r,o)&&(i=e[o],o in t&&t[o]===i||(t[o]=i));return t}return function(e){e||(e={});var r=arguments.length,n=arguments[arguments.length-1];!function(t){return"[object Array]"===Object.prototype.toString.call(t)}(n)?n=[]:r--;for(var o=1;o<r;o++)t(e,arguments[o],n);return e}}();function i(n){n=n||[];var i=t({instance:{constructor:function(t){this._value=t},value:function(){return this._value},eq:function(t){return this.__extender__(this._value===t)},neq:function(t){return this.__extender__(this._value!==t)},print:function(){return console.log(this._value),this}}}),a=[];function s(t,n,o){if("function"!=typeof o)throw new TypeError("when extending type you must provide a function");var i;i="constructor"===n?function(){this._super(arguments),o.apply(this,arguments)}:function(){var t=r.call(arguments);t.unshift(this._value);var n=o.apply(this,t);return n!==e?this.__extender__(n):this},t[n]=i}function u(t,e,n){if("function"!=typeof n)throw new TypeError("when extending type you must provide a function");var o;o="constructor"===e?function(){this._super(arguments),n.apply(this,arguments)}:function(){var t=r.call(arguments);return t.unshift(this._value),n.apply(this,t)},t[e]=o}function c(t){var e,r,n=t;if(!(t instanceof i)){var o=i;for(e=0,r=a.length;e<r;e++){var s=a[e];s[0](t)&&(o=o.extend({instance:s[1]}))}(n=new o(t)).__extender__=c}return n}function l(){return!0}return c.define=function(t,e){if(arguments.length){"object"==typeof t&&(e=t,t=l);var r={};!function t(e,r,n){for(var o in r)r.hasOwnProperty(o)&&("getters"!==o&&"setters"!==o?"noWrap"===o?t(e,r[o],!0):n?u(e,o,r[o]):s(e,o,r[o]):e[o]=r[o])}(r,e=e||{}),r.hasOwnProperty("constructor")||(e.hasOwnProperty("constructor")?s(r,"constructor",e.constructor):r.constructor=function(){this._super(arguments)}),a.push([t,r])}return c},c.extend=function(t){return t&&t.hasOwnProperty("__defined__")&&(c.__defined__=a=a.concat(t.__defined__)),o(c,t,["define","extend","expose","__defined__"]),c},c.expose=function(){for(var t,e=0,r=arguments.length;e<r;e++)"object"==typeof(t=arguments[e])&&o(c,t,["define","extend","expose","__defined__"]);return c},c.__defined__=a,c}return{define:function(){return i().define.apply(i,arguments)},extend:function(t){return i().define().extend(t)}}}void 0!==r?void 0!==e&&e.exports&&(e.exports=n(t("declare.js"))):"function"==typeof define&&define.amd?define(["declare"],function(t){return n(t)}):this.extender=n(this.declare)}).call(this)},{"declare.js":55}],58:[function(t,e,r){e.exports=t("./extender.js")},{"./extender.js":57}],59:[function(t,e,r){(function(){"use strict";function n(t,e,r){var n=e.isArray,o=e.isObject,i=e.isString,a=e.isFunction,s=r.argsToArray;function u(t,e,r){var n;switch((e||[]).length){case 0:n=t.call(r);break;case 1:n=t.call(r,e[0]);break;case 2:n=t.call(r,e[0],e[1]);break;case 3:n=t.call(r,e[0],e[1],e[2]);break;default:n=t.apply(r,e)}return n}function c(t,e,r){if(r=s(arguments,2),i(e)&&!(e in t))throw new Error(e+" property not defined in scope");if(!i(e)&&!a(e))throw new Error(e+" is not a function");return i(e)?function(){var n=t[e];return a(n)?u(n,r.concat(s(arguments)),t):n}:r.length?function(){return u(e,r.concat(s(arguments)),t)}:function(){return u(e,arguments,t)}}function l(t,e){if(e=s(arguments,1),!i(t)&&!a(t))throw new Error(t+" must be the name of a property or function to execute");return i(t)?function(){var r=s(arguments),n=r.shift(),o=n[t];return a(o)?u(o,r=e.concat(r),n):o}:function(){var r=s(arguments),n=r.shift();return r=e.concat(r),u(t,r,n)}}function f(t,e,r){if(r=s(arguments,2),i(e)&&!(e in t))throw new Error(e+" property not defined in scope");if(!i(e)&&!a(e))throw new Error(e+" is not a function");return i(e)?function(){var n=t[e];return a(n)?u(n,r,t):n}:function(){return u(e,r,t)}}function d(t){var e=s(arguments,1);if(!o(t)&&!a(t))throw new TypeError("scope must be an object");if(1===e.length&&n(e[0])&&(e=e[0]),!e.length)for(var r in e=[],t)t.hasOwnProperty(r)&&a(t[r])&&e.push(r);for(var i=0,u=e.length;i<u;i++)t[e[i]]=c(t,t[e[i]]);return t}function h(t,e){if(e=s(arguments,1),!i(t)&&!a(t))throw new Error(t+" must be the name of a property or function to execute");return i(t)?function(){var r=this[t];return a(r)?u(r,e.concat(s(arguments)),this):r}:function(){var r=e.concat(s(arguments));return u(t,r,this)}}function p(t,e){return function(){var r=s(arguments);return e?u(t,arguments,this):function(){return u(t,r.concat(s(arguments)),this)}}}function g(t,e,r){var n;if(n=r?c(r,e):e,t)for(var o=t-1,i=o;i>=0;i--)n=p(n,i===o);return n}return t.define(o,{bind:c,bindAll:d,bindIgnore:f,curry:function(t,e,r){return g(e,r,t)}}).define(a,{bind:function(t,e){return u(c,[e,t].concat(s(arguments,2)),this)},bindIgnore:function(t,e){return u(f,[e,t].concat(s(arguments,2)),this)},partial:h,applyFirst:l,curry:function(t,e,r){return g(e,t,r)},noWrap:{f:function(){return this.value()}}}).define(i,{bind:function(t,e){return c(e,t)},bindIgnore:function(t,e){return f(e,t)},partial:h,applyFirst:l,curry:function(t,e,r){return g(e,t,r)}}).expose({bind:c,bindAll:d,bindIgnore:f,partial:h,applyFirst:l,curry:g})}void 0!==r?void 0!==e&&e.exports&&(e.exports=n(t("extended"),t("is-extended"),t("arguments-extended"))):"function"==typeof define&&define.amd?define(["extended","is-extended","arguments-extended"],function(t,e,r){return n(t,e,r)}):this.functionExtended=n(this.extended,this.isExtended,this.argumentsExtended)}).call(this)},{"arguments-extended":51,extended:56,"is-extended":66}],60:[function(t,e,r){var n=t("__browserify_process");n.EventEmitter||(n.EventEmitter=function(){});var o=r.EventEmitter=n.EventEmitter,i="function"==typeof Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)};o.prototype.setMaxListeners=function(t){this._events||(this._events={}),this._events.maxListeners=t},o.prototype.emit=function(t){if("error"===t&&(!this._events||!this._events.error||i(this._events.error)&&!this._events.error.length))throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");if(!this._events)return!1;var e=this._events[t];if(!e)return!1;if("function"==typeof e){switch(arguments.length){case 1:e.call(this);break;case 2:e.call(this,arguments[1]);break;case 3:e.call(this,arguments[1],arguments[2]);break;default:var r=Array.prototype.slice.call(arguments,1);e.apply(this,r)}return!0}if(i(e)){r=Array.prototype.slice.call(arguments,1);for(var n=e.slice(),o=0,a=n.length;o<a;o++)n[o].apply(this,r);return!0}return!1},o.prototype.addListener=function(t,e){if("function"!=typeof e)throw new Error("addListener only takes instances of Function");if(this._events||(this._events={}),this.emit("newListener",t,e),this._events[t])if(i(this._events[t])){var r;if(!this._events[t].warned)(r=void 0!==this._events.maxListeners?this._events.maxListeners:10)&&r>0&&this._events[t].length>r&&(this._events[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[t].length),console.trace());this._events[t].push(e)}else this._events[t]=[this._events[t],e];else this._events[t]=e;return this},o.prototype.on=o.prototype.addListener,o.prototype.once=function(t,e){var r=this;return r.on(t,function n(){r.removeListener(t,n),e.apply(this,arguments)}),this},o.prototype.removeListener=function(t,e){if("function"!=typeof e)throw new Error("removeListener only takes instances of Function");if(!this._events||!this._events[t])return this;var r=this._events[t];if(i(r)){var n=function(t,e){if(t.indexOf)return t.indexOf(e);for(var r=0;r<t.length;r++)if(e===t[r])return r;return-1}(r,e);if(n<0)return this;r.splice(n,1),0==r.length&&delete this._events[t]}else this._events[t]===e&&delete this._events[t];return this},o.prototype.removeAllListeners=function(t){return 0===arguments.length?(this._events={},this):(t&&this._events&&this._events[t]&&(this._events[t]=null),this)},o.prototype.listeners=function(t){return this._events||(this._events={}),this._events[t]||(this._events[t]=[]),i(this._events[t])||(this._events[t]=[this._events[t]]),this._events[t]},o.listenerCount=function(t,e){return t._events&&t._events[e]?"function"==typeof t._events[e]?1:t._events[e].length:0}},{__browserify_process:64}],61:[function(t,e,r){},{}],62:[function(t,e,r){var n=t("__browserify_process");function o(t,e){for(var r=[],n=0;n<t.length;n++)e(t[n],n,t)&&r.push(t[n]);return r}function i(t,e){for(var r=0,n=t.length;n>=0;n--){var o=t[n];"."==o?t.splice(n,1):".."===o?(t.splice(n,1),r++):r&&(t.splice(n,1),r--)}if(e)for(;r--;r)t.unshift("..");return t}var a=/^(.+\/(?!$)|\/)?((?:.+?)?(\.[^.]*)?)$/;r.resolve=function(){for(var t="",e=!1,r=arguments.length;r>=-1&&!e;r--){var a=r>=0?arguments[r]:n.cwd();"string"==typeof a&&a&&(t=a+"/"+t,e="/"===a.charAt(0))}return t=i(o(t.split("/"),function(t){return!!t}),!e).join("/"),(e?"/":"")+t||"."},r.normalize=function(t){var e="/"===t.charAt(0),r="/"===t.slice(-1);return(t=i(o(t.split("/"),function(t){return!!t}),!e).join("/"))||e||(t="."),t&&r&&(t+="/"),(e?"/":"")+t},r.join=function(){var t=Array.prototype.slice.call(arguments,0);return r.normalize(o(t,function(t,e){return t&&"string"==typeof t}).join("/"))},r.dirname=function(t){var e=a.exec(t)[1]||"";return e?1===e.length?e:e.substring(0,e.length-1):"."},r.basename=function(t,e){var r=a.exec(t)[2]||"";return e&&r.substr(-1*e.length)===e&&(r=r.substr(0,r.length-e.length)),r},r.extname=function(t){return a.exec(t)[3]||""},r.relative=function(t,e){function n(t){for(var e=0;e<t.length&&""===t[e];e++);for(var r=t.length-1;r>=0&&""===t[r];r--);return e>r?[]:t.slice(e,r-e+1)}t=r.resolve(t).substr(1),e=r.resolve(e).substr(1);for(var o=n(t.split("/")),i=n(e.split("/")),a=Math.min(o.length,i.length),s=a,u=0;u<a;u++)if(o[u]!==i[u]){s=u;break}var c=[];for(u=s;u<o.length;u++)c.push("..");return(c=c.concat(i.slice(s))).join("/")},r.sep="/"},{__browserify_process:64}],63:[function(t,e,r){t=function(t,e,r,n){function o(n){if(!r[n]){if(!e[n]){if(t)return t(n);throw new Error("Cannot find module '"+n+"'")}var i=r[n]={exports:{}};e[n][0](function(t){var r=e[n][1][t];return o(r||t)},i,i.exports)}return r[n].exports}for(var i=0;i<n.length;i++)o(n[i]);return o}(void 0!==t&&t,{1:[function(t,e,r){var n=t("util"),o=t("buffer").Buffer,i=Array.prototype.slice;function a(t){if(Object.keys)return Object.keys(t);var e=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.push(r);return e}var s=e.exports=f;function u(t,e){return void 0===e?""+e:"number"!=typeof e||!isNaN(e)&&isFinite(e)?"function"==typeof e||e instanceof RegExp?e.toString():e:e.toString()}function c(t,e){return"string"==typeof t?t.length<e?t:t.slice(0,e):t}function l(t,e,r,n,o){throw new s.AssertionError({message:r,actual:t,expected:e,operator:n,stackStartFunction:o})}function f(t,e){t||l(t,!0,e,"==",s.ok)}function d(t,e){if(t===e)return!0;if(o.isBuffer(t)&&o.isBuffer(e)){if(t.length!=e.length)return!1;for(var r=0;r<t.length;r++)if(t[r]!==e[r])return!1;return!0}return t instanceof Date&&e instanceof Date?t.getTime()===e.getTime():"object"!=typeof t&&"object"!=typeof e?t==e:function(t,e){if(h(t)||h(e))return!1;if(t.prototype!==e.prototype)return!1;if(p(t))return!!p(e)&&(t=i.call(t),e=i.call(e),d(t,e));try{var r,n,o=a(t),s=a(e)}catch(t){return!1}if(o.length!=s.length)return!1;for(o.sort(),s.sort(),n=o.length-1;n>=0;n--)if(o[n]!=s[n])return!1;for(n=o.length-1;n>=0;n--)if(r=o[n],!d(t[r],e[r]))return!1;return!0}(t,e)}function h(t){return null===t||void 0===t}function p(t){return"[object Arguments]"==Object.prototype.toString.call(t)}function g(t,e){return!(!t||!e)&&(e instanceof RegExp?e.test(t):t instanceof e||!0===e.call({},t))}function m(t,e,r,n){var o;"string"==typeof r&&(n=r,r=null);try{e()}catch(t){o=t}if(n=(r&&r.name?" ("+r.name+").":".")+(n?" "+n:"."),t&&!o&&l("Missing expected exception"+n),!t&&g(o,r)&&l("Got unwanted exception"+n),t&&o&&r&&!g(o,r)||!t&&o)throw o}s.AssertionError=function(t){this.name="AssertionError",this.message=t.message,this.actual=t.actual,this.expected=t.expected,this.operator=t.operator;var e=t.stackStartFunction||l;Error.captureStackTrace&&Error.captureStackTrace(this,e)},n.inherits(s.AssertionError,Error),s.AssertionError.prototype.toString=function(){return this.message?[this.name+":",this.message].join(" "):[this.name+":",c(JSON.stringify(this.actual,u),128),this.operator,c(JSON.stringify(this.expected,u),128)].join(" ")},s.AssertionError.__proto__=Error.prototype,s.fail=l,s.ok=f,s.equal=function(t,e,r){t!=e&&l(t,e,r,"==",s.equal)},s.notEqual=function(t,e,r){t==e&&l(t,e,r,"!=",s.notEqual)},s.deepEqual=function(t,e,r){d(t,e)||l(t,e,r,"deepEqual",s.deepEqual)},s.notDeepEqual=function(t,e,r){d(t,e)&&l(t,e,r,"notDeepEqual",s.notDeepEqual)},s.strictEqual=function(t,e,r){t!==e&&l(t,e,r,"===",s.strictEqual)},s.notStrictEqual=function(t,e,r){t===e&&l(t,e,r,"!==",s.notStrictEqual)},s.throws=function(t,e,r){m.apply(this,[!0].concat(i.call(arguments)))},s.doesNotThrow=function(t,e,r){m.apply(this,[!1].concat(i.call(arguments)))},s.ifError=function(t){if(t)throw t}},{util:2,buffer:3}],2:[function(t,e,r){t("events");function n(t){return t instanceof Array||Array.isArray(t)||t&&t!==Object.prototype&&n(t.__proto__)}function o(t){return t instanceof RegExp||"object"==typeof t&&"[object RegExp]"===Object.prototype.toString.call(t)}function i(t){if(t instanceof Date)return!0;if("object"!=typeof t)return!1;var e=Date.prototype&&s(Date.prototype),r=t.__proto__&&s(t.__proto__);return JSON.stringify(r)===JSON.stringify(e)}r.isArray=n,r.isDate=function(t){return"[object Date]"===Object.prototype.toString.call(t)},r.isRegExp=function(t){return"[object RegExp]"===Object.prototype.toString.call(t)},r.print=function(){},r.puts=function(){},r.debug=function(){},r.inspect=function(t,e,u,c){var l=[],f=function(t,e){var r={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},n={special:"cyan",number:"blue",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"}[e];return n?"\\033["+r[n][0]+"m"+t+"\\033["+r[n][1]+"m":t};return c||(f=function(t,e){return t}),function t(u,c){if(u&&"function"==typeof u.inspect&&u!==r&&(!u.constructor||u.constructor.prototype!==u))return u.inspect(c);switch(typeof u){case"undefined":return f("undefined","undefined");case"string":var d="'"+JSON.stringify(u).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return f(d,"string");case"number":return f(""+u,"number");case"boolean":return f(""+u,"boolean")}if(null===u)return f("null","null");var h,p,g,m=a(u),v=e?s(u):m;if("function"==typeof u&&0===v.length){if(o(u))return f(""+u,"regexp");var y=u.name?": "+u.name:"";return f("[Function"+y+"]","special")}if(i(u)&&0===v.length)return f(u.toUTCString(),"date");if(n(u)?(p="Array",g=["[","]"]):(p="Object",g=["{","}"]),"function"==typeof u){var x=u.name?": "+u.name:"";h=o(u)?" "+u:" [Function"+x+"]"}else h="";if(i(u)&&(h=" "+u.toUTCString()),0===v.length)return g[0]+h+g[1];if(c<0)return o(u)?f(""+u,"regexp"):f("[Object]","special");l.push(u);var C=v.map(function(e){var r,o;if(u.__lookupGetter__&&(u.__lookupGetter__(e)?o=u.__lookupSetter__(e)?f("[Getter/Setter]","special"):f("[Getter]","special"):u.__lookupSetter__(e)&&(o=f("[Setter]","special"))),m.indexOf(e)<0&&(r="["+e+"]"),o||(l.indexOf(u[e])<0?(o=null===c?t(u[e]):t(u[e],c-1)).indexOf("\n")>-1&&(o=n(u)?o.split("\n").map(function(t){return"  "+t}).join("\n").substr(2):"\n"+o.split("\n").map(function(t){return"   "+t}).join("\n")):o=f("[Circular]","special")),void 0===r){if("Array"===p&&e.match(/^\d+$/))return o;(r=JSON.stringify(""+e)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(r=r.substr(1,r.length-2),r=f(r,"name")):(r=r.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),r=f(r,"string"))}return r+": "+o});l.pop();return C=C.reduce(function(t,e){return e.indexOf("\n"),t+e.length+1},0)>50?g[0]+(""===h?"":h+"\n ")+" "+C.join(",\n  ")+" "+g[1]:g[0]+h+" "+C.join(", ")+" "+g[1]}(t,void 0===u?2:u)};r.log=function(t){},r.pump=null;var a=Object.keys||function(t){var e=[];for(var r in t)e.push(r);return e},s=Object.getOwnPropertyNames||function(t){var e=[];for(var r in t)Object.hasOwnProperty.call(t,r)&&e.push(r);return e},u=Object.create||function(t,e){var r;if(null===t)r={__proto__:null};else{if("object"!=typeof t)throw new TypeError("typeof prototype["+typeof t+"] != 'object'");var n=function(){};n.prototype=t,(r=new n).__proto__=t}return void 0!==e&&Object.defineProperties&&Object.defineProperties(r,e),r};r.inherits=function(t,e){t.super_=e,t.prototype=u(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})};var c=/%[sdj%]/g;r.format=function(t){if("string"!=typeof t){for(var e=[],n=0;n<arguments.length;n++)e.push(r.inspect(arguments[n]));return e.join(" ")}n=1;for(var o=arguments,i=o.length,a=String(t).replace(c,function(t){if("%%"===t)return"%";if(n>=i)return t;switch(t){case"%s":return String(o[n++]);case"%d":return Number(o[n++]);case"%j":return JSON.stringify(o[n++]);default:return t}}),s=o[n];n<i;s=o[++n])a+=null===s||"object"!=typeof s?" "+s:" "+r.inspect(s);return a}},{events:4}],5:[function(t,e,r){r.readIEEE754=function(t,e,r,n,o){var i,a,s=8*o-n-1,u=(1<<s)-1,c=u>>1,l=-7,f=r?0:o-1,d=r?1:-1,h=t[e+f];for(f+=d,i=h&(1<<-l)-1,h>>=-l,l+=s;l>0;i=256*i+t[e+f],f+=d,l-=8);for(a=i&(1<<-l)-1,i>>=-l,l+=n;l>0;a=256*a+t[e+f],f+=d,l-=8);if(0===i)i=1-c;else{if(i===u)return a?NaN:1/0*(h?-1:1);a+=Math.pow(2,n),i-=c}return(h?-1:1)*a*Math.pow(2,i-n)},r.writeIEEE754=function(t,e,r,n,o,i){var a,s,u,c=8*i-o-1,l=(1<<c)-1,f=l>>1,d=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,h=n?i-1:0,p=n?-1:1,g=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(s=isNaN(e)?1:0,a=l):(a=Math.floor(Math.log(e)/Math.LN2),e*(u=Math.pow(2,-a))<1&&(a--,u*=2),(e+=a+f>=1?d/u:d*Math.pow(2,1-f))*u>=2&&(a++,u/=2),a+f>=l?(s=0,a=l):a+f>=1?(s=(e*u-1)*Math.pow(2,o),a+=f):(s=e*Math.pow(2,f-1)*Math.pow(2,o),a=0));o>=8;t[r+h]=255&s,h+=p,s/=256,o-=8);for(a=a<<o|s,c+=o;c>0;t[r+h]=255&a,h+=p,a/=256,c-=8);t[r+h-p]|=128*g}},{}],6:[function(t,e,r){var n=e.exports={};n.nextTick=function(){var t="undefined"!=typeof window&&window.setImmediate,e="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(t)return function(t){return window.setImmediate(t)};if(e){var r=[];return window.addEventListener("message",function(t){t.source===window&&"process-tick"===t.data&&(t.stopPropagation(),r.length>0&&r.shift()())},!0),function(t){r.push(t),window.postMessage("process-tick","*")}}return function(t){setTimeout(t,0)}}(),n.title="browser",n.browser=!0,n.env={},n.argv=[],n.binding=function(t){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(t){throw new Error("process.chdir is not supported")}},{}],4:[function(t,e,r){!function(t){t.EventEmitter||(t.EventEmitter=function(){});var e=r.EventEmitter=t.EventEmitter,n="function"==typeof Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)};e.prototype.setMaxListeners=function(t){this._events||(this._events={}),this._events.maxListeners=t},e.prototype.emit=function(t){if("error"===t&&(!this._events||!this._events.error||n(this._events.error)&&!this._events.error.length))throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");if(!this._events)return!1;var e=this._events[t];if(!e)return!1;if("function"==typeof e){switch(arguments.length){case 1:e.call(this);break;case 2:e.call(this,arguments[1]);break;case 3:e.call(this,arguments[1],arguments[2]);break;default:var r=Array.prototype.slice.call(arguments,1);e.apply(this,r)}return!0}if(n(e)){r=Array.prototype.slice.call(arguments,1);for(var o=e.slice(),i=0,a=o.length;i<a;i++)o[i].apply(this,r);return!0}return!1},e.prototype.addListener=function(t,e){if("function"!=typeof e)throw new Error("addListener only takes instances of Function");if(this._events||(this._events={}),this.emit("newListener",t,e),this._events[t])if(n(this._events[t])){var r;if(!this._events[t].warned)(r=void 0!==this._events.maxListeners?this._events.maxListeners:10)&&r>0&&this._events[t].length>r&&(this._events[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[t].length),console.trace());this._events[t].push(e)}else this._events[t]=[this._events[t],e];else this._events[t]=e;return this},e.prototype.on=e.prototype.addListener,e.prototype.once=function(t,e){var r=this;return r.on(t,function n(){r.removeListener(t,n),e.apply(this,arguments)}),this},e.prototype.removeListener=function(t,e){if("function"!=typeof e)throw new Error("removeListener only takes instances of Function");if(!this._events||!this._events[t])return this;var r=this._events[t];if(n(r)){var o=function(t,e){if(t.indexOf)return t.indexOf(e);for(var r=0;r<t.length;r++)if(e===t[r])return r;return-1}(r,e);if(o<0)return this;r.splice(o,1),0==r.length&&delete this._events[t]}else this._events[t]===e&&delete this._events[t];return this},e.prototype.removeAllListeners=function(t){return 0===arguments.length?(this._events={},this):(t&&this._events&&this._events[t]&&(this._events[t]=null),this)},e.prototype.listeners=function(t){return this._events||(this._events={}),this._events[t]||(this._events[t]=[]),n(this._events[t])||(this._events[t]=[this._events[t]]),this._events[t]}}(t("__browserify_process"))},{__browserify_process:6}],"buffer-browserify":[function(t,e,r){e.exports=t("q9TxCC")},{}],q9TxCC:[function(t,e,r){function n(t){this.length=t}var o,i=t("assert");function a(t){return t<16?"0"+t.toString(16):t.toString(16)}function s(t){for(var e=[],r=0;r<t.length;r++)if(t.charCodeAt(r)<=127)e.push(t.charCodeAt(r));else for(var n=encodeURIComponent(t.charAt(r)).substr(1).split("%"),o=0;o<n.length;o++)e.push(parseInt(n[o],16));return e}function u(e){return t("base64-js").toByteArray(e)}function c(t,e,r,n){for(var o=0;o<n&&!(o+r>=e.length||o>=t.length);)e[o+r]=t[o],o++;return o}function l(t){try{return decodeURIComponent(t)}catch(t){return String.fromCharCode(65533)}}function f(t){return(t=~~Math.ceil(+t))<0?0:t}function d(t,e,r){if(!(this instanceof d))return new d(t,e,r);var i;if("number"==typeof r)this.length=f(e),this.parent=t,this.offset=r;else{switch(i=typeof t){case"number":this.length=f(t);break;case"string":this.length=d.byteLength(t,e);break;case"object":this.length=f(t.length);break;default:throw new Error("First argument needs to be a number, array or string.")}if(this.length>d.poolSize?(this.parent=new n(this.length),this.offset=0):((!o||o.length-o.used<this.length)&&((o=new n(d.poolSize)).used=0),this.parent=o,this.offset=o.used,o.used+=this.length),function(t){return Array.isArray(t)||d.isBuffer(t)||t&&"object"==typeof t&&"number"==typeof t.length}(t))for(var a=0;a<this.length;a++)this.parent[a+this.offset]=t instanceof d?t.readUInt8(a):t[a];else"string"==i&&(this.length=this.write(t,0,e))}}function h(t,e,r,n){var o=0;return n||(i.ok("boolean"==typeof r,"missing or invalid endian"),i.ok(void 0!==e&&null!==e,"missing offset"),i.ok(e+1<t.length,"Trying to read beyond buffer length")),e>=t.length?0:(r?(o=t.parent[t.offset+e]<<8,e+1<t.length&&(o|=t.parent[t.offset+e+1])):(o=t.parent[t.offset+e],e+1<t.length&&(o|=t.parent[t.offset+e+1]<<8)),o)}function p(t,e,r,n){var o=0;return n||(i.ok("boolean"==typeof r,"missing or invalid endian"),i.ok(void 0!==e&&null!==e,"missing offset"),i.ok(e+3<t.length,"Trying to read beyond buffer length")),e>=t.length?0:(r?(e+1<t.length&&(o=t.parent[t.offset+e+1]<<16),e+2<t.length&&(o|=t.parent[t.offset+e+2]<<8),e+3<t.length&&(o|=t.parent[t.offset+e+3]),o+=t.parent[t.offset+e]<<24>>>0):(e+2<t.length&&(o=t.parent[t.offset+e+2]<<16),e+1<t.length&&(o|=t.parent[t.offset+e+1]<<8),o|=t.parent[t.offset+e],e+3<t.length&&(o+=t.parent[t.offset+e+3]<<24>>>0)),o)}function g(t,e,r,n){var o;return n||(i.ok("boolean"==typeof r,"missing or invalid endian"),i.ok(void 0!==e&&null!==e,"missing offset"),i.ok(e+1<t.length,"Trying to read beyond buffer length")),32768&(o=h(t,e,r,n))?-1*(65535-o+1):o}function m(t,e,r,n){var o;return n||(i.ok("boolean"==typeof r,"missing or invalid endian"),i.ok(void 0!==e&&null!==e,"missing offset"),i.ok(e+3<t.length,"Trying to read beyond buffer length")),2147483648&(o=p(t,e,r,n))?-1*(4294967295-o+1):o}function v(e,r,n,o){return o||(i.ok("boolean"==typeof n,"missing or invalid endian"),i.ok(r+3<e.length,"Trying to read beyond buffer length")),t("./buffer_ieee754").readIEEE754(e,r,n,23,4)}function y(e,r,n,o){return o||(i.ok("boolean"==typeof n,"missing or invalid endian"),i.ok(r+7<e.length,"Trying to read beyond buffer length")),t("./buffer_ieee754").readIEEE754(e,r,n,52,8)}function x(t,e){i.ok("number"==typeof t,"cannot write a non-number as a number"),i.ok(t>=0,"specified a negative value for writing an unsigned value"),i.ok(t<=e,"value is larger than maximum value for type"),i.ok(Math.floor(t)===t,"value has a fractional component")}function C(t,e,r,n,o){o||(i.ok(void 0!==e&&null!==e,"missing value"),i.ok("boolean"==typeof n,"missing or invalid endian"),i.ok(void 0!==r&&null!==r,"missing offset"),i.ok(r+1<t.length,"trying to write beyond buffer length"),x(e,65535));for(var a=0;a<Math.min(t.length-r,2);a++)t.parent[t.offset+r+a]=(e&255<<8*(n?1-a:a))>>>8*(n?1-a:a)}function _(t,e,r,n,o){o||(i.ok(void 0!==e&&null!==e,"missing value"),i.ok("boolean"==typeof n,"missing or invalid endian"),i.ok(void 0!==r&&null!==r,"missing offset"),i.ok(r+3<t.length,"trying to write beyond buffer length"),x(e,4294967295));for(var a=0;a<Math.min(t.length-r,4);a++)t.parent[t.offset+r+a]=e>>>8*(n?3-a:a)&255}function w(t,e,r){i.ok("number"==typeof t,"cannot write a non-number as a number"),i.ok(t<=e,"value larger than maximum allowed value"),i.ok(t>=r,"value smaller than minimum allowed value"),i.ok(Math.floor(t)===t,"value has a fractional component")}function b(t,e,r){i.ok("number"==typeof t,"cannot write a non-number as a number"),i.ok(t<=e,"value larger than maximum allowed value"),i.ok(t>=r,"value smaller than minimum allowed value")}function E(t,e,r,n,o){o||(i.ok(void 0!==e&&null!==e,"missing value"),i.ok("boolean"==typeof n,"missing or invalid endian"),i.ok(void 0!==r&&null!==r,"missing offset"),i.ok(r+1<t.length,"Trying to write beyond buffer length"),w(e,32767,-32768)),C(t,e>=0?e:65535+e+1,r,n,o)}function I(t,e,r,n,o){o||(i.ok(void 0!==e&&null!==e,"missing value"),i.ok("boolean"==typeof n,"missing or invalid endian"),i.ok(void 0!==r&&null!==r,"missing offset"),i.ok(r+3<t.length,"Trying to write beyond buffer length"),w(e,2147483647,-2147483648)),_(t,e>=0?e:4294967295+e+1,r,n,o)}function O(e,r,n,o,a){a||(i.ok(void 0!==r&&null!==r,"missing value"),i.ok("boolean"==typeof o,"missing or invalid endian"),i.ok(void 0!==n&&null!==n,"missing offset"),i.ok(n+3<e.length,"Trying to write beyond buffer length"),b(r,3.4028234663852886e38,-3.4028234663852886e38)),t("./buffer_ieee754").writeIEEE754(e,r,n,o,23,4)}function M(e,r,n,o,a){a||(i.ok(void 0!==r&&null!==r,"missing value"),i.ok("boolean"==typeof o,"missing or invalid endian"),i.ok(void 0!==n&&null!==n,"missing offset"),i.ok(n+7<e.length,"Trying to write beyond buffer length"),b(r,1.7976931348623157e308,-1.7976931348623157e308)),t("./buffer_ieee754").writeIEEE754(e,r,n,o,52,8)}r.INSPECT_MAX_BYTES=50,n.byteLength=function(t,e){switch(e||"utf8"){case"hex":return t.length/2;case"utf8":case"utf-8":return s(t).length;case"ascii":case"binary":return t.length;case"base64":return u(t).length;default:throw new Error("Unknown encoding")}},n.prototype.utf8Write=function(t,e,r){return n._charsWritten=c(s(t),this,e,r)},n.prototype.asciiWrite=function(t,e,r){return n._charsWritten=c(function(t){for(var e=[],r=0;r<t.length;r++)e.push(255&t.charCodeAt(r));return e}(t),this,e,r)},n.prototype.binaryWrite=n.prototype.asciiWrite,n.prototype.base64Write=function(t,e,r){return n._charsWritten=c(u(t),this,e,r)},n.prototype.base64Slice=function(e,r){var n=Array.prototype.slice.apply(this,arguments);return t("base64-js").fromByteArray(n)},n.prototype.utf8Slice=function(){for(var t=Array.prototype.slice.apply(this,arguments),e="",r="",n=0;n<t.length;)t[n]<=127?(e+=l(r)+String.fromCharCode(t[n]),r=""):r+="%"+t[n].toString(16),n++;return e+l(r)},n.prototype.asciiSlice=function(){for(var t=Array.prototype.slice.apply(this,arguments),e="",r=0;r<t.length;r++)e+=String.fromCharCode(t[r]);return e},n.prototype.binarySlice=n.prototype.asciiSlice,n.prototype.inspect=function(){for(var t=[],e=this.length,n=0;n<e;n++)if(t[n]=a(this[n]),n==r.INSPECT_MAX_BYTES){t[n+1]="...";break}return"<SlowBuffer "+t.join(" ")+">"},n.prototype.hexSlice=function(t,e){var r=this.length;(!t||t<0)&&(t=0),(!e||e<0||e>r)&&(e=r);for(var n="",o=t;o<e;o++)n+=a(this[o]);return n},n.prototype.toString=function(t,e,r){if(t=String(t||"utf8").toLowerCase(),e=+e||0,void 0===r&&(r=this.length),+r==e)return"";switch(t){case"hex":return this.hexSlice(e,r);case"utf8":case"utf-8":return this.utf8Slice(e,r);case"ascii":return this.asciiSlice(e,r);case"binary":return this.binarySlice(e,r);case"base64":return this.base64Slice(e,r);case"ucs2":case"ucs-2":return this.ucs2Slice(e,r);default:throw new Error("Unknown encoding")}},n.prototype.hexWrite=function(t,e,r){e=+e||0;var o=this.length-e;r?(r=+r)>o&&(r=o):r=o;var i=t.length;if(i%2)throw new Error("Invalid hex string");r>i/2&&(r=i/2);for(var a=0;a<r;a++){var s=parseInt(t.substr(2*a,2),16);if(isNaN(s))throw new Error("Invalid hex string");this[e+a]=s}return n._charsWritten=2*a,a},n.prototype.write=function(t,e,r,n){if(isFinite(e))isFinite(r)||(n=r,r=void 0);else{var o=n;n=e,e=r,r=o}e=+e||0;var i=this.length-e;switch(r?(r=+r)>i&&(r=i):r=i,n=String(n||"utf8").toLowerCase()){case"hex":return this.hexWrite(t,e,r);case"utf8":case"utf-8":return this.utf8Write(t,e,r);case"ascii":return this.asciiWrite(t,e,r);case"binary":return this.binaryWrite(t,e,r);case"base64":return this.base64Write(t,e,r);case"ucs2":case"ucs-2":return this.ucs2Write(t,e,r);default:throw new Error("Unknown encoding")}},n.prototype.slice=function(t,e){if(void 0===e&&(e=this.length),e>this.length)throw new Error("oob");if(t>e)throw new Error("oob");return new d(this,e-t,+t)},n.prototype.copy=function(t,e,r,n){for(var o=[],a=r;a<n;a++)i.ok(void 0!==this[a],"copying undefined buffer bytes!"),o.push(this[a]);for(a=e;a<e+o.length;a++)t[a]=o[a-e]},n.prototype.fill=function(t,e,r){if(r>this.length)throw new Error("oob");if(e>r)throw new Error("oob");for(var n=e;n<r;n++)this[n]=t},r.SlowBuffer=n,r.Buffer=d,d.poolSize=8192,d.isBuffer=function(t){return t instanceof d||t instanceof n},d.concat=function(t,e){if(!Array.isArray(t))throw new Error("Usage: Buffer.concat(list, [totalLength])\n       list should be an Array.");if(0===t.length)return new d(0);if(1===t.length)return t[0];if("number"!=typeof e){e=0;for(var r=0;r<t.length;r++){e+=(i=t[r]).length}}var n=new d(e),o=0;for(r=0;r<t.length;r++){var i;(i=t[r]).copy(n,o),o+=i.length}return n},d.prototype.inspect=function(){for(var t=[],e=this.length,n=0;n<e;n++)if(t[n]=a(this.parent[n+this.offset]),n==r.INSPECT_MAX_BYTES){t[n+1]="...";break}return"<Buffer "+t.join(" ")+">"},d.prototype.get=function(t){if(t<0||t>=this.length)throw new Error("oob");return this.parent[this.offset+t]},d.prototype.set=function(t,e){if(t<0||t>=this.length)throw new Error("oob");return this.parent[this.offset+t]=e},d.prototype.write=function(t,e,r,o){if(isFinite(e))isFinite(r)||(o=r,r=void 0);else{var i=o;o=e,e=r,r=i}e=+e||0;var a,s=this.length-e;switch(r?(r=+r)>s&&(r=s):r=s,o=String(o||"utf8").toLowerCase()){case"hex":a=this.parent.hexWrite(t,this.offset+e,r);break;case"utf8":case"utf-8":a=this.parent.utf8Write(t,this.offset+e,r);break;case"ascii":a=this.parent.asciiWrite(t,this.offset+e,r);break;case"binary":a=this.parent.binaryWrite(t,this.offset+e,r);break;case"base64":a=this.parent.base64Write(t,this.offset+e,r);break;case"ucs2":case"ucs-2":a=this.parent.ucs2Write(t,this.offset+e,r);break;default:throw new Error("Unknown encoding")}return d._charsWritten=n._charsWritten,a},d.prototype.toString=function(t,e,r){switch(t=String(t||"utf8").toLowerCase(),void 0===e||e<0?e=0:e>this.length&&(e=this.length),void 0===r||r>this.length?r=this.length:r<0&&(r=0),e+=this.offset,r+=this.offset,t){case"hex":return this.parent.hexSlice(e,r);case"utf8":case"utf-8":return this.parent.utf8Slice(e,r);case"ascii":return this.parent.asciiSlice(e,r);case"binary":return this.parent.binarySlice(e,r);case"base64":return this.parent.base64Slice(e,r);case"ucs2":case"ucs-2":return this.parent.ucs2Slice(e,r);default:throw new Error("Unknown encoding")}},d.byteLength=n.byteLength,d.prototype.fill=function(t,e,r){if(t||(t=0),e||(e=0),r||(r=this.length),"string"==typeof t&&(t=t.charCodeAt(0)),"number"!=typeof t||isNaN(t))throw new Error("value is not a number");if(r<e)throw new Error("end < start");if(r===e)return 0;if(0==this.length)return 0;if(e<0||e>=this.length)throw new Error("start out of bounds");if(r<0||r>this.length)throw new Error("end out of bounds");return this.parent.fill(t,e+this.offset,r+this.offset)},d.prototype.copy=function(t,e,r,n){if(r||(r=0),n||(n=this.length),e||(e=0),n<r)throw new Error("sourceEnd < sourceStart");if(n===r)return 0;if(0==t.length||0==this.length)return 0;if(e<0||e>=t.length)throw new Error("targetStart out of bounds");if(r<0||r>=this.length)throw new Error("sourceStart out of bounds");if(n<0||n>this.length)throw new Error("sourceEnd out of bounds");return n>this.length&&(n=this.length),t.length-e<n-r&&(n=t.length-e+r),this.parent.copy(t.parent,e+t.offset,r+this.offset,n+this.offset)},d.prototype.slice=function(t,e){if(void 0===e&&(e=this.length),e>this.length)throw new Error("oob");if(t>e)throw new Error("oob");return new d(this.parent,e-t,+t+this.offset)},d.prototype.utf8Slice=function(t,e){return this.toString("utf8",t,e)},d.prototype.binarySlice=function(t,e){return this.toString("binary",t,e)},d.prototype.asciiSlice=function(t,e){return this.toString("ascii",t,e)},d.prototype.utf8Write=function(t,e){return this.write(t,e,"utf8")},d.prototype.binaryWrite=function(t,e){return this.write(t,e,"binary")},d.prototype.asciiWrite=function(t,e){return this.write(t,e,"ascii")},d.prototype.readUInt8=function(t,e){if(e||(i.ok(void 0!==t&&null!==t,"missing offset"),i.ok(t<this.length,"Trying to read beyond buffer length")),!(t>=this.length))return this.parent[this.offset+t]},d.prototype.readUInt16LE=function(t,e){return h(this,t,!1,e)},d.prototype.readUInt16BE=function(t,e){return h(this,t,!0,e)},d.prototype.readUInt32LE=function(t,e){return p(this,t,!1,e)},d.prototype.readUInt32BE=function(t,e){return p(this,t,!0,e)},d.prototype.readInt8=function(t,e){if(e||(i.ok(void 0!==t&&null!==t,"missing offset"),i.ok(t<this.length,"Trying to read beyond buffer length")),!(t>=this.length))return 128&this.parent[this.offset+t]?-1*(255-this.parent[this.offset+t]+1):this.parent[this.offset+t]},d.prototype.readInt16LE=function(t,e){return g(this,t,!1,e)},d.prototype.readInt16BE=function(t,e){return g(this,t,!0,e)},d.prototype.readInt32LE=function(t,e){return m(this,t,!1,e)},d.prototype.readInt32BE=function(t,e){return m(this,t,!0,e)},d.prototype.readFloatLE=function(t,e){return v(this,t,!1,e)},d.prototype.readFloatBE=function(t,e){return v(this,t,!0,e)},d.prototype.readDoubleLE=function(t,e){return y(this,t,!1,e)},d.prototype.readDoubleBE=function(t,e){return y(this,t,!0,e)},d.prototype.writeUInt8=function(t,e,r){r||(i.ok(void 0!==t&&null!==t,"missing value"),i.ok(void 0!==e&&null!==e,"missing offset"),i.ok(e<this.length,"trying to write beyond buffer length"),x(t,255)),e<this.length&&(this.parent[this.offset+e]=t)},d.prototype.writeUInt16LE=function(t,e,r){C(this,t,e,!1,r)},d.prototype.writeUInt16BE=function(t,e,r){C(this,t,e,!0,r)},d.prototype.writeUInt32LE=function(t,e,r){_(this,t,e,!1,r)},d.prototype.writeUInt32BE=function(t,e,r){_(this,t,e,!0,r)},d.prototype.writeInt8=function(t,e,r){r||(i.ok(void 0!==t&&null!==t,"missing value"),i.ok(void 0!==e&&null!==e,"missing offset"),i.ok(e<this.length,"Trying to write beyond buffer length"),w(t,127,-128)),t>=0?this.writeUInt8(t,e,r):this.writeUInt8(255+t+1,e,r)},d.prototype.writeInt16LE=function(t,e,r){E(this,t,e,!1,r)},d.prototype.writeInt16BE=function(t,e,r){E(this,t,e,!0,r)},d.prototype.writeInt32LE=function(t,e,r){I(this,t,e,!1,r)},d.prototype.writeInt32BE=function(t,e,r){I(this,t,e,!0,r)},d.prototype.writeFloatLE=function(t,e,r){O(this,t,e,!1,r)},d.prototype.writeFloatBE=function(t,e,r){O(this,t,e,!0,r)},d.prototype.writeDoubleLE=function(t,e,r){M(this,t,e,!1,r)},d.prototype.writeDoubleBE=function(t,e,r){M(this,t,e,!0,r)},n.prototype.readUInt8=d.prototype.readUInt8,n.prototype.readUInt16LE=d.prototype.readUInt16LE,n.prototype.readUInt16BE=d.prototype.readUInt16BE,n.prototype.readUInt32LE=d.prototype.readUInt32LE,n.prototype.readUInt32BE=d.prototype.readUInt32BE,n.prototype.readInt8=d.prototype.readInt8,n.prototype.readInt16LE=d.prototype.readInt16LE,n.prototype.readInt16BE=d.prototype.readInt16BE,n.prototype.readInt32LE=d.prototype.readInt32LE,n.prototype.readInt32BE=d.prototype.readInt32BE,n.prototype.readFloatLE=d.prototype.readFloatLE,n.prototype.readFloatBE=d.prototype.readFloatBE,n.prototype.readDoubleLE=d.prototype.readDoubleLE,n.prototype.readDoubleBE=d.prototype.readDoubleBE,n.prototype.writeUInt8=d.prototype.writeUInt8,n.prototype.writeUInt16LE=d.prototype.writeUInt16LE,n.prototype.writeUInt16BE=d.prototype.writeUInt16BE,n.prototype.writeUInt32LE=d.prototype.writeUInt32LE,n.prototype.writeUInt32BE=d.prototype.writeUInt32BE,n.prototype.writeInt8=d.prototype.writeInt8,n.prototype.writeInt16LE=d.prototype.writeInt16LE,n.prototype.writeInt16BE=d.prototype.writeInt16BE,n.prototype.writeInt32LE=d.prototype.writeInt32LE,n.prototype.writeInt32BE=d.prototype.writeInt32BE,n.prototype.writeFloatLE=d.prototype.writeFloatLE,n.prototype.writeFloatBE=d.prototype.writeFloatBE,n.prototype.writeDoubleLE=d.prototype.writeDoubleLE,n.prototype.writeDoubleBE=d.prototype.writeDoubleBE},{assert:1,"./buffer_ieee754":5,"base64-js":7}],7:[function(t,e,r){!function(t){"use strict";var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";e.exports.toByteArray=function(t){var e,n,o,i,a,s;if(t.length%4>0)throw"Invalid string. Length must be a multiple of 4";for(s=[],o=(a=(a=t.indexOf("="))>0?t.length-a:0)>0?t.length-4:t.length,e=0,n=0;e<o;e+=4,n+=3)i=r.indexOf(t[e])<<18|r.indexOf(t[e+1])<<12|r.indexOf(t[e+2])<<6|r.indexOf(t[e+3]),s.push((16711680&i)>>16),s.push((65280&i)>>8),s.push(255&i);return 2===a?(i=r.indexOf(t[e])<<2|r.indexOf(t[e+1])>>4,s.push(255&i)):1===a&&(i=r.indexOf(t[e])<<10|r.indexOf(t[e+1])<<4|r.indexOf(t[e+2])>>2,s.push(i>>8&255),s.push(255&i)),s},e.exports.fromByteArray=function(t){var e,n,o,i,a=t.length%3,s="";for(e=0,o=t.length-a;e<o;e+=3)n=(t[e]<<16)+(t[e+1]<<8)+t[e+2],s+=r[(i=n)>>18&63]+r[i>>12&63]+r[i>>6&63]+r[63&i];switch(a){case 1:n=t[t.length-1],s+=r[n>>2],s+=r[n<<4&63],s+="==";break;case 2:n=(t[t.length-2]<<8)+t[t.length-1],s+=r[n>>10],s+=r[n>>4&63],s+=r[n<<2&63],s+="="}return s}}()},{}],8:[function(t,e,r){r.readIEEE754=function(t,e,r,n,o){var i,a,s=8*o-n-1,u=(1<<s)-1,c=u>>1,l=-7,f=r?0:o-1,d=r?1:-1,h=t[e+f];for(f+=d,i=h&(1<<-l)-1,h>>=-l,l+=s;l>0;i=256*i+t[e+f],f+=d,l-=8);for(a=i&(1<<-l)-1,i>>=-l,l+=n;l>0;a=256*a+t[e+f],f+=d,l-=8);if(0===i)i=1-c;else{if(i===u)return a?NaN:1/0*(h?-1:1);a+=Math.pow(2,n),i-=c}return(h?-1:1)*a*Math.pow(2,i-n)},r.writeIEEE754=function(t,e,r,n,o,i){var a,s,u,c=8*i-o-1,l=(1<<c)-1,f=l>>1,d=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,h=n?i-1:0,p=n?-1:1,g=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(s=isNaN(e)?1:0,a=l):(a=Math.floor(Math.log(e)/Math.LN2),e*(u=Math.pow(2,-a))<1&&(a--,u*=2),(e+=a+f>=1?d/u:d*Math.pow(2,1-f))*u>=2&&(a++,u/=2),a+f>=l?(s=0,a=l):a+f>=1?(s=(e*u-1)*Math.pow(2,o),a+=f):(s=e*Math.pow(2,f-1)*Math.pow(2,o),a=0));o>=8;t[r+h]=255&s,h+=p,s/=256,o-=8);for(a=a<<o|s,c+=o;c>0;t[r+h]=255&a,h+=p,a/=256,c-=8);t[r+h-p]|=128*g}},{}],3:[function(t,e,r){function n(t){this.length=t}var o,i=t("assert");function a(t){return t<16?"0"+t.toString(16):t.toString(16)}function s(t){for(var e=[],r=0;r<t.length;r++)if(t.charCodeAt(r)<=127)e.push(t.charCodeAt(r));else for(var n=encodeURIComponent(t.charAt(r)).substr(1).split("%"),o=0;o<n.length;o++)e.push(parseInt(n[o],16));return e}function u(e){return t("base64-js").toByteArray(e)}function c(t,e,r,n){for(var o=0;o<n&&!(o+r>=e.length||o>=t.length);)e[o+r]=t[o],o++;return o}function l(t){try{return decodeURIComponent(t)}catch(t){return String.fromCharCode(65533)}}function f(t){return(t=~~Math.ceil(+t))<0?0:t}function d(t,e,r){if(!(this instanceof d))return new d(t,e,r);var i;if("number"==typeof r)this.length=f(e),this.parent=t,this.offset=r;else{switch(i=typeof t){case"number":this.length=f(t);break;case"string":this.length=d.byteLength(t,e);break;case"object":this.length=f(t.length);break;default:throw new Error("First argument needs to be a number, array or string.")}if(this.length>d.poolSize?(this.parent=new n(this.length),this.offset=0):((!o||o.length-o.used<this.length)&&((o=new n(d.poolSize)).used=0),this.parent=o,this.offset=o.used,o.used+=this.length),function(t){return Array.isArray(t)||d.isBuffer(t)||t&&"object"==typeof t&&"number"==typeof t.length}(t))for(var a=0;a<this.length;a++)this.parent[a+this.offset]=t[a];else"string"==i&&(this.length=this.write(t,0,e))}}function h(t,e,r,n){var o=0;return n||(i.ok("boolean"==typeof r,"missing or invalid endian"),i.ok(void 0!==e&&null!==e,"missing offset"),i.ok(e+1<t.length,"Trying to read beyond buffer length")),r?(o=t.parent[t.offset+e]<<8,o|=t.parent[t.offset+e+1]):(o=t.parent[t.offset+e],o|=t.parent[t.offset+e+1]<<8),o}function p(t,e,r,n){var o=0;return n||(i.ok("boolean"==typeof r,"missing or invalid endian"),i.ok(void 0!==e&&null!==e,"missing offset"),i.ok(e+3<t.length,"Trying to read beyond buffer length")),r?(o=t.parent[t.offset+e+1]<<16,o|=t.parent[t.offset+e+2]<<8,o|=t.parent[t.offset+e+3],o+=t.parent[t.offset+e]<<24>>>0):(o=t.parent[t.offset+e+2]<<16,o|=t.parent[t.offset+e+1]<<8,o|=t.parent[t.offset+e],o+=t.parent[t.offset+e+3]<<24>>>0),o}function g(t,e,r,n){var o;return n||(i.ok("boolean"==typeof r,"missing or invalid endian"),i.ok(void 0!==e&&null!==e,"missing offset"),i.ok(e+1<t.length,"Trying to read beyond buffer length")),32768&(o=h(t,e,r,n))?-1*(65535-o+1):o}function m(t,e,r,n){var o;return n||(i.ok("boolean"==typeof r,"missing or invalid endian"),i.ok(void 0!==e&&null!==e,"missing offset"),i.ok(e+3<t.length,"Trying to read beyond buffer length")),2147483648&(o=p(t,e,r,n))?-1*(4294967295-o+1):o}function v(e,r,n,o){return o||(i.ok("boolean"==typeof n,"missing or invalid endian"),i.ok(r+3<e.length,"Trying to read beyond buffer length")),t("./buffer_ieee754").readIEEE754(e,r,n,23,4)}function y(e,r,n,o){return o||(i.ok("boolean"==typeof n,"missing or invalid endian"),i.ok(r+7<e.length,"Trying to read beyond buffer length")),t("./buffer_ieee754").readIEEE754(e,r,n,52,8)}function x(t,e){i.ok("number"==typeof t,"cannot write a non-number as a number"),i.ok(t>=0,"specified a negative value for writing an unsigned value"),i.ok(t<=e,"value is larger than maximum value for type"),i.ok(Math.floor(t)===t,"value has a fractional component")}function C(t,e,r,n,o){o||(i.ok(void 0!==e&&null!==e,"missing value"),i.ok("boolean"==typeof n,"missing or invalid endian"),i.ok(void 0!==r&&null!==r,"missing offset"),i.ok(r+1<t.length,"trying to write beyond buffer length"),x(e,65535)),n?(t.parent[t.offset+r]=(65280&e)>>>8,t.parent[t.offset+r+1]=255&e):(t.parent[t.offset+r+1]=(65280&e)>>>8,t.parent[t.offset+r]=255&e)}function _(t,e,r,n,o){o||(i.ok(void 0!==e&&null!==e,"missing value"),i.ok("boolean"==typeof n,"missing or invalid endian"),i.ok(void 0!==r&&null!==r,"missing offset"),i.ok(r+3<t.length,"trying to write beyond buffer length"),x(e,4294967295)),n?(t.parent[t.offset+r]=e>>>24&255,t.parent[t.offset+r+1]=e>>>16&255,t.parent[t.offset+r+2]=e>>>8&255,t.parent[t.offset+r+3]=255&e):(t.parent[t.offset+r+3]=e>>>24&255,t.parent[t.offset+r+2]=e>>>16&255,t.parent[t.offset+r+1]=e>>>8&255,t.parent[t.offset+r]=255&e)}function w(t,e,r){i.ok("number"==typeof t,"cannot write a non-number as a number"),i.ok(t<=e,"value larger than maximum allowed value"),i.ok(t>=r,"value smaller than minimum allowed value"),i.ok(Math.floor(t)===t,"value has a fractional component")}function b(t,e,r){i.ok("number"==typeof t,"cannot write a non-number as a number"),i.ok(t<=e,"value larger than maximum allowed value"),i.ok(t>=r,"value smaller than minimum allowed value")}function E(t,e,r,n,o){o||(i.ok(void 0!==e&&null!==e,"missing value"),i.ok("boolean"==typeof n,"missing or invalid endian"),i.ok(void 0!==r&&null!==r,"missing offset"),i.ok(r+1<t.length,"Trying to write beyond buffer length"),w(e,32767,-32768)),C(t,e>=0?e:65535+e+1,r,n,o)}function I(t,e,r,n,o){o||(i.ok(void 0!==e&&null!==e,"missing value"),i.ok("boolean"==typeof n,"missing or invalid endian"),i.ok(void 0!==r&&null!==r,"missing offset"),i.ok(r+3<t.length,"Trying to write beyond buffer length"),w(e,2147483647,-2147483648)),_(t,e>=0?e:4294967295+e+1,r,n,o)}function O(e,r,n,o,a){a||(i.ok(void 0!==r&&null!==r,"missing value"),i.ok("boolean"==typeof o,"missing or invalid endian"),i.ok(void 0!==n&&null!==n,"missing offset"),i.ok(n+3<e.length,"Trying to write beyond buffer length"),b(r,3.4028234663852886e38,-3.4028234663852886e38)),t("./buffer_ieee754").writeIEEE754(e,r,n,o,23,4)}function M(e,r,n,o,a){a||(i.ok(void 0!==r&&null!==r,"missing value"),i.ok("boolean"==typeof o,"missing or invalid endian"),i.ok(void 0!==n&&null!==n,"missing offset"),i.ok(n+7<e.length,"Trying to write beyond buffer length"),b(r,1.7976931348623157e308,-1.7976931348623157e308)),t("./buffer_ieee754").writeIEEE754(e,r,n,o,52,8)}r.INSPECT_MAX_BYTES=50,n.byteLength=function(t,e){switch(e||"utf8"){case"hex":return t.length/2;case"utf8":case"utf-8":return s(t).length;case"ascii":return t.length;case"base64":return u(t).length;default:throw new Error("Unknown encoding")}},n.prototype.utf8Write=function(t,e,r){return n._charsWritten=c(s(t),this,e,r)},n.prototype.asciiWrite=function(t,e,r){return n._charsWritten=c(function(t){for(var e=[],r=0;r<t.length;r++)e.push(255&t.charCodeAt(r));return e}(t),this,e,r)},n.prototype.base64Write=function(t,e,r){return n._charsWritten=c(u(t),this,e,r)},n.prototype.base64Slice=function(e,r){var n=Array.prototype.slice.apply(this,arguments);return t("base64-js").fromByteArray(n)},n.prototype.utf8Slice=function(){for(var t=Array.prototype.slice.apply(this,arguments),e="",r="",n=0;n<t.length;)t[n]<=127?(e+=l(r)+String.fromCharCode(t[n]),r=""):r+="%"+t[n].toString(16),n++;return e+l(r)},n.prototype.asciiSlice=function(){for(var t=Array.prototype.slice.apply(this,arguments),e="",r=0;r<t.length;r++)e+=String.fromCharCode(t[r]);return e},n.prototype.inspect=function(){for(var t=[],e=this.length,n=0;n<e;n++)if(t[n]=a(this[n]),n==r.INSPECT_MAX_BYTES){t[n+1]="...";break}return"<SlowBuffer "+t.join(" ")+">"},n.prototype.hexSlice=function(t,e){var r=this.length;(!t||t<0)&&(t=0),(!e||e<0||e>r)&&(e=r);for(var n="",o=t;o<e;o++)n+=a(this[o]);return n},n.prototype.toString=function(t,e,r){if(t=String(t||"utf8").toLowerCase(),e=+e||0,void 0===r&&(r=this.length),+r==e)return"";switch(t){case"hex":return this.hexSlice(e,r);case"utf8":case"utf-8":return this.utf8Slice(e,r);case"ascii":return this.asciiSlice(e,r);case"binary":return this.binarySlice(e,r);case"base64":return this.base64Slice(e,r);case"ucs2":case"ucs-2":return this.ucs2Slice(e,r);default:throw new Error("Unknown encoding")}},n.prototype.hexWrite=function(t,e,r){e=+e||0;var o=this.length-e;r?(r=+r)>o&&(r=o):r=o;var i=t.length;if(i%2)throw new Error("Invalid hex string");r>i/2&&(r=i/2);for(var a=0;a<r;a++){var s=parseInt(t.substr(2*a,2),16);if(isNaN(s))throw new Error("Invalid hex string");this[e+a]=s}return n._charsWritten=2*a,a},n.prototype.write=function(t,e,r,n){if(isFinite(e))isFinite(r)||(n=r,r=void 0);else{var o=n;n=e,e=r,r=o}e=+e||0;var i=this.length-e;switch(r?(r=+r)>i&&(r=i):r=i,n=String(n||"utf8").toLowerCase()){case"hex":return this.hexWrite(t,e,r);case"utf8":case"utf-8":return this.utf8Write(t,e,r);case"ascii":return this.asciiWrite(t,e,r);case"binary":return this.binaryWrite(t,e,r);case"base64":return this.base64Write(t,e,r);case"ucs2":case"ucs-2":return this.ucs2Write(t,e,r);default:throw new Error("Unknown encoding")}},n.prototype.slice=function(t,e){if(void 0===e&&(e=this.length),e>this.length)throw new Error("oob");if(t>e)throw new Error("oob");return new d(this,e-t,+t)},n.prototype.copy=function(t,e,r,n){for(var o=[],a=r;a<n;a++)i.ok(void 0!==this[a],"copying undefined buffer bytes!"),o.push(this[a]);for(a=e;a<e+o.length;a++)t[a]=o[a-e]},r.SlowBuffer=n,r.Buffer=d,d.poolSize=8192,d.isBuffer=function(t){return t instanceof d||t instanceof n},d.concat=function(t,e){if(!Array.isArray(t))throw new Error("Usage: Buffer.concat(list, [totalLength])\n       list should be an Array.");if(0===t.length)return new d(0);if(1===t.length)return t[0];if("number"!=typeof e){e=0;for(var r=0;r<t.length;r++){e+=(i=t[r]).length}}var n=new d(e),o=0;for(r=0;r<t.length;r++){var i;(i=t[r]).copy(n,o),o+=i.length}return n},d.prototype.inspect=function(){for(var t=[],e=this.length,n=0;n<e;n++)if(t[n]=a(this.parent[n+this.offset]),n==r.INSPECT_MAX_BYTES){t[n+1]="...";break}return"<Buffer "+t.join(" ")+">"},d.prototype.get=function(t){if(t<0||t>=this.length)throw new Error("oob");return this.parent[this.offset+t]},d.prototype.set=function(t,e){if(t<0||t>=this.length)throw new Error("oob");return this.parent[this.offset+t]=e},d.prototype.write=function(t,e,r,o){if(isFinite(e))isFinite(r)||(o=r,r=void 0);else{var i=o;o=e,e=r,r=i}e=+e||0;var a,s=this.length-e;switch(r?(r=+r)>s&&(r=s):r=s,o=String(o||"utf8").toLowerCase()){case"hex":a=this.parent.hexWrite(t,this.offset+e,r);break;case"utf8":case"utf-8":a=this.parent.utf8Write(t,this.offset+e,r);break;case"ascii":a=this.parent.asciiWrite(t,this.offset+e,r);break;case"binary":a=this.parent.binaryWrite(t,this.offset+e,r);break;case"base64":a=this.parent.base64Write(t,this.offset+e,r);break;case"ucs2":case"ucs-2":a=this.parent.ucs2Write(t,this.offset+e,r);break;default:throw new Error("Unknown encoding")}return d._charsWritten=n._charsWritten,a},d.prototype.toString=function(t,e,r){switch(t=String(t||"utf8").toLowerCase(),void 0===e||e<0?e=0:e>this.length&&(e=this.length),void 0===r||r>this.length?r=this.length:r<0&&(r=0),e+=this.offset,r+=this.offset,t){case"hex":return this.parent.hexSlice(e,r);case"utf8":case"utf-8":return this.parent.utf8Slice(e,r);case"ascii":return this.parent.asciiSlice(e,r);case"binary":return this.parent.binarySlice(e,r);case"base64":return this.parent.base64Slice(e,r);case"ucs2":case"ucs-2":return this.parent.ucs2Slice(e,r);default:throw new Error("Unknown encoding")}},d.byteLength=n.byteLength,d.prototype.fill=function(t,e,r){if(t||(t=0),e||(e=0),r||(r=this.length),"string"==typeof t&&(t=t.charCodeAt(0)),"number"!=typeof t||isNaN(t))throw new Error("value is not a number");if(r<e)throw new Error("end < start");if(r===e)return 0;if(0==this.length)return 0;if(e<0||e>=this.length)throw new Error("start out of bounds");if(r<0||r>this.length)throw new Error("end out of bounds");return this.parent.fill(t,e+this.offset,r+this.offset)},d.prototype.copy=function(t,e,r,n){if(r||(r=0),n||(n=this.length),e||(e=0),n<r)throw new Error("sourceEnd < sourceStart");if(n===r)return 0;if(0==t.length||0==this.length)return 0;if(e<0||e>=t.length)throw new Error("targetStart out of bounds");if(r<0||r>=this.length)throw new Error("sourceStart out of bounds");if(n<0||n>this.length)throw new Error("sourceEnd out of bounds");return n>this.length&&(n=this.length),t.length-e<n-r&&(n=t.length-e+r),this.parent.copy(t.parent,e+t.offset,r+this.offset,n+this.offset)},d.prototype.slice=function(t,e){if(void 0===e&&(e=this.length),e>this.length)throw new Error("oob");if(t>e)throw new Error("oob");return new d(this.parent,e-t,+t+this.offset)},d.prototype.utf8Slice=function(t,e){return this.toString("utf8",t,e)},d.prototype.binarySlice=function(t,e){return this.toString("binary",t,e)},d.prototype.asciiSlice=function(t,e){return this.toString("ascii",t,e)},d.prototype.utf8Write=function(t,e){return this.write(t,e,"utf8")},d.prototype.binaryWrite=function(t,e){return this.write(t,e,"binary")},d.prototype.asciiWrite=function(t,e){return this.write(t,e,"ascii")},d.prototype.readUInt8=function(t,e){return e||(i.ok(void 0!==t&&null!==t,"missing offset"),i.ok(t<this.length,"Trying to read beyond buffer length")),this.parent[this.offset+t]},d.prototype.readUInt16LE=function(t,e){return h(this,t,!1,e)},d.prototype.readUInt16BE=function(t,e){return h(this,t,!0,e)},d.prototype.readUInt32LE=function(t,e){return p(this,t,!1,e)},d.prototype.readUInt32BE=function(t,e){return p(this,t,!0,e)},d.prototype.readInt8=function(t,e){return e||(i.ok(void 0!==t&&null!==t,"missing offset"),i.ok(t<this.length,"Trying to read beyond buffer length")),128&this.parent[this.offset+t]?-1*(255-this.parent[this.offset+t]+1):this.parent[this.offset+t]},d.prototype.readInt16LE=function(t,e){return g(this,t,!1,e)},d.prototype.readInt16BE=function(t,e){return g(this,t,!0,e)},d.prototype.readInt32LE=function(t,e){return m(this,t,!1,e)},d.prototype.readInt32BE=function(t,e){return m(this,t,!0,e)},d.prototype.readFloatLE=function(t,e){return v(this,t,!1,e)},d.prototype.readFloatBE=function(t,e){return v(this,t,!0,e)},d.prototype.readDoubleLE=function(t,e){return y(this,t,!1,e)},d.prototype.readDoubleBE=function(t,e){return y(this,t,!0,e)},d.prototype.writeUInt8=function(t,e,r){r||(i.ok(void 0!==t&&null!==t,"missing value"),i.ok(void 0!==e&&null!==e,"missing offset"),i.ok(e<this.length,"trying to write beyond buffer length"),x(t,255)),this.parent[this.offset+e]=t},d.prototype.writeUInt16LE=function(t,e,r){C(this,t,e,!1,r)},d.prototype.writeUInt16BE=function(t,e,r){C(this,t,e,!0,r)},d.prototype.writeUInt32LE=function(t,e,r){_(this,t,e,!1,r)},d.prototype.writeUInt32BE=function(t,e,r){_(this,t,e,!0,r)},d.prototype.writeInt8=function(t,e,r){r||(i.ok(void 0!==t&&null!==t,"missing value"),i.ok(void 0!==e&&null!==e,"missing offset"),i.ok(e<this.length,"Trying to write beyond buffer length"),w(t,127,-128)),t>=0?this.writeUInt8(t,e,r):this.writeUInt8(255+t+1,e,r)},d.prototype.writeInt16LE=function(t,e,r){E(this,t,e,!1,r)},d.prototype.writeInt16BE=function(t,e,r){E(this,t,e,!0,r)},d.prototype.writeInt32LE=function(t,e,r){I(this,t,e,!1,r)},d.prototype.writeInt32BE=function(t,e,r){I(this,t,e,!0,r)},d.prototype.writeFloatLE=function(t,e,r){O(this,t,e,!1,r)},d.prototype.writeFloatBE=function(t,e,r){O(this,t,e,!0,r)},d.prototype.writeDoubleLE=function(t,e,r){M(this,t,e,!1,r)},d.prototype.writeDoubleBE=function(t,e,r){M(this,t,e,!0,r)},n.prototype.readUInt8=d.prototype.readUInt8,n.prototype.readUInt16LE=d.prototype.readUInt16LE,n.prototype.readUInt16BE=d.prototype.readUInt16BE,n.prototype.readUInt32LE=d.prototype.readUInt32LE,n.prototype.readUInt32BE=d.prototype.readUInt32BE,n.prototype.readInt8=d.prototype.readInt8,n.prototype.readInt16LE=d.prototype.readInt16LE,n.prototype.readInt16BE=d.prototype.readInt16BE,n.prototype.readInt32LE=d.prototype.readInt32LE,n.prototype.readInt32BE=d.prototype.readInt32BE,n.prototype.readFloatLE=d.prototype.readFloatLE,n.prototype.readFloatBE=d.prototype.readFloatBE,n.prototype.readDoubleLE=d.prototype.readDoubleLE,n.prototype.readDoubleBE=d.prototype.readDoubleBE,n.prototype.writeUInt8=d.prototype.writeUInt8,n.prototype.writeUInt16LE=d.prototype.writeUInt16LE,n.prototype.writeUInt16BE=d.prototype.writeUInt16BE,n.prototype.writeUInt32LE=d.prototype.writeUInt32LE,n.prototype.writeUInt32BE=d.prototype.writeUInt32BE,n.prototype.writeInt8=d.prototype.writeInt8,n.prototype.writeInt16LE=d.prototype.writeInt16LE,n.prototype.writeInt16BE=d.prototype.writeInt16BE,n.prototype.writeInt32LE=d.prototype.writeInt32LE,n.prototype.writeInt32BE=d.prototype.writeInt32BE,n.prototype.writeFloatLE=d.prototype.writeFloatLE,n.prototype.writeFloatBE=d.prototype.writeFloatBE,n.prototype.writeDoubleLE=d.prototype.writeDoubleLE,n.prototype.writeDoubleBE=d.prototype.writeDoubleBE},{assert:1,"./buffer_ieee754":8,"base64-js":9}],9:[function(t,e,r){!function(t){"use strict";var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";e.exports.toByteArray=function(t){var e,n,o,i,a,s;if(t.length%4>0)throw"Invalid string. Length must be a multiple of 4";for(s=[],o=(a=(a=t.indexOf("="))>0?t.length-a:0)>0?t.length-4:t.length,e=0,n=0;e<o;e+=4,n+=3)i=r.indexOf(t[e])<<18|r.indexOf(t[e+1])<<12|r.indexOf(t[e+2])<<6|r.indexOf(t[e+3]),s.push((16711680&i)>>16),s.push((65280&i)>>8),s.push(255&i);return 2===a?(i=r.indexOf(t[e])<<2|r.indexOf(t[e+1])>>4,s.push(255&i)):1===a&&(i=r.indexOf(t[e])<<10|r.indexOf(t[e+1])<<4|r.indexOf(t[e+2])>>2,s.push(i>>8&255),s.push(255&i)),s},e.exports.fromByteArray=function(t){var e,n,o,i,a=t.length%3,s="";for(e=0,o=t.length-a;e<o;e+=3)n=(t[e]<<16)+(t[e+1]<<8)+t[e+2],s+=r[(i=n)>>18&63]+r[i>>12&63]+r[i>>6&63]+r[63&i];switch(a){case 1:n=t[t.length-1],s+=r[n>>2],s+=r[n<<4&63],s+="==";break;case 2:n=(t[t.length-2]<<8)+t[t.length-1],s+=r[n>>10],s+=r[n>>4&63],s+=r[n<<2&63],s+="="}return s}}()},{}]},{},[]),e.exports=t("buffer-browserify")},{}],64:[function(t,e,r){var n=e.exports={};n.nextTick=function(){var t="undefined"!=typeof window&&window.setImmediate,e="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(t)return function(t){return window.setImmediate(t)};if(e){var r=[];return window.addEventListener("message",function(t){var e=t.source;e!==window&&null!==e||"process-tick"!==t.data||(t.stopPropagation(),r.length>0&&r.shift()())},!0),function(t){r.push(t),window.postMessage("process-tick","*")}}return function(t){setTimeout(t,0)}}(),n.title="browser",n.browser=!0,n.env={},n.argv=[],n.binding=function(t){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(t){throw new Error("process.chdir is not supported")}},{}],65:[function(t,e,r){(function(){"use strict";function n(t){var e=function(t){return"string"==typeof t?t:"object"==typeof t&&t.hashCode?t.hashCode():""+t},r=t.declare({instance:{constructor:function(){this.__entries=[],this.__keys=[],this.__values=[]},pushValue:function(t,e){return this.__keys.push(t),this.__values.push(e),this.__entries.push({key:t,value:e}),e},remove:function(t){for(var e,r=this.__entries,n=this.__keys,o=this.__values,i=r.length-1;i>=0;i--)if((e=r[i])&&e.key===t)return r.splice(i,1),n.splice(i,1),o.splice(i,1),e.value;return null},set:function(t,e){for(var r=null,n=this.__entries,o=this.__values,i=n.length-1;i>=0;i--){var a=n[i];if(a&&t===a.key){o[i]=e,a.value=e,r=e;break}}return r||n.push({key:t,value:e}),r},find:function(t){for(var e,r=null,n=this.__entries,o=n.length-1;o>=0;o--)if((e=n[o])&&t===e.key){r=e.value;break}return r},getEntrySet:function(){return this.__entries},getKeys:function(){return this.__keys},getValues:function(t){return this.__values}}});return t.declare({instance:{constructor:function(){this.__map={}},entrySet:function(){var t=[],e=this.__map;for(var r in e)e.hasOwnProperty(r)&&(t=t.concat(e[r].getEntrySet()));return t},put:function(t,n){var o=e(t),i=null;return(i=this.__map[o])||(i=this.__map[o]=new r),i.pushValue(t,n),n},remove:function(t){var r=e(t),n=null,o=this.__map[r];return o&&(n=o.remove(t)),n},get:function(t){var r,n=e(t),o=null;return(r=this.__map[n])&&(o=r.find(t)),o},set:function(t,n){var o=e(t),i=null,a=this.__map;return(i=a[o])?i.set(t,n):(a[o]=new r).pushValue(t,n)},contains:function(t){var r=e(t),n=!1,o=null;return(o=this.__map[r])&&(n=!!o.find(t)),n},concat:function(t){if(t instanceof this._static){for(var e=new this._static,r=t.entrySet().concat(this.entrySet()),n=r.length-1;n>=0;n--){var o=r[n];e.put(o.key,o.value)}return e}throw new TypeError("When joining hashtables the joining arg must be a HashTable")},filter:function(e,r){for(var n=this.entrySet(),o=new this._static,i=(n=t.filter(n,e,r)).length-1;i>=0;i--){var a=n[i];o.put(a.key,a.value)}return o},forEach:function(e,r){var n=this.entrySet();t.forEach(n,e,r)},every:function(e,r){var n=this.entrySet();return t.every(n,e,r)},map:function(e,r){var n=this.entrySet();return t.map(n,e,r)},some:function(e,r){var n=this.entrySet();return t.some(n,e,r)},reduce:function(e,r){var n=this.entrySet();return t.reduce(n,e,r)},reduceRight:function(e,r){var n=this.entrySet();return t.reduceRight(n,e,r)},clear:function(){this.__map={}},keys:function(){var t=[],e=this.__map;for(var r in e)t=t.concat(e[r].getKeys());return t},values:function(){var t=[],e=this.__map;for(var r in e)t=t.concat(e[r].getValues());return t},isEmpty:function(){return 0===this.keys().length}}})}void 0!==r?void 0!==e&&e.exports&&(e.exports=n(t("extended")().register("declare",t("declare.js")).register(t("is-extended")).register(t("array-extended")))):"function"==typeof define?define(["extended","declare","is-extended","array-extended"],function(t,e,r,o){return n(t().register("declare",e).register(r).register(o))}):this.Ht=n(this.extended().register("declare",this.declare).register(this.isExtended).register(this.arrayExtended))}).call(this)},{"array-extended":52,"declare.js":55,extended:56,"is-extended":66}],66:[function(t,e,r){var n=t("__browserify_Buffer").Buffer;(function(){"use strict";function o(t){var e=Array.prototype.slice,r=Object.prototype.hasOwnProperty,o=Object.prototype.toString;function i(t,e){var r=-1,n=0,o=t.length,i=[];for(r+=e=e||0;++r<o;)i[n++]=t[r];return i}function a(t){var e=[];for(var n in t)r.call(t,n)&&e.push(n);return e}function s(t,r){if(t===r)return!0;if(void 0!==n&&n.isBuffer(t)&&n.isBuffer(r)){if(t.length!==r.length)return!1;for(var o=0;o<t.length;o++)if(t[o]!==r[o])return!1;return!0}return y(t)&&y(r)?t.getTime()===r.getTime():m(t)&&m(r)?t.source===r.source&&t.global===r.global&&t.multiline===r.multiline&&t.lastIndex===r.lastIndex&&t.ignoreCase===r.ignoreCase:(!x(t)||!x(r)||t===r)&&("object"!=typeof t&&"object"!=typeof r?t===r:function(t,r){var n;if(h(t)||h(r))return!1;if(t.prototype!==r.prototype)return!1;if(g(t))return!!g(r)&&(t=e.call(t),r=e.call(r),s(t,r));try{var o,i=a(t),u=a(r);if(i.length!==u.length)return!1;for(i.sort(),u.sort(),o=i.length-1;o>=0;o--)if(i[o]!==u[o])return!1;for(o=i.length-1;o>=0;o--)if(n=i[o],!s(t[n],r[n]))return!1}catch(t){return!1}return!0}(t,r))}var u,c=function(t){return"[object Function]"===o.call(t)};function l(t){return null!==t&&"object"==typeof t}function f(t){return!0===t||!1===t||"[object Boolean]"===o.call(t)}function d(t){return void 0===t}function h(t){return d(t)||p(t)}function p(t){return null===t}"undefined"==typeof window||c(window.alert)||(u=window.alert,c=function(t){return"[object Function]"===o.call(t)||t===u});var g=function(t){return"[object Arguments]"===o.call(t)};function m(t){return"[object RegExp]"===o.call(t)}g(arguments)||(g=function(t){return!(!t||!r.call(t,"callee"))});var v=Array.isArray||function(t){return"[object Array]"===o.call(t)};function y(t){return"[object Date]"===o.call(t)}function x(t){return"[object String]"===o.call(t)}function C(t,e){return t==e}function _(t,e){if(v(e)&&Array.prototype.indexOf||x(e))return e.indexOf(t)>-1;if(v(e))for(var r=0,n=e.length;r<n;r++)if(C(t,e[r]))return!0;return!1}function w(t,e){return x(e)?null!==(""+t).match(e):!!m(e)&&e.test(t)}function b(t,e){return r.call(t,e)}var E={isFunction:c,isObject:l,isEmpty:function(t){return g(t)?0===t.length:l(t)?0===a(t).length:!x(t)&&!v(t)||0===t.length},isHash:function(t){return l(t)&&t.constructor===Object&&!t.nodeType&&!t.setInterval},isNumber:function(t){return"[object Number]"===o.call(t)},isString:x,isDate:y,isArray:v,isBoolean:f,isUndefined:d,isDefined:function(t){return!d(t)},isUndefinedOrNull:h,isNull:p,isArguments:g,instanceOf:function(t,e){return!!c(e)&&t instanceof e},isRegExp:m,deepEqual:s,isTrue:function(t){return!0===t},isFalse:function(t){return!1===t},isNotNull:function(t){return!p(t)},isEq:C,isNeq:function(t,e){return t!=e},isSeq:function(t,e){return t===e},isSneq:function(t,e){return t!==e},isIn:_,isNotIn:function(t,e){return!_(t,e)},isLt:function(t,e){return t<e},isLte:function(t,e){return t<=e},isGt:function(t,e){return t>e},isGte:function(t,e){return t>=e},isLike:w,isNotLike:function(t,e){return!w(t,e)},contains:function(t,e){return _(e,t)},notContains:function(t,e){return!_(e,t)},has:b,notHas:function(t,e){return!b(t,e)},isLength:function(t,e){return!!b(t,"length")&&t.length===e},isNotLength:function(t,e){return!!b(t,"length")&&t.length!==e},containsAt:function(t,e,r){return!!(v(t)&&t.length>r)&&C(t[r],e)},notContainsAt:function(t,e,r){return!!v(t)&&!C(t[r],e)}},I={constructor:function(){this._testers=[]},noWrap:{tester:function(){var t=this._testers;return function(e){for(var r=!1,n=0,o=t.length;n<o&&!r;n++)r=t[n](e);return r}}}},O={constructor:function(){this._cases=[],this.__default=null},def:function(t,e){this.__default=e},noWrap:{switcher:function(){var t=this._cases,e=this.__default;return function(){for(var r,n=i(arguments),o=0,a=t.length;o<a;o++)if((r=t[o](n)).length>1&&(r[1]||r[0]))return r[1];if(e)return e.apply(this,n)}}}};function M(t){I[t]=function(){this._testers.push(E[t])}}function S(t){O[t]=function(){var e,r=i(arguments,1),n=E[t],o=!0;if(r.length<=n.length-1)throw new TypeError("A handler must be defined when calling using switch");if(f(e=r.pop())&&(o=e,e=r.pop()),!c(e))throw new TypeError("handler must be defined");this._cases.push(function(t){return n.apply(E,t.concat(r))?[o,e.apply(this,t)]:[!1]})}}for(var A in E)r.call(E,A)&&(S(A),M(A));var k=t.define(E).expose(E);return k.tester=t.define(I),k.switcher=t.define(O),k}void 0!==r?void 0!==e&&e.exports&&(e.exports=o(t("extended"))):"function"==typeof define&&define.amd?define(["extended"],function(t){return o(t)}):this.isExtended=o(this.extended)}).call(this)},{__browserify_Buffer:63,extended:56}],67:[function(t,e,r){(function(){"use strict";function n(t){function e(t,e){return t>e?1:t<e?-1:e?0:1}var r,n,o,i,a,s,u=t.multiply,c=t.declare({instance:{__printNode:function(e,r){var n=[];t.isUndefinedOrNull(e)?(n.push(u("\t",r)),n.push("~"),console.log(n.join(""))):(this.__printNode(e.right,r+1),n.push(u("\t",r)),n.push(e.data+"\n"),console.log(n.join("")),this.__printNode(e.left,r+1))},constructor:function(t){t=t||{},this.compare=t.compare||e,this.__root=null},insert:function(){throw new Error("Not Implemented")},remove:function(){throw new Error("Not Implemented")},clear:function(){this.__root=null},isEmpty:function(){return!this.__root},traverseWithCondition:function(t,e,r){var n=!0;return t&&((e=e||c.PRE_ORDER)===c.PRE_ORDER?(n=r(t.data))&&(n=this.traverseWithCondition(t.left,e,r))&&(n=this.traverseWithCondition(t.right,e,r)):e===c.IN_ORDER?(n=this.traverseWithCondition(t.left,e,r))&&(n=r(t.data))&&(n=this.traverseWithCondition(t.right,e,r)):e===c.POST_ORDER?(n=this.traverseWithCondition(t.left,e,r))&&(n&&(n=this.traverseWithCondition(t.right,e,r)),n&&(n=r(t.data))):e===c.REVERSE_ORDER&&(n=this.traverseWithCondition(t.right,e,r))&&(n=r(t.data))&&(n=this.traverseWithCondition(t.left,e,r))),n},traverse:function(t,e,r){t&&((e=e||c.PRE_ORDER)===c.PRE_ORDER?(r(t.data),this.traverse(t.left,e,r),this.traverse(t.right,e,r)):e===c.IN_ORDER?(this.traverse(t.left,e,r),r(t.data),this.traverse(t.right,e,r)):e===c.POST_ORDER?(this.traverse(t.left,e,r),this.traverse(t.right,e,r),r(t.data)):e===c.REVERSE_ORDER&&(this.traverse(t.right,e,r),r(t.data),this.traverse(t.left,e,r)))},forEach:function(t,e,r){if("function"!=typeof t)throw new TypeError;r=r||c.IN_ORDER,e=e||this,this.traverse(this.__root,r,function(r){t.call(e,r,this)})},map:function(t,e,r){if("function"!=typeof t)throw new TypeError;r=r||c.IN_ORDER,e=e||this;var n=new this._static;return this.traverse(this.__root,r,function(r){n.insert(t.call(e,r,this))}),n},filter:function(t,e,r){if("function"!=typeof t)throw new TypeError;r=r||c.IN_ORDER,e=e||this;var n=new this._static;return this.traverse(this.__root,r,function(r){t.call(e,r,this)&&n.insert(r)}),n},reduce:function(e,r,n){var o=[this.toArray(n),e];return t.isUndefinedOrNull(r)||o.push(r),t.reduce.apply(t,o)},reduceRight:function(e,r,n){var o=[this.toArray(n),e];return t.isUndefinedOrNull(r)||o.push(r),t.reduceRight.apply(t,o)},every:function(t,e,r){if("function"!=typeof t)throw new TypeError;r=r||c.IN_ORDER,e=e||this;var n=!1;return this.traverseWithCondition(this.__root,r,function(r){return n=t.call(e,r,this)}),n},some:function(t,e,r){if("function"!=typeof t)throw new TypeError;var n;return r=r||c.IN_ORDER,e=e||this,this.traverseWithCondition(this.__root,r,function(r){return!(n=t.call(e,r,this))}),n},toArray:function(t){t=t||c.IN_ORDER;var e=[];return this.traverse(this.__root,t,function(t){e.push(t)}),e},contains:function(t){for(var e=!1,r=this.__root;null!==r;){var n=this.compare(t,r.data);n?r=r[-1===n?"left":"right"]:(e=!0,r=null)}return e},find:function(t){for(var e,r=this.__root;r;){var n=this.compare(t,r.data);if(!n){e=r.data;break}r=r[-1===n?"left":"right"]}return e},findLessThan:function(t,e){var r=[],n=this.compare;return this.traverseWithCondition(this.__root,c.IN_ORDER,function(o){var i=n(t,o);return(!e&&0===i||1===i)&&(r.push(o),!0)}),r},findGreaterThan:function(t,e){var r=[],n=this.compare;return this.traverse(this.__root,c.REVERSE_ORDER,function(o){var i=n(t,o);return(!e&&0===i||-1===i)&&(r.push(o),!0)}),r},print:function(){this.__printNode(this.__root,0)}},static:{PRE_ORDER:"pre_order",IN_ORDER:"in_order",POST_ORDER:"post_order",REVERSE_ORDER:"reverse_order"}}),l=function(){var t=Math.abs,e=function(t){return{data:t,balance:0,left:null,right:null}},r=function(t,e,r){var n=t[r];return t[r]=n[e],n[e]=t,n},n=function(t,e,n){return t[n]=r(t[n],n,e),r(t,e,n)},o=function(t,e,r){var n="left"===e?"right":"left",o=t[e],i=o[n];0===i.balance?t.balance=o.balance=0:i.balance===r?(t.balance=-r,o.balance=0):(t.balance=0,o.balance=r),i.balance=0},i=function(t,e){var i="left"===e?"right":"left",a=t[e],s="right"===e?-1:1;return a.balance===s?(t.balance=a.balance=0,t=r(t,i,e)):(o(t,e,s),t=n(t,i,e)),t},a=function(t,e,i){var a="left"===e?"right":"left",s=t[a],u="right"===e?-1:1;return s.balance===-u?(t.balance=s.balance=0,t=r(t,e,a)):s.balance===u?(o(t,a,-u),t=n(t,e,a)):(t.balance=-u,s.balance=u,t=r(t,e,a),i.done=!0),t};return c.extend({instance:{insert:function(r){!function(r,n,o){var a=r.__root;if(null===a||void 0===a)r.__root=e(n);else{for(var s,u=a,c=[],l=[],f=0;;){if(s=c[f]=-1===o(n,u.data)?"left":"right",l[f++]=u,!u[s]){u[s]=e(n);break}u=u[s]}if(!u[s])return null;for(;--f>=0&&(l[f].balance+="right"===c[f]?-1:1,0!==l[f].balance);)if(t(l[f].balance)>1){l[f]=i(l[f],c[f]),0!==f?l[f-1][c[f-1]]=l[f]:r.__root=l[0];break}}}(this,r,this.compare)},remove:function(e){!function(e,r,n){var o=e.__root;if(null!==o&&void 0!==o){for(var i,s,u=o,c=0,l=[],f=[],d={done:!1};;){if(!u)return;if(0===(s=n(r,u.data)))break;i=f[c]=-1===s?"left":"right",l[c++]=u,u=u[i]}var h=u.left,p=u.right;if(h&&p){var g=h;for(f[c]="left",l[c++]=u;g.right;)f[c]="right",l[c++]=g,g=g.right;u.data=g.data,l[c-1][l[c-1]===u?"left":"right"]=g.left}else i=h?"left":"right",0!==c?l[c-1][f[c-1]]=u[i]:e.__root=u[i];for(;--c>=0&&!d.done&&(l[c].balance+="left"===f[c]?-1:1,1!==t(l[c].balance));)t(l[c].balance)>1&&(l[c]=a(l[c],f[c],d),0!==c?l[c-1][f[c-1]]=l[c]:e.__root=l[0])}}(this,e,this.compare)},__printNode:function(t,e){var r=[];t?(this.__printNode(t.right,e+1),r.push(u("\t",e)),r.push(t.data+":"+t.balance+"\n"),console.log(r.join("")),this.__printNode(t.left,e+1)):(r.push(u("\t",e)),r.push("~"),console.log(r.join("")))}}})}(),f=function(){var t={level:0,data:null};function e(t){if(0!==t.level&&t.left.level===t.level){var e=t.left;t.left=e.right,e.right=t,t=e}return t}function r(t){if(0!==t.level&&t.right.right.level===t.level){var e=t.right;t.right=e.left,e.left=t,(t=e).level++}return t}function n(o,i,a){if(o===t)o=function(e,r){return{data:e,level:r,left:t,right:t}}(i,1);else{var s=-1===a(i,o.data)?"left":"right";o[s]=n(o[s],i,a),o=r(o=e(o))}return o}var o=function(n,i,a){var s,u;if(n!==t){var c=a(i,n.data);if(0===c)if(s=n.left,u=n.right,s!==t&&u!==t){for(var l=s;l.right!==t;)l=l.right;n.data=l.data,n.left=o(s,l.data,a)}else n=n[s===t?"right":"left"];else{var f=-1===c?"left":"right";n[f]=o(n[f],i,a)}}if(n!==t){var d=n.level,h=n.left.level,p=n.right.level;(h<d-1||p<d-1)&&(p>--n.level&&(n.right.level=n.level),n=r(n=e(n)))}return n};return c.extend({instance:{isEmpty:function(){return this.__root===t||this._super(arguments)},insert:function(e){this.__root||(this.__root=t),this.__root=n(this.__root,e,this.compare)},remove:function(t){this.__root=o(this.__root,t,this.compare)},traverseWithCondition:function(e){return e===t||this._super(arguments)},traverse:function(e){e!==t&&this._super(arguments)},contains:function(){return this.__root!==t&&this._super(arguments)},__printNode:function(t,e){var r=[];t&&t.data?(this.__printNode(t.right,e+1),r.push(u("\t",e)),r.push(t.data+":"+t.level+"\n"),console.log(r.join("")),this.__printNode(t.left,e+1)):(r.push(u("\t",e)),r.push("~"),console.log(r.join("")))}}})}(),d=c.extend({instance:{insert:function(t){if(!this.__root)return this.__root={data:t,parent:null,left:null,right:null},this.__root;for(var e=this.compare,r=this.__root;null!==r;){var n=e(t,r.data);if(!n)return;var o=-1===n?"left":"right",i=r[o];if(!i)return r[o]={data:t,parent:r,left:null,right:null};r=i}},remove:function(t){if(null!==this.__root){for(var e,r={right:this.__root},n=r,o=null,i="right";null!==n[i];){e=n,n=n[i];var a=this.compare(t,n.data);a||(o=n),i=-1===a?"left":"right"}null!==o&&(o.data=n.data,e[e.right===n?"right":"left"]=n[null===n.left?"right":"left"]),this.__root=r.right}}}}),h=(r=function(t){return null!==t&&t.red},n=function(t,e,a){if(!t)return function(t){return{data:t,red:!0,left:null,right:null}}(e);var s=a(e,t.data);if(s){var u=-1===s?"left":"right",c="left"===u?"right":"left";t[u]=n(t[u],e,a);var l=t[u];if(r(l)){var f=t[c];r(f)?(t.red=!0,l.red=!1,f.red=!1):r(l[u])?t=o(t,c):r(l[c])&&(t=i(t,c))}}return t},o=function(t,e){var r="left"===e?"right":"left",n=t[r];return t[r]=n[e],n[e]=t,t.red=!0,n.red=!1,n},i=function(t,e){var r="left"===e?"right":"left";return t[r]=o(t[r],r),o(t,e)},a=function(t,e,n,o){if(t){var i;if(0===o(e,t.data)){if(!t.left||!t.right){var u=t[t.left?"left":"right"];return r(t)?n.done=!0:r(u)&&(u.red=!1,n.done=!0),u}for(var c,l=t.right;null!==l.left;)c=l,l=l.left;c&&(c.left=null),t.data=l.data,e=l.data}t[i=-1===o(e,t.data)?"left":"right"]=a(t[i],e,n,o),n.done||(t=s(t,i,n))}else n.done=!0;return t},s=function(t,e,n){var a="left"===e?"right":"left",s=t,u=s[a];if(r(u)&&(t=o(t,e),u=s[a]),null!==u)if(r(u.left)||r(u.right)){var c=s.red,l=t===s;(s=(r(u[a])?o:i)(s,e)).red=c,s.left.red=s.right.red=0,l?t=s:t[e]=s,n.done=!0}else r(s)&&(n.done=!0),s.red=0,u.red=1;return t},c.extend({instance:{insert:function(t){this.__root=n(this.__root,t,this.compare),this.__root.red=!1},remove:function(t){var e=a(this.__root,t,{done:!1},this.compare);return null!==e&&(e.red=0),this.__root=e,t},__printNode:function(t,e){var r=[];t?(this.__printNode(t.right,e+1),r.push(u("\t",e)),r.push((t.red?"RED":"BLACK")+":"+t.data+"\n"),console.log(r.join("")),this.__printNode(t.left,e+1)):(r.push(u("\t",e)),r.push("~"),console.log(r.join("")))}}}));return{Tree:c,AVLTree:l,AnderssonTree:f,BinaryTree:d,RedBlackTree:h,IN_ORDER:c.IN_ORDER,PRE_ORDER:c.PRE_ORDER,POST_ORDER:c.POST_ORDER,REVERSE_ORDER:c.REVERSE_ORDER}}void 0!==r?void 0!==e&&e.exports&&(e.exports=n(t("extended")().register("declare",t("declare.js")).register(t("is-extended")).register(t("array-extended")).register(t("string-extended")))):"function"==typeof define?define(["extended","declare.js","is-extended","array-extended","string-extended"],function(t,e,r,o,i){return n(t().register("declare",e).register(r).register(o).register(i))}):this.leafy=n(this.extended().register("declare",this.declare).register(this.isExtended).register(this.arrayExtended).register(this.stringExtended))}).call(this)},{"array-extended":52,"declare.js":55,extended:56,"is-extended":66,"string-extended":70}],68:[function(t,e,r){(function(){"use strict";function n(t,e,r){var n=e.deepEqual,o=e.isString,i=e.isHash,a=r.difference,s=Object.prototype.hasOwnProperty,u=e.isFunction;function c(t,e){var r,n;for(r in e)s.call(e,r)&&(n=e[r],r in t&&t[r]===n||(t[r]=n));return t}function l(t,e){var r,o,a;for(r in e)s.call(e,r)&&(o=e[r],a=t[r],n(a,o)||(i(a)&&i(o)?t[r]=l(a,o):i(o)?t[r]=l({},o):t[r]=o));return t}function f(t){t||(t={});for(var e=1,r=arguments.length;e<r;e++)c(t,arguments[e]);return t}function d(t,e){return f(t.prototype||t,e),t}function h(t){if(!i(t))throw new TypeError;var e=[];for(var r in t)s.call(t,r)&&e.push(r);return e}function p(t,e){if(!i(t))throw new TypeError;o(e)&&(e=[e]);for(var r,n=a(h(t),e),s={},u=0,c=n.length;u<c;++u)s[r=n[u]]=t[r];return s}var g={forEach:function(t,e,r){if(!i(t)||!u(e))throw new TypeError;for(var n,o=h(t),a=0,s=o.length;a<s;++a)n=o[a],e.call(r||t,t[n],n,t);return t},filter:function(t,e,r){if(!i(t)||!u(e))throw new TypeError;for(var n,o,a=h(t),s={},c=0,l=a.length;c<l;++c)o=t[n=a[c]],e.call(r||t,o,n,t)&&(s[n]=o);return s},invert:function(t){if(!i(t))throw new TypeError;for(var e,r=h(t),n={},o=0,a=r.length;o<a;++o)n[t[e=r[o]]]=e;return n},values:function(t){if(!i(t))throw new TypeError;for(var e=h(t),r=[],n=0,o=e.length;n<o;++n)r.push(t[e[n]]);return r},toArray:function(t){if(!i(t))throw new TypeError;for(var e,r=h(t),n=[],o=0,a=r.length;o<a;++o)e=r[o],n.push([e,t[e]]);return n},keys:h,omit:p},m={extend:d,merge:f,deepMerge:function(t){t||(t={});for(var e=1,r=arguments.length;e<r;e++)l(t,arguments[e]);return t},omit:p},v=t.define(e.isObject,m).define(i,g).define(e.isFunction,{extend:d}).expose({hash:g}).expose(m),y=v.extend;return v.extend=function(){if(1===arguments.length)return y.extend.apply(v,arguments);d.apply(null,arguments)},v}void 0!==r?void 0!==e&&e.exports&&(e.exports=n(t("extended"),t("is-extended"),t("array-extended"))):"function"==typeof define&&define.amd?define(["extended","is-extended","array-extended"],function(t,e,r){return n(t,e,r)}):this.objectExtended=n(this.extended,this.isExtended,this.arrayExtended)}).call(this)},{"array-extended":52,extended:56,"is-extended":66}],69:[function(t,e,r){var n=t("__browserify_process");(function(){"use strict";function o(t,e,r,o,i,a){var s,u=r.forEach,c=o.isUndefinedOrNull,l=o.isArray,f=o.isFunction,d=o.isBoolean,h=i.bind,p=i.bindIgnore,g=a.argsToArray;function m(t,e){return function(){try{E(t.apply(null,arguments)).addCallback(e).addErrback(e)}catch(t){e.errback(t)}}}if("function"==typeof setImmediate)s="undefined"!=typeof window?setImmediate.bind(window):setImmediate;else if(void 0!==n)s=function(t){n.nextTick(t)};else if("undefined"!=typeof MessageChannel){var v=new MessageChannel,y={},x=y;v.port1.onmessage=function(){var t=(y=y.next).task;delete y.task,t()},s=function(t){x=x.next={task:t},v.port2.postMessage(0)}}else s=function(t){setTimeout(t,0)};var C=t({instance:{__fired:!1,__results:null,__error:null,__errorCbs:null,__cbs:null,constructor:function(){this.__errorCbs=[],this.__cbs=[],i.bindAll(this,["callback","errback","resolve","classic","__resolve","addCallback","addErrback"])},__resolve:function(){if(!this.__fired){this.__fired=!0;var t,e=this.__error?this.__errorCbs:this.__cbs,r=e.length,n=this.__error||this.__results;for(t=0;t<r;t++)this.__callNextTick(e[t],n)}},__callNextTick:function(t,e){s(function(){t.apply(this,e)})},addCallback:function(t){return t&&(b(t)&&t.callback&&(t=t.callback),this.__fired&&this.__results?this.__callNextTick(t,this.__results):this.__cbs.push(t)),this},addErrback:function(t){return t&&(b(t)&&t.errback&&(t=t.errback),this.__fired&&this.__error?this.__callNextTick(t,this.__error):this.__errorCbs.push(t)),this},callback:function(t){return this.__fired||(this.__results=arguments,this.__resolve()),this.promise()},errback:function(t){return this.__fired||(this.__error=arguments,this.__resolve()),this.promise()},resolve:function(t,e){return t?this.errback(t):this.callback.apply(this,g(arguments,1)),this},classic:function(t){return"function"==typeof t&&(this.addErrback(function(e){t(e)}),this.addCallback(function(){t.apply(this,[null].concat(g(arguments)))})),this},then:function(t,e){var r=new C,n=r;return f(e)&&(n=m(e,r)),this.addErrback(n),f(t)?this.addCallback(m(t,r)):this.addCallback(r),r.promise()},both:function(t){return this.then(t,t)},promise:function(){var t={then:h(this,"then"),both:h(this,"both"),promise:function(){return t}};return u(["addCallback","addErrback","classic"],function(e){t[e]=h(this,function(){return this[e].apply(this,arguments),t})},this),t}}}),_=C.extend({instance:{__results:null,__errors:null,__promiseLength:0,__defLength:0,__firedLength:0,normalizeResults:!1,constructor:function(t,e){this.__errors=[],this.__results=[],this.normalizeResults=!!d(e)&&e,this._super(arguments),t&&t.length?(this.__defLength=t.length,u(t,this.__addPromise,this)):this.__resolve()},__addPromise:function(t,e){t.then(h(this,function(){var t=g(arguments);t.unshift(e),this.callback.apply(this,t)}),h(this,function(){var t=g(arguments);t.unshift(e),this.errback.apply(this,t)}))},__resolve:function(){if(!this.__fired){this.__fired=!0;var t,e=this.__errors.length?this.__errorCbs:this.__cbs,r=e.length,n=this.__errors.length?this.__errors:this.__results;for(t=0;t<r;t++)this.__callNextTick(e[t],n)}},__callNextTick:function(t,e){s(function(){t.apply(null,[e])})},addCallback:function(t){return t&&(b(t)&&t.callback&&(t=h(t,"callback")),this.__fired&&!this.__errors.length?this.__callNextTick(t,this.__results):this.__cbs.push(t)),this},addErrback:function(t){return t&&(b(t)&&t.errback&&(t=h(t,"errback")),this.__fired&&this.__errors.length?this.__callNextTick(t,this.__errors):this.__errorCbs.push(t)),this},callback:function(t){if(this.__fired)throw new Error("Already fired!");var e=g(arguments);return this.normalizeResults&&(e=1===(e=e.slice(1)).length?e.pop():e),this.__results[t]=e,this.__firedLength++,this.__firedLength===this.__defLength&&this.__resolve(),this.promise()},errback:function(t){if(this.__fired)throw new Error("Already fired!");var e=g(arguments);return this.normalizeResults&&(e=1===(e=e.slice(1)).length?e.pop():e),this.__errors[t]=e,this.__firedLength++,this.__firedLength===this.__defLength&&this.__resolve(),this.promise()}}});function w(t,e,r){var n=(new C).callback();return u(t,function(t){n=n.then(r?t:p(null,t)),r||(n=n.then(function(t){return e.push(t),e}))}),n}function b(t){return!c(t)&&f(t.then)}function E(t){var e;return(t=g(arguments)).length?1===t.length?b(t=t.pop())?t.addCallback&&t.addErrback?(e=new C,t.addCallback(e.callback),t.addErrback(e.errback)):e=function(t){var e=new C;return t.then(h(e,"callback"),h(e,"errback")),e.promise()}(t):e=l(t)&&r.every(t,b)?new _(t,!0).promise():(new C).callback(t):e=new _(r.map(t,function(t){return E(t)}),!0).promise():e=(new C).callback(t).promise(),e}function I(){return new C}return e.define({isPromiseLike:b}).expose({isPromiseLike:b,when:E,wrap:function(t,e){return function(){var r=new C,n=g(arguments);return n.push(r.resolve),t.apply(e||this,n),r.promise()}},wait:function(t,e){t=g(arguments);var r=!1;e=t.pop();var n=E(t);return function(){return r?E(e.apply(this,arguments)):(t=arguments,n.then(h(this,function(){return r=!0,e.apply(this,t)})))}},serial:function(t){if(l(t))return w(t,[],!1);throw new Error("When calling promise.serial the first argument must be an array")},chain:function(t){if(l(t))return w(t,[],!0);throw new Error("When calling promise.serial the first argument must be an array")},Promise:C,PromiseList:_,promise:I,defer:I,deferredList:function(t){return new _(t,!0).promise()},reject:function(t){return I().errback(t)},resolve:function(t){return I().callback(t)}})}void 0!==r?void 0!==e&&e.exports&&(e.exports=o(t("declare.js"),t("extended"),t("array-extended"),t("is-extended"),t("function-extended"),t("arguments-extended"))):"function"==typeof define&&define.amd?define(["declare","extended","array-extended","is-extended","function-extended","arguments-extended"],function(t,e,r,n,i,a){return o(t,e,r,n,i,a)}):this.promiseExtended=o(this.declare,this.extended,this.arrayExtended,this.isExtended,this.functionExtended,this.argumentsExtended)}).call(this)},{__browserify_process:64,"arguments-extended":51,"array-extended":52,"declare.js":55,extended:56,"function-extended":59,"is-extended":66}],70:[function(t,e,r){(function(){"use strict";function n(t,e,r,n){var o;"undefined"==typeof JSON?function(){function t(t){return t<10?"0"+t:t}var r=e.tester().isString().isNumber().isBoolean().tester();var n,i,a,s=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,u={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function c(t){return s.lastIndex=0,s.test(t)?'"'+t.replace(s,function(t){var e=u[t];return"string"==typeof e?e:"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+t+'"'}function l(o,s){var u,f,d,h,p,g,m=n,v=s[o];switch(v&&(g=v,v=e.isDate(g)?isFinite(g.valueOf())?g.getUTCFullYear()+"-"+t(g.getUTCMonth()+1)+"-"+t(g.getUTCDate())+"T"+t(g.getUTCHours())+":"+t(g.getUTCMinutes())+":"+t(g.getUTCSeconds())+"Z":null:r(g)?g.valueOf():g),"function"==typeof a&&(v=a.call(s,o,v)),typeof v){case"string":return c(v);case"number":return isFinite(v)?String(v):"null";case"boolean":case"null":return String(v);case"object":if(!v)return"null";if(n+=i,p=[],"[object Array]"===Object.prototype.toString.apply(v)){for(h=v.length,u=0;u<h;u+=1)p[u]=l(u,v)||"null";return d=0===p.length?"[]":n?"[\n"+n+p.join(",\n"+n)+"\n"+m+"]":"["+p.join(",")+"]",n=m,d}if(a&&"object"==typeof a)for(h=a.length,u=0;u<h;u+=1)"string"==typeof a[u]&&(d=l(f=a[u],v))&&p.push(c(f)+(n?": ":":")+d);else for(f in v)Object.prototype.hasOwnProperty.call(v,f)&&(d=l(f,v))&&p.push(c(f)+(n?": ":":")+d);return d=0===p.length?"{}":n?"{\n"+n+p.join(",\n"+n)+"\n"+m+"}":"{"+p.join(",")+"}",n=m,d}}o=function(t,e,r){var o;if(n="",i="","number"==typeof r)for(o=0;o<r;o+=1)i+=" ";else"string"==typeof r&&(i=r);if(a=e,e&&"function"!=typeof e&&("object"!=typeof e||"number"!=typeof e.length))throw new Error("JSON.stringify");return l("",{"":t})}}():o=JSON.stringify;var i=e.isHash,a=Array.prototype.slice,s=/%((?:-?\+?.?\d*)?|(?:\[[^\[|\]]*\]))?([sjdDZ])/g,u=/\{(?:\[([^\[|\]]*)\])?(\w+)\}/g,c=/(-?)(\+?)([A-Z|a-z|\W]?)([1-9][0-9]*)?$/,l=/([1-9][0-9]*)$/g;function f(t,e){var r=t;if(c.test(e)){var n=e.match(c),o=n[1],i=n[3],a=n[4];a&&(a=parseInt(a,10),r=r.length<a?g(r,a,i,o):m(r,a))}return r}function d(t,r){var n;if(!e.isNumber(t))throw new Error("stringExtended.format : when using %d the parameter must be a number!");if(n=""+t,c.test(r)){var o=r.match(c),i=o[1],a=o[2],s=o[3],u=o[4];a&&(n=(t>0?"+":"")+n),u&&(u=parseInt(u,10),n=n.length<u?g(n,u,s||"0",i):m(n,u))}return n}function h(t,e){var r,n=e.match(l),i=0;n&&(i=parseInt(n[0],10),isNaN(i)&&(i=0));try{r=o(t,null,i)}catch(e){throw new Error("stringExtended.format : Unable to parse json from ",t)}return r}var p={bold:1,bright:1,italic:3,underline:4,blink:5,inverse:7,crossedOut:9,red:31,green:32,yellow:33,blue:34,magenta:35,cyan:36,white:37,redBackground:41,greenBackground:42,yellowBackground:43,blueBackground:44,magentaBackground:45,cyanBackground:46,whiteBackground:47,encircled:52,overlined:53,grey:90,black:90};function g(t,e,r,n){t=""+t,r=r||" ";for(var o=t.length;o<e;)n?t+=r:t=r+t,o++;return t}function m(t,r,n){var o=t;if(e.isString(o)){if(t.length>r)if(n){var i=t.length;o=t.substring(i-r,i)}else o=t.substring(0,r)}else o=m(""+o,r);return o}function v(t,r){var n,o,i;if(r)if(e.isArray(t))for(n=[],o=0,i=t.length;o<i;o++)n.push(v(t[o],r));else if(r instanceof Array)for(n=t,o=0,i=r.length;o<i;o++)n=v(n,r[o]);else r in p&&(n="["+p[r]+"m"+t+"[0m");return n}var y={toArray:function(t,e){var r=[];return t&&(t.indexOf(e)>0?r=t.replace(/\s+/g,"").split(e):r.push(t)),r},pad:g,truncate:m,multiply:function(t,e){var r=[];if(e)for(var n=0;n<e;n++)r.push(t);return r.join("")},format:function t(n,c){if(c instanceof Array){var l=0,p=c.length;return n.replace(s,function(t,e,n){var i,a;if(!(l<p))return t;if(i=c[l++],"%s"===t||"%d"===t||"%D"===t)a=i+"";else if("%Z"===t)a=i.toUTCString();else if("%j"===t)try{a=o(i)}catch(t){throw new Error("stringExtended.format : Unable to parse json from ",i)}else switch(e=e.replace(/^\[|\]$/g,""),n){case"s":a=f(i,e);break;case"d":a=d(i,e);break;case"j":a=h(i,e);break;case"D":a=r.format(i,e);break;case"Z":a=r.format(i,e,!0)}return a})}return i(c)?n.replace(u,function(t,n,o){if(o=c[o],!e.isUndefined(o)){if(!n)return""+o;if(e.isString(o))return f(o,n);if(e.isNumber(o))return d(o,n);if(e.isDate(o))return r.format(o,n);if(e.isObject(o))return h(o,n)}return t}):t(n,a.call(arguments).slice(1))},style:v,escape:function(t,e){return t.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,function(t){return e&&-1!==n.indexOf(e,t)?t:"\\"+t})},trim:function(t){return t.replace(/^\s*|\s*$/g,"")},trimLeft:function(t){return t.replace(/^\s*/,"")},trimRight:function(t){return t.replace(/\s*$/,"")},isEmpty:function(t){return 0===t.length}};return t.define(e.isString,y).define(e.isArray,{style:v}).expose(y).expose({characters:{SMILEY:"",SOLID_SMILEY:"",HEART:"",DIAMOND:"",CLOVE:"",SPADE:"",DOT:"",SQUARE_CIRCLE:"",CIRCLE:"",FILLED_SQUARE_CIRCLE:"",MALE:"",FEMALE:"",EIGHT_NOTE:"",DOUBLE_EIGHTH_NOTE:"",SUN:"",PLAY:"",REWIND:"",UP_DOWN:"",PILCROW:"",SECTION:"",THICK_MINUS:"",SMALL_UP_DOWN:"",UP_ARROW:"",DOWN_ARROW:"",RIGHT_ARROW:"",LEFT_ARROW:"",RIGHT_ANGLE:"",LEFT_RIGHT_ARROW:"",TRIANGLE:"",DOWN_TRIANGLE:"",HOUSE:"",C_CEDILLA:"",U_UMLAUT:"",E_ACCENT:"",A_LOWER_CIRCUMFLEX:"",A_LOWER_UMLAUT:"",A_LOWER_GRAVE_ACCENT:"",A_LOWER_CIRCLE_OVER:"",C_LOWER_CIRCUMFLEX:"",E_LOWER_CIRCUMFLEX:"",E_LOWER_UMLAUT:"",E_LOWER_GRAVE_ACCENT:"",I_LOWER_UMLAUT:"",I_LOWER_CIRCUMFLEX:"",I_LOWER_GRAVE_ACCENT:"",A_UPPER_UMLAUT:"",A_UPPER_CIRCLE:"",E_UPPER_ACCENT:"",A_E_LOWER:"",A_E_UPPER:"",O_LOWER_CIRCUMFLEX:"",O_LOWER_UMLAUT:"",O_LOWER_GRAVE_ACCENT:"",U_LOWER_CIRCUMFLEX:"",U_LOWER_GRAVE_ACCENT:"",Y_LOWER_UMLAUT:"",O_UPPER_UMLAUT:"",U_UPPER_UMLAUT:"",CENTS:"",POUND:"",YEN:"",CURRENCY:"",PTS:"",FUNCTION:"",A_LOWER_ACCENT:"",I_LOWER_ACCENT:"",O_LOWER_ACCENT:"",U_LOWER_ACCENT:"",N_LOWER_TILDE:"",N_UPPER_TILDE:"",A_SUPER:"",O_SUPER:"",UPSIDEDOWN_QUESTION:"",SIDEWAYS_L:"",NEGATION:"",ONE_HALF:"",ONE_FOURTH:"",UPSIDEDOWN_EXCLAMATION:"",DOUBLE_LEFT:"",DOUBLE_RIGHT:"",LIGHT_SHADED_BOX:"",MEDIUM_SHADED_BOX:"",DARK_SHADED_BOX:"",VERTICAL_LINE:"",MAZE__SINGLE_RIGHT_T:"",MAZE_SINGLE_RIGHT_TOP:"",MAZE_SINGLE_RIGHT_BOTTOM_SMALL:"",MAZE_SINGLE_LEFT_TOP_SMALL:"",MAZE_SINGLE_LEFT_BOTTOM_SMALL:"",MAZE_SINGLE_LEFT_T:"",MAZE_SINGLE_BOTTOM_T:"",MAZE_SINGLE_TOP_T:"",MAZE_SINGLE_CENTER:"",MAZE_SINGLE_HORIZONTAL_LINE:"",MAZE_SINGLE_RIGHT_DOUBLECENTER_T:"",MAZE_SINGLE_RIGHT_DOUBLE_BL:"",MAZE_SINGLE_RIGHT_DOUBLE_T:"",MAZE_SINGLE_RIGHT_DOUBLEBOTTOM_TOP:"",MAZE_SINGLE_RIGHT_DOUBLELEFT_TOP:"",MAZE_SINGLE_LEFT_DOUBLE_T:"",MAZE_SINGLE_BOTTOM_DOUBLE_T:"",MAZE_SINGLE_TOP_DOUBLE_T:"",MAZE_SINGLE_TOP_DOUBLECENTER_T:"",MAZE_SINGLE_BOTTOM_DOUBLECENTER_T:"",MAZE_SINGLE_LEFT_DOUBLERIGHT_BOTTOM:"",MAZE_SINGLE_LEFT_DOUBLERIGHT_TOP:"",MAZE_SINGLE_LEFT_DOUBLEBOTTOM_TOP:"",MAZE_SINGLE_LEFT_DOUBLETOP_BOTTOM:"",MAZE_SINGLE_LEFT_TOP:"",MAZE_SINGLE_RIGHT_BOTTOM:"",MAZE_SINGLE_LEFT_CENTER:"",MAZE_SINGLE_DOUBLECENTER_CENTER:"",MAZE_SINGLE_DOUBLECROSS_CENTER:"",MAZE_DOUBLE_LEFT_CENTER:"",MAZE_DOUBLE_VERTICAL:"",MAZE_DOUBLE_RIGHT_TOP:"",MAZE_DOUBLE_RIGHT_BOTTOM:"",MAZE_DOUBLE_LEFT_BOTTOM:"",MAZE_DOUBLE_LEFT_TOP:"",MAZE_DOUBLE_BOTTOM_T:"",MAZE_DOUBLE_TOP_T:"",MAZE_DOUBLE_LEFT_T:"",MAZE_DOUBLE_HORIZONTAL:"",MAZE_DOUBLE_CROSS:"",SOLID_RECTANGLE:"",THICK_LEFT_VERTICAL:"",THICK_RIGHT_VERTICAL:"",SOLID_SMALL_RECTANGLE_BOTTOM:"",SOLID_SMALL_RECTANGLE_TOP:"",PHI_UPPER:"",INFINITY:"",INTERSECTION:"",DEFINITION:"",PLUS_MINUS:"",GT_EQ:"",LT_EQ:"",THEREFORE:"",SINCE:"",DOESNOT_EXIST:"",EXISTS:"",FOR_ALL:"",EXCLUSIVE_OR:"",BECAUSE:"",DIVIDE:"",APPROX:"",DEGREE:"",BOLD_DOT:"",DOT_SMALL:"",CHECK:"",ITALIC_X:"",SUPER_N:"",SQUARED:"",CUBED:"",SOLID_BOX:"",PERMILE:"",REGISTERED_TM:"",COPYRIGHT:"",TRADEMARK:"",BETA:"",GAMMA:"",ZETA:"",ETA:"",IOTA:"",KAPPA:"",LAMBDA:"",NU:"",XI:"",OMICRON:"",RHO:"",UPSILON:"",CHI_LOWER:"",CHI_UPPER:"",PSI:"",ALPHA:"",ESZETT:"",PI:"",SIGMA_UPPER:"",SIGMA_LOWER:"",MU:"",TAU:"",THETA:"",OMEGA:"",DELTA:"",PHI_LOWER:"",EPSILON:""}})}void 0!==r?void 0!==e&&e.exports&&(e.exports=n(t("extended"),t("is-extended"),t("date-extended"),t("array-extended"))):"function"==typeof define&&define.amd?define(["extended","is-extended","date-extended","array-extended"],function(t,e,r,o){return n(t,e,r,o)}):this.stringExtended=n(this.extended,this.isExtended,this.dateExtended,this.arrayExtended)}).call(this)},{"array-extended":52,"date-extended":53,extended:56,"is-extended":66}]},{},[1]),function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).b2wgincart=t()}}(function(){var define,module,exports;return function(){return function t(e,r,n){function o(a,s){if(!r[a]){if(!e[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(i)return i(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var l=r[a]={exports:{}};e[a][0].call(l.exports,function(t){return o(e[a][1][t]||t)},l,l.exports,t,e,r,n)}return r[a].exports}for(var i="function"==typeof require&&require,a=0;a<n.length;a++)o(n[a]);return o}}()({1:[function(t,e,r){var n=function(e){if(!("undefined"!=typeof window&&"[object Window]"==={}.toString.call(window))&&wslog)return wslog.setDefaultLevel=function(t){},wslog.setLevel=function(t){},wslog;var r,n=t("loglevel");return(r="function"==typeof n?new n:n).setDefaultLevel(r.levels.SILENT),r.startTimer=function(t){return t||(t="dummy_"+(new Date).getTime()),r.getLevel()===r.levels.INFO&&console.time(t),{currentLabel:t,done:function(t){r.getLevel()===r.levels.INFO&&console.timeEnd(this.currentLabel)}}},r}();e.exports=n},{loglevel:2}],2:[function(t,e,r){!function(t,r){"use strict";"function"==typeof define&&define.amd?define(r):"object"==typeof e&&e.exports?e.exports=r():t.log=r()}(this,function(){"use strict";var t=function(){},e="undefined",r=["trace","debug","info","warn","error"];function n(t,e){var r=t[e];if("function"==typeof r.bind)return r.bind(t);try{return Function.prototype.bind.call(r,t)}catch(e){return function(){return Function.prototype.apply.apply(r,[t,arguments])}}}function o(e,n){for(var o=0;o<r.length;o++){var i=r[o];this[i]=o<e?t:this.methodFactory(i,e,n)}this.log=this.debug}function i(r,i,a){return function(r){return"debug"===r&&(r="log"),typeof console!==e&&(void 0!==console[r]?n(console,r):void 0!==console.log?n(console,"log"):t)}(r)||function(t,r,n){return function(){typeof console!==e&&(o.call(this,r,n),this[t].apply(this,arguments))}}.apply(this,arguments)}function a(t,n,a){var s,u=this,c="loglevel";function l(){var t;if(typeof window!==e){try{t=window.localStorage[c]}catch(t){}if(typeof t===e)try{var r=window.document.cookie,n=r.indexOf(encodeURIComponent(c)+"=");-1!==n&&(t=/^([^;]+)/.exec(r.slice(n))[1])}catch(t){}return void 0===u.levels[t]&&(t=void 0),t}}t&&(c+=":"+t),u.name=t,u.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},u.methodFactory=a||i,u.getLevel=function(){return s},u.setLevel=function(n,i){if("string"==typeof n&&void 0!==u.levels[n.toUpperCase()]&&(n=u.levels[n.toUpperCase()]),!("number"==typeof n&&n>=0&&n<=u.levels.SILENT))throw"log.setLevel() called with invalid level: "+n;if(s=n,!1!==i&&function(t){var n=(r[t]||"silent").toUpperCase();if(typeof window!==e){try{return void(window.localStorage[c]=n)}catch(t){}try{window.document.cookie=encodeURIComponent(c)+"="+n+";"}catch(t){}}}(n),o.call(u,n,t),typeof console===e&&n<u.levels.SILENT)return"No console available for logging"},u.setDefaultLevel=function(t){l()||u.setLevel(t,!1)},u.enableAll=function(t){u.setLevel(u.levels.TRACE,t)},u.disableAll=function(t){u.setLevel(u.levels.SILENT,t)};var f=l();null==f&&(f=null==n?"WARN":n),u.setLevel(f,!1)}var s=new a,u={};s.getLogger=function(t){if("string"!=typeof t||""===t)throw new TypeError("You must supply a name when creating a logger.");var e=u[t];return e||(e=u[t]=new a(t,s.getLevel(),s.methodFactory)),e};var c=typeof window!==e?window.log:void 0;return s.noConflict=function(){return typeof window!==e&&window.log===s&&(window.log=c),s},s.getLoggers=function(){return u},s})},{}],3:[function(t,e,r){(function(t){!function(){var n="object"==typeof self&&self.self===self&&self||"object"==typeof t&&t.global===t&&t||this||{},o=n._,i=Array.prototype,a=Object.prototype,s="undefined"!=typeof Symbol?Symbol.prototype:null,u=i.push,c=i.slice,l=a.toString,f=a.hasOwnProperty,d=Array.isArray,h=Object.keys,p=Object.create,g=function(){},m=function(t){return t instanceof m?t:this instanceof m?void(this._wrapped=t):new m(t)};void 0===r||r.nodeType?n._=m:(void 0!==e&&!e.nodeType&&e.exports&&(r=e.exports=m),r._=m),m.VERSION="1.9.1";var v,y=function(t,e,r){if(void 0===e)return t;switch(null==r?3:r){case 1:return function(r){return t.call(e,r)};case 3:return function(r,n,o){return t.call(e,r,n,o)};case 4:return function(r,n,o,i){return t.call(e,r,n,o,i)}}return function(){return t.apply(e,arguments)}},x=function(t,e,r){return m.iteratee!==v?m.iteratee(t,e):null==t?m.identity:m.isFunction(t)?y(t,e,r):m.isObject(t)&&!m.isArray(t)?m.matcher(t):m.property(t)};m.iteratee=v=function(t,e){return x(t,e,1/0)};var C=function(t,e){return e=null==e?t.length-1:+e,function(){for(var r=Math.max(arguments.length-e,0),n=Array(r),o=0;o<r;o++)n[o]=arguments[o+e];switch(e){case 0:return t.call(this,n);case 1:return t.call(this,arguments[0],n);case 2:return t.call(this,arguments[0],arguments[1],n)}var i=Array(e+1);for(o=0;o<e;o++)i[o]=arguments[o];return i[e]=n,t.apply(this,i)}},_=function(t){if(!m.isObject(t))return{};if(p)return p(t);g.prototype=t;var e=new g;return g.prototype=null,e},w=function(t){return function(e){return null==e?void 0:e[t]}},b=function(t,e){return null!=t&&f.call(t,e)},E=function(t,e){for(var r=e.length,n=0;n<r;n++){if(null==t)return;t=t[e[n]]}return r?t:void 0},I=Math.pow(2,53)-1,O=w("length"),M=function(t){var e=O(t);return"number"==typeof e&&e>=0&&e<=I};m.each=m.forEach=function(t,e,r){var n,o;if(e=y(e,r),M(t))for(n=0,o=t.length;n<o;n++)e(t[n],n,t);else{var i=m.keys(t);for(n=0,o=i.length;n<o;n++)e(t[i[n]],i[n],t)}return t},m.map=m.collect=function(t,e,r){e=x(e,r);for(var n=!M(t)&&m.keys(t),o=(n||t).length,i=Array(o),a=0;a<o;a++){var s=n?n[a]:a;i[a]=e(t[s],s,t)}return i};var S=function(t){return function(e,r,n,o){var i=arguments.length>=3;return function(e,r,n,o){var i=!M(e)&&m.keys(e),a=(i||e).length,s=t>0?0:a-1;for(o||(n=e[i?i[s]:s],s+=t);s>=0&&s<a;s+=t){var u=i?i[s]:s;n=r(n,e[u],u,e)}return n}(e,y(r,o,4),n,i)}};m.reduce=m.foldl=m.inject=S(1),m.reduceRight=m.foldr=S(-1),m.find=m.detect=function(t,e,r){var n=(M(t)?m.findIndex:m.findKey)(t,e,r);if(void 0!==n&&-1!==n)return t[n]},m.filter=m.select=function(t,e,r){var n=[];return e=x(e,r),m.each(t,function(t,r,o){e(t,r,o)&&n.push(t)}),n},m.reject=function(t,e,r){return m.filter(t,m.negate(x(e)),r)},m.every=m.all=function(t,e,r){e=x(e,r);for(var n=!M(t)&&m.keys(t),o=(n||t).length,i=0;i<o;i++){var a=n?n[i]:i;if(!e(t[a],a,t))return!1}return!0},m.some=m.any=function(t,e,r){e=x(e,r);for(var n=!M(t)&&m.keys(t),o=(n||t).length,i=0;i<o;i++){var a=n?n[i]:i;if(e(t[a],a,t))return!0}return!1},m.contains=m.includes=m.include=function(t,e,r,n){return M(t)||(t=m.values(t)),("number"!=typeof r||n)&&(r=0),m.indexOf(t,e,r)>=0},m.invoke=C(function(t,e,r){var n,o;return m.isFunction(e)?o=e:m.isArray(e)&&(n=e.slice(0,-1),e=e[e.length-1]),m.map(t,function(t){var i=o;if(!i){if(n&&n.length&&(t=E(t,n)),null==t)return;i=t[e]}return null==i?i:i.apply(t,r)})}),m.pluck=function(t,e){return m.map(t,m.property(e))},m.where=function(t,e){return m.filter(t,m.matcher(e))},m.findWhere=function(t,e){return m.find(t,m.matcher(e))},m.max=function(t,e,r){var n,o,i=-1/0,a=-1/0;if(null==e||"number"==typeof e&&"object"!=typeof t[0]&&null!=t)for(var s=0,u=(t=M(t)?t:m.values(t)).length;s<u;s++)null!=(n=t[s])&&n>i&&(i=n);else e=x(e,r),m.each(t,function(t,r,n){((o=e(t,r,n))>a||o===-1/0&&i===-1/0)&&(i=t,a=o)});return i},m.min=function(t,e,r){var n,o,i=1/0,a=1/0;if(null==e||"number"==typeof e&&"object"!=typeof t[0]&&null!=t)for(var s=0,u=(t=M(t)?t:m.values(t)).length;s<u;s++)null!=(n=t[s])&&n<i&&(i=n);else e=x(e,r),m.each(t,function(t,r,n){((o=e(t,r,n))<a||o===1/0&&i===1/0)&&(i=t,a=o)});return i},m.shuffle=function(t){return m.sample(t,1/0)},m.sample=function(t,e,r){if(null==e||r)return M(t)||(t=m.values(t)),t[m.random(t.length-1)];var n=M(t)?m.clone(t):m.values(t),o=O(n);e=Math.max(Math.min(e,o),0);for(var i=o-1,a=0;a<e;a++){var s=m.random(a,i),u=n[a];n[a]=n[s],n[s]=u}return n.slice(0,e)},m.sortBy=function(t,e,r){var n=0;return e=x(e,r),m.pluck(m.map(t,function(t,r,o){return{value:t,index:n++,criteria:e(t,r,o)}}).sort(function(t,e){var r=t.criteria,n=e.criteria;if(r!==n){if(r>n||void 0===r)return 1;if(r<n||void 0===n)return-1}return t.index-e.index}),"value")};var A=function(t,e){return function(r,n,o){var i=e?[[],[]]:{};return n=x(n,o),m.each(r,function(e,o){var a=n(e,o,r);t(i,e,a)}),i}};m.groupBy=A(function(t,e,r){b(t,r)?t[r].push(e):t[r]=[e]}),m.indexBy=A(function(t,e,r){t[r]=e}),m.countBy=A(function(t,e,r){b(t,r)?t[r]++:t[r]=1});var k=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;m.toArray=function(t){return t?m.isArray(t)?c.call(t):m.isString(t)?t.match(k):M(t)?m.map(t,m.identity):m.values(t):[]},m.size=function(t){return null==t?0:M(t)?t.length:m.keys(t).length},m.partition=A(function(t,e,r){t[r?0:1].push(e)},!0),m.first=m.head=m.take=function(t,e,r){return null==t||t.length<1?null==e?void 0:[]:null==e||r?t[0]:m.initial(t,t.length-e)},m.initial=function(t,e,r){return c.call(t,0,Math.max(0,t.length-(null==e||r?1:e)))},m.last=function(t,e,r){return null==t||t.length<1?null==e?void 0:[]:null==e||r?t[t.length-1]:m.rest(t,Math.max(0,t.length-e))},m.rest=m.tail=m.drop=function(t,e,r){return c.call(t,null==e||r?1:e)},m.compact=function(t){return m.filter(t,Boolean)};var T=function(t,e,r,n){for(var o=(n=n||[]).length,i=0,a=O(t);i<a;i++){var s=t[i];if(M(s)&&(m.isArray(s)||m.isArguments(s)))if(e)for(var u=0,c=s.length;u<c;)n[o++]=s[u++];else T(s,e,r,n),o=n.length;else r||(n[o++]=s)}return n};m.flatten=function(t,e){return T(t,e,!1)},m.without=C(function(t,e){return m.difference(t,e)}),m.uniq=m.unique=function(t,e,r,n){m.isBoolean(e)||(n=r,r=e,e=!1),null!=r&&(r=x(r,n));for(var o=[],i=[],a=0,s=O(t);a<s;a++){var u=t[a],c=r?r(u,a,t):u;e&&!r?(a&&i===c||o.push(u),i=c):r?m.contains(i,c)||(i.push(c),o.push(u)):m.contains(o,u)||o.push(u)}return o},m.union=C(function(t){return m.uniq(T(t,!0,!0))}),m.intersection=function(t){for(var e=[],r=arguments.length,n=0,o=O(t);n<o;n++){var i=t[n];if(!m.contains(e,i)){var a;for(a=1;a<r&&m.contains(arguments[a],i);a++);a===r&&e.push(i)}}return e},m.difference=C(function(t,e){return e=T(e,!0,!0),m.filter(t,function(t){return!m.contains(e,t)})}),m.unzip=function(t){for(var e=t&&m.max(t,O).length||0,r=Array(e),n=0;n<e;n++)r[n]=m.pluck(t,n);return r},m.zip=C(m.unzip),m.object=function(t,e){for(var r={},n=0,o=O(t);n<o;n++)e?r[t[n]]=e[n]:r[t[n][0]]=t[n][1];return r};var P=function(t){return function(e,r,n){r=x(r,n);for(var o=O(e),i=t>0?0:o-1;i>=0&&i<o;i+=t)if(r(e[i],i,e))return i;return-1}};m.findIndex=P(1),m.findLastIndex=P(-1),m.sortedIndex=function(t,e,r,n){for(var o=(r=x(r,n,1))(e),i=0,a=O(t);i<a;){var s=Math.floor((i+a)/2);r(t[s])<o?i=s+1:a=s}return i};var L=function(t,e,r){return function(n,o,i){var a=0,s=O(n);if("number"==typeof i)t>0?a=i>=0?i:Math.max(i+s,a):s=i>=0?Math.min(i+1,s):i+s+1;else if(r&&i&&s)return n[i=r(n,o)]===o?i:-1;if(o!=o)return(i=e(c.call(n,a,s),m.isNaN))>=0?i+a:-1;for(i=t>0?a:s-1;i>=0&&i<s;i+=t)if(n[i]===o)return i;return-1}};m.indexOf=L(1,m.findIndex,m.sortedIndex),m.lastIndexOf=L(-1,m.findLastIndex),m.range=function(t,e,r){null==e&&(e=t||0,t=0),r||(r=e<t?-1:1);for(var n=Math.max(Math.ceil((e-t)/r),0),o=Array(n),i=0;i<n;i++,t+=r)o[i]=t;return o},m.chunk=function(t,e){if(null==e||e<1)return[];for(var r=[],n=0,o=t.length;n<o;)r.push(c.call(t,n,n+=e));return r};var N=function(t,e,r,n,o){if(!(n instanceof e))return t.apply(r,o);var i=_(t.prototype),a=t.apply(i,o);return m.isObject(a)?a:i};m.bind=C(function(t,e,r){if(!m.isFunction(t))throw new TypeError("Bind must be called on a function");var n=C(function(o){return N(t,n,e,this,r.concat(o))});return n}),m.partial=C(function(t,e){var r=m.partial.placeholder,n=function(){for(var o=0,i=e.length,a=Array(i),s=0;s<i;s++)a[s]=e[s]===r?arguments[o++]:e[s];for(;o<arguments.length;)a.push(arguments[o++]);return N(t,n,this,this,a)};return n}),m.partial.placeholder=m,m.bindAll=C(function(t,e){var r=(e=T(e,!1,!1)).length;if(r<1)throw new Error("bindAll must be passed function names");for(;r--;){var n=e[r];t[n]=m.bind(t[n],t)}}),m.memoize=function(t,e){var r=function(n){var o=r.cache,i=""+(e?e.apply(this,arguments):n);return b(o,i)||(o[i]=t.apply(this,arguments)),o[i]};return r.cache={},r},m.delay=C(function(t,e,r){return setTimeout(function(){return t.apply(null,r)},e)}),m.defer=m.partial(m.delay,m,1),m.throttle=function(t,e,r){var n,o,i,a,s=0;r||(r={});var u=function(){s=!1===r.leading?0:m.now(),n=null,a=t.apply(o,i),n||(o=i=null)},c=function(){var c=m.now();s||!1!==r.leading||(s=c);var l=e-(c-s);return o=this,i=arguments,l<=0||l>e?(n&&(clearTimeout(n),n=null),s=c,a=t.apply(o,i),n||(o=i=null)):n||!1===r.trailing||(n=setTimeout(u,l)),a};return c.cancel=function(){clearTimeout(n),s=0,n=o=i=null},c},m.debounce=function(t,e,r){var n,o,i=function(e,r){n=null,r&&(o=t.apply(e,r))},a=C(function(a){if(n&&clearTimeout(n),r){var s=!n;n=setTimeout(i,e),s&&(o=t.apply(this,a))}else n=m.delay(i,e,this,a);return o});return a.cancel=function(){clearTimeout(n),n=null},a},m.wrap=function(t,e){return m.partial(e,t)},m.negate=function(t){return function(){return!t.apply(this,arguments)}},m.compose=function(){var t=arguments,e=t.length-1;return function(){for(var r=e,n=t[e].apply(this,arguments);r--;)n=t[r].call(this,n);return n}},m.after=function(t,e){return function(){if(--t<1)return e.apply(this,arguments)}},m.before=function(t,e){var r;return function(){return--t>0&&(r=e.apply(this,arguments)),t<=1&&(e=null),r}},m.once=m.partial(m.before,2),m.restArguments=C;var R=!{toString:null}.propertyIsEnumerable("toString"),F=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],D=function(t,e){var r=F.length,n=t.constructor,o=m.isFunction(n)&&n.prototype||a,i="constructor";for(b(t,i)&&!m.contains(e,i)&&e.push(i);r--;)(i=F[r])in t&&t[i]!==o[i]&&!m.contains(e,i)&&e.push(i)};m.keys=function(t){if(!m.isObject(t))return[];if(h)return h(t);var e=[];for(var r in t)b(t,r)&&e.push(r);return R&&D(t,e),e},m.allKeys=function(t){if(!m.isObject(t))return[];var e=[];for(var r in t)e.push(r);return R&&D(t,e),e},m.values=function(t){for(var e=m.keys(t),r=e.length,n=Array(r),o=0;o<r;o++)n[o]=t[e[o]];return n},m.mapObject=function(t,e,r){e=x(e,r);for(var n=m.keys(t),o=n.length,i={},a=0;a<o;a++){var s=n[a];i[s]=e(t[s],s,t)}return i},m.pairs=function(t){for(var e=m.keys(t),r=e.length,n=Array(r),o=0;o<r;o++)n[o]=[e[o],t[e[o]]];return n},m.invert=function(t){for(var e={},r=m.keys(t),n=0,o=r.length;n<o;n++)e[t[r[n]]]=r[n];return e},m.functions=m.methods=function(t){var e=[];for(var r in t)m.isFunction(t[r])&&e.push(r);return e.sort()};var j=function(t,e){return function(r){var n=arguments.length;if(e&&(r=Object(r)),n<2||null==r)return r;for(var o=1;o<n;o++)for(var i=arguments[o],a=t(i),s=a.length,u=0;u<s;u++){var c=a[u];e&&void 0!==r[c]||(r[c]=i[c])}return r}};m.extend=j(m.allKeys),m.extendOwn=m.assign=j(m.keys),m.findKey=function(t,e,r){e=x(e,r);for(var n,o=m.keys(t),i=0,a=o.length;i<a;i++)if(e(t[n=o[i]],n,t))return n};var B,U,G=function(t,e,r){return e in r};m.pick=C(function(t,e){var r={},n=e[0];if(null==t)return r;m.isFunction(n)?(e.length>1&&(n=y(n,e[1])),e=m.allKeys(t)):(n=G,e=T(e,!1,!1),t=Object(t));for(var o=0,i=e.length;o<i;o++){var a=e[o],s=t[a];n(s,a,t)&&(r[a]=s)}return r}),m.omit=C(function(t,e){var r,n=e[0];return m.isFunction(n)?(n=m.negate(n),e.length>1&&(r=e[1])):(e=m.map(T(e,!1,!1),String),n=function(t,r){return!m.contains(e,r)}),m.pick(t,n,r)}),m.defaults=j(m.allKeys,!0),m.create=function(t,e){var r=_(t);return e&&m.extendOwn(r,e),r},m.clone=function(t){return m.isObject(t)?m.isArray(t)?t.slice():m.extend({},t):t},m.tap=function(t,e){return e(t),t},m.isMatch=function(t,e){var r=m.keys(e),n=r.length;if(null==t)return!n;for(var o=Object(t),i=0;i<n;i++){var a=r[i];if(e[a]!==o[a]||!(a in o))return!1}return!0},B=function(t,e,r,n){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return!1;if(t!=t)return e!=e;var o=typeof t;return("function"===o||"object"===o||"object"==typeof e)&&U(t,e,r,n)},U=function(t,e,r,n){t instanceof m&&(t=t._wrapped),e instanceof m&&(e=e._wrapped);var o=l.call(t);if(o!==l.call(e))return!1;switch(o){case"[object RegExp]":case"[object String]":return""+t==""+e;case"[object Number]":return+t!=+t?+e!=+e:0==+t?1/+t==1/e:+t==+e;case"[object Date]":case"[object Boolean]":return+t==+e;case"[object Symbol]":return s.valueOf.call(t)===s.valueOf.call(e)}var i="[object Array]"===o;if(!i){if("object"!=typeof t||"object"!=typeof e)return!1;var a=t.constructor,u=e.constructor;if(a!==u&&!(m.isFunction(a)&&a instanceof a&&m.isFunction(u)&&u instanceof u)&&"constructor"in t&&"constructor"in e)return!1}r=r||[],n=n||[];for(var c=r.length;c--;)if(r[c]===t)return n[c]===e;if(r.push(t),n.push(e),i){if((c=t.length)!==e.length)return!1;for(;c--;)if(!B(t[c],e[c],r,n))return!1}else{var f,d=m.keys(t);if(c=d.length,m.keys(e).length!==c)return!1;for(;c--;)if(f=d[c],!b(e,f)||!B(t[f],e[f],r,n))return!1}return r.pop(),n.pop(),!0},m.isEqual=function(t,e){return B(t,e)},m.isEmpty=function(t){return null==t||(M(t)&&(m.isArray(t)||m.isString(t)||m.isArguments(t))?0===t.length:0===m.keys(t).length)},m.isElement=function(t){return!(!t||1!==t.nodeType)},m.isArray=d||function(t){return"[object Array]"===l.call(t)},m.isObject=function(t){var e=typeof t;return"function"===e||"object"===e&&!!t},m.each(["Arguments","Function","String","Number","Date","RegExp","Error","Symbol","Map","WeakMap","Set","WeakSet"],function(t){m["is"+t]=function(e){return l.call(e)==="[object "+t+"]"}}),m.isArguments(arguments)||(m.isArguments=function(t){return b(t,"callee")});var q=n.document&&n.document.childNodes;"function"!=typeof/./&&"object"!=typeof Int8Array&&"function"!=typeof q&&(m.isFunction=function(t){return"function"==typeof t||!1}),m.isFinite=function(t){return!m.isSymbol(t)&&isFinite(t)&&!isNaN(parseFloat(t))},m.isNaN=function(t){return m.isNumber(t)&&isNaN(t)},m.isBoolean=function(t){return!0===t||!1===t||"[object Boolean]"===l.call(t)},m.isNull=function(t){return null===t},m.isUndefined=function(t){return void 0===t},m.has=function(t,e){if(!m.isArray(e))return b(t,e);for(var r=e.length,n=0;n<r;n++){var o=e[n];if(null==t||!f.call(t,o))return!1;t=t[o]}return!!r},m.noConflict=function(){return n._=o,this},m.identity=function(t){return t},m.constant=function(t){return function(){return t}},m.noop=function(){},m.property=function(t){return m.isArray(t)?function(e){return E(e,t)}:w(t)},m.propertyOf=function(t){return null==t?function(){}:function(e){return m.isArray(e)?E(t,e):t[e]}},m.matcher=m.matches=function(t){return t=m.extendOwn({},t),function(e){return m.isMatch(e,t)}},m.times=function(t,e,r){var n=Array(Math.max(0,t));e=y(e,r,1);for(var o=0;o<t;o++)n[o]=e(o);return n},m.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))},m.now=Date.now||function(){return(new Date).getTime()};var V={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},H=m.invert(V),W=function(t){var e=function(e){return t[e]},r="(?:"+m.keys(t).join("|")+")",n=RegExp(r),o=RegExp(r,"g");return function(t){return t=null==t?"":""+t,n.test(t)?t.replace(o,e):t}};m.escape=W(V),m.unescape=W(H),m.result=function(t,e,r){m.isArray(e)||(e=[e]);var n=e.length;if(!n)return m.isFunction(r)?r.call(t):r;for(var o=0;o<n;o++){var i=null==t?void 0:t[e[o]];void 0===i&&(i=r,o=n),t=m.isFunction(i)?i.call(t):i}return t};var $=0;m.uniqueId=function(t){var e=++$+"";return t?t+e:e},m.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var z=/(.)^/,Z={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},J=/\\|'|\r|\n|\u2028|\u2029/g,X=function(t){return"\\"+Z[t]};m.template=function(t,e,r){!e&&r&&(e=r),e=m.defaults({},e,m.templateSettings);var n,o=RegExp([(e.escape||z).source,(e.interpolate||z).source,(e.evaluate||z).source].join("|")+"|$","g"),i=0,a="__p+='";t.replace(o,function(e,r,n,o,s){return a+=t.slice(i,s).replace(J,X),i=s+e.length,r?a+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'":n?a+="'+\n((__t=("+n+"))==null?'':__t)+\n'":o&&(a+="';\n"+o+"\n__p+='"),e}),a+="';\n",e.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{n=new Function(e.variable||"obj","_",a)}catch(t){throw t.source=a,t}var s=function(t){return n.call(this,t,m)},u=e.variable||"obj";return s.source="function("+u+"){\n"+a+"}",s},m.chain=function(t){var e=m(t);return e._chain=!0,e};var Y=function(t,e){return t._chain?m(e).chain():e};m.mixin=function(t){return m.each(m.functions(t),function(e){var r=m[e]=t[e];m.prototype[e]=function(){var t=[this._wrapped];return u.apply(t,arguments),Y(this,r.apply(m,t))}}),m},m.mixin(m),m.each(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=i[t];m.prototype[t]=function(){var r=this._wrapped;return e.apply(r,arguments),"shift"!==t&&"splice"!==t||0!==r.length||delete r[0],Y(this,r)}}),m.each(["concat","join","slice"],function(t){var e=i[t];m.prototype[t]=function(){return Y(this,e.apply(this._wrapped,arguments))}}),m.prototype.value=function(){return this._wrapped},m.prototype.valueOf=m.prototype.toJSON=m.prototype.value,m.prototype.toString=function(){return String(this._wrapped)},"function"==typeof define&&define.amd&&define("underscore",[],function(){return m})}()}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],4:[function(t,e,r){e.exports=function(t){var e=t;return{add:function(t){e.assert(t)},remove:function(t){e.retract(t)},clearSession:function(){for(var t=e,r=t.getFacts(),n=0,o=r.length;n<o;n++)t.retract(r[n])},createAndAdd:function(t,r){var n;return n="string"!=r.toLowerCase()?new(0,this.classDefinitions[r.toLowerCase()])(t):t,e.assert(n),n},modify:function(t){e.modify(t)},changeCatalog:function(){var t,r=e,n=[];for(var o in r.classDefinitions)if("order"!=o&&"account"!=o){t=this.classDefinitions[o];var i=r.getFacts(t);i.length>0&&n.push.apply(n,i)}for(var a=0,s=n.length;a<s;a++)r.retract(n[a])},removeCurrentItems:function(t){(new Date).getTime();var e={debug:!1,grouprules:["agCleanCatalog"]};if(void 0!=t){if(t.constructor!==Array)throw new Error("list of events must be an array!");e.events=t}var r=this;return new Promise(function(t,n){r.fire(e,function(e){void 0==e.err?t(e):n(e)})})},addToCart:function(t){(new Date).getTime();var e={debug:!1,grouprules:["agAddToCart","agCheckCart","agEligibility","agTotalCart"]};if(void 0!=t){if(t.constructor!==Array)throw new Error("list of events must be an array!");e.events=t}var r=this;return new Promise(function(t,n){r.fire(e,function(e){void 0==e.err?t(e):n(e)})})},eligibility:function(t){(new Date).getTime();var e={debug:!1,grouprules:["agEligibility"]};if(void 0!=t){if(t.constructor!==Array)throw new Error("list of events must be an array!");e.events=t}var r=this;return new Promise(function(t,n){r.fire(e,function(e){void 0==e.err?t(e):n(e)})})},removeFromCart:function(t){(new Date).getTime();var e={debug:!1,grouprules:["agResetStatus","agAddToCart","agCheckCart","agEligibility","agTotalCart"]};if(void 0!=t){if(t.constructor!==Array)throw new Error("list of events must be an array!");e.events=t}var r=this;return new Promise(function(t,n){r.fire(e,function(e){void 0==e.err?t(e):n(e)})})},retrieveCurrentFacts:function(){var t=this.classDefinitions,r=e,n={};for(k in t)"object"!==k&&r.getFacts(t[k]).length>0&&(n[k]=r.getFacts(t[k]));return n},fire:function(t,r){t&&t.debug&&console.log("----- init call -----");var n={eventResults:{}},o=e,i=this.classDefinitions;if(delete o._events,t&&t.grouprules)for(var a=t.grouprules.length-1;a>=0;a--){var s=t.grouprules[a];t&&t.debug&&console.log("[b2wgin log] Set focus on group of rules [ "+s+" ]"),o.focus(s)}function u(e){o.on(e,function(r){t&&t.debug&&console.log("[b2wgin log] "+e+" event caught!"),n.eventResults[e].push(r)})}if(t&&t.events)for(var c=0;c<t.events.length;c++){var l=t.events[c];n.eventResults[l]=[],t&&t.debug&&console.log("[b2wgin log] setting listener to ["+l+"]"),u(l)}if(t&&t.debug&&o.on("fire",function(e,r){t&&t.debug&&console.log("[b2wgin log] "+e+" fired!")}),void 0==r)return t&&t.debug&&console.log("----- end call -----"),o.match();o.match().then(function(){var e=o.getFacts();for(c in n.matches=e,n.matches={},i)"object"!==c&&o.getFacts(i[c]).length>0&&(n.matches[c]=o.getFacts(i[c]));if(t&&void 0!=t.debug&&"verbose"==t.debug&&console.log(JSON.stringify(n.matches)),void 0!=t&&void 0!=t.persist&&0==t.persist)for(var a=o.getFacts(),s=0;s<a.length;s++)o.retract(a[s]);t&&t.debug&&console.log("----- end call -----"),r(n)},function(t){console.log("[b2wgin log] Error in analyzing rules.. "+t),n.err=t,r(n)})}}}},{}],5:[function(require,module,exports){"use strict";var b2wgin_cart=function(_initConfig){var CurrentContext=require("./currentContext.js"),cbResponse=require("./callbackResponse.js"),b2wgindatainterceptor=require("./interceptor.js"),isBrowser="undefined"!=typeof window&&"[object Window]"==={}.toString.call(window),currentContext=new CurrentContext,catalogEngine,wslog=require("./logging.js"),logMessage=function(t,e,r){try{if("active"==currentContext.debugMode)if("Message"==e&&(currentContext.dataInterceptor.debugLog+="Action '"+t+"' with content: "+r+"\n\n\n"),"MessageJSON"==e)currentContext.dataInterceptor.debugLog+="Action '"+t+"' with content: \n"+JSON.stringify(r)+"\n\n\n";else if("ActionStart"==e){var n=(new Date).getMilliseconds()-o;currentContext.debugTimes[t]=n}else if("ActionEnd"==e){var o=currentContext.debugTimes[t],i=(new Date).getMilliseconds()-o;currentContext.dataInterceptor.debugLog+="Action '"+t+"' Executed in: "+i+" milliseconds"+r+"\n\n\n",delete currentContext.debugTimes[t]}}catch(t){wslog.info("logError: "+t)}},sendMessage=function(t,e,r){wslog.info("cartOptions.enableCartEvents: "+currentContext.cartOptions.enableCartEvents);var n=!0;if(1==currentContext.blockSendMessage&&(n=!1),0==currentContext.cartOptions.enableCartEvents&&(n=!1),n){wslog.info("sending to lexOrigin: "+currentContext.lexOrigin),wslog.info("typeofmessage: "+t),wslog.info("Sending message"),wslog.info("message is",e),e.action=t,logMessage("Sending Message","MessageJSON",e),e=JSON.stringify(e);try{window.parent.postMessage(e,currentContext.lexOrigin)}catch(t){window.postMessage(e,currentContext.lexOrigin)}null!=r&&void 0!=r&&r()}},generateError=function(t){if(!currentContext.cartOptions.enableCartEvents)return!1;wslog.info("Error: "+t);var e=new Object;throw e.type="war",e.text=t,currentContext.dataInterceptor.retrieveItemsServiceOutput.messages=[],currentContext.dataInterceptor.retrieveItemsServiceOutput.messages.push(e),sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),t},generateContextObject=function(){var t=new Object;return t.currentrootvid=ifnull(currentContext.rootvid),t.currentvid=ifnull(currentContext.complexProductToOpen),t.currentcatalogname=currentContext.catalog.commModelName,t.configurator=null!=ifnull(currentContext.complexProductToOpen),t.currentcatalogid=currentContext.catalog.catalogid,t.dateTarget=currentContext.configuration.NE__order_date__c,t.confcurrency=currentContext.confcurrency,null!=ifnull(currentContext.currentBundle)&&(t.currentbundleid=currentContext.currentBundle.fields.id),null!=ifnull(currentContext.currentBundlevid)&&(t.currentbundlevid=currentContext.currentBundlevid),null!=ifnull(currentContext.currentBundleElement)&&(t.currentbundleelementid=currentContext.currentBundleElement.fields.id),wslog.info("Load context object: ",t),t},resetConfigurator=function(t){currentContext.complexProductId="",currentContext.rootvid=null,currentContext.rootCatalogitemid=null,currentContext.dataInterceptor.lastChild=null,currentContext.dataInterceptor.itemToShow=null,currentContext.productCatalogItemId="",currentContext.mapOfItemsInPages={},currentContext.countItemInCategory=0,"simpleWithAttributes"!=t&&(currentContext.complexProductToOpen=null),"simple"==t&&(currentContext.itemheaderId=null)},organizeCart=function(t){var e=Object.assign([],t);wslog.info("cartitemstosend to organize: ",e);var r=[],n={};currentContext.cartMap={};for(var o={LastNumber:100},i=0;i<e.length;i++)e[i].childItems=[],wslog.info("cartitemstosend[i].fields.type: ",e[i].fields.type),"Product"==e[i].fields.type&&(wslog.info("adding to cartmap: ",n),n[e[i].fields.vid]=e[i]),currentContext.cartMap[e[i].fields.vid]=e[i];for(i=0;i<e.length;i++){if(null==ifnull(e[i].fields.bundleId)&&(e[i].fields.bundleId=null),"Child-Product"==e[i].fields.type){var a=n[e[i].fields.rootvid];a.childItems.push(e[i]),n[a.fields.vid]=a}if(null!=ifnull(e[i].fields.bundleId)&&null==ifnull(e[i].fields.bundlevid)){var s=o.LastNumber;s+=100,o[e[i].fields.vid]=s,o[e[i].fields.vid+"_last"]=s,o.LastNumber=s}}for(var u in n){var c=n[u];r.push(c),currentContext.saveBackup&&c.fields.vid==currentContext.complexProductToOpen&&null==currentContext.backUpConfiguration&&(wslog.info("Backup saved"),currentContext.backUpConfiguration=JSON.stringify(c),currentContext.saveBackup=!1)}return wslog.info("organizeCart organizedCartArray: ",r),r.sort(function(t,e){return assignCartItemNumber(t,o)-assignCartItemNumber(e,o)})};function assignCartItemNumber(t,e){if(null==ifnull(t.fields.bundleId))return 0;if(null!=ifnull(t.fields.bundleId)&&null==ifnull(t.fields.bundlevid))return null==ifnull(r=e[t.fields.vid])?0:r;if(null!=ifnull(t.fields.bundleId)&&null!=ifnull(t.fields.bundlevid)){var r,n=e[t.fields.vid];if(null!=ifnull(n))return n;if(null==ifnull(r=e[t.fields.bundlevid+"_last"]))return 0;var o=r+10;return e[t.fields.bundlevid+"_last"]=o,e[t.fields.vid]=o,o}return 0}var addItemFromMessage=function(t,e,r){var n=generateContextObject(),o={};for(var i in n)o[i]=n[i];var a=t.itemEngineCode;o.source="Message",b2wgindatainterceptor.retrieveCartItem(a,o,function(t){if("0"!=t.errorCode)return generateError("retrieveCartItem: "+t.errorMessage),r(t.errorMessage),!1;var n;wslog.info("addData function response: ",t),t.result.hasOwnProperty("cartitem")&&(n=JSON.parse(t.result.cartitem),wslog.info("cartitem adding -> ",n),n.fields.source="Message"),addItemToCart(n,function(t){e(t)},function(t){r(t)})},function(t){r(t)},{escape:!1})},addItemToCart=function(t,e,r){var n;if("Message"!=t.fields.source)for(var o=0;o<currentContext.listOfItems.length;o++){var i=currentContext.listOfItems[o];if(i.fields.id==t.fields.id&&i.fields.bundleId==t.fields.bundleId&&i.fields.bundleElement==t.fields.bundleElement){wslog.info("Found item to add into the list with id: "+i.fields.id),0==t.fields.qty?i.fields.qty=1:i.fields.qty=t.fields.qty,(n=Object.assign(new Object,i)).fields.vid=Math.random().toString(36).substring(3),n.fields.itemCode=n.fields.vid,"configureCatalogItem"==currentContext.lastMessageAction?(n.fields.isCatalogItem=!0,n.fields.isCart=!1):(n.fields.isCatalogItem=!1,n.fields.isCart=!0),null!=ifnull(currentContext.currentBundleElement)&&null!=ifnull(currentContext.currentBundle)&&null!=ifnull(currentContext.currentBundlevid)&&(n.fields.bundlevid=currentContext.currentBundlevid,n.fields.bundleId=currentContext.currentBundle.fields.id,n.fields.bundleElement=currentContext.currentBundleElement.fields.id);break}}else wslog.info("Received item from message source"),n=t;currentContext.itemheaderId=ifnull(n.fields.itemHeader),wslog.info("Current complexProductToOpen",currentContext.complexProductToOpen),currentContext.lastItemAdded=n,"Child-Product"==n.fields.type&&(n.fields.parentvid=currentContext.complexProductToOpen,n.fields.rootvid=currentContext.rootvid,currentContext.dataInterceptor.lastChild=n);var a=!1,s=!1;(null!=currentContext.itemheaderId||null!=n.listOfAttributes&&"undefined"!=n.listOfAttributes&&n.listOfAttributes.length>0)&&("Product"==n.fields.type?("Configuration Required"==n.fields.configurationtype||"Auto Configuration"==n.fields.configurationtype||1==n.fields.isCatalogItem?(currentContext.complexProductToOpen=n.fields.vid,currentContext.complexProductId=n.fields.catalogitemid,currentContext.rootvid=n.fields.vid,currentContext.productCatalogItemId=n.fields.catalogitemid,"Auto Configuration"==n.fields.configurationtype&&(currentContext.blockSendMessage=!0),a=!0):a=!1,s=!0):"Child-Product"==n.fields.type&&"Configuration Required"==n.fields.configurationtype&&(a=!0)),wslog.info("Adding item: ",n),wslog.info("itemheaderId: "+currentContext.itemheaderId),wslog.info("openConfigurator: "+a),wslog.info("isConfigurable: "+s);var u=catalogEngine.createAndAdd(n,"cartitem");currentContext.cart.push(u),wslog.info("itemAddedInEngine: ",u),wslog.info("Refresh context");var c=currentContext.cartadministration.GetStructure;if(null!=currentContext.itemheaderId&&c){wslog.info("**** adding default ***");var l={},f="Product"==n.fields.type?n.fields.id:"",d="";for(o=0;o<currentContext.listOfItems.length;o++){var h=currentContext.listOfItems[o],p=Object.assign(new Object,h),g=p.fields.id,m=(p.fields.vid,p.fields.itemHeader),v=p.fields.defaultQty,y=p.fields.type,x=p.fields.parentvid,C=p.fields.rootvid;if(m==currentContext.itemheaderId&&null==ifnull(p.fields.bundleId))if(g==n.fields.id&&"Product"==y?d=n.fields.vid:null!=ifnull(currentContext.rootvid)&&(d=currentContext.rootvid),g==n.fields.id)p=n,l[g]=p;else if(-1==currentContext.listOfItems.findIndex(function(t){return t.fields.id==x})&&(x=f),C=d,v>=1&&ifnull(l[x])){p.fields.vid=Math.random().toString(36).substring(3),p.fields.itemCode=p.fields.vid,p.fields.parentvid=l[x].fields.vid,p.fields.rootvid=C,p.fields.qty=v,p.fields.visible=p.fields.visiblefromdb;u=catalogEngine.createAndAdd(p,"cartitem");currentContext.cart.push(u),l[g]=p}}"Product"==n.fields.type&&1==a?wslog.info("Retrieve items call postponed"):0==a?retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"Child-Product"==n.fields.type?currentContext.complexProductId:"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(t){e(t)},function(t){r(t)}):modifyItem(n,function(t){e(t)},function(t){r(t)})}else"Child-Product"==n.fields.type?1==n.fields.hasDefaultChildren||"true"==n.fields.hasDefaultChildren?b2wgindatainterceptor.retrieveAutoAddedChildren(n.fields.rootvid,n.fields.vid,n.fields.catalogitemid,currentContext.getDataOptionsMap,function(t){if("0"!=t.errorCode)return generateError("getAutoAddedChildrenResponse: "+t.errorMessage),r(t.errorMessage),!1;for(var o in wslog.info("added children: ",t),t.result)if(t.result.hasOwnProperty(o))if(wslog.info(o+" -> "+t.result[o]),"-1"!=o.indexOf("___")){var i=o.split("___")[0];(s=t.result[o]).constructor!==Object&&(s=JSON.parse(t.result[o])),s.fields.visible=s.fields.visiblefromdb,catalogEngine.createAndAdd(s,i),"undefined"!=currentContext.moduleAppVar[i]&&null!=currentContext.moduleAppVar[i]||(wslog.info("Initialize list: "+i),currentContext.moduleAppVar[i]=[]),currentContext.moduleAppVar[i].push(s)}else{var s;(s=t.result[o]).constructor!==Object&&(s=JSON.parse(t.result[o])),currentContext.moduleAppVar[o]=s,catalogEngine.createAndAdd(s,o),currentContext.contextdata[o]=o}0==a?retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(t){e(t)},function(t){r(t)}):modifyItem(n,function(t){e(t)},function(t){r(t)})},function(t){r(t)},{escape:!1}):0==a?retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(t){e(t)},function(t){r(t)}):modifyItem(n,function(t){e(t)},function(t){r(t)}):"Product"==n.fields.type&&0==a&&(1==s&&null!=ifnull(n.fields.itemHeader)?(currentContext.moduleAppVar.complex_category=[],wslog.info("retrieve complex data but i will not configure it"),b2wgindatainterceptor.retrieveComplexProductsData(n.fields.vid,n.fields.itemHeader,currentContext.catalog.catalogid,currentContext.configuration.NE__order_date__c,currentContext.lastMessageType,currentContext.lastMessageAction,currentContext.getDataOptionsMap,function(t){if("0"!=t.errorCode)return generateError("getComplexReturn: "+t.errorMessage),r(t.errorMessage),!1;for(var n in t.result)if(t.result.hasOwnProperty(n)&&(wslog.info(n+" -> "+t.result[n]),"-1"!=n.indexOf("___"))){var o=n.split("___")[0];if("cartitem"==o){var i=t.result[n];i.constructor!==Object&&(i=JSON.parse(t.result[n])),i.fields.visible=i.fields.visiblefromdb,catalogEngine.createAndAdd(i,o),"undefined"!=currentContext.moduleAppVar[o]&&null!=currentContext.moduleAppVar[o]||(wslog.info("Initialize list: "+o),currentContext.moduleAppVar[o]=[]),currentContext.moduleAppVar[o].push(i)}}retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(t){e(t)},function(t){r(t)})},function(t){e(t)},{escape:!1})):retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(t){e(t)},function(t){r(t)}));"Product"==n.fields.type&&1==a&&(currentContext.saveBackup=!0,retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(t){wslog.info("trying to open the product: "+currentContext.complexProductToOpen),currentContext.dataInterceptor.configure=!0,currentContext.dataInterceptor.componentToShow="configurator";var o={action:"startLoading"};sendMessage("startLoading",o),wslog.info("itemToAdd.fields.configurationtype: "+n.fields.configurationtype),null!=ifnull(currentContext.itemheaderId)&&(currentContext.saveBackup=!0,currentContext.backUpConfiguration=null),"Auto Configuration"==n.fields.configurationtype?changeProgramContext("complex",currentContext.itemheaderId,function(){currentContext.blockSendMessage=!1,resetSaveConfiguration(function(t){e(t)},function(t){r(t)})}):changeProgramContext("complex",currentContext.itemheaderId,function(){e()},function(t){r(t)})}))},changeProgramContext=function(t,e,r,n){var o;if(wslog.info("changeProgramContext: "+t),wslog.info("changeitemheaderId: "+e),wslog.info("complexProductToOpen: "+currentContext.complexProductToOpen),wslog.info("complexProductId: "+currentContext.complexProductId),wslog.info("rootvid: "+currentContext.rootvid),"complex"==t){if(currentContext.dataInterceptor.componentToShow="configurator",currentContext.componentToShow="configurator",null!=ifnull(currentContext.complexProductToOpen)&&null!=e&&""!=e)currentContext.moduleAppVar.category=[],currentContext.moduleAppVar.complex_category=[],o=null==ifnull(currentContext.lastItemAdded)?currentContext.rootvid:currentContext.lastItemAdded.fields.vid,wslog.info("addedRootVid: "+o),currentContext.getDataOptionsMap.currentCatalogItemId=currentContext.productCatalogItemId,currentContext.moduleAppVar.complex_category=[],b2wgindatainterceptor.retrieveComplexProductsData(o,e,currentContext.catalog.catalogid,currentContext.configuration.NE__order_date__c,currentContext.lastMessageType,currentContext.lastMessageAction,currentContext.getDataOptionsMap,function(t){if("0"!=t.errorCode)return generateError("getComplexReturn: "+t.errorMessage),n(t.errorMessage),!1;null!=ifnull(e)?(currentContext.programname=t.result.programName,currentContext.version=t.result.programVersion):(t.result.programName=currentContext.programname,t.result.programVersion=currentContext.version),wslog.info("programname: "+currentContext.programname),wslog.info("version: "+currentContext.version),currentContext.dataInterceptor.componentToShow="configurator",wslog.info("cart.length init program: "+currentContext.cart.length),currentContext.rootCatalogitemid=t.result.rootCatalogitemid,delete t.result.rootCatalogitemid,wslog.info("rootCatalogitemid: "+currentContext.rootCatalogitemid),b2wgindatainterceptor.retrieveProgram(currentContext.programname,currentContext.version,currentContext.organizationId,function(e){if("0"!=e.errorCode)return generateError("retrieveProgram: "+e.errorMessage),n(e.errorMessage),!1;for(var o in wslog.info("Retrieve after entering into the product"),(catalogEngine=e).clearSession(),currentContext.moduleAppVar.complex_category=null,wslog.info("Load complex item data",t),t.result)if(t.result.hasOwnProperty(o))if(wslog.info(o+" -> "+t.result[o]),"-1"!=o.indexOf("___")){var i=o.split("___")[0];(a=t.result[o]).constructor!==Object&&(a=JSON.parse(t.result[o])),catalogEngine.createAndAdd(a,i),"undefined"!=currentContext.moduleAppVar[i]&&null!=currentContext.moduleAppVar[i]||(wslog.info("Initialize list: "+i),currentContext.moduleAppVar[i]=[]),currentContext.moduleAppVar[i].push(a)}else if("programName"==o||"programVersion"==o)currentContext.moduleAppVar[o]=t.result[o];else{var a;(a=t.result[o]).constructor!==Object&&(a=JSON.parse(t.result[o])),currentContext.moduleAppVar[o]=a,catalogEngine.createAndAdd(a,o),currentContext.contextdata[o]=o}currentContext.selectedCategory=currentContext.moduleAppVar.complex_category[0].categoryFields.id;for(var s=0;s<currentContext.moduleAppVar.complex_category.length;s++)if("Root"==currentContext.moduleAppVar.complex_category[s].categoryFields.parenttype){currentContext.selectedCategory=currentContext.moduleAppVar.complex_category[s].categoryFields.id;break}wslog.info("b2wgin_cart before changing product category: ",currentContext.selectedCategory);for(s=0;s<currentContext.cart.length;s++)catalogEngine.createAndAdd(currentContext.cart[s],"cartitem");for(var u in wslog.info("restoring context contextdata ",currentContext.contextdata),currentContext.contextdata)if(wslog.info("Restoring key: "+u),null!=ifnull(currentContext.moduleAppVar[u]))if(currentContext.moduleAppVar[u]instanceof Array){var c=currentContext.moduleAppVar[u];for(s=0;s<c.length;s++)catalogEngine.createAndAdd(c[s],u)}else catalogEngine.createAndAdd(currentContext.moduleAppVar[u],u);retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(){wslog.info("Send complex data to open: "+currentContext.complexProductToOpen);for(var t=0;t<currentContext.dataInterceptor.retrieveItemsServiceOutput.cart.length;t++)if(currentContext.complexProductToOpen==currentContext.dataInterceptor.retrieveItemsServiceOutput.cart[t].fields.vid){currentContext.dataInterceptor.itemToShow=currentContext.dataInterceptor.retrieveItemsServiceOutput.cart[t];break}wslog.info("cart.length Send complex data: "+currentContext.cart.length),currentContext.dataInterceptor.configure=!0,sendMessage("changeComponentToShow",currentContext.dataInterceptor),wslog.info("Complex change context callback"),r()},function(t){n(t)})},function(t){n(t)})},function(t){n(t)},{escape:!1});else if(null!=ifnull(currentContext.complexProductToOpen)){wslog.info("Simple product: Send only attributes data to open",currentContext.complexProductToOpen),resetConfigurator("simpleWithAttributes");for(var i=0;i<currentContext.dataInterceptor.retrieveItemsServiceOutput.cart.length;i++)if(currentContext.complexProductToOpen==currentContext.dataInterceptor.retrieveItemsServiceOutput.cart[i].fields.vid){currentContext.dataInterceptor.itemToShow=currentContext.dataInterceptor.retrieveItemsServiceOutput.cart[i];break}wslog.info("cart.length Send complex data: "+currentContext.cart.length),currentContext.dataInterceptor.configure=!0,sendMessage("changeComponentToShow",currentContext.dataInterceptor),r()}}else"simple"==t&&(currentContext.programname=currentContext.catalogprogramname,currentContext.version=currentContext.catalogversion,currentContext.dataInterceptor.componentToShow="catalog",currentContext.componentToShow="catalog",currentContext.moduleAppVar.category=[],currentContext.moduleAppVar.complex_category=[],resetConfigurator("simple"),b2wgindatainterceptor.retrieveProgram(currentContext.programname,currentContext.version,currentContext.organizationId,function(t){if("0"!=t.errorCode)return generateError("retrieveProgram: "+t.errorMessage),n(t.errorMessage),!1;(catalogEngine=t).clearSession(),null!=ifnull(currentContext.taxModelsParameters)&&(currentContext.getDataOptionsMap.taxModelsParameters=currentContext.taxModelsParameters,currentContext.getDataOptionsMap.catalogHeaderId=currentContext.catalog.headerid,currentContext.getDataOptionsMap.configurationDate=currentContext.configuration.NE__order_date__c),b2wgindatainterceptor.retrieveCatalogData(currentContext.catalog.catalogid,"",currentContext.getDataOptionsMap,function(t){if("0"!=t.errorCode)return generateError("retrieveCatalogData: "+t.errorMessage),n(t.errorMessage),!1;for(var e in wslog.info("Load catalog data"),currentContext.category=null,t.result)if(t.result.hasOwnProperty(e))if(wslog.info(e+" -> "+t.result[e]),"-1"!=e.indexOf("___")){var o=e.split("___")[0],i=t.result[e];i.constructor!==Object&&(i=JSON.parse(i)),catalogEngine.createAndAdd(i,o),"undefined"!=currentContext.moduleAppVar[o]&&null!=currentContext.moduleAppVar[o]||(wslog.info("Initialize list: "+o),currentContext.moduleAppVar[o]=[]),currentContext.moduleAppVar[o].push(i),"taxmodel"==o&&(currentContext.contextdata[o]=o)}else currentContext.moduleAppVar[e]=t.result[e],catalogEngine.createAndAdd(JSON.parse(t.result[e]),e);null!=ifnull(currentContext.catalogSelectedCategory)?currentContext.selectedCategory=currentContext.catalogSelectedCategory:currentContext.selectedCategory=currentContext.category.filter(function(t){return"false"===t.categoryFields.hidden})[0].categoryFields.id;for(var a=0;a<currentContext.cart.length;a++)catalogEngine.createAndAdd(currentContext.cart[a],"cartitem");for(var s in wslog.info("restoring context contextdata ",currentContext.contextdata),currentContext.contextdata)if(null!=ifnull(currentContext.moduleAppVar[s]))if(currentContext.moduleAppVar[s]instanceof Array){var u=currentContext.moduleAppVar[s];for(a=0;a<u.length;a++)catalogEngine.createAndAdd(u[a],s)}else catalogEngine.createAndAdd(currentContext.moduleAppVar[s],s);wslog.info("Simple change context to simple"),currentContext.complexProductToOpen="Catalog",retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(){r()},function(t){n(t)})},{escape:!1})},function(t){n(t)}))},removeItemFromCart=function(t,e,r){var n,o={};o[t.fields.vid]=t.fields.vid;for(var i=[],a=[],s=0;s<currentContext.cart.length;s++)n=currentContext.cart[s],wslog.info("Check item for removing ",n),n.fields.vid==t.fields.vid||null!=ifnull(n.fields.parentvid)&&null!=ifnull(o[n.fields.parentvid])?(wslog.info("Found item to remove from the list with vid: "+n.fields.vid),catalogEngine.remove(n),delete currentContext.cartMap[n.fields.vid],o[n.fields.vid]=n.fields.vid):(null!=ifnull(t.fields.bundleId)&&null==ifnull(t.fields.bundleElement)&&null==ifnull(n.fields.parentvid)&&n.fields.bundlevid==t.fields.vid&&a.push(n),i.push(n));currentContext.cart=i;for(s=0;s<a.length;s++)removeItemFromCart(a[s]);wslog.info("Refresh context after removing ",o),currentContext.complexProductId=ifnull(currentContext.complexProductId),currentContext.productCatalogItemId=ifnull(currentContext.productCatalogItemId),void 0!=e&&(t.fields.isRollback?(delete t.fields.isRollback,e()):t.fields.isCatalogItem?null!=ifnull(currentContext.itemheaderId)?resetSaveConfiguration(function(t){e(t)},function(t){r(t)}):(currentContext.blockSendMessage=!0,retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(t){currentContext.blockSendMessage=!1,resetSaveConfiguration(function(t){e(t)},function(t){r(t)})},function(t){r(t)})):retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(t){e(t)},function(t){r(t)}))},clearCart=function(t,e){for(var r=0;r<currentContext.cart.length;r++){var n=currentContext.cart[r];catalogEngine.remove(n)}retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(e){t(e)},function(t){e(t)})},retrieveCatalogItems=function(t,e,r,n,o,i,a,s){catalogEngine.fire(ifnull(currentContext.agendaGroupsMap.agCleanCatalog),function(u){i.currentCatalogItemId=null!=currentContext.productCatalogItemId&&void 0!=currentContext.productCatalogItemId?currentContext.productCatalogItemId:"",i.itemheaderId=null!=currentContext.itemheaderId&&void 0!=currentContext.itemheaderId?currentContext.itemheaderId:"";var c=!1;null==ifnull(r)&&null!=ifnull(currentContext.currentBundleElement)&&(r=currentContext.currentBundleElement.fields.id,c=!0),b2wgindatainterceptor.retrieveCatalogItemsAttachment(t,e,r,n,o,i,function(t){if(wslog.info("Load catalog items data ",t),"0"!=t.errorCode)return generateError("retrieveCatalogItemsAttachment: "+t.errorMessage),s(t.errorMessage),!1;c&&(r=null),wslog.info("complexProductToOpen ",currentContext.complexProductToOpen),null!=ifnull(currentContext.complexProductToOpen)&&"Catalog"!=currentContext.complexProductToOpen||(currentContext.offset=parseInt(o));var e=0;void 0!=currentContext.countItemInCategory&&null!=currentContext.countItemInCategory||(currentContext.countItemInCategory=0);var n=0,u="true"==i.GetAllData,l="true"==i.GetStructure;for(var f in t.result)if(t.result.hasOwnProperty(f))if(wslog.info(f+" -> "+t.result[f]),"-1"!=f.indexOf("___")){var d,h=f.split("___")[0];if("itemHeader"!=h&&"complex_program"!=h&&"catCategory"!=h&&"simple_program"!=h&&(d=t.result[f].constructor===String?JSON.parse(t.result[f]):t.result[f]),"item"!=h||null!=ifnull(currentContext.complexProductToOpen)&&"Catalog"!=currentContext.complexProductToOpen)"item"==h&&(null==ifnull(currentContext.productCatalogItemId)&&"Child-Product"==d.fields.type&&currentContext.selectedCategory!=d.fields.categoryid?d.fields.visible="false":d.fields.visible=d.fields.visiblefromdb,u&&"Product"==d.fields.type&&currentContext.selectedCategory!=d.fields.categoryid&&(d.fields.visible="false"));else{if(wslog.info("itemCounter: "+e+" currentContext.itemsForPage: "+currentContext.itemsForPage),d.fields.vid=Math.random().toString(36).substring(3),d.fields.itemCode=d.fields.vid,wslog.info("complexProductToOpen: "+currentContext.complexProductToOpen+" parsedElement.fields.type: "+d.fields.type),null!=ifnull(currentContext.complexProductToOpen)&&"Catalog"!=currentContext.complexProductToOpen||"Child-Product"!=d.fields.type?d.fields.visible=d.fields.visiblefromdb:d.fields.visible="false",u&&"Product"==d.fields.type&&currentContext.selectedCategory!=d.fields.categoryid&&(d.fields.visible="false"),u||l){if("true"==d.fields.visible){n++;var p=currentContext.itemsForPage*currentContext.offset-(currentContext.itemsForPage-1),g=currentContext.itemsForPage*currentContext.offset;if(n<p||n>g){wslog.info("Not in range, item skipped");continue}}}else if("true"==d.fields.visible){var m="";void 0!=currentContext.mapOfItemsInPages&&null!=currentContext.mapOfItemsInPages||(currentContext.mapOfItemsInPages={}),null!=currentContext.mapOfItemsInPages[o]&&""!=currentContext.mapOfItemsInPages[o]&&void 0!=currentContext.mapOfItemsInPages[o]?m=currentContext.mapOfItemsInPages[o]:currentContext.mapOfItemsInPages[o]=m;var v=!1;for(var y in currentContext.mapOfItemsInPages)if(-1!=currentContext.mapOfItemsInPages[y].indexOf(d.fields.id)&&y!=o){wslog.info("Already added in page "+y+" , item skipped"),v=!0;break}if(v)continue;if(e++,currentContext.countItemInCategory++,e>currentContext.itemsForPage){wslog.info("Not in range, item skipped");continue}-1==m.indexOf(d.fields.id)&&(m+=d.fields.id+";"),currentContext.mapOfItemsInPages[o]=m}null!=currentContext.currentBundleElement&&(d.fields.bundleElement=currentContext.currentBundleElement.fields.id,d.fields.bundleId=currentContext.currentBundleElement.fields.bundleid)}"itemHeader"!=h&&"complex_program"!=h&&"complex_category"!=h&&"catCategory"!=h&&"simple_program"!=h&&catalogEngine.createAndAdd(d,h)}else currentContext.moduleAppVar[f]=t.result[f],catalogEngine.createAndAdd(JSON.parse(t.result[f]),f);if(wslog.info("Setted offset ",currentContext.offset),null!=r&&""!=r&&null!=ifnull(currentContext.itemheaderId))for(var x=0;x<currentContext.moduleAppVar.complex_category.length;x++)catalogEngine.createAndAdd(currentContext.moduleAppVar.complex_category[x],"complex_category");else{for(x=0;x<currentContext.moduleAppVar.category.length;x++)catalogEngine.createAndAdd(currentContext.moduleAppVar.category[x],"category");if(l&&null!=ifnull(currentContext.moduleAppVar.bundleItems))for(x=0;x<currentContext.moduleAppVar.bundleItems.length;x++)catalogEngine.createAndAdd(currentContext.moduleAppVar.bundleItems[x],"item")}catalogEngine.createAndAdd(generateContextObject(),"contextdata"),wslog.info("lastMessageType: ",currentContext.lastMessageType),wslog.info("Using agenda groups: ",ifnull(currentContext.agendaGroupsMap[currentContext.lastMessageType])),catalogEngine.fire(ifnull(currentContext.agendaGroupsMap[currentContext.lastMessageType]),function(t){wslog.info("Verify catalogEngine after fire:",t),null!=ifnull(t.matches.item)&&0!=t.matches.item.length?currentContext.listOfItems=t.matches.item:currentContext.listOfItems=[];var e=currentContext.listOfItems.sort(function(t,e){var r=assignItemNumber(t),n=assignItemNumber(e);return r>=2&&r<=7&&r==n?t.fields.sequence-e.fields.sequence:r-n});currentContext.listOfItems=e,ifnull(null!=t.matches.cartitem)&&0!=t.matches.cartitem.length?currentContext.cart=t.matches.cartitem:currentContext.cart=[],currentContext.configuration=t.matches.configuration[0],currentContext.configuration.NE__ConfigurationStatus__c=currentContext.configuration.NE__configurationstatus__c,currentContext.configuration.NE__CatalogId__c=currentContext.selectedCatalog.catalogid,currentContext.configuration.NE__CommercialModelId__c=currentContext.selectedCatalog.commercialModelId,currentContext.prefix=currentContext.dataInterceptor.prefix,null!=ifnull(t.matches.category)?currentContext.moduleAppVar.category=t.matches.category:currentContext.moduleAppVar.category=t.matches.complex_category;var r=currentContext.moduleAppVar.category.sort(function(t,e){var r=assignCategoryNumber(t),n=assignCategoryNumber(e);return r==n?t.categoryFields.sequence-e.categoryFields.sequence:r-n});if(currentContext.moduleAppVar.category=r,null==ifnull(t.matches.message)?currentContext.messages=[]:currentContext.messages=t.matches.message,null==ifnull(t.matches.bundle)?currentContext.listOfbundles=[]:currentContext.listOfbundles=t.matches.bundle,currentContext.dataInterceptor.retrieveItemsServiceOutput.cart=organizeCart(currentContext.cart),currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration=currentContext.configuration,currentContext.dataInterceptor.retrieveItemsServiceOutput.listOfCategories=currentContext.moduleAppVar.category,currentContext.dataInterceptor.retrieveItemsServiceOutput.listOfItems=currentContext.listOfItems,currentContext.dataInterceptor.retrieveItemsServiceOutput.messages=currentContext.messages,currentContext.dataInterceptor.selectedCatalog=currentContext.selectedCatalog,currentContext.dataInterceptor.retrieveItemsServiceOutput.listOfBundles=currentContext.listOfbundles,delete currentContext.dataInterceptor.retrieveItemsServiceOutput.listOfBundle,null!=ifnull(t.matches.sessionparameter))for(var o=0;o<t.matches.sessionparameter.length;o++)currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters[t.matches.sessionparameter[o].name]=t.matches.sessionparameter[o].value;currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.ItemsForPage=String(currentContext.itemsForPage),currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.SelectedCategoryId=currentContext.selectedCategory,currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.CurrentPage=String(currentContext.offset),currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.catalogId=currentContext.selectedCatalog.catalogid,1==currentContext.multicurrencyactivated?currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.isMultiCurrency="true":currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.isMultiCurrency="false",currentContext.dataInterceptor.retrieveItemsServiceOutput.currentBundlevid=currentContext.currentBundlevid,currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.GetAllData=u,currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.GetStructure=l,(u||l)&&(currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters["countitem_"+currentContext.selectedCategory]=n),currentContext.cartOptions.sendmatches&&(currentContext.dataInterceptor.retrieveItemsServiceOutput.matches=t.matches),null!=a&&"undefined"!=a&&a()})},function(t){s(t)},{escape:!1})})},changeCategory=function(t,e,r){wslog.info("Reset elements"),currentContext.selectedCategory=t,currentContext.catalogSelectedCategory=t,currentContext.productCatalogItemId=null,currentContext.itemheaderId=null,currentContext.mapOfItemsInPages={},currentContext.countItemInCategory=0,wslog.info("Retrieve items for category: "+t),wslog.info("Retrieve items for catalog: "+currentContext.catalog.catalogid),retrieveCatalogItems(currentContext.catalog.catalogid,t,"",currentContext.itemsForPage,1,currentContext.getDataOptionsMap,function(t){e(t)},function(t){r(t)})},changeChildProduct=function(t,e,r){wslog.info("Goback to child"),currentContext.selectedCategory=null,t.fields.engineAction="Open",currentContext.dataInterceptor.lastChild=t,currentContext.dataInterceptor.itemToShow=t,currentContext.complexProductId=t.fields.catalogitemid,"Product"!=t.fields.type?retrieveCatalogItems(currentContext.catalog.catalogid,"",t.fields.catalogitemid,currentContext.itemsForPage,1,currentContext.getDataOptionsMap,function(t){e(t)},function(t){r(t)}):retrieveCatalogItems(currentContext.catalog.catalogid,"",currentContext.rootCatalogitemid,currentContext.itemsForPage,1,currentContext.getDataOptionsMap,function(t){e(t)},function(t){r(t)})},changeAttribute=function(t,e,r){wslog.info("Change Attribute",t),currentContext.saveBackup=!1;for(var n={},o=0;o<t.listOfAttributes.length;o++){var i=t.listOfAttributes[o];n[i.fields.pfpId]=i}wslog.info("mapToPfpToChange",n);for(o=0;o<currentContext.cart.length;o++){var a=currentContext.cart[o];if(a.fields.itemCode==t.fields.itemCode){for(var s=0;s<a.listOfAttributes.length;s++){var u=n[a.listOfAttributes[s].fields.pfpId];null!=ifnull(u)&&(wslog.info("Changed from "+a.listOfAttributes[s].fields.value+"to "+u.fields.value),a.listOfAttributes[s].fields.previousvalue=a.listOfAttributes[s].fields.value,a.listOfAttributes[s].fields.value=u.fields.value)}catalogEngine.modify(a);break}}wslog.info("Change Attribute itemsForPage ",currentContext.itemsForPage),wslog.info("Change Attribute offset ",currentContext.offset),retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(t){e(t)},function(t){r(t)})},changeQuantity=function(t,e,r){wslog.info("Change quantity",t);for(var n=t.fields.qtyToManage,o=0;o<currentContext.cart.length;o++){var i=currentContext.cart[o];if(i.fields.itemCode==t.fields.itemCode){i.fields.qty=n,i.fields.qtyToManage=n,catalogEngine.modify(i),wslog.info("Found item "+i.fields.itemCode+" with qty: "+t.fields.qtyToManage);break}}currentContext.complexProductId=ifnull(currentContext.complexProductId),currentContext.productCatalogItemId=ifnull(currentContext.productCatalogItemId),retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(t){e(t)},function(t){r(t)})},resetSaveConfiguration=function(t,e){currentContext.backUpConfiguration=null,wslog.info("resetSave itemHeaderId: "+currentContext.itemheaderId),null!=ifnull(currentContext.itemheaderId)?changeProgramContext("simple","",function(){currentContext.dataInterceptor.configure=!1,currentContext.dataInterceptor.componentToShow="catalog",currentContext.dataInterceptor.itemToShow=null,wslog.info("Return to shopping cart"),currentContext.saveBackup=!1,sendMessage("changeComponentToShow",currentContext.dataInterceptor),t()},function(t){e(t)}):(currentContext.dataInterceptor.configure=!1,currentContext.dataInterceptor.componentToShow="catalog",currentContext.dataInterceptor.itemToShow=null,wslog.info("Return to shopping cart"),currentContext.saveBackup=!1,sendMessage("changeComponentToShow",currentContext.dataInterceptor),t())},changeCatalog=function(t,e,r){if(wslog.info("Selecting program: ",t),null==t.catalogid)return currentContext.initInProgress=!1,generateError(t.commModelName+": no active catalog version found"),r("No active catalog version found"),!1;currentContext.catalog=t,currentContext.programname=t.programname,currentContext.version=t.version.toString(),1==currentContext.cartOptions.useBaseCatalogProgram&&(currentContext.programname="Base_Program_Catalog",currentContext.version="1"),currentContext.catalogprogramname=currentContext.programname,currentContext.catalogversion=currentContext.version,currentContext.selectedCatalog=t,"initCart"!=currentContext.lastMessageType&&0==currentContext.initInProgress&&(currentContext.cart=[]),currentContext.category=[],currentContext.listOfItems=[],currentContext.messages=[],currentContext.listOfbundles=[],delete currentContext.contextdata.bundle,delete currentContext.moduleAppVar.bundleItems,delete currentContext.moduleAppVar.bundle,b2wgindatainterceptor.selectedCatalog=currentContext.selectedCatalog,b2wgindatainterceptor.selectedCategory=currentContext.selectedCategory,b2wgindatainterceptor.optionsMap=currentContext.cartOptions,async.waterfall([function(t){retrieveProgramChangeCatalog(currentContext.programname,currentContext.version,currentContext.organizationId,t)},function(e){retrieveRowParametersChangeCatalog("",t,e)},function(e,r){retrieveCatalogDataChangeCatalog(t,e,r)},function(e){retrieveCatalogBundles(t,currentContext.getDataOptionsMap,e)}],function(t,n){if(t)return generateError("[changeCatalog] "+t),r(t),!1;retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,1,currentContext.getDataOptionsMap,function(t){e(t)},function(t){return t.method="changeCategory",generateError(t),r(t),!1})})},checkOut=function(t,e){for(var r in wslog.info("checkout called"),currentContext.lastMessageType="checkout",currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration.id=ifnull(currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration.id),wslog.info("prefix: "+currentContext.prefix),currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration){if("NE__"!=currentContext.prefix&&1==r.endsWith("__c")){var n=r.replace("NE__",currentContext.prefix);currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration[n]=currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration[r],delete currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration[r]}"RecordTypeId"!=r&&"Id"!=r||null!=currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration[r]&&""!=currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration[r]||delete currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration[r],"itemsCounter"==r&&delete currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration[r]}wslog.info("dataInterceptor.retrieveItemsServiceOutput input: ",currentContext.dataInterceptor.retrieveItemsServiceOutput),b2wgindatainterceptor.checkoutCart(currentContext.dataInterceptor,function(r){if(wslog.info("Checkout result!: ",r),currentContext.dataInterceptor.cartCheckOutServiceOutput=r,currentContext.dataInterceptor.cartadministration=currentContext.cartadministration,currentContext.dataInterceptor.cartCheckOutServiceOutput.sessionParameters=currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters,"0"!=r.errorCode)return generateError("checkOutCart: "+r.errorMessage),e(r.errorMessage),!1;sendMessage("checkOut",currentContext.dataInterceptor),t()},function(t){e(t)},{escape:!1})},searchItems=function(t,e,r){if(null==ifnull(currentContext.complexProductToOpen)){var n={productFieldsSet:[],catalogItemFieldsSet:[],productFields:{},dynamicPropertyDefinitionFieldsSet:[],documentationCharacteristicFieldsSet:[],catalogItemFields:{}};n.productFieldsList=t.MapProductList,n.catalogItemFieldsList=t.MapCatItemList,n.bundleElements=t.bundleElements,null==ifnull(n.productFieldsList)&&(n.productFieldsList=[]),null==ifnull(n.catalogItemFieldsList)&&(n.catalogItemFieldsList=[]),null==ifnull(n.bundleElements)&&(n.bundleElements=[]),currentContext.itemsForPageBK=currentContext.itemsForPage;var o=!1;null!=ifnull(t.searchOptions)&&(o=t.searchOptions.enableSearchAndAdd),0==n.productFieldsList.length&&0==n.catalogItemFieldsList.length&&0==n.bundleElements.length?(o=!1,delete currentContext.getDataOptionsMap.searchString,delete currentContext.getDataOptionsMap.itemsForPageSearch,delete currentContext.getDataOptionsMap.pageNumberSearch):(currentContext.getDataOptionsMap.searchString=JSON.stringify(n),null!=ifnull(t.searchOptions.itemsForPage)&&(currentContext.itemsForPage=parseInt(t.searchOptions.itemsForPage),currentContext.getDataOptionsMap.itemsForPageSearch=t.searchOptions.itemsForPage),null!=ifnull(t.searchOptions.pageNumber)&&(currentContext.getDataOptionsMap.pageNumberSearch=t.searchOptions.pageNumber),wslog.info("searchString:"+currentContext.getDataOptionsMap.searchString)),retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(t){currentContext.itemsForPage=currentContext.itemsForPageBK,delete currentContext.itemsForPageBK,wslog.info("searchAndAddActivated: "+o),1==o&&1==currentContext.dataInterceptor.retrieveItemsServiceOutput.listOfItems.length?(wslog.info("Adding element after search: "+currentContext.dataInterceptor.retrieveItemsServiceOutput.listOfItems[0].fields.productname),addItemToCart(currentContext.dataInterceptor.retrieveItemsServiceOutput.listOfItems[0],function(t){e(t)},function(t){reject(t)})):e(t)},function(t){r(t)})}else wslog.info("Search items not available for complex products"),e("Search items not available for complex products")},workNextQueuedRequest=function(){currentContext.requestQueue.length>0&&(delete currentContext.requestQueue[0],currentContext.requestQueue.length>0&&(currentContext.requestQueue[0].execute=!0))},configureCatalogItem=function(t,e,r){t.fields.isCatalogItem=!0,currentContext.tempConfigurationVid=t.fields.vid,addItemToCart(t,function(t){e(t)},function(t){r(t)})},confirmItemConfiguration=function(t,e){wslog.info("complexProduct To Confirm: "+currentContext.complexProductToOpen),currentContext.tempConfigurationVid=null;for(var r=0;r<currentContext.cart.length;r++){var n=currentContext.cart[r];wslog.info("Item vid: "+n.fields.vid+" Item rootvid: "+n.fields.rootvid),n.fields.vid!=currentContext.complexProductToOpen&&n.fields.rootvid!=currentContext.complexProductToOpen||(n.fields.isCatalogItem=!1,n.fields.isCart=!0,catalogEngine.modify(n),wslog.info("Item modified"))}retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(r){resetSaveConfiguration(function(e){t(e)},function(t){e(t)})})},cancelItemConfiguration=function(t,e,r){wslog.info("complexProduct To Cancel: "+currentContext.complexProductToOpen),currentContext.tempConfigurationVid=null;t=null;currentContext.backUpConfiguration=null;var n=currentContext.rootvid;null==ifnull(n)&&(n=currentContext.complexProductToOpen);for(var o=0;o<currentContext.cart.length;o++){var i=currentContext.cart[o];if(i.fields.vid==n){t=i;break}}null!=t?removeItemFromCart(t,function(t){e(t)},function(t){r(t)}):e()},commonModifyItem=function(t,e,r){currentContext.itemheaderId=t.fields.itemHeader,wslog.info("itemheaderId: "+currentContext.itemheaderId),wslog.info("rootvid: "+currentContext.rootvid),wslog.info("itemToModify.fields.rootvid: "+t.fields.rootvid);var n="complex";null==ifnull(currentContext.itemheaderId)&&null!=ifnull(currentContext.rootvid)&&(n="simple"),currentContext.rootvid==t.fields.rootvid?(currentContext.complexProductToOpen=t.fields.vid,changeChildProduct(t,function(t){e(t)},function(t){r(t)})):(resetConfigurator("complex"),(null!=ifnull(currentContext.itemheaderId)||null!=t.listOfAttributes&&"undefined"!=t.listOfAttributes&&t.listOfAttributes.length>0)&&(currentContext.complexProductToOpen=t.fields.vid,currentContext.complexProductId=t.fields.catalogitemid,currentContext.rootvid=t.fields.vid,currentContext.itemheaderId=currentContext.itemheaderId,"Product"==t.fields.type&&(currentContext.productCatalogItemId=t.fields.catalogitemid)),null==ifnull(currentContext.backUpConfiguration)&&(currentContext.saveBackup=!0),changeProgramContext(n,currentContext.itemheaderId,"simple"==n?function(){currentContext.complexProductToOpen=t.fields.vid,currentContext.complexProductId=t.fields.catalogitemid,"Product"==t.fields.type&&(currentContext.productCatalogItemId=t.fields.catalogitemid),changeProgramContext("complex",currentContext.itemheaderId,function(t){e(t)},function(t){r(t)})}:function(t){e(t)},function(t){r(t)}))},modifyItem=function(t,e,r){if(currentContext.saveBackup=!0,null!=ifnull(currentContext.cartMap)&&null!=ifnull(currentContext.cartMap[t.fields.vid])&&(currentContext.backUpConfiguration=JSON.stringify(currentContext.cartMap[t.fields.vid])),null!=currentContext.tempConfigurationVid){for(var n,o=0;o<currentContext.cart.length;o++)if((n=currentContext.cart[o]).fields.vid==currentContext.tempConfigurationVid){n.fields.isRollback;break}1!=t.fields.isCatalogItem?(wslog.info("Removing temp element before continue"),cancelItemConfiguration(n,function(n){commonModifyItem(t,function(t){e(t)},function(t){r(t)})},function(t){r(t)})):commonModifyItem(t,function(t){e(t)},function(t){r(t)})}else commonModifyItem(t,function(t){e(t)},function(t){r(t)})},rollbackConfiguration=function(t,e){if(wslog.info("Rollback to: ",currentContext.backUpConfiguration),null!=currentContext.backUpConfiguration){var r,n=currentContext.rootvid;null==ifnull(n)&&(n=currentContext.complexProductToOpen);for(var o=0;o<currentContext.cart.length;o++)if(r=currentContext.cart[o],wslog.info("Item vid: "+r.fields.vid+" Item rootvid: "+r.fields.rootvid),r.fields.vid==n){r.fields.isRollback=!0;break}removeItemFromCart(r,function(r){var n=JSON.parse(currentContext.backUpConfiguration),o=n.childItems;n.childItems=[],catalogEngine.createAndAdd(n,"cartitem"),currentContext.cart.push(n),currentContext.moduleAppVar.cart=currentContext.cart,currentContext.dataInterceptor.retrieveItemsServiceOutput.cart=currentContext.cart;for(var i=0;i<o.length;i++)catalogEngine.createAndAdd(o[i],"cartitem"),currentContext.cart.push(o[i]);retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(r){modifyItem(n,function(e){t(e)},function(t){e(t)})})},function(t){e(t)})}else t()},selectCatalog=function(t,e,r){currentContext.lastMessageType="changeCatalog",wslog.info("Change catalog to: "+currentContext.catalogId);for(var n=null,o=0;o<currentContext.catalogHeaders.length;o++)if(currentContext.catalogHeaders[o].catalogid==t||currentContext.catalogHeaders[o].headerid==t){n=currentContext.catalogHeaders[o];break}wslog.info("selectedCatalog",currentContext.selectedCatalog),wslog.info("catalogHeaderSelected",n),null==ifnull(currentContext.selectedCatalog)||n.catalogid!=currentContext.selectedCatalog.catalogid?changeCatalog(n,function(t){e(t)},function(t){r(t)}):(wslog.info("Skipped selecting catalog because is the same"),e())},changePage=function(t,e,r){wslog.info("Change page to: "+t),currentContext.pageNumber=t,0==currentContext.pageNumber&&(currentContext.pageNumber=1),retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.pageNumber,currentContext.getDataOptionsMap,function(t){e(t)},function(t){r(t)})};function isEmpty(t){for(var e in t)if(t.hasOwnProperty(e))return!1;return!0}function ifnull(t){return""==t||"undefined"==t||null==t?null:t}function retrieveB2WGinData(t){b2wgindatainterceptor.retrieveB2WGinData(currentContext.cartOptions.organizationId,function(e){if("0"!=e.errorCode)return generateError("retrieveB2WGinData: "+e.errorMessage),t(e.errorMessage),!1;var r=e.result;void 0==r&&(r=e);try{null!=ifnull(r.action)&&wslog.setLevel(wslog.levels[r.action])}catch(t){wslog.setLevel(wslog.levels.SILENT)}if(r.action="",currentContext.defaultCurrency=r.defaultCurrency,wslog.info("defaultCurrency: "+r.defaultCurrency),currentContext.dataInterceptor=r,wslog.info("dataInterceptor: ",currentContext.dataInterceptor),currentContext.organizationId=r.organizationId,wslog.info("Organization id: "+currentContext.organizationId),isBrowser&&(wslog.info("Frame origin: ",window.location.origin),currentContext.dataInterceptor.requestOrigin=window.location.origin),null!=ifnull(currentContext.cartOptions.userLanguage)&&(currentContext.getDataOptionsMap.userLanguage=currentContext.cartOptions.userLanguage),currentContext.lexOrigin=r.lexOrigin,isBrowser&&-1!=window.location.href.indexOf("lightningFromVF=true")&&(currentContext.lexOrigin=window.location.origin.replace("ne.","c.")),isBrowser&&-1!=window.location.href.indexOf("sendmatches=true")&&(currentContext.cartOptions.sendmatches=!0),wslog.info("Starting B2WginData: ",r),currentContext.agendaGroupsMap={},currentContext.agendaGroupsMap.changeCatalogOrCategories={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.changePage={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.addRemoveItem={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.manageCart={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.retrieveItemsFromBundleElement={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.searchItems={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.addRemoveChildItem={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.addChild={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.removeChild={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.changeAttribute={debug:currentContext.DEBUG,grouprules:["agPreSystem","agChangeAttribute","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.resetSaveConfiguration={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.initCart={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agFirstLoad","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.changeCatalog={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agFirstLoad","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.agCheckOut={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCheckOut","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.agCleanCatalog={debug:currentContext.DEBUG,grouprules:["agCleanCatalog"]},currentContext.agendaGroupsMap.changeCategory={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.saveConfiguration={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.saveBundle={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.modifyBundle={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.addBundle={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.reset={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.configureCatalogItem={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.cancelItemConfiguration={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.confirmItemConfiguration={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.updateB2WGinEngine={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},wslog.info("Base agenda groups: ",currentContext.agendaGroupsMap),null!=ifnull(r.cartadministration)){var n=new Object;for(var o in r.cartadministration){var i=o.replace(currentContext.dataInterceptor.prefix,"");n[i=i.replace("__c","")]=r.cartadministration[o]}if(currentContext.contextdata.cartadministration="cartadministration",currentContext.cartadministration=n,void 0!=currentContext.cartOptions&&null!=currentContext.cartOptions)for(var a in currentContext.cartOptions)"facts"!=a&&(currentContext.cartadministration[a]=currentContext.cartOptions[a]);wslog.info("cartadministration: ",currentContext.cartadministration),currentContext.itemsForPage=currentContext.cartadministration.ItemsForPage}if(currentContext.multicurrencyactivated=r.multicurrencyactivated,null!=ifnull(r.mapOfCurrenciesConversion)&&1==r.multicurrencyactivated)for(var s in currentContext.contextdata.currencyconversion="currencyconversion",currentContext.moduleAppVar.currencyconversion=[],r.mapOfCurrenciesConversion){var u=new Object;u.isocode=s,u.value=r.mapOfCurrenciesConversion[s],currentContext.moduleAppVar.currencyconversion.push(u)}wslog.info("Setted itemsForPage ",currentContext.itemsForPage),currentContext.lastMessageType="initCart",t()},function(e){e.method="retrieveB2WGinData",t(e)})}function retrieveProgram(t,e,r,n){b2wgindatainterceptor.retrieveProgram("getCatalogsEligible","1",currentContext.organizationId,function(t){if("0"!=t.errorCode)return generateError("retrieveProgram: "+t.errorMessage),n(t.errorMessage),!1;catalogEngine=t,isBrowser&&wslog.info("Init get catalogs program ended: "+window.location.search),n(null,catalogEngine)},function(t){n(t)})}function retrieveRowParameters(t){b2wgindatainterceptor.retrieveRowParameters("",null,"getPrograms",function(e){if(null!=e&&void 0!=e){currentContext.rowParameters=e.result;for(var r=0;r<currentContext.rowParameters.length;r++)catalogEngine.createAndAdd(currentContext.rowParameters[r],"matrixparameterrow"),null==ifnull(currentContext.moduleAppVar.matrixparameterrow)&&(currentContext.moduleAppVar.matrixparameterrow=[]),currentContext.moduleAppVar.matrixparameterrow.push(currentContext.rowParameters[r]),currentContext.contextdata.matrixparameterrow="matrixparameterrow";t()}else t("error")},function(e){t(e)})}function retrieveContextData(t,e,r){b2wgindatainterceptor.retrieveContextData(t,currentContext.getDataOptionsMap,function(t){if("0"!=t.errorCode)return generateError("retrieveContextData: "+t.errorMessage),r(t.errorMessage),!1;if(null!=t.result&&void 0!=t.result){var e=currentContext.cartOptions.facts;if(null!=ifnull(e))for(var n in e){var o=e[n];if(o.constructor===Array)for(var i=0;i<o.length;i++){var a=Math.random().toString(36).substring(3),s=o[i];null==ifnull(s.id)&&(s.id=a),t.result[n+"___"+s.id]=s}else{a=Math.random().toString(36).substring(3);null==ifnull(o.id)&&(o.id=a),t.result[n]=o}}for(var u in t.result)if(t.result.hasOwnProperty(u))if(wslog.info(u+" -> "+t.result[u]),"-1"!=u.indexOf("___")){f=t.result[u].constructor===String?JSON.parse(t.result[u]):t.result[u];var c=u.split("___")[0];catalogEngine.createAndAdd(f,c),"sessionparameter"==c?(null==ifnull(currentContext.moduleAppVar[c])&&(currentContext.moduleAppVar[c]=[]),f.value=unescape(f.value),currentContext.moduleAppVar[c].push(f),currentContext.contextdata[c]=currentContext.moduleAppVar[c],"confcurrency"==f.name?currentContext.confcurrency=f.value:"taxmodel"==f.name&&(currentContext.taxModelsParameters=f.value),"debugMode"==f.name&&"active"==f.value&&(currentContext.debugMode="active",currentContext.debugLog="")):"cartitem"==c?(null==ifnull(currentContext.cart)&&(currentContext.cart=[]),currentContext.cart.push(f)):"catalog"!=c&&null!=f.id&&""!=f.id&&(null==ifnull(currentContext.moduleAppVar[c])&&(currentContext.moduleAppVar[c]=[]),f.value=unescape(f.value),currentContext.moduleAppVar[c].push(f),currentContext.contextdata[c]=currentContext.moduleAppVar[c])}else{if(1==currentContext.multicurrencyactivated&&void 0!=currentContext.moduleAppVar.sessionparameter&&null!=currentContext.moduleAppVar.sessionparameter){var l={name:"isMultiCurrency",value:"true"};catalogEngine.createAndAdd(l,"sessionparameter"),currentContext.moduleAppVar.sessionparameter.push(l)}var f;f=t.result[u].constructor===String?JSON.parse(t.result[u]):t.result[u],currentContext.moduleAppVar[u]=f,catalogEngine.createAndAdd(f,u),currentContext.contextdata[u]=u}if(currentContext.configuration=currentContext.moduleAppVar.configuration,currentContext.getDataOptionsMap.configurationDateString=currentContext.configuration.NE__order_date__c,null!=ifnull(currentContext.cartadministration.ColumsVisible)&&-1!=currentContext.cartadministration.ColumsVisible.indexOf("showInTable")){null==ifnull(currentContext.moduleAppVar.sessionparameter)&&(currentContext.moduleAppVar.sessionparameter=[]);var d={value:"multiAdd",name:"itemView"};catalogEngine.createAndAdd(d,"sessionparameter"),currentContext.moduleAppVar.sessionparameter.push(d),currentContext.contextdata.sessionparameter=currentContext.moduleAppVar.sessionparameter}currentContext.dataInterceptor.retrieveCatalogsServiceOutput.configuration=currentContext.configuration,r()}},function(t){r(t)})}function retrieveProgramChangeCatalog(t,e,r,n){b2wgindatainterceptor.retrieveProgram(t,e,r,function(t){if("0"!=t.errorCode)return generateError("retrieveProgram: "+t.errorMessage),n(t.errorMessage),!1;wslog.info("change catalog init program starts"),(catalogEngine=t).clearSession(),currentContext.moduleAppVar.category=[],currentContext.moduleAppVar.complex_category=[],wslog.info("Change catalog restoring context contextdata ",currentContext.contextdata),currentContext.contextdata.matrixparameterrow=[];for(var e=0;e<currentContext.cart.length;e++)catalogEngine.createAndAdd(currentContext.cart[e],"cartitem");for(var r in currentContext.contextdata)if(null!=ifnull(currentContext.moduleAppVar[r]))if(wslog.info("Restoring key: "+r),currentContext.moduleAppVar[r]instanceof Array){var o=currentContext.moduleAppVar[r];for(e=0;e<o.length;e++)catalogEngine.createAndAdd(o[e],r)}else catalogEngine.createAndAdd(currentContext.moduleAppVar[r],r);n()},function(t){t.method="retrieveProgramChangeCatalog",n(t)})}function retrieveMatrixParametersChangeCatalog(headerId,callback){wslog.info("retrieveRowParameters"),b2wgindatainterceptor.retrieveMatrixParameters(headerId,function(result){if("0"!=result.errorCode)return generateError("retrieveMatrixParameters: "+result.errorMessage),callback(result.errorMessage),!1;var queryCondition="";if(result.result&&""!=result.result){queryCondition=result.result;for(var splitted=queryCondition.split(" "),tempString="",i=0;i<splitted.length;i++)void 0!=splitted[i]&&" "!=splitted[i]&&-1!=splitted[i].indexOf("$")?(0!=i&&(tempString+=" "),tempString+="'"+eval(splitted[i])+"'"):void 0!=splitted[i]&&" "!=splitted[i]&&(0!=i&&(tempString+=" "),tempString+=splitted[i]);currentContext.queryCondition=tempString}callback(null,currentContext.queryCondition)},function(t){t.method="retrieveMatrixParametersChangeCatalog",callback(t)})}function retrieveRowParametersChangeCatalog(t,e,r){wslog.info("retrieveRowParameters"),currentContext.cartOptions.mpquery?t=currentContext.cartOptions.mpquery:e.mpquery&&(t=e.mpquery),b2wgindatainterceptor.retrieveRowParameters(t,e.catalogid,null,function(t){if("0"!=t.errorCode)return generateError("Unable to load matrix rows parameters: "+t.errorMessage),r(t.errorMessage),!1;currentContext.rowParameters=t.result;for(var e=0;e<currentContext.rowParameters.length;e++)catalogEngine.createAndAdd(currentContext.rowParameters[e],"matrixparameterrow"),null==ifnull(currentContext.moduleAppVar.matrixparameterrow)&&(currentContext.moduleAppVar.matrixparameterrow=[]),currentContext.moduleAppVar.matrixparameterrow.push(currentContext.rowParameters[e]),currentContext.contextdata.matrixparameterrow="matrixparameterrow";null!=ifnull(currentContext.taxModelsParameters)&&(currentContext.getDataOptionsMap.taxModelsParameters=currentContext.taxModelsParameters,currentContext.getDataOptionsMap.catalogHeaderId=currentContext.catalog.headerid,currentContext.getDataOptionsMap.configurationDate=currentContext.configuration.NE__order_date__c),currentContext.getDataOptionsMap.GetAllData=String(currentContext.cartadministration.GetAllData),currentContext.getDataOptionsMap.GetStructure=String(currentContext.cartadministration.GetStructure),currentContext.getDataOptionsMap.CatalogsEligible=currentContext.cartadministration.CatalogsEligible,r(null,currentContext.getDataOptionsMap)},function(t){t.method="retrieveRowParametersChangeCatalog",r(t)})}function retrieveCatalogDataChangeCatalog(t,e,r){var n=t.catalogid;currentContext.selectedCategory=null,b2wgindatainterceptor.retrieveCatalogData(n,"",e,function(e){if("0"!=e.errorCode)return generateError("retrieveCatalogData: "+e.errorMessage),r(e.errorMessage),!1;for(var n in wslog.info("Load catalog data"),e.result)if(e.result.hasOwnProperty(n))if(wslog.info(n+" -> "+e.result[n]),"-1"!=n.indexOf("___")){var o,i=n.split("___")[0];o=e.result[n].constructor===String?JSON.parse(e.result[n]):e.result[n],catalogEngine.createAndAdd(o,i),"undefined"!=currentContext.moduleAppVar[i]&&null!=currentContext.moduleAppVar[i]||(wslog.info("Initialize list: "+i),currentContext.moduleAppVar[i]=[]),"category"!=i||null==ifnull(t.defaultCategory)||t.defaultCategory!=o.categoryFields.enginecode&&t.defaultCategory!=o.categoryFields.id&&t.defaultCategory!=o.categoryFields.name||(currentContext.selectedCategory=o.categoryFields.id,currentContext.catalogSelectedCategory=o.categoryFields.id),currentContext.moduleAppVar[i].push(o),"taxmodel"==i&&(currentContext.contextdata[i]=i)}else currentContext.moduleAppVar[n]=e.result[n],catalogEngine.createAndAdd(JSON.parse(e.result[n]),n);null==currentContext.selectedCategory&&(currentContext.selectedCategory=currentContext.moduleAppVar.category.filter(function(t){return"false"===t.categoryFields.hidden})[0].categoryFields.id,currentContext.catalogSelectedCategory=currentContext.selectedCategory),currentContext.searchActive=!1,currentContext.searchText="",wslog.info("retrieveCatalogItems"),r()},function(t){t.method="retrieveCatalogDataChangeCatalog",r(t)})}function assignObjectNumber(t,e){var r=t;if("-1"!=t.indexOf("___")&&(r=t.split("___")[0]),"bundle"==r)return 0;var n=e[t];if(n.constructor===String)return 9;if(null==ifnull(n.fields))return 8;if("bundleItem"==ifnull(n.fields.categoryname))return 1;switch(n.fields.deeprelationship){case"Product":return 2;case"Child0":return 3;case"Child1":return 4;case"Child2":return 5;case"Child3":return 6;case"Child4":return 7}return 9}function assignItemNumber(t){switch(t.fields.deeprelationship){case"Product":return 2;case"Child0":return 3;case"Child1":return 4;case"Child2":return 5;case"Child3":return 6;case"Child4":return 7}return 9}function assignCategoryNumber(t){switch(t.categoryFields.depth){case"Category0":return 2;case"Category1":return 3;case"Category2":return 4;case"Category3":return 5;case"Category4":return 6;case"Category5":return 7}return 9}function retrieveCatalogBundles(t,e,r){var n=t.catalogid;wslog.info("retrieve bundle data for date: "+currentContext.configuration),b2wgindatainterceptor.retrieveCatalogBundles(n,e,function(t){if("0"!=t.errorCode)return generateError("retrieveCatalogBundle: "+t.errorMessage),void r(t.errorMessage);wslog.info("Load bundle data");var e,n={},o={},i={},a={},s=[];for(var u in t.result){s.push(u);var c=t.result[u];try{c.constructor===String?a[u]=JSON.parse(c):a[u]=c}catch(t){a[u]=c}}for(var l=s.sort(function(t,e){var r=assignObjectNumber(t,a),n=assignObjectNumber(e,a);if(r>=2&&r<=7&&r==n){var o=a[t],i=a[e];return o.fields.sequence-i.fields.sequence}return r-n}),f=0;f<l.length;f++){u=l[f];if(a.hasOwnProperty(u))if(wslog.info(u+" -> ",a[u]),"-1"!=u.indexOf("___")){var d,h=u.split("___")[0];if("itemHeader"!=h&&"complex_program"!=h&&"catCategory"!=h&&"simple_program"!=h){if(d=a[u].constructor===String?JSON.parse(a[u]):a[u],"item"==h){"undefined"!=currentContext.moduleAppVar.bundleItems&&null!=currentContext.moduleAppVar.bundleItems||(currentContext.moduleAppVar.bundleItems=[]),d.fields.visible="false",d.fields.bundleId=i[d.fields.id];d.fields.productname;if(null!=ifnull(_=n[d.fields.sourceId]))for(var p=0;p<_.length;p++){if(_.length>0){var g=JSON.stringify(d);d=JSON.parse(g)}e=_[p],d.fields.bundleElement=e.fields.id,d.fields.bundleId=e.fields.bundleid;var m=o[d.fields.itemHeader];null==ifnull(m)&&(m=[]),m.push(d),o[d.fields.itemHeader]=m,currentContext.moduleAppVar.bundleItems.push(d)}else if("Child-Product"==d.fields.type){var v=o[d.fields.itemHeader];if(null!=ifnull(v))for(p=0;p<v.length;p++){if(v.length>0){g=JSON.stringify(d);d=JSON.parse(g)}var y=v[p];d.fields.bundleElement=y.fields.bundleElement,d.fields.bundleId=y.fields.bundleId,currentContext.moduleAppVar.bundleItems.push(d)}}else currentContext.moduleAppVar.bundleItems.push(d)}else if("bundle"==h){"undefined"!=currentContext.moduleAppVar[h]&&null!=currentContext.moduleAppVar[h]||(wslog.info("Initialize list: "+h),currentContext.moduleAppVar[h]=[]),currentContext.moduleAppVar[h].push(d),catalogEngine.createAndAdd(d,h),currentContext.contextdata.bundle="bundle",i[d.fields.catalogitem]=d.fields.id;for(var x=0;x<d.bundleElements.length;x++){var C=d.bundleElements[x];if(1==C.fields.maxqty&&1==C.fields.minqty&&"Item"==C.fields.type){var _,w=C.fields.elements.split("*row*")[0].split("*el*");null==ifnull(_=n[w[1]])&&(_=[]),_.push(C),n[w[1]]=_}}d}}else"undefined"!=currentContext.moduleAppVar[h]&&null!=currentContext.moduleAppVar[h]||(wslog.info("Initialize list: "+h),currentContext.moduleAppVar[h]=[]),currentContext.moduleAppVar[h].push(d)}else currentContext.moduleAppVar[u]=a[u]}r()},function(t){t.method="retrieveCatalogDataChangeCatalog",r(t)})}function modifyBundle(t,e,r){if(currentContext.currentBundlevid=t.fields.vid,currentContext.dataInterceptor.retrieveItemsServiceOutput.currentBundlevid=currentContext.currentBundlevid,null!=ifnull(currentContext.listOfbundles)){currentContext.getDataOptionsMap.GetAllData_BK=currentContext.getDataOptionsMap.GetAllData,currentContext.getDataOptionsMap.GetAllData="false";for(var n=0;n<currentContext.listOfbundles.length;n++){var o=currentContext.listOfbundles[n];if(o.fields.id==t.fields.bundleId){currentContext.dataInterceptor.bundleToConfigure=o,currentContext.currentBundle=o;for(n=0;n<currentContext.dataInterceptor.bundleToConfigure.bundleElements.length;n++){var i=currentContext.dataInterceptor.bundleToConfigure.bundleElements[n];if(1==i.fields.maxqty&&1==i.fields.minqty&&"Item"==i.fields.type){var a=i.fields.elements.split("*row*");a[0].split("*el*");i.fields.isComplete="true",2==a.length?i.fields.fixed=!0:i.fields.fixed=!1,catalogEngine.modify(currentContext.dataInterceptor.bundleToConfigure)}}break}}retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(t){e()},function(t){r(t)})}}function retrieveBundleData(t,e,r,n,o){var i,a={};if(currentContext.cartadministration.GetStructure){var s={};s.result={},s.errorCode="0",s.errorMessage="";var u=currentContext.listOfItems.filter(function(t){return"Product"===t.fields.type&&t.fields.bundleId===currentContext.dataInterceptor.bundleToConfigure.fields.id});u=u.sort(function(t,e){return null!=ifnull(t.fields.bundleElement)&&null==ifnull(e.fields.bundleElement)?1:t.fields.sequence>e.fields.sequence?1:-1});for(var c=0;c<u.length;c++){var l=u[c];wslog.info("Found product bundle item to add into the list with id: "+l.fields.id),(d=Object.assign(new Object,l)).fields.vid=Math.random().toString(36).substring(3),d.fields.itemCode=d.fields.vid,d.fields.isCatalogItem=!1,d.fields.isCart=!0,0==d.fields.qty&&(d.fields.qty=1),d,a[d.fields.itemheaderId]=d,null!=ifnull(d.fields.bundleId)&&null==ifnull(d.fields.bundleElement)?i=d:d.fields.bundlevid=i.fields.vid,a[d.fields.catalogitemid]=d,s.result["cartitem___"+d.fields.vid]=d}var f=currentContext.listOfItems.filter(function(t){return"Child-Product"===t.fields.type&&null!=ifnull(t.fields.defaultQty)&&t.fields.bundleId===currentContext.dataInterceptor.bundleToConfigure.fields.id});for(c=0;c<f.length;c++){var d;l=f[c];wslog.info("Found child bundle item to add into the list with id: "+l.fields.id),(d=Object.assign(new Object,l)).fields.vid=Math.random().toString(36).substring(3),d.fields.itemCode=d.fields.vid,d.fields.isCatalogItem=!1,d.fields.isCart=!0,0==d.fields.qty&&(d.fields.qty=1),d.fields.qty=d.fields.defaultQty;var h=a[d.fields.parent];null==ifnull(h)&&(h=a[d.fields.productcatalogitem]),d.fields.parentvid=h.fields.vid;var p=a[d.fields.itemheaderId];d.fields.rootvid=p.fields.vid,null!=ifnull(d.fields.bundleId)&&null==ifnull(d.fields.bundleElement)?i=d:d.fields.bundlevid=i.fields.vid,a[d.fields.catalogitemid]=d,s.result["cartitem___"+d.fields.vid]=d}n(s)}else b2wgindatainterceptor.retrieveBundleData(t,e,currentContext.getDataOptionsMap,function(t){n(t)})}function addBundle(t,e,r){var n,o={},i=[];currentContext.mapOfBundleElements={},currentContext.mapOfBundleLogicalConn={},currentContext.getDataOptionsMap.GetAllData_BK=currentContext.getDataOptionsMap.GetAllData,currentContext.getDataOptionsMap.GetAllData="false";for(var a=0;a<currentContext.listOfbundles.length;a++)currentContext.listOfbundles[a].fields.id==t.fields.id&&(t=currentContext.listOfbundles[a],currentContext.currentBundle=t);for(a=0;a<t.bundleElements.length;a++){var s=t.bundleElements[a];if(1==s.fields.maxqty&&1==s.fields.minqty&&"Item"==s.fields.type){var u=s.fields.elements.split("*row*"),c=u[0].split("*el*");o[c[1]]=s,i.push(c[1]),s.fields.isComplete="true",2==u.length?s.fields.fixed=!0:s.fields.fixed=!1,currentContext.mapOfBundleElements[s.fields.id]=s}}catalogEngine.modify(t),currentContext.dataInterceptor.bundleToConfigure=t,wslog.info("itemsExternalIds: ",i),wslog.info("Adding bundle: ",t),retrieveBundleData(t.fields.catalogItemSourceId,i,currentContext.getDataOptionsMap,function(i){for(var a in"0"!=i.errorCode&&(generateError("retrieveBundleInformation: "+i.errorMessage),r(i.errorMessage)),wslog.info("added bundle or bundle element: ",i),i.result)if(i.result.hasOwnProperty(a)&&(wslog.info(a+" -> ",i.result[a]),"-1"!=a.indexOf("___"))){var s=a.split("___")[0],u=i.result[a];if(u.constructor!==Object&&(u=JSON.parse(i.result[a])),u.fields.visible=u.fields.visiblefromdb,null!=(n=o[u.fields.sourceId])&&"Product"==u.fields.type){if(null!=ifnull(n.fields.recurringchargediscount)&&(u.fields.baserecurringcharge=u.fields.baserecurringcharge*n.fields.recurringchargediscount/100),null!=ifnull(n.fields.recurringchargeoverride)&&(u.fields.baserecurringcharge=n.fields.recurringchargediscount),null!=ifnull(n.fields.baseonetimefeediscount)&&(u.fields.baseonetimefee=u.fields.baseonetimefee*n.fields.baseonetimefeediscount/100),null!=ifnull(n.fields.baseonetimefeeoverride)&&(u.fields.baseonetimefee=currentContext.currentBundleElement.fields.baseonetimefeeoverride),u.fields.bundleElement=n.fields.id,u.fields.bundlevid=currentContext.currentBundlevid,currentContext.mapOfBundleLogicalConn[n.fields.id]=u.fields.vid,null!=ifnull(n.fields.parentBundleElement)){var c=currentContext.mapOfBundleElements[n.fields.parentBundleElement];null!=ifnull(c)&&(u.fields.logicalParent=currentContext.mapOfBundleLogicalConn[c.fields.id])}}else null==n&&"Product"==u.fields.type?currentContext.currentBundlevid=u.fields.vid:null!=n&&"Child-Product"==u.fields.type&&(u.fields.bundleElement=n.fields.id);u.fields.bundleId=t.fields.id,catalogEngine.createAndAdd(u,s),"undefined"!=currentContext.moduleAppVar[s]&&null!=currentContext.moduleAppVar[s]||(wslog.info("Initialize list: "+s),currentContext.moduleAppVar[s]=[]),currentContext.moduleAppVar[s].push(u)}retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(t){e(t)},function(t){r(t)})},function(t){r(t)},{escape:!1})}function retrieveItemsFromBundleElement(t,e,r,n){null!=t&&void 0!=t?(wslog.info("bundleElement.fields.id: "+t.fields.id),currentContext.getDataOptionsMap.bundleElement=t.fields.id,null!=ifnull(t.fields.filter)?currentContext.getDataOptionsMap.bundleElementFilter=t.fields.filter:delete currentContext.getDataOptionsMap.bundleElementFilter,currentContext.cachedResponse={},currentContext.currentBundleElement=t,retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,t.fields.id,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(t){r(t)},function(t){n(t)})):r({})}function saveBundle(t,e){currentContext.dataInterceptor.configure=!1,currentContext.dataInterceptor.componentToShow="catalog",currentContext.dataInterceptor.itemToShow=null,currentContext.itemheaderId=null,currentContext.complexProductToOpen=null,currentContext.complexProductId=null,"true"==currentContext.getDataOptionsMap.GetAllData_BK?currentContext.getDataOptionsMap.GetAllData="true":currentContext.getDataOptionsMap.GetAllData="false",wslog.info("Return to shopping cart"),currentContext.saveBackup=!1,currentContext.getDataOptionsMap.bundleElement=null,delete currentContext.getDataOptionsMap.bundleElementFilter,currentContext.cachedResponse={},currentContext.currentBundleElement=null,currentContext.currentBundle=null,currentContext.currentBundlevid=null,retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(e){t(e)},function(t){e(t)})}function removeBundle(t){removeItemFromCart()}var b2wginCartToReturn={initCart:function(t,e){return e&&(currentContext=new CurrentContext(e)),currentContext.initInProgress=!0,new Promise(function(e,r){null==t&&(t={}),currentContext.cartOptions=t,b2wgindatainterceptor.setExternalOptions(currentContext.cartOptions),void 0==currentContext.cartOptions.enableCartEvents&&(currentContext.cartOptions.enableCartEvents=!1),currentContext.cartOptions&&currentContext.cartOptions.logLevel?wslog.setLevel(wslog.levels[currentContext.cartOptions.logLevel]):wslog.setLevel(wslog.levels.SILENT),currentContext.cartOptions.enableCartEvents&&window.addEventListener("message",function(t){var e;try{e=JSON.parse(t.data),wslog.info("Received message: "),wslog.info(t.origin),wslog.info(currentContext.lexOrigin),wslog.info("messageReceived: ",e),wslog.info("messageReceived type: "+e.type),wslog.info("event.origin: "+t.origin),logMessage("Received Message","MessageJSON",e)}catch(t){(e=new Object).type="unsupported"}t.origin==currentContext.lexOrigin&&"unsupported"!=e.type&&(0==currentContext.initInProgress&&0==currentContext.actionInProgress?(e.protectedMessage.type=e.type,b2wginCartToReturn.manageRequest(e.protectedMessage)):wslog.info("Init in progress, action skipped"))},!1),async.series([function(t){retrieveB2WGinData(t)},function(t){retrieveProgram("getCatalogsEligible","1",currentContext.organizationId,t)},function(t){retrieveContextData(isBrowser?window.location.search:currentContext.cartOptions.search,currentContext.getDataOptionsMap,t)},function(t){retrieveRowParameters(t)}],function(t,n){if(t)return currentContext.initInProgress=!1,generateError(t),r(t),!1;catalogEngine.fire(null,function(t){if(wslog.info("result"),wslog.info(t),currentContext.cartOptions.sendmatches&&(currentContext.dataInterceptor.retrieveCatalogsServiceOutput.matches=t.matches),null!=t.matches.catalog&&void 0!=t.matches.catalog){currentContext.catalogHeaders=[],currentContext.dataInterceptor.retrieveCatalogsServiceOutput.catalogs=[];try{for(var n=0;n<t.matches.catalog.length;n++)if(1==t.matches.catalog[n].eligible){var o=new Object,i={};i.Name=t.matches.catalog[n].commModelName,i.Id=t.matches.catalog[n].headerid,o.catalog=i,currentContext.dataInterceptor.retrieveCatalogsServiceOutput.catalogs.push(o),wslog.info(currentContext.dataInterceptor.retrieveCatalogsServiceOutput.catalogs),currentContext.catalogHeaders.push(t.matches.catalog[n])}}catch(t){wslog.info("dataInterceptor err: "+t)}}wslog.info("Send Catalog"),sendMessage("retrieveCatalogsServiceOutput",currentContext.dataInterceptor),wslog.info("Catalogs sent: "+currentContext.catalogHeaders.length),void 0==currentContext.catalogHeaders||0==currentContext.catalogHeaders.length?(wslog.info("No eligible catalogs found"),currentContext.initInProgress=!1,generateError("No eligible catalogs found"),r("No eligible catalogs found")):selectCatalog(currentContext.catalogHeaders[0].headerid,function(t){currentContext.initInProgress=!1,sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),e(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){currentContext.initInProgress=!1,r(t)})})})})},manageRequest:function(t,e){return new Promise(function(r,n){try{if(e&&(currentContext=new CurrentContext(e)),currentContext.requestQueue=[],t.execute=!0,0==currentContext.requestQueue.length||1==t.execute){"unsupported"!=t.type&&(currentContext.lastMessageType=ifnull(t.type),currentContext.lastMessageAction=ifnull(t.action),currentContext.actionInProgress=!0);if(1=={modifyItem:!0,addItem:!0,removeItem:!0,add:!0,addFromMessage:!0,remove:!0,removeChild:!0,clearCart:!0,modify:!0,goBack:!0,checkout:!0,changeQty:!0,configureCatalogItem:!0}[currentContext.lastMessageType]&&(currentContext.lastMessageAction=currentContext.lastMessageType,currentContext.lastMessageType="manageCart"),"changeCatalogOrCategories"==t.type)wslog.info("isCatalog: "+t.isCatalog),t.isCatalog?selectCatalog(t.catalogId,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)}):changeCategory(t.categoryId,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)});else if("changeCatalog"==t.type)selectCatalog(t.catalogId,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)});else if("changeCategory"==t.type)changeCategory(t.categoryId,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)});else if(1==t.retrieveContextData){var o=b2wginCartToReturn.retrieveContext();o.action="retrieveContextData",sendMessage("retrieveContextData",o),currentContext.actionInProgress=!1,r(new cbResponse(o,"retrieveContextData"))}else if("changePage"==t.type)changePage(t.page,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)});else if("addRemoveItem"==t.type||"manageCart"==t.type)if(wslog.info("addRemoveItem action: "+t.action),"add"==t.action||"addItem"==t.action)t.action="add",addItemToCart(t.item,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)});else if("addFromMessage"==t.action)addItemFromMessage(t.mapOfItems,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)});else if("remove"==t.action||"removeItem"==t.action)t.action="remove",removeItemFromCart(t.item,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)});else if("removeChild"==t.action)t.item.action="Remove",removeItemFromCart(t.item,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)});else if("clearCart"==t.action)clearCart(function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)});else if("modify"==t.action||"modifyItem"==t.action)t.action="modify",modifyItem(t.item,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput")),null!=ifnull(currentContext.dataInterceptor.lastChild)&&(currentContext.dataInterceptor.lastChild.fields.engineAction="")},function(t){n(t)});else if("GoBack"==t.action||"goBack"==t.action){var i=currentContext.cartMap[t.item.fields.parentvid];wslog.info("Goback parentitem: ",i),currentContext.complexProductToOpen=i.fields.vid,changeChildProduct(i,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)})}else"checkout"==t.action?checkOut(function(t){currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)}):"changeQty"==t.action?(sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),changeQuantity(t.item,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)})):"configureCatalogItem"==t.action&&configureCatalogItem(t.item,function(t){currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)});else"addRemoveChildItem"==t.type||"addChild"==t.type?(wslog.info("addRemoveChildItem action: "+t.action),wslog.info("addRemoveChildItem complexProductToOpen: "+currentContext.complexProductToOpen),t.type="addRemoveChildItem",addItemToCart(t.itemChanged,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)})):"changeAttribute"==t.type?(null!=ifnull(currentContext.dataInterceptor.lastChild)&&(currentContext.dataInterceptor.lastChild.fields.engineAction=""),changeAttribute(t.itemChanged,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)})):"resetSaveConfiguration"==t.type||"saveConfiguration"==t.type?(t.type="resetSaveConfiguration",null!=ifnull(currentContext.currentBundlevid)&&(currentContext.blockSendMessage=!0),resetSaveConfiguration(function(e){if(null!=ifnull(currentContext.currentBundlevid)){var o;currentContext.blockSendMessage=!1;for(var i=0;i<currentContext.cart.length;i++)if(currentContext.cart[i].fields.vid==currentContext.currentBundlevid){o=currentContext.cart[i];break}modifyBundle(o,function(e){currentContext.dataInterceptor.bundleToConfigure=t.bundleItem,sendMessage("showBundleConfigurator",currentContext.dataInterceptor),currentContext.actionInProgress=!1,currentContext.complexProductId=null,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)})}else sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)})):"searchItems"==t.type?searchItems(t,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)}):"confirmItemConfiguration"==t.type?confirmItemConfiguration(function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)}):"cancelItemConfiguration"==t.type?cancelItemConfiguration(t.item,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)}):"reset"==t.type||"resetConfiguration"==t.type?(t.type="reset",rollbackConfiguration(function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)})):"retrieveItemsFromBundleElement"==t.type?retrieveItemsFromBundleElement(t.BundleElement,0,function(t){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsFromBundleElement"))},function(t){n(t)}):"addBundle"==t.type?void 0==t.bundleItem.fields.vid||null==t.bundleItem.fields.vid?addBundle(t.bundleItem,function(t){sendMessage("showBundleConfigurator",currentContext.dataInterceptor),currentContext.actionInProgress=!1,currentContext.complexProductId=null,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)}):modifyBundle(t.bundleItem,function(t){sendMessage("showBundleConfigurator",currentContext.dataInterceptor),currentContext.actionInProgress=!1,currentContext.complexProductId=null,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)}):"modifyBundle"==t.type?modifyBundle(t.bundleItem,function(e){currentContext.dataInterceptor.bundleToConfigure=t.bundleItem,sendMessage("showBundleConfigurator",currentContext.dataInterceptor),currentContext.actionInProgress=!1,currentContext.complexProductId=null,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)}):"saveBundle"==t.type?(t.type="saveBundle",saveBundle(function(t){sendMessage("changeComponentToShow",currentContext.dataInterceptor),currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)})):"configureCatalogItem"==t.type?configureCatalogItem(t.item,function(t){currentContext.actionInProgress=!1,r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){n(t)}):"updateB2WGinEngine"==t.type?b2wginCartToReturn.updateB2WGinEngine(t.updateB2WGinEngine).then(function(e){currentContext.actionInProgress=!1,1==t.updateB2WGinEngine.executeRules?(sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),r(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))):r("0")}).catch(function(t){n(t)}):(currentContext.actionInProgress=!1,sendMessage("stopLoading","Unsupported message"),n("Unsupported message"))}}catch(t){currentContext.actionInProgress=!1,n(t),wslog.info("Skipped not cart message: "+t)}})},getOrganization:function(){return currentContext.organizationId},getCategories:function(){return currentContext.moduleAppVar.category},getCatalogSelectedCategory:function(){return currentContext.catalogSelectedCategory},getDataInterceptor:function(){return currentContext.dataInterceptor},getCatalogProgramName:function(){return currentContext.catalogprogramname},getCurrentRootVid:function(){return currentContext.rootVid},getCart:function(){return currentContext.cart},getConfiguration:function(){return currentContext.configuration},retrieveContext:function(){var t=JSON.stringify(currentContext);return JSON.parse(t)},restoreContext:function(t,e,r){wslog.info("restoring context contextdata ",t),(currentContext=t).lastMessageType="changePage",b2wgindatainterceptor.setExternalOptions(currentContext.cartOptions),b2wgindatainterceptor.retrieveProgram(currentContext.programname,currentContext.version,currentContext.organizationId,function(t){if("0"!=t.errorCode)return generateError("retrieveProgram: "+t.errorMessage),r(t.errorMessage),!1;(catalogEngine=t).clearSession();for(var n=0;n<currentContext.cart.length;n++)catalogEngine.createAndAdd(currentContext.cart[n],"cartitem");for(var o in currentContext.contextdata)if(wslog.info("Restoring key: "+o),null!=ifnull(currentContext.moduleAppVar[o]))if(currentContext.moduleAppVar[o]instanceof Array){var i=currentContext.moduleAppVar[o];for(n=0;n<i.length;n++)catalogEngine.createAndAdd(i[n],o)}else catalogEngine.createAndAdd(currentContext.moduleAppVar[o],o);isBrowser?retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(){e(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){r(t)}):e(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(t){r(t)})},cartMap:currentContext.cartMap,retrieveCartItem:b2wgindatainterceptor.retrieveCartItem,getCurrentContext:function(){return currentContext},reInitCart:function(t){return this.initCart(t,{})},getCurrentFacts:function(){return catalogEngine.retrieveCurrentFacts()},updateB2WGinEngine:function(t){return new Promise(function(e,r){try{if(t.constructor!==Object)throw new Error("first param must be an object");if(void 0===catalogEngine)throw new Error("Engine is not initialized");for(var n=t.objectList,o=0;o<n.length;o++){var i=n[o],a=i.action;if(!a)throw new Error("Action not set!");a=a.toLowerCase();var s=i.type;if(!s)throw new Error("Type not set!");var u=i.instance;if("add"===a){if(!u)throw new Error("no object(s) of [ "+s+" ] to add");try{if(u.constructor===Array)for(var c=0;c<u.length;c++)catalogEngine.createAndAdd(u[c],s);else catalogEngine.createAndAdd(u,s)}catch(t){throw new Error("Error in adding [ "+s+" ] objects. Operation aborted. Stack: "+JSON.stringify(t))}}else{if("modify"!==a&&"remove"!==a)throw new Error("action not defined [add, modify or remove]");var l=i.instance,f=i.uniqueid;if(!f)throw new Error("uniqueId is mandatory");var d=i.value;if(!d)throw new Error("value to check is mandatory");if(d.constructor===Array&&"modify"===a)throw new Error("value can't be an array");if("modify"===a&&!l)throw new Error("no object of [ "+s+" ] to modify!");var h=f.split("."),p=catalogEngine.retrieveCurrentFacts()[s].filter(function(t){if(1===h.length)return d.constructor!==Array?t[f]===d:d.indexOf(t[f])>-1;for(var e=t[h[0]],r=1;r<h.length;r++)e=e[h[r]];return d.constructor!==Array?e===d:d.indexOf(e)>-1});if(0===p.length){wslog.info("no object [ "+s+" ] found with [ "+f+" ] === "+d);continue}if("modify"===a)catalogEngine.remove(p[0]),catalogEngine.createAndAdd(l,s);else for(var g=0;g<p.length;g++)catalogEngine.remove(p[g])}}1==t.executeRules?retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(){e(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))}):e("0"),e("0")}catch(t){r(t.message)}})}};return b2wginCartToReturn};module.exports=b2wgin_cart},{"./callbackResponse.js":8,"./currentContext.js":9,"./interceptor.js":11,"./logging.js":12}],6:[function(t,e,r){var n=new(t("./b2wgin_cart.js"));e.exports=n},{"./b2wgin_cart.js":5}],7:[function(t,e,r){var n=function(){var e,r=function(){var t,e,r,n;return r={},n={},function(o){var i,a,s=[],u=[];for(i in o)a=o[i],n[i]=a,r[a]=i,s.push(a),u.push(i);t=new RegExp("("+s.join("|")+")","g"),e=new RegExp("("+u.join("|")+"|&#[0-9]{1,5};)","g")}({"&amp;":"&","&gt;":">","&lt;":"<","&quot;":'"',"&#39;":"'"}),{htmlEncode:function(e){return e?String(e).replace(t,function(t,e){return r[e]}):e},htmlDecode:function(t){return t?String(t).replace(e,function(t,e){return e in n?n[e]:String.fromCharCode(parseInt(e.substr(2),10))}):t}}}();var n=t("./engine.js");return{engine:function(t,r){return e=new n(t,r)},init:function(t,r){e.init(function(e){t(e)},function(t){r(t)})},htmlEnDeCode:r}}();e.exports=n},{"./engine.js":10}],8:[function(t,e,r){e.exports=function(t,e){var r={};for(var n in t)t.hasOwnProperty(n)&&(!t[n]||t[n].constructor!==Array&&t[n].constructor!==Object)&&(r[n]=t[n]);return e&&t.hasOwnProperty(e)&&(r[e]=t[e]),r}},{}],9:[function(t,e,r){e.exports=function(t){if(this.whatShow="Catalog",this.viewType="Standard",this.defaultCurrency="EUR",this.listOfItems=[],this.currentPage=1,this.catalogs=[],this.cart=[],this.cartInfo={},this.messages=[],this.searchText="",this.account={},this.servAccount={},this.billAccount={},this.configuration={},this.catalogs=[],this.searchActive=!1,this.countItemCart=0,this.existingOrderItems=[],this.contextdata={},this.DEBUG=!1,this.dataInterceptor,this.requestQueue=[],this.blockSendMessage=!1,this.executedRules={},this.cartOptions={},this.moduleAppVar={},this.debugMode="Debug is not active",this.debugLog="Debug is not active",this.debugTimes={},this.tempConfigurationVid=null,this.cartMap={},this.backUpConfiguration,this.saveBackup=!1,this.getDataOptionsMap={},this.loadedItems={},this.cachedResponse={},this.catalogprogramname="",this.catalogversion="",this.organizationId="",this.lexOrigin="",this.agendaGroupsMap={},this.cartadministration=null,this.itemsForPage=null,this.multicurrencyactivated=!1,this.lastMessageType="",this.confcurrency=null,this.Configuration=null,this.rowParameters=null,this.catalogHeaders=null,this.selectedCatalog=null,this.catalog=null,this.programname="",this.version=null,this.category=null,this.selectedCategory=null,this.queryCondition="",this.taxModelsParameters=null,this.selectedCategory=null,this.catalogSelectedCategory=null,this.lastItemAdded=null,this.itemheaderId=null,this.complexProductToOpen=null,this.rootvid=null,this.prefix="",this.lastMessageAction="",this.offset=1,this.complexProductId=null,this.rootCatalogitemid=null,this.componentToShow=null,this.currencyconversion=[],this.initInProgress=!1,this.productCatalogItemId=null,this.listOfbundles=[],this.currentBundleElement=null,this.actionInProgress=!1,this.currentBundlevid=null,this.mapOfBundleElements={},this.mapOfBundleLogicalConn={},this.currentBundle=null,t)for(var e in t)this[e]=t[e];return this}},{}],10:[function(t,e,r){e.exports=function(e,r){var n=t("./b2wginInstance.js"),o="undefined"!=typeof window&&"[object Window]"==={}.toString.call(window),i=t("underscore"),a=t("../common/logging.js");return{bootstrapEngine:function(t,e,r){var a;if(void 0===(a=b2wgin.getFlow(t))){if(o){var s=document.createElement("script");s.type="text/javascript",s.text=e,s.id=t,document.head.appendChild(s),a=b2wgin.getFlow(t)}else a=b2wgin.compile(e,{name:t,scope:i});if(o){var u=document.getElementById(t);u.parentNode.removeChild(u)}}var c=new n(a.getSession()),l={array:Array,string:String,number:Number,boolean:Boolean,regExp:RegExp,date:Date,object:Object};for(var f in a.__defined)void 0==l[f]&&(l[f]=a.getDefined(f));c.classDefinitions=l,r(c)},bootstrapEngineSM:function(t,e,r,o){var s;if(void 0===(s=b2wgin.getFlow(t))||r){void 0!==s&&(a.info("Program [ "+t+" ] changed. Force reload!"),b2wgin.deleteFlow(t));const r=a.startTimer(t+" loaded");s=b2wgin.compile(e,{name:t,scope:i}),r.done({message:t+" loaded"}),s=b2wgin.getFlow(t)}else a.info("[ "+t+" ]already avalaible");var u=new n(s.getSession()),c={array:Array,string:String,number:Number,boolean:Boolean,regExp:RegExp,date:Date,object:Object};for(var l in s.__defined)void 0==c[l]&&(c[l]=s.getDefined(l));u.classDefinitions=c,o(u)}}}},{"../common/logging.js":1,"./b2wginInstance.js":4,underscore:3}],11:[function(t,e,r){"use strict";var n,o,i,a=(n=t("./b2wginapi.js"),o={},i={},{retrieveBundleData:function(t,e,r,n){r.bundleId=t,r.actionType="retrieveBundleData",r.itemsExternalIds=JSON.stringify(e),NE.b2wgin_DataRetrieve.executeAction(r,function(t){null!=n&&"undefined"!=n&&n(t)},{escape:!1})},retrieveCatalogBundles:function(t,e,r){e.catalogId=t,e.actionType="retrieveCatalogBundles",NE.b2wgin_DataRetrieve.executeAction(e,function(t){null!=r&&"undefined"!=r&&r(t)},{escape:!1})},setExternalOptions:function(t){},retrieveCatalogItemsAttachment:function(t,e,r,n,a,s,u){var c="true"==s.GetAllData,l="true"==s.GetStructure,f=null!=s.currentCatalogItemId?s.currentCatalogItemId:"",d=null!=s.itemheaderId?s.itemheaderId:"",h=!1,p=null!=o&&Object.keys(o).length>0,g="";if(""!=d?null!=i&&Object.keys(i).length>0&&(g=null!=i[d]&&void 0!=i[d]?i[d]:""):null!=i&&Object.keys(i).length>0&&(g=null!=e?null!=i[e]&&void 0!=i[e]?i[e]:"":null!=i.simpleProduct&&void 0!=i.simpleProduct?i.simpleProduct:""),p&&(c&&(""==f||""!=g&&-1!=g.indexOf(f))||l&&""!=g&&""!=f&&-1!=g.indexOf(f)&&g!=f+";")&&(h=!0),console.log("*** isInCache: "+h),h){console.log("*** try to retrieve from cache!");var m={},v={},y=!1;for(var x in o.result)if("-1"!=x.indexOf("___")){var C,_=x.split("___")[0];if(o.result[x].constructor===String)try{C=JSON.parse(o.result[x])}catch(t){}else C=o.result[x];console.log("*** parsedElement: ",C),console.log("*** catalogId: "+t),"item"==_?C.fields.catalogid==t&&("Product"==C.fields.type?c?(v[x]=o.result[x],y=!0):C.fields.categoryid==e&&(v[x]=o.result[x],y=!0):l?(v[x]=o.result[x],y=!0):""!=d&&C.fields.itemHeader==d&&(v[x]=o.result[x],y=!0)):"complex_category"==_?C.categoryFields.itemHeader==d&&(v[x]=o.result[x],y=!0):v[x]=o.result[x]}else v[x]=o.result[x];m.result=v,Object.keys(v).length>0&&y?(m.errorCode="0",u(m)):h=!1}h||(console.log("*** retrieve from sf!"),NE.b2wgin_DataRetrieve.retrieveCatalogItemsAttachment(t,e,r,n,a,s,function(t){if(c||l)for(var e in t)if(o[e]=t[e],"result"==e)for(var r in t.result){if(r.startsWith("itemHeader___")){var n=r.split("itemHeader___")[1];i[n]=t.result[r]}r.startsWith("catCategory___")&&(n=r.split("catCategory___")[1],i[n]=t.result[r])}null!=u&&"undefined"!=u&&u(t)},{escape:!1}))},retrieveCartItem:function(t,e,r){NE.b2wgin_DataRetrieve.retrieveCartItem(t,e,function(t){null!=r&&"undefined"!=r&&r(t)},{escape:!1})},retrieveAutoAddedChildren:function(t,e,r,n,o){NE.b2wgin_DataRetrieve.retrieveAutoAddedChildren(t,e,r,function(t){null!=o&&"undefined"!=o&&o(t)},{escape:!1})},retrieveComplexProductsData:function(t,e,r,n,a,s,u,c){var l="true"==u.GetStructure,f=u.currentCatalogItemId,d=!1,h=null!=o&&Object.keys(o).length>0,p="";if(""!=e?null!=i&&Object.keys(i).length>0&&(p=null!=i[e]&&void 0!=i[e]?i[e]:""):null!=i&&Object.keys(i).length>0&&(p=null!=i.simpleProduct&&void 0!=i.simpleProduct?i.simpleProduct:""),h&&l&&""!=p&&-1!=p.indexOf(f)&&p!=f+";"&&(d=!0),console.log("*** isInCache: "+d),d){console.log("*** try to retrieve from cache (complexProductsData)!");var g={result:{}};if(null!=e){var m=o.result["complex_program___"+e];g.result.programName=m.substring(0,m.indexOf(":")),g.result.programVersion=m.substring(m.indexOf(":")+1);var v=p.split(";");for(var y in v){var x=v[y];null!=o.result["complex_category___"+x]&&void 0!=o.result["complex_category___"+x]&&(g.result["complex_category___"+x]=o.result["complex_category___"+x])}}Object.keys(g.result).length>0?(g.errorCode="0",c(g)):d=!1}d||(console.log("*** retrieve from sf (complexProductsData)!"),NE.b2wgin_DataRetrieve.retrieveComplexProductsData(t,e,r,n,a,s,function(t){if(l)for(var e in t)if(o[e]=t[e],"result"==e)for(var r in t.result){if(r.startsWith("itemHeader___")){var n=r.split("itemHeader___")[1];i[n]=t.result[r]}r.startsWith("catCategory___")&&(n=r.split("catCategory___")[1],i[n]=retrieveCatalogItemsAttachmentResponse.result[r])}null!=c&&"undefined"!=c&&c(t)},{escape:!1}))},retrieveProgram:function(t,e,r,o){var i=n.engine(t,e,r),a=t.replace(/ /g,"_")+"_"+e.replace(".","_");if("undefined"!=Cache&&null!=Cache&&void 0!=Cache[a]){console.log("Cached program retrieved");var s=Cache[a];s.errorCode="0",s.errorMessage="",o(Cache[a])}else NE.b2wgin_DataRetrieve.retrieveProgram(t,e,r,function(t,e){var r=t.value;if("0"==t.errorCode)i.bootstrapEngine(a,n.htmlEnDeCode.htmlDecode(r.rules),function(t){t.errorCode="0",t.errorMessage="",o(t)});else{var s=new Object;s.errorCode=t.errorCode,s.errorMessage=t.errorMessage,console.log("Error in retrieveProgramResponse: ",s),o(s)}})},retrieveCatalogData:function(t,e,r,n){NE.b2wgin_DataRetrieve.retrieveCatalogData(t,e,r,function(t){null!=n&&"undefined"!=n&&n(t)},{escape:!1})},retrieveMatrixParameters:function(t,e){NE.b2wgin_DataRetrieve.retrieveMatrixParameterQueryWhere(t,function(t){null!=e&&"undefined"!=e&&e(t)},{escape:!1})},retrieveRowParameters:function(t,e,r,n){console.log("query: "+t),console.log("catalogId: "+e),console.log("matrixName: "+r),NE.b2wgin_DataRetrieve.retrieveRowParametersWithMatrixAndCatalog(t,e,r,function(t){null!=n&&"undefined"!=n&&n(t)},{escape:!1})},checkoutCart:function(t,e){NE.b2wgin_DataRetrieve.checkoutCart(JSON.stringify(t.retrieveItemsServiceOutput),function(t){null!=e&&"undefined"!=e&&e(t)},{escape:!1,timeout:12e4})},retrieveB2WGinData:function(t,e){NE.b2wgin_DataRetrieve.retrieveB2WGinData(function(t){null!=e&&"undefined"!=e&&e(t)},{escape:!1})},retrieveContextData:function(t,e,r){NE.b2wgin_DataRetrieve.retrieveContextData(t,function(t){null!=r&&"undefined"!=r&&r(t)},{escape:!1})},getLoadedItemsId:function(t,e){null!=i&&null!=e&&"undefined"!=e&&e(i[t])}});e.exports=a},{"./b2wginapi.js":7}],12:[function(t,e,r){arguments[4][1][0].apply(r,arguments)},{dup:1,loglevel:2}]},{},[6])(6)});
/* eslint-enable */
