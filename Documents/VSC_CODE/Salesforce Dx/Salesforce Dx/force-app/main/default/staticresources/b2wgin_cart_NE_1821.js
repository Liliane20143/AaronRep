/*! b2wgin - v1.0.0 - 2019-02-18
* Copyright (c) 2019 b2wgin team; */
/* eslint-disable */
!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c||a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){(function(){"use strict";var b=a("../");"function"!=typeof Object.getPrototypeOf&&(Object.getPrototypeOf="".__proto__===String.prototype?function(a){return a.__proto__}:function(a){return a.constructor.prototype}),"function"==typeof this.define&&this.define.amd?define([],function(){return b}):this.b2wgin=b}).call("undefined"!=typeof window?window:this)},{"../":2}],2:[function(a,b,c){b.exports=a("./lib")},{"./lib":15}],3:[function(a,b,c){"use strict";var d=a("./extended"),e=d.declare,f=d.AVLTree,g=d.LinkedList,h=d.isPromiseLike,i=a("events").EventEmitter,j=e({instance:{constructor:function(){this.memory={},this.memoryValues=new g},clear:function(){this.memoryValues.clear(),this.memory={}},remove:function(a){var b=a.hashCode,c=this.memory,d=c[b];return d&&(this.memoryValues.remove(d),delete c[b]),d},insert:function(a){var b=a.hashCode;if(b in this.memory)throw new Error("Activation already in agenda "+a.rule.name+" agenda");this.memoryValues.push(this.memory[b]=a)}}}),k="main";b.exports=e(i,{instance:{constructor:function(a,b){this.agendaGroups={},this.agendaGroupStack=[k],this.rules={},this.flow=a,this.comparator=b,this.setFocus(k).addAgendaGroup(k)},addAgendaGroup:function(a){d.has(this.agendaGroups,a)||(this.agendaGroups[a]=new f({compare:this.comparator}))},getAgendaGroup:function(a){return this.agendaGroups[a||k]},setFocus:function(a){return a!==this.getFocused()&&this.agendaGroups[a]&&(this.agendaGroupStack.push(a),this.emit("focused",a)),this},getFocused:function(){var a=this.agendaGroupStack;return a[a.length-1]},getFocusedAgenda:function(){return this.agendaGroups[this.getFocused()]},register:function(a){var b=a.rule.agendaGroup;this.rules[a.name]={tree:new f({compare:this.comparator}),factTable:new j},b&&this.addAgendaGroup(b)},isEmpty:function(){for(var a=this.agendaGroupStack,b=!1;this.getFocusedAgenda().isEmpty()&&this.getFocused()!==k;)a.pop(),b=!0;return b&&this.emit("focused",this.getFocused()),this.getFocusedAgenda().isEmpty()},fireNext:function(){for(var a=this.agendaGroupStack,b=!1;this.getFocusedAgenda().isEmpty()&&this.getFocused()!==k;)a.pop();if(!this.getFocusedAgenda().isEmpty()){var c=this.pop();this.emit("fire",c.rule.name,c.match.factHash);var d=c.rule.fire(this.flow,c.match);b=!h(d)||d.then(function(){return!0})}return b},pop:function(){for(var a=this.getFocusedAgenda(),b=a.__root;b.right;)b=b.right;var c=b.data;a.remove(c);var d=this.rules[c.name];return d.tree.remove(c),d.factTable.remove(c),c},peek:function(){for(var a=this.getFocusedAgenda(),b=a.__root;b.right;)b=b.right;return b.data},modify:function(a,b){this.retract(a,b),this.insert(a,b)},retract:function(a,b){var c=this.rules[a.name];b.rule=a;var d=c.factTable.remove(b);d&&(this.getAgendaGroup(a.rule.agendaGroup).remove(d),c.tree.remove(d))},insert:function(a,b){var c=this.rules[a.name],d=a.rule,e=d.agendaGroup;c.tree.insert(b),this.getAgendaGroup(e).insert(b),d.autoFocus&&this.setFocus(e),c.factTable.insert(b)},dispose:function(){for(var a in this.agendaGroups)this.agendaGroups[a].clear();var b=this.rules;for(a in b)a in b&&(b[a].tree.clear(),b[a].factTable.clear());this.rules={}}}})},{"./extended":12,events:60}],4:[function(require,module,exports){"use strict";var extd=require("../extended"),forEach=extd.forEach,isString=extd.isString;exports.modifiers=["assert","modify","retract","emit","halt","focus","getFacts"];var createFunction=function(body,defined,scope,scopeNames,definedNames){var declares=[];forEach(definedNames,function(a){-1!==body.indexOf(a)&&declares.push("var "+a+"= defined."+a+";")}),forEach(scopeNames,function(a){-1!==body.indexOf(a)&&declares.push("var "+a+"= scope."+a+";")}),body=["((function(){",declares.join(""),"\n\treturn ",body,"\n})())"].join("");try{return eval(body)}catch(a){throw new Error("Invalid action : "+body+"\n"+a.message)}},createDefined=function(){var a=function(a,b,c){if(isString(a)){var d=[];extd(b).keys().forEach(function(b){-1!==a.indexOf(b)&&d.push("var "+b+"= defined."+b+";")}),extd(c).keys().forEach(function(b){-1!==a.indexOf(b)&&d.push("var "+b+"= function(){var prop = scope."+b+"; return __objToStr__.call(prop) === '[object Function]' ? prop.apply(void 0, arguments) : prop;};")}),d.length&&d.unshift("var __objToStr__ = Object.prototype.toString;"),a=[d.join(""),"return ",a,";"].join(""),a=new Function("defined","scope",a)(b,c)}var e=a.hasOwnProperty("constructor")&&"function"==typeof a.constructor?a.constructor:function(b){b=b||{};for(var c in b)c in a&&(this[c]=b[c])},f=e.prototype;for(var g in a)f[g]=a[g];return e};return function(b,c,d){return a(b.properties,c,d)}}();exports.createFunction=createFunction,exports.createDefined=createDefined},{"../extended":12}],5:[function(a,b,c){var d=a("__browserify_Buffer").Buffer,e=a("../extended"),f=a("../parser"),g=a("../constraintMatcher.js"),h=e.indexOf,i=e.forEach,j=e.removeDuplicates,k=e.map,l=e.hash,m=l.keys,n=e.merge,o=a("../rule"),p=a("./common"),q=p.modifiers,r=p.createDefined,s=p.createFunction,t=function(a,b,c,d){var f=[];i(b,function(b){-1!==a.indexOf(b)&&f.push("var "+b+"= facts."+b+";")}),e(c).keys().forEach(function(b){-1!==a.indexOf(b)&&f.push("var "+b+"= defined."+b+";")}),e(d).keys().forEach(function(b){-1!==a.indexOf(b)&&f.push("var "+b+"= scope."+b+";")}),e(q).forEach(function(b){-1!==a.indexOf(b)&&f.push("if(!"+b+"){ var "+b+"= flow."+b+";}")});var g=["facts","flow"];/next\(.*\)/.test(a)&&g.push("next"),a=f.join("")+a;try{return new Function("defined, scope","return "+new Function(g.join(","),a).toString())(c,d)}catch(b){throw new Error("Invalid action : "+a+"\n"+b.message)}},u=function(){function a(c,d,e,f,g){if(c.length){var h=c[0];if("not"===h||"exists"===h){var k=[];c.shift(),b(c,e,k,f,g);var l=k[0];l.unshift(h),d.push(l)}else if("or"===h){var m=[h];c.shift(),i(c,function(b){a(b,m,e,f,g)}),d.push(m)}else b(c,e,d,f,g),e=j(e)}}var b=function(a,b,c,d,j){var k=[],l=a[0],m=a[1],n=a[2],o=a[3];if(e.isHash(n)&&(o=n,n=null),!l||!(l=d[l]))throw new Error("Invalid class "+a[0]+" for rule "+j);if(k.push(l),k.push(m,n,o),c.push(k),b.push(m),n&&i(g.getIdentifiers(f.parseConstraint(n)),function(a){b.push(a)}),e.isObject(o))for(var p in o){var q=o[p];-1===h(b,q)&&b.push(q)}};return function(b,c,d){var f=b.name;if(e.isEmpty(b))throw new Error("Rule is empty");var g=b.options||{};g.scope=d;var h=b.constraints||[];h.length||(h=["true"]);var j=b.action;if(e.isUndefined(j))throw new Error("No action was defined for rule "+f);var k=[],l=[];return i(h,function(b){a(b,k,l,c,f)}),o.createRule(f,g,k,t(j,l,c,d))}}();c.parse=function(a,b){return f.parseRuleSet(a,b)},c.compile=function(a,b,c,f){e.isFunction(b)?(c=b,b={}):b=b||{};var g=a.name||b.name;if(!g)throw new Error("Name must be present in JSON or options");var h=new f(g),j=n({Array:Array,String:String,Number:Number,Boolean:Boolean,RegExp:RegExp,Date:Date,Object:Object},b.define||{});void 0!==d&&(j.Buffer=d);var l=n({console:console},b.scope);i(a.scope,function(a){l[a.name]=!0}),i(a.define,function(a){j[a.name]=r(a,j,l)}),e(j).forEach(function(a,b){h.addDefined(b,a)});var o=e(a.scope).pluck("name").union(e(l).keys().value()).value(),p=k(m(j),function(a){return a});i(a.scope,function(a){l[a.name]=s(a.body,j,l,o,p)});var q=a.rules;return q.length&&i(q,function(a){h.__rules=h.__rules.concat(u(a,j,l))}),c&&c.call(h,h),h},c.transpile=a("./transpile").transpile},{"../constraintMatcher.js":9,"../extended":12,"../parser":44,"../rule":49,"./common":4,"./transpile":6,__browserify_Buffer:63}],6:[function(a,b,c){function d(a){a=n(a)?new Function("return "+a+";")():a;var b,c=["(function(){"];a.hasOwnProperty("constructor")&&"function"==typeof a.constructor?c.push("var Defined = "+a.constructor.toString()+";"):c.push("var Defined = function(opts){ for(var i in opts){if(opts.hasOwnProperty(i)){this[i] = opts[i];}}};"),c.push("var proto = Defined.prototype;");for(var d in a)a.hasOwnProperty(d)&&(b=a[d],c.push("proto."+d+" = "+(j.isFunction(b)?b.toString():j.format("%j",b))+";"));return c.push("return Defined;"),c.push("}())"),c.join("")}function e(a,b,c,d){var e=[],f={};k(b,function(b){-1!==a.indexOf(b)&&(f[b]=!0,e.push("var "+b+"= facts."+b+";"))}),j(c).keys().forEach(function(b){-1===a.indexOf(b)||f[b]||(f[b]=!0,e.push("var "+b+"= defined."+b+";"))}),j(d).keys().forEach(function(b){-1===a.indexOf(b)||f[b]||(f[b]=!0,e.push("var "+b+"= scope."+b+";"))}),j(o).forEach(function(b){-1===a.indexOf(b)||f[b]||e.push("var "+b+"= flow."+b+";")});var g=["facts","flow"];/next\(.*\)/.test(a)&&g.push("next"),a=e.join("")+a;try{return["function(",g.join(","),"){",a,"}"].join("")}catch(b){throw new Error("Invalid action : "+a+"\n"+b.message)}}function f(a,b){if(a.length&&j.isString(a[0])){var c=a[0].match(" *(from)");if(c)switch(c=c[0]){case"from":b.push(', "',a.shift(),'"');break;default:throw new Error("Unrecognized modifier "+c)}}}function g(a,b,c){if(a.length&&j.isHash(a[0])){var d=a.shift();j(d).values().forEach(function(a){-1===l(c,a)&&c.push(a)}),b.push(","+j.format("%j",[d]))}}function h(a,b){a=a.slice(0);var c=[];if("or"===a[0])return c.push('["'+a.shift()+'"'),c.push(j.map(a,function(a){return h(a,b)}).join(",")+"]"),c;if("not"!==a[0]&&"exists"!==a[0]||c.push('"',a.shift(),'", '),b.push(a[1]),c.push(a[0],', "'+a[1].replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'),a.splice(0,2),a.length){var d=a.shift();j.isString(d)&&d?(c.push(',"'+d.replace(/\\/g,"\\\\").replace(/"/g,'\\"'),'"'),k(p.getIdentifiers(q.parseConstraint(d)),function(a){b.push(a)})):(c.push(',"true"'),a.unshift(d))}return f(a,c),g(a,c,b),"["+c.join("")+"]"}var i=a("__browserify_Buffer").Buffer,j=a("../extended"),k=j.forEach,l=j.indexOf,m=j.merge,n=j.isString,o=a("./common").modifiers,p=a("../constraintMatcher"),q=a("../parser");c.transpile=function(a,b){b=b||{};var c=[];c.push("(function(){"),c.push("return function(options){"),c.push("options = options || {};"),c.push("var bind = function(scope, fn){return function(){return fn.apply(scope, arguments);};}, defined = {Array: Array, String: String, Number: Number, Boolean: Boolean, RegExp: RegExp, Date: Date, Object: Object}, scope = options.scope || {};"),c.push("var optDefined = options.defined || {}; for(var i in optDefined){defined[i] = optDefined[i];}");var f=m({Array:Array,String:String,Number:Number,Boolean:Boolean,RegExp:RegExp,Date:Date,Object:Object},b.define||{});void 0!==i&&(f.Buffer=i);var g=m({console:console},b.scope);return c.push(["return b2wgin.flow('",b.name,"', function(){"].join("")),c.push(j(a.define||[]).map(function(a){var b=a.name;return a[b]={},["var",b,"= defined."+b,"= this.addDefined('"+b+"',",d(a.properties)+");"].join(" ")}).value().join("\n")),c.push(j(a.scope||[]).map(function(a){var b=a.name;return g[b]={},["var",b,"= scope."+b,"= ",a.body,";"].join(" ")}).value().join("\n")),c.push("scope.console = console;\n"),c.push(j(a.rules||[]).map(function(a){var b=[],c=["this.rule('",a.name.replace(/'/g,"\\'"),"'"],d=j.merge(a.options||{},{scope:"scope"});return c.push(",",j.format("%j",[d]).replace(/(:"scope")/,":scope")),a.constraints&&!j.isEmpty(a.constraints)&&(c.push(", ["),c.push(j(a.constraints).map(function(a){return h(a,b)}).value().join(",")),c.push("]")),c.push(",",e(a.action,b,f,g)),c.push(");"),c.join("")}).value().join("")),c.push("});"),c.push("};"),c.push("}());"),c.join("")}},{"../constraintMatcher":9,"../extended":12,"../parser":44,"./common":4,__browserify_Buffer:63}],7:[function(a,b,c){function d(a,b){return a.rule.priority-b.rule.priority}function e(a,b){return a.counter-b.counter}function f(a,b){for(var c=0,d=a.match.recency,e=b.match.recency,f=d.length-1,g=e.length-1;d[c]===e[c]&&c<f&&c<g&&c++;);var h=d[c]-e[c];return h||(h=f-g),h}function g(a,b){return a.recency-b.recency}var h=a("./extended").map,i={salience:d,bucketCounter:e,factRecency:f,activationRecency:g};c.strategies=i,c.strategy=function(a){a=h(a,function(a){return i[a]});var b=a.length;return function(c,d){var e=-1,f=0;if(c!==d&&(c.name!==d.name||c.hashCode!==d.hashCode)){for(;++e<b&&!f;)f=a[e](c,d);f=f>0?1:-1}return f}}},{"./extended":12}],8:[function(a,b,c){"use strict";var d,e=a("./extended"),f=e.deepEqual,g=e.merge,h=e.instanceOf,i=e.filter,j=e.declare,k=0,l=j({type:null,instance:{constructor:function(b){d||(d=a("./constraintMatcher")),this.id=k++,this.constraint=b,e.bindAll(this,["assert"])},assert:function(){throw new Error("not implemented")},getIndexableProperties:function(){return[]},equal:function(a){return h(a,this._static)&&this.get("alias")===a.get("alias")&&e.deepEqual(this.constraint,a.constraint)},getters:{variables:function(){return[this.get("alias")]}}}});l.extend({instance:{type:"object",constructor:function(a){this._super([a])},assert:function(a){return a instanceof this.constraint||a.constructor===this.constraint},equal:function(a){return h(a,this._static)&&this.constraint===a.constraint}}}).as(c,"ObjectConstraint");var m=l.extend({instance:{type:"equality",constructor:function(a,b){this._super([a]),b=b||{},this.pattern=b.pattern,this._matcher=d.getMatcher(a,b,!0)},assert:function(a){return this._matcher(a)}}}).as(c,"EqualityConstraint");m.extend({instance:{type:"inequality"}}).as(c,"InequalityConstraint"),m.extend({instance:{type:"comparison"}}).as(c,"ComparisonConstraint"),l.extend({instance:{type:"equality",constructor:function(){this._super([[!0]])},equal:function(a){return h(a,this._static)&&this.get("alias")===a.get("alias")},assert:function(){return!0}}}).as(c,"TrueConstraint");var n=l.extend({instance:{type:"reference",constructor:function(a,b){this.cache={},this._super([a]),b=b||{},this.values=[],this.pattern=b.pattern,this._options=b,this._matcher=d.getMatcher(a,b,!1)},assert:function(a,b){try{return this._matcher(a,b)}catch(a){throw new Error("Error with evaluating pattern "+this.pattern+" "+a.message)}},merge:function(a){var b=this;return a instanceof n&&(b=new this._static([this.constraint,a.constraint,"and"],g({},this._options,this._options)),b._alias=this._alias||a._alias,b.vars=this.vars.concat(a.vars)),b},equal:function(a){return h(a,this._static)&&e.deepEqual(this.constraint,a.constraint)},getters:{variables:function(){return this.vars},alias:function(){return this._alias}},setters:{alias:function(a){this._alias=a,this.vars=i(d.getIdentifiers(this.constraint),function(b){return b!==a})}}}}).as(c,"ReferenceConstraint");n.extend({instance:{type:"reference_equality",op:"eq",getIndexableProperties:function(){return d.getIndexableProperties(this.constraint)}}}).as(c,"ReferenceEqualityConstraint").extend({instance:{type:"reference_inequality",op:"neq"}}).as(c,"ReferenceInequalityConstraint").extend({instance:{type:"reference_gt",op:"gt"}}).as(c,"ReferenceGTConstraint").extend({instance:{type:"reference_gte",op:"gte"}}).as(c,"ReferenceGTEConstraint").extend({instance:{type:"reference_lt",op:"lt"}}).as(c,"ReferenceLTConstraint").extend({instance:{type:"reference_lte",op:"lte"}}).as(c,"ReferenceLTEConstraint"),l.extend({instance:{type:"hash",constructor:function(a){this._super([a])},equal:function(a){return e.instanceOf(a,this._static)&&this.get("alias")===a.get("alias")&&e.deepEqual(this.constraint,a.constraint)},assert:function(){return!0},getters:{variables:function(){return this.constraint}}}}).as(c,"HashConstraint"),l.extend({instance:{constructor:function(a,b){this.type="from",this.constraints=d.getSourceMatcher(a,b||{},!0),e.bindAll(this,["assert"])},equal:function(a){return h(a,this._static)&&this.get("alias")===a.get("alias")&&f(this.constraints,a.constraints)},assert:function(a,b){return this.constraints(a,b)},getters:{variables:function(){return this.constraint}}}}).as(c,"FromConstraint"),l.extend({instance:{constructor:function(a,b){this.type="custom",this.fn=a,this.options=b,e.bindAll(this,["assert"])},equal:function(a){return h(a,this._static)&&this.fn===a.constraint},assert:function(a,b){return this.fn(a,b)}}}).as(c,"CustomConstraint")},{"./constraintMatcher":9,"./extended":12}],9:[function(a,b,c){"use strict";function d(a){return e(a).map(function(a){return f(a)?f(a[0])?d(a).value():a.reverse().join("."):a}).flatten().filter(function(a){return!!a})}var e=a("./extended"),f=e.isArray,g=e.forEach,h=e.some,i=e.indexOf,j=e.isNumber,k=e.removeDuplicates,l=a("./constraint"),m={indexOf:e.indexOf,now:function(){return new Date},Date:function(a,b,c,d,e,f,g){var h=new Date;return j(a)&&h.setYear(a),j(b)&&h.setMonth(b),j(c)&&h.setDate(c),j(d)&&h.setHours(d),j(e)&&h.setMinutes(e),j(f)&&h.setSeconds(f),j(g)&&h.setMilliseconds(g),h},lengthOf:function(a,b){return a.length===b},isTrue:function(a){return!0===a},isFalse:function(a){return!1===a},isNotNull:function(a){return null!==a},dateCmp:function(a,b){return e.compare(a,b)}};g(["years","days","months","hours","minutes","seconds"],function(a){m[a+"FromNow"]=e[a+"FromNow"],m[a+"Ago"]=e[a+"Ago"]}),g(["isArray","isNumber","isHash","isObject","isDate","isBoolean","isString","isRegExp","isNull","isEmpty","isUndefined","isDefined","isUndefinedOrNull","isPromiseLike","isFunction","deepEqual"],function(a){var b=e[a];m[a]=function(){return b.apply(e,arguments)}});var n={equal:function(a,b){var c=!1;return a===b?c=!0:a[2]===b[2]&&(c=-1!==i(["string","number","boolean","regexp","identifier","null"],a[2])?a[0]===b[0]:"unary"===a[2]||"logicalNot"===a[2]?this.equal(a[0],b[0]):this.equal(a[0],b[0])&&this.equal(a[1],b[1])),c},__getProperties:function(a){var b=[];if(a){var c=a[2];if(!c)return b;"prop"!==c&&"identifier"!==c&&"string"!==c&&"number"!==c&&"boolean"!==c&&"regexp"!==c&&"unary"!==c&&"unary"!==c?(b[0]=this.__getProperties(a[0]),b[1]=this.__getProperties(a[1])):b="identifier"===c?[a[0]]:n.__getProperties(a[1]).concat(n.__getProperties(a[0]))}return b},getIndexableProperties:function(a){return"composite"===a[2]?this.getIndexableProperties(a[0]):/^(\w+(\['[^']*'])*) *([!=]==?|[<>]=?) (\w+(\['[^']*'])*)$/.test(this.parse(a))?d(this.__getProperties(a)).flatten().value():[]},getIdentifiers:function(a){var b=[],c=a[2];if("identifier"===c)return[a[0]];if("function"===c)b=b.concat(this.getIdentifiers(a[0])).concat(this.getIdentifiers(a[1]));else if("string"!==c&&"number"!==c&&"boolean"!==c&&"regexp"!==c&&"unary"!==c&&"unary"!==c)if("prop"===c){if(b=b.concat(this.getIdentifiers(a[0])),a[1])for(var d=a[1];f(d);){if("function"===d[2]){b=b.concat(this.getIdentifiers(d[1]));break}d=d[1]}}else a[0]&&(b=b.concat(this.getIdentifiers(a[0]))),a[1]&&(b=b.concat(this.getIdentifiers(a[1])));return k(b)},toConstraints:function(a,b){var c=[],d=b.alias,e=b.scope||{},f=a[2];if("and"===f)c=c.concat(this.toConstraints(a[0],b)).concat(this.toConstraints(a[1],b));else if("composite"===f||"or"===f||"lt"===f||"gt"===f||"lte"===f||"gte"===f||"like"===f||"notLike"===f||"eq"===f||"neq"===f||"seq"===f||"sneq"===f||"in"===f||"notIn"===f||"prop"===f||"propLookup"===f||"function"===f||"logicalNot"===f){var g=h(this.getIdentifiers(a),function(a){return!(a===d||a in m||a in e)});switch(f){case"eq":case"seq":c.push(new l[g?"ReferenceEqualityConstraint":"EqualityConstraint"](a,b));break;case"neq":case"sneq":c.push(new l[g?"ReferenceInequalityConstraint":"InequalityConstraint"](a,b));break;case"gt":c.push(new l[g?"ReferenceGTConstraint":"ComparisonConstraint"](a,b));break;case"gte":c.push(new l[g?"ReferenceGTEConstraint":"ComparisonConstraint"](a,b));break;case"lt":c.push(new l[g?"ReferenceLTConstraint":"ComparisonConstraint"](a,b));break;case"lte":c.push(new l[g?"ReferenceLTEConstraint":"ComparisonConstraint"](a,b));break;default:c.push(new l[g?"ReferenceConstraint":"ComparisonConstraint"](a,b))}}return c},parse:function(a){return this[a[2]](a[0],a[1])},composite:function(a){return this.parse(a)},and:function(a,b){return["(",this.parse(a),"&&",this.parse(b),")"].join(" ")},or:function(a,b){return["(",this.parse(a),"||",this.parse(b),")"].join(" ")},prop:function(a,b){return"function"===b[2]?[this.parse(a),this.parse(b)].join("."):[this.parse(a),"['",this.parse(b),"']"].join("")},propLookup:function(a,b){return"function"===b[2]?[this.parse(a),this.parse(b)].join("."):[this.parse(a),"[",this.parse(b),"]"].join("")},unary:function(a){return-1*this.parse(a)},plus:function(a,b){return[this.parse(a),"+",this.parse(b)].join(" ")},minus:function(a,b){return[this.parse(a),"-",this.parse(b)].join(" ")},mult:function(a,b){return[this.parse(a),"*",this.parse(b)].join(" ")},div:function(a,b){return[this.parse(a),"/",this.parse(b)].join(" ")},mod:function(a,b){return[this.parse(a),"%",this.parse(b)].join(" ")},lt:function(a,b){return[this.parse(a),"<",this.parse(b)].join(" ")},gt:function(a,b){return[this.parse(a),">",this.parse(b)].join(" ")},lte:function(a,b){return[this.parse(a),"<=",this.parse(b)].join(" ")},gte:function(a,b){return[this.parse(a),">=",this.parse(b)].join(" ")},like:function(a,b){return[this.parse(b),".test(",this.parse(a),")"].join("")},notLike:function(a,b){return["!",this.parse(b),".test(",this.parse(a),")"].join("")},eq:function(a,b){return[this.parse(a),"==",this.parse(b)].join(" ")},seq:function(a,b){return[this.parse(a),"===",this.parse(b)].join(" ")},neq:function(a,b){return[this.parse(a),"!=",this.parse(b)].join(" ")},sneq:function(a,b){return[this.parse(a),"!==",this.parse(b)].join(" ")},in:function(a,b){return["(indexOf(",this.parse(b),",",this.parse(a),")) != -1"].join("")},notIn:function(a,b){return["(indexOf(",this.parse(b),",",this.parse(a),")) == -1"].join("")},arguments:function(a,b){var c=[];return a&&c.push(this.parse(a)),b&&c.push(this.parse(b)),c.join(",")},array:function(a){var b=[];return a?(b=this.parse(a),f(b)?b:["[",b,"]"].join("")):["[",b.join(","),"]"].join("")},function:function(a,b){var c=this.parse(b);return[this.parse(a),"(",c,")"].join("")},string:function(a){return"'"+a+"'"},number:function(a){return a},boolean:function(a){return a},regexp:function(a){return a},identifier:function(a){return a},null:function(){return"null"},logicalNot:function(a){return["!(",this.parse(a),")"].join("")}},o=0,p=c.toJs=function(a,b,c,d,f){var g=n.parse(a);b=b||{};var h=n.getIdentifiers(a),i=["var indexOf = definedFuncs.indexOf; var hasOwnProperty = Object.prototype.hasOwnProperty;"],j=[];e(h).filter(function(a){var c=["var ",a," = "];if(m.hasOwnProperty(a))c.push("definedFuncs['",a,"']");else{if(!b.hasOwnProperty(a))return!0;c.push("scope['",a,"']")}return c.push(";"),i.push(c.join("")),!1}).forEach(function(a){var b=["var ",a," = "];d||a!==c?b.push("fact."+a):a===c&&b.push("hash.",a,""),b.push(";"),j.push(b.join(""))});var k=i.join("")+"return function matcher"+o+++(d?"(fact){":"(fact, hash){")+j.join("")+" return "+(f?f(g):g)+";}";return new Function("definedFuncs, scope",k)(m,b)};c.getMatcher=function(a,b,c){return b=b||{},p(a,b.scope,b.alias,c,function(a){return"!!("+a+")"})},c.getSourceMatcher=function(a,b,c){return b=b||{},p(a,b.scope,b.alias,c,function(a){return a})},c.toConstraints=function(a,b){return"function"==typeof a?[new l.CustomConstraint(a,b)]:n.toConstraints(a,b)},c.equal=function(a,b){return n.equal(a,b)},c.getIdentifiers=function(a){return n.getIdentifiers(a)},c.getIndexableProperties=function(a){return n.getIndexableProperties(a)}},{"./constraint":8,"./extended":12}],10:[function(a,b,c){"use strict";function d(a,b){for(var c="",d=-1,e=a.length;++d<e;)c+=a[d].id+":";return c+=b}function e(a,b,c){for(var d,e=-1,f=c.length;++e<f;)d=c[e],a[d]=b[d]}function f(a,b,c){k.apply(a,b);for(var d,e=-1,f=c.length,g=a.length;++e<f;)d=c[e],-1===j(a,d)&&(a[g++]=d)}var g=a("./extended"),h=g.isBoolean,i=g.declare,j=g.indexOf,k=Array.prototype.push,l=i({instance:{isMatch:!0,hashCode:"",facts:null,factIds:null,factHash:null,recency:null,aliases:null,constructor:function(){this.facts=[],this.factIds=[],this.factHash={},this.recency=[],this.aliases=[]},addFact:function(a){return k.call(this.facts,a),k.call(this.recency,a.recency),k.call(this.factIds,a.id),this.hashCode=this.factIds.join(":"),this},merge:function(a){var b=new l;return b.isMatch=a.isMatch,k.apply(b.facts,this.facts),k.apply(b.facts,a.facts),k.apply(b.aliases,this.aliases),k.apply(b.aliases,a.aliases),b.hashCode=this.hashCode+":"+a.hashCode,e(b.factHash,this.factHash,this.aliases),e(b.factHash,a.factHash,a.aliases),f(b.recency,this.recency,a.recency),b}}}),m=i({instance:{match:null,factHash:null,aliases:null,fact:null,hashCode:null,paths:null,pathsHash:null,constructor:function(a,b,c){this.fact=a,this.match=c||(new l).addFact(a),this.factHash=this.match.factHash,this.aliases=this.match.aliases,this.hashCode=this.match.hashCode,b?(this.paths=b,this.pathsHash=d(b,this.hashCode)):this.pathsHash=this.hashCode},set:function(a,b){return this.factHash[a]=b,this.aliases.push(a),this},isMatch:function(a){return h(a)?(this.match.isMatch=a,this):this.match.isMatch},mergeMatch:function(a){var b=this.match=this.match.merge(a);return this.factHash=b.factHash,this.hashCode=b.hashCode,this.aliases=b.aliases,this},clone:function(a,b,c){return new m(a||this.fact,b||this.path,c||this.match)}}}).as(b)},{"./extended":12}],11:[function(a,b,c){var d=a("./extended"),e=d.Promise,f=a("./nextTick"),g=d.isPromiseLike;e.extend({instance:{looping:!1,constructor:function(a,b){this._super([]),this.flow=a,this.agenda=a.agenda,this.rootNode=a.rootNode,this.matchUntilHalt=!!b,d.bindAll(this,["onAlter","callNext"])},halt:function(){this.__halted=!0,this.looping||this.callback()},onAlter:function(){this.flowAltered=!0,this.looping||!this.matchUntilHalt||this.__halted||this.callNext()},setup:function(){var a=this.flow;this.rootNode.resetCounter(),a.on("assert",this.onAlter),a.on("modify",this.onAlter),a.on("retract",this.onAlter)},tearDown:function(){var a=this.flow;a.removeListener("assert",this.onAlter),a.removeListener("modify",this.onAlter),a.removeListener("retract",this.onAlter)},__handleAsyncNext:function(a){var b=this,c=b.agenda;return a.then(function(){b.looping=!1,c.isEmpty()?b.matchUntilHalt&&!b.__halted||b.callback():(b.flowAltered&&(b.rootNode.incrementCounter(),b.flowAltered=!1),b.__halted?b.callback():b.callNext()),b=null},this.errback)},__handleSyncNext:function(a){return this.looping=!1,this.agenda.isEmpty()||this.flowAltered&&(this.rootNode.incrementCounter(),this.flowAltered=!1),a&&!this.__halted?f(this.callNext):this.matchUntilHalt&&!this.__halted||this.callback(),a},callback:function(){this.tearDown(),this._super(arguments)},callNext:function(){this.looping=!0;var a=this.agenda.fireNext();return g(a)?this.__handleAsyncNext(a):this.__handleSyncNext(a)},execute:function(){return this.setup(),this.callNext(),this}}}).as(b)},{"./extended":12,"./nextTick":17}],12:[function(a,b,c){function d(a){var b=a.match(/(\w+)\(\)$/);return b?(a=b[1],function(b){return b[a]()}):function(b){return b[a]}}function e(a){if(a=a.split("."),1===a.length)return d(a[0]);var b=o(a,function(a){return d(a)}),c=b.length;return function(a){for(var d=-1,e=a;++d<c;)e=b[d](e);return e}}function f(a,b){a=p.call(a);var c,d,e=-1;for(d=a.length;++e<d;)c=a[e],-1===n(b,c)&&(q.call(a,e--,1),d--);return a}function g(a,b){var c,d,e=-1;for(d=a.length;++e<d;)c=a[e],-1===n(b,c)&&(q.call(a,e--,1),d--);return a}function h(a,b){var c,d,e=-1;for(d=a.length;++e<d;)c=a[e],-1!==n(b,c)&&(q.call(a,e--,1),d--);return a}function i(a,b){var c,d,e,f=[],g=-1,h=b.length,i=a.length;if(h>i){for(f=a.slice();++g<h;)for(d=b[g],c=-1,i=f.length;++c<i;)if(f[c]===d){f.splice(c,1);break}}else for(;++g<i;){for(d=a[g],c=-1,e=!1;++c<h;)if(b[c]===d){e=!0;break}e||f.push(d)}return f}function j(a,b){var c={};for(var d in a)hasOwnProperty.call(b,d)||(c[d]=a[d]);return c}function k(a,b){return m(a.concat(b))}var l=a("array-extended"),m=l.unique,n=l.indexOf,o=l.map,p=Array.prototype.slice,q=Array.prototype.splice;b.exports=a("extended")().register(a("date-extended")).register(l).register(a("object-extended")).register(a("string-extended")).register(a("promise-extended")).register(a("function-extended")).register(a("is-extended")).register("intersection",f).register("inPlaceIntersection",g).register("inPlaceDifference",h).register("diffArr",i).register("diffHash",j).register("unionArr",k).register("plucker",e).register("HashTable",a("ht")).register("declare",a("declare.js")).register(a("leafy")).register("LinkedList",a("./linkedList"))},{"./linkedList":16,"array-extended":52,"date-extended":53,"declare.js":55,extended:56,"function-extended":59,ht:65,"is-extended":66,leafy:67,"object-extended":68,"promise-extended":69,"string-extended":70}],13:[function(a,b,c){"use strict";var d=a("./extended"),e=d.bind,f=d.declare,g=a("./nodes"),h=a("events").EventEmitter,i=a("./workingMemory"),j=i.WorkingMemory,k=a("./executionStrategy"),l=a("./agenda");b.exports=f(h,{instance:{name:null,executionStrategy:null,constructor:function(a,b){this.env=null,this.name=a,this.__rules={},this.conflictResolutionStrategy=b,this.workingMemory=new j,this.agenda=new l(this,b),this.agenda.on("fire",e(this,"emit","fire")),this.agenda.on("focused",e(this,"emit","focused")),this.rootNode=new g.RootNode(this.workingMemory,this.agenda),d.bindAll(this,"halt","assert","retract","modify","focus","emit","getFacts","getFact")},getFacts:function(a){return a?this.workingMemory.getFactsByType(a):this.workingMemory.getFacts()},getFact:function(a){var b;return(b=a?this.workingMemory.getFactsByType(a):this.workingMemory.getFacts())&&b[0]},focus:function(a){return this.agenda.setFocus(a),this},halt:function(){return this.executionStrategy.halt(),this},dispose:function(){this.workingMemory.dispose(),this.agenda.dispose(),this.rootNode.dispose()},assert:function(a){return this.rootNode.assertFact(this.workingMemory.assertFact(a)),this.emit("assert",a),a},retract:function(a){return this.rootNode.retractFact(this.workingMemory.retractFact(a)),this.emit("retract",a),a},modify:function(a,b){return"function"==typeof b&&b.call(a,a),this.rootNode.modifyFact(this.workingMemory.modifyFact(a)),this.emit("modify",a),a},print:function(){this.rootNode.print()},containsRule:function(a){return this.rootNode.containsRule(a)},rule:function(a){this.rootNode.assertRule(a)},matchUntilHalt:function(a){return(this.executionStrategy=new k(this,!0)).execute().classic(a).promise()},match:function(a){return(this.executionStrategy=new k(this)).execute().classic(a).promise()}}})},{"./agenda":3,"./executionStrategy":11,"./extended":12,"./nodes":27,"./workingMemory":50,events:60}],14:[function(a,b,c){"use strict";var d=a("./extended"),e=d.instanceOf,f=d.forEach,g=d.declare,h=a("./pattern").InitialFact,i=a("./conflict"),j=i.strategy(["salience","activationRecency"]),k=a("./rule"),l=a("./flow"),m={},n=g({instance:{constructor:function(a,b){if(this.name=a,this.cb=b,this.__rules=[],this.__defined={},this.conflictResolutionStrategy=j,b&&b.call(this,this),m.hasOwnProperty(a))throw new Error("Flow with "+a+" already defined");m[a]=this},conflictResolution:function(a){return this.conflictResolutionStrategy=i.strategy(a),this},getDefined:function(a){var b=this.__defined[a.toLowerCase()];if(!b)throw new Error(a+" flow class is not defined");return b},addDefined:function(a,b){return this.__defined[a.toLowerCase()]=b,b},rule:function(){return this.__rules=this.__rules.concat(k.createRule.apply(k,arguments)),this},getSession:function(){var a=new l(this.name,this.conflictResolutionStrategy);f(this.__rules,function(b){a.rule(b)}),a.assert(new h);for(var b=0,c=arguments.length;b<c;b++)a.assert(arguments[b]);return a},containsRule:function(a){return d.some(this.__rules,function(b){return b.name===a})}},static:{getFlow:function(a){return m[a]},hasFlow:function(a){return d.has(m,a)},deleteFlow:function(a){return e(a,n)&&(a=a.name),delete m[a],n},deleteFlows:function(){for(var a in m)a in m&&delete m[a];return n},create:function(a,b){return new n(a,b)}}}).as(b)},{"./conflict":7,"./extended":12,"./flow":13,"./pattern":48,"./rule":49}],15:[function(a,b,c){"use strict";function d(a){return/\.b2wgin$/.test(a)}function e(a){return d(a)?i.parse(g.readFileSync(a,"utf8"),a):i.parse(a)}var f=a("./extended"),g=a("fs"),h=a("path"),i=a("./compile"),j=a("./flowContainer");c.Flow=j,c.getFlow=j.getFlow,c.hasFlow=j.hasFlow,c.deleteFlow=function(a){return j.deleteFlow(a),this},c.deleteFlows=function(){return j.deleteFlows(),this},c.flow=j.create,c.compile=function(a,b,c){if(f.isFunction(b)?(c=b,b={}):b=b||{},f.isString(a)&&(b.name=b.name||(d(a)?h.basename(a,h.extname(a)):null),a=e(a)),!b.name)throw new Error("Name required when compiling b2wgin source");return i.compile(a,b,c,j)},c.transpile=function(a,b){return b=b||{},f.isString(a)&&(b.name=b.name||(d(a)?h.basename(a,h.extname(a)):null),a=e(a)),i.transpile(a,b)},c.parse=e},{"./compile":5,"./extended":12,"./flowContainer":14,fs:61,path:62}],16:[function(a,b,c){a("declare.js")({instance:{constructor:function(){this.head=null,this.tail=null,this.length=null},push:function(a){var b=this.tail,c=this.head,d={data:a,prev:b,next:null};return b&&(this.tail.next=d),this.tail=d,c||(this.head=d),this.length++,d},remove:function(a){a.prev?a.prev.next=a.next:this.head=a.next,a.next?a.next.prev=a.prev:this.tail=a.prev,this.length--},forEach:function(a){for(var b={next:this.head};b=b.next;)a(b.data)},toArray:function(){for(var a={next:this.head},b=[];a=a.next;)b.push(a);return b},removeByData:function(a){for(var b={next:this.head};b=b.next;)if(b.data===a){this.remove(b);break}},getByData:function(a){for(var b={next:this.head};b=b.next;)if(b.data===a)return b},clear:function(){this.head=this.tail=null,this.length=0}}}).as(b)},{"declare.js":55}],17:[function(a,b,c){var d,e=a("__browserify_process"),f=a("./extended");if("function"==typeof setImmediate)d="undefined"!=typeof window?f.bind(window,setImmediate):setImmediate;else if(void 0!==e)d=e.nextTick;else if("undefined"!=typeof MessageChannel){var g=new MessageChannel,h={},i=h;g.port1.onmessage=function(){h=h.next;var a=h.task;delete h.task,a()},d=function(a){i=i.next={task:a},g.port2.postMessage(0)}}else d=function(a){setTimeout(a,0)};b.exports=d},{"./extended":12,__browserify_process:64}],18:[function(a,b,c){var d=a("./node"),e=a("../extended").intersection;d.extend({instance:{__propagatePaths:function(a,b){for(var c,d,f,g,h=this.__entrySet,i=h.length;--i>-1;)c=h[i],d=c.key,f=c.value,(g=e(f,b.paths)).length&&d[a](b.clone(null,g,null))},__propagateNoPaths:function(a,b){for(var c=this.__entrySet,d=c.length;--d>-1;)c[d].key[a](b)},__propagate:function(a,b){b.paths?this.__propagatePaths(a,b):this.__propagateNoPaths(a,b)}}}).as(b)},{"../extended":12,"./node":37}],19:[function(a,b,c){a("./alphaNode").extend({instance:{constructor:function(){this._super(arguments),this.alias=this.constraint.get("alias")},toString:function(){return"AliasNode"+this.__count},assert:function(a){return this.__propagate("assert",a.set(this.alias,a.fact.object))},modify:function(a){return this.__propagate("modify",a.set(this.alias,a.fact.object))},retract:function(a){return this.__propagate("retract",a.set(this.alias,a.fact.object))},equal:function(a){return a instanceof this._static&&this.alias===a.alias}}}).as(b)},{"./alphaNode":20}],20:[function(a,b,c){"use strict";a("./node").extend({instance:{constructor:function(a){this._super([]),this.constraint=a,this.constraintAssert=this.constraint.assert},toString:function(){return"AlphaNode "+this.__count},equal:function(a){return this.constraint.equal(a.constraint)}}}).as(b)},{"./node":37}],21:[function(a,b,c){var d=a("../extended"),e=d.hash.keys,f=a("./node"),g=a("./misc/leftMemory"),h=a("./misc/rightMemory");f.extend({instance:{nodeType:"BetaNode",constructor:function(){this._super([]),this.leftMemory={},this.rightMemory={},this.leftTuples=new g,this.rightTuples=new h},__propagate:function(a,b){for(var c,d,e=this.__entrySet,f=e.length;--f>-1;)c=e[f],d=c.key,d[a](b)},dispose:function(){this.leftMemory={},this.rightMemory={},this.leftTuples.clear(),this.rightTuples.clear()},disposeLeft:function(a){this.leftMemory={},this.leftTuples.clear(),this.propagateDispose(a)},disposeRight:function(a){this.rightMemory={},this.rightTuples.clear(),this.propagateDispose(a)},hashCode:function(){return this.nodeType+" "+this.__count},toString:function(){return this.nodeType+" "+this.__count},retractLeft:function(a){a=this.removeFromLeftMemory(a).data;for(var b=a.rightMatches,c=e(b),d=-1,f=c.length;++d<f;)this.__propagate("retract",b[c[d]].clone())},retractRight:function(a){a=this.removeFromRightMemory(a).data;for(var b=a.leftMatches,c=e(b),d=-1,f=c.length;++d<f;)this.__propagate("retract",b[c[d]].clone())},assertLeft:function(a){this.__addToLeftMemory(a);for(var b=this.rightTuples.getRightMemory(a),c=-1,d=b.length;++c<d;)this.propagateFromLeft(a,b[c].data)},assertRight:function(a){this.__addToRightMemory(a);for(var b=this.leftTuples.getLeftMemory(a),c=-1,d=b.length;++c<d;)this.propagateFromRight(a,b[c].data)},modifyLeft:function(a){var b=this.removeFromLeftMemory(a).data;this.__addToLeftMemory(a);var c,d=this.rightTuples.getRightMemory(a),e=d.length,f=-1;if(e)for(c=b.rightMatches;++f<e;)this.propagateAssertModifyFromLeft(a,c,d[f].data);else this.propagateRetractModifyFromLeft(b)},modifyRight:function(a){var b=this.removeFromRightMemory(a).data;this.__addToRightMemory(a);var c=this.leftTuples.getLeftMemory(a);if(c.length)for(var d=b.leftMatches,e=-1,f=c.length;++e<f;)this.propagateAssertModifyFromRight(a,d,c[e].data);else this.propagateRetractModifyFromRight(b)},propagateFromLeft:function(a,b){this.__propagate("assert",this.__addToMemoryMatches(b,a,a.clone(null,null,a.match.merge(b.match))))},propagateFromRight:function(a,b){this.__propagate("assert",this.__addToMemoryMatches(a,b,b.clone(null,null,b.match.merge(a.match))))},propagateRetractModifyFromLeft:function(a){for(var b=a.rightMatches,c=e(b),d=c.length,f=-1;++f<d;)this.__propagate("retract",b[c[f]].clone())},propagateRetractModifyFromRight:function(a){for(var b=a.leftMatches,c=e(b),d=c.length,f=-1;++f<d;)this.__propagate("retract",b[c[f]].clone())},propagateAssertModifyFromLeft:function(a,b,c){c.hashCode in b?this.__propagate("modify",this.__addToMemoryMatches(c,a,a.clone(null,null,a.match.merge(c.match)))):this.propagateFromLeft(a,c)},propagateAssertModifyFromRight:function(a,b,c){c.hashCode in b?this.__propagate("modify",this.__addToMemoryMatches(a,c,a.clone(null,null,c.match.merge(a.match)))):this.propagateFromRight(a,c)},removeFromRightMemory:function(a){var b,c=a.hashCode;a=this.rightMemory[c]||null;var d=this.rightTuples;if(a){var f=this.leftMemory;b=a.data;var g=b.leftMatches;d.remove(a);for(var h=e(g),i=-1,j=h.length;++i<j;)delete f[h[i]].data.rightMatches[c];delete this.rightMemory[c]}return a},removeFromLeftMemory:function(a){var b=a.hashCode;if(a=this.leftMemory[b]||null){var c=this.rightMemory,d=a.data.rightMatches;this.leftTuples.remove(a);for(var f=e(d),g=-1,h=f.length;++g<h;)delete c[f[g]].data.leftMatches[b];delete this.leftMemory[b]}return a},getRightMemoryMatches:function(a){var b=this.leftMemory[a.hashCode],c={};return b&&(c=b.rightMatches),c},__addToMemoryMatches:function(a,b,c){var d,e=a.hashCode,f=this.rightMemory[e],g=b.hashCode;if(f){if(f=f.data,g in f.leftMatches)throw new Error("Duplicate left fact entry");f.leftMatches[g]=c}if(d=this.leftMemory[g]){if(d=d.data,e in d.rightMatches)throw new Error("Duplicate right fact entry");d.rightMatches[e]=c}return c},__addToRightMemory:function(a){var b=a.hashCode,c=this.rightMemory;return!(b in c)&&(c[b]=this.rightTuples.push(a),a.leftMatches={},!0)},__addToLeftMemory:function(a){var b=a.hashCode,c=this.leftMemory;return!(b in c)&&(c[b]=this.leftTuples.push(a),a.rightMatches={},!0)}}}).as(b)},{"../extended":12,"./misc/leftMemory":32,"./misc/rightMemory":34,"./node":37}],22:[function(a,b,c){a("./alphaNode").extend({instance:{constructor:function(){this.memory={},this._super(arguments),this.constraintAssert=this.constraint.assert},assert:function(a){(this.memory[a.pathsHash]=this.constraintAssert(a.factHash))&&this.__propagate("assert",a)},modify:function(a){var b=this.memory,c=a.pathsHash,d=b[c];(b[c]=this.constraintAssert(a.factHash))?this.__propagate(d?"modify":"assert",a):d&&this.__propagate("retract",a)},retract:function(a){var b=a.pathsHash,c=this.memory;c[b]&&this.__propagate("retract",a),delete c[b]},toString:function(){return"EqualityNode"+this.__count}}}).as(b)},{"./alphaNode":20}],23:[function(a,b,c){var d=a("./fromNotNode"),e=a("../extended"),f=a("../context"),g=e.isDefined,h=e.isArray;d.extend({instance:{nodeType:"ExistsFromNode",retractLeft:function(a){var b=this.removeFromLeftMemory(a);b&&(b=b.data,b.blocked&&this.__propagate("retract",b.clone()))},__modify:function(a,b){var c=b.blocked,d=a.factHash,e=this.from(d);if(h(e)){for(var f=0,i=e.length;f<i;f++)if(this.__isMatch(a,e[f],!0)){a.blocked=!0;break}}else g(e)&&(a.blocked=this.__isMatch(a,e,!0));a.blocked?c?this.__propagate("modify",a.clone()):this.__propagate("assert",a.clone()):c&&this.__propagate("retract",a.clone())},__findMatches:function(a){var b=a.factHash,c=this.from(b),d=!1;if(h(c)){for(var e=0,f=c.length;e<f;e++)if(this.__isMatch(a,c[e],!0))return a.blocked=!0,void this.__propagate("assert",a.clone())}else g(c)&&this.__isMatch(a,c,!0)&&(a.blocked=!0,this.__propagate("assert",a.clone()));return d},__isMatch:function(a,b,c){var d=!1;if(this.type(b)){var e=this.workingMemory.getFactHandle(b),g=new f(e,null,null).mergeMatch(a.match).set(this.alias,b);if(c){var h=this.fromMemory[e.id];h||(h=this.fromMemory[e.id]={}),h[a.hashCode]=a}for(var i=g.factHash,j=this.__equalityConstraints,k=0,l=j.length;k<l;k++){if(!j[k](i)){d=!1;break}d=!0}}return d},assertLeft:function(a){this.__addToLeftMemory(a),this.__findMatches(a)}}}).as(b)},{"../context":10,"../extended":12,"./fromNotNode":26}],24:[function(a,b,c){var d=a("./notNode"),e=a("../linkedList");d.extend({instance:{nodeType:"ExistsNode",blockedContext:function(a,b){a.blocker=b,this.removeFromLeftMemory(a),this.addToLeftBlockedMemory(b.blocking.push(a)),this.__propagate("assert",this.__cloneContext(a))},notBlockedContext:function(a,b){this.__addToLeftMemory(a),b&&this.__propagate("retract",this.__cloneContext(a))},propagateFromLeft:function(a){this.notBlockedContext(a,!1)},retractLeft:function(a){var b;if(!this.removeFromLeftMemory(a)){if(!(b=this.removeFromLeftBlockedMemory(a)))throw new Error;this.__propagate("retract",this.__cloneContext(b.data))}},modifyLeft:function(a){var b,c,d,e,f=this.removeFromLeftMemory(a),g=this.constraint,h=this.rightTuples,i=h.length,j=!1;if(f||(f=this.removeFromLeftBlockedMemory(a),j=!0),!f)throw new Error;if(b=f.data,b&&b.blocker&&(e=this.rightMemory[b.blocker.hashCode]),e?(g.isMatch(a,d=e.data)&&(this.__propagate(j?"modify":"assert",this.__cloneContext(b)),a.blocker=d,this.addToLeftBlockedMemory(d.blocking.push(a)),a=null),a&&(c={next:e.next})):c={next:h.head},a&&i)for(c={next:h.head};c=c.next;)if(g.isMatch(a,d=c.data)){this.__propagate(j?"modify":"assert",this.__cloneContext(b)),this.addToLeftBlockedMemory(d.blocking.push(a)),a.blocker=d,a=null;break}a&&(this.__addToLeftMemory(a),j&&this.__propagate("retract",this.__cloneContext(a)))},modifyRight:function(a){var b=this.removeFromRightMemory(a);if(!b)throw new Error;var c,d,f=b.data,g=this.leftTuples,h=g.length,i=this.constraint,j=f.blocking;if(this.__addToRightMemory(a),a.blocking=new e,h||j.length){if(j.length)for(var k,l={next:j.head};l=l.next;)if(c=l.data,c.blocker=null,i.isMatch(c,a))c.blocker=a,this.addToLeftBlockedMemory(a.blocking.push(c)),this.__propagate("assert",this.__cloneContext(c)),c=null;else{for(c.blocker=null,d=b;d=d.next;)if(i.isMatch(c,k=d.data)){c.blocker=k,this.addToLeftBlockedMemory(k.blocking.push(c)),this.__propagate("assert",this.__cloneContext(c)),c=null;break}c&&this.__addToLeftMemory(c)}if(h)for(d={next:g.head};d=d.next;)c=d.data,i.isMatch(c,a)&&(this.__propagate("assert",this.__cloneContext(c)),this.removeFromLeftMemory(c),this.addToLeftBlockedMemory(a.blocking.push(c)),c.blocker=a)}}}}).as(b)},{"../linkedList":16,"./notNode":38}],25:[function(a,b,c){var d=a("./joinNode"),e=a("../extended"),f=a("../constraint"),g=f.EqualityConstraint,h=f.HashConstraint,i=f.ReferenceConstraint,j=a("../context"),k=e.isDefined,l=e.isEmpty,m=e.forEach,n=e.isArray,o={isMatch:function(){return!1}};d.extend({instance:{nodeType:"FromNode",constructor:function(a,b){this._super(arguments),this.workingMemory=b,this.fromMemory={},this.pattern=a,this.type=a.get("constraints")[0].assert,this.alias=a.get("alias"),this.from=a.from.assert;var c=this.__equalityConstraints=[],d=[];m(this.constraints=this.pattern.get("constraints").slice(1),function(a){a instanceof g||a instanceof i?c.push(a.assert):a instanceof h&&(d=d.concat(a.get("variables")))}),this.__variables=d},__createMatches:function(a){var b=a.factHash,c=this.from(b);if(n(c))for(var d=0,e=c.length;d<e;d++)this.__checkMatch(a,c[d],!0);else k(c)&&this.__checkMatch(a,c,!0)},__checkMatch:function(a,b,c){var d;return(d=this.__createMatch(a,b)).isMatch()&&c&&this.__propagate("assert",d.clone()),d},__createMatch:function(a,b){if(this.type(b)){var c,d=this.workingMemory.getFactHandle(b,!0),e=new j(d,null,null).set(this.alias,b),f=d.id,g=e.factHash,h=a.factHash;for(var i in h)g[i]=h[i];for(var k=this.__equalityConstraints,l=this.__variables,m=-1,n=k.length;++m<n;)if(!k[m](g,g)){c=o;break}var p=this.fromMemory[f];if(p||(p=this.fromMemory[f]={}),!c){var q;for(m=-1,n=l.length;++m<n;)q=l[m],g[q]=b[q];a.fromMatches[d.id]=c=e.clone(d,null,a.match.merge(e.match))}return p[a.hashCode]=[a,c],c}return o},retractRight:function(){throw new Error("Shouldnt have gotten here")},removeFromFromMemory:function(a){var b=a.fact.id,c=this.fromMemory[b];if(c){var d;for(var e in c)if(d=c[e],d[1]===a){delete c[e],l(c)&&delete this.fromMemory[b];break}}},retractLeft:function(a){var b=this.removeFromLeftMemory(a);if(b){b=b.data;var c=b.fromMatches;for(var d in c)this.removeFromFromMemory(c[d]),this.__propagate("retract",c[d].clone())}},modifyLeft:function(a){var b,c,d,e,f,g=this.removeFromLeftMemory(a);if(g){this.__addToLeftMemory(a);var h=g.data,i=a.fromMatches={},j=h.fromMatches,l=this.from(a.factHash);if(n(l))for(c=0,d=l.length;c<d;c++)b=this.__checkMatch(a,l[c],!1),b.isMatch()&&(e=b.fact.id,e in j?this.__propagate("modify",b.clone()):this.__propagate("assert",b.clone()));else k(l)&&(b=this.__checkMatch(a,l,!1),b.isMatch()&&(e=b.fact.id,e in j?this.__propagate("modify",b.clone()):this.__propagate("assert",b.clone())));for(c in j)c in i||(this.removeFromFromMemory(j[c]),this.__propagate("retract",j[c].clone()))}else this.assertLeft(a);f=a.fact,e=f.id;var m=this.fromMemory[e];if(this.fromMemory[e]={},m){var o,p,q,r,s=f.object;for(c in m)p=m[c],o=p[0],q=p[1],r=q.isMatch(),o.hashCode!==a.hashCode&&(b=this.__createMatch(o,s,!1),r&&this.__propagate("retract",q.clone()),b.isMatch()&&this.__propagate(r?"modify":"assert",b.clone()))}},assertLeft:function(a){this.__addToLeftMemory(a),a.fromMatches={},this.__createMatches(a)},assertRight:function(){throw new Error("Shouldnt have gotten here")}}}).as(b)},{"../constraint":8,"../context":10,"../extended":12,"./joinNode":28}],26:[function(a,b,c){var d=a("./joinNode"),e=a("../extended"),f=a("../constraint"),g=f.EqualityConstraint,h=f.HashConstraint,i=f.ReferenceConstraint,j=a("../context"),k=e.isDefined,l=e.forEach,m=e.isArray;d.extend({instance:{nodeType:"FromNotNode",constructor:function(a,b){this._super(arguments),this.workingMemory=b,this.pattern=a,this.type=a.get("constraints")[0].assert,this.alias=a.get("alias"),this.from=a.from.assert,this.fromMemory={};var c=this.__equalityConstraints=[],d=[];l(this.constraints=this.pattern.get("constraints").slice(1),function(a){a instanceof g||a instanceof i?c.push(a.assert):a instanceof h&&(d=d.concat(a.get("variables")))}),this.__variables=d},retractLeft:function(a){var b=this.removeFromLeftMemory(a);b&&(b=b.data,b.blocked||this.__propagate("retract",b.clone()))},__modify:function(a,b){var c=b.blocked,d=a.factHash,e=this.from(d);if(m(e)){for(var f=0,g=e.length;f<g;f++)if(this.__isMatch(a,e[f],!0)){a.blocked=!0;break}}else k(e)&&(a.blocked=this.__isMatch(a,e,!0));a.blocked?c||this.__propagate("retract",b.clone()):c?this.__propagate("assert",a.clone()):this.__propagate("modify",a.clone())},modifyLeft:function(a){var b=this.removeFromLeftMemory(a);if(!b)throw new Error;this.__addToLeftMemory(a),this.__modify(a,b.data);var c=this.fromMemory[a.fact.id];if(this.fromMemory[a.fact.id]={},c)for(var d in c)if(d!==a.hashCode){var e=c[d];b=this.removeFromLeftMemory(e),b&&(e=e.clone(),e.blocked=!1,this.__addToLeftMemory(e),this.__modify(e,b.data))}},__findMatches:function(a){var b=a.factHash,c=this.from(b),d=!1;if(m(c)){for(var e=0,f=c.length;e<f;e++)if(this.__isMatch(a,c[e],!0))return void(a.blocked=!0);this.__propagate("assert",a.clone())}else k(c)&&!(a.blocked=this.__isMatch(a,c,!0))&&this.__propagate("assert",a.clone());return d},__isMatch:function(a,b,c){var d=!1;if(this.type(b)){var e=this.workingMemory.getFactHandle(b),f=new j(e,null).mergeMatch(a.match).set(this.alias,b);if(c){var g=this.fromMemory[e.id];g||(g=this.fromMemory[e.id]={}),g[a.hashCode]=a}for(var h=f.factHash,i=this.__equalityConstraints,k=0,l=i.length;k<l;k++){if(!i[k](h,h)){d=!1;break}d=!0}}return d},assertLeft:function(a){this.__addToLeftMemory(a),this.__findMatches(a)},assertRight:function(){throw new Error("Shouldnt have gotten here")},retractRight:function(){throw new Error("Shouldnt have gotten here")}}}).as(b)},{"../constraint":8,"../context":10,"../extended":12,"./joinNode":28}],27:[function(a,b,c){"use strict";function d(a){return g(a.constraints||[],function(a){return a instanceof t})}var e=a("../extended"),f=e.forEach,g=e.some,h=e.declare,i=a("../pattern.js"),j=i.ObjectPattern,k=i.FromPattern,l=i.FromNotPattern,m=i.ExistsPattern,n=i.FromExistsPattern,o=i.NotPattern,p=i.CompositePattern,q=i.InitialFactPattern,r=a("../constraint"),s=r.HashConstraint,t=r.ReferenceConstraint,u=a("./aliasNode"),v=a("./equalityNode"),w=a("./joinNode"),x=a("./betaNode"),y=a("./notNode"),z=a("./fromNode"),A=a("./fromNotNode"),B=a("./existsNode"),C=a("./existsFromNode"),D=a("./leftAdapterNode"),E=a("./rightAdapterNode"),F=a("./typeNode"),G=a("./terminalNode"),H=a("./propertyNode");h({instance:{constructor:function(a,b){this.terminalNodes=[],this.joinNodes=[],this.nodes=[],this.constraints=[],this.typeNodes=[],this.__ruleCount=0,this.bucket={counter:0,recency:0},this.agendaTree=b,this.workingMemory=a},assertRule:function(a){var b=new G(this.bucket,this.__ruleCount++,a,this.agendaTree);this.__addToNetwork(a,a.pattern,b),this.__mergeJoinNodes(),this.terminalNodes.push(b)},resetCounter:function(){this.bucket.counter=0},incrementCounter:function(){this.bucket.counter++},assertFact:function(a){for(var b=this.typeNodes,c=b.length-1;c>=0;c--)b[c].assert(a)},retractFact:function(a){for(var b=this.typeNodes,c=b.length-1;c>=0;c--)b[c].retract(a)},modifyFact:function(a){for(var b=this.typeNodes,c=b.length-1;c>=0;c--)b[c].modify(a)},containsRule:function(a){return g(this.terminalNodes,function(b){return b.rule.name===a})},dispose:function(){for(var a=this.typeNodes,b=a.length-1;b>=0;b--)a[b].dispose()},__mergeJoinNodes:function(){for(var a=this.joinNodes,b=0;b<a.length;b++){var c=a[b],d=a[b+1];c&&d&&c.constraint&&d.constraint&&c.constraint.equal(d.constraint)&&(c.merge(d),a.splice(b+1,1))}},__checkEqual:function(a){for(var b=this.constraints,c=b.length-1;c>=0;c--){var d=b[c];if(a.equal(d))return d}return b.push(a),a},__createTypeNode:function(a,b){for(var c=new F(b.get("constraints")[0]),d=this.typeNodes,e=d.length-1;e>=0;e--){var f=d[e];if(c.equal(f))return f}return d.push(c),c},__createEqualityNode:function(a,b){return this.__checkEqual(new v(b)).addRule(a)},__createPropertyNode:function(a,b){return this.__checkEqual(new H(b)).addRule(a)},__createAliasNode:function(a,b){return this.__checkEqual(new u(b)).addRule(a)},__createAdapterNode:function(a,b){return("left"===b?new D:new E).addRule(a)},__createJoinNode:function(a,b,c,e){var f;b.rightPattern instanceof o?f=new y:b.rightPattern instanceof n?f=new C(b.rightPattern,this.workingMemory):b.rightPattern instanceof m?f=new B:b.rightPattern instanceof l?f=new A(b.rightPattern,this.workingMemory):b.rightPattern instanceof k?f=new z(b.rightPattern,this.workingMemory):b instanceof p&&!d(b.leftPattern)&&!d(b.rightPattern)?(f=new x,this.joinNodes.push(f)):(f=new w,this.joinNodes.push(f)),f.__rule__=a;var g=f;if(c instanceof x){var h=this.__createAdapterNode(a,e);g.addOutNode(h,b),g=h}return g.addOutNode(c,b),f.addRule(a)},__addToNetwork:function(a,b,c,d){b instanceof j?b instanceof q||d&&"left"!==d?this.__createAlphaNode(a,b,c,d):this.__createBetaNode(a,new p(new q,b),c,d):b instanceof p&&this.__createBetaNode(a,b,c,d)},__createBetaNode:function(a,b,c,d){var e=this.__createJoinNode(a,b,c,d);return this.__addToNetwork(a,b.rightPattern,e,"right"),this.__addToNetwork(a,b.leftPattern,e,"left"),c.addParentNode(e),e},__createAlphaNode:function(a,b,c,d){var e,f;if(!(b instanceof k)){var g=b.get("constraints");e=this.__createTypeNode(a,b);var h=this.__createAliasNode(a,b);e.addOutNode(h,b),h.addParentNode(e),f=h;for(var i=g.length-1;i>0;i--){var j,l=g[i];if(l instanceof s)j=this.__createPropertyNode(a,l);else{if(l instanceof t){c.constraint.addConstraint(l);continue}j=this.__createEqualityNode(a,l)}f.addOutNode(j,b),j.addParentNode(f),f=j}if(c instanceof x){var m=this.__createAdapterNode(a,d);m.addParentNode(f),f.addOutNode(m,b),f=m}return c.addParentNode(f),f.addOutNode(c,b),e}},print:function(){f(this.terminalNodes,function(a){a.print("    ")})}}}).as(c,"RootNode")},{"../constraint":8,"../extended":12,"../pattern.js":48,"./aliasNode":19,"./betaNode":21,"./equalityNode":22,"./existsFromNode":23,"./existsNode":24,"./fromNode":25,"./fromNotNode":26,"./joinNode":28,"./leftAdapterNode":30,"./notNode":38,"./propertyNode":39,"./rightAdapterNode":40,"./terminalNode":41,"./typeNode":42}],28:[function(a,b,c){var d=a("./betaNode"),e=a("./joinReferenceNode");d.extend({instance:{constructor:function(){this._super(arguments),this.constraint=new e(this.leftTuples,this.rightTuples)},nodeType:"JoinNode",propagateFromLeft:function(a,b){var c;return(c=this.constraint.match(a,b)).isMatch&&this.__propagate("assert",this.__addToMemoryMatches(b,a,a.clone(null,null,c))),this},propagateFromRight:function(a,b){var c;return(c=this.constraint.match(b,a)).isMatch&&this.__propagate("assert",this.__addToMemoryMatches(a,b,a.clone(null,null,c))),this},propagateAssertModifyFromLeft:function(a,b,c){var d,e=c.hashCode;if(e in b){d=this.constraint.match(a,c);d.isMatch?this.__propagate("modify",this.__addToMemoryMatches(c,a,a.clone(null,null,d))):this.__propagate("retract",b[e].clone())}else this.propagateFromLeft(a,c)},propagateAssertModifyFromRight:function(a,b,c){var d,e=c.hashCode;if(e in b){d=this.constraint.match(c,a);d.isMatch?this.__propagate("modify",this.__addToMemoryMatches(a,c,a.clone(null,null,d))):this.__propagate("retract",b[e].clone())}else this.propagateFromRight(a,c)}}}).as(b)},{"./betaNode":21,"./joinReferenceNode":29}],29:[function(a,b,c){function d(a,b,c){return a===b[1]&&(c=j[c]),c}function e(a,b,c){return a===b[1]&&(c=j[c]),c}var f=a("./node"),g=a("../constraint"),h=g.ReferenceEqualityConstraint,i={isDefault:!0,assert:function(){return!0},equal:function(){return!1}},j={gt:"lte",gte:"lte",lt:"gte",lte:"gte",eq:"eq",neq:"neq"};f.extend({instance:{constraint:i,constructor:function(a,b){this._super(arguments),this.constraint=i,this.constraintAssert=i.assert,this.rightIndexes=[],this.leftIndexes=[],this.constraintLength=0,this.leftMemory=a,this.rightMemory=b},addConstraint:function(a){if(a instanceof h){var b=a.getIndexableProperties(),c=a.get("alias");if(2===b.length&&c){for(var f,g,i=-1,j=[];++i<2;){var k=b[i];null===k.match(new RegExp("^"+c+"(\\.?)"))?(j.push(k),f=k):(j.push(k),g=k)}if(f&&g){var l=e(f,j,a.op),m=d(g,j,a.op);this.rightMemory.addIndex(g,f,m),this.leftMemory.addIndex(f,g,l)}}}this.constraint.isDefault?(this.constraint=a,this.isDefault=!1):this.constraint=this.constraint.merge(a),this.constraintAssert=this.constraint.assert},equal:function(a){return this.constraint.equal(a.constraint)},isMatch:function(a,b){return this.constraintAssert(a.factHash,b.factHash)},match:function(a,b){var c={isMatch:!1};return this.constraintAssert(a.factHash,b.factHash)&&(c=a.match.merge(b.match)),c}}}).as(b)},{"../constraint":8,"./node":37}],30:[function(a,b,c){a("./adapterNode").extend({instance:{propagateAssert:function(a){this.__propagate("assertLeft",a)},propagateRetract:function(a){this.__propagate("retractLeft",a)},propagateResolve:function(a){this.__propagate("retractResolve",a)},propagateModify:function(a){this.__propagate("modifyLeft",a)},retractResolve:function(a){this.__propagate("retractResolve",a)},dispose:function(a){this.propagateDispose(a)},toString:function(){return"LeftAdapterNode "+this.__count}}}).as(b)},{"./adapterNode":18}],31:[function(a,b,c){c.getMemory=function(){function a(a,b,c){var d,e=0,f=-1;if(m<c)for(;m&&++f<c;)l[(d=b[f]).hashCode]&&(a[e++]=d,m--);else h.apply(a,b);m=0,l={}}function b(a,b,c){var d,e=0,f=-1;if(i<c)for(;++f<c;)i?k[(d=b[f]).hashCode]?i--:a[e++]=d:a[e++]=b[f];i=0,k={}}function c(a,b,c){if(m===c)f(a,b,c);else if(i<c)for(var d,e,g=0,h=-1;++h<c;)!k[e=(d=b[h]).hashCode]&&l[e]&&(a[g++]=d);i=0,k={},m=0,l={}}function d(d,e){var f=j;return e&&(i||m?(f=[],i?m?c(f,d,e):b(f,d,e):a(f,d,e)):f=d),f}function e(a,b,c){var d;return"gt"===a?d=b.findGT(c):"gte"===a?d=b.findGTE(c):"lt"===a?d=b.findLT(c):"lte"===a&&(d=b.findLTE(c)),d}function f(a,b){if(b)for(var c,d=-1;++d<b;)c=a[d].hashCode,k[c]||(k[c]=!0,i++)}function g(a,b){if(b)for(var c,d=-1;++d<b;)c=a[d].hashCode,l[c]||(l[c]=!0,m++)}var h=Array.prototype.push,i=0,j=[],k={},l={},m=0;return function(a,b,c){for(var h,i,k,l,m,n,o,p=-1,q=c.length,r=a.tuples,s=r.length,t=!1,u=a.tables;++p<q&&s;)h=c[p],i=h[3](b),k=h[4],m=u[h[0]],"eq"===k||"seq"===k?(l=m.get(i))?(s=(r=(a=l).tuples).length,u=l.tables):s=(r=j).length:"neq"===k||"sneq"===k?(l=m.get(i))&&(o=(n=l.tuples).length,f(n,o)):t?(o=(n=e(k,m,i)).length)?g(n,o):(r=n,s=o):(s=(r=e(k,m,i)).length,t=!0);return d(r,s)}}()},{}],32:[function(a,b,c){a("./memory").extend({instance:{getLeftMemory:function(a){return this.getMemory(a)}}}).as(b)},{"./memory":33}],33:[function(a,b,c){var d=a("../../extended"),e=d.plucker,f=d.declare,g=a("./helpers").getMemory,h=a("./table"),i=a("./tupleEntry"),j=0;f({instance:{length:0,constructor:function(){this.head=null,this.tail=null,this.indexes=[],this.tables=new i(null,new h,!1)},push:function(a){var b=this.tail,c=this.head,d={data:a,tuples:[],hashCode:j++,prev:b,next:null};return b&&(this.tail.next=d),this.tail=d,c||(this.head=d),this.length++,this.__index(d),this.tables.addNode(d),d},remove:function(a){a.prev?a.prev.next=a.next:this.head=a.next,a.next?a.next.prev=a.prev:this.tail=a.prev,this.tables.removeNode(a),this.__removeFromIndex(a),this.length--},forEach:function(a){for(var b={next:this.head};b=b.next;)a(b.data)},toArray:function(){return this.tables.tuples.slice()},clear:function(){this.head=this.tail=null,this.length=0,this.clearIndexes()},clearIndexes:function(){this.tables={},this.indexes.length=0},__index:function(a){for(var b,c,d,e,f,g,j,k=a.data,l=k.factHash,m=this.indexes,n=this.tables,o=-1,p=m.length;++o<p;)c=m[o],d=c[2](l),e=c[0],f=n.tables,(b=(g=f[e]||(f[e]=new h)).get(d))||(b=new i(d,g,!0),g.set(d,b)),g!==j&&a.tuples.push(b.addNode(a)),j=g,"eq"===c[4]&&(n=b)},__removeFromIndex:function(a){for(var b=a.tuples,c=b.length;--c>=0;)b[c].removeNode(a);a.tuples.length=0},getMemory:function(a){return this.length?g(this.tables,a.factHash,this.indexes):[]},__createIndexTree:function(){(this.tables.tables={})[this.indexes[0][0]]=new h},addIndex:function(a,b,c){this.indexes.push([a,b,e(a),e(b),c||"eq"]),this.indexes.sort(function(a,b){var c=a[4],d=b[4];return c===d?0:c>d?1:c===d?0:-1}),this.__createIndexTree()}}}).as(b)},{"../../extended":12,"./helpers":31,"./table":35,"./tupleEntry":36}],34:[function(a,b,c){a("./memory").extend({instance:{getRightMemory:function(a){return this.getMemory(a)}}}).as(b)},{"./memory":33}],35:[function(a,b,c){function d(a,b){a=a.key,b=b.key;return a==b?0:a>b?1:a<b?-1:1}function e(a,b){return 1===d(a,b)}function f(a,b){return-1!==d(a,b)}function g(a,b){return-1===d(a,b)}function h(a,b){return 1!==d(a,b)}function i(a,b,c){p.key=b;for(var d,e=[],f=0,g=a.__root;;)if(g)g=(o[f++]=g).left;else{if(!(f>0))break;if(d=(g=o[--f]).data,!c(d,p))break;l.apply(e,d.value.tuples),g=g.right}return o.length=0,e}function j(a,b,c){p.key=b;for(var d,e=[],f=0,g=a.__root;;)if(g)g=(o[f++]=g).right;else{if(!(f>0))break;if(d=(g=o[--f]).data,!c(d,p))break;l.apply(e,d.value.tuples),g=g.left}return o.length=0,e}var k=a("../../extended"),l=Array.prototype.push,m=k.HashTable,n=k.AVLTree,o=[],p={key:null};n.extend({instance:{constructor:function(){this._super([{compare:d}]),this.gtCache=new m,this.gteCache=new m,this.ltCache=new m,this.lteCache=new m,this.hasGTCache=!1,this.hasGTECache=!1,this.hasLTCache=!1,this.hasLTECache=!1},clearCache:function(){this.hasGTCache&&this.gtCache.clear()&&(this.hasGTCache=!1),this.hasGTECache&&this.gteCache.clear()&&(this.hasGTECache=!1),this.hasLTCache&&this.ltCache.clear()&&(this.hasLTCache=!1),this.hasLTECache&&this.lteCache.clear()&&(this.hasLTECache=!1)},contains:function(a){return this._super([{key:a}])},set:function(a,b){this.insert({key:a,value:b}),this.clearCache()},get:function(a){var b=this.find({key:a});return b&&b.value},remove:function(a){return this.clearCache(),this._super([{key:a}])},findGT:function(a){var b=this.gtCache.get(a);return b||(this.hasGTCache=!0,this.gtCache.put(a,b=j(this,a,e))),b},findGTE:function(a){var b=this.gteCache.get(a);return b||(this.hasGTECache=!0,this.gteCache.put(a,b=j(this,a,f))),b},findLT:function(a){var b=this.ltCache.get(a);return b||(this.hasLTCache=!0,this.ltCache.put(a,b=i(this,a,g))),b},findLTE:function(a){var b=this.lteCache.get(a);return b||(this.hasLTECache=!0,this.lteCache.put(a,b=i(this,a,h))),b}}}).as(b)},{"../../extended":12}],36:[function(a,b,c){var d=a("../../extended"),e=d.indexOf,f=0;d.declare({instance:{tuples:null,tupleMap:null,hashCode:null,tables:null,entry:null,constructor:function(a,b,c){this.val=a,this.canRemove=c,this.tuples=[],this.tupleMap={},this.hashCode=f++,this.tables={},this.length=0,this.entry=b},addNode:function(a){return this.tuples[this.length++]=a,this.length>1&&this.entry.clearCache(),this},removeNode:function(a){var b=this.tuples,c=e(b,a);-1!==c&&(b.splice(c,1),this.length--,this.entry.clearCache()),this.canRemove&&!this.length&&this.entry.remove(this.val)}}}).as(b)},{"../../extended":12}],37:[function(a,b,c){var d=a("../extended"),e=d.forEach,f=d.indexOf,g=d.intersection,h=d.declare,i=d.HashTable,j=a("../context"),k=0;h({instance:{constructor:function(){this.nodes=new i,this.rules=[],this.parentNodes=[],this.__count=k++,this.__entrySet=[]},addRule:function(a){return-1===f(this.rules,a)&&this.rules.push(a),this},merge:function(a){a.nodes.forEach(function(b){for(var c=b.value,d=b.key,e=0,f=c.length;e<f;e++)this.addOutNode(d,c[e]);a.nodes.remove(d)},this);for(var b=a.parentNodes,c=0,d=a.parentNodes.l;c<d;c++){var e=b[c];this.addParentNode(e),e.nodes.remove(a)}return this},resolve:function(a,b){return a.hashCode===b.hashCode},print:function(a){console.log(a+this.toString()),e(this.parentNodes,function(b){b.print("    "+a)})},addOutNode:function(a,b){this.nodes.contains(a)||this.nodes.put(a,[]),this.nodes.get(a).push(b),this.__entrySet=this.nodes.entrySet()},addParentNode:function(a){-1===f(this.parentNodes,a)&&this.parentNodes.push(a)},shareable:function(){return!1},__propagate:function(a,b){for(var c,d,e,f,h=this.__entrySet,i=h.length;--i>-1;)c=h[i],d=c.key,e=c.value,(f=g(e,b.paths)).length&&d[a](new j(b.fact,f,b.match))},dispose:function(a){this.propagateDispose(a)},retract:function(a){this.propagateRetract(a)},propagateDispose:function(a,b){b=b||this.nodes;for(var c=this.__entrySet,d=c.length-1;d>=0;d--){c[d].key.dispose(a)}},propagateAssert:function(a){this.__propagate("assert",a)},propagateRetract:function(a){this.__propagate("retract",a)},assert:function(a){this.propagateAssert(a)},modify:function(a){this.propagateModify(a)},propagateModify:function(a){this.__propagate("modify",a)}}}).as(b)},{"../context":10,"../extended":12}],38:[function(a,b,c){var d=a("./joinNode"),e=a("../linkedList"),f=a("../context"),g=a("../pattern").InitialFact;d.extend({instance:{nodeType:"NotNode",constructor:function(){this._super(arguments),this.leftTupleMemory={},this.notMatch=new f(new g).match},__cloneContext:function(a){return a.clone(null,null,a.match.merge(this.notMatch))},retractRight:function(a){var b=this.removeFromRightMemory(a),c=b.data,d=c.blocking;if(d.length){for(var e,f,g=this.constraint,h={next:d.head};h=h.next;){e=h.data,this.removeFromLeftBlockedMemory(e);var i,j=this.rightTuples.getRightMemory(e),k=j.length;for(i=-1;++i<k;)if(g.isMatch(e,f=j[i].data)){this.blockedContext(e,f),e=null;break}e&&this.notBlockedContext(e,!0)}d.clear()}},blockedContext:function(a,b,c){a.blocker=b,this.removeFromLeftMemory(a),this.addToLeftBlockedMemory(b.blocking.push(a)),c&&this.__propagate("retract",this.__cloneContext(a))},notBlockedContext:function(a,b){this.__addToLeftMemory(a),b&&this.__propagate("assert",this.__cloneContext(a))},propagateFromLeft:function(a){this.notBlockedContext(a,!0)},propagateFromRight:function(a){this.notBlockedContext(a,!0)},blockFromAssertRight:function(a,b){this.blockedContext(a,b,!0)},blockFromAssertLeft:function(a,b){this.blockedContext(a,b,!1)},retractLeft:function(a){var b=this.removeFromLeftMemory(a);if(b)b=b.data,this.__propagate("retract",this.__cloneContext(b));else if(!this.removeFromLeftBlockedMemory(a))throw new Error},assertLeft:function(a){for(var b,c=this.rightTuples.getRightMemory(a),d=this.constraint,e=-1,f=c.length;++e<f;)d.isMatch(a,b=c[e].data)&&(this.blockFromAssertLeft(a,b),a=null,e=f);a&&this.propagateFromLeft(a)},assertRight:function(a){this.__addToRightMemory(a),a.blocking=new e;for(var b,c=this.leftTuples.getLeftMemory(a).slice(),d=-1,f=c.length,g=this.constraint;++d<f;)b=c[d].data,g.isMatch(b,a)&&this.blockFromAssertRight(b,a)},addToLeftBlockedMemory:function(a){var b=a.data,c=b.hashCode,d=this.leftMemory[c];return this.leftTupleMemory[c]=a,d&&this.leftTuples.remove(d),this},removeFromLeftBlockedMemory:function(a){var b=this.leftTupleMemory[a.hashCode]||null;return b&&(delete this.leftTupleMemory[a.hashCode],b.data.blocker.blocking.remove(b)),b},modifyLeft:function(a){var b,c,d,e,f=this.removeFromLeftMemory(a),g=this.constraint,h=this.rightTuples.getRightMemory(a),i=h.length,j=!1;if(f||(f=this.removeFromLeftBlockedMemory(a),j=!0),!f)throw new Error;if(b=f.data,b&&b.blocker&&(e=this.rightMemory[b.blocker.hashCode],b.blocker=null),e&&g.isMatch(a,d=e.data)&&(j||this.__propagate("retract",this.__cloneContext(b)),a.blocker=d,this.addToLeftBlockedMemory(d.blocking.push(a)),a=null),a&&i)for(c=-1;++c<i;)if(g.isMatch(a,d=h[c].data)){j||this.__propagate("retract",this.__cloneContext(b)),this.addToLeftBlockedMemory(d.blocking.push(a)),a.blocker=d,a=null;break}a&&(this.__addToLeftMemory(a),j?this.__propagate("assert",this.__cloneContext(a)):this.__propagate("modify",this.__cloneContext(a)))},modifyRight:function(a){var b=this.removeFromRightMemory(a);if(!b)throw new Error;var c,d,f,g=b.data,h=this.leftTuples.getLeftMemory(a).slice(),i=h.length,j=this.constraint,k=g.blocking;this.__addToRightMemory(a),a.blocking=new e;for(var l,m={next:k.head};m=m.next;)if(c=m.data,c.blocker=null,j.isMatch(c,a))c.blocker=a,this.addToLeftBlockedMemory(a.blocking.push(c)),c=null;else{for(c.blocker=null,f=b;f=f.next;)if(j.isMatch(c,l=f.data)){c.blocker=l,this.addToLeftBlockedMemory(l.blocking.push(c)),c=null;break}c&&(this.__addToLeftMemory(c),this.__propagate("assert",this.__cloneContext(c)))}if(i)for(d=-1;++d<i;)c=h[d].data,j.isMatch(c,a)&&(this.__propagate("retract",this.__cloneContext(c)),this.removeFromLeftMemory(c),this.addToLeftBlockedMemory(a.blocking.push(c)),c.blocker=a)}}}).as(b)},{"../context":10,"../linkedList":16,"../pattern":48,"./joinNode":28}],39:[function(a,b,c){var d=a("./alphaNode"),e=a("../context"),f=a("../extended");d.extend({instance:{constructor:function(){this._super(arguments),this.alias=this.constraint.get("alias"),this.varLength=(this.variables=f(this.constraint.get("variables")).toArray().value()).length},assert:function(a){var b,c=new e(a.fact,a.paths),d=this.variables,f=a.fact.object;c.set(this.alias,f);for(var g=0,h=this.varLength;g<h;g++)b=d[g],c.set(b[1],f[b[0]]);this.__propagate("assert",c)},retract:function(a){this.__propagate("retract",new e(a.fact,a.paths))},modify:function(a){var b,c=new e(a.fact,a.paths),d=this.variables,f=a.fact.object;c.set(this.alias,f);for(var g=0,h=this.varLength;g<h;g++)b=d[g],c.set(b[1],f[b[0]]);this.__propagate("modify",c)},toString:function(){return"PropertyNode"+this.__count}}}).as(b)},{"../context":10,"../extended":12,"./alphaNode":20}],40:[function(a,b,c){a("./adapterNode").extend({instance:{retractResolve:function(a){this.__propagate("retractResolve",a)},dispose:function(a){this.propagateDispose(a)},propagateAssert:function(a){this.__propagate("assertRight",a)},propagateRetract:function(a){this.__propagate("retractRight",a)},propagateResolve:function(a){this.__propagate("retractResolve",a)},propagateModify:function(a){this.__propagate("modifyRight",a)},toString:function(){return"RightAdapterNode "+this.__count}}}).as(b)},{"./adapterNode":18}],41:[function(a,b,c){var d=a("./node"),e=a("../extended"),f=e.bind;d.extend({instance:{constructor:function(a,b,c,d){this._super([]),this.resolve=f(this,this.resolve),this.rule=c,this.index=b,this.name=this.rule.name,this.agenda=d,this.bucket=a,d.register(this)},__assertModify:function(a){var b=a.match;if(b.isMatch){var c=this.rule,d=this.bucket;this.agenda.insert(this,{rule:c,hashCode:a.hashCode,index:this.index,name:c.name,recency:d.recency++,match:b,counter:d.counter})}},assert:function(a){this.__assertModify(a)},modify:function(a){this.agenda.retract(this,a),this.__assertModify(a)},retract:function(a){this.agenda.retract(this,a)},retractRight:function(a){this.agenda.retract(this,a)},retractLeft:function(a){this.agenda.retract(this,a)},assertLeft:function(a){this.__assertModify(a)},assertRight:function(a){this.__assertModify(a)},toString:function(){return"TerminalNode "+this.rule.name}}}).as(b)},{"../extended":12,"./node":37}],42:[function(a,b,c){var d=a("./alphaNode"),e=a("../context");d.extend({instance:{assert:function(a){this.constraintAssert(a.object)&&this.__propagate("assert",a)},modify:function(a){this.constraintAssert(a.object)&&this.__propagate("modify",a)},retract:function(a){this.constraintAssert(a.object)&&this.__propagate("retract",a)},toString:function(){return"TypeNode"+this.__count},dispose:function(){for(var a=this.__entrySet,b=a.length-1;b>=0;b--){var c=a[b],d=c.key,e=c.value;d.dispose({paths:e})}},__propagate:function(a,b){for(var c=this.__entrySet,d=-1,f=c.length;++d<f;){var g=c[d],h=g.key,i=g.value;h[a](new e(b,i))}}}}).as(b)},{"../context":10,"./alphaNode":20}],43:[function(a,b,c){var d=a("__browserify_process"),e=function(){function a(){this.yy={}}var b=function(a,b,c,d){for(c=c||{},d=a.length;d--;c[a[d]]=b);return c},c=[1,29],d=[1,30],e=[1,26],f=[1,24],g=[1,16],h=[1,18],i=[1,19],j=[1,20],k=[1,21],l=[1,22],m=[5,38,49],n=[1,33],o=[5,36,38,49],p=[5,8,11,12,13,15,17,19,20,21,22,24,25,26,27,28,29,36,38,49],q=[2,2],r=[5,24,25,26,27,28,29,36,38,49],s=[1,42],t=[1,43],u=[1,44],v=[1,45],w=[5,8,11,12,13,15,17,19,20,21,22,24,25,26,27,28,29,31,33,36,38,40,46,49],x=[1,46],y=[1,47],z=[1,48],A=[5,19,20,21,22,24,25,26,27,28,29,36,38,49],B=[1,50],C=[5,8,11,12,13,15,17,19,20,21,22,24,25,26,27,28,29,31,33,36,38,40,43,44,46,48,49],D=[5,17,19,20,21,22,24,25,26,27,28,29,36,38,49],E=[1,55],F=[1,54],G=[5,8,15,17,19,20,21,22,24,25,26,27,28,29,36,38,49],H=[1,56],I=[1,57],J=[1,58],K=[1,87],L=[40,46,49],M={trace:function(){},yy:{},symbols_:{error:2,expressions:3,EXPRESSION:4,EOF:5,UNARY_EXPRESSION:6,LITERAL_EXPRESSION:7,"-":8,"!":9,MULTIPLICATIVE_EXPRESSION:10,"*":11,"/":12,"%":13,ADDITIVE_EXPRESSION:14,"+":15,EXPONENT_EXPRESSION:16,"^":17,RELATIONAL_EXPRESSION:18,"<":19,">":20,"<=":21,">=":22,EQUALITY_EXPRESSION:23,"==":24,"===":25,"!=":26,"!==":27,"=~":28,"!=~":29,IN_EXPRESSION:30,in:31,ARRAY_EXPRESSION:32,notIn:33,OBJECT_EXPRESSION:34,AND_EXPRESSION:35,"&&":36,OR_EXPRESSION:37,"||":38,ARGUMENT_LIST:39,",":40,IDENTIFIER_EXPRESSION:41,IDENTIFIER:42,".":43,"[":44,STRING_EXPRESSION:45,"]":46,NUMBER_EXPRESSION:47,"(":48,")":49,STRING:50,NUMBER:51,REGEXP_EXPRESSION:52,REGEXP:53,BOOLEAN_EXPRESSION:54,BOOLEAN:55,NULL_EXPRESSION:56,NULL:57,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",8:"-",9:"!",11:"*",12:"/",13:"%",15:"+",17:"^",19:"<",20:">",21:"<=",22:">=",24:"==",25:"===",26:"!=",27:"!==",28:"=~",29:"!=~",31:"in",33:"notIn",36:"&&",38:"||",40:",",42:"IDENTIFIER",43:".",44:"[",46:"]",48:"(",49:")",50:"STRING",51:"NUMBER",53:"REGEXP",55:"BOOLEAN",57:"NULL"},productions_:[0,[3,2],[6,1],[6,2],[6,2],[10,1],[10,3],[10,3],[10,3],[14,1],[14,3],[14,3],[16,1],[16,3],[18,1],[18,3],[18,3],[18,3],[18,3],[23,1],[23,3],[23,3],[23,3],[23,3],[23,3],[23,3],[30,1],[30,3],[30,3],[30,3],[30,3],[35,1],[35,3],[37,1],[37,3],[39,1],[39,3],[41,1],[34,1],[34,3],[34,4],[34,4],[34,4],[34,3],[34,4],[45,1],[47,1],[52,1],[54,1],[56,1],[32,2],[32,3],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,3],[4,1]],performAction:function(a,b,c,d,e,f,g){var h=f.length-1;switch(e){case 1:return f[h-1];case 3:this.$=[f[h],null,"unary"];break;case 4:this.$=[f[h],null,"logicalNot"];break;case 6:this.$=[f[h-2],f[h],"mult"];break;case 7:this.$=[f[h-2],f[h],"div"];break;case 8:this.$=[f[h-2],f[h],"mod"];break;case 10:this.$=[f[h-2],f[h],"plus"];break;case 11:this.$=[f[h-2],f[h],"minus"];break;case 13:this.$=[f[h-2],f[h],"pow"];break;case 15:this.$=[f[h-2],f[h],"lt"];break;case 16:this.$=[f[h-2],f[h],"gt"];break;case 17:this.$=[f[h-2],f[h],"lte"];break;case 18:this.$=[f[h-2],f[h],"gte"];break;case 20:this.$=[f[h-2],f[h],"eq"];break;case 21:this.$=[f[h-2],f[h],"seq"];break;case 22:this.$=[f[h-2],f[h],"neq"];break;case 23:this.$=[f[h-2],f[h],"sneq"];break;case 24:this.$=[f[h-2],f[h],"like"];break;case 25:this.$=[f[h-2],f[h],"notLike"];break;case 27:case 29:this.$=[f[h-2],f[h],"in"];break;case 28:case 30:this.$=[f[h-2],f[h],"notIn"];break;case 32:this.$=[f[h-2],f[h],"and"];break;case 34:this.$=[f[h-2],f[h],"or"];break;case 36:this.$=[f[h-2],f[h],"arguments"];break;case 37:this.$=[String(a),null,"identifier"];break;case 39:this.$=[f[h-2],f[h],"prop"];break;case 40:case 41:case 42:this.$=[f[h-3],f[h-1],"propLookup"];break;case 43:this.$=[f[h-2],[null,null,"arguments"],"function"];break;case 44:this.$=[f[h-3],f[h-1],"function"];break;case 45:this.$=[String(a.replace(/^['|"]|['|"]$/g,"")),null,"string"];break;case 46:this.$=[Number(a),null,"number"];break;case 47:this.$=[a,null,"regexp"];break;case 48:this.$=["true"==a.replace(/^\s+/,""),null,"boolean"];break;case 49:this.$=[null,null,"null"];break;case 50:this.$=[null,null,"array"];break;case 51:this.$=[f[h-1],null,"array"];break;case 59:this.$=[f[h-1],null,"composite"]}},table:[{3:1,4:2,6:28,7:7,8:c,9:d,10:27,14:25,16:17,18:8,23:6,30:5,32:15,34:14,35:4,37:3,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{1:[3]},{5:[1,31]},b([5,49],[2,60],{38:[1,32]}),b(m,[2,33],{36:n}),b(o,[2,31]),b(o,[2,26],{24:[1,34],25:[1,35],26:[1,36],27:[1,37],28:[1,38],29:[1,39]}),b(p,q,{31:[1,40],33:[1,41]}),b(r,[2,19],{19:s,20:t,21:u,22:v}),b(w,[2,52]),b(w,[2,53]),b(w,[2,54]),b(w,[2,55]),b(w,[2,56]),b(w,[2,57],{43:x,44:y,48:z}),b(w,[2,58]),{4:49,6:28,7:7,8:c,9:d,10:27,14:25,16:17,18:8,23:6,30:5,32:15,34:14,35:4,37:3,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},b(A,[2,14],{17:B}),b(w,[2,45]),b(w,[2,46]),b(w,[2,47]),b(w,[2,48]),b(w,[2,49]),b(C,[2,38]),{7:53,32:15,34:14,39:52,41:23,42:e,44:f,45:9,46:[1,51],47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},b(D,[2,12],{8:E,15:F}),b(C,[2,37]),b(G,[2,9],{11:H,12:I,13:J}),b(p,[2,5]),{6:59,7:60,8:c,9:d,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{6:61,7:60,8:c,9:d,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{1:[2,1]},{6:28,7:7,8:c,9:d,10:27,14:25,16:17,18:8,23:6,30:5,32:15,34:14,35:62,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{6:28,7:7,8:c,9:d,10:27,14:25,16:17,18:8,23:6,30:63,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{6:28,7:60,8:c,9:d,10:27,14:25,16:17,18:64,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{6:28,7:60,8:c,9:d,10:27,14:25,16:17,18:65,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{6:28,7:60,8:c,9:d,10:27,14:25,16:17,18:66,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{6:28,7:60,8:c,9:d,10:27,14:25,16:17,18:67,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{6:28,7:60,8:c,9:d,10:27,14:25,16:17,18:68,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{6:28,7:60,8:c,9:d,10:27,14:25,16:17,18:69,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{32:70,34:71,41:23,42:e,44:f},{32:72,34:73,41:23,42:e,44:f},{6:28,7:60,8:c,9:d,10:27,14:25,16:74,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{6:28,7:60,8:c,9:d,10:27,14:25,16:75,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{6:28,7:60,8:c,9:d,10:27,14:25,16:76,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{6:28,7:60,8:c,9:d,10:27,14:25,16:77,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{41:78,42:e},{34:81,41:23,42:e,45:79,47:80,50:h,51:i},{7:53,32:15,34:14,39:83,41:23,42:e,44:f,45:9,47:10,48:g,49:[1,82],50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{49:[1,84]},{6:28,7:60,8:c,9:d,10:27,14:85,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},b(w,[2,50]),{40:K,46:[1,86]},b(L,[2,35]),{6:28,7:60,8:c,9:d,10:88,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{6:28,7:60,8:c,9:d,10:89,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{6:90,7:60,8:c,9:d,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{6:91,7:60,8:c,9:d,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},{6:92,7:60,8:c,9:d,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},b(p,[2,3]),b(p,q),b(p,[2,4]),b(m,[2,34],{36:n}),b(o,[2,32]),b(r,[2,20],{19:s,20:t,21:u,22:v}),b(r,[2,21],{19:s,20:t,21:u,22:v}),b(r,[2,22],{19:s,20:t,21:u,22:v}),b(r,[2,23],{19:s,20:t,21:u,22:v}),b(r,[2,24],{19:s,20:t,21:u,22:v}),b(r,[2,25],{19:s,20:t,21:u,22:v}),b(o,[2,27]),b(o,[2,29],{43:x,44:y,48:z}),b(o,[2,28]),b(o,[2,30],{43:x,44:y,48:z}),b(A,[2,15],{17:B}),b(A,[2,16],{17:B}),b(A,[2,17],{17:B}),b(A,[2,18],{17:B}),b(C,[2,39]),{46:[1,93]},{46:[1,94]},{43:x,44:y,46:[1,95],48:z},b(C,[2,43]),{40:K,49:[1,96]},b(w,[2,59]),b(D,[2,13],{8:E,15:F}),b(w,[2,51]),{7:97,32:15,34:14,41:23,42:e,44:f,45:9,47:10,48:g,50:h,51:i,52:11,53:j,54:12,55:k,56:13,57:l},b(G,[2,10],{11:H,12:I,13:J}),b(G,[2,11],{11:H,12:I,13:J}),b(p,[2,6]),b(p,[2,7]),b(p,[2,8]),b(C,[2,40]),b(C,[2,41]),b(C,[2,42]),b(C,[2,44]),b(L,[2,36])],defaultActions:{31:[2,1]},parseError:function(a,b){function c(a,b){this.message=a,this.hash=b}if(!b.recoverable)throw c.prototype=Error,new c(a,b);this.trace(a)},parse:function(a){var b=this,c=[0],d=[null],e=[],f=this.table,g="",h=0,i=0,j=0,k=2,l=1,m=e.slice.call(arguments,1),n=Object.create(this.lexer),o={yy:{}};for(var p in this.yy)Object.prototype.hasOwnProperty.call(this.yy,p)&&(o.yy[p]=this.yy[p]);n.setInput(a,o.yy),o.yy.lexer=n,o.yy.parser=this,void 0===n.yylloc&&(n.yylloc={});var q=n.yylloc;e.push(q);var r=n.options&&n.options.ranges;"function"==typeof o.yy.parseError?this.parseError=o.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var s,t,u,v,w,x,y,z,A,B=function(){var a;return a=n.lex()||l,"number"!=typeof a&&(a=b.symbols_[a]||a),a},C={};;){if(u=c[c.length-1],this.defaultActions[u]?v=this.defaultActions[u]:(null!==s&&void 0!==s||(s=B()),v=f[u]&&f[u][s]),void 0===v||!v.length||!v[0]){var D="";A=[];for(x in f[u])this.terminals_[x]&&x>k&&A.push("'"+this.terminals_[x]+"'");D=n.showPosition?"Parse error on line "+(h+1)+":\n"+n.showPosition()+"\nExpecting "+A.join(", ")+", got '"+(this.terminals_[s]||s)+"'":"Parse error on line "+(h+1)+": Unexpected "+(s==l?"end of input":"'"+(this.terminals_[s]||s)+"'"),this.parseError(D,{text:n.match,token:this.terminals_[s]||s,line:n.yylineno,loc:q,expected:A})}if(v[0]instanceof Array&&v.length>1)throw new Error("Parse Error: multiple actions possible at state: "+u+", token: "+s);switch(v[0]){case 1:c.push(s),d.push(n.yytext),e.push(n.yylloc),c.push(v[1]),s=null,t?(s=t,t=null):(i=n.yyleng,g=n.yytext,h=n.yylineno,q=n.yylloc,j>0&&j--);break;case 2:if(y=this.productions_[v[1]][1],C.$=d[d.length-y],C._$={first_line:e[e.length-(y||1)].first_line,last_line:e[e.length-1].last_line,first_column:e[e.length-(y||1)].first_column,last_column:e[e.length-1].last_column},r&&(C._$.range=[e[e.length-(y||1)].range[0],e[e.length-1].range[1]]),void 0!==(w=this.performAction.apply(C,[g,i,h,o.yy,v[1],d,e].concat(m))))return w;y&&(c=c.slice(0,-1*y*2),d=d.slice(0,-1*y),e=e.slice(0,-1*y)),c.push(this.productions_[v[1]][0]),d.push(C.$),e.push(C._$),z=f[c[c.length-2]][c[c.length-1]],c.push(z);break;case 3:return!0}}return!0}},N=function(){return{EOF:1,parseError:function(a,b){if(!this.yy.parser)throw new Error(a);this.yy.parser.parseError(a,b)},setInput:function(a,b){return this.yy=b||this.yy||{},this._input=a,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var a=this._input[0];return this.yytext+=a,this.yyleng++,this.offset++,this.match+=a,this.matched+=a,a.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),a},unput:function(a){var b=a.length,c=a.split(/(?:\r\n?|\n)/g);this._input=a+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-b),this.offset-=b;var d=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),c.length-1&&(this.yylineno-=c.length-1);var e=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:c?(c.length===d.length?this.yylloc.first_column:0)+d[d.length-c.length].length-c[0].length:this.yylloc.first_column-b},this.options.ranges&&(this.yylloc.range=[e[0],e[0]+this.yyleng-b]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(a){this.unput(this.match.slice(a))},pastInput:function(){var a=this.matched.substr(0,this.matched.length-this.match.length);return(a.length>20?"...":"")+a.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var a=this.match;return a.length<20&&(a+=this._input.substr(0,20-a.length)),(a.substr(0,20)+(a.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var a=this.pastInput(),b=new Array(a.length+1).join("-");return a+this.upcomingInput()+"\n"+b+"^"},test_match:function(a,b){var c,d,e;if(this.options.backtrack_lexer&&(e={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(e.yylloc.range=this.yylloc.range.slice(0))),d=a[0].match(/(?:\r\n?|\n).*/g),d&&(this.yylineno+=d.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:d?d[d.length-1].length-d[d.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+a[0].length},this.yytext+=a[0],this.match+=a[0],this.matches=a,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(a[0].length),this.matched+=a[0],c=this.performAction.call(this,this.yy,this,b,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),c)return c;if(this._backtrack){for(var f in e)this[f]=e[f];return!1}return!1},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var a,b,c,d;this._more||(this.yytext="",this.match="");for(var e=this._currentRules(),f=0;f<e.length;f++)if((c=this._input.match(this.rules[e[f]]))&&(!b||c[0].length>b[0].length)){if(b=c,d=f,this.options.backtrack_lexer){if(!1!==(a=this.test_match(c,e[f])))return a;if(this._backtrack){b=!1;continue}return!1}if(!this.options.flex)break}return b?!1!==(a=this.test_match(b,e[d]))&&a:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var a=this.next();return a||this.lex()},begin:function(a){this.conditionStack.push(a)},popState:function(){return this.conditionStack.length-1>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(a){return a=this.conditionStack.length-1-Math.abs(a||0),a>=0?this.conditionStack[a]:"INITIAL"},pushState:function(a){this.begin(a)},stateStackSize:function(){return this.conditionStack.length},options:{},performAction:function(a,b,c,d){switch(c){case 0:return 31;case 1:return 33;case 2:return"from";case 3:return 24;case 4:return 25;case 5:return 26;case 6:return 27;case 7:return 21;case 8:return 19;case 9:return 22;case 10:return 20;case 11:return 28;case 12:return 29;case 13:return 36;case 14:return 38;case 15:return 57;case 16:return 55;case 17:break;case 18:return 51;case 19:case 20:return 50;case 21:return 42;case 22:return 53;case 23:return 43;case 24:return 11;case 25:return 12;case 26:return 13;case 27:return 40;case 28:return 8;case 29:return 28;case 30:return 29;case 31:return 25;case 32:return 24;case 33:return 27;case 34:return 26;case 35:return 21;case 36:return 22;case 37:return 20;case 38:return 19;case 39:return 36;case 40:return 38;case 41:return 15;case 42:return 17;case 43:return 48;case 44:return 46;case 45:return 44;case 46:return 49;case 47:return 9;case 48:return 5}},rules:[/^(?:\s+in\b)/,/^(?:\s+notIn\b)/,/^(?:\s+from\b)/,/^(?:\s+(eq|EQ)\b)/,/^(?:\s+(seq|SEQ)\b)/,/^(?:\s+(neq|NEQ)\b)/,/^(?:\s+(sneq|SNEQ)\b)/,/^(?:\s+(lte|LTE)\b)/,/^(?:\s+(lt|LT)\b)/,/^(?:\s+(gte|GTE)\b)/,/^(?:\s+(gt|GT)\b)/,/^(?:\s+(like|LIKE)\b)/,/^(?:\s+(notLike|NOT_LIKE)\b)/,/^(?:\s+(and|AND)\b)/,/^(?:\s+(or|OR)\b)/,/^(?:\s*(null)\b)/,/^(?:\s*(true|false)\b)/,/^(?:\s+)/,/^(?:-?[0-9]+(?:\.[0-9]+)?\b)/,/^(?:'[^']*')/,/^(?:"[^"]*")/,/^(?:([a-zA-Z_$][0-9a-zA-Z_$]*))/,/^(?:^\/((?![\s=])[^[\/\n\\]*(?:(?:\\[\s\S]|\[[^\]\n\\]*(?:\\[\s\S][^\]\n\\]*)*])[^[\/\n\\]*)*\/[imgy]{0,4})(?!\w))/,/^(?:\.)/,/^(?:\*)/,/^(?:\/)/,/^(?:\%)/,/^(?:,)/,/^(?:-)/,/^(?:=~)/,/^(?:!=~)/,/^(?:===)/,/^(?:==)/,/^(?:!==)/,/^(?:!=)/,/^(?:<=)/,/^(?:>=)/,/^(?:>)/,/^(?:<)/,/^(?:&&)/,/^(?:\|\|)/,/^(?:\+)/,/^(?:\^)/,/^(?:\()/,/^(?:\])/,/^(?:\[)/,/^(?:\))/,/^(?:!)/,/^(?:$)/],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48],inclusive:!0}}}}();return M.lexer=N,a.prototype=M,M.Parser=a,new a}();void 0!==a&&void 0!==c&&(c.parser=e,c.Parser=e.Parser,c.parse=function(){return e.parse.apply(e,arguments)},c.main=function(b){b[1]||(console.log("Usage: "+b[0]+" FILE"),d.exit(1));var e=a("fs").readFileSync(a("path").normalize(b[1]),"utf8");return c.parser.parse(e)},void 0!==b&&a.main===b&&c.main(d.argv.slice(1)))},{__browserify_process:64,fs:61,path:62}],44:[function(a,b,c){!function(){"use strict";var b=a("./constraint/parser"),d=a("./b2wgin/nool.parser");c.parseConstraint=function(a){try{return b.parse(a)}catch(b){throw new Error("Invalid expression '"+a+"'")}},c.parseRuleSet=function(a,b){return d.parse(a,b)}}()},{"./constraint/parser":43,"./b2wgin/nool.parser":45}],45:[function(a,b,c){"use strict";var d=a("./tokens.js"),e=a("../../extended"),f=e.hash.keys,g=a("./util.js"),h=function(a,b,c){var d=a;a=a.replace(/\/\/(.*)/g,"").replace(/\r\n|\r|\n/g," ");for(var e,i=new RegExp("^("+f(b).join("|")+")");a&&-1!==(e=g.findNextTokenIndex(a));){a=a.substr(e);var j=a.match(i);if(null===j)throw new Error("Error parsing "+a);if(!((j=j[1])in b))throw new Error("Unknown token"+j);try{a=b[j](a,c,h).replace(/^\s*|\s*$/g,"")}catch(a){throw new Error("Invalid "+j+" definition \n"+a.message+"; \nstarting at : "+d)}}};c.parse=function(a,b){var c={define:[],rules:[],scope:[],loaded:[],file:b};return h(a,d,c),c}},{"../../extended":12,"./tokens.js":46,"./util.js":47}],46:[function(require,module,exports){var process=require("__browserify_process"),utils=require("./util.js"),fs=require("fs"),extd=require("../../extended"),filter=extd.filter,indexOf=extd.indexOf,predicates=["not","or","exists"],predicateRegExp=new RegExp("^("+predicates.join("|")+") *\\((.*)\\)$","m"),predicateBeginExp=new RegExp(" *("+predicates.join("|")+") *\\(","g"),isWhiteSpace=function(a){return 0===a.replace(/[\s|\n|\r|\t]/g,"").length},joinFunc=function(a,b){return"; "+b},splitRuleLineByPredicateExpressions=function(a){var b=a.replace(/,\s*(\$?\w+\s*:)/g,joinFunc),c=filter(b.split(predicateBeginExp),function(a){return""!==a}),d=c.length,e=[];if(!d)return b;for(var f=0;f<d;f++)-1!==indexOf(predicates,c[f])?e.push([c[f],"(",c[++f].replace(/, *$/,"")].join("")):e.push(c[f].replace(/, *$/,""));return e.join(";")},ruleTokens={salience:function(){var a=/^(salience|priority)\s*:\s*(-?\d+)\s*[,;]?/;return function(b,c){if(a.test(b)){var d=b.match(a),e=parseInt(d[2],10);if(isNaN(e))throw new Error("Invalid salience/priority "+d[2]);return c.options.priority=e,b.replace(d[0],"")}throw new Error("invalid format")}}(),agendaGroup:function(){var a=/^(agenda-group|agendaGroup)\s*:\s*([a-zA-Z_$][0-9a-zA-Z_$]*|"[^"]*"|'[^']*')\s*[,;]?/;return function(b,c){if(a.test(b)){var d=b.match(a),e=d[2];if(!e)throw new Error("Invalid agenda-group "+d[2]);return c.options.agendaGroup=e.replace(/^["']|["']$/g,""),b.replace(d[0],"")}throw new Error("invalid format")}}(),autoFocus:function(){var a=/^(auto-focus|autoFocus)\s*:\s*(true|false)\s*[,;]?/;return function(b,c){if(a.test(b)){var d=b.match(a),e=d[2];if(!e)throw new Error("Invalid auto-focus "+d[2]);return c.options.autoFocus="true"===e,b.replace(d[0],"")}throw new Error("invalid format")}}(),"agenda-group":function(){return this.agendaGroup.apply(this,arguments)},"auto-focus":function(){return this.autoFocus.apply(this,arguments)},priority:function(){return this.salience.apply(this,arguments)},when:function(){var ruleRegExp=/^(\$?\w+) *: *(\w+)(.*)/,constraintRegExp=/(\{ *(?:["']?\$?\w+["']?\s*:\s*["']?\$?\w+["']? *(?:, *["']?\$?\w+["']?\s*:\s*["']?\$?\w+["']?)*)+ *\})/,fromRegExp=/(\bfrom\s+.*)/,parseRules=function(str){for(var rules=[],ruleLines=str.split(";"),l=ruleLines.length,ruleLine,i=0;i<l&&(ruleLine=ruleLines[i].replace(/^\s*|\s*$/g,"").replace(/\n/g,""));i++)if(!isWhiteSpace(ruleLine)){var rule=[];if(predicateRegExp.test(ruleLine)){var m=ruleLine.match(predicateRegExp),pred=m[1].replace(/^\s*|\s*$/g,"");if(rule.push(pred),ruleLine=m[2].replace(/^\s*|\s*$/g,""),"or"===pred){rule=rule.concat(parseRules(splitRuleLineByPredicateExpressions(ruleLine))),rules.push(rule);continue}}var parts=ruleLine.match(ruleRegExp);if(!parts||!parts.length)throw new Error("Invalid constraint "+ruleLine);rule.push(parts[2],parts[1]);var constraints=parts[3].replace(/^\s*|\s*$/g,""),hashParts=constraints.match(constraintRegExp),from=null,fromMatch;if(hashParts){var hash=hashParts[1],constraint=constraints.replace(hash,"");fromRegExp.test(constraint)&&(fromMatch=constraint.match(fromRegExp),from=fromMatch[0],constraint=constraint.replace(fromMatch[0],"")),constraint&&rule.push(constraint.replace(/^\s*|\s*$/g,"")),hash&&rule.push(eval("("+hash.replace(/(\$?\w+)\s*:\s*(\$?\w+)/g,'"$1" : "$2"')+")"))}else constraints&&!isWhiteSpace(constraints)&&(fromRegExp.test(constraints)&&(fromMatch=constraints.match(fromRegExp),from=fromMatch[0],constraints=constraints.replace(fromMatch[0],"")),rule.push(constraints));from&&rule.push(from),rules.push(rule)}return rules};return function(a,b){var c=a.replace(/^when\s*/,"").replace(/^\s*|\s*$/g,"");if("{"===utils.findNextToken(c)){var d=utils.getTokensBetween(c,"{","}",!0).join("");return c=c.replace(d,""),b.constraints=parseRules(d.replace(/^\{\s*|\}\s*$/g,"")),c}throw new Error("unexpected token : expected : '{' found : '"+utils.findNextToken(c)+"'")}}(),then:function(){return function(a,b){if(b.action)throw new Error("action already defined for rule"+b.name);var c=a.replace(/^then\s*/,"").replace(/^\s*|\s*$/g,"");if("{"===utils.findNextToken(c)){var d=utils.getTokensBetween(c,"{","}",!0).join("");if(c=c.replace(d,""),b.action||(b.action=d.replace(/^\{\s*|\}\s*$/g,"")),!isWhiteSpace(c))throw new Error("Error parsing then block "+a);return c}throw new Error("unexpected token : expected : '{' found : '"+utils.findNextToken(c)+"'")}}()},topLevelTokens={"/":function(a){return a.match(/^\/\*/)?a.replace(/\/\*.*?\*\//,""):a},define:function(a,b){var c=a.replace(/^define\s*/,""),d=c.match(/^([a-zA-Z_$][0-9a-zA-Z_$]*)/);if(d){if(c=c.replace(d[0],"").replace(/^\s*|\s*$/g,""),"{"===utils.findNextToken(c)){d=d[1];var e=utils.getTokensBetween(c,"{","}",!0).join("");return c=c.replace(e,""),b.define.push({name:d,properties:"("+e+")"}),c}throw new Error("unexpected token : expected : '{' found : '"+utils.findNextToken(c)+"'")}throw new Error("missing name")},import:function(a,b,c){if("undefined"!=typeof window)throw new Error("import cannot be used in a browser");var d=a.replace(/^import\s*/,"");if("("===utils.findNextToken(d)){var e=utils.getParamList(d);if(d=d.replace(e,"").replace(/^\s*|\s*$/g,""),";"===utils.findNextToken(d)&&(d=d.replace(/\s*;/,"")),e=e.replace(/[\(|\)]/g,"").split(","),1===e.length){if(e=utils.resolve(b.file||process.cwd(),e[0].replace(/["|']/g,"")),-1===indexOf(b.loaded,e)){var f=b.file;b.file=e,c(fs.readFileSync(e,"utf8"),topLevelTokens,b),b.loaded.push(e),b.file=f}return d}throw new Error("import accepts a single file")}throw new Error("unexpected token : expected : '(' found : '"+utils.findNextToken(d)+"'")},global:function(a,b){var c=a.replace(/^global\s*/,""),d=c.match(/^([a-zA-Z_$][0-9a-zA-Z_$]*\s*)/);if(d){if(c=c.replace(d[0],"").replace(/^\s*|\s*$/g,""),"="===utils.findNextToken(c)){d=d[1].replace(/^\s+|\s+$/g,"");var e=utils.getTokensBetween(c,"=",";",!0).join(""),f=e.substring(1,e.length-1);if(f=f.replace(/^\s+|\s+$/g,""),/^require\(/.test(f)){var g=utils.getParamList(f.replace("require")).replace(/[\(|\)]/g,"").split(",");1===g.length&&(g=g[0].replace(/["|']/g,""),f=["require('",utils.resolve(b.file||process.cwd(),g),"')"].join(""))}return b.scope.push({name:d,body:f}),c=c.replace(e,"")}throw new Error("unexpected token : expected : '=' found : '"+utils.findNextToken(c)+"'")}throw new Error("missing name")},function:function(a,b){var c=a.replace(/^function\s*/,""),d=c.match(/^([a-zA-Z_$][0-9a-zA-Z_$]*)\s*/);if(d){if(c=c.replace(d[0],""),"("===utils.findNextToken(c)){d=d[1];var e=utils.getParamList(c);if(c=c.replace(e,"").replace(/^\s*|\s*$/g,""),"{"===utils.findNextToken(c)){var f=utils.getTokensBetween(c,"{","}",!0).join("");return c=c.replace(f,""),b.scope.push({name:d,body:"function"+e+f}),c}throw new Error("unexpected token : expected : '{' found : '"+utils.findNextToken(c)+"'")}throw new Error("unexpected token : expected : '(' found : '"+utils.findNextToken(c)+"'")}throw new Error("missing name")},rule:function(a,b,c){var d=a.replace(/^rule\s*/,""),e=d.match(/^([a-zA-Z_$][0-9a-zA-Z_$]*|"[^"]*"|'[^']*')/);if(e){if(d=d.replace(e[0],"").replace(/^\s*|\s*$/g,""),"{"===utils.findNextToken(d)){e=e[1].replace(/^["']|["']$/g,"");var f={name:e,options:{},constraints:null,action:null},g=utils.getTokensBetween(d,"{","}",!0).join("");return d=d.replace(g,""),c(g.replace(/^\{\s*|\}\s*$/g,""),ruleTokens,f),b.rules.push(f),d}throw new Error("unexpected token : expected : '{' found : '"+utils.findNextToken(d)+"'")}throw new Error("missing name")}};module.exports=topLevelTokens},{"../../extended":12,"./util.js":47,__browserify_process:64,fs:61}],47:[function(a,b,c){var d=a("__browserify_process"),e=a("path"),f=/[\s|\n|\r|\t]/,g=e.sep||("win32"===d.platform?"\\":"/"),h={"{":"}","}":"{","(":")",")":"(","[":"]"},i=c.getTokensBetween=function(a,b,c,d){var e=0,f=[];b||(b=h[c],e=1),c||(c=h[b]),a=Object(a);for(var g,i=!1,j=0,k=!1;g=a.charAt(j++);)if(g===b)e++,i?f.push(g):(i=!0,d&&f.push(g));else if(g===c&&j){if(0===--e){d&&f.push(g),k=!0;break}f.push(g)}else i&&f.push(g);if(!k)throw new Error("Unable to match "+b+" in "+a);return f};c.getParamList=function(a){return i(a,"(",")",!0).join("")},c.resolve=function(a,b){return"win32"===d.platform&&(b=b.replace(/\//g,"\\")),""!==e.extname(a)&&(a=e.dirname(a)),1===b.split(g).length?b:e.resolve(a,b).replace(/\\/g,"/")};var j=c.findNextTokenIndex=function(a,b,c){b=b||0,c=c||a.length;var d=-1,e=a.length;for((!c||c>e)&&(c=e);b<c;b++){var g=a.charAt(b);if(!f.test(g)){d=b;break}}return d};c.findNextToken=function(a,b,c){return a.charAt(j(a,b,c))}},{__browserify_process:64,path:62}],48:[function(a,b,c){"use strict";var d=a("./extended"),e=d.isEmpty,f=d.merge,g=d.forEach,h=d.declare,i=a("./constraintMatcher"),j=a("./constraint"),k=j.EqualityConstraint,l=j.FromConstraint,m=0,n=h({}),o=n.extend({instance:{constructor:function(a,b,c,d,h){h=h||{},this.id=m++,this.type=a,this.alias=b,this.conditions=c,this.pattern=h.pattern;var k=[new j.ObjectConstraint(a)],l=i.toConstraints(c,f({alias:b},h));if(l.length)k=k.concat(l);else{var n=new j.TrueConstraint;k.push(n)}if(d&&!e(d)){var o=new j.HashConstraint(d);k.push(o)}g(k,function(a){a.set("alias",b)}),this.constraints=k},getSpecificity:function(){for(var a=this.constraints,b=0,c=0,d=a.length;c<d;c++)a[c]instanceof k&&b++;return b},hasConstraint:function(a){return d.some(this.constraints,function(b){return b instanceof a})},hashCode:function(){return[this.type,this.alias,d.format("%j",this.conditions)].join(":")},toString:function(){return d.format("%j",this.constraints)}}}).as(c,"ObjectPattern"),p=o.extend({instance:{constructor:function(a,b,c,d,e,f){this._super([a,b,c,d,f]),this.from=new l(e,f)},hasConstraint:function(a){return d.some(this.constraints,function(b){return b instanceof a})},getSpecificity:function(){return this._super(arguments)+1},hashCode:function(){return[this.type,this.alias,d.format("%j",this.conditions),this.from.from].join(":")},toString:function(){return d.format("%j from %s",this.constraints,this.from.from)}}}).as(c,"FromPattern");p.extend().as(c,"FromNotPattern"),o.extend().as(c,"NotPattern"),o.extend().as(c,"ExistsPattern"),p.extend().as(c,"FromExistsPattern"),n.extend({instance:{constructor:function(a,b){this.id=m++,this.leftPattern=a,this.rightPattern=b},hashCode:function(){return[this.leftPattern.hashCode(),this.rightPattern.hashCode()].join(":")},getSpecificity:function(){return this.rightPattern.getSpecificity()+this.leftPattern.getSpecificity()},getters:{constraints:function(){return this.leftPattern.constraints.concat(this.rightPattern.constraints)}}}}).as(c,"CompositePattern");var q=h({instance:{constructor:function(){this.id=m++,this.recency=0}}}).as(c,"InitialFact");o.extend({instance:{constructor:function(){this._super([q,"__i__",[],{}])},assert:function(){return!0}}}).as(c,"InitialFactPattern")},{"./constraint":8,"./constraintMatcher":9,"./extended":12}],49:[function(a,b,c){"use strict";function d(a,b,c,d){f(b)?(d=c,c=b):b=b||{};var g=e.every(c,function(a){return f(a)});g&&1===c.length&&(c=c[0],g=!1);var h=[],i=b.scope||{};if(c.scope=i,g){for(var j,k=function(a,b){m[b]?e(m).forEach(function(b){b.push(a)}):(m[b]=0===b?[]:m[b-1].slice(),0!==b&&m[b].pop(),m[b].push(a))},l=c.length,m=[],n=0;n<l;n++)j=c[n],j.scope=i,e.forEach(y(j),k);h=e.map(m,function(c){for(var e=null,f=0;f<c.length;f++)e=null===e?new t(c[f++],c[f]):new t(e,c[f]);return new z(a,b,e,d)})}else h=e.map(y(c),function(c){return new z(a,b,c,d)});return h}var e=a("./extended"),f=e.isArray,g=e.Promise,h=e.declare,i=e.isHash,j=e.isString,k=e.format,l=a("./parser"),m=a("./pattern"),n=m.ObjectPattern,o=m.FromPattern,p=m.NotPattern,q=m.ExistsPattern,r=m.FromNotPattern,s=m.FromExistsPattern,t=m.CompositePattern,u=function(a){return"function"==typeof a?a:l.parseConstraint(a)},v=e.switcher().isUndefinedOrNull(function(){return null}).isLike(/^from +/,function(a){return{from:a.replace(/^from +/,"").replace(/^\s*|\s*$/g,"")}}).def(function(a){throw new Error("invalid rule constraint option "+a)}).switcher(),w=e.switcher().isLength(1,function(a){throw new Error("invalid rule constraint "+k("%j",[a]))}).isLength(2,function(a){return a.push("true"),a}).isLength(3,function(a){if(j(a[2])&&/^from +/.test(a[2])){var b=a[2];a.splice(2,0,"true"),a[3]=null,a[4]=v(b)}else i(a[2])&&a.splice(2,0,"true");return a}).isLength(4,function(a){return j(a[3])&&(a.splice(3,0,null),a[4]=v(a[4])),a}).def(function(a){return 5===a.length&&(a[4]=v(a[4])),a}).switcher(),x=function(a,b){b=b||{};var c=e.switcher().isEq("string",function(){return String}).isEq("date",function(){return Date}).isEq("array",function(){return Array}).isEq("boolean",function(){return Boolean}).isEq("regexp",function(){return RegExp}).isEq("number",function(){return Number}).isEq("object",function(){return Object}).isEq("hash",function(){return Object}).def(function(a){throw new TypeError("invalid param type "+a)}).switcher();return e.switcher().isString(function(a){var d=b[a];return d||c(a.toLowerCase())}).isFunction(function(a){return a}).deepEqual([],function(){return Array}).def(function(a){throw new Error("invalid param type "+a)}).switcher()(a)},y=e.switcher().containsAt("or",0,function(a){return a.shift(),e(a).map(function(b){return b.scope=a.scope,y(b)}).flatten().value()}).containsAt("not",0,function(a){return a.shift(),a=w(a),a[4]&&a[4].from?[new r(x(a[0],a.scope),a[1]||"m",u(a[2]||"true"),a[3]||{},u(a[4].from),{scope:a.scope,pattern:a[2]})]:[new p(x(a[0],a.scope),a[1]||"m",u(a[2]||"true"),a[3]||{},{scope:a.scope,pattern:a[2]})]}).containsAt("exists",0,function(a){return a.shift(),a=w(a),a[4]&&a[4].from?[new s(x(a[0],a.scope),a[1]||"m",u(a[2]||"true"),a[3]||{},u(a[4].from),{scope:a.scope,pattern:a[2]})]:[new q(x(a[0],a.scope),a[1]||"m",u(a[2]||"true"),a[3]||{},{scope:a.scope,pattern:a[2]})]}).def(function(a){return"function"==typeof a?[a]:(a=w(a),a[4]&&a[4].from?[new o(x(a[0],a.scope),a[1]||"m",u(a[2]||"true"),a[3]||{},u(a[4].from),{scope:a.scope,pattern:a[2]})]:[new n(x(a[0],a.scope),a[1]||"m",u(a[2]||"true"),a[3]||{},{scope:a.scope,pattern:a[2]})])}).switcher(),z=h({instance:{constructor:function(a,b,c,d){this.name=a,this.pattern=c,this.cb=d,b.agendaGroup&&(this.agendaGroup=b.agendaGroup,this.autoFocus=!!e.isBoolean(b.autoFocus)&&b.autoFocus),this.priority=b.priority||b.salience||0},fire:function(a,b){var c=new g,d=this.cb;try{3===d.length?d.call(a,b.factHash,a,c.resolve):c=d.call(a,b.factHash,a)}catch(a){c.errback(a)}return c}}});c.createRule=d},{"./extended":12,"./parser":44,"./pattern":48}],50:[function(a,b,c){"use strict";var d=a("declare.js"),e=a("./linkedList"),f=a("./pattern").InitialFact,g=0,h=d({instance:{constructor:function(a){this.object=a,this.recency=0,this.id=g++},equals:function(a){return a===this.object},hashCode:function(){return this.id}}});d({instance:{constructor:function(){this.recency=0,this.facts=new e},dispose:function(){this.facts.clear()},getFacts:function(){for(var a,b={next:this.facts.head},c=[],d=0;b=b.next;)(a=b.data.object)instanceof f||(c[d++]=a);return c},getFactsByType:function(a){for(var b={next:this.facts.head},c=[],d=0;b=b.next;){var e=b.data.object;e instanceof f||!(e instanceof a||e.constructor===a)||(c[d++]=e)}return c},getFactHandle:function(a){for(var b,c={next:this.facts.head};c=c.next;){var d=c.data;if(d.equals(a))return d}return b||(b=new h(a),b.recency=this.recency++),b},modifyFact:function(a){for(var b={next:this.facts.head};b=b.next;){var c=b.data;if(c.equals(a))return c.recency=this.recency++,c}throw new Error("the fact to modify does not exist")},assertFact:function(a){var b=new h(a);return b.recency=this.recency++,this.facts.push(b),b},retractFact:function(a){for(var b=this.facts,c={next:b.head};c=c.next;){var d=c.data;if(d.equals(a))return b.remove(c),d}throw new Error("the fact to remove does not exist")}}}).as(c,"WorkingMemory")},{"./linkedList":16,"./pattern":48,"declare.js":55}],51:[function(a,b,c){(function(){"use strict";function d(a,b){function c(a,b){var c=-1,d=0,e=a.length,f=[];for(b=b||0,c+=b;++c<e;)f[d++]=a[c];return f}var d=(Array.prototype.slice,b.isArguments);return a.define(d,{toArray:c}).expose({argsToArray:c})}void 0!==c?void 0!==b&&b.exports&&(b.exports=d(a("extended"),a("is-extended"))):"function"==typeof define&&define.amd?define(["extended","is-extended"],function(a,b){return d(a,b)}):this.argumentsExtended=d(this.extended,this.isExtended)}).call(this)},{extended:56,"is-extended":66}],52:[function(a,b,c){(function(){"use strict";function d(a,b,c){function d(a,b){return o(b,function(b,c){return N(c)||(c=[c]),c.unshift(a),b.unshift(c),b},[])}function e(a,b,c){for(var d=[],e=0;e<b.length;e++)d.push([a].concat(y(b,e)).slice(0,c));return d}function f(a,b){var c,d,e=[],f=-1;for(d=a.length;++f<d;)c=a[f],-1!==g(b,c)&&e.push(c);return e}function g(a,b,c){for(var d=(c||0)-1,e=a.length;++d<e;)if(a[d]===b)return d;return-1}function h(a,b,c){if(!N(a))throw new TypeError;var d=Object(a),e=d.length>>>0;if(0===e)return-1;var f=e;arguments.length>2&&(f=Number(arguments[2]),f!==f?f=0:0!==f&&f!==1/0&&f!==-1/0&&(f=(f>0||-1)*P(Q(f))));for(var g=f>=0?R(f,e-1):e-Q(f);g>=0;g--)if(g in d&&d[g]===b)return g;return-1}function i(a,b,c){if(a&&X&&X===a.filter)return a.filter(b,c);if(!N(a)||"function"!=typeof b)throw new TypeError;for(var d=Object(a),e=d.length>>>0,f=[],g=0;g<e;g++)if(g in d){var h=d[g];b.call(c,h,g,d)&&f.push(h)}return f}function j(a,b,c){if(!N(a)||"function"!=typeof b)throw new TypeError;if(a&&T&&T===a.forEach)return a.forEach(b,c),a;for(var d=0,e=a.length;d<e;++d)b.call(c||a,a[d],d,a);return a}function k(a,b,c){if(a&&Y&&Y===a.every)return a.every(b,c);if(!N(a)||"function"!=typeof b)throw new TypeError;for(var d=Object(a),e=d.length>>>0,f=0;f<e;f++)if(f in d&&!b.call(c,d[f],f,d))return!1;return!0}function l(a,b,c){if(a&&Z&&Z===a.some)return a.some(b,c);if(!N(a)||"function"!=typeof b)throw new TypeError;for(var d=Object(a),e=d.length>>>0,f=0;f<e;f++)if(f in d&&b.call(c,d[f],f,d))return!0;return!1}function m(a,b,c){if(a&&U&&U===a.map)return a.map(b,c);if(!N(a)||"function"!=typeof b)throw new TypeError;for(var d=Object(a),e=d.length>>>0,f=[],g=0;g<e;g++)g in d&&f.push(b.call(c,d[g],g,d));return f}function n(a,b,c){var d=arguments.length>2;if(a&&V&&V===a.reduce)return d?a.reduce(b,c):a.reduce(b);if(!N(a)||"function"!=typeof b)throw new TypeError;var e=0,f=a.length>>0;if(arguments.length<3){if(0===f)throw new TypeError("Array length is 0 and no second argument");c=a[0],e=1}else c=arguments[2];for(;e<f;)e in a&&(c=b.call(void 0,c,a[e],e,a)),++e;return c}function o(a,b,c){var d=arguments.length>2;if(a&&W&&W===a.reduceRight)return d?a.reduceRight(b,c):a.reduceRight(b);if(!N(a)||"function"!=typeof b)throw new TypeError;var e=Object(a),f=e.length>>>0;if(0===f&&2===arguments.length)throw new TypeError;var g=f-1;if(arguments.length>=3)c=arguments[2];else for(;;)if(g in a){c=a[g--];break}for(;g>=0;)g in e&&(c=b.call(void 0,c,e[g],g,e)),g--;return c}function p(a){var c=[];if(null!==a){var d=$(arguments);if(1===d.length)if(N(a))c=a;else if(b.isHash(a))for(var e in a)a.hasOwnProperty(e)&&c.push([e,a[e]]);else c.push(a);else j(d,function(a){c=c.concat(p(a))})}return c}function q(a){return a=a||[],a.length?n(a,function(a,b){return a+b}):0}function r(a){if(a=a||[],a.length){var c=q(a);if(b.isNumber(c))return c/a.length;throw new Error("Cannot average an array of non numbers.")}return 0}function s(a,b){return _(a,b)}function t(a,b){return _(a,b)[0]}function u(a,b){return _(a,b)[a.length-1]}function v(a){var b=a,c=J($(arguments,1));return N(a)&&(b=i(a,function(a){return-1===g(c,a)})),b}function w(a){var b,c=[],d=-1,e=0;if(a)for(b=a.length;++d<b;){var f=a[d];-1===g(c,f)&&(c[e++]=f)}return c}function x(a){return w(a)}function y(a,b){var c=a.slice();return"number"!=typeof b&&(b=1),b&&N(a)?(b>0?(c.push(c.shift()),b--):(c.unshift(c.pop()),b++),y(c,b)):c}function z(a,b){var c=[];if(N(a)){var d=a.slice(0);"number"!=typeof b&&(b=a.length),b?b<=a.length&&(c=n(a,function(a,c,f){var g;return g=b>1?e(c,y(d,f).slice(1),b):[[c]],a.concat(g)},[])):c=[[]]}return c}function A(){var a=[],c=$(arguments);if(c.length>1){var d=c.shift();N(d)&&(a=n(d,function(a,d,e){for(var f=[d],g=0;g<c.length;g++){var h=c[g];N(h)&&!b.isUndefined(h[e])?f.push(h[e]):f.push(null)}return a.push(f),a},[]))}return a}function B(a){var b=[];if(N(a)&&a.length){var c;j(a,function(a){!N(a)||c&&a.length!==c.length||(j(a,function(a,c){b[c]||(b[c]=[]),b[c].push(a)}),c=a)})}return b}function C(a,b){var c=[];if(b=$(arguments),a=b.shift(),N(a)&&b.length)for(var d=0,e=b.length;d<e;d++)c.push(a[b[d]]||null);return c}function D(){var a=[],b=$(arguments);if(b.length>1){for(var c=0,d=b.length;c<d;c++)a=a.concat(b[c]);a=w(a)}return a}function E(){var a,b,c=[],d=-1;if(a=arguments.length>1?$(arguments):arguments[0],N(a))for(c=a[0],d=0,b=a.length;++d<b;)c=f(c,a[d]);return w(c)}function F(a){var b=[];return N(a)&&a.length&&(b=n(a,function(a,b){var c=m(a,function(a){return a.concat(b)});return a.concat(c)},[[]])),b}function G(a,b){var c=[];return N(a)&&N(b)&&a.length&&b.length&&(c=d(a[0],b).concat(G(a.slice(1),b))),c}function H(a){var c=[];return N(a)&&a.length&&(c=i(a,function(a){return!b.isUndefinedOrNull(a)})),c}function I(a,c){c=b.isNumber(c)?c:1,c||(c=1),a=p(a||[]);for(var d=[],e=0;++e<=c;)d=d.concat(a);return d}function J(a){var b,c=$(arguments);return b=c.length>1?c:p(a),n(b,function(a,b){return a.concat(b)},[])}function K(a,b){b=b.split(".");var c=a.slice(0);return j(b,function(a){var b=a.match(/(\w+)\(\)$/);c=m(c,function(c){return b?c[b[1]]():c[a]})}),c}function L(a,b,c){return c=$(arguments,2),m(a,function(a){return(M(b)?a[b]:b).apply(a,c)})}var M=b.isString,N=Array.isArray||b.isArray,O=b.isDate,P=Math.floor,Q=Math.abs,R=(Math.max,Math.min),S=Array.prototype,T=(S.indexOf,S.forEach),U=S.map,V=S.reduce,W=S.reduceRight,X=S.filter,Y=S.every,Z=S.some,$=c.argsToArray,_=function(){var a=function(a,b){return k(a,b)},b=function(a,b){return a-b},c=function(a,b){return a.getTime()-b.getTime()};return function(d,e){var f=[];return N(d)&&(f=d.slice(),e?"function"==typeof e?f.sort(e):f.sort(function(a,b){var c=a[e],d=b[e];return M(c)&&M(d)?c>d?1:c<d?-1:0:O(c)&&O(d)?c.getTime()-d.getTime():c-d}):a(f,M)?f.sort():a(f,O)?f.sort(c):f.sort(b)),f}}(),aa={toArray:p,sum:q,avg:r,sort:s,min:t,max:u,difference:v,removeDuplicates:w,unique:x,rotate:y,permutations:z,zip:A,transpose:B,valuesAt:C,union:D,intersect:E,powerSet:F,cartesian:G,compact:H,multiply:I,flatten:J,pluck:K,invoke:L,forEach:j,map:m,filter:i,reduce:n,reduceRight:o,some:l,every:k,indexOf:g,lastIndexOf:h};return a.define(N,aa).expose(aa)}void 0!==c?void 0!==b&&b.exports&&(b.exports=d(a("extended"),a("is-extended"),a("arguments-extended"))):"function"==typeof define&&define.amd?define(["extended","is-extended","arguments-extended"],function(a,b,c){return d(a,b,c)}):this.arrayExtended=d(this.extended,this.isExtended,this.argumentsExtended)}).call(this)},{"arguments-extended":51,extended:56,"is-extended":66}],53:[function(a,b,c){(function(){"use strict";function d(a,b,c){function d(a,b,c,d){a=""+a,c=c||" ";for(var e=a.length;e<b;)d?a+=c:a=c+a,e++;return a}function e(a,c,d){var f=a;if(b.isString(f)){if(a.length>c)if(d){var g=a.length;f=a.substring(g-c,g)}else f=a.substring(0,c)}else f=e(""+f,c);return f}function f(a,c,d){if(!b.isArray(a)||"function"!=typeof c)throw new TypeError;for(var e=Object(a),f=e.length>>>0,g=0;g<f;g++)if(g in e&&!c.call(d,e[g],g,e))return!1;return!0}function g(a,b){return A.difference(new Date(a.getFullYear(),0,1,a.getHours()),a,null,b)+1}function h(a,b,c){b=b||0;var d=a[c?"getUTCFullYear":"getFullYear"](),e=new Date(d,0,1).getDay(),f=(e-b+7)%7,h=o((g(a)+f-1)/7);return e===b&&h++,h}function i(a){var b=a.toString(),c="",d=b.indexOf("(");return d>-1&&(c=b.substring(++d,b.indexOf(")"))),c}function j(a,b){return a.replace(/([a-z])\1*/gi,function(a){var c,d=a.charAt(0),e=a.length,f="0?";if("y"===d)c="\\d{2,4}";else if("M"===d)c=e>2?"\\S+?":"1[0-2]|"+f+"[1-9]";else if("D"===d)c="[12][0-9][0-9]|3[0-5][0-9]|36[0-6]|0{0,2}[1-9][0-9]|"+f+"[1-9]";else if("d"===d)c="3[01]|[12]\\d|"+f+"[1-9]";else if("w"===d)c="[1-4][0-9]|5[0-3]|"+f+"[1-9]";else if("E"===d)c="\\S+";else if("h"===d)c="1[0-2]|"+f+"[1-9]";else if("K"===d)c="1[01]|"+f+"\\d";else if("H"===d)c="1\\d|2[0-3]|"+f+"\\d";else if("k"===d)c="1\\d|2[0-4]|"+f+"[1-9]";else if("m"===d||"s"===d)c="[0-5]\\d";else if("S"===d)c="\\d{"+e+"}";else if("a"===d){var g="AM",h="PM";c=g+"|"+h,g!==g.toLowerCase()&&(c+="|"+g.toLowerCase()),h!==h.toLowerCase()&&(c+="|"+h.toLowerCase()),c=c.replace(/\./g,"\\.")}else c="v"===d||"z"===d||"Z"===d||"G"===d||"q"===d||"Q"===d?".*":" "===d?"\\s*":d+"*";return b&&b.push(a),"("+c+")"}).replace(/[\xa0 ]/g,"[\\s\\xa0]")}function k(a){B[a+"sFromNow"]=function(b){return A.add(new Date,a,b)},B[a+"sAgo"]=function(b){return A.add(new Date,a,-b)}}for(var l=function(){function a(a,b,c){return a=a.replace(/s$/,""),e.hasOwnProperty(a)?e[a](b,c):[c,"UTC"+a.charAt(0).toUpperCase()+a.substring(1)+"s",!1]}function b(a,b,c,e){return a=a.replace(/s$/,""),d(f[a](b,c,e))}var c=Math.floor,d=Math.round,e={day:function(a,b){return[b,"Date",!1]},weekday:function(a,b){var c,d,e=b%5,f=a.getDay(),g=0;e?(c=e,d=parseInt(b/5,10)):(c=b>0?5:-5,d=b>0?(b-5)/5:(b+5)/5),6===f&&b>0?g=1:0===f&&b<0&&(g=-1);var h=f+c;return 0!==h&&6!==h||(g=b>0?2:-2),[7*d+c+g,"Date",!1]},year:function(a,b){return[b,"FullYear",!0]},week:function(a,b){return[7*b,"Date",!1]},quarter:function(a,b){return[3*b,"Month",!0]},month:function(a,b){return[b,"Month",!0]}},f={quarter:function(a,b,d){var e=b.getFullYear()-a.getFullYear(),f=a[d?"getUTCMonth":"getMonth"](),g=b[d?"getUTCMonth":"getMonth"](),h=c(f/3)+1,i=c(g/3)+1;return(i+=4*e)-h},weekday:function(a,c,d){var e,f=b("day",a,c,d),g=f%7;if(0===g)f=5*b("week",a,c,d);else{var h=0,i=a[d?"getUTCDay":"getDay"](),j=c[d?"getUTCDay":"getDay"]();e=parseInt(f/7,10);var k=new Date(+a);k.setDate(k[d?"getUTCDate":"getDate"]()+7*e);var l=k[d?"getUTCDay":"getDay"]();f>0?6===i||6===j?h=-1:0===i?h=0:(0===j||l+g>5)&&(h=-2):f<0&&(6===i?h=0:0===i||0===j?h=1:(6===j||l+g<0)&&(h=2)),f+=h,f-=2*e}return f},year:function(a,b){return b.getFullYear()-a.getFullYear()},month:function(a,b,c){var d=a[c?"getUTCMonth":"getMonth"]();return b[c?"getUTCMonth":"getMonth"]()-d+12*(b.getFullYear()-a.getFullYear())},week:function(a,c,e){return d(b("day",a,c,e)/7)},day:function(a,b){return 1.1574074074074074e-8*(b.getTime()-a.getTime())},hour:function(a,b){return 2.7777777777777776e-7*(b.getTime()-a.getTime())},minute:function(a,b){return 16666666666666667e-21*(b.getTime()-a.getTime())},second:function(a,b){return.001*(b.getTime()-a.getTime())},millisecond:function(a,b){return b.getTime()-a.getTime()}};return{addTransform:a,differenceTransform:b}}(),m=l.addTransform,n=l.differenceTransform,o=Math.floor,p=Math.round,q=Math.min,r=Math.pow,s=Math.ceil,t=Math.abs,u=["January","February","March","April","May","June","July","August","September","October","November","December"],v=["Jan.","Feb.","Mar.","Apr.","May.","Jun.","Jul.","Aug.","Sep.","Oct.","Nov.","Dec."],w=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],x=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],y=["Before Christ","Anno Domini"],z=["BC","AD"],A={getDaysInMonth:function(a){var b=a.getMonth(),c=[31,28,31,30,31,30,31,31,30,31,30,31];return 1===b&&A.isLeapYear(a)?29:c[b]},isLeapYear:function(a,b){var c=a[b?"getUTCFullYear":"getFullYear"]();return c%400==0||c%4==0&&c%100!=0},isWeekend:function(a,b){var c=(a||new Date)[b?"getUTCDay":"getDay"]();return 0===c||6===c},getTimezoneName:i,compare:function(a,b,c){return a=new Date(+a),b=new Date(+(b||new Date)),"date"===c?(a.setHours(0,0,0,0),b.setHours(0,0,0,0)):"time"===c&&(a.setFullYear(0,0,0),b.setFullYear(0,0,0)),a>b?1:a<b?-1:0},add:function(a,b,c){var d=m(b,a,c||0);c=d[0];var e=d[1],f=new Date(+a),g=d[2];return e&&f["set"+e](f["get"+e]()+c),g&&f.getDate()<a.getDate()&&f.setDate(0),f},difference:function(a,b,c,d){return b=b||new Date,c=c||"day",n(c,a,b,d)},format:function(a,b,c){c=c||!1;var f,j,k,l,m,n,q,A;return c?(f=a.getUTCFullYear(),j=a.getUTCMonth(),k=a.getUTCDay(),l=a.getUTCDate(),m=a.getUTCHours(),n=a.getUTCMinutes(),q=a.getUTCSeconds(),A=a.getUTCMilliseconds()):(f=a.getFullYear(),j=a.getMonth(),l=a.getDate(),k=a.getDay(),m=a.getHours(),n=a.getMinutes(),q=a.getSeconds(),A=a.getMilliseconds()),b.replace(/([A-Za-z])\1*/g,function(b){var B,C,D=b.charAt(0),E=b.length;if("d"===D)B=""+l,C=!0;else if("H"!==D||B)if("m"!==D||B)if("s"===D)B||(B=""+q),C=!0;else if("G"===D)B=(E<4?z:y)[f<0?0:1];else if("y"===D)B=f,E>1&&(2===E?B=e(""+B,2,!0):C=!0);else if("Q"===D.toUpperCase())B=s((j+1)/3),C=!0;else if("M"===D)E<3?(B=j+1,C=!0):B=(3===E?v:u)[j];else if("w"===D)B=h(a,0,c),C=!0;else if("D"===D)B=g(a,c),C=!0;else if("E"===D)E<3?(B=k+1,C=!0):B=(-3===E?x:w)[k];else if("a"===D)B=m<12?"AM":"PM";else if("h"===D)B=m%12||12,C=!0;else if("K"===D)B=m%12,C=!0;else if("k"===D)B=m||24,C=!0;else if("S"===D)B=p(A*r(10,E-3)),C=!0;else if("z"===D||"v"===D||"Z"===D){if(B=i(a),"z"!==D&&"v"!==D||B||(E=4),!B||"Z"===D){var F=a.getTimezoneOffset(),G=[F>=0?"-":"+",d(o(t(F)/60),2,"0"),d(t(F)%60,2,"0")];4===E&&(G.splice(0,0,"GMT"),G.splice(3,0,":")),B=G.join("")}}else B=b;else B=""+n,C=!0;else B=""+m,C=!0;return C&&(B=d(B,E,"0")),B})}},B={},C=["year","month","day","hour","minute","second"],D=0,E=C.length;D<E;D++)k(C[D]);var F={parseDate:function(a,b){if(!b)throw new Error("format required when calling dateExtender.parse");var d=[],e=j(b,d),g=new RegExp("^"+e+"$","i"),h=g.exec(a);if(!h)return null;var i=[1970,0,1,0,0,0,0],k="";if(f(h,function(a,b){if(b){var e=d[b-1],f=e.length,g=e.charAt(0);if("y"===g)if(a<100){a=parseInt(a,10);var h=""+(new Date).getFullYear(),j=100*h.substring(0,2),l=q(h.substring(2,4)+20,99);i[0]=a<l?j+a:j-100+a}else i[0]=a;else if("M"===g){if(f>2){var m,n,o=u;3===f&&(o=v),a=a.replace(".","").toLowerCase();var p=!1;for(m=0,n=o.length;m<n&&!p;m++){var r=o[m].replace(".","").toLocaleLowerCase();r===a&&(a=m,p=!0)}if(!p)return!1}else a--;i[1]=a}else if("E"===g||"e"===g){var s=w;3===f&&(s=x),a=a.toLowerCase(),s=c.map(s,function(a){return a.toLowerCase()});var t=c.indexOf(s,a);if(-1===t){if(a=parseInt(a,10),isNaN(a)||a>s.length)return!1}else a=t}else if("D"===g||"d"===g)"D"===g&&(i[1]=0),i[2]=a;else if("a"===g){var y="am",z="pm",A=/\./g;a=a.replace(A,"").toLowerCase(),k=a===z?"p":a===y?"a":""}else"k"===g||"h"===g||"H"===g||"K"===g?("k"===g&&24==+a&&(a=0),i[3]=a):"m"===g?i[4]=a:"s"===g?i[5]=a:"S"===g&&(i[6]=a)}return!0})){var l=+i[3];"p"===k&&l<12?i[3]=l+12:"a"===k&&12===l&&(i[3]=0);var m=new Date(i[0],i[1],i[2],i[3],i[4],i[5],i[6]),n=-1!==c.indexOf(d,"d"),o=-1!==c.indexOf(d,"M"),p=i[1],r=i[2],s=m.getMonth(),t=m.getDate();return o&&s>p||n&&t>r?null:m}return null}},G=a.define(b.isDate,A).define(b.isString,F).define(b.isNumber,B);for(D in A)A.hasOwnProperty(D)&&(G[D]=A[D]);for(D in F)F.hasOwnProperty(D)&&(G[D]=F[D]);for(D in B)B.hasOwnProperty(D)&&(G[D]=B[D]);return G}void 0!==c?void 0!==b&&b.exports&&(b.exports=d(a("extended"),a("is-extended"),a("array-extended"))):"function"==typeof define&&define.amd?define(["extended","is-extended","array-extended"],function(a,b,c){return d(a,b,c)}):this.dateExtended=d(this.extended,this.isExtended,this.arrayExtended)}).call(this)},{"array-extended":52,extended:56,"is-extended":66}],54:[function(a,b,c){!function(){function a(){function a(a,b){return b=b||0,x.call(a,b)}function b(a){return"[object Array]"===Object.prototype.toString.call(a)}function c(a){var b;return null!==a&&a!==b&&"object"==typeof a}function d(a){return c(a)&&a.constructor===Object}function e(a,b){if(a&&a.length)for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return c;return-1}function f(a,b,c){var d,f;for(d in b)b.hasOwnProperty(d)&&-1===e(c,d)&&(f=b[d],d in a&&a[d]===f||(a[d]=f));return a}function g(a,c){var d=this.__meta,e=d.supers,f=e.length,g=d.superMeta,h=g.pos;if(f>h){a=a?B(a)||b(a)?a:[a]:[];var i,j=g.name,k=g.f;do{if("function"==typeof(i=e[h][j])&&(i=i._f||i)!==k)return g.pos=1+h,i.apply(this,a)}while(f>++h)}return null}function h(){var a=this.__meta,b=a.supers,c=b.length,d=a.superMeta,e=d.pos;if(c>e){var f,g=d.name,h=d.f;do{if("function"==typeof(f=b[e][g])&&(f=f._f||f)!==h)return d.pos=1+e,f.bind(this)}while(c>++e)}return null}function i(a){var b=this.__getters__;return b.hasOwnProperty(a)?b[a].apply(this):this[a]}function j(b,c){var e=this.__setters__;if(!d(b))return e.hasOwnProperty(b)?e[b].apply(this,a(arguments,1)):this[b]=c;for(var f in b){var g=b[f];e.hasOwnProperty(f)?e[b].call(this,g):this[f]=g}}function k(){var a=this.__meta||{},b=a.supers,c=b.length,d=a.superMeta,e=d.pos;if(c>e){var f,g=d.name,h=d.f;do{if("function"==typeof(f=b[e][g])&&(f=f._f||f)!==h)return d.pos=1+e,f.apply(this,arguments)}while(c>++e)}return null}function l(a,b){if(a.toString().match(A)){var c=function(){var c,d=this.__meta||{},e=d.superMeta;switch(d.superMeta={f:a,pos:0,name:b},arguments.length){case 0:c=a.call(this);break;case 1:c=a.call(this,arguments[0]);break;case 2:c=a.call(this,arguments[0],arguments[1]);break;case 3:c=a.call(this,arguments[0],arguments[1],arguments[2]);break;default:c=a.apply(this,arguments)}return d.superMeta=e,c};return c._f=a,c}return a._f=a,a}function m(a,b){var c=b.setters||{},d=a.__setters__,e=a.__getters__;for(var f in c)d.hasOwnProperty(f)||(d[f]=c[f]);c=b.getters||{};for(f in c)e.hasOwnProperty(f)||(e[f]=c[f]);for(var g in b)if("getters"!==g&&"setters"!==g){var h=b[g];"function"==typeof h?a.hasOwnProperty(g)||(a[g]=l(k,g)):a[g]=h}}function n(){for(var b=a(arguments),c=b.length,d=this.prototype,e=d.__meta,f=this.__meta,g=d.__meta.bases,h=g.slice(),i=f.supers||[],j=e.supers||[],k=0;k<c;k++){var l=b[k],n=l.prototype,p=n.__meta,q=l.__meta;!p&&(p=n.__meta={proto:n||{}}),!q&&(q=l.__meta={proto:l.__proto__||{}}),m(d,p.proto||{}),m(this,q.proto||{}),o(l.prototype,j,g),o(l,i,h)}return this}function o(a,b,c){var d=a.__meta;!d&&(d=a.__meta={});var f=a.__meta.unique;if(!f&&(d.unique="declare"+ ++y),-1===e(c,f)){c.push(f);for(var g=a.__meta.supers||[],h=g.length-1||0;h>=0;)o(g[h--],b,c);b.unshift(a)}}function p(a,b){var c=b.setters,d=a.__setters__,e=a.__getters__;if(c)for(var f in c)d[f]=c[f];if(c=b.getters||{})for(f in c)e[f]=c[f];for(f in b)if("getters"!=f&&"setters"!=f){var g=b[f];if("function"==typeof g){var h=g.__meta||{};h.isConstructor?a[f]=g:a[f]=l(g,f)}else a[f]=g}}function q(a,b){return a&&b?a[b]=this:a.exports=a=this,this}function r(a){return u(this,a)}function s(a){z.prototype=a.prototype;var b=new z;return z.prototype=null,b}function t(a,c,e){var i={},j=[],m="declare"+ ++y,q=[],r=[],t=[],u=[],v={supers:t,unique:m,bases:q,superMeta:{f:null,pos:0,name:null}},x={supers:u,unique:m,bases:r,isConstructor:!0,superMeta:{f:null,pos:0,name:null}};if(d(c)&&!e&&(e=c,c=w),"function"==typeof c||b(c)?(j=b(c)?c:[c],c=j.shift(),a.__meta=x,i=s(c),i.__meta=v,i.__getters__=f({},i.__getters__||{}),i.__setters__=f({},i.__setters__||{}),a.__getters__=f({},a.__getters__||{}),a.__setters__=f({},a.__setters__||{}),o(c.prototype,t,q),o(c,u,r)):(a.__meta=x,i.__meta=v,i.__getters__=i.__getters__||{},i.__setters__=i.__setters__||{},a.__getters__=a.__getters__||{},a.__setters__=a.__setters__||{}),a.prototype=i,e){var z=v.proto=e.instance||{},A=x.proto=e.static||{};A.init=A.init||k,p(i,z),p(a,A),z.hasOwnProperty("constructor")?i.constructor=l(z.constructor,"constructor"):i.constructor=z.constructor=l(k,"constructor")}else v.proto={},x.proto={},a.init=l(k,"init"),i.constructor=l(k,"constructor");j.length&&n.apply(a,j),c&&f(a,f(f({},c),a)),i._super=a._super=g,i._getSuper=a._getSuper=h,i._static=a}function u(a,b){function c(){switch(arguments.length){case 0:this.constructor.call(this);break;case 1:this.constructor.call(this,arguments[0]);break;case 2:this.constructor.call(this,arguments[0],arguments[1]);break;case 3:this.constructor.call(this,arguments[0],arguments[1],arguments[2]);break;default:this.constructor.apply(this,arguments)}}return t(c,a,b),c.init()||c}function v(a,b){function c(){return d||(this.constructor.apply(this,arguments),d=this),d}var d;return t(c,a,b),c.init()||c}var w,x=Array.prototype.slice,y=0,z=new Function,A=/(super)/g,B=function(a){return"[object Arguments]"===Object.prototype.toString.call(a)};return B(arguments)||(B=function(a){return!(!a||!a.hasOwnProperty("callee"))}),w=u({instance:{get:i,set:j},static:{get:i,set:j,mixin:n,extend:r,as:q}}),u.singleton=v,u}void 0!==c?void 0!==b&&b.exports&&(b.exports=a()):"function"==typeof define&&define.amd?define(a):this.declare=a()}()},{}],55:[function(a,b,c){b.exports=a("./declare.js")},{"./declare.js":54}],56:[function(a,b,c){(function(){"use strict";function d(a){function b(){var b=a.define();return b.expose({register:function(a,c){c||(c=a,a=null);var d=typeof c;if(a)b[a]=c;else if(c&&"function"===d)b.extend(c);else{if("object"!==d)throw new TypeError("extended.register must be called with an extender function");b.expose(c)}return b},define:function(){return a.define.apply(a,arguments)}}),b}function c(){return b()}!function(){function a(a,b){var c,d;for(c in b)b.hasOwnProperty(c)&&(d=b[c],c in a&&a[c]===d||(a[c]=d));return a}}();return c.define=function(){return a.define.apply(a,arguments)},c}void 0!==c?void 0!==b&&b.exports&&(b.exports=d(a("extender"))):"function"==typeof define&&define.amd?define(["extender"],function(a){return d(a)}):this.extended=d(this.extender)}).call(this)},{extender:58}],57:[function(a,b,c){(function(){function d(a){function b(a,b){if(a&&a.length)for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return c;return-1}function c(a){return"[object Array]"===Object.prototype.toString.call(a)}function d(b){function c(a,b,c){if("function"!=typeof c)throw new TypeError("when extending type you must provide a function");var d;d="constructor"===b?function(){this._super(arguments),c.apply(this,arguments)}:function(){var a=f.call(arguments);a.unshift(this._value);var b=c.apply(this,a);return b!==e?this.__extender__(b):this},a[b]=d}function d(a,b,c){if("function"!=typeof c)throw new TypeError("when extending type you must provide a function");var d;d="constructor"===b?function(){this._super(arguments),c.apply(this,arguments)}:function(){var a=f.call(arguments);return a.unshift(this._value),c.apply(this,a)},a[b]=d}function h(a,b,e){for(var f in b)b.hasOwnProperty(f)&&("getters"!==f&&"setters"!==f?"noWrap"===f?h(a,b[f],!0):e?d(a,f,b[f]):c(a,f,b[f]):a[f]=b[f])}function i(a){var b,c,d=a;if(!(a instanceof m)){var e=m;for(b=0,c=n.length;b<c;b++){var f=n[b];f[0](a)&&(e=e.extend({instance:f[1]}))}d=new e(a),d.__extender__=i}return d}function j(){return!0}function k(a,b){if(arguments.length){"object"==typeof a&&(b=a,a=j),b=b||{};var d={};h(d,b),d.hasOwnProperty("constructor")||(b.hasOwnProperty("constructor")?c(d,"constructor",b.constructor):d.constructor=function(){this._super(arguments)}),n.push([a,d])}return i}function l(a){return a&&a.hasOwnProperty("__defined__")&&(i.__defined__=n=n.concat(a.__defined__)),g(i,a,["define","extend","expose","__defined__"]),i}b=b||[];var m=a({instance:{constructor:function(a){this._value=a},value:function(){return this._value},eq:function(a){return this.__extender__(this._value===a)},neq:function(a){return this.__extender__(this._value!==a)},print:function(){return console.log(this._value),this}}}),n=[];return i.define=k,i.extend=l,i.expose=function(){for(var a,b=0,c=arguments.length;b<c;b++)"object"==typeof(a=arguments[b])&&g(i,a,["define","extend","expose","__defined__"]);return i},i.__defined__=n,i}var e,f=Array.prototype.slice,g=function(){function a(a,c,d){var e,f;for(e in c)c.hasOwnProperty(e)&&-1===b(d,e)&&(f=c[e],e in a&&a[e]===f||(a[e]=f));return a}return function(b){b||(b={});var d=arguments.length,e=arguments[arguments.length-1];c(e)?d--:e=[];for(var f=1;f<d;f++)a(b,arguments[f],e);return b}}();return{define:function(){return d().define.apply(d,arguments)},extend:function(a){return d().define().extend(a)}}}void 0!==c?void 0!==b&&b.exports&&(b.exports=d(a("declare.js"))):"function"==typeof define&&define.amd?define(["declare"],function(a){return d(a)}):this.extender=d(this.declare)}).call(this)},{"declare.js":55}],58:[function(a,b,c){b.exports=a("./extender.js")},{"./extender.js":57}],59:[function(a,b,c){(function(){"use strict";function d(a,b,c){function d(a,b,c){var d;switch((b||[]).length){case 0:d=a.call(c);break;case 1:d=a.call(c,b[0]);break;case 2:d=a.call(c,b[0],b[1]);break;case 3:d=a.call(c,b[0],b[1],b[2]);break;default:d=a.apply(c,b)}return d}function e(a,b,c){if(c=p(arguments,2),n(b)&&!(b in a))throw new Error(b+" property not defined in scope");if(!n(b)&&!o(b))throw new Error(b+" is not a function");return n(b)?function(){var e=a[b];return o(e)?d(e,c.concat(p(arguments)),a):e}:c.length?function(){return d(b,c.concat(p(arguments)),a)}:function(){return d(b,arguments,a)}}function f(a,b){if(b=p(arguments,1),!n(a)&&!o(a))throw new Error(a+" must be the name of a property or function to execute");return n(a)?function(){var c=p(arguments),e=c.shift(),f=e[a];return o(f)?(c=b.concat(c),d(f,c,e)):f}:function(){var c=p(arguments),e=c.shift();return c=b.concat(c),d(a,c,e)}}function g(a,b,c){if(c=p(arguments,2),n(b)&&!(b in a))throw new Error(b+" property not defined in scope");if(!n(b)&&!o(b))throw new Error(b+" is not a function");return n(b)?function(){var e=a[b];return o(e)?d(e,c,a):e}:function(){return d(b,c,a)}}function h(a){var b=p(arguments,1);if(!m(a)&&!o(a))throw new TypeError("scope must be an object");if(1===b.length&&l(b[0])&&(b=b[0]),!b.length){b=[];for(var c in a)a.hasOwnProperty(c)&&o(a[c])&&b.push(c)}for(var d=0,f=b.length;d<f;d++)a[b[d]]=e(a,a[b[d]]);return a}function i(a,b){if(b=p(arguments,1),!n(a)&&!o(a))throw new Error(a+" must be the name of a property or function to execute");return n(a)?function(){var c=this[a];if(o(c)){return d(c,b.concat(p(arguments)),this)}return c}:function(){var c=b.concat(p(arguments));return d(a,c,this)}}function j(a,b){return function(){var c=p(arguments);return b?d(a,arguments,this):function(){return d(a,c.concat(p(arguments)),this)}}}function k(a,b,c){var d;if(d=c?e(c,b):b,a)for(var f=a-1,g=f;g>=0;g--)d=j(d,g===f);return d}var l=b.isArray,m=b.isObject,n=b.isString,o=b.isFunction,p=c.argsToArray;return a.define(m,{bind:e,bindAll:h,bindIgnore:g,curry:function(a,b,c){return k(b,c,a)}}).define(o,{bind:function(a,b){return d(e,[b,a].concat(p(arguments,2)),this)},bindIgnore:function(a,b){return d(g,[b,a].concat(p(arguments,2)),this)},partial:i,applyFirst:f,curry:function(a,b,c){return k(b,a,c)},noWrap:{f:function(){return this.value()}}}).define(n,{bind:function(a,b){return e(b,a)},bindIgnore:function(a,b){return g(b,a)},partial:i,applyFirst:f,curry:function(a,b,c){return k(b,a,c)}}).expose({bind:e,bindAll:h,bindIgnore:g,partial:i,applyFirst:f,curry:k})}void 0!==c?void 0!==b&&b.exports&&(b.exports=d(a("extended"),a("is-extended"),a("arguments-extended"))):"function"==typeof define&&define.amd?define(["extended","is-extended","arguments-extended"],function(a,b,c){return d(a,b,c)}):this.functionExtended=d(this.extended,this.isExtended,this.argumentsExtended)}).call(this)},{"arguments-extended":51,extended:56,"is-extended":66}],60:[function(a,b,c){function d(a,b){if(a.indexOf)return a.indexOf(b);for(var c=0;c<a.length;c++)if(b===a[c])return c;return-1}var e=a("__browserify_process");e.EventEmitter||(e.EventEmitter=function(){});var f=c.EventEmitter=e.EventEmitter,g="function"==typeof Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};f.prototype.setMaxListeners=function(a){this._events||(this._events={}),this._events.maxListeners=a},f.prototype.emit=function(a){if("error"===a&&(!this._events||!this._events.error||g(this._events.error)&&!this._events.error.length))throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");if(!this._events)return!1;var b=this._events[a];if(!b)return!1;if("function"==typeof b){switch(arguments.length){case 1:b.call(this);break;case 2:b.call(this,arguments[1]);break;case 3:b.call(this,arguments[1],arguments[2]);break;default:var c=Array.prototype.slice.call(arguments,1);b.apply(this,c)}return!0}if(g(b)){for(var c=Array.prototype.slice.call(arguments,1),d=b.slice(),e=0,f=d.length;e<f;e++)d[e].apply(this,c);return!0}return!1},f.prototype.addListener=function(a,b){if("function"!=typeof b)throw new Error("addListener only takes instances of Function");if(this._events||(this._events={}),this.emit("newListener",a,b),this._events[a])if(g(this._events[a])){if(!this._events[a].warned){var c;(c=void 0!==this._events.maxListeners?this._events.maxListeners:10)&&c>0&&this._events[a].length>c&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),console.trace())}this._events[a].push(b)}else this._events[a]=[this._events[a],b];else this._events[a]=b;return this},f.prototype.on=f.prototype.addListener,f.prototype.once=function(a,b){var c=this;return c.on(a,function d(){c.removeListener(a,d),b.apply(this,arguments)}),this},f.prototype.removeListener=function(a,b){if("function"!=typeof b)throw new Error("removeListener only takes instances of Function");if(!this._events||!this._events[a])return this;var c=this._events[a];if(g(c)){var e=d(c,b);if(e<0)return this;c.splice(e,1),0==c.length&&delete this._events[a]}else this._events[a]===b&&delete this._events[a];return this},f.prototype.removeAllListeners=function(a){return 0===arguments.length?(this._events={},this):(a&&this._events&&this._events[a]&&(this._events[a]=null),this)},f.prototype.listeners=function(a){return this._events||(this._events={}),this._events[a]||(this._events[a]=[]),g(this._events[a])||(this._events[a]=[this._events[a]]),this._events[a]},f.listenerCount=function(a,b){return a._events&&a._events[b]?"function"==typeof a._events[b]?1:a._events[b].length:0}},{__browserify_process:64}],61:[function(a,b,c){},{}],62:[function(a,b,c){function d(a,b){for(var c=[],d=0;d<a.length;d++)b(a[d],d,a)&&c.push(a[d]);return c}function e(a,b){for(var c=0,d=a.length;d>=0;d--){var e=a[d];"."==e?a.splice(d,1):".."===e?(a.splice(d,1),c++):c&&(a.splice(d,1),c--)}if(b)for(;c--;c)a.unshift("..");return a}var f=a("__browserify_process"),g=/^(.+\/(?!$)|\/)?((?:.+?)?(\.[^.]*)?)$/;c.resolve=function(){for(var a="",b=!1,c=arguments.length;c>=-1&&!b;c--){var g=c>=0?arguments[c]:f.cwd();"string"==typeof g&&g&&(a=g+"/"+a,b="/"===g.charAt(0))}return a=e(d(a.split("/"),function(a){return!!a}),!b).join("/"),(b?"/":"")+a||"."},c.normalize=function(a){var b="/"===a.charAt(0),c="/"===a.slice(-1);return a=e(d(a.split("/"),function(a){return!!a}),!b).join("/"),a||b||(a="."),a&&c&&(a+="/"),(b?"/":"")+a},c.join=function(){var a=Array.prototype.slice.call(arguments,0);return c.normalize(d(a,function(a,b){return a&&"string"==typeof a}).join("/"))},c.dirname=function(a){var b=g.exec(a)[1]||"";return b?1===b.length?b:b.substring(0,b.length-1):"."},c.basename=function(a,b){var c=g.exec(a)[2]||"";return b&&c.substr(-1*b.length)===b&&(c=c.substr(0,c.length-b.length)),c},c.extname=function(a){return g.exec(a)[3]||""},c.relative=function(a,b){function d(a){for(var b=0;b<a.length&&""===a[b];b++);for(var c=a.length-1;c>=0&&""===a[c];c--);return b>c?[]:a.slice(b,c-b+1)}a=c.resolve(a).substr(1),b=c.resolve(b).substr(1);for(var e=d(a.split("/")),f=d(b.split("/")),g=Math.min(e.length,f.length),h=g,i=0;i<g;i++)if(e[i]!==f[i]){h=i;break}for(var j=[],i=h;i<e.length;i++)j.push("..");return j=j.concat(f.slice(h)),j.join("/")},c.sep="/"},{__browserify_process:64}],63:[function(a,b,c){a=function(a,b,c,d){function e(d){if(!c[d]){if(!b[d]){if(a)return a(d);throw new Error("Cannot find module '"+d+"'")}var f=c[d]={exports:{}};b[d][0](function(a){var c=b[d][1][a];return e(c||a)},f,f.exports)}return c[d].exports}for(var f=0;f<d.length;f++)e(d[f]);return e}(void 0!==a&&a,{1:[function(a,b,c){function d(a){if(Object.keys)return Object.keys(a);var b=[];for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&b.push(c);return b}function e(a,b){return void 0===b?""+b:"number"!=typeof b||!isNaN(b)&&isFinite(b)?"function"==typeof b||b instanceof RegExp?b.toString():b:b.toString()}function f(a,b){return"string"==typeof a?a.length<b?a:a.slice(0,b):a}function g(a,b,c,d,e){throw new r.AssertionError({message:c,actual:a,expected:b,operator:d,stackStartFunction:e})}function h(a,b){a||g(a,!0,b,"==",r.ok)}function i(a,b){if(a===b)return!0;if(p.isBuffer(a)&&p.isBuffer(b)){if(a.length!=b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0}return a instanceof Date&&b instanceof Date?a.getTime()===b.getTime():"object"!=typeof a&&"object"!=typeof b?a==b:l(a,b)}function j(a){return null===a||void 0===a}function k(a){return"[object Arguments]"==Object.prototype.toString.call(a)}function l(a,b){if(j(a)||j(b))return!1;if(a.prototype!==b.prototype)return!1;if(k(a))return!!k(b)&&(a=q.call(a),b=q.call(b),i(a,b));try{var c,e,f=d(a),g=d(b)}catch(a){return!1}if(f.length!=g.length)return!1;for(f.sort(),g.sort(),e=f.length-1;e>=0;e--)if(f[e]!=g[e])return!1;for(e=f.length-1;e>=0;e--)if(c=f[e],!i(a[c],b[c]))return!1;return!0}function m(a,b){return!(!a||!b)&&(b instanceof RegExp?b.test(a):a instanceof b||!0===b.call({},a))}function n(a,b,c,d){var e;"string"==typeof c&&(d=c,c=null);try{b()}catch(a){e=a}if(d=(c&&c.name?" ("+c.name+").":".")+(d?" "+d:"."),a&&!e&&g("Missing expected exception"+d),!a&&m(e,c)&&g("Got unwanted exception"+d),a&&e&&c&&!m(e,c)||!a&&e)throw e}var o=a("util"),p=a("buffer").Buffer,q=Array.prototype.slice,r=b.exports=h;r.AssertionError=function(a){this.name="AssertionError",this.message=a.message,this.actual=a.actual,this.expected=a.expected,this.operator=a.operator;var b=a.stackStartFunction||g;Error.captureStackTrace&&Error.captureStackTrace(this,b)},o.inherits(r.AssertionError,Error),r.AssertionError.prototype.toString=function(){return this.message?[this.name+":",this.message].join(" "):[this.name+":",f(JSON.stringify(this.actual,e),128),this.operator,f(JSON.stringify(this.expected,e),128)].join(" ")},r.AssertionError.__proto__=Error.prototype,r.fail=g,r.ok=h,r.equal=function(a,b,c){a!=b&&g(a,b,c,"==",r.equal)},r.notEqual=function(a,b,c){a==b&&g(a,b,c,"!=",r.notEqual)},r.deepEqual=function(a,b,c){i(a,b)||g(a,b,c,"deepEqual",r.deepEqual)},r.notDeepEqual=function(a,b,c){i(a,b)&&g(a,b,c,"notDeepEqual",r.notDeepEqual)},r.strictEqual=function(a,b,c){a!==b&&g(a,b,c,"===",r.strictEqual)},r.notStrictEqual=function(a,b,c){a===b&&g(a,b,c,"!==",r.notStrictEqual)},r.throws=function(a,b,c){n.apply(this,[!0].concat(q.call(arguments)))},r.doesNotThrow=function(a,b,c){n.apply(this,[!1].concat(q.call(arguments)))},r.ifError=function(a){if(a)throw a}},{util:2,buffer:3}],2:[function(a,b,c){function d(a){return a instanceof Array||Array.isArray(a)||a&&a!==Object.prototype&&d(a.__proto__)}function e(a){return a instanceof RegExp||"object"==typeof a&&"[object RegExp]"===Object.prototype.toString.call(a)}function f(a){if(a instanceof Date)return!0;if("object"!=typeof a)return!1;var b=Date.prototype&&h(Date.prototype),c=a.__proto__&&h(a.__proto__);return JSON.stringify(c)===JSON.stringify(b)}a("events");c.isArray=d,c.isDate=function(a){return"[object Date]"===Object.prototype.toString.call(a)},c.isRegExp=function(a){return"[object RegExp]"===Object.prototype.toString.call(a)},c.print=function(){},c.puts=function(){},c.debug=function(){},c.inspect=function(a,b,i,j){function k(a,i){if(a&&"function"==typeof a.inspect&&a!==c&&(!a.constructor||a.constructor.prototype!==a))return a.inspect(i);switch(typeof a){case"undefined":return m("undefined","undefined");case"string":var j="'"+JSON.stringify(a).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return m(j,"string");case"number":return m(""+a,"number");case"boolean":return m(""+a,"boolean")}if(null===a)return m("null","null");var n=g(a),o=b?h(a):n;if("function"==typeof a&&0===o.length){if(e(a))return m(""+a,"regexp");var p=a.name?": "+a.name:"";return m("[Function"+p+"]","special")}if(f(a)&&0===o.length)return m(a.toUTCString(),"date");var q,r,s;if(d(a)?(r="Array",s=["[","]"]):(r="Object",s=["{","}"]),"function"==typeof a){var t=a.name?": "+a.name:"";q=e(a)?" "+a:" [Function"+t+"]"}else q="";if(f(a)&&(q=" "+a.toUTCString()),0===o.length)return s[0]+q+s[1];if(i<0)return e(a)?m(""+a,"regexp"):m("[Object]","special");l.push(a);var u=o.map(function(b){var c,e;if(a.__lookupGetter__&&(a.__lookupGetter__(b)?e=a.__lookupSetter__(b)?m("[Getter/Setter]","special"):m("[Getter]","special"):a.__lookupSetter__(b)&&(e=m("[Setter]","special"))),n.indexOf(b)<0&&(c="["+b+"]"),e||(l.indexOf(a[b])<0?(e=null===i?k(a[b]):k(a[b],i-1),e.indexOf("\n")>-1&&(e=d(a)?e.split("\n").map(function(a){return"  "+a}).join("\n").substr(2):"\n"+e.split("\n").map(function(a){return"   "+a}).join("\n"))):e=m("[Circular]","special")),void 0===c){if("Array"===r&&b.match(/^\d+$/))return e;c=JSON.stringify(""+b),c.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(c=c.substr(1,c.length-2),c=m(c,"name")):(c=c.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),c=m(c,"string"))}return c+": "+e});l.pop();var v=0;return u=u.reduce(function(a,b){return v++,b.indexOf("\n")>=0&&v++,a+b.length+1},0)>50?s[0]+(""===q?"":q+"\n ")+" "+u.join(",\n  ")+" "+s[1]:s[0]+q+" "+u.join(", ")+" "+s[1]}var l=[],m=function(a,b){var c={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},d={special:"cyan",number:"blue",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"}[b];return d?"\\033["+c[d][0]+"m"+a+"\\033["+c[d][1]+"m":a};return j||(m=function(a,b){return a}),k(a,void 0===i?2:i)};c.log=function(a){},c.pump=null;var g=Object.keys||function(a){var b=[];for(var c in a)b.push(c);return b},h=Object.getOwnPropertyNames||function(a){var b=[];for(var c in a)Object.hasOwnProperty.call(a,c)&&b.push(c);return b},i=Object.create||function(a,b){var c;if(null===a)c={__proto__:null};else{if("object"!=typeof a)throw new TypeError("typeof prototype["+typeof a+"] != 'object'");var d=function(){};d.prototype=a,c=new d,c.__proto__=a}return void 0!==b&&Object.defineProperties&&Object.defineProperties(c,b),c};c.inherits=function(a,b){a.super_=b,a.prototype=i(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})};var j=/%[sdj%]/g;c.format=function(a){if("string"!=typeof a){for(var b=[],d=0;d<arguments.length;d++)b.push(c.inspect(arguments[d]));return b.join(" ")}for(var d=1,e=arguments,f=e.length,g=String(a).replace(j,function(a){if("%%"===a)return"%";if(d>=f)return a;switch(a){case"%s":return String(e[d++]);case"%d":return Number(e[d++]);case"%j":return JSON.stringify(e[d++]);default:return a}}),h=e[d];d<f;h=e[++d])g+=null===h||"object"!=typeof h?" "+h:" "+c.inspect(h);return g}},{events:4}],5:[function(a,b,c){c.readIEEE754=function(a,b,c,d,e){var f,g,h=8*e-d-1,i=(1<<h)-1,j=i>>1,k=-7,l=c?0:e-1,m=c?1:-1,n=a[b+l];for(l+=m,f=n&(1<<-k)-1,n>>=-k,k+=h;k>0;f=256*f+a[b+l],l+=m,k-=8);for(g=f&(1<<-k)-1,f>>=-k,k+=d;k>0;g=256*g+a[b+l],l+=m,k-=8);if(0===f)f=1-j;else{if(f===i)return g?NaN:1/0*(n?-1:1);g+=Math.pow(2,d),f-=j}return(n?-1:1)*g*Math.pow(2,f-d)},c.writeIEEE754=function(a,b,c,d,e,f){var g,h,i,j=8*f-e-1,k=(1<<j)-1,l=k>>1,m=23===e?Math.pow(2,-24)-Math.pow(2,-77):0,n=d?f-1:0,o=d?-1:1,p=b<0||0===b&&1/b<0?1:0;for(b=Math.abs(b),isNaN(b)||b===1/0?(h=isNaN(b)?1:0,g=k):(g=Math.floor(Math.log(b)/Math.LN2),b*(i=Math.pow(2,-g))<1&&(g--,i*=2),b+=g+l>=1?m/i:m*Math.pow(2,1-l),b*i>=2&&(g++,i/=2),g+l>=k?(h=0,g=k):g+l>=1?(h=(b*i-1)*Math.pow(2,e),g+=l):(h=b*Math.pow(2,l-1)*Math.pow(2,e),g=0));e>=8;a[c+n]=255&h,n+=o,h/=256,e-=8);for(g=g<<e|h,j+=e;j>0;a[c+n]=255&g,n+=o,g/=256,j-=8);a[c+n-o]|=128*p}},{}],6:[function(a,b,c){var d=b.exports={};d.nextTick=function(){var a="undefined"!=typeof window&&window.setImmediate,b="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(a)return function(a){return window.setImmediate(a)};if(b){var c=[];return window.addEventListener("message",function(a){if(a.source===window&&"process-tick"===a.data&&(a.stopPropagation(),c.length>0)){c.shift()()}},!0),function(a){c.push(a),window.postMessage("process-tick","*")}}return function(a){setTimeout(a,0)}}(),d.title="browser",d.browser=!0,d.env={},d.argv=[],d.binding=function(a){throw new Error("process.binding is not supported")},d.cwd=function(){return"/"},d.chdir=function(a){throw new Error("process.chdir is not supported")}},{}],4:[function(a,b,c){!function(a){function b(a,b){if(a.indexOf)return a.indexOf(b);for(var c=0;c<a.length;c++)if(b===a[c])return c;return-1}a.EventEmitter||(a.EventEmitter=function(){});var d=c.EventEmitter=a.EventEmitter,e="function"==typeof Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};d.prototype.setMaxListeners=function(a){this._events||(this._events={}),this._events.maxListeners=a},d.prototype.emit=function(a){if("error"===a&&(!this._events||!this._events.error||e(this._events.error)&&!this._events.error.length))throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");if(!this._events)return!1;var b=this._events[a];if(!b)return!1;if("function"==typeof b){switch(arguments.length){case 1:b.call(this);break;case 2:b.call(this,arguments[1]);break;case 3:b.call(this,arguments[1],arguments[2]);break;default:var c=Array.prototype.slice.call(arguments,1);b.apply(this,c)}return!0}if(e(b)){for(var c=Array.prototype.slice.call(arguments,1),d=b.slice(),f=0,g=d.length;f<g;f++)d[f].apply(this,c);return!0}return!1},d.prototype.addListener=function(a,b){if("function"!=typeof b)throw new Error("addListener only takes instances of Function");if(this._events||(this._events={}),this.emit("newListener",a,b),this._events[a])if(e(this._events[a])){if(!this._events[a].warned){var c;(c=void 0!==this._events.maxListeners?this._events.maxListeners:10)&&c>0&&this._events[a].length>c&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),console.trace())}this._events[a].push(b)}else this._events[a]=[this._events[a],b];else this._events[a]=b;return this},d.prototype.on=d.prototype.addListener,d.prototype.once=function(a,b){var c=this;return c.on(a,function d(){c.removeListener(a,d),b.apply(this,arguments)}),this},d.prototype.removeListener=function(a,c){if("function"!=typeof c)throw new Error("removeListener only takes instances of Function");if(!this._events||!this._events[a])return this;var d=this._events[a];if(e(d)){var f=b(d,c);if(f<0)return this;d.splice(f,1),0==d.length&&delete this._events[a]}else this._events[a]===c&&delete this._events[a];return this},d.prototype.removeAllListeners=function(a){return 0===arguments.length?(this._events={},this):(a&&this._events&&this._events[a]&&(this._events[a]=null),this)},d.prototype.listeners=function(a){return this._events||(this._events={}),this._events[a]||(this._events[a]=[]),e(this._events[a])||(this._events[a]=[this._events[a]]),this._events[a]}}(a("__browserify_process"))},{__browserify_process:6}],"buffer-browserify":[function(a,b,c){b.exports=a("q9TxCC")},{}],q9TxCC:[function(a,b,c){function d(a){this.length=a}function e(a){return a<16?"0"+a.toString(16):a.toString(16)}function f(a){for(var b=[],c=0;c<a.length;c++)if(a.charCodeAt(c)<=127)b.push(a.charCodeAt(c));else for(var d=encodeURIComponent(a.charAt(c)).substr(1).split("%"),e=0;e<d.length;e++)b.push(parseInt(d[e],16));return b}function g(a){for(var b=[],c=0;c<a.length;c++)b.push(255&a.charCodeAt(c));return b}function h(b){return a("base64-js").toByteArray(b)}function i(a,b,c,d){for(var e=0;e<d&&!(e+c>=b.length||e>=a.length);)b[e+c]=a[e],e++;return e}function j(a){try{return decodeURIComponent(a)}catch(a){return String.fromCharCode(65533)}}function k(a){return a=~~Math.ceil(+a),a<0?0:a}function l(a,b,c){if(!(this instanceof l))return new l(a,b,c);var e;if("number"==typeof c)this.length=k(b),this.parent=a,this.offset=c;else{switch(e=typeof a){case"number":this.length=k(a);break;case"string":this.length=l.byteLength(a,b);break;case"object":this.length=k(a.length);break;default:throw new Error("First argument needs to be a number, array or string.")}if(this.length>l.poolSize?(this.parent=new d(this.length),this.offset=0):((!E||E.length-E.used<this.length)&&n(),this.parent=E,this.offset=E.used,E.used+=this.length),m(a))for(var f=0;f<this.length;f++)this.parent[f+this.offset]=a instanceof l?a.readUInt8(f):a[f];else"string"==e&&(this.length=this.write(a,0,b))}}function m(a){return Array.isArray(a)||l.isBuffer(a)||a&&"object"==typeof a&&"number"==typeof a.length}function n(){E=new d(l.poolSize),E.used=0}function o(a,b,c,d){var e=0;return d||(D.ok("boolean"==typeof c,"missing or invalid endian"),D.ok(void 0!==b&&null!==b,"missing offset"),D.ok(b+1<a.length,"Trying to read beyond buffer length")),b>=a.length?0:(c?(e=a.parent[a.offset+b]<<8,b+1<a.length&&(e|=a.parent[a.offset+b+1])):(e=a.parent[a.offset+b],b+1<a.length&&(e|=a.parent[a.offset+b+1]<<8)),e)}function p(a,b,c,d){var e=0;return d||(D.ok("boolean"==typeof c,"missing or invalid endian"),D.ok(void 0!==b&&null!==b,"missing offset"),D.ok(b+3<a.length,"Trying to read beyond buffer length")),b>=a.length?0:(c?(b+1<a.length&&(e=a.parent[a.offset+b+1]<<16),b+2<a.length&&(e|=a.parent[a.offset+b+2]<<8),b+3<a.length&&(e|=a.parent[a.offset+b+3]),e+=a.parent[a.offset+b]<<24>>>0):(b+2<a.length&&(e=a.parent[a.offset+b+2]<<16),b+1<a.length&&(e|=a.parent[a.offset+b+1]<<8),e|=a.parent[a.offset+b],b+3<a.length&&(e+=a.parent[a.offset+b+3]<<24>>>0)),e)}function q(a,b,c,d){var e,f;return d||(D.ok("boolean"==typeof c,"missing or invalid endian"),D.ok(void 0!==b&&null!==b,"missing offset"),D.ok(b+1<a.length,"Trying to read beyond buffer length")),f=o(a,b,c,d),e=32768&f,e?-1*(65535-f+1):f}function r(a,b,c,d){var e,f;return d||(D.ok("boolean"==typeof c,"missing or invalid endian"),D.ok(void 0!==b&&null!==b,"missing offset"),D.ok(b+3<a.length,"Trying to read beyond buffer length")),f=p(a,b,c,d),e=2147483648&f,e?-1*(4294967295-f+1):f}function s(b,c,d,e){return e||(D.ok("boolean"==typeof d,"missing or invalid endian"),D.ok(c+3<b.length,"Trying to read beyond buffer length")),a("./buffer_ieee754").readIEEE754(b,c,d,23,4)}function t(b,c,d,e){return e||(D.ok("boolean"==typeof d,"missing or invalid endian"),D.ok(c+7<b.length,"Trying to read beyond buffer length")),a("./buffer_ieee754").readIEEE754(b,c,d,52,8)}function u(a,b){D.ok("number"==typeof a,"cannot write a non-number as a number"),D.ok(a>=0,"specified a negative value for writing an unsigned value"),D.ok(a<=b,"value is larger than maximum value for type"),D.ok(Math.floor(a)===a,"value has a fractional component")}function v(a,b,c,d,e){e||(D.ok(void 0!==b&&null!==b,"missing value"),D.ok("boolean"==typeof d,"missing or invalid endian"),D.ok(void 0!==c&&null!==c,"missing offset"),D.ok(c+1<a.length,"trying to write beyond buffer length"),u(b,65535));for(var f=0;f<Math.min(a.length-c,2);f++)a.parent[a.offset+c+f]=(b&255<<8*(d?1-f:f))>>>8*(d?1-f:f)}function w(a,b,c,d,e){e||(D.ok(void 0!==b&&null!==b,"missing value"),D.ok("boolean"==typeof d,"missing or invalid endian"),D.ok(void 0!==c&&null!==c,"missing offset"),D.ok(c+3<a.length,"trying to write beyond buffer length"),u(b,4294967295));for(var f=0;f<Math.min(a.length-c,4);f++)a.parent[a.offset+c+f]=b>>>8*(d?3-f:f)&255}function x(a,b,c){D.ok("number"==typeof a,"cannot write a non-number as a number"),D.ok(a<=b,"value larger than maximum allowed value"),D.ok(a>=c,"value smaller than minimum allowed value"),D.ok(Math.floor(a)===a,"value has a fractional component")}function y(a,b,c){D.ok("number"==typeof a,"cannot write a non-number as a number"),D.ok(a<=b,"value larger than maximum allowed value"),D.ok(a>=c,"value smaller than minimum allowed value")}function z(a,b,c,d,e){e||(D.ok(void 0!==b&&null!==b,"missing value"),D.ok("boolean"==typeof d,"missing or invalid endian"),D.ok(void 0!==c&&null!==c,"missing offset"),D.ok(c+1<a.length,"Trying to write beyond buffer length"),x(b,32767,-32768)),b>=0?v(a,b,c,d,e):v(a,65535+b+1,c,d,e)}function A(a,b,c,d,e){e||(D.ok(void 0!==b&&null!==b,"missing value"),D.ok("boolean"==typeof d,"missing or invalid endian"),D.ok(void 0!==c&&null!==c,"missing offset"),D.ok(c+3<a.length,"Trying to write beyond buffer length"),x(b,2147483647,-2147483648)),b>=0?w(a,b,c,d,e):w(a,4294967295+b+1,c,d,e)}function B(b,c,d,e,f){f||(D.ok(void 0!==c&&null!==c,"missing value"),D.ok("boolean"==typeof e,"missing or invalid endian"),D.ok(void 0!==d&&null!==d,"missing offset"),D.ok(d+3<b.length,"Trying to write beyond buffer length"),y(c,3.4028234663852886e38,-3.4028234663852886e38)),a("./buffer_ieee754").writeIEEE754(b,c,d,e,23,4)}function C(b,c,d,e,f){f||(D.ok(void 0!==c&&null!==c,"missing value"),D.ok("boolean"==typeof e,"missing or invalid endian"),D.ok(void 0!==d&&null!==d,"missing offset"),D.ok(d+7<b.length,"Trying to write beyond buffer length"),y(c,1.7976931348623157e308,-1.7976931348623157e308)),a("./buffer_ieee754").writeIEEE754(b,c,d,e,52,8)}var D=a("assert");c.INSPECT_MAX_BYTES=50,d.byteLength=function(a,b){switch(b||"utf8"){case"hex":return a.length/2;case"utf8":case"utf-8":return f(a).length;case"ascii":case"binary":return a.length;case"base64":return h(a).length;default:throw new Error("Unknown encoding")}},d.prototype.utf8Write=function(a,b,c){return d._charsWritten=i(f(a),this,b,c)},d.prototype.asciiWrite=function(a,b,c){return d._charsWritten=i(g(a),this,b,c)},d.prototype.binaryWrite=d.prototype.asciiWrite,d.prototype.base64Write=function(a,b,c){return d._charsWritten=i(h(a),this,b,c)},d.prototype.base64Slice=function(b,c){var d=Array.prototype.slice.apply(this,arguments);return a("base64-js").fromByteArray(d)},d.prototype.utf8Slice=function(){for(var a=Array.prototype.slice.apply(this,arguments),b="",c="",d=0;d<a.length;)a[d]<=127?(b+=j(c)+String.fromCharCode(a[d]),c=""):c+="%"+a[d].toString(16),d++;return b+j(c)},d.prototype.asciiSlice=function(){for(var a=Array.prototype.slice.apply(this,arguments),b="",c=0;c<a.length;c++)b+=String.fromCharCode(a[c]);return b},d.prototype.binarySlice=d.prototype.asciiSlice,d.prototype.inspect=function(){for(var a=[],b=this.length,d=0;d<b;d++)if(a[d]=e(this[d]),d==c.INSPECT_MAX_BYTES){a[d+1]="...";break}return"<SlowBuffer "+a.join(" ")+">"},d.prototype.hexSlice=function(a,b){var c=this.length;(!a||a<0)&&(a=0),(!b||b<0||b>c)&&(b=c);for(var d="",f=a;f<b;f++)d+=e(this[f]);return d},d.prototype.toString=function(a,b,c){if(a=String(a||"utf8").toLowerCase(),b=+b||0,void 0===c&&(c=this.length),+c==b)return"";switch(a){case"hex":return this.hexSlice(b,c);case"utf8":case"utf-8":return this.utf8Slice(b,c);case"ascii":return this.asciiSlice(b,c);case"binary":return this.binarySlice(b,c);case"base64":return this.base64Slice(b,c);case"ucs2":case"ucs-2":return this.ucs2Slice(b,c);default:throw new Error("Unknown encoding")}},d.prototype.hexWrite=function(a,b,c){b=+b||0;var e=this.length-b;c?(c=+c)>e&&(c=e):c=e;var f=a.length;if(f%2)throw new Error("Invalid hex string");c>f/2&&(c=f/2);for(var g=0;g<c;g++){var h=parseInt(a.substr(2*g,2),16);if(isNaN(h))throw new Error("Invalid hex string");this[b+g]=h}return d._charsWritten=2*g,g},d.prototype.write=function(a,b,c,d){if(isFinite(b))isFinite(c)||(d=c,c=void 0);else{var e=d;d=b,b=c,c=e}b=+b||0;var f=this.length-b;switch(c?(c=+c)>f&&(c=f):c=f,d=String(d||"utf8").toLowerCase()){case"hex":return this.hexWrite(a,b,c);case"utf8":case"utf-8":return this.utf8Write(a,b,c);case"ascii":return this.asciiWrite(a,b,c);case"binary":return this.binaryWrite(a,b,c);case"base64":return this.base64Write(a,b,c);case"ucs2":case"ucs-2":return this.ucs2Write(a,b,c);default:throw new Error("Unknown encoding")}},d.prototype.slice=function(a,b){if(void 0===b&&(b=this.length),b>this.length)throw new Error("oob");if(a>b)throw new Error("oob");return new l(this,b-a,+a)},d.prototype.copy=function(a,b,c,d){for(var e=[],f=c;f<d;f++)D.ok(void 0!==this[f],"copying undefined buffer bytes!"),e.push(this[f]);for(var f=b;f<b+e.length;f++)a[f]=e[f-b]},d.prototype.fill=function(a,b,c){if(c>this.length)throw new Error("oob");if(b>c)throw new Error("oob");for(var d=b;d<c;d++)this[d]=a},c.SlowBuffer=d,c.Buffer=l,l.poolSize=8192;var E;l.isBuffer=function(a){return a instanceof l||a instanceof d},l.concat=function(a,b){if(!Array.isArray(a))throw new Error("Usage: Buffer.concat(list, [totalLength])\n       list should be an Array.");if(0===a.length)return new l(0);if(1===a.length)return a[0];if("number"!=typeof b){b=0;for(var c=0;c<a.length;c++){var d=a[c];b+=d.length}}for(var e=new l(b),f=0,c=0;c<a.length;c++){var d=a[c];d.copy(e,f),f+=d.length}return e},l.prototype.inspect=function(){for(var a=[],b=this.length,d=0;d<b;d++)if(a[d]=e(this.parent[d+this.offset]),d==c.INSPECT_MAX_BYTES){a[d+1]="...";break}return"<Buffer "+a.join(" ")+">"},l.prototype.get=function(a){if(a<0||a>=this.length)throw new Error("oob");return this.parent[this.offset+a]},l.prototype.set=function(a,b){if(a<0||a>=this.length)throw new Error("oob");return this.parent[this.offset+a]=b},l.prototype.write=function(a,b,c,e){if(isFinite(b))isFinite(c)||(e=c,c=void 0);else{var f=e;e=b,b=c,c=f}b=+b||0;var g=this.length-b;c?(c=+c)>g&&(c=g):c=g,e=String(e||"utf8").toLowerCase();var h;switch(e){case"hex":h=this.parent.hexWrite(a,this.offset+b,c);break;case"utf8":case"utf-8":h=this.parent.utf8Write(a,this.offset+b,c);break;case"ascii":h=this.parent.asciiWrite(a,this.offset+b,c);break;case"binary":h=this.parent.binaryWrite(a,this.offset+b,c);break;case"base64":h=this.parent.base64Write(a,this.offset+b,c);break;case"ucs2":case"ucs-2":h=this.parent.ucs2Write(a,this.offset+b,c);break;default:throw new Error("Unknown encoding")}return l._charsWritten=d._charsWritten,h},l.prototype.toString=function(a,b,c){switch(a=String(a||"utf8").toLowerCase(),void 0===b||b<0?b=0:b>this.length&&(b=this.length),void 0===c||c>this.length?c=this.length:c<0&&(c=0),b+=this.offset,c+=this.offset,a){case"hex":return this.parent.hexSlice(b,c);case"utf8":case"utf-8":return this.parent.utf8Slice(b,c);case"ascii":return this.parent.asciiSlice(b,c);case"binary":return this.parent.binarySlice(b,c);case"base64":return this.parent.base64Slice(b,c);case"ucs2":case"ucs-2":return this.parent.ucs2Slice(b,c);default:throw new Error("Unknown encoding")}},l.byteLength=d.byteLength,l.prototype.fill=function(a,b,c){if(a||(a=0),b||(b=0),c||(c=this.length),"string"==typeof a&&(a=a.charCodeAt(0)),"number"!=typeof a||isNaN(a))throw new Error("value is not a number");if(c<b)throw new Error("end < start");if(c===b)return 0;if(0==this.length)return 0;if(b<0||b>=this.length)throw new Error("start out of bounds");if(c<0||c>this.length)throw new Error("end out of bounds");return this.parent.fill(a,b+this.offset,c+this.offset)},l.prototype.copy=function(a,b,c,d){var e=this;if(c||(c=0),d||(d=this.length),b||(b=0),d<c)throw new Error("sourceEnd < sourceStart");if(d===c)return 0;if(0==a.length||0==e.length)return 0;if(b<0||b>=a.length)throw new Error("targetStart out of bounds");if(c<0||c>=e.length)throw new Error("sourceStart out of bounds");if(d<0||d>e.length)throw new Error("sourceEnd out of bounds");return d>this.length&&(d=this.length),a.length-b<d-c&&(d=a.length-b+c),this.parent.copy(a.parent,b+a.offset,c+this.offset,d+this.offset)},l.prototype.slice=function(a,b){if(void 0===b&&(b=this.length),b>this.length)throw new Error("oob");if(a>b)throw new Error("oob");return new l(this.parent,b-a,+a+this.offset)},l.prototype.utf8Slice=function(a,b){return this.toString("utf8",a,b)},l.prototype.binarySlice=function(a,b){return this.toString("binary",a,b)},l.prototype.asciiSlice=function(a,b){return this.toString("ascii",a,b)},l.prototype.utf8Write=function(a,b){return this.write(a,b,"utf8")},l.prototype.binaryWrite=function(a,b){return this.write(a,b,"binary")},l.prototype.asciiWrite=function(a,b){return this.write(a,b,"ascii")},l.prototype.readUInt8=function(a,b){var c=this;if(b||(D.ok(void 0!==a&&null!==a,"missing offset"),D.ok(a<c.length,"Trying to read beyond buffer length")),!(a>=c.length))return c.parent[c.offset+a]},l.prototype.readUInt16LE=function(a,b){return o(this,a,!1,b)},l.prototype.readUInt16BE=function(a,b){return o(this,a,!0,b)},l.prototype.readUInt32LE=function(a,b){return p(this,a,!1,b)},l.prototype.readUInt32BE=function(a,b){return p(this,a,!0,b)},l.prototype.readInt8=function(a,b){var c,d=this;if(b||(D.ok(void 0!==a&&null!==a,"missing offset"),D.ok(a<d.length,"Trying to read beyond buffer length")),!(a>=d.length))return c=128&d.parent[d.offset+a],c?-1*(255-d.parent[d.offset+a]+1):d.parent[d.offset+a]},l.prototype.readInt16LE=function(a,b){return q(this,a,!1,b)},l.prototype.readInt16BE=function(a,b){return q(this,a,!0,b)},l.prototype.readInt32LE=function(a,b){return r(this,a,!1,b)},l.prototype.readInt32BE=function(a,b){return r(this,a,!0,b)},l.prototype.readFloatLE=function(a,b){return s(this,a,!1,b)},l.prototype.readFloatBE=function(a,b){return s(this,a,!0,b)},l.prototype.readDoubleLE=function(a,b){return t(this,a,!1,b)},l.prototype.readDoubleBE=function(a,b){return t(this,a,!0,b)},l.prototype.writeUInt8=function(a,b,c){var d=this;c||(D.ok(void 0!==a&&null!==a,"missing value"),D.ok(void 0!==b&&null!==b,"missing offset"),D.ok(b<d.length,"trying to write beyond buffer length"),u(a,255)),b<d.length&&(d.parent[d.offset+b]=a)},l.prototype.writeUInt16LE=function(a,b,c){v(this,a,b,!1,c)},l.prototype.writeUInt16BE=function(a,b,c){v(this,a,b,!0,c)},l.prototype.writeUInt32LE=function(a,b,c){w(this,a,b,!1,c)},l.prototype.writeUInt32BE=function(a,b,c){w(this,a,b,!0,c)},l.prototype.writeInt8=function(a,b,c){var d=this;c||(D.ok(void 0!==a&&null!==a,"missing value"),D.ok(void 0!==b&&null!==b,"missing offset"),D.ok(b<d.length,"Trying to write beyond buffer length"),x(a,127,-128)),a>=0?d.writeUInt8(a,b,c):d.writeUInt8(255+a+1,b,c)},l.prototype.writeInt16LE=function(a,b,c){z(this,a,b,!1,c)},l.prototype.writeInt16BE=function(a,b,c){z(this,a,b,!0,c)},l.prototype.writeInt32LE=function(a,b,c){A(this,a,b,!1,c)},l.prototype.writeInt32BE=function(a,b,c){A(this,a,b,!0,c)},l.prototype.writeFloatLE=function(a,b,c){B(this,a,b,!1,c)},l.prototype.writeFloatBE=function(a,b,c){B(this,a,b,!0,c)},l.prototype.writeDoubleLE=function(a,b,c){C(this,a,b,!1,c)},l.prototype.writeDoubleBE=function(a,b,c){C(this,a,b,!0,c)},d.prototype.readUInt8=l.prototype.readUInt8,d.prototype.readUInt16LE=l.prototype.readUInt16LE,d.prototype.readUInt16BE=l.prototype.readUInt16BE,d.prototype.readUInt32LE=l.prototype.readUInt32LE,d.prototype.readUInt32BE=l.prototype.readUInt32BE,d.prototype.readInt8=l.prototype.readInt8,d.prototype.readInt16LE=l.prototype.readInt16LE,d.prototype.readInt16BE=l.prototype.readInt16BE,d.prototype.readInt32LE=l.prototype.readInt32LE,d.prototype.readInt32BE=l.prototype.readInt32BE,d.prototype.readFloatLE=l.prototype.readFloatLE,d.prototype.readFloatBE=l.prototype.readFloatBE,d.prototype.readDoubleLE=l.prototype.readDoubleLE,d.prototype.readDoubleBE=l.prototype.readDoubleBE,d.prototype.writeUInt8=l.prototype.writeUInt8,d.prototype.writeUInt16LE=l.prototype.writeUInt16LE,d.prototype.writeUInt16BE=l.prototype.writeUInt16BE,d.prototype.writeUInt32LE=l.prototype.writeUInt32LE,d.prototype.writeUInt32BE=l.prototype.writeUInt32BE,d.prototype.writeInt8=l.prototype.writeInt8,d.prototype.writeInt16LE=l.prototype.writeInt16LE,d.prototype.writeInt16BE=l.prototype.writeInt16BE,d.prototype.writeInt32LE=l.prototype.writeInt32LE,d.prototype.writeInt32BE=l.prototype.writeInt32BE,d.prototype.writeFloatLE=l.prototype.writeFloatLE,d.prototype.writeFloatBE=l.prototype.writeFloatBE,d.prototype.writeDoubleLE=l.prototype.writeDoubleLE,d.prototype.writeDoubleBE=l.prototype.writeDoubleBE},{assert:1,"./buffer_ieee754":5,"base64-js":7}],7:[function(a,b,c){!function(a){"use strict";function c(a){var b,c,d,f,g,h;if(a.length%4>0)throw"Invalid string. Length must be a multiple of 4";for(g=a.indexOf("="),g=g>0?a.length-g:0,h=[],d=g>0?a.length-4:a.length,b=0,c=0;b<d;b+=4,c+=3)f=e.indexOf(a[b])<<18|e.indexOf(a[b+1])<<12|e.indexOf(a[b+2])<<6|e.indexOf(a[b+3]),h.push((16711680&f)>>16),h.push((65280&f)>>8),h.push(255&f);return 2===g?(f=e.indexOf(a[b])<<2|e.indexOf(a[b+1])>>4,h.push(255&f)):1===g&&(f=e.indexOf(a[b])<<10|e.indexOf(a[b+1])<<4|e.indexOf(a[b+2])>>2,h.push(f>>8&255),h.push(255&f)),h}function d(a){function b(a){return e[a>>18&63]+e[a>>12&63]+e[a>>6&63]+e[63&a]}var c,d,f,g=a.length%3,h="";for(c=0,f=a.length-g;c<f;c+=3)d=(a[c]<<16)+(a[c+1]<<8)+a[c+2],h+=b(d);switch(g){case 1:d=a[a.length-1],h+=e[d>>2],h+=e[d<<4&63],h+="==";break;case 2:d=(a[a.length-2]<<8)+a[a.length-1],h+=e[d>>10],h+=e[d>>4&63],h+=e[d<<2&63],h+="="}return h}var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";b.exports.toByteArray=c,b.exports.fromByteArray=d}()},{}],8:[function(a,b,c){c.readIEEE754=function(a,b,c,d,e){var f,g,h=8*e-d-1,i=(1<<h)-1,j=i>>1,k=-7,l=c?0:e-1,m=c?1:-1,n=a[b+l];for(l+=m,f=n&(1<<-k)-1,n>>=-k,k+=h;k>0;f=256*f+a[b+l],l+=m,k-=8);for(g=f&(1<<-k)-1,f>>=-k,k+=d;k>0;g=256*g+a[b+l],l+=m,k-=8);if(0===f)f=1-j;else{if(f===i)return g?NaN:1/0*(n?-1:1);g+=Math.pow(2,d),f-=j}return(n?-1:1)*g*Math.pow(2,f-d)},c.writeIEEE754=function(a,b,c,d,e,f){var g,h,i,j=8*f-e-1,k=(1<<j)-1,l=k>>1,m=23===e?Math.pow(2,-24)-Math.pow(2,-77):0,n=d?f-1:0,o=d?-1:1,p=b<0||0===b&&1/b<0?1:0;for(b=Math.abs(b),isNaN(b)||b===1/0?(h=isNaN(b)?1:0,g=k):(g=Math.floor(Math.log(b)/Math.LN2),b*(i=Math.pow(2,-g))<1&&(g--,i*=2),b+=g+l>=1?m/i:m*Math.pow(2,1-l),b*i>=2&&(g++,i/=2),g+l>=k?(h=0,g=k):g+l>=1?(h=(b*i-1)*Math.pow(2,e),g+=l):(h=b*Math.pow(2,l-1)*Math.pow(2,e),g=0));e>=8;a[c+n]=255&h,n+=o,h/=256,e-=8);for(g=g<<e|h,j+=e;j>0;a[c+n]=255&g,n+=o,g/=256,j-=8);a[c+n-o]|=128*p}},{}],3:[function(a,b,c){function d(a){this.length=a}function e(a){return a<16?"0"+a.toString(16):a.toString(16)}function f(a){for(var b=[],c=0;c<a.length;c++)if(a.charCodeAt(c)<=127)b.push(a.charCodeAt(c));else for(var d=encodeURIComponent(a.charAt(c)).substr(1).split("%"),e=0;e<d.length;e++)b.push(parseInt(d[e],16));return b}function g(a){for(var b=[],c=0;c<a.length;c++)b.push(255&a.charCodeAt(c));return b}function h(b){return a("base64-js").toByteArray(b)}function i(a,b,c,d){for(var e=0;e<d&&!(e+c>=b.length||e>=a.length);)b[e+c]=a[e],e++;return e}function j(a){try{return decodeURIComponent(a)}catch(a){return String.fromCharCode(65533)}}function k(a){return a=~~Math.ceil(+a),a<0?0:a}function l(a,b,c){if(!(this instanceof l))return new l(a,b,c);var e;if("number"==typeof c)this.length=k(b),this.parent=a,this.offset=c;else{switch(e=typeof a){case"number":this.length=k(a);break;case"string":this.length=l.byteLength(a,b);break;case"object":this.length=k(a.length);break;default:throw new Error("First argument needs to be a number, array or string.")}if(this.length>l.poolSize?(this.parent=new d(this.length),this.offset=0):((!E||E.length-E.used<this.length)&&n(),this.parent=E,this.offset=E.used,E.used+=this.length),m(a))for(var f=0;f<this.length;f++)this.parent[f+this.offset]=a[f];else"string"==e&&(this.length=this.write(a,0,b))}}function m(a){return Array.isArray(a)||l.isBuffer(a)||a&&"object"==typeof a&&"number"==typeof a.length}function n(){E=new d(l.poolSize),E.used=0}function o(a,b,c,d){var e=0;return d||(D.ok("boolean"==typeof c,"missing or invalid endian"),D.ok(void 0!==b&&null!==b,"missing offset"),D.ok(b+1<a.length,"Trying to read beyond buffer length")),c?(e=a.parent[a.offset+b]<<8,e|=a.parent[a.offset+b+1]):(e=a.parent[a.offset+b],e|=a.parent[a.offset+b+1]<<8),e}function p(a,b,c,d){var e=0;return d||(D.ok("boolean"==typeof c,"missing or invalid endian"),D.ok(void 0!==b&&null!==b,"missing offset"),D.ok(b+3<a.length,"Trying to read beyond buffer length")),c?(e=a.parent[a.offset+b+1]<<16,e|=a.parent[a.offset+b+2]<<8,e|=a.parent[a.offset+b+3],e+=a.parent[a.offset+b]<<24>>>0):(e=a.parent[a.offset+b+2]<<16,e|=a.parent[a.offset+b+1]<<8,e|=a.parent[a.offset+b],e+=a.parent[a.offset+b+3]<<24>>>0),e}function q(a,b,c,d){var e,f;return d||(D.ok("boolean"==typeof c,"missing or invalid endian"),D.ok(void 0!==b&&null!==b,"missing offset"),D.ok(b+1<a.length,"Trying to read beyond buffer length")),f=o(a,b,c,d),e=32768&f,e?-1*(65535-f+1):f}function r(a,b,c,d){var e,f;return d||(D.ok("boolean"==typeof c,"missing or invalid endian"),D.ok(void 0!==b&&null!==b,"missing offset"),D.ok(b+3<a.length,"Trying to read beyond buffer length")),f=p(a,b,c,d),e=2147483648&f,e?-1*(4294967295-f+1):f}function s(b,c,d,e){return e||(D.ok("boolean"==typeof d,"missing or invalid endian"),D.ok(c+3<b.length,"Trying to read beyond buffer length")),a("./buffer_ieee754").readIEEE754(b,c,d,23,4)}function t(b,c,d,e){return e||(D.ok("boolean"==typeof d,"missing or invalid endian"),D.ok(c+7<b.length,"Trying to read beyond buffer length")),a("./buffer_ieee754").readIEEE754(b,c,d,52,8)}function u(a,b){D.ok("number"==typeof a,"cannot write a non-number as a number"),D.ok(a>=0,"specified a negative value for writing an unsigned value"),D.ok(a<=b,"value is larger than maximum value for type"),D.ok(Math.floor(a)===a,"value has a fractional component")}function v(a,b,c,d,e){e||(D.ok(void 0!==b&&null!==b,"missing value"),D.ok("boolean"==typeof d,"missing or invalid endian"),D.ok(void 0!==c&&null!==c,"missing offset"),D.ok(c+1<a.length,"trying to write beyond buffer length"),u(b,65535)),d?(a.parent[a.offset+c]=(65280&b)>>>8,a.parent[a.offset+c+1]=255&b):(a.parent[a.offset+c+1]=(65280&b)>>>8,a.parent[a.offset+c]=255&b)}function w(a,b,c,d,e){e||(D.ok(void 0!==b&&null!==b,"missing value"),D.ok("boolean"==typeof d,"missing or invalid endian"),D.ok(void 0!==c&&null!==c,"missing offset"),D.ok(c+3<a.length,"trying to write beyond buffer length"),u(b,4294967295)),d?(a.parent[a.offset+c]=b>>>24&255,a.parent[a.offset+c+1]=b>>>16&255,a.parent[a.offset+c+2]=b>>>8&255,a.parent[a.offset+c+3]=255&b):(a.parent[a.offset+c+3]=b>>>24&255,a.parent[a.offset+c+2]=b>>>16&255,a.parent[a.offset+c+1]=b>>>8&255,a.parent[a.offset+c]=255&b)}function x(a,b,c){D.ok("number"==typeof a,"cannot write a non-number as a number"),D.ok(a<=b,"value larger than maximum allowed value"),D.ok(a>=c,"value smaller than minimum allowed value"),D.ok(Math.floor(a)===a,"value has a fractional component")}function y(a,b,c){D.ok("number"==typeof a,"cannot write a non-number as a number"),D.ok(a<=b,"value larger than maximum allowed value"),D.ok(a>=c,"value smaller than minimum allowed value")}function z(a,b,c,d,e){e||(D.ok(void 0!==b&&null!==b,"missing value"),D.ok("boolean"==typeof d,"missing or invalid endian"),D.ok(void 0!==c&&null!==c,"missing offset"),D.ok(c+1<a.length,"Trying to write beyond buffer length"),x(b,32767,-32768)),b>=0?v(a,b,c,d,e):v(a,65535+b+1,c,d,e)}function A(a,b,c,d,e){e||(D.ok(void 0!==b&&null!==b,"missing value"),D.ok("boolean"==typeof d,"missing or invalid endian"),D.ok(void 0!==c&&null!==c,"missing offset"),D.ok(c+3<a.length,"Trying to write beyond buffer length"),x(b,2147483647,-2147483648)),b>=0?w(a,b,c,d,e):w(a,4294967295+b+1,c,d,e)}function B(b,c,d,e,f){f||(D.ok(void 0!==c&&null!==c,"missing value"),D.ok("boolean"==typeof e,"missing or invalid endian"),D.ok(void 0!==d&&null!==d,"missing offset"),D.ok(d+3<b.length,"Trying to write beyond buffer length"),y(c,3.4028234663852886e38,-3.4028234663852886e38)),a("./buffer_ieee754").writeIEEE754(b,c,d,e,23,4)}function C(b,c,d,e,f){f||(D.ok(void 0!==c&&null!==c,"missing value"),D.ok("boolean"==typeof e,"missing or invalid endian"),D.ok(void 0!==d&&null!==d,"missing offset"),D.ok(d+7<b.length,"Trying to write beyond buffer length"),y(c,1.7976931348623157e308,-1.7976931348623157e308)),a("./buffer_ieee754").writeIEEE754(b,c,d,e,52,8)}var D=a("assert");c.INSPECT_MAX_BYTES=50,d.byteLength=function(a,b){switch(b||"utf8"){case"hex":return a.length/2;case"utf8":case"utf-8":return f(a).length;case"ascii":return a.length;case"base64":return h(a).length;default:throw new Error("Unknown encoding")}},d.prototype.utf8Write=function(a,b,c){return d._charsWritten=i(f(a),this,b,c)},d.prototype.asciiWrite=function(a,b,c){return d._charsWritten=i(g(a),this,b,c)},d.prototype.base64Write=function(a,b,c){return d._charsWritten=i(h(a),this,b,c)},d.prototype.base64Slice=function(b,c){var d=Array.prototype.slice.apply(this,arguments);return a("base64-js").fromByteArray(d)},d.prototype.utf8Slice=function(){for(var a=Array.prototype.slice.apply(this,arguments),b="",c="",d=0;d<a.length;)a[d]<=127?(b+=j(c)+String.fromCharCode(a[d]),c=""):c+="%"+a[d].toString(16),d++;return b+j(c)},d.prototype.asciiSlice=function(){for(var a=Array.prototype.slice.apply(this,arguments),b="",c=0;c<a.length;c++)b+=String.fromCharCode(a[c]);return b},d.prototype.inspect=function(){for(var a=[],b=this.length,d=0;d<b;d++)if(a[d]=e(this[d]),d==c.INSPECT_MAX_BYTES){a[d+1]="...";break}return"<SlowBuffer "+a.join(" ")+">"},d.prototype.hexSlice=function(a,b){var c=this.length;(!a||a<0)&&(a=0),(!b||b<0||b>c)&&(b=c);for(var d="",f=a;f<b;f++)d+=e(this[f]);return d},d.prototype.toString=function(a,b,c){if(a=String(a||"utf8").toLowerCase(),b=+b||0,void 0===c&&(c=this.length),+c==b)return"";switch(a){case"hex":return this.hexSlice(b,c);case"utf8":case"utf-8":return this.utf8Slice(b,c);case"ascii":return this.asciiSlice(b,c);case"binary":return this.binarySlice(b,c);case"base64":return this.base64Slice(b,c);case"ucs2":case"ucs-2":return this.ucs2Slice(b,c);default:throw new Error("Unknown encoding")}},d.prototype.hexWrite=function(a,b,c){b=+b||0;var e=this.length-b;c?(c=+c)>e&&(c=e):c=e;var f=a.length;if(f%2)throw new Error("Invalid hex string");c>f/2&&(c=f/2);for(var g=0;g<c;g++){var h=parseInt(a.substr(2*g,2),16);if(isNaN(h))throw new Error("Invalid hex string");this[b+g]=h}return d._charsWritten=2*g,g},d.prototype.write=function(a,b,c,d){if(isFinite(b))isFinite(c)||(d=c,c=void 0);else{var e=d;d=b,b=c,c=e}b=+b||0;var f=this.length-b;switch(c?(c=+c)>f&&(c=f):c=f,d=String(d||"utf8").toLowerCase()){case"hex":return this.hexWrite(a,b,c);case"utf8":case"utf-8":return this.utf8Write(a,b,c);case"ascii":return this.asciiWrite(a,b,c);case"binary":return this.binaryWrite(a,b,c);case"base64":return this.base64Write(a,b,c);case"ucs2":case"ucs-2":return this.ucs2Write(a,b,c);default:throw new Error("Unknown encoding")}},d.prototype.slice=function(a,b){if(void 0===b&&(b=this.length),b>this.length)throw new Error("oob");if(a>b)throw new Error("oob");return new l(this,b-a,+a)},d.prototype.copy=function(a,b,c,d){for(var e=[],f=c;f<d;f++)D.ok(void 0!==this[f],"copying undefined buffer bytes!"),e.push(this[f]);for(var f=b;f<b+e.length;f++)a[f]=e[f-b]},c.SlowBuffer=d,c.Buffer=l,l.poolSize=8192;var E;l.isBuffer=function(a){return a instanceof l||a instanceof d},l.concat=function(a,b){if(!Array.isArray(a))throw new Error("Usage: Buffer.concat(list, [totalLength])\n       list should be an Array.");if(0===a.length)return new l(0);if(1===a.length)return a[0];if("number"!=typeof b){b=0;for(var c=0;c<a.length;c++){var d=a[c];b+=d.length}}for(var e=new l(b),f=0,c=0;c<a.length;c++){var d=a[c];d.copy(e,f),f+=d.length}return e},l.prototype.inspect=function(){for(var a=[],b=this.length,d=0;d<b;d++)if(a[d]=e(this.parent[d+this.offset]),d==c.INSPECT_MAX_BYTES){a[d+1]="...";break}return"<Buffer "+a.join(" ")+">"},l.prototype.get=function(a){if(a<0||a>=this.length)throw new Error("oob");return this.parent[this.offset+a]},l.prototype.set=function(a,b){if(a<0||a>=this.length)throw new Error("oob");return this.parent[this.offset+a]=b},l.prototype.write=function(a,b,c,e){if(isFinite(b))isFinite(c)||(e=c,c=void 0);else{var f=e;e=b,b=c,c=f}b=+b||0;var g=this.length-b;c?(c=+c)>g&&(c=g):c=g,e=String(e||"utf8").toLowerCase();var h;switch(e){case"hex":h=this.parent.hexWrite(a,this.offset+b,c);break;case"utf8":case"utf-8":h=this.parent.utf8Write(a,this.offset+b,c);break;case"ascii":h=this.parent.asciiWrite(a,this.offset+b,c);break;case"binary":h=this.parent.binaryWrite(a,this.offset+b,c);break;case"base64":h=this.parent.base64Write(a,this.offset+b,c);break;case"ucs2":case"ucs-2":h=this.parent.ucs2Write(a,this.offset+b,c);break;default:throw new Error("Unknown encoding")}return l._charsWritten=d._charsWritten,h},l.prototype.toString=function(a,b,c){switch(a=String(a||"utf8").toLowerCase(),void 0===b||b<0?b=0:b>this.length&&(b=this.length),void 0===c||c>this.length?c=this.length:c<0&&(c=0),b+=this.offset,c+=this.offset,a){case"hex":return this.parent.hexSlice(b,c);case"utf8":case"utf-8":return this.parent.utf8Slice(b,c);case"ascii":return this.parent.asciiSlice(b,c);case"binary":return this.parent.binarySlice(b,c);case"base64":return this.parent.base64Slice(b,c);case"ucs2":case"ucs-2":return this.parent.ucs2Slice(b,c);default:throw new Error("Unknown encoding")}},l.byteLength=d.byteLength,l.prototype.fill=function(a,b,c){if(a||(a=0),b||(b=0),c||(c=this.length),"string"==typeof a&&(a=a.charCodeAt(0)),"number"!=typeof a||isNaN(a))throw new Error("value is not a number");if(c<b)throw new Error("end < start");if(c===b)return 0;if(0==this.length)return 0;if(b<0||b>=this.length)throw new Error("start out of bounds");if(c<0||c>this.length)throw new Error("end out of bounds");return this.parent.fill(a,b+this.offset,c+this.offset)},l.prototype.copy=function(a,b,c,d){var e=this;if(c||(c=0),d||(d=this.length),b||(b=0),d<c)throw new Error("sourceEnd < sourceStart");if(d===c)return 0;if(0==a.length||0==e.length)return 0;if(b<0||b>=a.length)throw new Error("targetStart out of bounds");if(c<0||c>=e.length)throw new Error("sourceStart out of bounds");if(d<0||d>e.length)throw new Error("sourceEnd out of bounds");return d>this.length&&(d=this.length),a.length-b<d-c&&(d=a.length-b+c),this.parent.copy(a.parent,b+a.offset,c+this.offset,d+this.offset)},l.prototype.slice=function(a,b){if(void 0===b&&(b=this.length),b>this.length)throw new Error("oob");if(a>b)throw new Error("oob");return new l(this.parent,b-a,+a+this.offset)},l.prototype.utf8Slice=function(a,b){return this.toString("utf8",a,b)},l.prototype.binarySlice=function(a,b){return this.toString("binary",a,b)},l.prototype.asciiSlice=function(a,b){return this.toString("ascii",a,b)},l.prototype.utf8Write=function(a,b){return this.write(a,b,"utf8")},l.prototype.binaryWrite=function(a,b){return this.write(a,b,"binary")},l.prototype.asciiWrite=function(a,b){return this.write(a,b,"ascii")},l.prototype.readUInt8=function(a,b){var c=this;return b||(D.ok(void 0!==a&&null!==a,"missing offset"),D.ok(a<c.length,"Trying to read beyond buffer length")),c.parent[c.offset+a]},l.prototype.readUInt16LE=function(a,b){return o(this,a,!1,b)},l.prototype.readUInt16BE=function(a,b){return o(this,a,!0,b)},l.prototype.readUInt32LE=function(a,b){return p(this,a,!1,b)},l.prototype.readUInt32BE=function(a,b){return p(this,a,!0,b)},l.prototype.readInt8=function(a,b){var c,d=this;return b||(D.ok(void 0!==a&&null!==a,"missing offset"),D.ok(a<d.length,"Trying to read beyond buffer length")),c=128&d.parent[d.offset+a],c?-1*(255-d.parent[d.offset+a]+1):d.parent[d.offset+a]},l.prototype.readInt16LE=function(a,b){return q(this,a,!1,b)},l.prototype.readInt16BE=function(a,b){return q(this,a,!0,b)},l.prototype.readInt32LE=function(a,b){return r(this,a,!1,b)},l.prototype.readInt32BE=function(a,b){return r(this,a,!0,b)},l.prototype.readFloatLE=function(a,b){return s(this,a,!1,b)},l.prototype.readFloatBE=function(a,b){return s(this,a,!0,b)},l.prototype.readDoubleLE=function(a,b){return t(this,a,!1,b)},l.prototype.readDoubleBE=function(a,b){return t(this,a,!0,b)},l.prototype.writeUInt8=function(a,b,c){var d=this;c||(D.ok(void 0!==a&&null!==a,"missing value"),D.ok(void 0!==b&&null!==b,"missing offset"),D.ok(b<d.length,"trying to write beyond buffer length"),u(a,255)),d.parent[d.offset+b]=a},l.prototype.writeUInt16LE=function(a,b,c){v(this,a,b,!1,c)},l.prototype.writeUInt16BE=function(a,b,c){v(this,a,b,!0,c)},l.prototype.writeUInt32LE=function(a,b,c){w(this,a,b,!1,c)},l.prototype.writeUInt32BE=function(a,b,c){w(this,a,b,!0,c)},l.prototype.writeInt8=function(a,b,c){var d=this;c||(D.ok(void 0!==a&&null!==a,"missing value"),D.ok(void 0!==b&&null!==b,"missing offset"),D.ok(b<d.length,"Trying to write beyond buffer length"),x(a,127,-128)),a>=0?d.writeUInt8(a,b,c):d.writeUInt8(255+a+1,b,c)},l.prototype.writeInt16LE=function(a,b,c){z(this,a,b,!1,c)},l.prototype.writeInt16BE=function(a,b,c){z(this,a,b,!0,c)},l.prototype.writeInt32LE=function(a,b,c){A(this,a,b,!1,c)},l.prototype.writeInt32BE=function(a,b,c){A(this,a,b,!0,c)},l.prototype.writeFloatLE=function(a,b,c){B(this,a,b,!1,c)},l.prototype.writeFloatBE=function(a,b,c){B(this,a,b,!0,c)},l.prototype.writeDoubleLE=function(a,b,c){C(this,a,b,!1,c)},l.prototype.writeDoubleBE=function(a,b,c){C(this,a,b,!0,c)},d.prototype.readUInt8=l.prototype.readUInt8,d.prototype.readUInt16LE=l.prototype.readUInt16LE,d.prototype.readUInt16BE=l.prototype.readUInt16BE,d.prototype.readUInt32LE=l.prototype.readUInt32LE,d.prototype.readUInt32BE=l.prototype.readUInt32BE,d.prototype.readInt8=l.prototype.readInt8,d.prototype.readInt16LE=l.prototype.readInt16LE,d.prototype.readInt16BE=l.prototype.readInt16BE,d.prototype.readInt32LE=l.prototype.readInt32LE,d.prototype.readInt32BE=l.prototype.readInt32BE,d.prototype.readFloatLE=l.prototype.readFloatLE,d.prototype.readFloatBE=l.prototype.readFloatBE,d.prototype.readDoubleLE=l.prototype.readDoubleLE,d.prototype.readDoubleBE=l.prototype.readDoubleBE,d.prototype.writeUInt8=l.prototype.writeUInt8,d.prototype.writeUInt16LE=l.prototype.writeUInt16LE,d.prototype.writeUInt16BE=l.prototype.writeUInt16BE,d.prototype.writeUInt32LE=l.prototype.writeUInt32LE,d.prototype.writeUInt32BE=l.prototype.writeUInt32BE,d.prototype.writeInt8=l.prototype.writeInt8,d.prototype.writeInt16LE=l.prototype.writeInt16LE,d.prototype.writeInt16BE=l.prototype.writeInt16BE,d.prototype.writeInt32LE=l.prototype.writeInt32LE,d.prototype.writeInt32BE=l.prototype.writeInt32BE,d.prototype.writeFloatLE=l.prototype.writeFloatLE,d.prototype.writeFloatBE=l.prototype.writeFloatBE,d.prototype.writeDoubleLE=l.prototype.writeDoubleLE,d.prototype.writeDoubleBE=l.prototype.writeDoubleBE},{assert:1,"./buffer_ieee754":8,"base64-js":9}],9:[function(a,b,c){!function(a){"use strict";function c(a){var b,c,d,f,g,h;if(a.length%4>0)throw"Invalid string. Length must be a multiple of 4";for(g=a.indexOf("="),g=g>0?a.length-g:0,h=[],d=g>0?a.length-4:a.length,b=0,c=0;b<d;b+=4,c+=3)f=e.indexOf(a[b])<<18|e.indexOf(a[b+1])<<12|e.indexOf(a[b+2])<<6|e.indexOf(a[b+3]),h.push((16711680&f)>>16),h.push((65280&f)>>8),h.push(255&f);return 2===g?(f=e.indexOf(a[b])<<2|e.indexOf(a[b+1])>>4,h.push(255&f)):1===g&&(f=e.indexOf(a[b])<<10|e.indexOf(a[b+1])<<4|e.indexOf(a[b+2])>>2,h.push(f>>8&255),h.push(255&f)),h}function d(a){function b(a){return e[a>>18&63]+e[a>>12&63]+e[a>>6&63]+e[63&a]}var c,d,f,g=a.length%3,h="";for(c=0,f=a.length-g;c<f;c+=3)d=(a[c]<<16)+(a[c+1]<<8)+a[c+2],h+=b(d);switch(g){case 1:d=a[a.length-1],h+=e[d>>2],h+=e[d<<4&63],h+="==";break;case 2:d=(a[a.length-2]<<8)+a[a.length-1],h+=e[d>>10],h+=e[d>>4&63],h+=e[d<<2&63],h+="="}return h}var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";b.exports.toByteArray=c,b.exports.fromByteArray=d}()},{}]},{},[]),b.exports=a("buffer-browserify")},{}],64:[function(a,b,c){var d=b.exports={};d.nextTick=function(){var a="undefined"!=typeof window&&window.setImmediate,b="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(a)return function(a){return window.setImmediate(a)};if(b){var c=[];return window.addEventListener("message",function(a){var b=a.source;if((b===window||null===b)&&"process-tick"===a.data&&(a.stopPropagation(),c.length>0)){c.shift()()}},!0),function(a){c.push(a),window.postMessage("process-tick","*")}}return function(a){setTimeout(a,0)}}(),d.title="browser",d.browser=!0,d.env={},d.argv=[],d.binding=function(a){throw new Error("process.binding is not supported")},d.cwd=function(){return"/"},d.chdir=function(a){throw new Error("process.chdir is not supported")}},{}],65:[function(a,b,c){(function(){"use strict";function d(a){var b=function(a){return"string"==typeof a?a:"object"==typeof a&&a.hashCode?a.hashCode():""+a},c=a.declare({instance:{constructor:function(){this.__entries=[],this.__keys=[],this.__values=[]},pushValue:function(a,b){return this.__keys.push(a),this.__values.push(b),this.__entries.push({key:a,value:b}),b},remove:function(a){for(var b,c=null,d=this.__entries,e=this.__keys,f=this.__values,g=d.length-1;g>=0;g--)if((b=d[g])&&b.key===a)return d.splice(g,1),e.splice(g,1),f.splice(g,1),b.value;return c},set:function(a,b){for(var c=null,d=this.__entries,e=this.__values,f=d.length-1;f>=0;f--){var g=d[f];if(g&&a===g.key){e[f]=b,g.value=b,c=b;break}}return c||d.push({key:a,value:b}),c},find:function(a){for(var b,c=null,d=this.__entries,e=d.length-1;e>=0;e--)if((b=d[e])&&a===b.key){c=b.value;break}return c},getEntrySet:function(){return this.__entries},getKeys:function(){return this.__keys},getValues:function(a){return this.__values}}});return a.declare({instance:{constructor:function(){this.__map={}},entrySet:function(){var a=[],b=this.__map;for(var c in b)b.hasOwnProperty(c)&&(a=a.concat(b[c].getEntrySet()));return a},put:function(a,d){var e=b(a),f=null;return(f=this.__map[e])||(f=this.__map[e]=new c),f.pushValue(a,d),d},remove:function(a){var c=b(a),d=null,e=this.__map[c];return e&&(d=e.remove(a)),d},get:function(a){var c,d=b(a),e=null;return(c=this.__map[d])&&(e=c.find(a)),e},set:function(a,d){var e=b(a),f=null,g=this.__map;return(f=g[e])?f.set(a,d):(g[e]=new c).pushValue(a,d)},contains:function(a){var c=b(a),d=!1,e=null;return(e=this.__map[c])&&(d=!!e.find(a)),d},concat:function(a){if(a instanceof this._static){for(var b=new this._static,c=a.entrySet().concat(this.entrySet()),d=c.length-1;d>=0;d--){var e=c[d];b.put(e.key,e.value)}return b}throw new TypeError("When joining hashtables the joining arg must be a HashTable")},filter:function(b,c){var d=this.entrySet(),e=new this._static;d=a.filter(d,b,c);for(var f=d.length-1;f>=0;f--){var g=d[f];e.put(g.key,g.value)}return e},forEach:function(b,c){var d=this.entrySet();a.forEach(d,b,c)},every:function(b,c){var d=this.entrySet();return a.every(d,b,c)},map:function(b,c){var d=this.entrySet();return a.map(d,b,c)},some:function(b,c){var d=this.entrySet();return a.some(d,b,c)},reduce:function(b,c){var d=this.entrySet();return a.reduce(d,b,c)},reduceRight:function(b,c){var d=this.entrySet();return a.reduceRight(d,b,c)},clear:function(){this.__map={}},keys:function(){var a=[],b=this.__map;for(var c in b)a=a.concat(b[c].getKeys());return a},values:function(){var a=[],b=this.__map;for(var c in b)a=a.concat(b[c].getValues());return a},isEmpty:function(){return 0===this.keys().length}}})}void 0!==c?void 0!==b&&b.exports&&(b.exports=d(a("extended")().register("declare",a("declare.js")).register(a("is-extended")).register(a("array-extended")))):"function"==typeof define?define(["extended","declare","is-extended","array-extended"],function(a,b,c,e){return d(a().register("declare",b).register(c).register(e))}):this.Ht=d(this.extended().register("declare",this.declare).register(this.isExtended).register(this.arrayExtended))}).call(this)},{"array-extended":52,"declare.js":55,extended:56,"is-extended":66}],66:[function(a,b,c){var d=a("__browserify_Buffer").Buffer;(function(){"use strict";function e(a){function b(a,b){var c=-1,d=0,e=a.length,f=[];for(b=b||0,c+=b;++c<e;)f[d++]=a[c];return f}function c(a){var b=[];for(var c in a)T.call(a,c)&&b.push(c);return b}function e(a,b){if(a===b)return!0;if(void 0!==d&&d.isBuffer(a)&&d.isBuffer(b)){if(a.length!==b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0}return q(a)&&q(b)?a.getTime()===b.getTime():p(a)&&p(b)?a.source===b.source&&a.global===b.global&&a.multiline===b.multiline&&a.lastIndex===b.lastIndex&&a.ignoreCase===b.ignoreCase:(!r(a)||!r(b)||a===b)&&("object"!=typeof a&&"object"!=typeof b?a===b:f(a,b))}function f(a,b){var d;if(m(a)||m(b))return!1;if(a.prototype!==b.prototype)return!1;if(W(a))return!!W(b)&&(a=S.call(a),b=S.call(b),e(a,b));try{var f,g=c(a),h=c(b);if(g.length!==h.length)return!1;for(g.sort(),h.sort(),f=g.length-1;f>=0;f--)if(g[f]!==h[f])return!1;for(f=g.length-1;f>=0;f--)if(d=g[f],!e(a[d],b[d]))return!1}catch(a){return!1}return!0}function g(a){return null!==a&&"object"==typeof a}function h(a){return g(a)&&a.constructor===Object&&!a.nodeType&&!a.setInterval}function i(a){return W(a)?0===a.length:g(a)?0===c(a).length:!r(a)&&!X(a)||0===a.length}function j(a){return!0===a||!1===a||"[object Boolean]"===U.call(a)}function k(a){return void 0===a}function l(a){return!k(a)}function m(a){return k(a)||n(a)}function n(a){return null===a}function o(a,b){return!!V(b)&&a instanceof b}function p(a){return"[object RegExp]"===U.call(a)}function q(a){return"[object Date]"===U.call(a)}function r(a){return"[object String]"===U.call(a)}function s(a){return"[object Number]"===U.call(a)}function t(a){return!0===a}function u(a){return!1===a}function v(a){return!n(a)}function w(a,b){return a==b}function x(a,b){return a!=b}function y(a,b){return a===b}function z(a,b){return a!==b}function A(a,b){if(X(b)&&Array.prototype.indexOf||r(b))return b.indexOf(a)>-1;if(X(b))for(var c=0,d=b.length;c<d;c++)if(w(a,b[c]))return!0;return!1}function B(a,b){return!A(a,b)}function C(a,b){return a<b}function D(a,b){return a<=b}function E(a,b){return a>b}function F(a,b){return a>=b}function G(a,b){return r(b)?null!==(""+a).match(b):!!p(b)&&b.test(a)}function H(a,b){return!G(a,b)}function I(a,b){return A(b,a)}function J(a,b){return!A(b,a)}function K(a,b,c){return!!(X(a)&&a.length>c)&&w(a[c],b)}function L(a,b,c){return!!X(a)&&!w(a[c],b)}function M(a,b){return T.call(a,b)}function N(a,b){return!M(a,b)}function O(a,b){return!!M(a,"length")&&a.length===b}function P(a,b){return!!M(a,"length")&&a.length!==b}function Q(a){Z[a]=function(){this._testers.push(Y[a])}}function R(a){$[a]=function(){var c,d=b(arguments,1),e=Y[a],f=!0;if(d.length<=e.length-1)throw new TypeError("A handler must be defined when calling using switch");if(c=d.pop(),j(c)&&(f=c,c=d.pop()),!V(c))throw new TypeError("handler must be defined");this._cases.push(function(a){return e.apply(Y,a.concat(d))?[f,c.apply(this,a)]:[!1]})}}var S=Array.prototype.slice,T=Object.prototype.hasOwnProperty,U=Object.prototype.toString,V=function(a){return"[object Function]"===U.call(a)};"undefined"==typeof window||V(window.alert)||function(a){V=function(b){return"[object Function]"===U.call(b)||b===a}}(window.alert);var W=function(a){return"[object Arguments]"===U.call(a)};W(arguments)||(W=function(a){return!(!a||!T.call(a,"callee"))});var X=Array.isArray||function(a){return"[object Array]"===U.call(a)},Y={isFunction:V,isObject:g,isEmpty:i,isHash:h,isNumber:s,isString:r,isDate:q,isArray:X,isBoolean:j,isUndefined:k,isDefined:l,isUndefinedOrNull:m,isNull:n,isArguments:W,instanceOf:o,isRegExp:p,deepEqual:e,isTrue:t,isFalse:u,isNotNull:v,isEq:w,isNeq:x,isSeq:y,isSneq:z,isIn:A,isNotIn:B,isLt:C,isLte:D,isGt:E,isGte:F,isLike:G,isNotLike:H,contains:I,notContains:J,has:M,notHas:N,isLength:O,isNotLength:P,containsAt:K,notContainsAt:L},Z={constructor:function(){this._testers=[]},noWrap:{tester:function(){var a=this._testers;return function(b){for(var c=!1,d=0,e=a.length;d<e&&!c;d++)c=a[d](b);return c}}}},$={constructor:function(){this._cases=[],this.__default=null},def:function(a,b){this.__default=b},noWrap:{switcher:function(){var a=this._cases,c=this.__default;return function(){for(var d,e=!1,f=b(arguments),g=0,h=a.length;g<h&&!e;g++)if(d=a[g](f),d.length>1&&(d[1]||d[0]))return d[1];if(!e&&c)return c.apply(this,f)}}}};for(var _ in Y)T.call(Y,_)&&(R(_),Q(_));var aa=a.define(Y).expose(Y);return aa.tester=a.define(Z),aa.switcher=a.define($),aa}void 0!==c?void 0!==b&&b.exports&&(b.exports=e(a("extended"))):"function"==typeof define&&define.amd?define(["extended"],function(a){return e(a)}):this.isExtended=e(this.extended)}).call(this)},{__browserify_Buffer:63,extended:56}],67:[function(a,b,c){(function(){"use strict";function d(a){function b(a,b){return a>b?1:a<b?-1:b?0:1}var c=a.multiply,d=a.declare({instance:{__printNode:function(b,d){var e=[];a.isUndefinedOrNull(b)?(e.push(c("\t",d)),e.push("~"),console.log(e.join(""))):(this.__printNode(b.right,d+1),e.push(c("\t",d)),e.push(b.data+"\n"),console.log(e.join("")),this.__printNode(b.left,d+1))},constructor:function(a){a=a||{},this.compare=a.compare||b,this.__root=null},insert:function(){throw new Error("Not Implemented")},remove:function(){throw new Error("Not Implemented")},clear:function(){this.__root=null},isEmpty:function(){return!this.__root},traverseWithCondition:function(a,b,c){var e=!0;return a&&(b=b||d.PRE_ORDER,b===d.PRE_ORDER?(e=c(a.data))&&(e=this.traverseWithCondition(a.left,b,c))&&(e=this.traverseWithCondition(a.right,b,c)):b===d.IN_ORDER?(e=this.traverseWithCondition(a.left,b,c))&&(e=c(a.data))&&(e=this.traverseWithCondition(a.right,b,c)):b===d.POST_ORDER?(e=this.traverseWithCondition(a.left,b,c))&&(e&&(e=this.traverseWithCondition(a.right,b,c)),e&&(e=c(a.data))):b===d.REVERSE_ORDER&&(e=this.traverseWithCondition(a.right,b,c))&&(e=c(a.data))&&(e=this.traverseWithCondition(a.left,b,c))),e},traverse:function(a,b,c){a&&(b=b||d.PRE_ORDER,b===d.PRE_ORDER?(c(a.data),this.traverse(a.left,b,c),this.traverse(a.right,b,c)):b===d.IN_ORDER?(this.traverse(a.left,b,c),c(a.data),this.traverse(a.right,b,c)):b===d.POST_ORDER?(this.traverse(a.left,b,c),this.traverse(a.right,b,c),c(a.data)):b===d.REVERSE_ORDER&&(this.traverse(a.right,b,c),c(a.data),this.traverse(a.left,b,c)))},forEach:function(a,b,c){if("function"!=typeof a)throw new TypeError;c=c||d.IN_ORDER,b=b||this,this.traverse(this.__root,c,function(c){a.call(b,c,this)})},map:function(a,b,c){if("function"!=typeof a)throw new TypeError;c=c||d.IN_ORDER,b=b||this;var e=new this._static;return this.traverse(this.__root,c,function(c){e.insert(a.call(b,c,this))}),e},filter:function(a,b,c){if("function"!=typeof a)throw new TypeError;c=c||d.IN_ORDER,b=b||this;var e=new this._static;return this.traverse(this.__root,c,function(c){a.call(b,c,this)&&e.insert(c)}),e},reduce:function(b,c,d){var e=this.toArray(d),f=[e,b];return a.isUndefinedOrNull(c)||f.push(c),a.reduce.apply(a,f)},reduceRight:function(b,c,d){var e=this.toArray(d),f=[e,b];return a.isUndefinedOrNull(c)||f.push(c),a.reduceRight.apply(a,f)},every:function(a,b,c){if("function"!=typeof a)throw new TypeError;c=c||d.IN_ORDER,b=b||this;var e=!1;return this.traverseWithCondition(this.__root,c,function(c){return e=a.call(b,c,this)}),e},some:function(a,b,c){if("function"!=typeof a)throw new TypeError;c=c||d.IN_ORDER,b=b||this;var e;return this.traverseWithCondition(this.__root,c,function(c){return!(e=a.call(b,c,this))}),e},toArray:function(a){a=a||d.IN_ORDER;var b=[];return this.traverse(this.__root,a,function(a){b.push(a)}),b},contains:function(a){for(var b=!1,c=this.__root;null!==c;){var d=this.compare(a,c.data);d?c=c[-1===d?"left":"right"]:(b=!0,c=null)}return b},find:function(a){for(var b,c=this.__root;c;){var d=this.compare(a,c.data);if(!d){b=c.data;break}c=c[-1===d?"left":"right"]}return b},findLessThan:function(a,b){var c=[],e=this.compare;return this.traverseWithCondition(this.__root,d.IN_ORDER,function(d){var f=e(a,d);return(!b&&0===f||1===f)&&(c.push(d),!0)}),c},findGreaterThan:function(a,b){var c=[],e=this.compare;return this.traverse(this.__root,d.REVERSE_ORDER,function(d){var f=e(a,d);return(!b&&0===f||-1===f)&&(c.push(d),!0)}),c},print:function(){this.__printNode(this.__root,0)}},static:{PRE_ORDER:"pre_order",IN_ORDER:"in_order",POST_ORDER:"post_order",REVERSE_ORDER:"reverse_order"}}),e=function(){function a(a,b,c){var d=a.__root;if(null===d||void 0===d)a.__root=f(b);else{for(var g,h=d,i=[],k=[],l=0;;){if(g=i[l]=-1===c(b,h.data)?"left":"right",k[l++]=h,!h[g]){h[g]=f(b);break}h=h[g]}if(!h[g])return null;for(;--l>=0&&(k[l].balance+="right"===i[l]?-1:1,0!==k[l].balance);)if(e(k[l].balance)>1){k[l]=j(k[l],i[l]),0!==l?k[l-1][i[l-1]]=k[l]:a.__root=k[0];break}}}function b(a,b,c){var d=a.__root;if(null!==d&&void 0!==d){for(var f,g,h=d,i=0,j=[],l=[],m={done:!1};;){if(!h)return;if(0===(g=c(b,h.data)))break;f=l[i]=-1===g?"left":"right",j[i++]=h,h=h[f]}var n=h.left,o=h.right;if(n&&o){var p=n;for(l[i]="left",j[i++]=h;p.right;)l[i]="right",j[i++]=p,p=p.right;h.data=p.data,j[i-1][j[i-1]===h?"left":"right"]=p.left}else f=n?"left":"right",0!==i?j[i-1][l[i-1]]=h[f]:a.__root=h[f];for(;--i>=0&&!m.done&&(j[i].balance+="left"===l[i]?-1:1,1!==e(j[i].balance));)e(j[i].balance)>1&&(j[i]=k(j[i],l[i],m),0!==i?j[i-1][l[i-1]]=j[i]:a.__root=j[0])}}var e=Math.abs,f=function(a){return{data:a,balance:0,left:null,right:null}},g=function(a,b,c){var d=a[c];return a[c]=d[b],d[b]=a,d},h=function(a,b,c){return a[c]=g(a[c],c,b),g(a,b,c)},i=function(a,b,c){var d="left"===b?"right":"left",e=a[b],f=e[d];0===f.balance?a.balance=e.balance=0:f.balance===c?(a.balance=-c,e.balance=0):(a.balance=0,e.balance=c),f.balance=0},j=function(a,b){var c="left"===b?"right":"left",d=a[b],e="right"===b?-1:1;return d.balance===e?(a.balance=d.balance=0,a=g(a,c,b)):(i(a,b,e),a=h(a,c,b)),a},k=function(a,b,c){var d="left"===b?"right":"left",e=a[d],f="right"===b?-1:1;return e.balance===-f?(a.balance=e.balance=0,a=g(a,b,d)):e.balance===f?(i(a,d,-f),a=h(a,b,d)):(a.balance=-f,e.balance=f,a=g(a,b,d),c.done=!0),a};return d.extend({instance:{insert:function(b){a(this,b,this.compare)},remove:function(a){b(this,a,this.compare)},__printNode:function(a,b){var d=[];a?(this.__printNode(a.right,b+1),d.push(c("\t",b)),d.push(a.data+":"+a.balance+"\n"),console.log(d.join("")),this.__printNode(a.left,b+1)):(d.push(c("\t",b)),d.push("~"),console.log(d.join("")))}}})}(),f=function(){function a(a,b){return{data:a,level:b,left:g,right:g}}function b(a){if(0!==a.level&&a.left.level===a.level){var b=a.left;a.left=b.right,b.right=a,a=b}return a}function e(a){if(0!==a.level&&a.right.right.level===a.level){var b=a.right;a.right=b.left,b.left=a,a=b,a.level++}return a}function f(c,d,h){if(c===g)c=a(d,1);else{var i=-1===h(d,c.data)?"left":"right";c[i]=f(c[i],d,h),c=b(c),c=e(c)}return c}var g={level:0,data:null},h=function(a,c,d){var f,i;if(a!==g){var j=d(c,a.data);if(0===j)if(f=a.left,i=a.right,f!==g&&i!==g){for(var k=f;k.right!==g;)k=k.right;a.data=k.data,a.left=h(f,k.data,d)}else a=a[f===g?"right":"left"];else{var l=-1===j?"left":"right";a[l]=h(a[l],c,d)}}if(a!==g){var m=a.level,n=a.left.level,o=a.right.level;(n<m-1||o<m-1)&&(o>--a.level&&(a.right.level=a.level),a=b(a),a=e(a))}return a};return d.extend({instance:{isEmpty:function(){return this.__root===g||this._super(arguments)},insert:function(a){this.__root||(this.__root=g),this.__root=f(this.__root,a,this.compare)},remove:function(a){this.__root=h(this.__root,a,this.compare)},traverseWithCondition:function(a){return a===g||this._super(arguments)},traverse:function(a){a!==g&&this._super(arguments)},contains:function(){return this.__root!==g&&this._super(arguments)},__printNode:function(a,b){var d=[];a&&a.data?(this.__printNode(a.right,b+1),d.push(c("\t",b)),d.push(a.data+":"+a.level+"\n"),console.log(d.join("")),this.__printNode(a.left,b+1)):(d.push(c("\t",b)),d.push("~"),console.log(d.join("")))}}})}(),g=d.extend({instance:{insert:function(a){if(!this.__root)return this.__root={data:a,parent:null,left:null,right:null},this.__root;for(var b=this.compare,c=this.__root;null!==c;){var d=b(a,c.data);if(!d)return;var e=-1===d?"left":"right",f=c[e];if(!f)return c[e]={data:a,parent:c,left:null,right:null};c=f}},remove:function(a){if(null!==this.__root){for(var b,c={right:this.__root},d=c,e=null,f="right";null!==d[f];){b=d,d=d[f];var g=this.compare(a,d.data);g||(e=d),f=-1===g?"left":"right"}null!==e&&(e.data=d.data,b[b.right===d?"right":"left"]=d[null===d.left?"right":"left"]),this.__root=c.right}}}}),h=function(){var a=function(a){return null!==a&&a.red},b=function(a){return{data:a,red:!0,left:null,right:null}},e=function(c,d,h){if(!c)return b(d);var i=h(d,c.data);if(i){var j=-1===i?"left":"right",k="left"===j?"right":"left";c[j]=e(c[j],d,h);var l=c[j];if(a(l)){var m=c[k];a(m)?(c.red=!0,l.red=!1,m.red=!1):a(l[j])?c=f(c,k):a(l[k])&&(c=g(c,k))}}return c},f=function(a,b){var c="left"===b?"right":"left",d=a[c];return a[c]=d[b],d[b]=a,a.red=!0,d.red=!1,d},g=function(a,b){var c="left"===b?"right":"left";return a[c]=f(a[c],c),f(a,b)},h=function(b,c,d,e){if(b){var f;if(0===e(c,b.data)){if(!b.left||!b.right){var g=b[b.left?"left":"right"];return a(b)?d.done=!0:a(g)&&(g.red=!1,d.done=!0),g}for(var j,k=b.right;null!==k.left;)j=k,k=k.left;j&&(j.left=null),b.data=k.data,c=k.data}f=-1===e(c,b.data)?"left":"right",b[f]=h(b[f],c,d,e),d.done||(b=i(b,f,d))}else d.done=!0;return b},i=function(b,c,d){var e="left"===c?"right":"left",h=b,i=h[e];if(a(i)&&(b=f(b,c),i=h[e]),null!==i)if(a(i.left)||a(i.right)){var j=h.red,k=b===h;h=(a(i[e])?f:g)(h,c),h.red=j,h.left.red=h.right.red=0,k?b=h:b[c]=h,d.done=!0}else a(h)&&(d.done=!0),h.red=0,i.red=1;return b};return d.extend({instance:{insert:function(a){this.__root=e(this.__root,a,this.compare),this.__root.red=!1},remove:function(a){var b={done:!1},c=h(this.__root,a,b,this.compare);return null!==c&&(c.red=0),this.__root=c,a},__printNode:function(a,b){var d=[];a?(this.__printNode(a.right,b+1),d.push(c("\t",b)),d.push((a.red?"RED":"BLACK")+":"+a.data+"\n"),console.log(d.join("")),this.__printNode(a.left,b+1)):(d.push(c("\t",b)),d.push("~"),console.log(d.join("")))}}})}();return{Tree:d,AVLTree:e,AnderssonTree:f,BinaryTree:g,RedBlackTree:h,IN_ORDER:d.IN_ORDER,PRE_ORDER:d.PRE_ORDER,POST_ORDER:d.POST_ORDER,REVERSE_ORDER:d.REVERSE_ORDER}}void 0!==c?void 0!==b&&b.exports&&(b.exports=d(a("extended")().register("declare",a("declare.js")).register(a("is-extended")).register(a("array-extended")).register(a("string-extended")))):"function"==typeof define?define(["extended","declare.js","is-extended","array-extended","string-extended"],function(a,b,c,e,f){return d(a().register("declare",b).register(c).register(e).register(f))}):this.leafy=d(this.extended().register("declare",this.declare).register(this.isExtended).register(this.arrayExtended).register(this.stringExtended))}).call(this)},{"array-extended":52,"declare.js":55,extended:56,"is-extended":66,"string-extended":70}],68:[function(a,b,c){(function(){"use strict";function d(a,b,c){function d(a,b){var c,d;for(c in b)t.call(b,c)&&(d=b[c],c in a&&a[c]===d||(a[c]=d));return a}function e(a,b){var c,d,f;for(c in b)t.call(b,c)&&(d=b[c],f=a[c],p(f,d)||(r(f)&&r(d)?a[c]=e(f,d):r(d)?a[c]=e({},d):a[c]=d));return a}function f(a){a||(a={});for(var b=1,c=arguments.length;b<c;b++)d(a,arguments[b]);return a}function g(a){a||(a={});for(var b=1,c=arguments.length;b<c;b++)e(a,arguments[b]);return a}function h(a,b){return f(a.prototype||a,b),a}function i(a,b,c){if(!r(a)||!u(b))throw new TypeError;for(var d,e=l(a),f=0,g=e.length;f<g;++f)d=e[f],b.call(c||a,a[d],d,a);return a}function j(a,b,c){if(!r(a)||!u(b))throw new TypeError;for(var d,e,f=l(a),g={},h=0,i=f.length;h<i;++h)d=f[h],e=a[d],b.call(c||a,e,d,a)&&(g[d]=e);return g}function k(a){if(!r(a))throw new TypeError;for(var b=l(a),c=[],d=0,e=b.length;d<e;++d)c.push(a[b[d]]);return c}function l(a){if(!r(a))throw new TypeError;var b=[];for(var c in a)t.call(a,c)&&b.push(c);return b}function m(a){if(!r(a))throw new TypeError;for(var b,c=l(a),d={},e=0,f=c.length;e<f;++e)b=c[e],d[a[b]]=b;return d}function n(a){if(!r(a))throw new TypeError;for(var b,c=l(a),d=[],e=0,f=c.length;e<f;++e)b=c[e],d.push([b,a[b]]);return d}function o(a,b){if(!r(a))throw new TypeError;q(b)&&(b=[b]);for(var c,d=s(l(a),b),e={},f=0,g=d.length;f<g;++f)c=d[f],e[c]=a[c];return e}var p=b.deepEqual,q=b.isString,r=b.isHash,s=c.difference,t=Object.prototype.hasOwnProperty,u=b.isFunction,v={forEach:i,filter:j,invert:m,values:k,toArray:n,keys:l,omit:o},w={extend:h,merge:f,deepMerge:g,omit:o},x=a.define(b.isObject,w).define(r,v).define(b.isFunction,{extend:h}).expose({hash:v}).expose(w),y=x.extend;return x.extend=function(){if(1===arguments.length)return y.extend.apply(x,arguments);h.apply(null,arguments)},x}void 0!==c?void 0!==b&&b.exports&&(b.exports=d(a("extended"),a("is-extended"),a("array-extended"))):"function"==typeof define&&define.amd?define(["extended","is-extended","array-extended"],function(a,b,c){return d(a,b,c)}):this.objectExtended=d(this.extended,this.isExtended,this.arrayExtended)}).call(this)},{"array-extended":52,extended:56,"is-extended":66}],69:[function(a,b,c){var d=a("__browserify_process");(function(){"use strict";function e(a,b,c,e,f,g){function h(a,b){return function(){try{l(a.apply(null,arguments)).addCallback(b).addErrback(b)}catch(a){b.errback(a)}}}function i(a,b,c){var d=(new G).callback();return v(a,function(a){d=d.then(c?a:B(null,a)),c||(d=d.then(function(a){return b.push(a),b}))}),d}function j(a){return!w(a)&&y(a.then)}function k(a){var b=new G;return a.then(A(b,"callback"),A(b,"errback")),b.promise()}function l(a){var b;return a=C(arguments),a.length?1===a.length?(a=a.pop(),j(a)?a.addCallback&&a.addErrback?(b=new G,a.addCallback(b.callback),a.addErrback(b.errback)):b=k(a):b=x(a)&&c.every(a,j)?new H(a,!0).promise():(new G).callback(a)):b=new H(c.map(a,function(a){return l(a)}),!0).promise():b=(new G).callback(a).promise(),b}function m(a,b){return function(){var c=new G,d=C(arguments);return d.push(c.resolve),a.apply(b||this,d),c.promise()}}function n(a){if(x(a))return i(a,[],!1);throw new Error("When calling promise.serial the first argument must be an array")}function o(a){if(x(a))return i(a,[],!0);throw new Error("When calling promise.serial the first argument must be an array")}function p(a,b){a=C(arguments);var c=!1;b=a.pop();var d=l(a);return function(){return c?l(b.apply(this,arguments)):(a=arguments,d.then(A(this,function(){return c=!0,b.apply(this,a)})))}}function q(){return new G}function r(a){return new H(a,!0).promise()}function s(a){return q().errback(a)}function t(a){return q().callback(a)}var u,v=c.forEach,w=e.isUndefinedOrNull,x=e.isArray,y=e.isFunction,z=e.isBoolean,A=f.bind,B=f.bindIgnore,C=g.argsToArray;if("function"==typeof setImmediate)u="undefined"!=typeof window?setImmediate.bind(window):setImmediate;else if(void 0!==d)u=function(a){d.nextTick(a)};else if("undefined"!=typeof MessageChannel){var D=new MessageChannel,E={},F=E;D.port1.onmessage=function(){E=E.next;var a=E.task;delete E.task,a()},u=function(a){F=F.next={task:a},D.port2.postMessage(0)}}else u=function(a){setTimeout(a,0)};var G=a({instance:{__fired:!1,__results:null,__error:null,__errorCbs:null,__cbs:null,constructor:function(){this.__errorCbs=[],this.__cbs=[],f.bindAll(this,["callback","errback","resolve","classic","__resolve","addCallback","addErrback"])},__resolve:function(){if(!this.__fired){this.__fired=!0;var a,b=this.__error?this.__errorCbs:this.__cbs,c=b.length,d=this.__error||this.__results;for(a=0;a<c;a++)this.__callNextTick(b[a],d)}},__callNextTick:function(a,b){u(function(){a.apply(this,b)})},addCallback:function(a){return a&&(j(a)&&a.callback&&(a=a.callback),this.__fired&&this.__results?this.__callNextTick(a,this.__results):this.__cbs.push(a)),this},addErrback:function(a){return a&&(j(a)&&a.errback&&(a=a.errback),this.__fired&&this.__error?this.__callNextTick(a,this.__error):this.__errorCbs.push(a)),this},callback:function(a){return this.__fired||(this.__results=arguments,this.__resolve()),this.promise()},errback:function(a){return this.__fired||(this.__error=arguments,this.__resolve()),this.promise()},resolve:function(a,b){return a?this.errback(a):this.callback.apply(this,C(arguments,1)),this},classic:function(a){return"function"==typeof a&&(this.addErrback(function(b){a(b)}),this.addCallback(function(){a.apply(this,[null].concat(C(arguments)))})),this},then:function(a,b){var c=new G,d=c;return y(b)&&(d=h(b,c)),this.addErrback(d),y(a)?this.addCallback(h(a,c)):this.addCallback(c),c.promise()},both:function(a){return this.then(a,a)},promise:function(){var a={then:A(this,"then"),both:A(this,"both"),promise:function(){return a}};return v(["addCallback","addErrback","classic"],function(b){a[b]=A(this,function(){return this[b].apply(this,arguments),a})},this),a}}}),H=G.extend({instance:{__results:null,__errors:null,__promiseLength:0,__defLength:0,__firedLength:0,normalizeResults:!1,constructor:function(a,b){this.__errors=[],this.__results=[],this.normalizeResults=!!z(b)&&b,this._super(arguments),a&&a.length?(this.__defLength=a.length,v(a,this.__addPromise,this)):this.__resolve()},__addPromise:function(a,b){a.then(A(this,function(){var a=C(arguments);a.unshift(b),this.callback.apply(this,a)}),A(this,function(){var a=C(arguments);a.unshift(b),this.errback.apply(this,a)}))},__resolve:function(){if(!this.__fired){this.__fired=!0;var a,b=this.__errors.length?this.__errorCbs:this.__cbs,c=b.length,d=this.__errors.length?this.__errors:this.__results;for(a=0;a<c;a++)this.__callNextTick(b[a],d)}},__callNextTick:function(a,b){u(function(){a.apply(null,[b])})},addCallback:function(a){return a&&(j(a)&&a.callback&&(a=A(a,"callback")),this.__fired&&!this.__errors.length?this.__callNextTick(a,this.__results):this.__cbs.push(a)),this},addErrback:function(a){return a&&(j(a)&&a.errback&&(a=A(a,"errback")),this.__fired&&this.__errors.length?this.__callNextTick(a,this.__errors):this.__errorCbs.push(a)),this},callback:function(a){if(this.__fired)throw new Error("Already fired!");var b=C(arguments);return this.normalizeResults&&(b=b.slice(1),b=1===b.length?b.pop():b),this.__results[a]=b,this.__firedLength++,this.__firedLength===this.__defLength&&this.__resolve(),this.promise()},errback:function(a){if(this.__fired)throw new Error("Already fired!");var b=C(arguments);return this.normalizeResults&&(b=b.slice(1),b=1===b.length?b.pop():b),this.__errors[a]=b,this.__firedLength++,this.__firedLength===this.__defLength&&this.__resolve(),this.promise()}}});return b.define({isPromiseLike:j}).expose({isPromiseLike:j,when:l,wrap:m,wait:p,serial:n,chain:o,Promise:G,PromiseList:H,promise:q,defer:q,deferredList:r,reject:s,resolve:t})}void 0!==c?void 0!==b&&b.exports&&(b.exports=e(a("declare.js"),a("extended"),a("array-extended"),a("is-extended"),a("function-extended"),a("arguments-extended"))):"function"==typeof define&&define.amd?define(["declare","extended","array-extended","is-extended","function-extended","arguments-extended"],function(a,b,c,d,f,g){return e(a,b,c,d,f,g)}):this.promiseExtended=e(this.declare,this.extended,this.arrayExtended,this.isExtended,this.functionExtended,this.argumentsExtended)}).call(this)},{__browserify_process:64,"arguments-extended":51,"array-extended":52,"declare.js":55,extended:56,"function-extended":59,"is-extended":66}],70:[function(a,b,c){(function(){"use strict";function d(a,b,c,d){function e(a,b){var c=a;if(x.test(b)){var d=b.match(x),e=d[1],f=d[3],g=d[4];g&&(g=parseInt(g,10),c=c.length<g?h(c,g,f,e):i(c,g))}return c}function f(a,c){var d;if(!b.isNumber(a))throw new Error("stringExtended.format : when using %d the parameter must be a number!");if(d=""+a,x.test(c)){var e=c.match(x),f=e[1],g=e[2],j=e[3],k=e[4];g&&(d=(a>0?"+":"")+d),k&&(k=parseInt(k,10),d=d.length<k?h(d,k,j||"0",f):i(d,k))}return d}function g(a,b){var c,d=b.match(y),e=0;d&&(e=parseInt(d[0],10),isNaN(e)&&(e=0));try{c=s(a,null,e)}catch(b){throw new Error("stringExtended.format : Unable to parse json from ",a)}return c}function h(a,b,c,d){a=""+a,c=c||" ";for(var e=a.length;e<b;)d?a+=c:a=c+a,e++;return a}function i(a,c,d){var e=a;if(b.isString(e)){if(a.length>c)if(d){var f=a.length;e=a.substring(f-c,f)}else e=a.substring(0,c)}else e=i(""+e,c);return e}function j(a,d){if(d instanceof Array){var h=0,i=d.length;return a.replace(v,function(a,b,j){var k,l;if(!(h<i))return a;if(k=d[h++],"%s"===a||"%d"===a||"%D"===a)l=k+"";else if("%Z"===a)l=k.toUTCString();else if("%j"===a)try{l=s(k)}catch(a){throw new Error("stringExtended.format : Unable to parse json from ",k)}else switch(b=b.replace(/^\[|\]$/g,""),j){case"s":l=e(k,b);break;case"d":l=f(k,b);break;case"j":l=g(k,b);break;case"D":l=c.format(k,b);break;case"Z":l=c.format(k,b,!0)}return l})}return t(d)?a.replace(w,function(a,h,i){if(i=d[i],!b.isUndefined(i)){if(!h)return""+i;if(b.isString(i))return e(i,h);if(b.isNumber(i))return f(i,h);if(b.isDate(i))return c.format(i,h);if(b.isObject(i))return g(i,h)}return a}):j(a,u.call(arguments).slice(1))}function k(a,b){var c=[];return a&&(a.indexOf(b)>0?c=a.replace(/\s+/g,"").split(b):c.push(a)),c}function l(a,b){var c=[];if(b)for(var d=0;d<b;d++)c.push(a);return c.join("")}function m(a,c){var d,e,f;if(c)if(b.isArray(a))for(d=[],e=0,f=a.length;e<f;e++)d.push(m(a[e],c));else if(c instanceof Array)for(d=a,e=0,f=c.length;e<f;e++)d=m(d,c[e]);else c in z&&(d="["+z[c]+"m"+a+"[0m");return d}function n(a,b){return a.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,function(a){return b&&-1!==d.indexOf(b,a)?a:"\\"+a})}function o(a){return a.replace(/^\s*|\s*$/g,"")}function p(a){return a.replace(/^\s*/,"")}function q(a){return a.replace(/\s*$/,"")}function r(a){return 0===a.length}var s;"undefined"==typeof JSON?function(){function a(a){return a<10?"0"+a:a}function c(c){return b.isDate(c)?isFinite(c.valueOf())?c.getUTCFullYear()+"-"+a(c.getUTCMonth()+1)+"-"+a(c.getUTCDate())+"T"+a(c.getUTCHours())+":"+a(c.getUTCMinutes())+":"+a(c.getUTCSeconds())+"Z":null:i(c)?c.valueOf():c}function d(a){return j.lastIndex=0,j.test(a)?'"'+a.replace(j,function(a){var b=k[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function e(a,b){var i,j,k,l,m,n=f,o=b[a];switch(o&&(o=c(o)),"function"==typeof h&&(o=h.call(b,a,o)),typeof o){case"string":return d(o);case"number":return isFinite(o)?String(o):"null";case"boolean":case"null":return String(o);case"object":if(!o)return"null";if(f+=g,m=[],"[object Array]"===Object.prototype.toString.apply(o)){for(l=o.length,i=0;i<l;i+=1)m[i]=e(i,o)||"null";return k=0===m.length?"[]":f?"[\n"+f+m.join(",\n"+f)+"\n"+n+"]":"["+m.join(",")+"]",f=n,k}if(h&&"object"==typeof h)for(l=h.length,i=0;i<l;i+=1)"string"==typeof h[i]&&(j=h[i],(k=e(j,o))&&m.push(d(j)+(f?": ":":")+k));else for(j in o)Object.prototype.hasOwnProperty.call(o,j)&&(k=e(j,o))&&m.push(d(j)+(f?": ":":")+k);return k=0===m.length?"{}":f?"{\n"+f+m.join(",\n"+f)+"\n"+n+"}":"{"+m.join(",")+"}",f=n,k}}var f,g,h,i=b.tester().isString().isNumber().isBoolean().tester(),j=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,k={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};s=function(a,b,c){var d;if(f="",g="","number"==typeof c)for(d=0;d<c;d+=1)g+=" ";else"string"==typeof c&&(g=c);if(h=b,b&&"function"!=typeof b&&("object"!=typeof b||"number"!=typeof b.length))throw new Error("JSON.stringify");return e("",{"":a})}}():s=JSON.stringify;var t=b.isHash,u=Array.prototype.slice,v=/%((?:-?\+?.?\d*)?|(?:\[[^\[|\]]*\]))?([sjdDZ])/g,w=/\{(?:\[([^\[|\]]*)\])?(\w+)\}/g,x=/(-?)(\+?)([A-Z|a-z|\W]?)([1-9][0-9]*)?$/,y=/([1-9][0-9]*)$/g,z={bold:1,bright:1,italic:3,underline:4,blink:5,inverse:7,crossedOut:9,red:31,green:32,yellow:33,blue:34,magenta:35,cyan:36,white:37,redBackground:41,greenBackground:42,yellowBackground:43,blueBackground:44,magentaBackground:45,cyanBackground:46,whiteBackground:47,encircled:52,overlined:53,grey:90,black:90},A={SMILEY:"☺",SOLID_SMILEY:"☻",HEART:"♥",DIAMOND:"♦",CLOVE:"♣",SPADE:"♠",DOT:"•",SQUARE_CIRCLE:"◘",CIRCLE:"○",FILLED_SQUARE_CIRCLE:"◙",MALE:"♂",FEMALE:"♀",EIGHT_NOTE:"♪",DOUBLE_EIGHTH_NOTE:"♫",SUN:"☼",PLAY:"►",REWIND:"◄",UP_DOWN:"↕",PILCROW:"¶",SECTION:"§",THICK_MINUS:"▬",SMALL_UP_DOWN:"↨",UP_ARROW:"↑",DOWN_ARROW:"↓",RIGHT_ARROW:"→",LEFT_ARROW:"←",RIGHT_ANGLE:"∟",LEFT_RIGHT_ARROW:"↔",TRIANGLE:"▲",DOWN_TRIANGLE:"▼",HOUSE:"⌂",C_CEDILLA:"Ç",U_UMLAUT:"ü",E_ACCENT:"é",A_LOWER_CIRCUMFLEX:"â",A_LOWER_UMLAUT:"ä",A_LOWER_GRAVE_ACCENT:"à",A_LOWER_CIRCLE_OVER:"å",C_LOWER_CIRCUMFLEX:"ç",E_LOWER_CIRCUMFLEX:"ê",E_LOWER_UMLAUT:"ë",E_LOWER_GRAVE_ACCENT:"è",I_LOWER_UMLAUT:"ï",I_LOWER_CIRCUMFLEX:"î",I_LOWER_GRAVE_ACCENT:"ì",A_UPPER_UMLAUT:"Ä",A_UPPER_CIRCLE:"Å",E_UPPER_ACCENT:"É",A_E_LOWER:"æ",A_E_UPPER:"Æ",O_LOWER_CIRCUMFLEX:"ô",O_LOWER_UMLAUT:"ö",O_LOWER_GRAVE_ACCENT:"ò",U_LOWER_CIRCUMFLEX:"û",U_LOWER_GRAVE_ACCENT:"ù",Y_LOWER_UMLAUT:"ÿ",O_UPPER_UMLAUT:"Ö",U_UPPER_UMLAUT:"Ü",CENTS:"¢",POUND:"£",YEN:"¥",CURRENCY:"¤",PTS:"₧",FUNCTION:"ƒ",A_LOWER_ACCENT:"á",I_LOWER_ACCENT:"í",O_LOWER_ACCENT:"ó",U_LOWER_ACCENT:"ú",N_LOWER_TILDE:"ñ",N_UPPER_TILDE:"Ñ",A_SUPER:"ª",O_SUPER:"º",UPSIDEDOWN_QUESTION:"¿",SIDEWAYS_L:"⌐",NEGATION:"¬",ONE_HALF:"½",ONE_FOURTH:"¼",UPSIDEDOWN_EXCLAMATION:"¡",DOUBLE_LEFT:"«",DOUBLE_RIGHT:"»",LIGHT_SHADED_BOX:"░",MEDIUM_SHADED_BOX:"▒",DARK_SHADED_BOX:"▓",VERTICAL_LINE:"│",MAZE__SINGLE_RIGHT_T:"┤",MAZE_SINGLE_RIGHT_TOP:"┐",MAZE_SINGLE_RIGHT_BOTTOM_SMALL:"┘",MAZE_SINGLE_LEFT_TOP_SMALL:"┌",MAZE_SINGLE_LEFT_BOTTOM_SMALL:"└",MAZE_SINGLE_LEFT_T:"├",MAZE_SINGLE_BOTTOM_T:"┴",MAZE_SINGLE_TOP_T:"┬",MAZE_SINGLE_CENTER:"┼",MAZE_SINGLE_HORIZONTAL_LINE:"─",MAZE_SINGLE_RIGHT_DOUBLECENTER_T:"╡",MAZE_SINGLE_RIGHT_DOUBLE_BL:"╛",MAZE_SINGLE_RIGHT_DOUBLE_T:"╢",MAZE_SINGLE_RIGHT_DOUBLEBOTTOM_TOP:"╖",MAZE_SINGLE_RIGHT_DOUBLELEFT_TOP:"╕",MAZE_SINGLE_LEFT_DOUBLE_T:"╞",MAZE_SINGLE_BOTTOM_DOUBLE_T:"╧",MAZE_SINGLE_TOP_DOUBLE_T:"╤",MAZE_SINGLE_TOP_DOUBLECENTER_T:"╥",MAZE_SINGLE_BOTTOM_DOUBLECENTER_T:"╨",MAZE_SINGLE_LEFT_DOUBLERIGHT_BOTTOM:"╘",MAZE_SINGLE_LEFT_DOUBLERIGHT_TOP:"╒",MAZE_SINGLE_LEFT_DOUBLEBOTTOM_TOP:"╓",MAZE_SINGLE_LEFT_DOUBLETOP_BOTTOM:"╙",MAZE_SINGLE_LEFT_TOP:"Γ",MAZE_SINGLE_RIGHT_BOTTOM:"╜",MAZE_SINGLE_LEFT_CENTER:"╟",MAZE_SINGLE_DOUBLECENTER_CENTER:"╫",MAZE_SINGLE_DOUBLECROSS_CENTER:"╪",MAZE_DOUBLE_LEFT_CENTER:"╣",MAZE_DOUBLE_VERTICAL:"║",MAZE_DOUBLE_RIGHT_TOP:"╗",MAZE_DOUBLE_RIGHT_BOTTOM:"╝",MAZE_DOUBLE_LEFT_BOTTOM:"╚",MAZE_DOUBLE_LEFT_TOP:"╔",MAZE_DOUBLE_BOTTOM_T:"╩",MAZE_DOUBLE_TOP_T:"╦",MAZE_DOUBLE_LEFT_T:"╠",MAZE_DOUBLE_HORIZONTAL:"═",MAZE_DOUBLE_CROSS:"╬",SOLID_RECTANGLE:"█",THICK_LEFT_VERTICAL:"▌",THICK_RIGHT_VERTICAL:"▐",SOLID_SMALL_RECTANGLE_BOTTOM:"▄",SOLID_SMALL_RECTANGLE_TOP:"▀",PHI_UPPER:"Φ",INFINITY:"∞",INTERSECTION:"∩",DEFINITION:"≡",PLUS_MINUS:"±",GT_EQ:"≥",LT_EQ:"≤",THEREFORE:"⌠",SINCE:"∵",DOESNOT_EXIST:"∄",EXISTS:"∃",FOR_ALL:"∀",EXCLUSIVE_OR:"⊕",BECAUSE:"⌡",DIVIDE:"÷",APPROX:"≈",DEGREE:"°",BOLD_DOT:"∙",DOT_SMALL:"·",CHECK:"√",ITALIC_X:"✗",SUPER_N:"ⁿ",SQUARED:"²",CUBED:"³",SOLID_BOX:"■",PERMILE:"‰",REGISTERED_TM:"®",COPYRIGHT:"©",TRADEMARK:"™",BETA:"β",GAMMA:"γ",ZETA:"ζ",ETA:"η",IOTA:"ι",KAPPA:"κ",LAMBDA:"λ",NU:"ν",XI:"ξ",OMICRON:"ο",RHO:"ρ",UPSILON:"υ",CHI_LOWER:"φ",CHI_UPPER:"χ",PSI:"ψ",ALPHA:"α",ESZETT:"ß",PI:"π",SIGMA_UPPER:"Σ",SIGMA_LOWER:"σ",MU:"µ",TAU:"τ",THETA:"Θ",OMEGA:"Ω",DELTA:"δ",PHI_LOWER:"φ",EPSILON:"ε"},B={toArray:k,pad:h,truncate:i,multiply:l,format:j,style:m,escape:n,trim:o,trimLeft:p,trimRight:q,isEmpty:r};return a.define(b.isString,B).define(b.isArray,{style:m}).expose(B).expose({characters:A})}void 0!==c?void 0!==b&&b.exports&&(b.exports=d(a("extended"),a("is-extended"),a("date-extended"),a("array-extended"))):"function"==typeof define&&define.amd?define(["extended","is-extended","date-extended","array-extended"],function(a,b,c,e){return d(a,b,c,e)}):this.stringExtended=d(this.extended,this.isExtended,this.dateExtended,this.arrayExtended)}).call(this)},{"array-extended":52,"date-extended":53,extended:56,"is-extended":66}]},{},[1]),function(a){"object"==typeof exports?module.exports=a():"function"==typeof define&&define.amd?define(a):"undefined"!=typeof window?window.b2wgincart=a():"undefined"!=typeof global?global.b2wgincart=a():"undefined"!=typeof self&&(self.b2wgincart=a())}(function(){var define,module,exports;return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c||a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){!function(a,c){"use strict";"function"==typeof define&&define.amd?define(c):"object"==typeof b&&b.exports?b.exports=c():a.log=c()}(this,function(){"use strict";function a(a,b){var c=a[b];if("function"==typeof c.bind)return c.bind(a);try{return Function.prototype.bind.call(c,a)}catch(b){return function(){return Function.prototype.apply.apply(c,[a,arguments])}}}function b(b){return"debug"===b&&(b="log"),typeof console!==h&&(void 0!==console[b]?a(console,b):void 0!==console.log?a(console,"log"):g)}function c(a,b){for(var c=0;c<i.length;c++){var d=i[c];this[d]=c<a?g:this.methodFactory(d,a,b)}this.log=this.debug}function d(a,b,d){return function(){typeof console!==h&&(c.call(this,b,d),this[a].apply(this,arguments))}}function e(a,c,e){return b(a)||d.apply(this,arguments)}function f(a,b,d){function f(a){var b=(i[a]||"silent").toUpperCase();if(typeof window!==h){try{return void(window.localStorage[l]=b)}catch(a){}try{window.document.cookie=encodeURIComponent(l)+"="+b+";"}catch(a){}}}function g(){var a;if(typeof window!==h){try{a=window.localStorage[l]}catch(a){}if(typeof a===h)try{var b=window.document.cookie,c=b.indexOf(encodeURIComponent(l)+"=");-1!==c&&(a=/^([^;]+)/.exec(b.slice(c))[1])}catch(a){}return void 0===k.levels[a]&&(a=void 0),a}}var j,k=this,l="loglevel";a&&(l+=":"+a),k.name=a,k.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},k.methodFactory=d||e,k.getLevel=function(){return j},k.setLevel=function(b,d){if("string"==typeof b&&void 0!==k.levels[b.toUpperCase()]&&(b=k.levels[b.toUpperCase()]),!("number"==typeof b&&b>=0&&b<=k.levels.SILENT))throw"log.setLevel() called with invalid level: "+b;if(j=b,!1!==d&&f(b),c.call(k,b,a),typeof console===h&&b<k.levels.SILENT)return"No console available for logging"},k.setDefaultLevel=function(a){g()||k.setLevel(a,!1)},k.enableAll=function(a){k.setLevel(k.levels.TRACE,a)},k.disableAll=function(a){k.setLevel(k.levels.SILENT,a)};var m=g();null==m&&(m=null==b?"WARN":b),k.setLevel(m,!1)}var g=function(){},h="undefined",i=["trace","debug","info","warn","error"],j=new f,k={};j.getLogger=function(a){if("string"!=typeof a||""===a)throw new TypeError("You must supply a name when creating a logger.");var b=k[a];return b||(b=k[a]=new f(a,j.getLevel(),j.methodFactory)),b};var l=typeof window!==h?window.log:void 0;return j.noConflict=function(){return typeof window!==h&&window.log===j&&(window.log=l),j},j.getLoggers=function(){return k},j})},{}],2:[function(a,b,c){(function(){var a=this,d=a._,e=Array.prototype,f=Object.prototype,g=Function.prototype,h=e.push,i=e.slice,j=e.concat,k=f.toString,l=f.hasOwnProperty,m=Array.isArray,n=Object.keys,o=g.bind,p=function(a){return a instanceof p?a:this instanceof p?void(this._wrapped=a):new p(a)};void 0!==c?(void 0!==b&&b.exports&&(c=b.exports=p),c._=p):a._=p,p.VERSION="1.7.0";var q=function(a,b,c){if(void 0===b)return a;switch(null==c?3:c){case 1:return function(c){return a.call(b,c)};case 2:return function(c,d){return a.call(b,c,d)};case 3:return function(c,d,e){return a.call(b,c,d,e)};case 4:return function(c,d,e,f){return a.call(b,c,d,e,f)}}return function(){return a.apply(b,arguments)}};p.iteratee=function(a,b,c){return null==a?p.identity:p.isFunction(a)?q(a,b,c):p.isObject(a)?p.matches(a):p.property(a)},p.each=p.forEach=function(a,b,c){if(null==a)return a;b=q(b,c);var d,e=a.length;if(e===+e)for(d=0;d<e;d++)b(a[d],d,a);else{var f=p.keys(a);for(d=0,e=f.length;d<e;d++)b(a[f[d]],f[d],a)}return a},p.map=p.collect=function(a,b,c){if(null==a)return[];b=p.iteratee(b,c);for(var d,e=a.length!==+a.length&&p.keys(a),f=(e||a).length,g=Array(f),h=0;h<f;h++)d=e?e[h]:h,g[h]=b(a[d],d,a);return g};var r="Reduce of empty array with no initial value";p.reduce=p.foldl=p.inject=function(a,b,c,d){null==a&&(a=[]),b=q(b,d,4);var e,f=a.length!==+a.length&&p.keys(a),g=(f||a).length,h=0;if(arguments.length<3){if(!g)throw new TypeError(r);c=a[f?f[h++]:h++]}for(;h<g;h++)e=f?f[h]:h,c=b(c,a[e],e,a);return c},p.reduceRight=p.foldr=function(a,b,c,d){null==a&&(a=[]),b=q(b,d,4);var e,f=a.length!==+a.length&&p.keys(a),g=(f||a).length;if(arguments.length<3){if(!g)throw new TypeError(r);c=a[f?f[--g]:--g]}for(;g--;)e=f?f[g]:g,c=b(c,a[e],e,a);return c},p.find=p.detect=function(a,b,c){var d;return b=p.iteratee(b,c),p.some(a,function(a,c,e){if(b(a,c,e))return d=a,!0}),d},p.filter=p.select=function(a,b,c){var d=[];return null==a?d:(b=p.iteratee(b,c),p.each(a,function(a,c,e){b(a,c,e)&&d.push(a)}),d)},p.reject=function(a,b,c){return p.filter(a,p.negate(p.iteratee(b)),c)},p.every=p.all=function(a,b,c){if(null==a)return!0;b=p.iteratee(b,c);var d,e,f=a.length!==+a.length&&p.keys(a),g=(f||a).length;for(d=0;d<g;d++)if(e=f?f[d]:d,!b(a[e],e,a))return!1;return!0},p.some=p.any=function(a,b,c){if(null==a)return!1;b=p.iteratee(b,c);var d,e,f=a.length!==+a.length&&p.keys(a),g=(f||a).length;for(d=0;d<g;d++)if(e=f?f[d]:d,b(a[e],e,a))return!0;return!1},p.contains=p.include=function(a,b){return null!=a&&(a.length!==+a.length&&(a=p.values(a)),p.indexOf(a,b)>=0)},p.invoke=function(a,b){var c=i.call(arguments,2),d=p.isFunction(b);return p.map(a,function(a){return(d?b:a[b]).apply(a,c)})},p.pluck=function(a,b){return p.map(a,p.property(b))},p.where=function(a,b){return p.filter(a,p.matches(b))},p.findWhere=function(a,b){return p.find(a,p.matches(b))},p.max=function(a,b,c){var d,e,f=-1/0,g=-1/0;if(null==b&&null!=a){a=a.length===+a.length?a:p.values(a);for(var h=0,i=a.length;h<i;h++)(d=a[h])>f&&(f=d)}else b=p.iteratee(b,c),p.each(a,function(a,c,d){((e=b(a,c,d))>g||e===-1/0&&f===-1/0)&&(f=a,g=e)});return f},p.min=function(a,b,c){var d,e,f=1/0,g=1/0;if(null==b&&null!=a){a=a.length===+a.length?a:p.values(a);for(var h=0,i=a.length;h<i;h++)(d=a[h])<f&&(f=d)}else b=p.iteratee(b,c),p.each(a,function(a,c,d){((e=b(a,c,d))<g||e===1/0&&f===1/0)&&(f=a,g=e)});return f},p.shuffle=function(a){for(var b,c=a&&a.length===+a.length?a:p.values(a),d=c.length,e=Array(d),f=0;f<d;f++)b=p.random(0,f),b!==f&&(e[f]=e[b]),e[b]=c[f];return e},p.sample=function(a,b,c){return null==b||c?(a.length!==+a.length&&(a=p.values(a)),a[p.random(a.length-1)]):p.shuffle(a).slice(0,Math.max(0,b))},p.sortBy=function(a,b,c){return b=p.iteratee(b,c),p.pluck(p.map(a,function(a,c,d){return{value:a,index:c,criteria:b(a,c,d)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||void 0===c)return 1;if(c<d||void 0===d)return-1}return a.index-b.index}),"value")};var s=function(a){return function(b,c,d){var e={};return c=p.iteratee(c,d),p.each(b,function(d,f){var g=c(d,f,b);a(e,d,g)}),e}};p.groupBy=s(function(a,b,c){p.has(a,c)?a[c].push(b):a[c]=[b]}),p.indexBy=s(function(a,b,c){a[c]=b}),p.countBy=s(function(a,b,c){p.has(a,c)?a[c]++:a[c]=1}),p.sortedIndex=function(a,b,c,d){c=p.iteratee(c,d,1);for(var e=c(b),f=0,g=a.length;f<g;){var h=f+g>>>1;c(a[h])<e?f=h+1:g=h}return f},p.toArray=function(a){return a?p.isArray(a)?i.call(a):a.length===+a.length?p.map(a,p.identity):p.values(a):[]},p.size=function(a){return null==a?0:a.length===+a.length?a.length:p.keys(a).length},p.partition=function(a,b,c){b=p.iteratee(b,c);var d=[],e=[];return p.each(a,function(a,c,f){(b(a,c,f)?d:e).push(a)}),[d,e]},p.first=p.head=p.take=function(a,b,c){if(null!=a)return null==b||c?a[0]:b<0?[]:i.call(a,0,b)},p.initial=function(a,b,c){return i.call(a,0,Math.max(0,a.length-(null==b||c?1:b)))},p.last=function(a,b,c){if(null!=a)return null==b||c?a[a.length-1]:i.call(a,Math.max(a.length-b,0))},p.rest=p.tail=p.drop=function(a,b,c){return i.call(a,null==b||c?1:b)},p.compact=function(a){return p.filter(a,p.identity)};var t=function(a,b,c,d){if(b&&p.every(a,p.isArray))return j.apply(d,a);for(var e=0,f=a.length;e<f;e++){var g=a[e];p.isArray(g)||p.isArguments(g)?b?h.apply(d,g):t(g,b,c,d):c||d.push(g)}return d};p.flatten=function(a,b){return t(a,b,!1,[])},p.without=function(a){return p.difference(a,i.call(arguments,1))},p.uniq=p.unique=function(a,b,c,d){if(null==a)return[];p.isBoolean(b)||(d=c,c=b,b=!1),null!=c&&(c=p.iteratee(c,d));for(var e=[],f=[],g=0,h=a.length;g<h;g++){var i=a[g];if(b)g&&f===i||e.push(i),f=i;else if(c){var j=c(i,g,a);p.indexOf(f,j)<0&&(f.push(j),e.push(i))}else p.indexOf(e,i)<0&&e.push(i)}return e},p.union=function(){return p.uniq(t(arguments,!0,!0,[]))},p.intersection=function(a){if(null==a)return[];for(var b=[],c=arguments.length,d=0,e=a.length;d<e;d++){var f=a[d];if(!p.contains(b,f)){for(var g=1;g<c&&p.contains(arguments[g],f);g++);g===c&&b.push(f)}}return b},p.difference=function(a){var b=t(i.call(arguments,1),!0,!0,[]);return p.filter(a,function(a){return!p.contains(b,a)})},p.zip=function(a){if(null==a)return[];for(var b=p.max(arguments,"length").length,c=Array(b),d=0;d<b;d++)c[d]=p.pluck(arguments,d);return c},p.object=function(a,b){if(null==a)return{};for(var c={},d=0,e=a.length;d<e;d++)b?c[a[d]]=b[d]:c[a[d][0]]=a[d][1];return c},p.indexOf=function(a,b,c){if(null==a)return-1;var d=0,e=a.length;if(c){if("number"!=typeof c)return d=p.sortedIndex(a,b),a[d]===b?d:-1;d=c<0?Math.max(0,e+c):c}for(;d<e;d++)if(a[d]===b)return d;return-1},p.lastIndexOf=function(a,b,c){if(null==a)return-1;var d=a.length;for("number"==typeof c&&(d=c<0?d+c+1:Math.min(d,c+1));--d>=0;)if(a[d]===b)return d;return-1},p.range=function(a,b,c){arguments.length<=1&&(b=a||0,a=0),c=c||1;for(var d=Math.max(Math.ceil((b-a)/c),0),e=Array(d),f=0;f<d;f++,a+=c)e[f]=a;return e};var u=function(){};p.bind=function(a,b){var c,d;if(o&&a.bind===o)return o.apply(a,i.call(arguments,1));if(!p.isFunction(a))throw new TypeError("Bind must be called on a function");return c=i.call(arguments,2),d=function(){if(!(this instanceof d))return a.apply(b,c.concat(i.call(arguments)));u.prototype=a.prototype;var e=new u;u.prototype=null;var f=a.apply(e,c.concat(i.call(arguments)));return p.isObject(f)?f:e}},p.partial=function(a){var b=i.call(arguments,1);return function(){for(var c=0,d=b.slice(),e=0,f=d.length;e<f;e++)d[e]===p&&(d[e]=arguments[c++]);for(;c<arguments.length;)d.push(arguments[c++]);return a.apply(this,d)}},p.bindAll=function(a){var b,c,d=arguments.length;if(d<=1)throw new Error("bindAll must be passed function names");for(b=1;b<d;b++)c=arguments[b],a[c]=p.bind(a[c],a);return a},p.memoize=function(a,b){var c=function(d){var e=c.cache,f=b?b.apply(this,arguments):d;return p.has(e,f)||(e[f]=a.apply(this,arguments)),e[f]};return c.cache={},c},p.delay=function(a,b){var c=i.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)},p.defer=function(a){return p.delay.apply(p,[a,1].concat(i.call(arguments,1)))},p.throttle=function(a,b,c){var d,e,f,g=null,h=0;c||(c={});var i=function(){h=!1===c.leading?0:p.now(),g=null,f=a.apply(d,e),g||(d=e=null)};return function(){var j=p.now();h||!1!==c.leading||(h=j);var k=b-(j-h);return d=this,e=arguments,k<=0||k>b?(clearTimeout(g),g=null,h=j,f=a.apply(d,e),g||(d=e=null)):g||!1===c.trailing||(g=setTimeout(i,k)),f}},p.debounce=function(a,b,c){var d,e,f,g,h,i=function(){var j=p.now()-g;j<b&&j>0?d=setTimeout(i,b-j):(d=null,c||(h=a.apply(f,e),d||(f=e=null)))};return function(){f=this,e=arguments,g=p.now();var j=c&&!d;return d||(d=setTimeout(i,b)),j&&(h=a.apply(f,e),f=e=null),h}},p.wrap=function(a,b){return p.partial(b,a)},p.negate=function(a){return function(){return!a.apply(this,arguments)}},p.compose=function(){var a=arguments,b=a.length-1;return function(){for(var c=b,d=a[b].apply(this,arguments);c--;)d=a[c].call(this,d);return d}},p.after=function(a,b){return function(){if(--a<1)return b.apply(this,arguments)}},p.before=function(a,b){var c;return function(){return--a>0?c=b.apply(this,arguments):b=null,c}},p.once=p.partial(p.before,2),p.keys=function(a){if(!p.isObject(a))return[];if(n)return n(a);var b=[];for(var c in a)p.has(a,c)&&b.push(c);return b},p.values=function(a){for(var b=p.keys(a),c=b.length,d=Array(c),e=0;e<c;e++)d[e]=a[b[e]];return d},p.pairs=function(a){for(var b=p.keys(a),c=b.length,d=Array(c),e=0;e<c;e++)d[e]=[b[e],a[b[e]]];return d},p.invert=function(a){for(var b={},c=p.keys(a),d=0,e=c.length;d<e;d++)b[a[c[d]]]=c[d];return b},p.functions=p.methods=function(a){var b=[];for(var c in a)p.isFunction(a[c])&&b.push(c);return b.sort()},p.extend=function(a){if(!p.isObject(a))return a;for(var b,c,d=1,e=arguments.length;d<e;d++){b=arguments[d];for(c in b)l.call(b,c)&&(a[c]=b[c])}return a},p.pick=function(a,b,c){var d,e={};if(null==a)return e;if(p.isFunction(b)){b=q(b,c);for(d in a){var f=a[d];b(f,d,a)&&(e[d]=f)}}else{var g=j.apply([],i.call(arguments,1));a=new Object(a);for(var h=0,k=g.length;h<k;h++)(d=g[h])in a&&(e[d]=a[d])}return e},p.omit=function(a,b,c){if(p.isFunction(b))b=p.negate(b);else{var d=p.map(j.apply([],i.call(arguments,1)),String);b=function(a,b){return!p.contains(d,b)}}return p.pick(a,b,c)},p.defaults=function(a){if(!p.isObject(a))return a;for(var b=1,c=arguments.length;b<c;b++){var d=arguments[b];for(var e in d)void 0===a[e]&&(a[e]=d[e])}return a},p.clone=function(a){return p.isObject(a)?p.isArray(a)?a.slice():p.extend({},a):a},p.tap=function(a,b){return b(a),a};var v=function(a,b,c,d){if(a===b)return 0!==a||1/a==1/b;if(null==a||null==b)return a===b;a instanceof p&&(a=a._wrapped),b instanceof p&&(b=b._wrapped);var e=k.call(a);if(e!==k.call(b))return!1;switch(e){case"[object RegExp]":case"[object String]":return""+a==""+b;case"[object Number]":return+a!=+a?+b!=+b:0==+a?1/+a==1/b:+a==+b;case"[object Date]":case"[object Boolean]":return+a==+b}if("object"!=typeof a||"object"!=typeof b)return!1;for(var f=c.length;f--;)if(c[f]===a)return d[f]===b;var g=a.constructor,h=b.constructor;if(g!==h&&"constructor"in a&&"constructor"in b&&!(p.isFunction(g)&&g instanceof g&&p.isFunction(h)&&h instanceof h))return!1;c.push(a),d.push(b);var i,j;if("[object Array]"===e){if(i=a.length,j=i===b.length)for(;i--&&(j=v(a[i],b[i],c,d)););}else{var l,m=p.keys(a);if(i=m.length,j=p.keys(b).length===i)for(;i--&&(l=m[i],j=p.has(b,l)&&v(a[l],b[l],c,d)););}return c.pop(),d.pop(),j};p.isEqual=function(a,b){return v(a,b,[],[])},p.isEmpty=function(a){if(null==a)return!0;if(p.isArray(a)||p.isString(a)||p.isArguments(a))return 0===a.length;for(var b in a)if(p.has(a,b))return!1;return!0},p.isElement=function(a){return!(!a||1!==a.nodeType)},p.isArray=m||function(a){return"[object Array]"===k.call(a)},p.isObject=function(a){var b=typeof a;return"function"===b||"object"===b&&!!a},p.each(["Arguments","Function","String","Number","Date","RegExp"],function(a){p["is"+a]=function(b){return k.call(b)==="[object "+a+"]"}}),p.isArguments(arguments)||(p.isArguments=function(a){return p.has(a,"callee")}),"function"!=typeof/./&&(p.isFunction=function(a){return"function"==typeof a||!1}),p.isFinite=function(a){return isFinite(a)&&!isNaN(parseFloat(a))},p.isNaN=function(a){return p.isNumber(a)&&a!==+a},p.isBoolean=function(a){return!0===a||!1===a||"[object Boolean]"===k.call(a)},p.isNull=function(a){return null===a},p.isUndefined=function(a){return void 0===a},p.has=function(a,b){return null!=a&&l.call(a,b)},p.noConflict=function(){return a._=d,this},p.identity=function(a){return a},p.constant=function(a){return function(){return a}},p.noop=function(){},p.property=function(a){return function(b){return b[a]}},p.matches=function(a){var b=p.pairs(a),c=b.length;return function(a){if(null==a)return!c;a=new Object(a);for(var d=0;d<c;d++){var e=b[d],f=e[0];if(e[1]!==a[f]||!(f in a))return!1}return!0}},p.times=function(a,b,c){var d=Array(Math.max(0,a));b=q(b,c,1);for(var e=0;e<a;e++)d[e]=b(e);return d},p.random=function(a,b){return null==b&&(b=a,a=0),a+Math.floor(Math.random()*(b-a+1))},p.now=Date.now||function(){return(new Date).getTime()};var w={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},x=p.invert(w),y=function(a){var b=function(b){return a[b]},c="(?:"+p.keys(a).join("|")+")",d=RegExp(c),e=RegExp(c,"g");return function(a){return a=null==a?"":""+a,d.test(a)?a.replace(e,b):a}};p.escape=y(w),p.unescape=y(x),p.result=function(a,b){if(null!=a){var c=a[b];return p.isFunction(c)?a[b]():c}};var z=0;p.uniqueId=function(a){var b=++z+"";return a?a+b:b},p.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var A=/(.)^/,B={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},C=/\\|'|\r|\n|\u2028|\u2029/g,D=function(a){return"\\"+B[a]};p.template=function(a,b,c){!b&&c&&(b=c),b=p.defaults({},b,p.templateSettings);var d=RegExp([(b.escape||A).source,(b.interpolate||A).source,(b.evaluate||A).source].join("|")+"|$","g"),e=0,f="__p+='";a.replace(d,function(b,c,d,g,h){return f+=a.slice(e,h).replace(C,D),e=h+b.length,c?f+="'+\n((__t=("+c+"))==null?'':_.escape(__t))+\n'":d?f+="'+\n((__t=("+d+"))==null?'':__t)+\n'":g&&(f+="';\n"+g+"\n__p+='"),b}),f+="';\n",b.variable||(f="with(obj||{}){\n"+f+"}\n"),f="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+f+"return __p;\n";try{var g=new Function(b.variable||"obj","_",f)}catch(a){throw a.source=f,a}var h=function(a){return g.call(this,a,p)},i=b.variable||"obj";return h.source="function("+i+"){\n"+f+"}",h},p.chain=function(a){var b=p(a);return b._chain=!0,b};var E=function(a){return this._chain?p(a).chain():a};p.mixin=function(a){p.each(p.functions(a),function(b){var c=p[b]=a[b];p.prototype[b]=function(){var a=[this._wrapped];return h.apply(a,arguments),E.call(this,c.apply(p,a))}})},p.mixin(p),p.each(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=e[a];p.prototype[a]=function(){var c=this._wrapped;return b.apply(c,arguments),"shift"!==a&&"splice"!==a||0!==c.length||delete c[0],E.call(this,c)}}),p.each(["concat","join","slice"],function(a){var b=e[a];p.prototype[a]=function(){return E.call(this,b.apply(this._wrapped,arguments))}}),p.prototype.value=function(){return this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return p})}).call(this)},{}],3:[function(a,b,c){function d(a){var b=a,c=!1;return{add:function(a){b.assert(a)},remove:function(a){b.retract(a)},clearSession:function(){for(var a=b,c=a.getFacts(),d=0,e=c.length;d<e;d++)a.retract(c[d])},createAndAdd:function(a,c){var d;if("string"!=c.toLowerCase()){d=new(0,this.classDefinitions[c.toLowerCase()])(a)}else d=a;return b.assert(d),d},modify:function(a){b.modify(a)},changeCatalog:function(){var a,d=b,e=[];(c||"verbose"==c)&&console.log("----- init change catalog -----");for(var f in d.classDefinitions)if("order"!=f&&"account"!=f){(c||"verbose"==c)&&console.log("[change catalog] remove [ "+f+" ] items"),a=this.classDefinitions[f];var g=d.getFacts(a);g.length>0&&e.push.apply(e,g)}for(var h=0,i=e.length;h<i;h++)d.retract(e[h]);(c||"verbose"==c)&&(console.log("[change catalog] [ "+e.length+" ] items removed"),console.log("----- end change catalog -----"))},removeCurrentItems:function(a){var b=(new Date).getTime(),d={debug:c,grouprules:["agCleanCatalog"]};if(void 0!=a){if(a.constructor!==Array)throw new Error("list of events must be an array!");d.events=a}var e=this;return new Promise(function(a,f){e.fire(d,function(d){void 0==d.err?a(d):f(d),(c||"verbose"==c)&&console.log("removeCurrentItems ended in [ "+((new Date).getTime()-b)+" ] ms.")})})},addToCart:function(a){var b=(new Date).getTime(),d={debug:c,grouprules:["agAddToCart","agCheckCart","agEligibility","agTotalCart"]};if(void 0!=a){if(a.constructor!==Array)throw new Error("list of events must be an array!");d.events=a}var e=this;return new Promise(function(a,f){e.fire(d,function(d){void 0==d.err?a(d):f(d),(c||"verbose"==c)&&console.log("addToCart ended in [ "+((new Date).getTime()-b)+" ] ms.")})})},eligibility:function(a){var b=(new Date).getTime(),d={debug:c,grouprules:["agEligibility"]};if(void 0!=a){if(a.constructor!==Array)throw new Error("list of events must be an array!");d.events=a}var e=this;return new Promise(function(a,f){e.fire(d,function(d){void 0==d.err?a(d):f(d),(c||"verbose"==c)&&console.log("eligibility ended in [ "+((new Date).getTime()-b)+" ] ms.")})})},removeFromCart:function(a){var b=(new Date).getTime(),d={debug:c,grouprules:["agResetStatus","agAddToCart","agCheckCart","agEligibility","agTotalCart"]};if(void 0!=a){if(a.constructor!==Array)throw new Error("list of events must be an array!");d.events=a}var e=this;return new Promise(function(a,f){e.fire(d,function(d){void 0==d.err?a(d):f(d),(c||"verbose"==c)&&console.log("RemoveFromCart ended in [ "+((new Date).getTime()-b)+" ] ms.")})})},retrieveCurrentFacts:function(){var a=this.classDefinitions,c=b,d={};for(k in a)"object"!==k&&c.getFacts(a[k]).length>0&&(d[k]=c.getFacts(a[k]));return d},fire:function(a,c){function d(b){f.on(b,function(c){a&&a.debug&&console.log("[b2wgin log] "+b+" event caught!"),e.eventResults[b].push(c)})}a&&a.debug&&console.log("----- init call -----");var e={};e.eventResults={};var f=b,g=this.classDefinitions;if(delete f._events,a&&a.grouprules)for(var h=a.grouprules.length-1,i=h;i>=0;i--){var j=a.grouprules[i];a&&a.debug&&console.log("[b2wgin log] Set focus on group of rules [ "+j+" ]"),f.focus(j)}if(a&&a.events)for(var k=0;k<a.events.length;k++){var l=a.events[k];e.eventResults[l]=[],a&&a.debug&&console.log("[b2wgin log] setting listener to ["+l+"]"),d(l)}if(a&&a.debug&&f.on("fire",function(b,c){a&&a.debug&&console.log("[b2wgin log] "+b+" fired!")}),void 0==c)return a&&a.debug&&console.log("----- end call -----"),f.match();f.match().then(function(){var b=f.getFacts();e.matches=b,e.matches={};for(k in g)"object"!==k&&f.getFacts(g[k]).length>0&&(e.matches[k]=f.getFacts(g[k]));if(a&&void 0!=a.debug&&"verbose"==a.debug&&console.log(JSON.stringify(e.matches)),void 0!=a&&void 0!=a.persist&&0==a.persist)for(var d=f.getFacts(),h=0;h<d.length;h++)f.retract(d[h]);a&&a.debug&&console.log("----- end call -----"),c(e)},function(a){console.log("[b2wgin log] Error in analyzing rules.. "+a),e.err=a,c(e)})}}}b.exports=d},{}],4:[function(require,module,exports){"use strict";var b2wgin_cart=function(_initConfig){function workPostEngineData(){if(null!=ifnull(currentContext.postEngineData)){wslog.info("currentContext.postEngineData found");for(var a=0;a<currentContext.postEngineData.length;a++)catalogEngine.modify(currentContext.postEngineData[a])}delete currentContext.postEngineData}function matches(a,b){return new RegExp(unescape(b),"i").test(a)}function validateAttribute(a,b,c){var d={};d.modifyFact=!1,d.checkPassed=!0,d.sendData=!1;try{var e=ifnull(b.fields.lastvalue),f=ifnull(b.fields.value),g=b.listOfDomains,h=ifnull(b.fields.validationexpression),i=ifnull(b.fields.validationerror),j=ifnull(b.fields.name),k=ifnull(b.fields.vid);if(null!=f&&f!=e){if(g.length>0){var l=g.length-1;do{var m=b.listOfDomains[l],n=ifnull(m.fields.name),o=m.fields.selected;if(null!=n){-1!==f.split(";").indexOf(n)&&"Y"!=o?(d.modifyFact=!0,m.fields.selected="Y"):"N"!=o&&(d.modifyFact=!0,m.fields.selected="N")}}while(--l)}if(b.fields.lastvalue=b.fields.value,null!=h&&!matches(f,h)){a.fields.configurationstatus="In progress",currentContext.configuration.NE__configurationstatus__c="In progress",d.checkPassed=!1;var p={};p.type="req";var q=j+" "+labels.AttributeValidationError+" "+b.fields.familyname;p.text=ifnull(i)?i:q,p.associatedItemCode=k,currentContext.messages.push(p)}d.modifyFact=!0}else if(null==f&&"Yes"===b.fields.required){var p={};p.type="req",p.text=a.fields.productname+": "+j+" "+labels.AttributeRequired+" "+b.fields.familyname,p.associatedItemCode=k,currentContext.messages.push(p),currentContext.configuration.NE__configurationstatus__c="In progress",a.fields.configurationstatus="In progress",d.modifyFact=!0,d.checkPassed=!1}if(1==c&&1==d.checkPassed&&currentContext.messages.length>0){var r=currentContext.messages.length-1;do{if(currentContext.messages[r].associatedItemCode==k){currentContext.messages.splice(r,1),d.sendData=!0;break}}while(r--)}0==d.checkPassed&&(d.sendData=!0)}catch(a){wslog.info("Validation exception: "+a)}return d}function assignCartItemNumber(a,b){if(null==ifnull(a.fields.bundleId))return 0;if(null!=ifnull(a.fields.bundleId)&&null==ifnull(a.fields.bundlevid)){var c=b[a.fields.vid];return null==ifnull(c)?0:c}if(null!=ifnull(a.fields.bundleId)&&null!=ifnull(a.fields.bundlevid)){var d=b[a.fields.vid];if(null!=ifnull(d))return d;var c=b[a.fields.bundlevid+"_last"];if(null==ifnull(c))return 0;var e=c+10;return b[a.fields.bundlevid+"_last"]=e,b[a.fields.vid]=e,e}return 0}function isEmpty(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}function ifnull(a){return""===a||"undefined"==a||null==a?null:a}function ifnull(a,b){return""===a||"undefined"==a||null==a?b:a}function logTimeStart(a){"TRACE"==currentContext.cartOptions.logLevel&&console.time(a)}function logTimeEnd(a){"TRACE"==currentContext.cartOptions.logLevel&&console.timeEnd(a)}function retrieveB2WGinData(a){b2wgindatainterceptor.retrieveB2WGinData(currentContext.cartOptions.organizationId,function(b){if("0"!=b.errorCode)return generateError("retrieveB2WGinData: "+b.errorMessage),a(b.errorMessage),!1;var c=b.result;void 0==c&&(c=b);try{null!=ifnull(c.action)&&(wslog.setLevel(wslog.levels[c.action]),currentContext.cartOptions.logLevel=c.action)}catch(a){wslog.setLevel(wslog.levels.SILENT)}if(c.action="",null!=ifnull(c.retrieveItemsServiceOutput.additionalData.labels)&&(labels=c.retrieveItemsServiceOutput.additionalData.labels,wslog.info("labels: ",c.retrieveItemsServiceOutput.additionalData.labels),delete c.retrieveItemsServiceOutput.additionalData.labels),currentContext.defaultCurrency=c.defaultCurrency,wslog.info("defaultCurrency: "+c.defaultCurrency),currentContext.dataInterceptor=c,wslog.info("dataInterceptor: ",currentContext.dataInterceptor),currentContext.organizationId=c.organizationId,wslog.info("Organization id: "+currentContext.organizationId),isBrowser&&(wslog.info("Frame origin: ",window.location.origin),currentContext.dataInterceptor.requestOrigin=window.location.origin),null!=ifnull(currentContext.cartOptions.userLanguage)&&(currentContext.getDataOptionsMap.userLanguage=currentContext.cartOptions.userLanguage),currentContext.lexOrigin=c.lexOrigin,isBrowser&&-1!=window.location.href.indexOf("lightningFromVF=true")&&(currentContext.lexOrigin=window.location.origin.replace("ne.","c.")),isBrowser&&-1!=window.location.href.indexOf("sendmatches=true")&&(currentContext.cartOptions.sendmatches=!0),wslog.info("Starting B2WginData: ",c),currentContext.agendaGroupsMap={},currentContext.agendaGroupsMap.changeCatalogOrCategories={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.changePage={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.addRemoveItem={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.manageCart={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.retrieveItemsFromBundleElement={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.searchItems={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.addRemoveChildItem={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.addChild={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.removeChild={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.changeAttribute={debug:currentContext.DEBUG,grouprules:["agPreSystem","agChangeAttribute","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.resetSaveConfiguration={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.initCart={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agFirstLoad","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.changeCatalog={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agFirstLoad","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.agCheckOut={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCheckOut","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.agCleanCatalog={debug:currentContext.DEBUG,grouprules:["agCleanCatalog"]},currentContext.agendaGroupsMap.changeCategory={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.saveConfiguration={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.saveBundle={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.modifyBundle={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.addBundle={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.agSystem={debug:currentContext.DEBUG,grouprules:["agSystem"]},currentContext.agendaGroupsMap.agPostSystem={debug:currentContext.DEBUG,grouprules:["agPostSystem"]},currentContext.agendaGroupsMap.reset={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.configureCatalogItem={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.cancelItemConfiguration={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.confirmItemConfiguration={debug:currentContext.DEBUG,grouprules:["agPreSystem","agCartChanged","agRetrieveItems","agAlways","agSystem","agPostSystem"]},currentContext.agendaGroupsMap.updateB2WGinEngine={debug:currentContext.DEBUG,grouprules:["agPreSystem","agRetrieveItems","agAlways","agSystem","agPostSystem"]},wslog.info("Base agenda groups: ",currentContext.agendaGroupsMap),null!=ifnull(c.cartadministration)){var d=new Object;for(var e in c.cartadministration){var f=e.replace(currentContext.dataInterceptor.prefix,"");f=f.replace("__c",""),d[f]=c.cartadministration[e]}if(currentContext.contextdata.cartadministration="cartadministration",currentContext.cartadministration=d,void 0!=currentContext.cartOptions&&null!=currentContext.cartOptions)for(var g in currentContext.cartOptions)"facts"!=g&&(currentContext.cartadministration[g]=currentContext.cartOptions[g]);wslog.info("cartadministration: ",currentContext.cartadministration),currentContext.itemsForPage=currentContext.cartadministration.ItemsForPage}if(currentContext.multicurrencyactivated=c.multicurrencyactivated,null!=ifnull(c.mapOfCurrenciesConversion)&&1==c.multicurrencyactivated){currentContext.contextdata.currencyconversion="currencyconversion",currentContext.moduleAppVar.currencyconversion=[];for(var h in c.mapOfCurrenciesConversion){var i=new Object;i.isocode=h,i.value=c.mapOfCurrenciesConversion[h],currentContext.moduleAppVar.currencyconversion.push(i)}}wslog.info("Setted itemsForPage ",currentContext.itemsForPage),currentContext.lastMessageType="initCart",a()},function(b){b.method="retrieveB2WGinData",a(b)})}function retrieveProgram(a,b,c,d){var e="[EXECUTION_TIME] retrieveProgram "+a+" took";logTimeStart(e),b2wgindatainterceptor.retrieveProgram("getCatalogsEligible","1",currentContext.organizationId,function(a){if(logTimeEnd(e),"0"!=a.errorCode)return generateError("retrieveProgram: "+a.errorMessage),d(a.errorMessage),!1;catalogEngine=a,isBrowser&&wslog.info("Init get catalogs program ended"),d(null,catalogEngine)},function(a){d(a)})}function retrieveRowParameters(a){b2wgindatainterceptor.retrieveRowParameters("",null,"getPrograms",function(b){if(null!=b&&void 0!=b){currentContext.rowParameters=b.result;for(var c=0;c<currentContext.rowParameters.length;c++)catalogEngine.createAndAdd(currentContext.rowParameters[c],"matrixparameterrow"),null==ifnull(currentContext.moduleAppVar.matrixparameterrow)&&(currentContext.moduleAppVar.matrixparameterrow=[]),currentContext.moduleAppVar.matrixparameterrow.push(currentContext.rowParameters[c]),currentContext.contextdata.matrixparameterrow="matrixparameterrow";a()}else a("error")},function(b){a(b)})}function retrieveContextData(a,b,c){wslog.info("retrieveContextData with params: "+a),b2wgindatainterceptor.retrieveContextData(a,currentContext.getDataOptionsMap,function(a){if("0"!=a.errorCode)return generateError("retrieveContextData: "+a.errorMessage),c(a.errorMessage),!1;if(null!=a.result&&void 0!=a.result){var b=currentContext.cartOptions.facts;if(null!=ifnull(b))for(var d in b){var e=b[d];if(e.constructor===Array)for(var f=0;f<e.length;f++){var g=Math.random().toString(36).substring(3),h=e[f];null==ifnull(h.id)&&(h.id=g),a.result[d+"___"+h.id]=h}else{var g=Math.random().toString(36).substring(3);null==ifnull(e.id)&&(e.id=g),a.result[d]=e}}for(var i in a.result)if(a.result.hasOwnProperty(i))if(wslog.info(i+" -> "+a.result[i]),"-1"!=i.indexOf("___")){var j;j=a.result[i].constructor===String?JSON.parse(a.result[i]):a.result[i];var k=i.split("___")[0];catalogEngine.createAndAdd(j,k),"sessionparameter"==k?(null==ifnull(currentContext.moduleAppVar[k])&&(currentContext.moduleAppVar[k]=[]),j.value=unescape(j.value),currentContext.moduleAppVar[k].push(j),currentContext.contextdata[k]=currentContext.moduleAppVar[k],"confcurrency"==j.name?currentContext.confcurrency=j.value:"taxmodel"==j.name&&(currentContext.taxModelsParameters=j.value),"debugMode"==j.name&&"active"==j.value&&(currentContext.debugMode="active",currentContext.debugLog="")):"cartitem"==k?(null==ifnull(currentContext.cart)&&(currentContext.cart=[]),currentContext.cart.push(j)):"catalog"!=k&&null!=j.id&&""!=j.id&&(null==ifnull(currentContext.moduleAppVar[k])&&(currentContext.moduleAppVar[k]=[]),j.value=unescape(j.value),currentContext.moduleAppVar[k].push(j),currentContext.contextdata[k]=currentContext.moduleAppVar[k])}else{if(1==currentContext.multicurrencyactivated&&void 0!=currentContext.moduleAppVar.sessionparameter&&null!=currentContext.moduleAppVar.sessionparameter){var l={name:"isMultiCurrency",value:"true"};catalogEngine.createAndAdd(l,"sessionparameter"),currentContext.moduleAppVar.sessionparameter.push(l)}var j;j=a.result[i].constructor===String?JSON.parse(a.result[i]):a.result[i],currentContext.moduleAppVar[i]=j,catalogEngine.createAndAdd(j,i),currentContext.contextdata[i]=i}if(currentContext.configuration=currentContext.moduleAppVar.configuration,currentContext.getDataOptionsMap.configurationDateString=currentContext.configuration.NE__order_date__c,null!=ifnull(currentContext.cartadministration.ColumsVisible)&&-1!=currentContext.cartadministration.ColumsVisible.indexOf("showInTable")){null==ifnull(currentContext.moduleAppVar.sessionparameter)&&(currentContext.moduleAppVar.sessionparameter=[]);var m={value:"multiAdd",name:"itemView"};catalogEngine.createAndAdd(m,"sessionparameter"),currentContext.moduleAppVar.sessionparameter.push(m),currentContext.contextdata.sessionparameter=currentContext.moduleAppVar.sessionparameter}currentContext.dataInterceptor.retrieveCatalogsServiceOutput.configuration=currentContext.configuration,c()}},function(a){c(a)})}function retrieveProgramChangeCatalog(a,b,c,d){var e="[EXECUTION_TIME] retrieveProgram "+a+" took";logTimeStart(e),b2wgindatainterceptor.retrieveProgram(a,b,c,function(a){if(logTimeEnd(e),"0"!=a.errorCode)return generateError("retrieveProgram: "+a.errorMessage),d(a.errorMessage),!1;wslog.info("change catalog init program starts"),catalogEngine=a,catalogEngine.clearSession(),currentContext.moduleAppVar.category=[],currentContext.moduleAppVar.complex_category=[],wslog.info("Change catalog restoring context contextdata ",currentContext.contextdata),currentContext.contextdata.matrixparameterrow=[];for(var b=0;b<currentContext.cart.length;b++)catalogEngine.createAndAdd(currentContext.cart[b],"cartitem");for(var c in currentContext.contextdata)if(null!=ifnull(currentContext.moduleAppVar[c]))if(wslog.info("Restoring key: "+c),currentContext.moduleAppVar[c]instanceof Array)for(var f=currentContext.moduleAppVar[c],b=0;b<f.length;b++)catalogEngine.createAndAdd(f[b],c);else catalogEngine.createAndAdd(currentContext.moduleAppVar[c],c);d()},function(a){a.method="retrieveProgramChangeCatalog",d(a)})}function retrieveMatrixParametersChangeCatalog(headerId,callback){wslog.info("retrieveRowParameters"),b2wgindatainterceptor.retrieveMatrixParameters(headerId,function(result){if("0"!=result.errorCode)return generateError("retrieveMatrixParameters: "+result.errorMessage),callback(result.errorMessage),!1;var queryCondition="";if(result.result&&""!=result.result){queryCondition=result.result;for(var splitted=queryCondition.split(" "),tempString="",i=0;i<splitted.length;i++)void 0!=splitted[i]&&" "!=splitted[i]&&-1!=splitted[i].indexOf("$")?(0!=i&&(tempString+=" "),tempString+="'"+eval(splitted[i])+"'"):void 0!=splitted[i]&&" "!=splitted[i]&&(0!=i&&(tempString+=" "),tempString+=splitted[i]);currentContext.queryCondition=tempString}callback(null,currentContext.queryCondition)},function(a){a.method="retrieveMatrixParametersChangeCatalog",callback(a)})}function retrieveRowParametersChangeCatalog(a,b,c){wslog.info("retrieveRowParameters"),currentContext.cartOptions.mpquery?a=currentContext.cartOptions.mpquery:b.mpquery&&(a=b.mpquery),b2wgindatainterceptor.retrieveRowParameters(a,b.catalogid,null,function(a){if("0"!=a.errorCode)return generateError("Unable to load matrix rows parameters: "+a.errorMessage),c(a.errorMessage),!1;currentContext.rowParameters=a.result;for(var b=0;b<currentContext.rowParameters.length;b++)catalogEngine.createAndAdd(currentContext.rowParameters[b],"matrixparameterrow"),null==ifnull(currentContext.moduleAppVar.matrixparameterrow)&&(currentContext.moduleAppVar.matrixparameterrow=[]),currentContext.moduleAppVar.matrixparameterrow.push(currentContext.rowParameters[b]),currentContext.contextdata.matrixparameterrow="matrixparameterrow";null!=ifnull(currentContext.taxModelsParameters)&&(currentContext.getDataOptionsMap.taxModelsParameters=currentContext.taxModelsParameters,currentContext.getDataOptionsMap.catalogHeaderId=currentContext.catalog.headerid,currentContext.getDataOptionsMap.configurationDate=currentContext.configuration.NE__order_date__c),currentContext.getDataOptionsMap.GetAllData=String(currentContext.cartadministration.GetAllData),currentContext.getDataOptionsMap.GetStructure=String(currentContext.cartadministration.GetStructure),currentContext.getDataOptionsMap.CatalogsEligible=currentContext.cartadministration.CatalogsEligible,c(null,currentContext.getDataOptionsMap)},function(a){a.method="retrieveRowParametersChangeCatalog",c(a)})}function retrieveCatalogDataChangeCatalog(a,b,c){var d=a.catalogid;currentContext.selectedCategory=null,b2wgindatainterceptor.retrieveCatalogData(d,"",b,function(b){if("0"!=b.errorCode)return generateError("retrieveCatalogData: "+b.errorMessage),c(b.errorMessage),!1;wslog.info("Load catalog data");for(var d in b.result)if(b.result.hasOwnProperty(d))if(wslog.info(d+" -> "+b.result[d]),"-1"!=d.indexOf("___")){var e,f=d.split("___")[0];e=b.result[d].constructor===String?JSON.parse(b.result[d]):b.result[d],catalogEngine.createAndAdd(e,f),"undefined"!=currentContext.moduleAppVar[f]&&null!=currentContext.moduleAppVar[f]||(wslog.info("Initialize list: "+f),currentContext.moduleAppVar[f]=[]),"category"!=f||null==ifnull(a.defaultCategory)||a.defaultCategory!=e.categoryFields.enginecode&&a.defaultCategory!=e.categoryFields.id&&a.defaultCategory!=e.categoryFields.name||(currentContext.selectedCategory=e.categoryFields.id,currentContext.catalogSelectedCategory=e.categoryFields.id),currentContext.moduleAppVar[f].push(e),"taxmodel"==f&&(currentContext.contextdata[f]=f)}else currentContext.moduleAppVar[d]=b.result[d],catalogEngine.createAndAdd(JSON.parse(b.result[d]),d);null==currentContext.selectedCategory&&(currentContext.selectedCategory=currentContext.moduleAppVar.category.filter(function(a){return"false"===a.categoryFields.hidden})[0].categoryFields.id,currentContext.catalogSelectedCategory=currentContext.selectedCategory),currentContext.searchActive=!1,currentContext.searchText="",wslog.info("retrieveCatalogItems"),c()},function(a){a.method="retrieveCatalogDataChangeCatalog",c(a)})}function assignObjectNumber(a,b){var c=a;if("-1"!=a.indexOf("___")&&(c=a.split("___")[0]),"bundle"==c)return 0;var d=b[a];if(d.constructor===String)return 9;if(null==ifnull(d.fields))return 8;if("bundleItem"==ifnull(d.fields.categoryname))return 1;switch(d.fields.deeprelationship){case"Product":return 2;case"Child0":return 3;case"Child1":return 4;case"Child2":return 5;case"Child3":return 6;case"Child4":return 7}return 9}function assignItemNumber(a){switch(a.fields.deeprelationship){case"Product":return 2;case"Child0":return 3;case"Child1":return 4;case"Child2":return 5;case"Child3":return 6;case"Child4":return 7}return 9}function assignCategoryNumber(a){switch(a.categoryFields.depth){case"Category0":return 2;case"Category1":return 3;case"Category2":return 4;case"Category3":return 5;case"Category4":return 6;case"Category5":return 7}return 9}function retrieveCatalogBundles(a,b,c){var d=a.catalogid;wslog.info("retrieve bundle data for date: "+currentContext.configuration),b2wgindatainterceptor.retrieveCatalogBundles(d,b,function(a){if("0"!=a.errorCode)return generateError("retrieveCatalogBundle: "+a.errorMessage),void c(a.errorMessage);wslog.info("Load bundle data");var b,d={},e={},f={},g={},h=[];for(var i in a.result){h.push(i);var j=a.result[i];try{j.constructor===String?g[i]=JSON.parse(j):g[i]=j}catch(a){g[i]=j}}for(var k=h.sort(function(a,b){var c=assignObjectNumber(a,g),d=assignObjectNumber(b,g);if(c>=2&&c<=7&&c==d){var e=g[a],f=g[b];return e.fields.sequence-f.fields.sequence}return c-d}),l=0;l<k.length;l++){var i=k[l];if(g.hasOwnProperty(i))if(wslog.info(i+" -> ",g[i]),"-1"!=i.indexOf("___")){var m,n=i.split("___")[0];if("itemHeader"!=n&&"complex_program"!=n&&"catCategory"!=n&&"simple_program"!=n){if(m=g[i].constructor===String?JSON.parse(g[i]):g[i],"item"==n){"undefined"!=currentContext.moduleAppVar.bundleItems&&null!=currentContext.moduleAppVar.bundleItems||(currentContext.moduleAppVar.bundleItems=[]),m.fields.visible="false",m.fields.bundleId=f[m.fields.id];var o=(m.fields.productname,d[m.fields.sourceId]);if(null!=ifnull(o))for(var p=0;p<o.length;p++){if(o.length>0){var q=JSON.stringify(m);m=JSON.parse(q)}b=o[p],m.fields.bundleElement=b.fields.id,m.fields.bundleId=b.fields.bundleid;var r=e[m.fields.itemHeader];null==ifnull(r)&&(r=[]),r.push(m),e[m.fields.itemHeader]=r,currentContext.moduleAppVar.bundleItems.push(m)}else if("Child-Product"==m.fields.type){var s=e[m.fields.itemHeader];if(null!=ifnull(s))for(var p=0;p<s.length;p++){if(s.length>0){var q=JSON.stringify(m);m=JSON.parse(q)}var t=s[p];m.fields.bundleElement=t.fields.bundleElement,m.fields.bundleId=t.fields.bundleId,currentContext.moduleAppVar.bundleItems.push(m)}}else currentContext.moduleAppVar.bundleItems.push(m)}else if("bundle"==n){"undefined"!=currentContext.moduleAppVar[n]&&null!=currentContext.moduleAppVar[n]||(wslog.info("Initialize list: "+n),currentContext.moduleAppVar[n]=[]),currentContext.moduleAppVar[n].push(m),catalogEngine.createAndAdd(m,n),currentContext.contextdata.bundle="bundle",f[m.fields.catalogitem]=m.fields.id;for(var u=0;u<m.bundleElements.length;u++){var v=m.bundleElements[u];if(1==v.fields.maxqty&&1==v.fields.minqty&&"Item"==v.fields.type){var w=v.fields.elements,x=w.split("*row*"),y=x[0].split("*el*"),o=d[y[1]];null==ifnull(o)&&(o=[]),o.push(v),d[y[1]]=o}}m}}else"simple_program"==n?("undefined"!=currentContext.moduleAppVar[i]&&null!=currentContext.moduleAppVar[i]||(currentContext.moduleAppVar[i]=[]),currentContext.moduleAppVar[i].push(g[i])):("undefined"!=currentContext.moduleAppVar[n]&&null!=currentContext.moduleAppVar[n]||(wslog.info("Initialize list: "+n),currentContext.moduleAppVar[n]=[]),currentContext.moduleAppVar[n].push(m))}else currentContext.moduleAppVar[i]=g[i]}c()},function(a){a.method="retrieveCatalogDataChangeCatalog",c(a)})}function modifyBundle(a,b,c){if(currentContext.currentBundlevid=a.fields.vid,currentContext.dataInterceptor.retrieveItemsServiceOutput.currentBundlevid=currentContext.currentBundlevid,null!=ifnull(currentContext.listOfbundles)){currentContext.getDataOptionsMap.GetAllData_BK=currentContext.getDataOptionsMap.GetAllData,currentContext.getDataOptionsMap.GetAllData="false";for(var d=0;d<currentContext.listOfbundles.length;d++){var e=currentContext.listOfbundles[d];if(e.fields.id==a.fields.bundleId){currentContext.dataInterceptor.bundleToConfigure=e,currentContext.currentBundle=e;for(var d=0;d<currentContext.dataInterceptor.bundleToConfigure.bundleElements.length;d++){var f=currentContext.dataInterceptor.bundleToConfigure.bundleElements[d];if(1==f.fields.maxqty&&1==f.fields.minqty&&"Item"==f.fields.type){var g=f.fields.elements,h=g.split("*row*");h[0].split("*el*");f.fields.isComplete="true",2==h.length?f.fields.fixed=!0:f.fields.fixed=!1,catalogEngine.modify(currentContext.dataInterceptor.bundleToConfigure)}}break}}retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(a){b()},function(a){c(a)})}}function retrieveBundleData(a,b,c,d,e){var f,g=currentContext.cartadministration.GetStructure,h={};if(g){var i={};i.result={},i.errorCode="0",i.errorMessage="";var j=currentContext.listOfItems.filter(function(a){return"Product"===a.fields.type&&a.fields.bundleId===currentContext.dataInterceptor.bundleToConfigure.fields.id});j=j.sort(function(a,b){return null!=ifnull(a.fields.bundleElement)&&null==ifnull(b.fields.bundleElement)?1:a.fields.sequence>b.fields.sequence?1:-1});for(var k=0;k<j.length;k++){var l=j[k];wslog.info("Found product bundle item to add into the list with id: "+l.fields.id);var m=Object.assign(new Object,l);m.fields.vid=Math.random().toString(36).substring(3),m.fields.itemCode=m.fields.vid,m.fields.isCatalogItem=!1,m.fields.isCart=!0,0==m.fields.qty&&(m.fields.qty=1),m,h[m.fields.itemheaderId]=m,null!=ifnull(m.fields.bundleId)&&null==ifnull(m.fields.bundleElement)?f=m:m.fields.bundlevid=f.fields.vid,h[m.fields.catalogitemid]=m,i.result["cartitem___"+m.fields.vid]=m}for(var n=currentContext.listOfItems.filter(function(a){return"Child-Product"===a.fields.type&&null!=ifnull(a.fields.defaultQty)&&a.fields.bundleId===currentContext.dataInterceptor.bundleToConfigure.fields.id}),k=0;k<n.length;k++){var l=n[k];wslog.info("Found child bundle item to add into the list with id: "+l.fields.id);var m=Object.assign(new Object,l);m.fields.vid=Math.random().toString(36).substring(3),m.fields.itemCode=m.fields.vid,m.fields.isCatalogItem=!1,m.fields.isCart=!0,0==m.fields.qty&&(m.fields.qty=1),m.fields.qty=m.fields.defaultQty;var o=h[m.fields.parent];null==ifnull(o)&&(o=h[m.fields.productcatalogitem]),m.fields.parentvid=o.fields.vid;var p=h[m.fields.itemheaderId];m.fields.rootvid=p.fields.vid,null!=ifnull(m.fields.bundleId)&&null==ifnull(m.fields.bundleElement)?f=m:m.fields.bundlevid=f.fields.vid,h[m.fields.catalogitemid]=m,i.result["cartitem___"+m.fields.vid]=m}d(i)}else b2wgindatainterceptor.retrieveBundleData(a,b,currentContext.getDataOptionsMap,function(a){d(a)})}function addBundle(a,b,c){var d={},e=[];currentContext.mapOfBundleElements={},currentContext.mapOfBundleLogicalConn={};var f;currentContext.getDataOptionsMap.GetAllData_BK=currentContext.getDataOptionsMap.GetAllData,currentContext.getDataOptionsMap.GetAllData="false";for(var g=0;g<currentContext.listOfbundles.length;g++)currentContext.listOfbundles[g].fields.id==a.fields.id&&(a=currentContext.listOfbundles[g],currentContext.currentBundle=a);for(var g=0;g<a.bundleElements.length;g++){var h=a.bundleElements[g];if(1==h.fields.maxqty&&1==h.fields.minqty&&"Item"==h.fields.type){var i=h.fields.elements,j=i.split("*row*"),k=j[0].split("*el*");d[k[1]]=h,e.push(k[1]),h.fields.isComplete="true",2==j.length?h.fields.fixed=!0:h.fields.fixed=!1,currentContext.mapOfBundleElements[h.fields.id]=h}}catalogEngine.modify(a),currentContext.dataInterceptor.bundleToConfigure=a,wslog.info("itemsExternalIds: ",e),wslog.info("Adding bundle: ",a),retrieveBundleData(a.fields.catalogItemSourceId,e,currentContext.getDataOptionsMap,function(e){"0"!=e.errorCode&&(generateError("retrieveBundleInformation: "+e.errorMessage),c(e.errorMessage)),wslog.info("added bundle or bundle element: ",e);for(var g in e.result)if(e.result.hasOwnProperty(g)&&(wslog.info(g+" -> ",e.result[g]),"-1"!=g.indexOf("___"))){var h=g.split("___")[0],i=e.result[g];if(i.constructor!==Object&&(i=JSON.parse(e.result[g])),i.fields.visible=i.fields.visiblefromdb,null!=(f=d[i.fields.sourceId])&&"Product"==i.fields.type){if(null!=ifnull(f.fields.recurringchargediscount)&&(i.fields.baserecurringcharge=i.fields.baserecurringcharge*f.fields.recurringchargediscount/100),null!=ifnull(f.fields.recurringchargeoverride)&&(i.fields.baserecurringcharge=f.fields.recurringchargediscount),null!=ifnull(f.fields.baseonetimefeediscount)&&(i.fields.baseonetimefee=i.fields.baseonetimefee*f.fields.baseonetimefeediscount/100),null!=ifnull(f.fields.baseonetimefeeoverride)&&(i.fields.baseonetimefee=currentContext.currentBundleElement.fields.baseonetimefeeoverride),i.fields.bundleElement=f.fields.id,i.fields.bundlevid=currentContext.currentBundlevid,currentContext.mapOfBundleLogicalConn[f.fields.id]=i.fields.vid,null!=ifnull(f.fields.parentBundleElement)){var j=currentContext.mapOfBundleElements[f.fields.parentBundleElement];null!=ifnull(j)&&(i.fields.logicalParent=currentContext.mapOfBundleLogicalConn[j.fields.id])}}else null==f&&"Product"==i.fields.type?currentContext.currentBundlevid=i.fields.vid:null!=f&&"Child-Product"==i.fields.type&&(i.fields.bundleElement=f.fields.id);i.fields.bundleId=a.fields.id,catalogEngine.createAndAdd(i,h),"undefined"!=currentContext.moduleAppVar[h]&&null!=currentContext.moduleAppVar[h]||(wslog.info("Initialize list: "+h),currentContext.moduleAppVar[h]=[]),currentContext.moduleAppVar[h].push(i)}retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(a){b(a)},function(a){c(a)})},function(a){c(a)},{escape:!1})}function retrieveItemsFromBundleElement(a,b,c,d){null!=a&&void 0!=a?(0==b&&(b=1),wslog.info("bundleElement.fields.id: "+a.fields.id),currentContext.getDataOptionsMap.bundleElement=a.fields.id,null!=ifnull(a.fields.filter)?currentContext.getDataOptionsMap.bundleElementFilter=a.fields.filter:delete currentContext.getDataOptionsMap.bundleElementFilter,currentContext.cachedResponse={},currentContext.currentBundleElement=a,retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,a.fields.id,currentContext.itemsForPage,b,currentContext.getDataOptionsMap,function(a){c(a)},function(a){d(a)})):c({})}function saveBundle(a,b){currentContext.dataInterceptor.configure=!1,currentContext.dataInterceptor.componentToShow="catalog",currentContext.dataInterceptor.itemToShow=null,currentContext.itemheaderId=null,currentContext.complexProductToOpen=null,currentContext.complexProductId=null,"true"==currentContext.getDataOptionsMap.GetAllData_BK?currentContext.getDataOptionsMap.GetAllData="true":currentContext.getDataOptionsMap.GetAllData="false",wslog.info("Return to shopping cart"),currentContext.saveBackup=!1,currentContext.getDataOptionsMap.bundleElement=null,delete currentContext.getDataOptionsMap.bundleElementFilter,currentContext.cachedResponse={},currentContext.currentBundleElement=null,currentContext.currentBundle=null,currentContext.currentBundlevid=null,currentContext.programname=currentContext.catalogprogramname,currentContext.version=currentContext.catalogversion,retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(b){a(b)},function(a){b(a)})}function removeBundle(a){removeItemFromCart()}function executeCostSimulator(a,b,c){try{if(null==ifnull(a))throw new Error("No simulation items provided");if(!a instanceof Array)throw new Error("You must provide an array of objects");if(0==a.length)throw new Error("No simulation data provided");if(void 0===catalogEngine)throw new Error("Engine is not initialized");if(void 0===b2wgindatainterceptor)throw new Error("Data Interceptor is not initialized");for(var d=currentContext.getDataOptionsMap.GetAllData,e=currentContext.getDataOptionsMap.GetStructure,f=catalogEngine.retrieveCurrentFacts(),g=[],h=0;h<a.length;h++){if(null==ifnull(a[h].fields))throw new Error("Invalid item provided: "+JSON.stringify(a[h]));var i="item";1==a[h].fields.isCart&&(i="cartitem"),g.push({type:i,instance:a[h]})}var j=["bundle","item","message","cartitem"];for(var k in f)if(-1===j.indexOf(k))for(var l=f[k],m=0;m<l.length;m++)g.push({type:k,instance:l[m]});wslog.info("[executeCostSimulator] objectList: ",g);var n={executeRules:!0,objectList:g},o=currentContext.programname+"_Simulator",p=currentContext.version;b2wgindatainterceptor.retrieveProgram(o,p,currentContext.organizationId,function(a){if("0"!=a.errorCode){var c=void 0!==a.errorMessage?a.errorMessage:"Retrieve program error";throw new Error(c)}var f=a;if(f.clearSession(),n.objectList.constructor!==Array)throw new Error("the property must be an array");0===n.objectList.length&&wslog.info("[executeCostSimulator] no object to add");for(var g=0;g<n.objectList.length;g++){var h=n.objectList[g],i=h.type;wslog.info("[executeCostSimulator] currentObject:",h.instance),wslog.info("[executeCostSimulator] key: "+i),f.createAndAdd(h.instance,i)}wslog.info("[executeCostSimulator] execute rules: "+n.executeRules),f.fire([],function(a){delete currentContext.lastActionOffline,wslog.info("Verify simulation fire:",a);var c={};if(null!=ifnull(a.matches.item)&&0!=a.matches.item.length?c.listOfItems=a.matches.item:c.listOfItems=[],ifnull(null!=a.matches.cartitem)&&0!=a.matches.cartitem.length?c.cart=organizeCart(a.matches.cartitem,!1):c.cart=[],c.listOfCategories=[],c.messages=[],c.selectedCatalog=currentContext.selectedCatalog,c.listOfBundles=[],delete c.listOfBundle,c.sessionParameters=[],c.matches={},null!=ifnull(a.matches.sessionparameter))for(var f=0;f<a.matches.sessionparameter.length;f++)c.sessionParameters[a.matches.sessionparameter[f].name]=a.matches.sessionparameter[f].value;c.sessionParameters.ItemsForPage=String(currentContext.itemsForPage),c.sessionParameters.SelectedCategoryId=currentContext.selectedCategory,c.sessionParameters.CurrentPage=String(currentContext.offset),c.sessionParameters.catalogId=currentContext.selectedCatalog.catalogid,1==currentContext.multicurrencyactivated?c.sessionParameters.isMultiCurrency="true":c.sessionParameters.isMultiCurrency="false",c.sessionParameters.GetAllData=d,c.sessionParameters.GetStructure=e,currentContext.cartOptions.sendmatches&&(c.matches=a.matches),c.errorCode="0",c.errorMessage=null,b(c)})})}catch(a){c(a)}}function retrieveCostSimulationData(a){var b=[];if(null!=ifnull(a.processObjects))b=a.processObjects;else{for(var c=0;c<currentContext.cart.length;c++)-1!=a.processIds.indexOf(currentContext.cart[c].fields.vid)&&b.push(currentContext.cart[c]);for(var c=0;c<currentContext.listOfItems.length;c++)-1!=a.processIds.indexOf(currentContext.listOfItems[c].fields.vid)&&b.push(currentContext.listOfItems[c])}return b}function generateWindowListener(){window.addEventListener("message",function(a){var b;try{b=JSON.parse(a.data),wslog.info("Received message: "),wslog.info(a.origin),wslog.info(currentContext.lexOrigin),wslog.info("messageReceived: ",b),wslog.info("messageReceived type: "+b.type),wslog.info("event.origin: "+a.origin),logMessage("Received Message","MessageJSON",b)}catch(a){b=new Object,b.type="unsupported"}a.origin==currentContext.lexOrigin&&"unsupported"!=b.type&&(0==currentContext.initInProgress&&0==currentContext.actionInProgress?(b.protectedMessage.type=b.type,b2wginCartToReturn.manageRequest(b.protectedMessage)):wslog.info("Init in progress, action skipped"))},!1),windowListenerGenerated=!0}function retrieveProgramPromise(a,b,c){return new Promise(function(d,e){b2wgindatainterceptor.retrieveProgram(a,b,c,function(c){wslog.info("Retrieve program "+a+" - "+b+" finished: "),"0"!=c.errorCode?e("Retrieve program "+a+"-"+b+" error: "+c.errorMessage):d("Retrieve program "+a+"-"+b+" successfull")})})}var CurrentContext=require("./currentContext.js"),cbResponse=require("./callbackResponse.js"),b2wgindatainterceptor=require("./interceptor.js"),isBrowser="undefined"!=typeof window&&"[object Window]"==={}.toString.call(window),currentContext=new CurrentContext,catalogEngine,wslog=require("./logging.js"),windowListenerGenerated=!1,labels={MaxQtyForBundleElement:"Max qty reached for bundle element",ItemMaxQty:"Max qty reached for item",CategoryMaxQty:"Max quantity reached for this category",CategoryMinQtyNotReached:"Category Min Qty not reached for the category",ItemMinQtyNotReached:"Item min quantity not reached for the item",DuplicateValueDetected:"Duplicated value detected",AttributeValidationError:"is not valid for family",AttributeRequired:"is required for family",ProductRequired:"is required for the category",CategoryRequired:"One or more items are required for the category:",ComplexCategoryRequired:"One or more items are required for the category:",CatalogItem:"Catalog Item",ConfigurationRequired:"The configuration is not valid for the item:",NoCatalogActive:"No catalog available. Check if the catalog is active in this date period",NoCatalogEligible:"No catalog available"},logMessage=function(a,b,c){try{if("active"==currentContext.debugMode)if("Message"==b&&(currentContext.dataInterceptor.debugLog+="Action '"+a+"' with content: "+c+"\n\n\n"),"MessageJSON"==b)currentContext.dataInterceptor.debugLog+="Action '"+a+"' with content: \n"+JSON.stringify(c)+"\n\n\n";else if("ActionStart"==b){var d=new Date,e=d.getMilliseconds()-f;currentContext.debugTimes[a]=e}else if("ActionEnd"==b){var f=currentContext.debugTimes[a],d=new Date,g=d.getMilliseconds()-f;currentContext.dataInterceptor.debugLog+="Action '"+a+"' Executed in: "+g+" milliseconds"+c+"\n\n\n",delete currentContext.debugTimes[a]}}catch(a){wslog.info("logError: "+a)}},sendMessage=function(a,b,c){wslog.info("cartOptions.enableCartEvents: "+currentContext.cartOptions.enableCartEvents);var d=!0;if(1==currentContext.blockSendMessage&&(d=!1),0==currentContext.cartOptions.enableCartEvents&&(d=!1),d){wslog.info("sending to lexOrigin: "+currentContext.lexOrigin),wslog.info("typeofmessage: "+a),wslog.info("Sending message"),wslog.info("message is",b),b.action=a,logMessage("Sending Message","MessageJSON",b),b=JSON.stringify(b);try{window.parent.postMessage(b,currentContext.lexOrigin)}catch(a){window.postMessage(b,currentContext.lexOrigin)}null!=c&&void 0!=c&&c()}},generateError=function(a){if(!currentContext.cartOptions.enableCartEvents)return!1;wslog.info("Error: "+a);var b=new Object;throw b.type="war",b.text=a,currentContext.dataInterceptor.retrieveItemsServiceOutput.messages=[],currentContext.dataInterceptor.retrieveItemsServiceOutput.messages.push(b),sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),a},generateContextObject=function(){var a=new Object;return a.currentrootvid=ifnull(currentContext.rootvid),a.currentvid=ifnull(currentContext.complexProductToOpen),a.currentcatalogname=currentContext.catalog.commModelName,a.configurator=null!=ifnull(currentContext.complexProductToOpen),a.currentcatalogid=currentContext.catalog.catalogid,a.dateTarget=currentContext.configuration.NE__order_date__c,a.confcurrency=currentContext.confcurrency,null!=ifnull(currentContext.currentBundle)&&(a.currentbundleid=currentContext.currentBundle.fields.id),null!=ifnull(currentContext.currentBundlevid)&&(a.currentbundlevid=currentContext.currentBundlevid),null!=ifnull(currentContext.currentBundleElement)&&(a.currentbundleelementid=currentContext.currentBundleElement.fields.id),wslog.info("Load context object: ",a),a},resetConfigurator=function(a){currentContext.complexProductId="",currentContext.rootvid=null,currentContext.rootCatalogitemid=null,currentContext.dataInterceptor.lastChild=null,currentContext.dataInterceptor.itemToShow=null,currentContext.productCatalogItemId="",currentContext.mapOfItemsInPages={},currentContext.countItemInCategory=0,"simpleWithAttributes"!=a&&(currentContext.complexProductToOpen=null),"simple"==a&&(currentContext.itemheaderId=null)},organizeCart=function(a,b){logTimeStart("[EXECUTION_TIME] organizeCart");var c=Object.assign([],a);wslog.info("cartitemstosend to organize: ",c);var d=[],e={};currentContext.cartMap={};var f={};f.LastNumber=100;for(var g=0;g<c.length;g++)c[g].childItems=[],wslog.info("cartitemstosend[i].fields.type: ",c[g].fields.type),"Product"==c[g].fields.type&&(wslog.info("adding to cartmap: ",e),e[c[g].fields.vid]=c[g]),currentContext.cartMap[c[g].fields.vid]=c[g];for(var g=0;g<c.length;g++){if(null==ifnull(c[g].fields.bundleId)&&(c[g].fields.bundleId=null),"Child-Product"==c[g].fields.type){var h=e[c[g].fields.rootvid];h.childItems.push(c[g]),e[h.fields.vid]=h}if(null!=ifnull(c[g].fields.bundleId)&&null==ifnull(c[g].fields.bundlevid)){var i=f.LastNumber;i+=100,f[c[g].fields.vid]=i,f[c[g].fields.vid+"_last"]=i,f.LastNumber=i}var j=!1;if(wslog.info("Start executeValidationChecks: "+b),1==b){var k=c[g].listOfAttributes.length,l=c[g].listOfAttributes;if(k>0)for(var m=0;m<k;m++){var n=l[m];if(null==ifnull(n))break;var o=validateAttribute(c[g],n,!1);1==o.modifyFact&&(j=!0)}wslog.info("modifyFact: "+j),1==j&&(null==ifnull(currentContext.asynchData)&&(currentContext.postEngineData=[]),currentContext.postEngineData.push(c[g]))}}for(var p in e){var q=e[p];d.push(q),currentContext.saveBackup&&q.fields.vid==currentContext.complexProductToOpen&&null==currentContext.backUpConfiguration&&(wslog.info("Backup saved"),currentContext.backUpConfiguration=JSON.stringify(q),currentContext.saveBackup=!1)}wslog.info("organizeCart organizedCartArray: ",d);var r=d.sort(function(a,b){return assignCartItemNumber(a,f)-assignCartItemNumber(b,f)});return logTimeEnd("[EXECUTION_TIME] organizeCart"),r},addItemFromMessage=function(a,b,c){var d=generateContextObject(),e={};for(var f in d)e[f]=d[f];var g=a.itemEngineCode;e.source="Message";for(var h=null,i=0;i<currentContext.listOfItems.length;i++){var j=currentContext.listOfItems[i];j.fields.enginecode==g&&(h=j)}if(null!=ifnull(h))wslog.info("retrieve item from list"),addItemToCart(h,function(a){b(a)},function(a){c(a)});else{wslog.info("search for item");var k={};k.MapCatItemList=[];var l={};l.name="engine_code__c",l.operator="=",l.value=g,k.MapCatItemList.push(l),k.MapDynamicList=[],k.MapProductList=[],k.MapStaticList=[],k.searchOptions={},k.searchOptions.enableSearchAndAdd=!0,searchItems(k,function(a){b(a)},function(a){c(a)})}},addItemToCart=function(a,b,c){var d;if("Message"!=a.fields.source)for(var e=0;e<currentContext.listOfItems.length;e++){var f=currentContext.listOfItems[e];if(f.fields.id==a.fields.id&&f.fields.bundleId==a.fields.bundleId&&f.fields.bundleElement==a.fields.bundleElement){wslog.info("Found item to add into the list with id: "+f.fields.id),0==a.fields.qty?f.fields.qty=1:f.fields.qty=a.fields.qty;var g=JSON.stringify(f);d=JSON.parse(g),d.fields.vid=Math.random().toString(36).substring(3),d.fields.itemCode=d.fields.vid,"configureCatalogItem"==currentContext.lastMessageAction?(d.fields.isCatalogItem=!0,d.fields.isCart=!1):(d.fields.isCatalogItem=!1,d.fields.isCart=!0),null!=ifnull(currentContext.currentBundleElement)&&null!=ifnull(currentContext.currentBundle)&&null!=ifnull(currentContext.currentBundlevid)&&(d.fields.bundlevid=currentContext.currentBundlevid,d.fields.bundleId=currentContext.currentBundle.fields.id,d.fields.bundleElement=currentContext.currentBundleElement.fields.id);break}}else wslog.info("Received item from message source"),d=a;currentContext.itemheaderId=ifnull(d.fields.itemHeader),wslog.info("Current complexProductToOpen",currentContext.complexProductToOpen),currentContext.lastItemAdded=d,"Child-Product"==d.fields.type&&(d.fields.parentvid=currentContext.complexProductToOpen,d.fields.rootvid=currentContext.rootvid,currentContext.dataInterceptor.lastChild=d);var h=!1,i=!1;(null!=currentContext.itemheaderId||null!=d.listOfAttributes&&"undefined"!=d.listOfAttributes&&d.listOfAttributes.length>0)&&("Product"==d.fields.type?("Configuration Required"==d.fields.configurationtype||"Auto Configuration"==d.fields.configurationtype||1==d.fields.isCatalogItem?(currentContext.complexProductToOpen=d.fields.vid,currentContext.complexProductId=d.fields.catalogitemid,currentContext.rootvid=d.fields.vid,currentContext.productCatalogItemId=d.fields.catalogitemid,"Auto Configuration"==d.fields.configurationtype&&(currentContext.blockSendMessage=!0),h=!0):h=!1,i=!0):"Child-Product"==d.fields.type&&"Configuration Required"==d.fields.configurationtype&&(h=!0)),null==ifnull(currentContext.itemheaderId)&&(currentContext.getDataOptionsMap.skipCall=!0),wslog.info("Adding item: ",d),wslog.info("itemheaderId: "+currentContext.itemheaderId),wslog.info("openConfigurator: "+h),wslog.info("isConfigurable: "+i);var j=catalogEngine.createAndAdd(d,"cartitem");currentContext.cart.push(j),wslog.info("itemAddedInEngine: ",j),wslog.info("Refresh context");var k=currentContext.cartadministration.GetStructure;if(null!=currentContext.itemheaderId&&k){wslog.info("**** adding default ***");for(var l={},m="Product"==d.fields.type?d.fields.id:"",n="",e=0;e<currentContext.listOfItems.length;e++){var o=currentContext.listOfItems[e],p=Object.assign(new Object,o),q=p.fields.id,r=(p.fields.vid,p.fields.itemHeader),s=p.fields.defaultQty,t=p.fields.type,u=p.fields.parentvid,v=p.fields.rootvid;if(r==currentContext.itemheaderId&&null==ifnull(p.fields.bundleId))if(q==d.fields.id&&"Product"==t?n=d.fields.vid:null!=ifnull(currentContext.rootvid)&&(n=currentContext.rootvid),q==d.fields.id)p=d,l[q]=p;else if(-1==currentContext.listOfItems.findIndex(function(a){return a.fields.id==u})&&(u=m),v=n,s>=1&&ifnull(l[u])){p.fields.vid=Math.random().toString(36).substring(3),p.fields.itemCode=p.fields.vid,p.fields.parentvid=l[u].fields.vid,p.fields.rootvid=v,p.fields.qty=s,p.fields.visible=p.fields.visiblefromdb;var j=catalogEngine.createAndAdd(p,"cartitem");currentContext.cart.push(j),l[q]=p}}"Product"==d.fields.type&&1==h?wslog.info("Retrieve items call postponed"):0==h?retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"Child-Product"==d.fields.type?currentContext.complexProductId:"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(a){b(a)},function(a){c(a)}):modifyItem(d,function(a){b(a)},function(a){c(a)})}else"Child-Product"==d.fields.type?1==d.fields.hasDefaultChildren||"true"==d.fields.hasDefaultChildren?b2wgindatainterceptor.retrieveAutoAddedChildren(d.fields.rootvid,d.fields.vid,d.fields.catalogitemid,currentContext.getDataOptionsMap,function(a){if("0"!=a.errorCode)return generateError("getAutoAddedChildrenResponse: "+a.errorMessage),c(a.errorMessage),!1;wslog.info("added children: ",a);for(var e in a.result)if(a.result.hasOwnProperty(e))if(wslog.info(e+" -> "+a.result[e]),"-1"!=e.indexOf("___")){var f=e.split("___")[0],g=a.result[e];g.constructor!==Object&&(g=JSON.parse(a.result[e])),g.fields.visible=g.fields.visiblefromdb,"cartitem"==f&&null!=ifnull(currentContext.currentBundlevid)&&null!=ifnull(currentContext.currentBundleElement)&&(g.fields.bundleElement=currentContext.currentBundleElement.fields.id,g.fields.bundleId=currentContext.currentBundleElement.fields.bundleid,g.fields.bundlevid=currentContext.currentBundlevid),catalogEngine.createAndAdd(g,f),"undefined"!=currentContext.moduleAppVar[f]&&null!=currentContext.moduleAppVar[f]||(wslog.info("Initialize list: "+f),currentContext.moduleAppVar[f]=[]),currentContext.moduleAppVar[f].push(g)}else{var g=a.result[e];g.constructor!==Object&&(g=JSON.parse(a.result[e])),currentContext.moduleAppVar[e]=g,catalogEngine.createAndAdd(g,e),currentContext.contextdata[e]=e}0==h?retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(a){b(a)},function(a){c(a)}):modifyItem(d,function(a){b(a)},function(a){c(a)})},function(a){c(a)},{escape:!1}):0==h?retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(a){b(a)},function(a){c(a)}):modifyItem(d,function(a){b(a)},function(a){c(a)}):"Product"==d.fields.type&&0==h&&(1==i&&null!=ifnull(d.fields.itemHeader)?(currentContext.moduleAppVar.complex_category=[],wslog.info("retrieve complex data but i will not configure it"),b2wgindatainterceptor.retrieveComplexProductsData(d.fields.vid,d.fields.itemHeader,currentContext.catalog.catalogid,currentContext.configuration.NE__order_date__c,currentContext.lastMessageType,currentContext.lastMessageAction,currentContext.getDataOptionsMap,function(a){if("0"!=a.errorCode)return generateError("getComplexReturn: "+a.errorMessage),c(a.errorMessage),!1;for(var d in a.result)if(a.result.hasOwnProperty(d)&&(wslog.info(d+" -> "+a.result[d]),"-1"!=d.indexOf("___"))){var e=d.split("___")[0];if("cartitem"==e){var f=a.result[d];f.constructor!==Object&&(f=JSON.parse(a.result[d])),"cartitem"==e&&null!=ifnull(currentContext.currentBundlevid)&&null!=ifnull(currentContext.currentBundleElement)&&(f.fields.bundleElement=currentContext.currentBundleElement.fields.id,f.fields.bundleId=currentContext.currentBundleElement.fields.bundleid,f.fields.bundlevid=currentContext.currentBundlevid),f.fields.visible=f.fields.visiblefromdb,catalogEngine.createAndAdd(f,e),"undefined"!=currentContext.moduleAppVar[e]&&null!=currentContext.moduleAppVar[e]||(wslog.info("Initialize list: "+e),currentContext.moduleAppVar[e]=[]),currentContext.moduleAppVar[e].push(f)}}retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(a){b(a)},function(a){c(a)})},function(a){b(a)},{escape:!1})):retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(a){b(a)},function(a){c(a)}));"Product"==d.fields.type&&1==h&&(currentContext.saveBackup=!0,retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(a){wslog.info("trying to open the product: "+currentContext.complexProductToOpen),currentContext.dataInterceptor.configure=!0,currentContext.dataInterceptor.componentToShow="configurator";var e={};e.action="startLoading",sendMessage("startLoading",e),wslog.info("itemToAdd.fields.configurationtype: "+d.fields.configurationtype),null!=ifnull(currentContext.itemheaderId)&&(currentContext.saveBackup=!0,currentContext.backUpConfiguration=null),"Auto Configuration"==d.fields.configurationtype?changeProgramContext("complex",currentContext.itemheaderId,function(){currentContext.blockSendMessage=!1,resetSaveConfiguration(function(a){b(a)},function(a){c(a)})}):changeProgramContext("complex",currentContext.itemheaderId,function(){b()},function(a){c(a)})}))},changeProgramContext=function(a,b,c,d){if(wslog.info("changeProgramContext: "+a),wslog.info("changeitemheaderId: "+b),wslog.info("complexProductToOpen: "+currentContext.complexProductToOpen),wslog.info("complexProductId: "+currentContext.complexProductId),wslog.info("rootvid: "+currentContext.rootvid),"complex"==a){if(currentContext.dataInterceptor.componentToShow="configurator",currentContext.componentToShow="configurator",null!=ifnull(currentContext.complexProductToOpen)&&null!=b&&""!=b){currentContext.moduleAppVar.category=[],currentContext.moduleAppVar.complex_category=[];var e;e=null==ifnull(currentContext.lastItemAdded)?currentContext.rootvid:currentContext.lastItemAdded.fields.vid,wslog.info("addedRootVid: "+e),currentContext.getDataOptionsMap.currentCatalogItemId=currentContext.productCatalogItemId,currentContext.moduleAppVar.complex_category=[],b2wgindatainterceptor.retrieveComplexProductsData(e,b,currentContext.catalog.catalogid,currentContext.configuration.NE__order_date__c,currentContext.lastMessageType,currentContext.lastMessageAction,currentContext.getDataOptionsMap,function(a){if("0"!=a.errorCode)return generateError("getComplexReturn: "+a.errorMessage),d(a.errorMessage),!1;null!=ifnull(b)?(currentContext.programname=a.result.programName,currentContext.version=a.result.programVersion):(a.result.programName=currentContext.programname,a.result.programVersion=currentContext.version),wslog.info("Program (complex program): "+currentContext.programname),wslog.info("version: "+currentContext.version),currentContext.dataInterceptor.componentToShow="configurator",wslog.info("cart.length init program: "+currentContext.cart.length),currentContext.rootCatalogitemid=a.result.rootCatalogitemid,delete a.result.rootCatalogitemid,wslog.info("rootCatalogitemid: "+currentContext.rootCatalogitemid),b2wgindatainterceptor.retrieveProgram(currentContext.programname,currentContext.version,currentContext.organizationId,function(b){if("0"!=b.errorCode)return generateError("retrieveProgram: "+b.errorMessage),d(b.errorMessage),!1;wslog.info("Retrieve after entering into the product"),catalogEngine=b,catalogEngine.clearSession(),currentContext.moduleAppVar.complex_category=null,wslog.info("Load complex item data",a);for(var e in a.result)if(a.result.hasOwnProperty(e))if(wslog.info(e+" -> "+a.result[e]),"-1"!=e.indexOf("___")){var f=e.split("___")[0],g=a.result[e];g.constructor!==Object&&(g=JSON.parse(a.result[e])),"cartitem"==f&&null!=ifnull(currentContext.currentBundlevid)&&null!=ifnull(currentContext.currentBundleElement)&&(g.fields.bundleElement=currentContext.currentBundleElement.fields.id,g.fields.bundleId=currentContext.currentBundleElement.fields.bundleid,g.fields.bundlevid=currentContext.currentBundlevid),catalogEngine.createAndAdd(g,f),"undefined"!=currentContext.moduleAppVar[f]&&null!=currentContext.moduleAppVar[f]||(wslog.info("Initialize list: "+f),currentContext.moduleAppVar[f]=[]),currentContext.moduleAppVar[f].push(g)}else if("programName"==e||"programVersion"==e)currentContext.moduleAppVar[e]=a.result[e];else{var g=a.result[e];g.constructor!==Object&&(g=JSON.parse(a.result[e])),currentContext.moduleAppVar[e]=g,catalogEngine.createAndAdd(g,e),currentContext.contextdata[e]=e}currentContext.selectedCategory=currentContext.moduleAppVar.complex_category[0].categoryFields.id;for(var h=0;h<currentContext.moduleAppVar.complex_category.length;h++)if("Root"==currentContext.moduleAppVar.complex_category[h].categoryFields.parenttype){currentContext.selectedCategory=currentContext.moduleAppVar.complex_category[h].categoryFields.id;break}wslog.info("b2wgin_cart before changing product category: ",currentContext.selectedCategory);for(var h=0;h<currentContext.cart.length;h++)catalogEngine.createAndAdd(currentContext.cart[h],"cartitem");wslog.info("restoring context contextdata ",currentContext.contextdata);for(var i in currentContext.contextdata)if(wslog.info("Restoring key: "+i),null!=ifnull(currentContext.moduleAppVar[i]))if(currentContext.moduleAppVar[i]instanceof Array)for(var j=currentContext.moduleAppVar[i],h=0;h<j.length;h++)catalogEngine.createAndAdd(j[h],i);else catalogEngine.createAndAdd(currentContext.moduleAppVar[i],i);retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(){wslog.info("Send complex data to open: "+currentContext.complexProductToOpen);for(var a=0;a<currentContext.dataInterceptor.retrieveItemsServiceOutput.cart.length;a++)if(currentContext.complexProductToOpen==currentContext.dataInterceptor.retrieveItemsServiceOutput.cart[a].fields.vid){currentContext.dataInterceptor.itemToShow=currentContext.dataInterceptor.retrieveItemsServiceOutput.cart[a];break}wslog.info("cart.length Send complex data: "+currentContext.cart.length),currentContext.dataInterceptor.configure=!0,sendMessage("changeComponentToShow",currentContext.dataInterceptor),wslog.info("Complex change context callback"),c()},function(a){d(a)})},function(a){d(a)})},function(a){d(a)},{escape:!1})}else if(null!=ifnull(currentContext.complexProductToOpen)){wslog.info("Simple product: Send only attributes data to open",currentContext.complexProductToOpen),resetConfigurator("simpleWithAttributes");for(var f=0;f<currentContext.dataInterceptor.retrieveItemsServiceOutput.cart.length;f++)if(currentContext.complexProductToOpen==currentContext.dataInterceptor.retrieveItemsServiceOutput.cart[f].fields.vid){currentContext.dataInterceptor.itemToShow=currentContext.dataInterceptor.retrieveItemsServiceOutput.cart[f];break}var g=!1;null!=currentContext.moduleAppVar["simple_program___"+currentContext.dataInterceptor.itemToShow.id]&&""!=currentContext.moduleAppVar["simple_program___"+currentContext.dataInterceptor.itemToShow.id]&&void 0!=currentContext.moduleAppVar["simple_program___"+currentContext.dataInterceptor.itemToShow.id]?(currentContext.programname=currentContext.moduleAppVar["simple_program___"+currentContext.dataInterceptor.itemToShow.id].split(":")[0],currentContext.version=currentContext.moduleAppVar["simple_program___"+currentContext.dataInterceptor.itemToShow.id].split(":")[1],g=!0):void 0!=currentContext.dataInterceptor.itemToShow.fields.programname&&null!=currentContext.dataInterceptor.itemToShow.fields.programname&&""!=currentContext.dataInterceptor.itemToShow.fields.programname&&(currentContext.programname=currentContext.dataInterceptor.itemToShow.fields.programname,currentContext.version="1",g=!0),g?(wslog.info("Program (simple program): "+currentContext.programname),wslog.info("version: "+currentContext.version),b2wgindatainterceptor.retrieveProgram(currentContext.programname,currentContext.version,currentContext.organizationId,function(a){if("0"!=a.errorCode)return generateError("retrieveProgram: "+a.errorMessage),d(a.errorMessage),!1;wslog.info("Retrieve after entering into the product"),catalogEngine=a,catalogEngine.clearSession(),currentContext.moduleAppVar.complex_category=null,wslog.info("Load simple, item data",currentContext.dataInterceptor.itemToShow),currentContext.moduleAppVar.programName=currentContext.programname,currentContext.moduleAppVar.programVersion=currentContext.version;for(var b=0;b<currentContext.cart.length;b++)catalogEngine.createAndAdd(currentContext.cart[b],"cartitem");wslog.info("restoring context contextdata ",currentContext.contextdata);for(var e in currentContext.contextdata)if(wslog.info("Restoring key: "+e),null!=ifnull(currentContext.moduleAppVar[e]))if(currentContext.moduleAppVar[e]instanceof Array)for(var f=currentContext.moduleAppVar[e],b=0;b<f.length;b++)catalogEngine.createAndAdd(f[b],e);else catalogEngine.createAndAdd(currentContext.moduleAppVar[e],e);retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(){wslog.info("Send complex data to open: "+currentContext.complexProductToOpen);for(var a=0;a<currentContext.dataInterceptor.retrieveItemsServiceOutput.cart.length;a++)if(currentContext.complexProductToOpen==currentContext.dataInterceptor.retrieveItemsServiceOutput.cart[a].fields.vid){currentContext.dataInterceptor.itemToShow=currentContext.dataInterceptor.retrieveItemsServiceOutput.cart[a];break}wslog.info("cart.length Send complex data: "+currentContext.cart.length),currentContext.dataInterceptor.configure=!0,sendMessage("changeComponentToShow",currentContext.dataInterceptor),wslog.info("Simple change context callback"),c()},function(a){d(a)})},function(a){d(a)})):(wslog.info("Program (catalog program for simple catalog item): "+currentContext.programname),wslog.info("version: "+currentContext.version),wslog.info("cart.length Send simple data: "+currentContext.cart.length),currentContext.dataInterceptor.configure=!0,sendMessage("changeComponentToShow",currentContext.dataInterceptor),c())}}else"simple"==a&&(currentContext.programname=currentContext.catalogprogramname,currentContext.version=currentContext.catalogversion,currentContext.dataInterceptor.componentToShow="catalog",currentContext.componentToShow="catalog",currentContext.moduleAppVar.category=[],currentContext.moduleAppVar.complex_category=[],resetConfigurator("simple"),wslog.info("Program (catalog program): "+currentContext.programname),wslog.info("version: "+currentContext.version),b2wgindatainterceptor.retrieveProgram(currentContext.programname,currentContext.version,currentContext.organizationId,function(a){if("0"!=a.errorCode)return generateError("retrieveProgram: "+a.errorMessage),d(a.errorMessage),!1;catalogEngine=a,catalogEngine.clearSession(),null!=ifnull(currentContext.taxModelsParameters)&&(currentContext.getDataOptionsMap.taxModelsParameters=currentContext.taxModelsParameters,currentContext.getDataOptionsMap.catalogHeaderId=currentContext.catalog.headerid,currentContext.getDataOptionsMap.configurationDate=currentContext.configuration.NE__order_date__c),b2wgindatainterceptor.retrieveCatalogData(currentContext.catalog.catalogid,"",currentContext.getDataOptionsMap,function(a){if("0"!=a.errorCode)return generateError("retrieveCatalogData: "+a.errorMessage),d(a.errorMessage),!1;wslog.info("Load catalog data"),currentContext.category=null;for(var b in a.result)if(a.result.hasOwnProperty(b))if(wslog.info(b+" -> "+a.result[b]),"-1"!=b.indexOf("___")){var e=b.split("___")[0],f=a.result[b];f.constructor!==Object&&(f=JSON.parse(f)),catalogEngine.createAndAdd(f,e),"undefined"!=currentContext.moduleAppVar[e]&&null!=currentContext.moduleAppVar[e]||(wslog.info("Initialize list: "+e),currentContext.moduleAppVar[e]=[]),currentContext.moduleAppVar[e].push(f),"taxmodel"==e&&(currentContext.contextdata[e]=e)}else currentContext.moduleAppVar[b]=a.result[b],catalogEngine.createAndAdd(JSON.parse(a.result[b]),b);null!=ifnull(currentContext.catalogSelectedCategory)?currentContext.selectedCategory=currentContext.catalogSelectedCategory:currentContext.selectedCategory=currentContext.category.filter(function(a){return"false"===a.categoryFields.hidden})[0].categoryFields.id;for(var g=0;g<currentContext.cart.length;g++)catalogEngine.createAndAdd(currentContext.cart[g],"cartitem");wslog.info("restoring context contextdata ",currentContext.contextdata);for(var h in currentContext.contextdata)if(null!=ifnull(currentContext.moduleAppVar[h]))if(currentContext.moduleAppVar[h]instanceof Array)for(var i=currentContext.moduleAppVar[h],g=0;g<i.length;g++)catalogEngine.createAndAdd(i[g],h);else catalogEngine.createAndAdd(currentContext.moduleAppVar[h],h);wslog.info("Simple change context to simple"),currentContext.complexProductToOpen="Catalog",retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(){c()},function(a){d(a)})},{escape:!1})},function(a){d(a)}))},removeItemFromCart=function(a,b,c){var d,e={};e[a.fields.vid]=a.fields.vid;for(var f=[],g=[],h=0;h<currentContext.cart.length;h++)d=currentContext.cart[h],wslog.info("Check item for removing ",d),d.fields.vid==a.fields.vid||null!=ifnull(d.fields.parentvid)&&null!=ifnull(e[d.fields.parentvid])?(wslog.info("Found item to remove from the list with vid: "+d.fields.vid),catalogEngine.remove(d),delete currentContext.cartMap[d.fields.vid],e[d.fields.vid]=d.fields.vid):(null!=ifnull(a.fields.bundleId)&&null==ifnull(a.fields.bundleElement)&&null==ifnull(d.fields.parentvid)&&d.fields.bundlevid==a.fields.vid&&g.push(d),f.push(d));currentContext.cart=f;for(var h=0;h<g.length;h++)removeItemFromCart(g[h]);wslog.info("Refresh context after removing ",e),currentContext.complexProductId=ifnull(currentContext.complexProductId),currentContext.productCatalogItemId=ifnull(currentContext.productCatalogItemId),void 0!=b&&(a.fields.isRollback?(delete a.fields.isRollback,b()):a.fields.isCatalogItem?null!=ifnull(currentContext.itemheaderId)?resetSaveConfiguration(function(a){b(a)},function(a){c(a)}):(currentContext.blockSendMessage=!0,retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(a){currentContext.blockSendMessage=!1,resetSaveConfiguration(function(a){b(a)},function(a){c(a)})},function(a){c(a)})):null!=ifnull(currentContext.currentBundlevid)&&null!=ifnull(a.fields.bundleId)&&null==ifnull(a.fields.bundleElement)?saveBundle(function(a){sendMessage("changeComponentToShow",currentContext.dataInterceptor),b(a)}):retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(a){b(a)},function(a){c(a)}))},clearCart=function(a,b){for(var c=0;c<currentContext.cart.length;c++){var d=currentContext.cart[c];catalogEngine.remove(d)}retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(b){a(b)},function(a){b(a)})},retrieveCatalogItems=function(a,b,c,d,e,f,g,h){logTimeStart("[EXECUTION_TIME] retrieveCatalogItems took"),logTimeStart("[EXECUTION_TIME] agCleanCatalog took"),catalogEngine.fire(ifnull(currentContext.agendaGroupsMap.agCleanCatalog),function(i){logTimeEnd("[EXECUTION_TIME] agCleanCatalog took"),delete currentContext.lastActionOffline,f.currentCatalogItemId=null!=currentContext.productCatalogItemId&&void 0!=currentContext.productCatalogItemId?currentContext.productCatalogItemId:"",f.itemheaderId=null!=currentContext.itemheaderId&&void 0!=currentContext.itemheaderId?currentContext.itemheaderId:"";var j=!1;null!=ifnull(c)&&"retrieveItemsFromBundleElement"!=currentContext.lastMessageType||null==ifnull(currentContext.currentBundleElement)||(c=currentContext.currentBundleElement.fields.id,j=!0),wslog.info("Verifying skip call: "+currentContext.lastMessageType),"changeAttribute"==currentContext.lastMessageType&&(f.skipCall=!0,currentContext.getDataOptionsMap.skipCall=!0),logTimeStart("[EXECUTION_TIME] retrieveCatalogItemsAttachment took"),b2wgindatainterceptor.retrieveCatalogItemsAttachment(a,b,c,d,e,f,function(a){if(logTimeEnd("[EXECUTION_TIME] retrieveCatalogItemsAttachment took"),wslog.info("Load catalog items data ",a),"0"!=a.errorCode)return generateError("retrieveCatalogItemsAttachment: "+a.errorMessage),h(a.errorMessage),!1;j&&(c=null),wslog.info("complexProductToOpen ",currentContext.complexProductToOpen),null!=ifnull(currentContext.complexProductToOpen)&&"Catalog"!=currentContext.complexProductToOpen||(currentContext.offset=parseInt(e));var b=0;void 0!=currentContext.countItemInCategory&&null!=currentContext.countItemInCategory||(currentContext.countItemInCategory=0);var d=0,i=a.itemsNumber,k="true"==f.GetAllData,l="true"==f.GetStructure;for(var m in a.result)if(a.result.hasOwnProperty(m))if(wslog.info(m+" -> "+a.result[m]),"-1"!=m.indexOf("___")){var n,o=m.split("___")[0];if("itemHeader"!=o&&"complex_program"!=o&&"catCategory"!=o&&"simple_program"!=o&&(n=a.result[m].constructor===String?JSON.parse(a.result[m]):a.result[m]),"item"!=o||null!=ifnull(currentContext.complexProductToOpen)&&"Catalog"!=currentContext.complexProductToOpen)"item"==o&&(null==ifnull(currentContext.productCatalogItemId)&&"Child-Product"==n.fields.type&&currentContext.selectedCategory!=n.fields.categoryid?n.fields.visible="false":n.fields.visible=n.fields.visiblefromdb,k&&"Product"==n.fields.type&&currentContext.selectedCategory!=n.fields.categoryid&&(n.fields.visible="false"));else{if(wslog.info("itemCounter: "+b+" currentContext.itemsForPage: "+currentContext.itemsForPage),n.fields.vid=Math.random().toString(36).substring(3),n.fields.itemCode=n.fields.vid,wslog.info("complexProductToOpen: "+currentContext.complexProductToOpen+" parsedElement.fields.type: "+n.fields.type),null!=ifnull(currentContext.complexProductToOpen)&&"Catalog"!=currentContext.complexProductToOpen||"Child-Product"!=n.fields.type?n.fields.visible=n.fields.visiblefromdb:n.fields.visible="false",k&&"Product"==n.fields.type&&currentContext.selectedCategory!=n.fields.categoryid&&(n.fields.visible="false"),k||l){if("true"==n.fields.visible){d++;var p=currentContext.itemsForPage*currentContext.offset-(currentContext.itemsForPage-1),q=currentContext.itemsForPage*currentContext.offset;if(d<p||d>q){wslog.info("Not in range, item skipped");continue}}}else if("true"==n.fields.visible){var r="";void 0!=currentContext.mapOfItemsInPages&&null!=currentContext.mapOfItemsInPages||(currentContext.mapOfItemsInPages={}),null!=currentContext.mapOfItemsInPages[e]&&""!=currentContext.mapOfItemsInPages[e]&&void 0!=currentContext.mapOfItemsInPages[e]?r=currentContext.mapOfItemsInPages[e]:currentContext.mapOfItemsInPages[e]=r;var s=!1;for(var t in currentContext.mapOfItemsInPages)if(-1!=currentContext.mapOfItemsInPages[t].indexOf(n.fields.id)&&t!=e){wslog.info("Already added in page "+t+" , item skipped"),s=!0;break}if(s)continue;if(b++,currentContext.countItemInCategory++,b>currentContext.itemsForPage){wslog.info("Not in range, item skipped");continue}-1==r.indexOf(n.fields.id)&&(r+=n.fields.id+";"),currentContext.mapOfItemsInPages[e]=r}null!=currentContext.currentBundleElement&&(n.fields.bundleElement=currentContext.currentBundleElement.fields.id,n.fields.bundleId=currentContext.currentBundleElement.fields.bundleid)}"itemHeader"!=o&&"complex_program"!=o&&"complex_category"!=o&&"catCategory"!=o&&"simple_program"!=o?catalogEngine.createAndAdd(n,o):"simple_program"==o&&(currentContext.moduleAppVar[m]=a.result[m])}else currentContext.moduleAppVar[m]=a.result[m],catalogEngine.createAndAdd(JSON.parse(a.result[m]),m);if(1==f.skipCall){delete f.skipCall,delete currentContext.getDataOptionsMap.skipCall;for(var u=0;u<currentContext.listOfItems.length;u++)catalogEngine.createAndAdd(currentContext.listOfItems[u],"item")}if(wslog.info("Setted offset ",currentContext.offset),null!=c&&""!=c&&null!=ifnull(currentContext.itemheaderId))for(var u=0;u<currentContext.moduleAppVar.complex_category.length;u++)catalogEngine.createAndAdd(currentContext.moduleAppVar.complex_category[u],"complex_category");else{for(var u=0;u<currentContext.moduleAppVar.category.length;u++)catalogEngine.createAndAdd(currentContext.moduleAppVar.category[u],"category");if(l&&null!=ifnull(currentContext.moduleAppVar.bundleItems))for(var u=0;u<currentContext.moduleAppVar.bundleItems.length;u++)catalogEngine.createAndAdd(currentContext.moduleAppVar.bundleItems[u],"item")}catalogEngine.createAndAdd(generateContextObject(),"contextdata"),wslog.info("lastMessageType: ",currentContext.lastMessageType),wslog.info("Using agenda groups: ",ifnull(currentContext.agendaGroupsMap[currentContext.lastMessageType])),logTimeStart("[EXECUTION_TIME] main fire took");var v=ifnull(currentContext.agendaGroupsMap[currentContext.lastMessageType]);if(null!=ifnull(currentContext.requestOptions)&&null!=ifnull(currentContext.requestOptions.agendaGroups))if(v=JSON.stringify(v),v=JSON.parse(v),currentContext.skipCartAgendas)v.grouprules=currentContext.requestOptions.agendaGroups;else{for(var w=v.grouprules,x=[],y=0;y<w.length;y++)x.push(w[y]),"agAlways"==w[y]&&(x=x.concat(currentContext.requestOptions.agendaGroups));wslog.info("newGroupArray: ",x),v.grouprules=x}catalogEngine.fire(v,function(a){logTimeEnd("[EXECUTION_TIME] main fire took"),logTimeStart("[EXECUTION_TIME] agSystem took"),catalogEngine.fire(ifnull(currentContext.agendaGroupsMap.agSystem),function(a){logTimeEnd("[EXECUTION_TIME] agSystem took"),logTimeStart("[EXECUTION_TIME] agPostSystem took"),catalogEngine.fire(ifnull(currentContext.agendaGroupsMap.agPostSystem),function(a){logTimeEnd("[EXECUTION_TIME] agPostSystem took"),wslog.info("Verify catalogEngine after fire:",a),null!=ifnull(a.matches.item)&&0!=a.matches.item.length?currentContext.listOfItems=a.matches.item:currentContext.listOfItems=[],ifnull(null!=a.matches.cartitem)&&0!=a.matches.cartitem.length?currentContext.cart=a.matches.cartitem:currentContext.cart=[],currentContext.configuration=a.matches.configuration[0],currentContext.configuration.NE__ConfigurationStatus__c=currentContext.configuration.NE__configurationstatus__c,currentContext.configuration.NE__CatalogId__c=currentContext.selectedCatalog.catalogid,currentContext.configuration.NE__CommercialModelId__c=currentContext.selectedCatalog.commercialModelId,currentContext.prefix=currentContext.dataInterceptor.prefix,null!=ifnull(a.matches.category)?currentContext.moduleAppVar.category=a.matches.category:currentContext.moduleAppVar.category=a.matches.complex_category;var b={},c=currentContext.moduleAppVar.category.sort(function(a,c){"true"==a.categoryFields.hidden&&(b[a.categoryFields.id]=a.categoryFields.hidden),"true"==c.categoryFields.hidden&&(b[c.categoryFields.id]=c.categoryFields.hidden);var d=assignCategoryNumber(a),e=assignCategoryNumber(c);if(d==e){return a.categoryFields.sequence-c.categoryFields.sequence}return d-e});currentContext.moduleAppVar.category=c;var e=currentContext.listOfItems.sort(function(a,c){null!=ifnull(b[a.fields.categoryid])&&(a.fields.visible="false"),null!=ifnull(b[c.fields.categoryid])&&(c.fields.visible="false");var d=assignItemNumber(a),e=assignItemNumber(c);if(d>=2&&d<=7&&d==e){return a.fields.sequence-c.fields.sequence}return d-e});if(1==e.length&&null!=ifnull(b[e[0].fields.categoryid])&&(e[0].fields.visible="false"),currentContext.listOfItems=e,null==ifnull(a.matches.message)?currentContext.messages=[]:currentContext.messages=a.matches.message,null==ifnull(a.matches.bundle)?currentContext.listOfbundles=[]:currentContext.listOfbundles=a.matches.bundle,currentContext.dataInterceptor.retrieveItemsServiceOutput.listOfCategories=currentContext.moduleAppVar.category,currentContext.dataInterceptor.retrieveItemsServiceOutput.listOfItems=currentContext.listOfItems,currentContext.dataInterceptor.selectedCatalog=currentContext.selectedCatalog,currentContext.dataInterceptor.retrieveItemsServiceOutput.listOfBundles=currentContext.listOfbundles,delete currentContext.dataInterceptor.retrieveItemsServiceOutput.listOfBundle,null!=ifnull(a.matches.sessionparameter))for(var f=0;f<a.matches.sessionparameter.length;f++)currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters[a.matches.sessionparameter[f].name]=a.matches.sessionparameter[f].value;currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.ItemsForPage=String(currentContext.itemsForPage),currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.SelectedCategoryId=currentContext.selectedCategory,currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.CurrentPage=String(currentContext.offset),currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.catalogId=currentContext.selectedCatalog.catalogid,1==currentContext.multicurrencyactivated?currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.isMultiCurrency="true":currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.isMultiCurrency="false",currentContext.dataInterceptor.retrieveItemsServiceOutput.currentBundlevid=currentContext.currentBundlevid,null!=ifnull(currentContext.currentBundleElement)&&null!=ifnull(currentContext.currentBundle)&&null!=ifnull(currentContext.currentBundlevid)?currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.countitem_bundleelement=i:delete currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.countitem_bundleelement,currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.GetAllData=k,currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters.GetStructure=l,(k||l)&&(currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters["countitem_"+currentContext.selectedCategory]=d),currentContext.cartOptions.sendmatches&&(currentContext.dataInterceptor.retrieveItemsServiceOutput.matches=a.matches),currentContext.dataInterceptor.retrieveItemsServiceOutput.cart=organizeCart(currentContext.cart,!0),currentContext.dataInterceptor.retrieveItemsServiceOutput.messages=currentContext.messages,currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration=currentContext.configuration,delete currentContext.dataInterceptor.retrieveItemsServiceOutput.targetComponents,logTimeEnd("[EXECUTION_TIME] retrieveCatalogItems took"),null!=g&&"undefined"!=g&&g()})})})},function(a){h(a)},{escape:!1})})},changeCategory=function(a,b,c){wslog.info("Reset elements"),currentContext.selectedCategory=a,currentContext.catalogSelectedCategory=a,currentContext.productCatalogItemId=null,currentContext.itemheaderId=null,currentContext.mapOfItemsInPages={},currentContext.countItemInCategory=0,wslog.info("Retrieve items for category: "+a),wslog.info("Retrieve items for catalog: "+currentContext.catalog.catalogid),retrieveCatalogItems(currentContext.catalog.catalogid,a,"",currentContext.itemsForPage,1,currentContext.getDataOptionsMap,function(a){b(a)},function(a){c(a)})},changeChildProduct=function(a,b,c){wslog.info("Goback to child"),currentContext.selectedCategory=null,a.fields.engineAction="Open",currentContext.dataInterceptor.lastChild=a,currentContext.dataInterceptor.itemToShow=a,currentContext.complexProductId=a.fields.catalogitemid,"Product"!=a.fields.type?retrieveCatalogItems(currentContext.catalog.catalogid,"",a.fields.catalogitemid,currentContext.itemsForPage,1,currentContext.getDataOptionsMap,function(a){b(a)},function(a){c(a)}):retrieveCatalogItems(currentContext.catalog.catalogid,"",currentContext.rootCatalogitemid,currentContext.itemsForPage,1,currentContext.getDataOptionsMap,function(a){b(a)},function(a){c(a)})},changeAttribute=function(a,b,c){wslog.info("Change Attribute",a),currentContext.saveBackup=!1;for(var d=!1,e={},f=0;f<a.listOfAttributes.length;f++){var g=a.listOfAttributes[f];e[g.fields.pfpId]=g}wslog.info("mapToPfpToChange",e);for(var f=0;f<currentContext.cart.length;f++){var h=currentContext.cart[f];if(h.fields.itemCode==a.fields.itemCode){for(var i=0;i<h.listOfAttributes.length;i++){var j=h.listOfAttributes[i],k=e[j.fields.pfpId];if(null!=ifnull(k)&&(wslog.info("Changed from "+h.listOfAttributes[i].fields.value+"to "+k.fields.value),h.listOfAttributes[i].fields.value=k.fields.value,d=h.listOfAttributes[i].fields.offlineattribute)){currentContext.lastActionOffline=!0;var l=validateAttribute(h,h.listOfAttributes[i],!0);wslog.info("validateActions: ",l)}}catalogEngine.modify(h);break}}if(wslog.info("Change Attribute itemsForPage ",currentContext.itemsForPage),wslog.info("Change Attribute offset ",currentContext.offset),wslog.info("offlineattribute: "+d),d){var m={};m.action="stopLoading",sendMessage("stopLoading",m)}if(1==d&&0==l.sendData){var n={};n.offlinerun=!0,b(n)}else if(1==d&&1==l.sendData){currentContext.dataInterceptor.retrieveItemsServiceOutput.targetComponents="Messages";var n={};b(n)}else retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(a){b(a)},function(a){c(a)})},changeQuantity=function(a,b,c){wslog.info("Change quantity",a);for(var d=a.fields.qtyToManage,e=0;e<currentContext.cart.length;e++){var f=currentContext.cart[e];if(f.fields.itemCode==a.fields.itemCode){f.fields.qty=d,f.fields.qtyToManage=d,catalogEngine.modify(f),wslog.info("Found item "+f.fields.itemCode+" with qty: "+a.fields.qtyToManage);break}}currentContext.complexProductId=ifnull(currentContext.complexProductId),currentContext.productCatalogItemId=ifnull(currentContext.productCatalogItemId),retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(a){b(a)},function(a){c(a)})},resetSaveConfiguration=function(a,b){currentContext.backUpConfiguration=null;var c=!1;currentContext.programname==currentContext.catalogprogramname&&currentContext.version==currentContext.catalogversion||(c=!0,currentContext.programname=currentContext.catalogprogramname,currentContext.version=currentContext.catalogversion),wslog.info("resetSave itemHeaderId: "+currentContext.itemheaderId),c?changeProgramContext("simple","",function(){currentContext.dataInterceptor.configure=!1,currentContext.dataInterceptor.componentToShow="catalog",currentContext.dataInterceptor.itemToShow=null,wslog.info("Return to shopping cart"),currentContext.saveBackup=!1,sendMessage("changeComponentToShow",currentContext.dataInterceptor),a()},function(a){b(a)}):(wslog.info("currentContext.lastActionOffline: "+currentContext.lastActionOffline),1==currentContext.lastActionOffline?(currentContext.blockSendMessage=!0,retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(b){currentContext.blockSendMessage=!1,currentContext.dataInterceptor.configure=!1,currentContext.dataInterceptor.componentToShow="catalog",currentContext.dataInterceptor.itemToShow=null,wslog.info("Return to shopping cart"),currentContext.saveBackup=!1,sendMessage("changeComponentToShow",currentContext.dataInterceptor),delete currentContext.lastActionOffline,a(b)},function(a){delete currentContext.lastActionOffline,b(a)})):(currentContext.dataInterceptor.configure=!1,currentContext.dataInterceptor.componentToShow="catalog",currentContext.dataInterceptor.itemToShow=null,wslog.info("Return to shopping cart"),currentContext.saveBackup=!1,sendMessage("changeComponentToShow",currentContext.dataInterceptor)),a())},changeCatalog=function(a,b,c){if(wslog.info("Selecting program: ",a),null==a.catalogid)return currentContext.initInProgress=!1,generateError(a.commModelName+": no active catalog version found"),c("No active catalog version found"),!1;currentContext.catalog=a,currentContext.programname=a.programname,currentContext.version=a.version.toString(),1==currentContext.cartOptions.useBaseCatalogProgram&&(currentContext.programname="Base_Program_Catalog",currentContext.version="1"),currentContext.catalogprogramname=currentContext.programname,currentContext.catalogversion=currentContext.version,currentContext.selectedCatalog=a,"initCart"!=currentContext.lastMessageType&&0==currentContext.initInProgress&&(currentContext.cart=[]),currentContext.category=[],currentContext.listOfItems=[],currentContext.messages=[],currentContext.listOfbundles=[],delete currentContext.contextdata.bundle,delete currentContext.moduleAppVar.bundleItems,delete currentContext.moduleAppVar.bundle,b2wgindatainterceptor.selectedCatalog=currentContext.selectedCatalog,b2wgindatainterceptor.selectedCategory=currentContext.selectedCategory,b2wgindatainterceptor.optionsMap=currentContext.cartOptions,async.waterfall([function(a){retrieveProgramChangeCatalog(currentContext.programname,currentContext.version,currentContext.organizationId,a)},function(b){retrieveRowParametersChangeCatalog("",a,b)},function(b,c){retrieveCatalogDataChangeCatalog(a,b,c)},function(b){retrieveCatalogBundles(a,currentContext.getDataOptionsMap,b)}],function(a,d){if(a)return generateError("[changeCatalog] "+a),c(a),!1;retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,1,currentContext.getDataOptionsMap,function(a){b(a)},function(a){return a.method="changeCategory",generateError(a),c(a),!1})})},checkOut=function(a,b){wslog.info("checkout called"),currentContext.lastMessageType="checkout",currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration.id=ifnull(currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration.id),wslog.info("prefix: "+currentContext.prefix);for(var c in currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration){if("NE__"!=currentContext.prefix&&1==c.endsWith("__c")){var d=c.replace("NE__",currentContext.prefix);currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration[d]=currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration[c],delete currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration[c]}"RecordTypeId"!=c&&"Id"!=c||null!=currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration[c]&&""!=currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration[c]||delete currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration[c],"itemsCounter"==c&&delete currentContext.dataInterceptor.retrieveItemsServiceOutput.configuration[c]}wslog.info("dataInterceptor.retrieveItemsServiceOutput input: ",currentContext.dataInterceptor.retrieveItemsServiceOutput),b2wgindatainterceptor.checkoutCart(currentContext.dataInterceptor,function(c){if(wslog.info("Checkout result!: ",c),currentContext.dataInterceptor.cartCheckOutServiceOutput=c,currentContext.dataInterceptor.cartadministration=currentContext.cartadministration,currentContext.dataInterceptor.cartCheckOutServiceOutput.sessionParameters=currentContext.dataInterceptor.retrieveItemsServiceOutput.sessionParameters,"0"!=c.errorCode)return generateError("checkOutCart: "+c.errorMessage),b(c.errorMessage),!1;sendMessage("checkOut",currentContext.dataInterceptor),a()},function(a){b(a)},{escape:!1})},searchItems=function(a,b,c){if(null==ifnull(currentContext.complexProductToOpen)){var d={};d.productFieldsSet=[],d.catalogItemFieldsSet=[],d.productFields={},d.dynamicPropertyDefinitionFieldsSet=[],d.documentationCharacteristicFieldsSet=[],d.catalogItemFields={},d.productFieldsList=a.MapProductList,d.catalogItemFieldsList=a.MapCatItemList,d.bundleElements=a.bundleElements,null==ifnull(d.productFieldsList)&&(d.productFieldsList=[]),null==ifnull(d.catalogItemFieldsList)&&(d.catalogItemFieldsList=[]),null==ifnull(d.bundleElements)&&(d.bundleElements=[]),currentContext.itemsForPageBK=currentContext.itemsForPage;var e=!1;null!=ifnull(a.searchOptions)&&(e=a.searchOptions.enableSearchAndAdd),0==d.productFieldsList.length&&0==d.catalogItemFieldsList.length&&0==d.bundleElements.length?(e=!1,delete currentContext.getDataOptionsMap.searchString,delete currentContext.getDataOptionsMap.itemsForPageSearch,delete currentContext.getDataOptionsMap.pageNumberSearch):(currentContext.getDataOptionsMap.searchString=JSON.stringify(d),null!=ifnull(a.searchOptions.itemsForPage)&&(currentContext.itemsForPage=parseInt(a.searchOptions.itemsForPage),currentContext.getDataOptionsMap.itemsForPageSearch=a.searchOptions.itemsForPage),null!=ifnull(a.searchOptions.pageNumber)&&(currentContext.getDataOptionsMap.pageNumberSearch=a.searchOptions.pageNumber),wslog.info("searchString:"+currentContext.getDataOptionsMap.searchString)),retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(a){currentContext.itemsForPage=currentContext.itemsForPageBK,delete currentContext.itemsForPageBK,wslog.info("searchAndAddActivated: "+e);var c=currentContext.dataInterceptor.retrieveItemsServiceOutput.listOfItems.filter(function(a){return"Product"===a.fields.type});1==e&&1==c.length?(wslog.info("Adding element after search: "+c[0].fields.productname),e=!1,delete currentContext.getDataOptionsMap.searchString,delete currentContext.getDataOptionsMap.itemsForPageSearch,delete currentContext.getDataOptionsMap.pageNumberSearch,addItemToCart(c[0],function(a){b(a)},function(a){reject(a)})):b(a)},function(a){c(a)})}else wslog.info("Search items not available for complex products"),b("Search items not available for complex products")},workNextQueuedRequest=function(){currentContext.requestQueue.length>0&&(delete currentContext.requestQueue[0],currentContext.requestQueue.length>0&&(currentContext.requestQueue[0].execute=!0))},configureCatalogItem=function(a,b,c){a.fields.isCatalogItem=!0,currentContext.tempConfigurationVid=a.fields.vid,addItemToCart(a,function(a){b(a)},function(a){c(a)})},confirmItemConfiguration=function(a,b){wslog.info("complexProduct To Confirm: "+currentContext.complexProductToOpen),currentContext.tempConfigurationVid=null;for(var c=0;c<currentContext.cart.length;c++){var d=currentContext.cart[c];wslog.info("Item vid: "+d.fields.vid+" Item rootvid: "+d.fields.rootvid),d.fields.vid!=currentContext.complexProductToOpen&&d.fields.rootvid!=currentContext.complexProductToOpen||(d.fields.isCatalogItem=!1,d.fields.isCart=!0,catalogEngine.modify(d),wslog.info("Item modified"))}retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(c){resetSaveConfiguration(function(b){a(b)},function(a){b(a)})})},cancelItemConfiguration=function(a,b,c){wslog.info("complexProduct To Cancel: "+currentContext.complexProductToOpen),currentContext.tempConfigurationVid=null;var a=null;currentContext.backUpConfiguration=null;var d=currentContext.rootvid;null==ifnull(d)&&(d=currentContext.complexProductToOpen);for(var e=0;e<currentContext.cart.length;e++){var f=currentContext.cart[e];if(f.fields.vid==d){a=f;break}}null!=a?removeItemFromCart(a,function(a){b(a)},function(a){c(a)}):b()},commonModifyItem=function(a,b,c){currentContext.itemheaderId=a.fields.itemHeader,wslog.info("itemheaderId: "+currentContext.itemheaderId),wslog.info("rootvid: "+currentContext.rootvid),wslog.info("itemToModify.fields.rootvid: "+a.fields.rootvid);var d="complex",e=currentContext.moduleAppVar["simple_program___"+a.id];null==ifnull(currentContext.itemheaderId)&&null!=ifnull(currentContext.rootvid)&&(d="simple"),currentContext.rootvid==a.fields.rootvid?(currentContext.complexProductToOpen=a.fields.vid,changeChildProduct(a,function(a){b(a)},function(a){c(a)})):(resetConfigurator("complex"),(null!=ifnull(currentContext.itemheaderId)||null!=a.listOfAttributes&&"undefined"!=a.listOfAttributes&&a.listOfAttributes.length>0||null!=ifnull(e))&&(currentContext.complexProductToOpen=a.fields.vid,currentContext.complexProductId=a.fields.catalogitemid,currentContext.rootvid=a.fields.vid,currentContext.itemheaderId=currentContext.itemheaderId,"Product"==a.fields.type&&(currentContext.productCatalogItemId=a.fields.catalogitemid)),null==ifnull(currentContext.backUpConfiguration)&&(currentContext.saveBackup=!0),"simple"==d?changeProgramContext(d,currentContext.itemheaderId,function(){currentContext.complexProductToOpen=a.fields.vid,currentContext.complexProductId=a.fields.catalogitemid,"Product"==a.fields.type&&(currentContext.productCatalogItemId=a.fields.catalogitemid),changeProgramContext("complex",currentContext.itemheaderId,function(a){b(a)},function(a){c(a)})},function(a){c(a)}):(null!=ifnull(currentContext.itemheaderId)||null!=a.listOfAttributes&&"undefined"!=a.listOfAttributes&&0!=a.listOfAttributes.length||null!=ifnull(e)||(d="simple"),changeProgramContext(d,currentContext.itemheaderId,function(a){b(a)},function(a){c(a)})))},modifyItem=function(a,b,c){if(currentContext.saveBackup=!0,null!=ifnull(currentContext.cartMap)&&null!=ifnull(currentContext.cartMap[a.fields.vid])&&(currentContext.backUpConfiguration=JSON.stringify(currentContext.cartMap[a.fields.vid])),null!=currentContext.tempConfigurationVid){for(var d,e=0;e<currentContext.cart.length;e++)if(d=currentContext.cart[e],d.fields.vid==currentContext.tempConfigurationVid){d.fields.isRollback;break}1!=a.fields.isCatalogItem?(wslog.info("Removing temp element before continue"),cancelItemConfiguration(d,function(d){commonModifyItem(a,function(a){b(a)},function(a){c(a)})},function(a){c(a)})):commonModifyItem(a,function(a){b(a)},function(a){c(a)})}else commonModifyItem(a,function(a){b(a)},function(a){c(a)})},rollbackConfiguration=function(a,b){if(wslog.info("Rollback to: ",currentContext.backUpConfiguration),null!=currentContext.backUpConfiguration){var c=currentContext.rootvid;null==ifnull(c)&&(c=currentContext.complexProductToOpen);for(var d,e=0;e<currentContext.cart.length;e++)if(d=currentContext.cart[e],wslog.info("Item vid: "+d.fields.vid+" Item rootvid: "+d.fields.rootvid),d.fields.vid==c){d.fields.isRollback=!0;break}removeItemFromCart(d,function(c){var d=JSON.parse(currentContext.backUpConfiguration),e=d.childItems;d.childItems=[],catalogEngine.createAndAdd(d,"cartitem"),currentContext.cart.push(d),currentContext.moduleAppVar.cart=currentContext.cart,currentContext.dataInterceptor.retrieveItemsServiceOutput.cart=currentContext.cart;for(var f=0;f<e.length;f++)catalogEngine.createAndAdd(e[f],"cartitem"),currentContext.cart.push(e[f]);retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(c){modifyItem(d,function(b){a(b)},function(a){b(a)})})},function(a){b(a)})}else a()},selectCatalog=function(a,b,c){currentContext.lastMessageType="changeCatalog",wslog.info("Change catalog to: "+currentContext.catalogId);for(var d=null,e=0;e<currentContext.catalogHeaders.length;e++)if(currentContext.catalogHeaders[e].catalogid==a||currentContext.catalogHeaders[e].headerid==a){d=currentContext.catalogHeaders[e];break}wslog.info("selectedCatalog",currentContext.selectedCatalog),wslog.info("catalogHeaderSelected",d),null==ifnull(currentContext.selectedCatalog)||d.catalogid!=currentContext.selectedCatalog.catalogid?changeCatalog(d,function(a){b(a)},function(a){c(a)}):(wslog.info("Skipped selecting catalog because is the same"),b())},changePage=function(a,b,c){wslog.info("Change page to: "+a),currentContext.pageNumber=a,0==currentContext.pageNumber&&(currentContext.pageNumber=1),retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,"",currentContext.itemsForPage,currentContext.pageNumber,currentContext.getDataOptionsMap,function(a){b(a)},function(a){c(a)})},b2wginCartToReturn={initCart:function(a,b){return b&&(currentContext=new CurrentContext(b)),currentContext.initInProgress=!0,new Promise(function(b,c){null==a&&(a={}),currentContext.cartOptions=a,b2wgindatainterceptor.setExternalOptions(currentContext.cartOptions),void 0==currentContext.cartOptions.enableCartEvents&&(currentContext.cartOptions.enableCartEvents=!1),currentContext.cartOptions&&currentContext.cartOptions.logLevel?wslog.setLevel(wslog.levels[currentContext.cartOptions.logLevel]):wslog.setLevel(wslog.levels.SILENT),currentContext.cartOptions.enableCartEvents&&0==windowListenerGenerated&&generateWindowListener();var d="";isBrowser&&(d=window.location.search,null!=ifnull(currentContext.cartOptions.parameters)?currentContext.cartOptions.parameters=d+currentContext.cartOptions.parameters:currentContext.cartOptions.parameters=d),async.series([function(a){retrieveB2WGinData(a)},function(a){retrieveProgram("getCatalogsEligible","1",currentContext.organizationId,a)},function(a){retrieveContextData(isBrowser?currentContext.cartOptions.parameters:currentContext.cartOptions.search,currentContext.getDataOptionsMap,a)},function(a){retrieveRowParameters(a)}],function(a,d){if(a)return currentContext.initInProgress=!1,generateError(a),c(a),!1;catalogEngine.fire(null,function(a){if(wslog.info("result"),wslog.info(a),delete currentContext.lastActionOffline,currentContext.cartOptions.sendmatches&&(currentContext.dataInterceptor.retrieveCatalogsServiceOutput.matches=a.matches),null!=a.matches.catalog&&void 0!=a.matches.catalog){currentContext.catalogHeaders=[],currentContext.dataInterceptor.retrieveCatalogsServiceOutput.catalogs=[];try{for(var d=0;d<a.matches.catalog.length;d++)if(1==a.matches.catalog[d].eligible){var e=new Object,f={};f.Name=a.matches.catalog[d].commModelName,f.Id=a.matches.catalog[d].headerid,e.catalog=f,currentContext.dataInterceptor.retrieveCatalogsServiceOutput.catalogs.push(e),wslog.info(currentContext.dataInterceptor.retrieveCatalogsServiceOutput.catalogs),currentContext.catalogHeaders.push(a.matches.catalog[d])}}catch(a){wslog.info("dataInterceptor err: "+a)}}if(null!=ifnull(a.matches.sessionparameter)){currentContext.moduleAppVar.sessionparameter=a.matches.sessionparameter,currentContext.contextdata.sessionparameter=currentContext.moduleAppVar.sessionparameter;for(var d=0;d<a.matches.sessionparameter.length;d++)"taxmodel"==a.matches.sessionparameter[d].name&&(currentContext.taxModelsParameters=a.matches.sessionparameter[d].value)}wslog.info("Send Catalog"),sendMessage("retrieveCatalogsServiceOutput",currentContext.dataInterceptor),wslog.info("Catalogs sent: "+currentContext.catalogHeaders.length),void 0==currentContext.catalogHeaders||0==currentContext.catalogHeaders.length?(wslog.info("No eligible catalogs found"),currentContext.initInProgress=!1,generateError("No eligible catalogs found"),c("No eligible catalogs found")):selectCatalog(currentContext.catalogHeaders[0].headerid,function(a){currentContext.initInProgress=!1,sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),b(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){currentContext.initInProgress=!1,c(a)})})})})},manageRequest:function(a,b){return new Promise(function(c,d){try{if(b&&(currentContext=new CurrentContext(b)),currentContext.requestQueue=[],a.execute=!0,0==currentContext.requestQueue.length||1==a.execute){"unsupported"!=a.type&&(currentContext.lastMessageType=ifnull(a.type),currentContext.lastMessageAction=ifnull(a.action),currentContext.actionInProgress=!0,delete currentContext.dataInterceptor.retrieveItemsServiceOutput.targetComponents),delete currentContext.requestOptions,currentContext.requestOptions=a.options,null==ifnull(currentContext.requestOptions)&&(currentContext.requestOptions={}),wslog.info("currentContext.messageOptions: ",currentContext.messageOptions);if(1=={modifyItem:!0,addItem:!0,removeItem:!0,add:!0,addFromMessage:!0,remove:!0,removeChild:!0,clearCart:!0,modify:!0,goBack:!0,checkout:!0,changeQty:!0,configureCatalogItem:!0}[currentContext.lastMessageType]&&(currentContext.lastMessageAction=currentContext.lastMessageType,currentContext.lastMessageType="manageCart"),"changeCatalogOrCategories"==a.type)wslog.info("isCatalog: "+a.isCatalog),a.isCatalog?selectCatalog(a.catalogId,function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)}):changeCategory(a.categoryId,function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("changeCatalog"==a.type)selectCatalog(a.catalogId,function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("changeCategory"==a.type)changeCategory(a.categoryId,function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if(1==a.retrieveContextData){var e=b2wginCartToReturn.retrieveContext();e.action="retrieveContextData",sendMessage("retrieveContextData",e),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(e,"retrieveContextData"))}else if("Cost Simulation"==a.type){var f=retrieveCostSimulationData(a);null!=f?executeCostSimulator(f,function(b){var d={};d.processData={},d.processData.process=a.type,d.processData.processIds=a.processIds,d.processData.processObjects=a.processObjects,d.processData.processOptions=a.processOptions,d.processData.processResult=b,sendMessage("costSimulator",d),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(d,"costSimulator"))},function(a){currentContext.actionInProgress=!1,d(a)}):d("No cost simulation object provided or found")}else if("changePage"==a.type)changePage(a.page,function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("addRemoveItem"==a.type||"manageCart"==a.type)if(wslog.info("addRemoveItem action: "+a.action),"add"==a.action||"addItem"==a.action)a.action="add",addItemToCart(a.item,function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("addFromMessage"==a.action)addItemFromMessage(a.mapOfItems,function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("remove"==a.action||"removeItem"==a.action)a.action="remove",removeItemFromCart(a.item,function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("removeChild"==a.action)a.item.action="remove",removeItemFromCart(a.item,function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("clearCart"==a.action)clearCart(function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("modify"==a.action||"modifyItem"==a.action)a.action="modify",modifyItem(a.item,function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput")),null!=ifnull(currentContext.dataInterceptor.lastChild)&&(currentContext.dataInterceptor.lastChild.fields.engineAction="")},function(a){d(a)});else if("GoBack"==a.action||"goBack"==a.action){var g=currentContext.cartMap[a.item.fields.parentvid];wslog.info("Goback parentitem: ",g),currentContext.complexProductToOpen=g.fields.vid,changeChildProduct(g,function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)})}else"checkout"==a.action?checkOut(function(a){currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)}):"changeQty"==a.action?(sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),changeQuantity(a.item,function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)})):"configureCatalogItem"==a.action&&configureCatalogItem(a.item,function(a){currentContext.actionInProgress=!1,c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("addRemoveChildItem"==a.type||"addChild"==a.type)wslog.info("addRemoveChildItem action: "+a.action),wslog.info("addRemoveChildItem complexProductToOpen: "+currentContext.complexProductToOpen),a.type="addRemoveChildItem",addItemToCart(a.itemChanged,function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("changeAttribute"==a.type)null!=ifnull(currentContext.dataInterceptor.lastChild)&&(currentContext.dataInterceptor.lastChild.fields.engineAction=""),changeAttribute(a.itemChanged,function(a){null==ifnull(a)&&(a={}),wslog.info("change attribute data result: ",a),1!=a.offlinerun&&sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("resetSaveConfiguration"==a.type||"saveConfiguration"==a.type)a.type="resetSaveConfiguration",null!=ifnull(currentContext.currentBundlevid)&&(currentContext.blockSendMessage=!0),resetSaveConfiguration(function(b){if(null!=ifnull(currentContext.currentBundlevid)){currentContext.blockSendMessage=!1;for(var e,f=0;f<currentContext.cart.length;f++)if(currentContext.cart[f].fields.vid==currentContext.currentBundlevid){e=currentContext.cart[f];break}modifyBundle(e,function(b){currentContext.dataInterceptor.bundleToConfigure=a.bundleItem,sendMessage("showBundleConfigurator",currentContext.dataInterceptor),currentContext.actionInProgress=!1,currentContext.complexProductId=null,c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)})}else sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"));workPostEngineData()},function(a){d(a)});else if("searchItems"==a.type)searchItems(a,function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("confirmItemConfiguration"==a.type)confirmItemConfiguration(function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("cancelItemConfiguration"==a.type)cancelItemConfiguration(a.item,function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("reset"==a.type||"resetConfiguration"==a.type)a.type="reset",rollbackConfiguration(function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("retrieveItemsFromBundleElement"==a.type){var h=ifnull(a.page,0);retrieveItemsFromBundleElement(a.BundleElement,h,function(a){sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsFromBundleElement"))},function(a){d(a)})}else if("addBundle"==a.type)void 0==a.bundleItem.fields.vid||null==a.bundleItem.fields.vid?addBundle(a.bundleItem,function(a){sendMessage("showBundleConfigurator",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),currentContext.complexProductId=null,c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)}):modifyBundle(a.bundleItem,function(a){sendMessage("showBundleConfigurator",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),currentContext.complexProductId=null,c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("modifyBundle"==a.type)modifyBundle(a.bundleItem,function(b){currentContext.dataInterceptor.bundleToConfigure=a.bundleItem,sendMessage("showBundleConfigurator",currentContext.dataInterceptor),currentContext.actionInProgress=!1,workPostEngineData(),currentContext.complexProductId=null,c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("saveBundle"==a.type)a.type="saveBundle",saveBundle(function(a){sendMessage("changeComponentToShow",currentContext.dataInterceptor),currentContext.actionInProgress=!1,c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("configureCatalogItem"==a.type)configureCatalogItem(a.item,function(a){currentContext.actionInProgress=!1,workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){d(a)});else if("updateB2WGinEngine"==a.type)b2wginCartToReturn.updateB2WGinEngine(a).then(function(b){currentContext.actionInProgress=!1,1==a.executeRules?(sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),workPostEngineData(),c(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))):c("0")}).catch(function(a){d(a)});else if("Restart"==a.type){wslog.info("Restart cart");var i=currentContext.cartOptions;if(null==ifnull(i)&&(i={}),null!=ifnull(a.processOptions))for(var j in a.processOptions)i[j]=a.processOptions[j];if(currentContext.actionInProgress=!1,currentContext.selectedCatalog=null,wslog.info("restart with cartOptionsRestart: ",i),null!=ifnull(catalogEngine))try{catalogEngine.clearSession(),currentContext.cart=[]}catch(a){wslog.info("unable to clear cart before init",a)}b2wginCartToReturn.initCart(i)}else currentContext.actionInProgress=!1,sendMessage("stopLoading","Unsupported message"),d("Unsupported message")}}catch(a){currentContext.actionInProgress=!1,d(a),wslog.info("Skipped not cart message: "+a)}})},preLoadData:function(a){return null==ifnull(a)?currentContext.cartOptions={}:currentContext.cartOptions=a,currentContext.cartOptions.logLevel="TRACE",wslog.info("preLoadData started"),logTimeStart("[EXECUTION_TIME] preLoadData"),new Promise(function(b,c){retrieveB2WGinData(function(){var d=a.preloadinfo,e={};if(e.result=0,e.resultMessage="",e.preLoadInfo=d,null!=ifnull(d)&&null!=ifnull(d.preloadprogramsdata)){wslog.info("Generating preloaddata programs");var f=[];b2wgindatainterceptor.setactivatePreLoad(!0);for(var g=0;g<d.preloadprogramsdata.length;g++)f.push(retrieveProgramPromise(d.preloadprogramsdata[g].name,d.preloadprogramsdata[g].version,a.organizationId));Promise.all(f).then(function(a){delete currentContext.cartOptions.logLevel,b2wgindatainterceptor.setactivatePreLoad(!1),logTimeEnd("[EXECUTION_TIME] preLoadData"),generateWindowListener(),sendMessage("retrieveItemsServiceOutput",currentContext.dataInterceptor),b("Preload data result: "+JSON.stringify(a))})}else delete currentContext.cartOptions.logLevel,wslog.info("No preload data provided"),logTimeEnd("[EXECUTION_TIME] preLoadData"),e.result=-1,e.resultMessage="No preload data provided",generateError("No preload data provided"),c(e)})})},getOrganization:function(){return currentContext.organizationId},getCategories:function(){return currentContext.moduleAppVar.category},getCatalogSelectedCategory:function(){return currentContext.catalogSelectedCategory},getDataInterceptor:function(){return currentContext.dataInterceptor},getCatalogProgramName:function(){return currentContext.catalogprogramname},getCurrentRootVid:function(){return currentContext.rootVid},getCart:function(){return currentContext.cart},getConfiguration:function(){return currentContext.configuration},retrieveContext:function(){var a=JSON.stringify(currentContext);return JSON.parse(a)},restoreContext:function(a,b,c){wslog.info("restoring context contextdata ",a),currentContext=a,currentContext.lastMessageType="changePage",b2wgindatainterceptor.setExternalOptions(currentContext.cartOptions),b2wgindatainterceptor.retrieveProgram(currentContext.programname,currentContext.version,currentContext.organizationId,function(a){if("0"!=a.errorCode)return generateError("retrieveProgram: "+a.errorMessage),c(a.errorMessage),!1;catalogEngine=a,catalogEngine.clearSession();for(var d=0;d<currentContext.cart.length;d++)catalogEngine.createAndAdd(currentContext.cart[d],"cartitem");for(var e in currentContext.contextdata)if(wslog.info("Restoring key: "+e),null!=ifnull(currentContext.moduleAppVar[e]))if(currentContext.moduleAppVar[e]instanceof Array)for(var f=currentContext.moduleAppVar[e],d=0;d<f.length;d++)catalogEngine.createAndAdd(f[d],e);else catalogEngine.createAndAdd(currentContext.moduleAppVar[e],e);if(!isBrowser)return void b(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"));retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(){b(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))},function(a){c(a)})},function(a){c(a)})},cartMap:currentContext.cartMap,retrieveCartItem:b2wgindatainterceptor.retrieveCartItem,getCurrentContext:function(){return currentContext},reInitCart:function(a){return this.initCart(a,{})},getCurrentFacts:function(){return catalogEngine.retrieveCurrentFacts()},updateB2WGinEngine:function(a){return new Promise(function(b,c){try{if(a.constructor!==Object)throw new Error("first param must be an object");if(void 0===catalogEngine)throw new Error("Engine is not initialized");for(var d=a.objectList,e=0;e<d.length;e++){var f=d[e],g=f.action;if(!g)throw new Error("Action not set!");g=g.toLowerCase();var h=f.type;if(!h)throw new Error("Type not set!");var i=f.instance;if("add"===g){if(!i)throw new Error("no object(s) of [ "+h+" ] to add");try{if(i.constructor===Array)for(var j=0;j<i.length;j++)catalogEngine.createAndAdd(i[j],h);else catalogEngine.createAndAdd(i,h)}catch(a){throw new Error("Error in adding [ "+h+" ] objects. Operation aborted. Stack: "+JSON.stringify(a))}}else{if("modify"!==g&&"remove"!==g)throw new Error("action not defined [add, modify or remove]");var k=f.instance,l=f.uniqueid;if(!l)throw new Error("uniqueId is mandatory");var m=f.value;if(!m)throw new Error("value to check is mandatory");if(m.constructor===Array&&"modify"===g)throw new Error("value can't be an array");if("modify"===g&&!k)throw new Error("no object of [ "+h+" ] to modify!");var n=l.split("."),o=catalogEngine.retrieveCurrentFacts()[h],p=o.filter(function(a){if(1===n.length)return m.constructor!==Array?a[l]===m:m.indexOf(a[l])>-1;for(var b=a[n[0]],c=1;c<n.length;c++)b=b[n[c]];return m.constructor!==Array?b===m:m.indexOf(b)>-1});if(0===p.length){wslog.info("no object [ "+h+" ] found with [ "+l+" ] === "+m);continue}if("modify"===g)catalogEngine.remove(p[0]),catalogEngine.createAndAdd(k,h);else for(var q=0;q<p.length;q++)catalogEngine.remove(p[q])}}1==a.executeRules?retrieveCatalogItems(currentContext.catalog.catalogid,currentContext.selectedCategory,currentContext.complexProductId,currentContext.itemsForPage,currentContext.offset,currentContext.getDataOptionsMap,function(){b(new cbResponse(currentContext.dataInterceptor,"retrieveItemsServiceOutput"))}):b("0")}catch(a){c(a.message)}})}};return b2wginCartToReturn};module.exports=b2wgin_cart},{"./callbackResponse.js":7,"./currentContext.js":8,"./interceptor.js":10,"./logging.js":11}],5:[function(a,b,c){var d=function(){return new(a("./b2wgin_cart.js"))}();b.exports=d},{"./b2wgin_cart.js":4}],6:[function(a,b,c){var d=function(){var b,c=function(){function a(){g={},h={},b({"&amp;":"&","&gt;":">","&lt;":"<","&quot;":'"',"&#39;":"'"})}function b(a){var b,c,d=[],i=[];for(b in a)c=a[b],h[b]=c,g[c]=b,d.push(c),i.push(b);e=new RegExp("("+d.join("|")+")","g"),f=new RegExp("("+i.join("|")+"|&#[0-9]{1,5};)","g")}function c(a){var b=function(a,b){return g[b]};return a?String(a).replace(e,b):a}function d(a){var b=function(a,b){return b in h?h[b]:String.fromCharCode(parseInt(b.substr(2),10))};return a?String(a).replace(f,b):a}var e,f,g,h;return a(),{htmlEncode:c,htmlDecode:d}}(),d=a("./engine.js");return{engine:function(a,c){return b=new d(a,c)},init:function(a,c){b.init(function(b){a(b)},function(a){c(a)})},htmlEnDeCode:c}}();b.exports=d},{"./engine.js":9}],7:[function(a,b,c){var d=function(a,b){var c={};for(var d in a)a.hasOwnProperty(d)&&(!a[d]||a[d].constructor!==Array&&a[d].constructor!==Object)&&(c[d]=a[d]);return b&&a.hasOwnProperty(b)&&(c[b]=a[b]),c};b.exports=d},{}],8:[function(a,b,c){var d=function(a){if(this.whatShow="Catalog",this.viewType="Standard",this.defaultCurrency="EUR",this.listOfItems=[],this.currentPage=1,this.catalogs=[],this.cart=[],this.cartInfo={},this.messages=[],this.searchText="",this.account={},this.servAccount={},this.billAccount={},this.configuration={},this.catalogs=[],this.searchActive=!1,this.countItemCart=0,this.existingOrderItems=[],this.contextdata={},this.DEBUG=!1,this.dataInterceptor,this.requestQueue=[],this.blockSendMessage=!1,this.executedRules={},this.cartOptions={},this.moduleAppVar={},this.debugMode="Debug is not active",this.debugLog="Debug is not active",this.debugTimes={},this.tempConfigurationVid=null,this.cartMap={},this.backUpConfiguration,this.saveBackup=!1,this.getDataOptionsMap={},this.loadedItems={},this.cachedResponse={},this.catalogprogramname="",this.catalogversion="",this.organizationId="",this.lexOrigin="",this.agendaGroupsMap={},this.cartadministration=null,this.itemsForPage=null,this.multicurrencyactivated=!1,this.lastMessageType="",this.confcurrency=null,this.Configuration=null,this.rowParameters=null,this.catalogHeaders=null,this.selectedCatalog=null,this.catalog=null,this.programname="",this.version=null,this.category=null,this.selectedCategory=null,this.queryCondition="",this.taxModelsParameters=null,this.selectedCategory=null,this.catalogSelectedCategory=null,this.lastItemAdded=null,this.itemheaderId=null,this.complexProductToOpen=null,this.rootvid=null,this.prefix="",this.lastMessageAction="",this.offset=1,this.complexProductId=null,this.rootCatalogitemid=null,this.componentToShow=null,this.currencyconversion=[],this.initInProgress=!1,this.productCatalogItemId=null,this.listOfbundles=[],this.currentBundleElement=null,this.actionInProgress=!1,this.currentBundlevid=null,this.mapOfBundleElements={},this.mapOfBundleLogicalConn={},this.currentBundle=null,a)for(var b in a)this[b]=a[b];return this};b.exports=d},{}],9:[function(a,b,c){function d(b,c){var d=a("./b2wginInstance.js"),e="undefined"!=typeof window&&"[object Window]"==={}.toString.call(window),f=a("underscore");return{bootstrapEngine:function(a,b,c){var g;if(void 0===(g=b2wgin.getFlow(a))){if(e){var h=document.createElement("script");h.type="text/javascript",h.text=b,h.id=a,document.head.appendChild(h),g=b2wgin.getFlow(a)}else g=b2wgin.compile(b,{name:a,scope:f});if(e){var i=document.getElementById(a);i.parentNode.removeChild(i)}}var j=new d(g.getSession()),k={array:Array,string:String,number:Number,boolean:Boolean,regExp:RegExp,date:Date,object:Object};for(var l in g.__defined)void 0==k[l]&&(k[l]=g.getDefined(l));j.classDefinitions=k,c(j)},bootstrapEngineSM:function(a,b,c){var e;void 0===(e=b2wgin.getFlow(a))&&(e=b2wgin.compile(b,{name:a,scope:f}));var g=new d(e.getSession()),h={array:Array,string:String,number:Number,boolean:Boolean,regExp:RegExp,date:Date,object:Object};for(var i in e.__defined)void 0==h[i]&&(h[i]=e.getDefined(i));g.classDefinitions=h,c(g)}}}b.exports=d},{"./b2wginInstance.js":3,underscore:2}],10:[function(a,b,c){"use strict";var d=function(){var b,c,b=a("./b2wginapi.js"),d={},e={},f={},g={},h=!1;return{retrieveBundleData:function(a,b,c,d){c.bundleId=a,c.actionType="retrieveBundleData",c.itemsExternalIds=JSON.stringify(b),NE.b2wgin_DataRetrieve.executeAction(c,function(a){null!=d&&"undefined"!=d&&d(a)},{escape:!1,timeout:12e4,buffer:!1})},retrieveCatalogBundles:function(a,b,c){b.catalogId=a,b.actionType="retrieveCatalogBundles",NE.b2wgin_DataRetrieve.executeAction(b,function(a){null!=c&&"undefined"!=c&&c(a)},{escape:!1,timeout:12e4,buffer:!1})},setExternalOptions:function(a){},retrieveCatalogItemsAttachment:function(a,b,g,h,i,j,k){var l=a+b+g+h+i+JSON.stringify(j);if(console.log("*** cacheKey: "+l),1==j.skipCall){console.log("retrieve skipped!");var m={};m.result={},m.errorCode="0",k(m)}else if(void 0!=f[l]&&null!=f[l])console.log("*** cacheHit!"),k(f[l]);else{var n="true"==j.GetAllData,o="true"==j.GetStructure,p=null!=j.currentCatalogItemId?j.currentCatalogItemId:"",q=null!=j.itemheaderId?j.itemheaderId:"",r=!1,s=null!=d&&Object.keys(d).length>0,t="";if(""!=q?null!=e&&Object.keys(e).length>0&&(t=null!=e[q]&&void 0!=e[q]?e[q]:""):null!=e&&Object.keys(e).length>0&&(t=null!=b?null!=e[b]&&void 0!=e[b]?e[b]:"":null!=e.simpleProduct&&void 0!=e.simpleProduct?e.simpleProduct:""),s&&(n&&(""==p||""!=t&&-1!=t.indexOf(p))||o&&""!=t&&""!=p&&-1!=t.indexOf(p)&&t!=p+";")&&(r=!0),console.log("*** isInCache: "+r),r){console.log("*** try to retrieve from cache!");var u={},v={},w=!1;for(var x in d.result)if("-1"!=x.indexOf("___")){var y,z=x.split("___")[0];if(d.result[x].constructor===String)try{y=JSON.parse(d.result[x])}catch(a){}else y=d.result[x];"item"==z?y.fields.catalogid==a&&("Product"==y.fields.type?n?(v[x]=d.result[x],w=!0):y.fields.categoryid==b&&(v[x]=d.result[x],w=!0):o?(v[x]=d.result[x],w=!0):""!=q&&y.fields.itemHeader==q&&(v[x]=d.result[x],w=!0)):"complex_category"==z?y.categoryFields.itemHeader==q&&(v[x]=d.result[x],w=!0):v[x]=d.result[x]}else v[x]=d.result[x];u.result=v,Object.keys(v).length>0&&w?(u.errorCode="0",k(u)):r=!1}r||(console.log("*** retrieve from sf!"),NE.b2wgin_DataRetrieve.retrieveCatalogItemsAttachment(a,b,g,h,i,j,function(a){if(n||o)for(var b in a)if(d[b]=a[b],"result"==b)for(var g in a.result){if(g.startsWith("itemHeader___")){var h=g.split("itemHeader___")[1];e[h]=a.result[g]}if(g.startsWith("catCategory___")){var h=g.split("catCategory___")[1];e[h]=a.result[g]}}if(null!=c&&void 0!=c&&c>0&&Object.keys(f).length>=c){var i=Object.keys(f)[0];console.log("winCache - remove first key "+i),delete f[i]}f[l]=a,null!=k&&"undefined"!=k&&k(a)},{escape:!1,timeout:12e4,buffer:!1}))}},retrieveCartItem:function(a,b,c){NE.b2wgin_DataRetrieve.retrieveCartItem(a,b,function(a){null!=c&&"undefined"!=c&&c(a)},{escape:!1,timeout:12e4,buffer:!1})},retrieveAutoAddedChildren:function(a,b,c,d,e){NE.b2wgin_DataRetrieve.retrieveAutoAddedChildren(a,b,c,function(a){null!=e&&"undefined"!=e&&e(a)},{escape:!1,timeout:12e4,buffer:!1})},retrieveComplexProductsData:function(a,b,g,h,i,j,k,l){var m=a+b+g+h+i+j+JSON.stringify(k);console.log("*** cacheKey: "+m);var n="true"==k.GetStructure,o=k.currentCatalogItemId,p=!1,q=null!=d&&Object.keys(d).length>0,r="";if(""!=b?null!=e&&Object.keys(e).length>0&&(r=null!=e[b]&&void 0!=e[b]?e[b]:""):null!=e&&Object.keys(e).length>0&&(r=null!=e.simpleProduct&&void 0!=e.simpleProduct?e.simpleProduct:""),q&&n&&""!=r&&-1!=r.indexOf(o)&&r!=o+";"&&(p=!0),console.log("*** isInCache: "+p),p){console.log("*** try to retrieve from cache (complexProductsData)!");var s={};if(s.result={},null!=b){var t=d.result["complex_program___"+b];s.result.programName=t.substring(0,t.indexOf(":")),s.result.programVersion=t.substring(t.indexOf(":")+1);var u=r.split(";");for(var v in u){var w=u[v];null!=d.result["complex_category___"+w]&&void 0!=d.result["complex_category___"+w]&&(s.result["complex_category___"+w]=d.result["complex_category___"+w])}}Object.keys(s.result).length>0?(s.errorCode="0",l(s)):p=!1}else void 0!=f[m]&&null!=f[m]?(console.log("Cache hit!"),l(f[m])):p||(console.log("*** retrieve from sf (complexProductsData)!"),NE.b2wgin_DataRetrieve.retrieveComplexProductsData(a,b,g,h,i,j,function(a){if(n)for(var b in a)if(d[b]=a[b],"result"==b)for(var g in a.result){if(g.startsWith("itemHeader___")){var h=g.split("itemHeader___")[1];e[h]=a.result[g]}if(g.startsWith("catCategory___")){var h=g.split("catCategory___")[1];e[h]=retrieveCatalogItemsAttachmentResponse.result[g]}}if(null!=c&&void 0!=c&&c>0&&Object.keys(f).length>=c){var i=Object.keys(f)[0];console.log("winCache - remove first key "+i),delete f[i]}f[m]=a,null!=l&&"undefined"!=l&&l(a)},{escape:!1,timeout:12e4,buffer:!1}))},retrieveProgram:function(a,d,e,i){var j=b.engine(a,d,e),k=a.replace(/ /g,"_")+"_"+d.replace(".","_"),l=a+d+e;if(console.log("*** cacheKey: "+l),"undefined"!=g&&null!=g&&void 0!=g[k]){console.log("Cached program retrieved");var m=g[k];m.errorCode="0",m.errorMessage="",i(g[k])}else void 0!=f[l]&&null!=f[l]?(console.log("Cache hit!"),i(f[l])):NE.b2wgin_DataRetrieve.retrieveProgram(a,d,e,function(a,d){var e=a.value;if("0"==a.errorCode)j.bootstrapEngine(k,b.htmlEnDeCode.htmlDecode(e.rules),function(a){if(a.errorCode="0",a.errorMessage="",null!=c&&void 0!=c&&c>0&&Object.keys(f).length>=c){var b=Object.keys(f)[0];console.log("winCache - remove first key "+b),delete f[b]}f[l]=a,1==h&&(g[l]=a),i(a)});else{var m=new Object;m.errorCode=a.errorCode,m.errorMessage=a.errorMessage,console.log("Error in retrieveProgramResponse: ",m),i(m)}},{timeout:12e4,buffer:!1})},retrieveCatalogData:function(a,b,c,d){NE.b2wgin_DataRetrieve.retrieveCatalogData(a,b,c,function(a){null!=d&&"undefined"!=d&&d(a)},{escape:!1,timeout:12e4,buffer:!1})},retrieveMatrixParameters:function(a,b){NE.b2wgin_DataRetrieve.retrieveMatrixParameterQueryWhere(a,function(a){null!=b&&"undefined"!=b&&b(a)},{escape:!1,timeout:12e4,buffer:!1})},retrieveRowParameters:function(a,b,c,d){console.log("query: "+a),console.log("catalogId: "+b),console.log("matrixName: "+c),NE.b2wgin_DataRetrieve.retrieveRowParametersWithMatrixAndCatalog(a,b,c,function(a){null!=d&&"undefined"!=d&&d(a)},{escape:!1,timeout:12e4,buffer:!1})},checkoutCart:function(a,b){NE.b2wgin_DataRetrieve.checkoutCart(JSON.stringify(a.retrieveItemsServiceOutput),function(a){null!=b&&"undefined"!=b&&b(a)},{escape:!1,timeout:12e4,buffer:!1})},retrieveB2WGinData:function(a,b){NE.b2wgin_DataRetrieve.retrieveB2WGinData(function(a){null!=b&&"undefined"!=b&&b(a)},{escape:!1,timeout:12e4,buffer:!1})},retrieveContextData:function(a,b,d){NE.b2wgin_DataRetrieve.retrieveContextData(a,function(a){null!=a&&null!=a.additionalData&&(c=a.additionalData.cacheSteps,null!=c&&isNaN(c)&&(c=null),console.log("cacheSteps: "+c)),null!=d&&"undefined"!=d&&d(a)},{escape:!1,timeout:12e4,buffer:!1})},getLoadedItemsId:function(a,b){null!=e&&null!=b&&"undefined"!=b&&b(e[a])},setactivatePreLoad:function(a){h=a}}}();b.exports=d},{"./b2wginapi.js":6}],11:[function(a,b,c){var d=function(b){var c,d=a("loglevel");return c="function"==typeof d?new d:d,b?c.setDefaultLevel(c.levels[b]):c.setDefaultLevel(c.levels.SILENT),c}();b.exports=d},{loglevel:1}]},{},[5])(5)});
/* eslint-enable */
